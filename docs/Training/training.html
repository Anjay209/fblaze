<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FBLAZE Dashboard</title>
  <link rel="stylesheet" href="training.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;
  }

  html::-webkit-scrollbar, body::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Edge */
  }
  
  body {
    background-color: #f8f9fb;
    color: #111;
  }
  
  /* Layout */
  .main-layout {
    display: flex;
  }
  
  /* Sidebar */
  .sidebar {
    width: 70px;
    height: 100vh;
    background: white;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem 0;
    gap: 2rem;
    position: fixed;
    top: 60px;
    left: 0;

  }

  .notification-item {
  background: #eef2ff;
  border: 1px solid #c7d2fe;
  border-radius: 8px;
  padding: 0.75rem;
  margin-bottom: 0.75rem;
  font-size: 0.9rem;
  color: #1e3a8a;
  cursor: pointer;
  transition: background 0.2s ease;
}

.notification-item:hover {
  background: #e0e7ff;
}

.notification-close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    font-size: 14px;
    padding: 2px 5px;
    border-radius: 50%;
}

.notification-close:hover {
    color: #666;
    background: #f0f0f0;
}

.notification-item {
    position: relative;
    padding: 12px 16px 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
    background: #fff;

}


  
  .logo {
    font-weight: bold;
    color: #007aff;
    font-size: 1.2rem;
  }
  
  .button {
    background-color: transparent;
    border-color: 1px solid transparent;
  }
  .nav-icons {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .nav-icons li {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    background-color: #f1f5ff;
    padding: 0.75rem;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .nav-icons li:hover {
    background-color: #d8e5ff;
  }

  .nav-label {
    position: absolute;
    left: 100%;
    top: 50%;
    transform: translateY(-50%);
    background-color: #111827;
    color: white;
    font-size: 0.7rem;
    padding: 0.3rem 0.5rem;
    border-radius: 6px;
    margin-left: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease, transform 0.2s ease;
  }

  .nav-icons li:hover .nav-label {
    opacity: 1;
    transform: translateY(-50%) translateX(0px);
  }
  
  /* Top Header */
  .top-header {
    position: sticky;
    top: 0;
    background: white;
    padding: 0.75rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    z-index: 1000;
    height: 60px;
  }
  
  .nav-title {
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .new-badge {
    font-size: 0.9rem;
    color: #007aff;
    margin-left: 0.5rem;
  }
  
  .nav-right {
  position: relative;
  display: flex;
  align-items: center;
}

  
  .nav-right input {
    padding: 0.4rem 2.2rem 0.4rem 0.75rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 0.9rem;
    width: 220px;
  }
  
  .search-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
    color: #666;
  }
  
  /* Content Area */
  .content {
    margin-left: 70px;
    padding: 2rem;
    width: 100%;
    width: calc(100% - 160px); /* Use available space */
    margin-left: 120px; /* Creates space from the sidebar */
  }
  
  /* Welcome Section */
  .welcome-section {
    margin-bottom: 1rem;
  }
  
  .course-title {
    background: linear-gradient(to right, #007cf0, #00dfd8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 2rem;
    font-weight: 700;
    text-transform: lowercase;
  }
  
  .unit-title {
    font-size: 5rem;
    font-weight: 800;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .name {
    background: linear-gradient(to right, #007cf0, #00dfd8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .meta-info {
    font-size: 0.95rem;
    color: #555;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  /* AI Summary Box */
  .ai-summary {
    background: #e6f7ff;
    padding: 1rem 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    width: 80vw;
    border-left: 5px solid #00bfff; /* sky blue border */
  }
  
  .ai-summary h3 {
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  
  /* Cards */
  .cards {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }
  
  .schoolhouse-card {
    background: #fff;
    border: 1px solid #e0e6ed;
    border-radius: 12px;
    padding: 1.5rem;
    width: 100%;
    max-width: 275px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .card-icon {
    font-size: 2rem;
    color: #3b82f6;
  }
  
  .card-content h3 {
    font-size: 1.1rem;
    font-weight: 700;
  }

  .card-content{
    gap: 1rem;
    display: flex;
  flex-direction: column;
  }
  
  .card-content p {
    font-size: 0.95rem;
    color: #4b5563;
  }
  
  .card-content a {
    font-size: 0.95rem;
    color: #2563eb;
    font-weight: 600;
    text-decoration: none;
  }
  
  .card-content a:hover {
    text-decoration: underline;
  }
  
  /* FAQ */
  .faq-wrapper {
    margin-top: 2rem;
  }
  
  .faq-category {
    font-size: 1.25rem;
    font-weight: 600;
    color: #007cf0;
    margin-bottom: 1rem;
  }

  .desc {
    line-height: 1.6rem;
  }
  
  .accordion {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .accordion-item {
    border-bottom: 1px solid #ddd;
  }
  
  .accordion-toggle {
    background: none;
    border: none;
    font-size: 1rem;
    font-weight: 600;
    text-align: left;
    width: 100%;
    padding: 1rem 0;
    cursor: pointer;
  
    display: flex;
    justify-content: space-between; /* 👈 pushes icon to far right */
    align-items: center;
    gap: 1rem;
  }
  
  .accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    font-size: 0.95rem;
    color: #555;
  }
  
  .accordion-toggle.active + .accordion-content {
    max-height: 200px;
    padding-bottom: 1rem;
  }
  
  .feature-box-icon {
    width: 48px;
    height: 48px;
    margin-bottom: 12px;
    display: block;
    object-fit: contain;
  }
  
  .sidebar .nav-icons a {
    text-decoration: none !important;  /* 💥 Force remove underline */
    color: inherit;                    /* 🟦 Optional: match surrounding text color */
    display: flex;                     /* 🔧 Keeps icon and label aligned */
    align-items: center;
    gap: 0.5rem;                       /* 👈 Optional spacing between icon and label */
  }
  
  .chevron-icon {
    transition: transform 0.3s ease;
  }
  
  .chevron-icon.rotate {
    transform: rotate(180deg);
  }
  

  .goal-modal {
  position: fixed;
  z-index: 1002;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 2rem;
  box-shadow: 0 10px 36px rgba(36,60,120,0.13), 0 2px 8px #357cf526;
  min-width: 350px;
  max-width: 95vw;
  padding: 2.6rem 2.1rem 2rem 2.1rem;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 1.6rem;
  animation: fadeIn 0.32s cubic-bezier(.21,.93,.49,1.05);
}
.goal-modal .modal-content {
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
}

.goal-modal h2 {
  font-size: 2rem;
  font-weight: 700;
  color: #212941;
  margin-bottom: 0.5rem;
  text-align: left;
}

.goal-choices {
  display: flex;
  gap: 1rem;
  justify-content: stretch;
  margin-bottom: 0.8rem;
}
.goal-card {
  flex: 1 1 0;
  background: #f8fafd;
  border: 2px solid #e3e8f2;
  border-radius: 14px;
  padding: 1.18rem 0.7rem 0.93rem 0.7rem;
  text-align: center;
  font-weight: 700;
  color: #25355a;
  font-size: 1.17rem;
  box-shadow: 0 1.5px 8px #3061cb10;
  cursor: pointer;
  transition: border 0.17s, box-shadow 0.16s, background 0.14s;
  min-width: 110px;
  outline: none;
  user-select: none;
}
.goal-card.selected,
.goal-card:active,
.goal-card:focus {
  border: 2.2px solid #357cf5;
  background: #eef4fe;
  color: #1d4dd1;
  box-shadow: 0 5px 20px #357cf513;
}
.goal-card span {
  font-size: 1.02rem;
  font-weight: 500;
  display: block;
  margin-top: 0.19em;
  color: #7b8ea8;
  letter-spacing: 0.01em;
}
.goal-modal label {
  margin-top: 0.3rem;
  margin-bottom: 0.18rem;
  font-weight: 600;
  color: #273760;
  font-size: 1.07rem;
  letter-spacing: -0.01em;
}
.goal-modal input[type="text"] {
  width: 100%;
  font-size: 1.09rem;
  border: 2px solid #e6eaf2;
  border-radius: 11px;
  padding: 0.86rem 1rem;
  background: #f7fafb;
  margin-bottom: 0.4rem;
  transition: border-color 0.14s, box-shadow 0.14s;
  font-family: inherit;
}
.goal-modal input[type="text"]:focus {
  border-color: #357cf5;
  box-shadow: 0 0 0 2px #357cf532;
  outline: none;
}

#goalSubmitBtn {
  background: #357cf5;
  color: #fff;
  font-weight: 700;
  font-size: 1.12rem;
  border: none;
  border-radius: 12px;
  padding: 0.98rem 0;
  margin-top: 0.6rem;
  opacity: 0.78;
  cursor: not-allowed;
  box-shadow: 0 1.5px 8px #357cf511;
  transition: background 0.16s, opacity 0.15s;
}
#goalSubmitBtn.enabled {
  opacity: 1;
  cursor: pointer;
  background: #357cf5;
}
#goalSubmitBtn.enabled:hover {
  background: #2057b9;
}
.modal-backdrop {
  position: fixed;
  z-index: 1000;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(40,50,80,0.12);
  backdrop-filter: blur(2px);
}
@media (max-width: 600px) {
  .goal-modal { min-width: 0; padding: 1.6rem 0.5rem;}
  .goal-choices { flex-direction: column; gap: 0.7rem; }
}
.goal-card.selected {
  outline: 0.5px solid #4f46e5;
  background: #E0F2FE ;
  /* add your own highlight styling if you want */
}


#searchDropdown {
  display: none;           /* Hidden by default */
  position: absolute;
  top: 42px;               /* Adjust based on your navbarSearch input height */
  right: 0;
  width: 340px;            /* Match or be slightly wider than your input */
  max-height: 320px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  z-index: 99;
  overflow-y: auto;
  padding: 0;
}
.dropdown-result {
  padding: 12px 18px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  background: #fff;
  font-size: 16px;
  transition: background 0.12s;
}
.dropdown-result:last-child {
  border-bottom: none;
}
.dropdown-result:hover, .dropdown-result:focus {
  background: #f2f8fd;
  color: #0072ff;
}

.cq-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.32);
  justify-content: center;
  align-items: center;
  transition: background 0.3s;
}
.cq-modal[style*="block"] {
  display: flex !important;
}
.cq-modal-content {
  background: white;
  border-radius: 24px;
  padding: 32px;
  max-width: 540px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.cq-close {
  position: absolute;
  top: 20px;
  right: 24px;
  font-size: 24px;
  color: #9ca3af;
  cursor: pointer;
  background: none;
  border: none;
  padding: 4px;
  line-height: 1;
}

.cq-close:hover {
  color: #6b7280;
}

.cq-modal-fields > div {
  margin-bottom: 16px;
  font-size: 16px;
  line-height: 1.5;
  color: #374151;
}

.cq-modal-fields > div > b {
  color: #1f2937;
  font-weight: 600;
  margin-right: 8px;
}

.cq-modal-fields ul {
  margin: 8px 0 0 20px;
  padding: 0;
}

.cq-modal-fields li {
  margin-bottom: 4px;
  color: #374151;
}


.cq-close:hover { color: #ff5361; }
.cq-modal-title {
  font-size: 1.7rem;
  font-weight: 700;
  margin-bottom: 0.7rem;
  color: #2176ff;
  text-align: center;
  letter-spacing: 0.5px;
}
.cq-modal-fields > div {
  margin-bottom: 0.55rem;
  font-size: 1.06rem;
}
.cq-modal-fields b {
  color: #404c64;
  font-weight: 600;
  margin-right: 4px;
}
.cq-modal-fields {
  margin-bottom: 1.25rem;
  margin-top: 0.5rem;
}
.cq-modal-btn {
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-right: 12px;
  transition: background-color 0.2s;
}

.cq-modal-btn:hover {
  background: #4338ca;
}

.cq-modal-btn:last-child {
  margin-right: 0;
}


@media (max-width: 560px) {
  .cq-modal-content {
    max-width: 97vw;
    min-width: unset;
    padding: 1rem 0.7rem 1.4rem 0.7rem;
  }
  .cq-modal-title {
    font-size: 1.22rem;
  }
}
.comment-panel {
    background: white;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.18);
    overflow: hidden;
    backdrop-filter: blur(20px);
}

.comment-panel-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: none;
}

.comment-panel-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
}

.mark-read-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
    margin-right: 8px;
}

.mark-read-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

.close-panel-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 8px 10px;
    border-radius: 8px;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
    line-height: 1;
    backdrop-filter: blur(10px);
}

.close-panel-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

/* Modern Notification Items */
.notification-item {
    position: relative;
    padding: 20px 24px;
    border-bottom: 1px solid #f1f5f9;
    background: white;
    transition: all 0.3s ease;
    cursor: pointer;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Replace your notification-item::before CSS with this gradient version */

.notification-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 4px;
    height: 100%;
    
    /* Beautiful gradient options - choose one: */
    
    /* Option 1: Blue to Purple */
    background: linear-gradient(180deg, #3b82f6 0%, #8b5cf6 100%);
    
    /* Option 2: Ocean Blue */
    /* background: linear-gradient(180deg, #06b6d4 0%, #3b82f6 100%); */
    
    /* Option 3: Sunset */
    /* background: linear-gradient(180deg, #f59e0b 0%, #ef4444 100%); */
    
    /* Option 4: Forest */
    /* background: linear-gradient(180deg, #10b981 0%, #059669 100%); */
    
    /* Option 5: Royal */
    /* background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); */
    
    /* Option 6: Neon */
    /* background: linear-gradient(180deg, #06ffa5 0%, #00d4ff 100%); */
    
    transform: scaleY(0);
    transition: transform 0.3s ease;
    border-radius: 0 2px 2px 0; /* Rounded right edge */
}

.notification-item:hover {
    background: #f8fafc;
    transform: translateX(4px);
}

.notification-item:hover::before {
    transform: scaleY(1);
}

.notification-item.read {
    background: #f9fafb;
    opacity: 0.7;
}

.notification-item.read::before {
    background: #94a3b8;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.notification-header strong {
    font-weight: 600;
    font-size: 0.95rem;
    color: #1e293b;
    line-height: 1.4;
    flex: 1;
    margin-right: 12px;
}

.notification-time {
    font-size: 0.75rem;
    color: #64748b;
    font-weight: 500;
    background: #f1f5f9;
    padding: 4px 8px;
    border-radius: 12px;
    white-space: nowrap;
}

.notification-body {
    font-size: 0.875rem;
    color: #475569;
    line-height: 1.5;
    margin: 0;
}

/* Unread indicator dot */
.notification-item:not(.read)::after {
    content: '';
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    background: #3b82f6;
    border-radius: 50%;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Modern scrollbar */
.notification-list {
    max-height: 500px;
    overflow-y: auto;
}

.notification-list::-webkit-scrollbar {
    width: 6px;
}

.notification-list::-webkit-scrollbar-track {
    background: #f1f5f9;
}

.notification-list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.notification-list::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Modern notification badge */
.notification-badge {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
color: transparent;
    border-radius: 50%;
    min-width: 22px;
    height: 22px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    line-height: 1;
    padding: 0;
    margin: 0;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    border: 2px solid white;
    position: absolute;
    top: -6px;
    right: -6px;
    animation: badge-bounce 0.6s ease;
}

@keyframes badge-bounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
/* Congrats Modal - should match your other modals */
#congratsModal {
  display: none;
  position: fixed;
  z-index: 1004; /* Higher than other modals */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
}

#congratsModal .cq-modal-content {
  background: white;
  margin: 10% auto;
  padding: 25px;
  width: 90%;
  max-width: 500px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  text-align: center;
  animation: modalFadeIn 0.3s ease-out;
}

#congratsModal .cq-modal-title {
  font-size: 1.8rem;
  color: #10b981;
  margin-bottom: 15px;
}

.cq-modal-title {
  font-size: 28px;
  font-weight: 600;
  color: #1f2937;
  margin: 0 0 24px 0;
  text-align: left;
}

#congratsModal .cq-modal-fields {
  font-size: 1.1rem;
  line-height: 1.6;
  margin: 20px 0;
}

.cq-modal-footer {
  margin-top: 32px;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

#congratsModal .cq-modal-btn {
  background: #10b981;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.2s;
}

#congratsModal .cq-modal-btn:hover {
  background: #0d9f6e;
}

@keyframes modalFadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}


/* CertQuest Modal Styling */
.certq-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  z-index: 10000;
  font-family: 'Inter', sans-serif;
  animation: certqFadeIn 0.3s ease-out;
}

.certq-modal-content {
  position: relative;
  background: white;
  width: 90%;
  max-width: 420px;
  margin: 100px auto;
  border-radius: 12px;
  padding: 28px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  border: 1px solid #e5e7eb;
}

.certq-modal-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #111827;
  margin-bottom: 1.25rem;
  text-align: center;
  line-height: 1.3;
}

.certq-modal-fields {
  color: #4b5563;
  font-size: 1rem;
  line-height: 1.5;
  padding: 0 0.5rem;
}

.certq-modal-footer {
  margin-top: 1.75rem;
  display: flex;
  justify-content: center;
  gap: 12px;
}

.certq-modal-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.95rem;
}

.certq-modal-btn:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

.certq-close {
  position: absolute;
  top: 16px;
  right: 20px;
  font-size: 1.75rem;
  color: #9ca3af;
  cursor: pointer;
  transition: color 0.2s ease;
  line-height: 1;
}

.certq-close:hover {
  color: #6b7280;
}

/* Animation */
@keyframes certqFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Responsive adjustments */
@media (max-width: 480px) {
  .certq-modal-content {
    width: 95%;
    padding: 20px;
  }
  
  .certq-modal-title {
    font-size: 1.3rem;
  }
  
  .certq-modal-btn {
    padding: 8px 16px;
  }
}

.cq-assignment-modal .complete-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 12px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  width: 100%;
  transition: background 0.2s;
}

.cq-assignment-modal .complete-btn:hover {
  background: #1d4ed8;
}

canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1000;
}

/* Add these styles to your CSS file */
.complete-btn {
  background: #2563eb; /* Your brand blue */
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%; /* Full width of container */
  margin-top: 1rem;
}

.complete-btn:hover {
  background: #1d4ed8; /* Slightly darker blue */
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.complete-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.complete-btn:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Optional: Add checkmark icon */
.complete-btn::after {
  content: '✓';
  font-size: 1.2rem;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.complete-btn:hover::after {
  opacity: 1;
}

.quiz-meta {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
  color: #666;
  font-size: 0.9rem;
}

.quiz-question {
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #eee;
}
 
.quiz-question:last-child {
  border-bottom: none;
}

.quiz-question h4 {
  margin-bottom: 0.8rem;
  color: #333;
}

.quiz-option {
  display: block;
  margin: 0.5rem 0;
  padding: 0.5rem;
  border-radius: 4px;
  cursor: pointer;
}

.quiz-option:hover {
  background: #f5f5f5;
}

.quiz-option input {
  margin-right: 0.5rem;
}

#submitQuizBtn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.cq-speaking-modal {
  position: fixed;
  z-index: 3100;
  left: 0; top: 0; right: 0; bottom: 0;
  align-items: center;
  justify-content: center;
  background: rgba(36, 45, 74, 0.17);
}
.cq-speaking-modal-content {
  background: #fff;
  border-radius: 2rem;
  box-shadow: 0 10px 40px rgba(24,36,85,.14), 0 1.5px 3px rgba(44,62,80,.05);
  max-width: 420px;
  width: 95%;
  padding: 2.2rem 2.5rem 2rem 2.5rem;
  position: relative;
  animation: modalpop .23s cubic-bezier(.51,1.35,.5,1) 1;
}
.cq-speaking-title {
  margin-bottom: 1.25rem;
  font-size: 1.6rem;
  font-weight: 700;
  color: #1750eb;
  text-align: center;
}
.cq-speaking-section {
  margin-bottom: 1.25rem;
}
.cq-speaking-label {
  font-weight: 600;
  color: #2b3751;
  margin-bottom: 0.25rem;
  display: block;
  font-size: 1rem;
}
.cq-speaking-qtext {
  margin-bottom: 0.4rem;
  font-size: 1.03rem;
  color: #2d3646;
  background: #f5f7fd;
  padding: 0.5rem 0.85rem;
  border-radius: 0.8rem;
}
.cq-speaking-btn {
  background: #2563eb;
  color: #fff;
  font-weight: 600;
  border: none;
  border-radius: 1.1rem;
  padding: 0.65rem 1.25rem;
  margin-right: 0.5rem;
  margin-top: 0.5rem;
  font-size: 1rem;
  transition: background .15s;
  cursor: pointer;
  box-shadow: 0 1.5px 4px rgba(44,62,80,.07);
}
.cq-speaking-btn:hover, .cq-speaking-btn:focus {
  background: #1a42a6;
}
.cq-speaking-submit {
  margin-top: 1.2rem;
  width: 100%;
  font-size: 1.1rem;
}
.cq-speaking-close {
  position: absolute;
  top: 1.2rem;
  right: 1.2rem;
  font-size: 2rem;
  font-weight: 600;
  color: #d0d3e2;
  cursor: pointer;
  z-index: 3;
}
.cq-speaking-close:hover { color: #4f5ca3; }
.cq-speaking-video, .cq-speaking-audio {
  border-radius: 1rem;
  background: #eef1f8;
  border: 1px solid #e4e7f5;
  margin-bottom: 1rem;
  margin-top: 0.2rem;
  width: 100%;
  outline: none;
}

.cq-speaking-section {
  margin: 1.5rem 0;
  font-family: 'Inter', sans-serif;
  color: #1e293b; /* dark slate */
}

.cq-speaking-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.6rem;
  font-size: 1.1rem;
  color: #334155; /* softer dark */
}

.recording-controls {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.recording-controls button {
  background-color: transparent;
  border: 1.5px solid #3b82f6; /* subtle blue border */
  color: #3b82f6;
  font-size: 1rem;
  padding: 0.5rem 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.3s ease, color 0.3s ease;
  box-shadow: none;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.recording-controls button:hover:not(:disabled) {
  background-color: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.recording-controls button:disabled {
  border-color: #a5b4fc;
  color: #a5b4fc;
  cursor: not-allowed;
}

#cq-speaking-submitBtn {
  background-color: transparent;
  border: 1.5px solid #10b981; /* subtle green border */
  color: #10b981;
  font-weight: 600;
  padding: 0.65rem 2rem;
  font-size: 1.1rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.3s ease, color 0.3s ease;
  width: 100%;
  max-width: 320px;
  margin: 1rem auto 0 auto;
  display: block;
}

#cq-speaking-submitBtn:hover:not(:disabled) {
  background-color: #10b981;
  color: white;
  border-color: #10b981;
}

#cq-speaking-submitBtn:disabled {
  border-color: #a7f3d0;
  color: #a7f3d0;
  cursor: not-allowed;
}


.media-preview {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 0.5rem;
}

.media-preview audio,
.media-preview video {
  border-radius: 8px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
  max-width: 100%;
  outline: none;
}

#cq-speaking-submitBtn {
  background-color: #4a90e2; /* pastel blue */
  color: white;
  font-weight: 600;
  padding: 0.65rem 2.2rem;
  font-size: 1.15rem;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  transition: background-color 0.25s ease;
  width: 100%;
  max-width: 360px;
  display: block;
  margin: 1.5rem auto 0 auto;
  box-shadow: none;
}

#cq-speaking-submitBtn:hover:not(:disabled) {
  background-color: #357abd; /* slightly deeper blue */
}

#cq-speaking-submitBtn:disabled {
  background-color: #a3c2f2; /* lighter pastel blue */
  cursor: not-allowed;
  color: #e0e6f7;
}

.drag-drop-zone {
  border: 2px dashed #2563eb;
  border-radius: 10px;
  background: #f3f6fd;
  padding: 2rem;
  text-align: center;
  font-size: 1.1rem;
  color: #2563eb;
  cursor: pointer;
  margin: 1rem 0;
  transition: all 0.2s ease;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.drag-drop-zone:hover {
  background: #e0ebff;
  border-color: #1e40af;
  transform: translateY(-1px);
}

#cq-speaking-uploadSubmitBtn {
  width: 100%;
  margin-top: 1rem;
  padding: 12px 24px;
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

#cq-speaking-uploadSubmitBtn:hover:not(:disabled) {
  background: #1e40af;
  transform: translateY(-1px);
}

#cq-speaking-uploadSubmitBtn:disabled {
  background: #94a3b8;
  cursor: not-allowed;
  transform: none;
}

#mentorCommentModal {
  display: none; /* hidden by default */
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100vw; height: 100vh;
  background: rgba(30, 41, 59, 0.30); /* translucent dark overlay */
  z-index: 5000;
  align-items: center;
  justify-content: center;
}

#mentorCommentModal .modal-content {
  background: #fff;
  border-radius: 1.25rem;
  box-shadow: 0 4px 40px rgba(0,0,0,0.13), 0 1.5px 8px rgba(60,60,120,0.08);
  padding: 2.2rem 2.5rem;
  max-width: 390px;
  width: 100%;
  margin: 0 auto;
  text-align: left;
  position: relative;
  animation: popIn 0.19s cubic-bezier(.42,1.54,.64,1) 1;
}

#mentorCommentModal .close {
  position: absolute;
  top: 20px;
  right: 24px;
  font-size: 2rem;
  color: #444;
  background: none;
  border: none;
  cursor: pointer;
  transition: color 0.13s;
}
#mentorCommentModal .close:hover {
  color: #2563eb;
}

#mentorCommentAssignment {
  font-size: 1.15rem;
  font-weight: 700;
  margin-bottom: 1rem;
  color: #222;
}
#mentorCommentText {
  color: #444;
  font-size: 1.04rem;
  margin-bottom: 1.3rem;
}

#mentorCommentModal .btn {
  background: linear-gradient(90deg, #aee7f5, #e0c3fc);
  color: #1e293b;
  border: none;
  border-radius: 0.95rem;
  padding: 0.7rem 1.5rem;
  font-size: 1.05rem;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: background 0.14s, transform 0.09s;
}
#mentorCommentModal .btn:hover {
  background: linear-gradient(90deg, #dbeafe, #f3e8ff);
  transform: translateY(-2px) scale(1.03);
}

@keyframes popIn {
  from { transform: scale(0.92); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* Add to your home.css */
.competency-result {
  margin: 1rem 0;
  padding: 0.5rem;
  background: #f8fafc;
  border-radius: 8px;
}

.progress-bar {
  height: 6px;
  background: #e2e8f0;
  border-radius: 3px;
  margin-top: 0.5rem;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: #4ade80;
  transition: width 0.3s ease;
}

.cq-modal-fields h4 {
  margin-bottom: 0.5rem;
  color: #334155;
}

.competency-result {
    margin: 1rem 0;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
}

.question-result {
    margin: 0.5rem 0;
    padding: 0.5rem;
}

.question-result.correct {
    border-left: 4px solid #4ade80;
}

.question-result.incorrect {
    border-left: 4px solid #f87171;
}

.comment-panel {
  position: fixed;
  top: 60px;
  left: 70px; /* align with edge of sidebar */
  width: 400px;
  height: calc(100% - 60px);
  background: #fff;
  border-right: 1px solid #ddd;
  box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1); /* shadow now on right side */
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
}

.comment-panel.active {
  transform: translateX(0);
}


.comment-header {
  display: flex;
  justify-content: space-between;
  padding: 1rem;
  font-weight: bold;
  border-bottom: 1px solid #eee;
}

.comment-content {
  padding: 1rem;
  flex: 1;
  overflow-y: auto;
}

.reply-container {
  padding: 1rem;
  border-top: 1px solid #eee;
}

.reply-box {
  width: 100%;
  height: 60px;
  padding: 0.75rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  resize: none;
}

.comment {
  background: #f7f7f7;
  padding: 0.75rem;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
}

.cq-written-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease-out;
}

.cq-written-modal-content {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 680px;
  max-height: 85vh;
  overflow: hidden;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  display: flex;
  flex-direction: column;
  animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(40px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.cq-written-header {
  padding: 24px 32px 20px;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.cq-written-title-section {
  flex: 1;
}

.cq-written-title {
  font-size: 24px;
  font-weight: 600;
  color: #1a202c;
  margin: 0 0 8px 0;
  line-height: 1.3;
}

.cq-written-meta {
  display: flex;
  gap: 20px;
  font-size: 14px;
  color: #64748b;
  font-weight: 500;
}

.cq-written-close {
  background: none;
  border: none;
  font-size: 28px;
  color: #94a3b8;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.cq-written-close:hover {
  background: #f1f5f9;
  color: #475569;
}

.cq-written-body {
  padding: 32px;
  flex: 1;
  overflow-y: auto;
}

.cq-written-competency {
  display: inline-block;
  background: #dbeafe;
  color: #1e40af;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 20px;
}

.cq-written-question {
  font-size: 20px;
  font-weight: 500;
  color: #1a202c;
  line-height: 1.4;
  margin-bottom: 32px;
}

.cq-written-options {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.cq-written-option {
  display: flex;
  align-items: flex-start;
  padding: 20px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  background: white;
}

.cq-written-option:hover {
  border-color: #cbd5e1;
  background: #f8fafc;
}

.cq-written-option.selected {
  border-color: #3b82f6;
  background: #f0f9ff;
}

.cq-written-option input[type="radio"] {
  margin: 0 16px 0 0;
  width: 20px;
  height: 20px;
  accent-color: #3b82f6;
  cursor: pointer;
}

.cq-written-option-text {
  flex: 1;
  font-size: 16px;
  color: #374151;
  line-height: 1.5;
}

.cq-written-footer {
  padding: 24px 32px;
  border-top: 1px solid #e2e8f0;
  background: #fafbfc;
}

.cq-written-progress {
  margin-bottom: 16px;
}

.cq-written-progress-bar {
  width: 100%;
  height: 6px;
  background: #e2e8f0;
  border-radius: 3px;
  overflow: hidden;
}

.cq-written-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #1d4ed8);
  border-radius: 3px;
  transition: width 0.3s ease;
  width: 10%; /* Will be updated by JavaScript */
}

.cq-written-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.cq-written-btn {
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 100px;
}

.cq-written-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.cq-written-btn-secondary {
  background: white;
  color: #64748b;
  border: 1px solid #e2e8f0;
}

.cq-written-btn-secondary:hover:not(:disabled) {
  background: #f8fafc;
  border-color: #cbd5e1;
}

.cq-written-btn-primary {
  background: #3b82f6;
  color: white;
}

.cq-written-btn-primary:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Mobile responsiveness */
@media (max-width: 640px) {
  .cq-written-modal-content {
    width: 95%;
    max-height: 95vh;
  }
  
  .cq-written-header {
    padding: 20px 24px 16px;
  }
  
  .cq-written-body {
    padding: 24px;
  }
  
  .cq-written-footer {
    padding: 20px 24px;
  }
  
  .cq-written-title {
    font-size: 20px;
  }
  
  .cq-written-question {
    font-size: 18px;
  }
  
  .cq-written-option {
    padding: 16px;
  }
}

/* Replace your existing .cq-written-modal styles with: */
.cq-written-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
}

.cq-written-modal-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* Enhanced header styling */
.cq-written-header {
    padding: 24px 24px 0 24px;
    border-bottom: none;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.cq-written-title {
    font-size: 24px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 8px 0;
}

.cq-written-meta {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #64748b;
    font-weight: 500;
}

.cq-written-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #94a3b8;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
}

.cq-written-close:hover {
    background: #f1f5f9;
    color: #64748b;
}

/* Body styling */
.cq-written-body {
    padding: 24px;
    flex: 1;
    overflow-y: auto;
}

.cq-written-competency {
    background: #dbeafe;
    color: #1e40af;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: inline-block;
    margin-bottom: 20px;
}

.cq-written-question {
    font-size: 18px;
    font-weight: 500;
    color: #1e293b;
    line-height: 1.5;
    margin: 0 0 24px 0;
}

/* Enhanced options styling */
.cq-written-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.cq-written-option {
    display: flex;
    align-items: flex-start;
    padding: 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.cq-written-option:hover {
    border-color: #cbd5e1;
    background: #f8fafc;
}

.cq-written-option.selected {
    border-color: #3b82f6;
    background: #eff6ff;
}

.cq-written-option input[type="radio"] {
    margin: 2px 12px 0 0;
    width: 18px;
    height: 18px;
    accent-color: #3b82f6;
    flex-shrink: 0;
}

.cq-written-option-text {
    flex: 1;
    font-size: 16px;
    color: #374151;
    line-height: 1.5;
}

/* Footer styling */
.cq-written-footer {
    padding: 24px;
    border-top: 1px solid #e2e8f0;
    background: #fafafa;
}

.cq-written-progress {
    margin-bottom: 16px;
}

.cq-written-progress-bar {
    width: 100%;
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
}

.cq-written-progress-fill {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s ease;
    border-radius: 3px;
}

.cq-written-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.cq-written-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    min-width: 80px;
}

.cq-written-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.cq-written-btn-secondary {
    background: #f1f5f9;
    color: #64748b;
}

.cq-written-btn-secondary:hover:not(:disabled) {
    background: #e2e8f0;
    color: #475569;
}

.cq-written-btn-primary {
    background: #3b82f6;
    color: white;
}

.cq-written-btn-primary:hover:not(:disabled) {
    background: #2563eb;
}


.record-my-answer-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 15px 30px;
    border-radius: 25px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    width: 100%;
    margin: 20px 0;
}

.record-my-answer-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
}
</style>
</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">🌐</div>
    <div class="nav-title">Dashboard <span class="new-badge">(New!)</span></div>
    <div class="nav-right">
  <input type="text" id="navbarSearch" placeholder="Search CertQuest..." />
  <span class="search-icon" id="navbarSearchIcon">🔍</span>
  <div id="searchDropdown"></div>
</div>
  </div>

  <div class="main-layout">
    <!-- Sidebar -->
   <aside class="sidebar">
      <div class="logo">FB</div>
      <ul class="nav-icons">
  <li>
     <a href="/Public/home.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3L20 9V21H15V15H9V21H4V9L12 3Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M12 3L4 9V21H9V15H15V21H20V9L12 3Z" stroke="#3b82f6" stroke-width="2" fill="none" stroke-linejoin="round"/>
      <rect x="10" y="17" width="4" height="4" fill="#3b82f6"/>
      <rect x="6" y="11" width="2" height="2" fill="#3b82f6"/>
      <rect x="16" y="11" width="2" height="2" fill="#3b82f6"/>
    </svg>
    
    <span class="nav-label">Home</span>
     </a>
  </li>
  <li>
  <a href="#" onclick="openNotificationsOnHome(); return false;">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <!-- Bell body main fill -->
    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" fill="#3b82f6" fill-opacity="0.3"/>
    <!-- Bell body lighter overlay -->
    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 12 6 15 6 15H18C18 15 18 12 18 8Z" fill="#3b82f6" fill-opacity="0.2"/>
    <!-- Bell outline -->
    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
    <!-- Bell clapper -->
    <circle cx="12" cy="8" r="1" fill="#3b82f6"/>
    <!-- Sound waves -->
    <path d="M19 4L20 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
    <path d="M20.5 6.5L22 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
    <path d="M5 4L4 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
    <path d="M3.5 6.5L2 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
    <!-- Bottom notification indicator -->
    <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <span class="nav-label">Notifications</span>
</a>
</li>
  <li>
    <a href="/Public/practice.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="9" fill="#3b82f6" fill-opacity="0.3"/>
      <circle cx="12" cy="12" r="6" fill="#3b82f6" fill-opacity="0.2"/>
      <circle cx="12" cy="12" r="9" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <circle cx="12" cy="12" r="6" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="3" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="1.5" fill="#3b82f6"/>
      <path d="M16 8L12 12L16 8Z" fill="#3b82f6"/>
      <line x1="16" y1="8" x2="19" y2="5" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Practice</span>
    </a>
  </li>
  <li>
    <a href="/Public/Forum/forum.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" fill="#3b82f6" fill-opacity="0.2"/>
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <line x1="11" y1="8" x2="17" y2="8" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="11" y1="10" x2="15" y2="10" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Forum</span>
    </a>
  </li>
  <li>
     <a href="/Public/Calendar/calendar.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="3" y="6" width="18" height="15" rx="2" fill="#3b82f6" fill-opacity="0.3"/>
      <rect x="3" y="6" width="18" height="4" rx="2" fill="#3b82f6" fill-opacity="0.2"/>
      <rect x="3" y="6" width="18" height="15" rx="2" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <line x1="7" y1="3" x2="7" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="17" y1="3" x2="17" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="10" x2="21" y2="10" stroke="#3b82f6" stroke-width="1" opacity="0.5"/>
      <line x1="7.5" y1="10" x2="7.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="12" y1="10" x2="12" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="16.5" y1="10" x2="16.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <circle cx="9" cy="13" r="1" fill="#3b82f6"/>
      <circle cx="15" cy="16" r="1" fill="#3b82f6"/>
      <circle cx="12" cy="18" r="1" fill="#3b82f6"/>
    </svg>
    <span class="nav-label">Calendar</span>
     </a>
  </li>
</ul>
    </aside>

      
      <section class="tutor-trainings" id="gridSection">
  <div class="header-section">
    <span class="heading">Mentor Training</span>
    <p class="subtext">Boost your tutoring skills with these tips, strategies, and guides. When you're done, refresh concepts by reviewing completed trainings!</p>
  </div>
  <div class="tab-wrapper">
    <div class="tabs">
      <button class="tab active">Incomplete</button>
      <button class="tab" id="completedTab">Completed</button>
    </div>
  </div>
  <!-- THIS IS ALL YOU NEED! -->
  <div class="training-grid"></div>
</section>


    <!-- Full Page Module View -->

<!-- Module view panel -->
<div id="moduleView" class="hidden">
  <div class="module-content">
   <button id="backToModulesBtn">← Back</button>
   <div class="moduleText"></div>
    <h2 id="moduleTitle"></h2>
    <div id="moduleContent"></div>
    <div class="module-nav-buttons">
      <div class="center-proceed-btn">
        <button id="proceedToNextBtn">Proceed →</button>
      </div>
    </div>
    </div>

  </div>
</div>

<!-- Fullscreen Quiz View -->
<div id="quizView" class="quiz-view hidden">
  <div class="quiz-container">
    <div class="quiz-question">
      <span class="question-number" id="quizNumber">1 →</span>
      <span class="question-text" id="quizText">As a tutor, why do you ask learners questions?*</span>
    </div>
    <textarea class="quiz-answer" id="quizAnswer" placeholder="Type your answer here..."></textarea>
    <div class="quiz-submit-row">
      <button class="submit-btn" id="quizOkBtn">OK</button>
      <span class="enter-hint">press <strong>Enter ↵</strong></span>
    </div>
  </div>
</div>

  <div id="goalModal" class="goal-modal" style="display:none;">
    <div class="modal-content">
      <h2>Set a Study Goal</h2>
      <div class="goal-choices">
        <div class="goal-card" data-goal="passive">Passive<br><span>20 min/week</span></div>
        <div class="goal-card" data-goal="active">Active<br><span>1 hr/week</span></div>
        <div class="goal-card" data-goal="committed">Committed<br><span>2 hrs/week</span></div>
        <div class="goal-card" data-goal="running">Running the Show<br><span>4+ hrs/week</span></div>
      </div>
      <label for="comps">What competitions are you in?</label>
      <input id="comps" type="text" placeholder="Math, FBLA, DECA, etc">

      <div style="margin: 1.2rem 0 0.5rem 0;display:flex;align-items:center;gap:0.5rem;">
        <input type="checkbox" id="isMentor" style="width:18px;height:18px;accent-color:#2563eb;">
        <label for="isMentor" style="margin:0;font-size:1rem;">I am a mentor for a competition</label>
      </div>

      <div id="mentorCompDiv" style="display:none;">
        <label for="mentorComp" style="margin: 1.2rem 0 0.5rem 0;">Which competition?</label><br><br>
        <input id="mentorComp" type="text" placeholder="e.g., Partnership with Business">
      </div>

      <button id="goalSubmitBtn" disabled>Save</button>
    </div>
  </div>
  <div class="modal-backdrop"  style="display:none;"></div>



<!-- Backdrop and modal should be siblings -->
<div class="modal-backdrop hidden"></div>

<div id="trainingModal" class="modal hidden">
  <div class="modal-content">
    <button class="close-modal">&times;</button>
    <h2 id="modalTitle"></h2>
    <div class="modal-meta">
      <span class="skill-badge">SKILL BUILDER</span>
      <span id="modalTime">8 mins</span>
      <span class="sp-badge">+10 SP</span>
    </div>
    <h3>Description</h3>
    <p id="modalDesc"></p>
    <ul id="modalBullets"></ul>
    <button id="startTrainingBtn">Start Training ↗</button>
  </div>
</div>





<script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- ELEMENTS ---
  const moduleView = document.getElementById("moduleView");
  const moduleTitle = document.getElementById("moduleTitle");
  const moduleContent = document.getElementById("moduleContent");
  const backBtn = document.getElementById("backToModulesBtn");
  const modal = document.getElementById("trainingModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalDesc = document.getElementById("modalDesc");
  const modalTime = document.getElementById("modalTime");
  const modalBullets = document.getElementById("modalBullets");
  const closeModal = document.querySelector(".close-modal");
  const startBtn = document.getElementById("startTrainingBtn");
  const quizView = document.getElementById("quizView");
  const proceedBtn = document.getElementById("proceedToNextBtn");
  const tabs = document.querySelectorAll(".tab");
  const gridSection = document.getElementById("gridSection");
  const grid = document.querySelector(".training-grid");

  // --- QUIZ ELEMENTS ---
  const quizNumber = document.getElementById("quizNumber");
  const quizText = document.getElementById("quizText");
  const quizAnswer = document.getElementById("quizAnswer");
  const quizOkBtn = document.getElementById("quizOkBtn");

  // --- FIREBASE ---
  const firebaseConfig = {
    apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
    authDomain: "certquest-94959.firebaseapp.com",
    projectId: "certquest-94959",
    storageBucket: "certquest-94959.appspot.com",
    messagingSenderId: "323956529033",
    appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
    measurementId: "G-F5JHTGGN6K"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- MODULE DATA ---
const MODULE_DATA = {
  "handling-questions": {
    title: "Handling Student Questions Effectively",
    description: "Learn strategies to answer questions clearly, encourage critical thinking, and guide students without giving away solutions.",
    bullets: ["The Socratic method", "When to provide direct answers", "Encouraging independent problem-solving"],
    time: "12 mins",
    sp: "+10 SP",
    content: `
      <h3>The Balance: Helping vs. Solving</h3>
      <p>As a mentor, your goal is to guide students toward understanding, not to solve problems for them. This develops their problem-solving skills and builds confidence.</p>
      
      <h3>The Socratic Method</h3>
      <p>Use questions to guide thinking rather than providing answers directly:</p>
      <ul>
        <li><strong>"What have you tried so far?"</strong> - Assesses their current understanding</li>
        <li><strong>"What do you think might work?"</strong> - Encourages hypothesis formation</li>
        <li><strong>"Why do you think that didn't work?"</strong> - Promotes debugging skills</li>
        <li><strong>"What would happen if...?"</strong> - Explores consequences and alternatives</li>
        <li><strong>"Can you explain your approach to me?"</strong> - Reinforces understanding through teaching</li>
      </ul>
      
      <h3>When to Give Direct Answers</h3>
      <p>Sometimes direct answers are appropriate:</p>
      <ul>
        <li>Syntax or tool-specific questions ("How do I declare a variable in Python?")</li>
        <li>When a student is completely stuck and frustration is building</li>
        <li>Time-sensitive competition situations</li>
        <li>Safety or ethical concerns</li>
        <li>After they've genuinely tried multiple approaches</li>
      </ul>
      
      <h3>Techniques for Different Situations</h3>
      <p><strong>For vague questions:</strong> "Can you show me the specific part you're struggling with?"</p>
      
      <p><strong>For "it doesn't work" questions:</strong> "What error message are you getting? What output did you expect vs. what you got?"</p>
      
      <p><strong>For conceptual questions:</strong> Use analogies, draw diagrams, or work through a simpler example together.</p>
      
      <p><strong>For advanced students:</strong> "That's a good solution. Can you think of a way to make it more efficient/elegant?"</p>
      
      <h3>Building Independence</h3>
      <p>Teach students how to help themselves:</p>
      <ul>
        <li>Show them how to read documentation</li>
        <li>Demonstrate effective Google searching techniques</li>
        <li>Encourage rubber duck debugging (explaining code to an object)</li>
        <li>Teach them to break problems into smaller parts</li>
        <li>Model your own problem-solving process out loud</li>
      </ul>
    `
  },
  
  "engaging-inactive-members": {
    title: "Re-engaging Inactive Team Members",
    description: "Strategies to identify why members become inactive and techniques to bring them back into the fold.",
    bullets: ["Identifying root causes", "Personalized outreach strategies", "Creating inclusive environments"],
    time: "14 mins",
    sp: "+10 SP",
    content: `
      <h3>Common Reasons for Inactivity</h3>
      <p>Understanding the "why" helps you address the real issue:</p>
      <ul>
        <li><strong>Intimidation:</strong> Feels they're not skilled enough or can't contribute</li>
        <li><strong>Confusion:</strong> Doesn't know what to work on or how to get started</li>
        <li><strong>Isolation:</strong> Doesn't feel connected to the team or project</li>
        <li><strong>Overcommitment:</strong> Too busy with school, other activities, or personal issues</li>
        <li><strong>Boredom:</strong> Tasks aren't engaging or challenging enough</li>
        <li><strong>Conflict:</strong> Had a negative interaction or feels unwelcome</li>
      </ul>
      
      <h3>Initial Outreach</h3>
      <p><strong>One-on-one conversations work best:</strong></p>
      <ul>
        <li>Reach out privately via text, Discord, or in person</li>
        <li>Use a friendly, non-judgmental tone: "Hey, we've missed you at meetings! Is everything okay?"</li>
        <li>Listen actively without making assumptions</li>
        <li>Ask open-ended questions: "What would make you more excited to participate?"</li>
      </ul>
      
      <p><strong>Avoid:</strong></p>
      <ul>
        <li>Calling them out publicly about their absence</li>
        <li>Making them feel guilty ("We really needed you...")</li>
        <li>Pressuring them to commit immediately</li>
      </ul>
      
      <h3>Tailored Re-engagement Strategies</h3>
      <p><strong>If intimidated:</strong></p>
      <ul>
        <li>Assign a buddy or mentor for support</li>
        <li>Find tasks matched to their current skill level</li>
        <li>Share that everyone started somewhere and mistakes are normal</li>
        <li>Highlight their past contributions (no matter how small)</li>
      </ul>
      
      <p><strong>If confused:</strong></p>
      <ul>
        <li>Provide clear, specific tasks with step-by-step guidance</li>
        <li>Create onboarding documentation or videos</li>
        <li>Schedule a "catch-up" session to explain current projects</li>
      </ul>
      
      <p><strong>If isolated:</strong></p>
      <ul>
        <li>Introduce them to other members personally</li>
        <li>Include social activities (game nights, team dinners)</li>
        <li>Pair them with someone with similar interests</li>
        <li>Create smaller sub-teams for projects</li>
      </ul>
      
      <p><strong>If overcommitted:</strong></p>
      <ul>
        <li>Offer flexible participation options (async tasks, shorter time commitments)</li>
        <li>Let them contribute in ways that fit their schedule</li>
        <li>Keep them in the loop even if they can't actively participate</li>
      </ul>
      
      <h3>Creating an Inclusive Culture</h3>
      <p>Prevention is the best medicine:</p>
      <ul>
        <li>Celebrate all contributions, big and small</li>
        <li>Create tasks for all skill levels</li>
        <li>Make meetings welcoming (start with icebreakers, recognize people by name)</li>
        <li>Have a "no stupid questions" policy and model it yourself</li>
        <li>Check in regularly with quieter members</li>
      </ul>
      
      <h3>When to Let Go</h3>
      <p>Sometimes people genuinely need to step back. That's okay:</p>
      <ul>
        <li>Respect their decision without guilt-tripping</li>
        <li>Leave the door open: "You're always welcome back!"</li>
        <li>Keep them on communications for updates</li>
        <li>Focus energy on engaged members</li>
      </ul>
    `
  },
  
  "teaching-technical-concepts": {
    title: "Teaching Technical Concepts",
    description: "Break down complex programming and engineering concepts into digestible lessons for students with varying skill levels.",
    bullets: ["Scaffolding learning", "Using analogies effectively", "Hands-on practice design"],
    time: "15 mins",
    sp: "+10 SP",
    content: `
      <h3>Know Your Audience</h3>
      <p>Before teaching, assess:</p>
      <ul>
        <li>Prior knowledge: What do they already understand?</li>
        <li>Learning goals: What do they need to accomplish?</li>
        <li>Learning styles: Visual, hands-on, verbal, reading/writing</li>
        <li>Attention span: Keep sessions focused and time-limited</li>
      </ul>
      
      <h3>The Learning Progression</h3>
      <p><strong>1. Concrete before Abstract</strong></p>
      <p>Start with tangible examples, then generalize:</p>
      <ul>
        <li>Show a working example first</li>
        <li>Let them interact with it</li>
        <li>Then explain the underlying concept</li>
        <li>Example: Let them play with a robot before explaining PID controllers</li>
      </ul>
      
      <p><strong>2. Build on What They Know</strong></p>
      <p>Connect new concepts to familiar ones:</p>
      <ul>
        <li>"A variable is like a labeled box that holds information"</li>
        <li>"A loop is like doing your homework problems 1 through 10"</li>
        <li>"Git is like 'Save As' with superpowers"</li>
      </ul>
      
      <p><strong>3. Chunking Information</strong></p>
      <p>Break complex topics into smaller pieces:</p>
      <ul>
        <li>Teach one concept at a time</li>
        <li>Master each piece before combining</li>
        <li>Example: For a robot arm - first position, then velocity, then trajectory</li>
      </ul>
      
      <h3>Effective Analogies</h3>
      <p>Good analogies bridge the gap between known and unknown:</p>
      <ul>
        <li><strong>Arrays:</strong> Like a row of mailboxes, each with a number</li>
        <li><strong>Functions:</strong> Like a recipe - inputs (ingredients), process (steps), output (food)</li>
        <li><strong>Recursion:</strong> Like Russian nesting dolls or "Inception"</li>
        <li><strong>Pointers:</strong> Like a house address vs. the actual house</li>
        <li><strong>Classes/Objects:</strong> Like a cookie cutter (class) and cookies (objects)</li>
      </ul>
      
      <p><strong>Warning:</strong> Don't overuse analogies - acknowledge their limitations when they break down.</p>
      
      <h3>Hands-On Practice</h3>
      <p><strong>The 20-80 Rule:</strong> 20% explaining, 80% doing</p>
      
      <p><strong>Progression:</strong></p>
      <ol>
        <li><strong>I do, you watch:</strong> Demonstrate while explaining</li>
        <li><strong>We do together:</strong> Walk through example side-by-side</li>
        <li><strong>You do, I help:</strong> They try while you provide hints</li>
        <li><strong>You do, I watch:</strong> They work independently</li>
      </ol>
      
      <p><strong>Practice Exercise Design:</strong></p>
      <ul>
        <li>Start simple, gradually increase complexity</li>
        <li>Make exercises relevant to competition goals</li>
        <li>Provide immediate feedback</li>
        <li>Include both success and failure cases</li>
      </ul>
      
      <h3>Common Teaching Pitfalls</h3>
      <p><strong>The Curse of Knowledge:</strong> You forget what it's like not to know something. Combat this by:</p>
      <ul>
        <li>Asking "Does this make sense?" frequently</li>
        <li>Watching their face for confusion</li>
        <li>Having them explain it back to you</li>
        <li>Never saying "this is easy" or "obviously"</li>
      </ul>
      
      <p><strong>Information Overload:</strong> Don't dump everything at once:</p>
      <ul>
        <li>Focus on what they need now, not everything they might need ever</li>
        <li>Say "We'll cover that later" and mean it</li>
        <li>Provide resources for deeper learning</li>
      </ul>
      
      <h3>Checking for Understanding</h3>
      <ul>
        <li>Ask them to explain the concept in their own words</li>
        <li>Have them predict what will happen before running code</li>
        <li>Give them a slightly different problem to solve</li>
        <li>Watch them work - where do they get stuck?</li>
      </ul>
    `
  },
  
  "finding-resources": {
    title: "Finding & Creating Resources",
    description: "Master the art of finding quality learning materials, documentation, and tools while creating effective resources for your team.",
    bullets: ["Effective search strategies", "Evaluating resource quality", "Creating team documentation"],
    time: "13 mins",
    sp: "+10 SP",
    content: `
      <h3>Strategic Searching</h3>
      <p><strong>Google Search Operators:</strong></p>
      <ul>
        <li><strong>Exact phrase:</strong> "how to use PID control"</li>
        <li><strong>Site-specific:</strong> site:stackoverflow.com python lists</li>
        <li><strong>File type:</strong> filetype:pdf robotics tutorial</li>
        <li><strong>Exclude terms:</strong> java tutorial -android</li>
        <li><strong>Recent results:</strong> Use Tools → Any time → Past year</li>
      </ul>
      
      <p><strong>Where to Look:</strong></p>
      <ul>
        <li><strong>Official documentation:</strong> Always start here (Python docs, FRC docs, manufacturer manuals)</li>
        <li><strong>GitHub:</strong> Example code, libraries, similar projects</li>
        <li><strong>Stack Overflow:</strong> Specific programming problems</li>
        <li><strong>YouTube:</strong> Visual tutorials and walkthroughs</li>
        <li><strong>Reddit:</strong> r/programming, r/FRC, competition-specific subreddits</li>
        <li><strong>Discord servers:</strong> Competition communities for real-time help</li>
      </ul>
      
      <h3>Competition-Specific Resources</h3>
      <p><strong>For Robotics (FRC/FTC/VEX):</strong></p>
      <ul>
        <li>Chief Delphi forums</li>
        <li>Official game manuals and Q&A forums</li>
        <li>Team GitHub repositories (search "FRC 2024 robot code")</li>
        <li>WPILib documentation</li>
        <li>REV Robotics, CTRE, VEX learning resources</li>
      </ul>
      
      <p><strong>For Coding Competitions:</strong></p>
      <ul>
        <li>LeetCode, HackerRank, Codeforces</li>
        <li>Competition editorials and solution writeups</li>
        <li>Algorithm visualizers (VisuAlgo, Algorithm Visualizer)</li>
        <li>Competitive programming books (CLRS, CP Handbook)</li>
      </ul>
      
      <p><strong>For Science/Engineering Competitions:</strong></p>
      <ul>
        <li>Research journal databases (Google Scholar, JSTOR)</li>
        <li>University course materials (MIT OpenCourseWare)</li>
        <li>Previous competition winning projects and papers</li>
        <li>Expert contacts (professors, industry professionals)</li>
      </ul>
      
      <h3>Evaluating Resource Quality</h3>
      <p>Not all resources are created equal. Check:</p>
      <ul>
        <li><strong>Recency:</strong> Is it up-to-date? (Especially critical for rapidly changing tech)</li>
        <li><strong>Authority:</strong> Who created it? Are they credible?</li>
        <li><strong>Accuracy:</strong> Cross-reference with other sources</li>
        <li><strong>Clarity:</strong> Is it well-explained or confusing?</li>
        <li><strong>Completeness:</strong> Does it cover what you need?</li>
        <li><strong>Examples:</strong> Does it include working code/demonstrations?</li>
      </ul>
      
      <p><strong>Red Flags:</strong></p>
      <ul>
        <li>No date or very old (5+ years for tech content)</li>
        <li>Anonymous authors or no credentials</li>
        <li>Broken code examples or missing dependencies</li>
        <li>Overly promotional content</li>
        <li>No sources cited for claims</li>
      </ul>
      
      <h3>Creating Team Documentation</h3>
      <p><strong>Why Document?</strong></p>
      <ul>
        <li>Onboard new members faster</li>
        <li>Preserve knowledge when seniors graduate</li>
        <li>Reduce repeated questions</li>
        <li>Improve team consistency</li>
      </ul>
      
      <p><strong>What to Document:</strong></p>
      <ul>
        <li><strong>Setup guides:</strong> How to install tools, clone repos, run code</li>
        <li><strong>Architecture overviews:</strong> How your system works (diagrams help!)</li>
        <li><strong>Troubleshooting:</strong> Common problems and solutions</li>
        <li><strong>Best practices:</strong> Coding standards, workflow, communication norms</li>
        <li><strong>Lessons learned:</strong> What worked, what didn't, and why</li>
      </ul>
      
      <p><strong>Documentation Best Practices:</strong></p>
      <ul>
        <li>Use clear, simple language (write for beginners)</li>
        <li>Include screenshots, diagrams, and code snippets</li>
        <li>Keep it organized with clear sections and navigation</li>
        <li>Update it regularly (assign responsibility)</li>
        <li>Store it somewhere accessible (GitHub Wiki, Notion, Google Docs)</li>
        <li>Get feedback: Does it actually help new members?</li>
      </ul>
      
      <h3>Building a Resource Library</h3>
      <p>Curate and organize resources for your team:</p>
      <ul>
        <li>Create a shared bookmark folder or wiki</li>
        <li>Categorize by topic (programming, mechanical, strategy, etc.)</li>
        <li>Add brief descriptions: "Good for: beginners learning Python"</li>
        <li>Include date added and who recommended it</li>
        <li>Review and update annually</li>
      </ul>
    `
  },
  
  "time-management": {
    title: "Time Management & Project Planning",
    description: "Learn to balance mentoring responsibilities with competition deadlines, personal commitments, and avoiding burnout.",
    bullets: ["Prioritization frameworks", "Delegation strategies", "Setting healthy boundaries"],
    time: "14 mins",
    sp: "+10 SP",
    content: `
      <h3>The Mentor's Time Crunch</h3>
      <p>You're juggling: homework, college apps, personal life, mentoring duties, AND often technical work for the competition. Something has to give - let's make sure it's not your sanity.</p>
      
      <h3>Prioritization: The Eisenhower Matrix</h3>
      <p>Categorize tasks by urgency and importance:</p>
      
      <p><strong>Urgent + Important (DO NOW):</strong></p>
      <ul>
        <li>Competition deadline tomorrow</li>
        <li>Broken critical system</li>
        <li>Team conflict escalating</li>
      </ul>
      
      <p><strong>Important, Not Urgent (SCHEDULE):</strong></p>
      <ul>
        <li>Teaching foundational skills</li>
        <li>Creating documentation</li>
        <li>Long-term project planning</li>
        <li>Personal development</li>
      </ul>
      
      <p><strong>Urgent, Not Important (DELEGATE):</strong></p>
      <ul>
        <li>Routine questions others can answer</li>
        <li>Data entry or repetitive tasks</li>
        <li>Some meetings (send a representative)</li>
      </ul>
      
      <p><strong>Neither (ELIMINATE):</strong></p>
      <ul>
        <li>Perfectionism on non-critical work</li>
        <li>Unnecessary meetings</li>
        <li>Busy work that doesn't serve team goals</li>
      </ul>
      
      <h3>Effective Delegation</h3>
      <p><strong>Why mentors struggle to delegate:</strong></p>
      <ul>
        <li>"It's faster if I do it myself" (true now, false long-term)</li>
        <li>"No one else can do it as well" (they can learn!)</li>
        <li>"I don't want to burden others" (you're denying them growth)</li>
      </ul>
      
      <p><strong>How to delegate well:</strong></p>
      <ul>
        <li>Choose tasks that match the person's skill level + slight stretch</li>
        <li>Provide clear expectations and deadlines</li>
        <li>Give them authority to make decisions</li>
        <li>Be available for questions but don't micromanage</li>
        <li>Accept that it might be done differently (and that's okay!)</li>
      </ul>
      
      <p><strong>Good tasks to delegate:</strong></p>
      <ul>
        <li>Leading sub-teams or projects</li>
        <li>Creating tutorials or documentation</li>
        <li>Mentoring newer members (peer mentoring)</li>
        <li>Organizing meetings or events</li>
        <li>Testing and debugging</li>
      </ul>
      
      <h3>Time Management Strategies</h3>
      <p><strong>Time Blocking:</strong></p>
      <ul>
        <li>Schedule specific hours for mentoring (e.g., Tuesdays 4-6pm)</li>
        <li>Protect personal time blocks (homework, rest, family)</li>
        <li>Include buffer time between tasks</li>
        <li>Batch similar activities (answer all messages at once, not constantly)</li>
      </ul>
      
      <p><strong>The 2-Minute Rule:</strong></p>
      <p>If something takes less than 2 minutes, do it now. Otherwise, schedule it or delegate it.</p>
      
      <p><strong>Meeting Efficiency:</strong></p>
      <ul>
        <li>Always have an agenda</li>
        <li>Start and end on time</li>
        <li>Assign action items with owners and deadlines</li>
        <li>Consider if it could be an email instead</li>
      </ul>
      
      <h3>Setting Healthy Boundaries</h3>
      <p><strong>You are not on call 24/7:</strong></p>
      <ul>
        <li>Set "office hours" for questions</li>
        <li>Don't respond to messages immediately (response time ≠ value)</li>
        <li>It's okay to say "I can't help with this right now, but I can tomorrow"</li>
        <li>Teach team members to try solving problems themselves first</li>
      </ul>
      
      <p><strong>Saying No:</strong></p>
      <ul>
        <li>"I'd love to, but I'm at capacity right now"</li>
        <li>"That sounds great, but it's not aligned with our current priorities"</li>
        <li>"I can't take this on, but [person] might be able to help"</li>
        <li>Remember: Every yes to something is a no to something else</li>
      </ul>
      
      <h3>Avoiding Burnout</h3>
      <p><strong>Warning Signs:</strong></p>
      <ul>
        <li>Dreading team activities you used to enjoy</li>
        <li>Irritability or short temper</li>
        <li>Neglecting schoolwork, health, or relationships</li>
        <li>Physical exhaustion or illness</li>
        <li>Feeling like you can't step away</li>
      </ul>
      
      <p><strong>Prevention:</strong></p>
      <ul>
        <li>Schedule genuine breaks (no team stuff)</li>
        <li>Maintain hobbies and friendships outside the team</li>
        <li>Share responsibilities with co-mentors</li>
        <li>Celebrate wins, don't just focus on problems</li>
        <li>Remember: Taking care of yourself IS taking care of the team</li>
      </ul>
      
      <h3>Competition Crunch Time</h3>
      <p>During intense periods (weeks before competition):</p>
      <ul>
        <li>Communicate reduced availability in advance</li>
        <li>Focus on highest-impact activities only</li>
        <li>Rely more heavily on delegation</li>
        <li>Cut scope if necessary (better to have a working simple solution)</li>
        <li>Plan recovery time afterward</li>
      </ul>
    `
  },
  
  "conflict-resolution": {
    title: "Handling Team Conflict & Difficult Conversations",
    description: "Navigate interpersonal conflicts, address underperformance, and facilitate difficult but necessary conversations.",
    bullets: ["Conflict mediation techniques", "Addressing underperformance", "Maintaining team morale"],
    time: "16 mins",
    sp: "+10 SP",
    content: `
      <h3>Types of Team Conflict</h3>
      <p><strong>Task Conflict:</strong> Disagreements about the work itself (which algorithm, design choice, strategy). Often productive if managed well.</p>
      
      <p><strong>Process Conflict:</strong> Disagreements about how work should be done (workflow, roles, decision-making). Can be resolved with clear systems.</p>
      
      <p><strong>Relationship Conflict:</strong> Personal friction between team members (personality clashes, communication styles). Most damaging if left unaddressed.</p>
      
      <h3>Your Role as Mediator</h3>
      <p><strong>You are not a judge:</strong> Your goal isn't to determine who's "right" but to help the team move forward productively.</p>
      
      <p><strong>Stay neutral:</strong> Avoid taking sides, even if you privately agree with one person. Focus on understanding all perspectives.</p>
      
      <p><strong>Focus on behavior, not character:</strong> "When you interrupted during the meeting..." not "You're disrespectful."</p>
      
      <h3>Conflict Resolution Process</h3>
      <p><strong>Step 1: Assess the Situation</strong></p>
      <ul>
        <li>How serious is it? (Eye roll vs. shouting match)</li>
        <li>Can they resolve it themselves or do you need to intervene?</li>
        <li>Is it isolated or a pattern?</li>
        <li>Is anyone feeling unsafe?</li>
      </ul>
      
      <p><strong>Step 2: Create a Safe Space</strong></p>
      <ul>
        <li>Meet privately, not in front of the whole team</li>
        <li>Choose a neutral location</li>
        <li>Set ground rules: respectful language, no interrupting, focus on solutions</li>
        <li>Assure confidentiality (within reason)</li>
      </ul>
      
      <p><strong>Step 3: Understand All Perspectives</strong></p>
      <ul>
        <li>Let each person explain their view without interruption</li>
        <li>Ask clarifying questions: "Can you help me understand why that upset you?"</li>
        <li>Reflect back what you hear: "So you felt dismissed when..."</li>
        <li>Look for underlying needs (respect, autonomy, recognition)</li>
      </ul>
      
      <p><strong>Step 4: Find Common Ground</strong></p>
      <ul>
        <li>Identify shared goals: "You both want the robot to work well, right?"</li>
        <li>Acknowledge valid points from all sides</li>
        <li>Separate positions (what they want) from interests (why they want it)</li>
      </ul>
      
      <p><strong>Step 5: Generate Solutions Together</strong></p>
      <ul>
        <li>Ask: "What would make this situation better for you?"</li>
        <li>Brainstorm multiple options without judging</li>
        <li>Look for win-win solutions</li>
        <li>Be willing to compromise</li>
      </ul>
      
      <p><strong>Step 6: Agree and Follow Up</strong></p>
      <ul>
        <li>Get explicit agreement on the solution</li>
        <li>Define concrete action steps</li>
        <li>Set a check-in date to review progress</li>
        <li>Thank them for working through it</li>
      </ul>
      
      <h3>Specific Conflict Scenarios</h3>
      <p><strong>Scenario: Team Member Not Pulling Their Weight</strong></p>
      <ul>
        <li>First, investigate: Are they capable but unmotivated, or do they need help?</li>
        <li>Private conversation: "I've noticed you haven't completed X. What's going on?"</li>
        <li>Focus on impact: "When tasks aren't done, it affects the whole team because..."</li>
        <li>Collaboratively solve: "What support do you need to meet commitments?"</li>
        <li>Set clear expectations and consequences going forward</li>
      </ul>
      
      <p><strong>Scenario: Dominant Personalities Silencing Others</strong></p>
      <ul>
        <li>Implement structured turn-taking in meetings</li>
        <li>Directly ask quieter members: "Sarah, what's your take on this?"</li>
        <li>Private chat with dominant person: "Your ideas are valuable, AND I need to make sure everyone gets heard"</li>
        <li>Create anonymous feedback channels</li>
      </ul>
      
      <p><strong>Scenario: Cliques Forming</strong></p>
      <ul>
        <li>Mix up sub-teams regularly</li>
        <li>Create team-wide activities (not just work)</li>
        <li>Address it openly: "I've noticed we're forming separate groups. How can we stay connected as one team?"</li>
        <li>Model inclusive behavior yourself</li>
      </ul>
      
      <p><strong>Scenario: Disagreement About Technical Decisions</strong></p>
      <ul>
        <li>Use data: Test both approaches if possible</li>
        <li>Set decision-making criteria beforehand (speed, reliability, maintainability)</li>
        <li>Use a decision-making framework (voting, consensus, expert decides)</li>
        <li>Make the decision and commit as a team (even if not everyone's first choice)</li>
      </ul>
      
      <h3>Difficult Conversations: Addressing Behavior Problems</h3>
      <p><strong>Preparation:</strong></p>
      <ul>
        <li>Document specific incidents (dates, what happened, impact)</li>
        <li>Choose the right time and place (private, calm moment)</li>
        <li>Plan your talking points but be ready to adapt</li>
        <li>Check your emotions - if you're angry, wait until you're calm</li>
      </ul>
      
      <p><strong>The Conversation:</strong></p>
      <ol>
        <li><strong>State facts:</strong> "In the last three meetings, you've arrived 20+ minutes late"</li>
        <li><strong>Explain impact:</strong> "This disrupts the team and we have to repeat information"</li>
        <li><strong>Ask for their perspective:</strong> "What's making it difficult to arrive on time?"</li>
        <li><strong>Listen genuinely:</strong> There may be a valid reason you didn't know about</li>
        <li><strong>Collaborative solution:</strong> "What can we do to improve this?"</li
          <li><strong>Set clear expectations:</strong> "Going forward, I need you to..."</li>
        <li><strong>Agree on accountability:</strong> "Let's check in next week on this"</li>
      </ol>
      
      <p><strong>What if they get defensive?</strong></p>
      <ul>
        <li>Stay calm and don't match their energy</li>
        <li>Acknowledge their feelings: "I can see this is frustrating to hear"</li>
        <li>Refocus on facts and impact, not personal attack</li>
        <li>Take a break if needed: "Let's continue this conversation tomorrow"</li>
      </ul>
      
      <h3>When to Escalate</h3>
      <p>Some situations require adult intervention (teachers, coaches, advisors):</p>
      <ul>
        <li>Safety concerns (threats, physical altercation)</li>
        <li>Harassment or bullying</li>
        <li>Discrimination based on protected characteristics</li>
        <li>Situations beyond your authority or expertise</li>
        <li>When direct intervention hasn't worked</li>
      </ul>
      
      <p><strong>Don't feel like you've failed if you need to escalate.</strong> Knowing when to get help is a sign of good judgment, not weakness.</p>
      
      <h3>Maintaining Team Morale During Conflict</h3>
      <p><strong>Address issues quickly:</strong> Unresolved conflict festers and spreads</p>
      
      <p><strong>Keep conflicts contained:</strong> Don't let personal issues become team drama</p>
      
      <p><strong>Focus on solutions, not blame:</strong> "How do we prevent this going forward?"</p>
      
      <p><strong>Celebrate team wins:</strong> Positive shared experiences build cohesion</p>
      
      <p><strong>Model healthy conflict:</strong> Show that disagreement can be respectful and productive</p>
      
      <h3>Preventing Conflict</h3>
      <p>An ounce of prevention is worth a pound of cure:</p>
      <ul>
        <li><strong>Clear roles and responsibilities:</strong> Reduces turf battles</li>
        <li><strong>Established decision-making processes:</strong> Reduces power struggles</li>
        <li><strong>Communication norms:</strong> How we give feedback, run meetings, handle disagreements</li>
        <li><strong>Regular check-ins:</strong> Catch small issues before they become big problems</li>
        <li><strong>Team agreements:</strong> Collaboratively create a "team charter" with shared values</li>
      </ul>
      
      <h3>Self-Care for Mediators</h3>
      <p>Dealing with conflict is emotionally draining:</p>
      <ul>
        <li>Don't take it personally - it's usually not about you</li>
        <li>Debrief with a trusted mentor or advisor after difficult conversations</li>
        <li>Know your limits - you can't solve every problem</li>
        <li>Celebrate when conflicts are resolved successfully</li>
        <li>Remember: Some tension is normal in high-performing teams</li>
      </ul>
    `
  }
};

  const MODULE_IDS = Object.keys(MODULE_DATA);
  let mentorId = null; // will be set once we have UID
  let lastProgress = {};

  // --- QUIZ DATA ---
  const quizQuestions = [
    { question: "As a tutor, why do you ask learners questions?*", placeholder: "Type your answer here..." },
    { question: "How would you handle a student who isn't responding?", placeholder: "Type your answer here..." },
    { question: "Describe a strategy for keeping learners engaged.", placeholder: "Type your answer here..." }
  ];
  let quizIndex = 0;
  let currentModuleId = null;

  // --- DYNAMIC CARD RENDERING ---
  function renderTrainingGrid(progress, completed = false) {
    grid.innerHTML = "";
    MODULE_IDS.forEach(moduleId => {
      const module = MODULE_DATA[moduleId];
      const status = progress[moduleId] || "not-started";
      if ((completed && status === "completed") || (!completed && status !== "completed")) {
        const card = document.createElement("div");
        card.className = "training-card" + (status === "completed" ? " completed" : "");
        card.dataset.module = moduleId;
        card.innerHTML = `
          <div class="badge ${status === "completed" ? "completed" : "optional"}">
            ${status === "completed" ? "COMPLETED" : (status === "in-progress" ? "IN PROGRESS" : "NOT STARTED")}
          </div>
          <h4>${module.title}</h4>
          <p>${module.description}</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">${module.time}</span>
            <span class="sp">${module.sp}</span>
          </div>
        `;
        if (status !== "completed") {
          card.addEventListener("click", () => {
            currentModuleId = moduleId;
            setModuleStatus(moduleId, "in-progress").then(() => {
              showModuleModal(moduleId);
            });
          });
        }
        grid.appendChild(card);
      }
    });
  }

  // --- TABS HANDLING ---
  function showGridView() {
    gridSection.classList.remove("hidden");
    moduleView.classList.add("hidden");
    moduleView.classList.remove("active");
    quizView.classList.add("hidden");
    quizView.classList.remove("active");
    modal.classList.remove("active");
    modal.classList.add("hidden");
    renderTrainingGrid(lastProgress, false);
    if (tabs.length >= 2) {
      tabs[0].classList.add("active");
      tabs[1].classList.remove("active");
    }
    if (!document.getElementById("quizOkBtn") && quizView) {
      quizView.innerHTML = `
        <div class="quiz-container">
          <div class="quiz-question">
            <span class="question-number" id="quizNumber"></span>
            <span class="question-text" id="quizText"></span>
          </div>
          <textarea class="quiz-answer" id="quizAnswer" placeholder="Type your answer here..."></textarea>
          <div class="quiz-submit-row">
            <button class="submit-btn" id="quizOkBtn">OK</button>
            <span class="enter-hint">press <strong>Enter ↵</strong></span>
          </div>
        </div>
      `;
      setupQuizListeners();
    }
  }
  function showCompletedView() {
    gridSection.classList.remove("hidden");
    moduleView.classList.add("hidden");
    moduleView.classList.remove("active");
    quizView.classList.add("hidden");
    quizView.classList.remove("active");
    modal.classList.remove("active");
    modal.classList.add("hidden");
    renderTrainingGrid(lastProgress, true);
    if (tabs.length >= 2) {
      tabs[1].classList.add("active");
      tabs[0].classList.remove("active");
    }
  }
  if (tabs.length >= 2) {
    tabs[0].addEventListener("click", showGridView);
    tabs[1].addEventListener("click", showCompletedView);
  }

  // Add this function near your other helper functions

// REPLACE YOUR EXISTING setModuleStatus FUNCTION WITH THIS ONE:
async function setModuleStatus(moduleId, status) {
  const userId = await getCurrentUserId();
  if (!userId) return;
  
  console.log("Setting module status for user:", userId);
  
  // Store training progress under the Firebase Auth UID
  await db.doc(`users/${userId}/trainingProgress/${moduleId}`).set({ status }, { merge: true });
  
  // If completing a module, award XP to the Firebase Auth UID
  if (status === "completed") {
    console.log("Awarding XP to Firebase Auth UID:", userId);
    await awardXP(userId, 10, 'completing training module');
  }
}


// ADD THIS NEW FUNCTION TO GET THE ACTUAL USER ID FOR XP:
async function getCurrentUserId() {
  return new Promise((resolve) => {
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        console.log("Using Firebase Auth UID:", user.uid);
        resolve(user.uid);
      } else {
        console.log("No authenticated user found");
        resolve(null);
      }
    });
  });
}

// --- MODAL HANDLING ---
  function showModuleModal(moduleId) {
    const module = MODULE_DATA[moduleId];
    modalTitle.textContent = module.title;
    modalDesc.textContent = module.description;
    modalTime.textContent = module.time;
    modalBullets.innerHTML = module.bullets.map(b => `<li>${b}</li>`).join("");
    modal.classList.add("active");
    modal.classList.remove("hidden");
  }
  closeModal.addEventListener("click", () => {
    modal.classList.remove("active");
    modal.classList.add("hidden");
  });

  startBtn.addEventListener("click", () => {
    if (!currentModuleId) return;
    const module = MODULE_DATA[currentModuleId];
    moduleTitle.textContent = module.title;
    moduleContent.innerHTML = module.content;
    modal.classList.remove("active");
    modal.classList.add("hidden");
    gridSection.classList.add("hidden");
    moduleView.classList.remove("hidden");
    moduleView.classList.add("active");
    quizView.classList.add("hidden");
    quizView.classList.remove("active");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });
  backBtn.addEventListener("click", () => {
    moduleView.classList.add("hidden");
    moduleView.classList.remove("active");
    gridSection.classList.remove("hidden");
    quizView.classList.add("hidden");
    quizView.classList.remove("active");
    modal.classList.remove("active");
    modal.classList.add("hidden");
  });
  proceedBtn.addEventListener("click", () => {
    moduleView.classList.add("hidden");
    moduleView.classList.remove("active");
    showQuiz();
    gridSection.classList.add("hidden");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });


// --- XP FUNCTION (Your working version) ---
async function awardXP(userId, amount, reason) {
  try {
    const userRef = db.collection('users').doc(userId);
    const userDoc = await userRef.get();
    
    if (userDoc.exists) {
      await userRef.update({
        XP: firebase.firestore.FieldValue.increment(amount)
      });
    } else {
      await userRef.set({
        XP: amount
      });
    }
    
    console.log(`Awarded ${amount} XP to user ${userId} for ${reason}`);
    showXPNotification(amount, reason);
    
  } catch (error) {
    console.error("Failed to award XP:", error);
  }
}

// --- XP NOTIFICATION FUNCTION (Your working version) ---
function showXPNotification(amount, reason) {
  // Create notification element if it doesn't exist
  let notification = document.getElementById('xpNotification');
  if (!notification) {
    notification = document.createElement('div');
    notification.id = 'xpNotification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      font-weight: bold;
      z-index: 10000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    `;
    document.body.appendChild(notification);
  }
  
  notification.textContent = `🎉 +${amount} XP for ${reason}!`;
  notification.style.transform = 'translateX(0)';
  
  setTimeout(() => {
    notification.style.transform = 'translateX(400px)';
  }, 3000);
}

// --- UPDATED QUIZ COMPLETION LOGIC ---
function loadQuizQuestion(index) {
  const quizNumber = document.getElementById("quizNumber");
  const quizText = document.getElementById("quizText");
  const quizAnswer = document.getElementById("quizAnswer");
  const quizOkBtn = document.getElementById("quizOkBtn");
  
  if (index < quizQuestions.length) {
    quizNumber.textContent = `${index + 1} →`;
    quizText.textContent = quizQuestions[index].question;
    quizAnswer.value = "";
    quizAnswer.placeholder = quizQuestions[index].placeholder;
    quizAnswer.focus();
    quizOkBtn.onclick = function() {
      quizIndex++;
      loadQuizQuestion(quizIndex);
    };
    quizAnswer.onkeydown = function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        quizOkBtn.click();
      }
    };
  } else {
    // Quiz completed - this is where XP is awarded via setModuleStatus
    quizView.innerHTML = `
      <div style="
min-height: 90vh;
display: flex;
align-items: center;
justify-content: center;
background: transparent;
">
<div style="
  background: #fff;
  padding: 2.2rem 2.5rem 2rem 2.5rem;
  border-radius: 20px;
  box-shadow: 0 8px 40px rgba(37,99,235,0.08), 0 1.5px 4px rgba(0,0,0,0.07);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
">
  <div style="
    font-size: 2.1rem;
    font-weight: 800;
    color: #111;
    margin-bottom: 0.7rem;
    letter-spacing: -1px;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  ">
    All done! <span>🎉</span>
  </div>
  <button id="backToModulesFromQuiz" style="
    background: #2563eb;
    color: #fff;
    font-weight: 700;
    font-size: 1.15rem;
    border: none;
    border-radius: 9px;
    padding: 0.75rem 2.2rem;
    margin-top: 0;
    box-shadow: 0 2px 18px rgba(37,99,235,0.09);
    cursor: pointer;
    transition: background 0.18s;
  "
  onmouseover="this.style.background='#184dc6'"
  onmouseout="this.style.background='#2563eb'"
  >Back to Modules</button>
</div>
</div>
    `;
    
    // Award XP by setting module status to completed
    setModuleStatus(currentModuleId, "completed");
    
    document.getElementById("backToModulesFromQuiz").onclick = () => {
      showGridView();
    };
  }
}


function setupQuizListeners() {
    const quizOkBtn = document.getElementById("quizOkBtn");
    const quizAnswer = document.getElementById("quizAnswer");
    quizOkBtn.onclick = function() {
      quizIndex++;
      loadQuizQuestion(quizIndex);
    };
    quizAnswer.onkeydown = function(e) {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        quizOkBtn.click();
      }
    };
    loadQuizQuestion(quizIndex);
  }
  function showQuiz() {
    quizIndex = 0;
    quizView.classList.remove("hidden");
    quizView.classList.add("active");
    quizView.innerHTML = `
      <div class="quiz-container">
        <div class="quiz-question">
          <span class="question-number" id="quizNumber"></span>
          <span class="question-text" id="quizText"></span>
        </div>
        <textarea class="quiz-answer" id="quizAnswer" placeholder="Type your answer here..."></textarea>
        <div class="quiz-submit-row">
          <button class="submit-btn" id="quizOkBtn">OK</button>
          <span class="enter-hint">press <strong>Enter ↵</strong></span>
        </div>
      </div>
    `;
    setupQuizListeners();
  }

  // --- FIRESTORE HELPERS ---




  // --- USER PROFILE TO UID LOOKUP ---
  async function getMentorIdFromEmail(email) {
    // Assumes you have a users collection and emails are unique
    const snap = await db.collection("users").where("email", "==", email).get();
    if (!snap.empty) {
      return snap.docs[0].data().uid;
    }
    return null;
  }

  // --- MAIN APP LOGIC ONCE UID LOADED ---
async function startAppWithUserId(userId) {
  mentorId = userId; // Keep this for backward compatibility
  console.log("Starting app with Firebase Auth UID:", userId);

  // Firestore listener for THIS USER'S training progress using their Firebase Auth UID
  db.collection(`users/${userId}/trainingProgress`).onSnapshot((snap) => {
    const progress = {};
    snap.forEach(doc => progress[doc.id] = doc.data().status);
    lastProgress = progress;
    
    const activeTab = document.querySelector(".tab.active");
    if (activeTab && tabs.length >= 2 && activeTab === tabs[1]) {
      renderTrainingGrid(progress, true);
    } else {
      renderTrainingGrid(progress, false);
    }
  });

  // Initial view
  showGridView();
}
  // ---- 👇 FETCH CURRENT USER EMAIL & LOAD UID ----
async function initApp() {
  const userEmail = await getLoggedInUserEmail();
  if (!userEmail) {
    alert("No user email found. Please log in.");
    return;
  }
  
  const userId = await getCurrentUserId();
  if (!userId) {
    alert("No user profile found for this email.");
    return;
  }
  
  // Start app with the actual user ID instead of looking up mentorId
  startAppWithUserId(userId);
}


  // Stub: Replace with real implementation (Firebase Auth, etc.)
async function getLoggedInUserEmail() {
  return new Promise((resolve) => {
    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        console.log("Current user email:", user.email);
        resolve(user.email);
      } else {
        console.log("No authenticated user found");
        resolve(null);
      }
    });
  });
}
  // --- RUN IT! ---
  initApp();

  // ============ MEILISEARCH INTEGRATION ============
  const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
  const index = client.index('content');
  const searchBox = document.getElementById('navbarSearch');
  const searchDropdown = document.getElementById('searchDropdown');
  const searchIcon = document.getElementById('navbarSearchIcon');

  if (searchBox && searchDropdown) {
    searchBox.addEventListener('input', async function(e) {
      const query = e.target.value.trim();
      if (!query) {
        searchDropdown.style.display = 'none';
        searchDropdown.innerHTML = '';
        return;
      }
      try {
        const result = await index.search(query, { limit: 5 });
        if (!result.hits.length) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
          return;
        }
        searchDropdown.style.display = 'block';
        searchDropdown.innerHTML = result.hits.map(doc => `
          <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
            <b>${doc.title}</b><br>
            <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
          </div>
        `).join('');
      } catch (err) {
        searchDropdown.style.display = 'none';
        searchDropdown.innerHTML = '';
      }
    });

    searchDropdown.addEventListener('click', function(e) {
      const target = e.target.closest('.dropdown-result');
      if (target && target.dataset.url) {
        window.location = target.dataset.url;
      }
    });

    searchBox.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && searchDropdown.innerHTML) {
        const first = searchDropdown.querySelector('.dropdown-result');
        if (first && first.dataset.url) {
          window.location = first.dataset.url;
        }
      }
    });

    document.addEventListener('click', function(e) {
      if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
        searchDropdown.style.display = 'none';
      }
    });

    if (searchIcon) {
      searchIcon.addEventListener('click', () => {
        searchBox.dispatchEvent(new Event('input'));
      });
    }
  }
  // =========== END MEILISEARCH ============

  
});






</script>



<script>

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
    authDomain: "certquest-94959.firebaseapp.com",
    projectId: "certquest-94959",
    storageBucket: "certquest-94959.appspot.com",
    messagingSenderId: "323956529033",
    appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
    measurementId: "G-F5JHTGGN6K"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  document.addEventListener('DOMContentLoaded', () => {
  // Ensure elements exist before attaching events
  const searchIcon = document.getElementById('navbarSearchIcon');
  if (searchIcon) {
    searchIcon.addEventListener('click', toggleCommentPanel);
  }
  
  // Initialize notification system
  firebase.auth().onAuthStateChanged(user => {
    if (user) loadNotifications();
  });
});

  // Global variables
  let modal, backdrop, goalSubmitBtn, compsInput, goalCards, isMentorCheckbox, mentorCompDiv, mentorCompInput, selectedGoal;
  let cqSpeakingMediaRecorder = null;
  let cqSpeakingMediaStream = null;
  let cqSpeakingRecordedChunks = [];
  let isRecording = false;
  let quizTimer = null;  // Add this line
let quizTimeRemaining = 0;  // Add this line if you want timer functionality
let cameraStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let recordingTimer = null;
let recordingSeconds = 0;
let cameraEnabled = true;
let micEnabled = true;
let selectedUploadFile = null;

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const tModal = document.getElementById('trainingModal');
  const tBackdrop = document.querySelector('.modal-backdrop');
  const tCloseBtn = tModal?.querySelector('.close-modal');
  
  if (tBackdrop) tBackdrop.style.display = '';
  
  function closeTModal() {
    if (tBackdrop) {
      tBackdrop.classList.remove('active');
      tBackdrop.classList.add('hidden');
    }
    if (tModal) {
      tModal.classList.remove('hidden', 'active');
      tModal.classList.add('hidden');
    }
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
  }
  
  document.querySelectorAll('.training-card').forEach(card => {
    card.addEventListener('click', function() {
      if (tBackdrop) {
        tBackdrop.classList.remove('hidden');
        tBackdrop.classList.add('active');
        tBackdrop.style.display = '';
      }
      if (tModal) {
        tModal.classList.remove('hidden');
        tModal.classList.add('active');
      }
      document.body.classList.add('modal-open');
      document.body.style.overflow = 'hidden';
    });
  });
  
  if (tCloseBtn) tCloseBtn.addEventListener('click', closeTModal);
  if (tBackdrop) tBackdrop.addEventListener('click', (e) => {
    if (e.target === tBackdrop) closeTModal();
  });
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && tModal && !tModal.classList.contains('hidden')) {
      closeTModal();
    }
  });
});
function showMentorCommentModal(assignmentName, comment, notificationId) {
  console.log("Showing mentor comment modal:", assignmentName, comment); // Debug log
  
  document.getElementById('mentorCommentAssignment').textContent = `Feedback for "${assignmentName}"`;
  document.getElementById('mentorCommentText').textContent = comment;
 document.getElementById('mentorCommentModal').style.display = 'flex';

  // When closed, mark notification as read
  window.closeMentorCommentModal = function() {
    document.getElementById('mentorCommentModal').style.display = 'none';
    if (notificationId) {
      db.collection('notifications').doc(notificationId).update({
        read: true
      }).catch(err => console.error("Error marking notification as read:", err));
    }
  };

  
}


function openNotificationsOnHome() {
    // Set a flag in sessionStorage (gets cleared when browser is closed)
    sessionStorage.setItem('openNotifications', 'true');
    // Navigate to home page - CHANGE THIS PATH to match your structure
    window.location.href = 'public/home.html';
}


let writtenQuestions = [];
let currentQuestionIndex = 0;
let writtenAnswers = {};
let writtenTimer = null;
let writtenTimeRemaining = 0;

const sampleWrittenQuestions = [
  {
    competency: "ACCOUNTING",
    question: "In accounting, what is the equation to calculate net income?",
    options: [
      "Assets = Liabilities + Equity",
      "Revenues - Expenses", 
      "Current Assets - Current Liabilities",
      "Gross Profit - Operating Expenses"
    ],
    correctAnswer: "Revenues - Expenses"
  },
  {
    competency: "FINANCE",
    question: "What is the primary purpose of a cash flow statement?",
    options: [
      "To show profitability over time",
      "To track cash receipts and payments",
      "To list all company assets",
      "To calculate tax obligations"
    ],
    correctAnswer: "To track cash receipts and payments"
  },
  {
    competency: "BUSINESS LAW",
    question: "Which type of business structure provides limited liability protection?",
    options: [
      "Sole Proprietorship",
      "Partnership",
      "Corporation",
      "None of the above"
    ],
    correctAnswer: "Corporation"
  },
  {
    competency: "MARKETING",
    question: "What are the 4 P's of marketing?",
    options: [
      "Product, Price, Place, Promotion",
      "People, Process, Physical, Promotion",
      "Product, Profit, Place, People",
      "Price, Profit, Promotion, People"
    ],
    correctAnswer: "Product, Price, Place, Promotion"
  },
  {
    competency: "ECONOMICS",
    question: "What happens to demand when the price of a good increases, all else being equal?",
    options: [
      "Demand increases",
      "Demand decreases",
      "Demand stays the same",
      "Demand becomes unpredictable"
    ],
    correctAnswer: "Demand decreases"
  },
  {
    competency: "MANAGEMENT",
    question: "Which leadership style involves making decisions without consulting team members?",
    options: [
      "Democratic",
      "Laissez-faire",
      "Autocratic",
      "Transformational"
    ],
    correctAnswer: "Autocratic"
  },
  {
    competency: "ENTREPRENEURSHIP",
    question: "What is a business plan primarily used for?",
    options: [
      "To impress investors only",
      "To outline business goals and strategies",
      "To calculate exact profits",
      "To hire employees"
    ],
    correctAnswer: "To outline business goals and strategies"
  },
  {
    competency: "BUSINESS ETHICS",
    question: "What is the main purpose of corporate social responsibility (CSR)?",
    options: [
      "To increase profits only",
      "To comply with legal requirements",
      "To contribute positively to society and environment",
      "To reduce employee wages"
    ],
    correctAnswer: "To contribute positively to society and environment"
  },
  {
    competency: "OPERATIONS",
    question: "What does 'Just-in-Time' inventory management aim to achieve?",
    options: [
      "Maximum inventory storage",
      "Minimum inventory while meeting demand",
      "Random inventory ordering",
      "Buying inventory in bulk always"
    ],
    correctAnswer: "Minimum inventory while meeting demand"
  },
  {
    competency: "HUMAN RESOURCES",
    question: "What is the primary purpose of performance appraisals?",
    options: [
      "To fire employees",
      "To evaluate and improve employee performance",
      "To reduce salaries",
      "To increase working hours"
    ],
    correctAnswer: "To evaluate and improve employee performance"
  }
];



  // Quiz answers
  let quizAnswers = {
    q1: "To make meetings more efficient",
    q2: "Adjourn", 
    q3: "Majority vote",
    q4: "Amend",
    q5: "\"I move to...\""
  };
  let userScore = 0;

  // Quiz Questions Array
// Replace your existing quizQuestions array with this
const quizQuestions = [
  {
    text: "What is the primary purpose of parliamentary procedure?",
    competency: "Meeting Management",
    correctAnswer: "To make meetings more efficient",
    options: [
      "To make meetings more efficient",
      "To give the president more power",
      "To eliminate debate",
      "To make meetings longer"
    ]
  },
  {
    text: "Which motion is used to end a meeting?",
    competency: "Meeting Management", 
    correctAnswer: "Adjourn",
    options: [
      "Adjourn",
      "Recess",
      "Postpone",
      "Table"
    ]
  },
  {
    text: "How many votes are typically needed to pass a motion?",
    competency: "Voting Procedures",
    correctAnswer: "Majority vote",
    options: [
      "Majority vote",
      "Unanimous vote",
      "Two-thirds vote",
      "Simple majority"
    ]
  },
  {
    text: "What motion is used to change a pending motion?",
    competency: "Amendment Process",
    correctAnswer: "Amend",
    options: [
      "Amend",
      "Substitute",
      "Withdraw",
      "Reconsider"
    ]
  },
  {
    text: "How should you properly introduce a motion?",
    competency: "Meeting Management",
    correctAnswer: "\"I move to...\"",
    options: [
      "\"I move to...\"",
      "\"I suggest that...\"",
      "\"I want to...\"",
      "\"I think we should...\""
    ]
  }
];

// Add this new function to analyze competency performance
function getQuizCompetencyBreakdown() {
  const competencyStats = {};

  document.querySelectorAll('.quiz-question').forEach((qDiv, idx) => {
    const competency = quizQuestions[idx].competency;
    const selectedOption = qDiv.querySelector('input[type="radio"]:checked');
    const isCorrect = selectedOption && 
                     selectedOption.value === quizQuestions[idx].correctAnswer;

    if (!competencyStats[competency]) {
      competencyStats[competency] = { total: 0, correct: 0 };
    }
    
    competencyStats[competency].total++;
    if (isCorrect) competencyStats[competency].correct++;
  });

  return competencyStats;
}

// Add this new function to show detailed results
function showCompetencyResults(score, totalQuestions, competencyStats) {
  const modal = document.getElementById('congratsModal');
  const content = modal.querySelector('.cq-modal-fields');
  
  let competencyHTML = Object.entries(competencyStats).map(([comp, stats]) => `
    <div class="competency-result">
      <span>${comp}:</span>
      <strong>${stats.correct}/${stats.total}</strong>
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${(stats.correct/stats.total)*100}%"></div>
      </div>
    </div>
  `).join('');

  content.innerHTML = `
    <h3 style="text-align:center">Quiz Results</h3>
    <div style="text-align:center; font-size:1.2rem; margin:1rem 0">
      Score: <strong>${score}/${totalQuestions}</strong>
    </div>
    <div style="margin-top:1.5rem">
      <h4>Competency Breakdown:</h4>
      ${competencyHTML}
    </div>
  `;

  modal.style.display = 'block';
}

function showNotification(title, description, onClick = null) {
    const list = document.getElementById("notificationList");
    const panel = document.getElementById("commentPanel");

    const item = document.createElement("div");
    item.className = "notification-item";
    item.innerHTML = `
        <div class="notification-header">
            <strong>${title}</strong>
            <span class="notification-time">Just now</span>
        </div>
        <div class="notification-body">${description}</div>
    `;

    if (onClick) {
        item.addEventListener("click", () => {
            onClick();
            // Don't remove the notification, just mark it as read
            item.classList.add("read");
        });
    }

    list.prepend(item);

    // Show a badge when new notifications arrive
    const notificationBadge = document.querySelector('.nav-icons li a[onclick="toggleCommentPanel()"] .notification-badge');
    if (notificationBadge) {
        notificationBadge.style.display = 'inline-block';
    }
}


function renderQuiz(questionsArr) {
  const quizContainer = document.getElementById('quizQuestions');
  quizContainer.innerHTML = questionsArr.map((q, idx) => `
    <div class="quiz-question" data-competency="${q.competency}">
      <h4>${idx + 1}. ${q.text}</h4>
      ${q.options.map(opt => `
        <label class="quiz-option">
          <input type="radio" name="q${idx+1}" value="${opt}"> ${opt}
        </label>
      `).join('')}
    </div>
  `).join('');
}

  function toggleAccordion(button) {
    const content = button.nextElementSibling;
    const icon = button.querySelector('.chevron-icon');
    const isActive = button.classList.contains('active');
    if (isActive) {
      button.classList.remove('active');
      content.style.maxHeight = null;
      if (icon) icon.classList.remove('rotate');
    } else {
      button.classList.add('active');
      content.style.maxHeight = content.scrollHeight + "px";
      if (icon) icon.classList.add('rotate');
    }
  }

  // Check browser compatibility for recording
  function checkRecordingSupport() {
    const issues = [];
    
    if (!navigator.mediaDevices) {
      issues.push("mediaDevices not supported");
    }
    
    if (!navigator.mediaDevices.getUserMedia) {
      issues.push("getUserMedia not supported");
    }
    
    if (!window.MediaRecorder) {
      issues.push("MediaRecorder not supported");
    }
    
    if (issues.length > 0) {
      console.error("Recording not supported:", issues.join(", "));
      alert("Your browser does not support audio/video recording: " + issues.join(", "));
      return false;
    }
    
    return true;
  }

  // Fixed audio recording function
  function startAudioRecording() {
    document.getElementById('cq-speaking-downloadBtn').style.display = 'none';
    console.log("Starting audio recording...");
    
    if (!checkRecordingSupport()) return;
    
    // Stop any existing recording first
    cqSpeakingStopAllMedia();
    cqSpeakingRecordedChunks = [];
    
    navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    })
    .then(stream => {
      console.log("Audio stream obtained successfully");
      cqSpeakingMediaStream = stream;
      
      // Check MediaRecorder support and set up with best available format
      let options = {};
      if (MediaRecorder.isTypeSupported('audio/webm')) {
        options.mimeType = 'audio/webm';
      } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
        options.mimeType = 'audio/mp4';
      } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
        options.mimeType = 'audio/ogg';
      }
      
      cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
      console.log("MediaRecorder created with mimeType:", cqSpeakingMediaRecorder.mimeType);
      
      cqSpeakingMediaRecorder.ondataavailable = (event) => {
        console.log("Audio data available:", event.data.size, "bytes");
        if (event.data.size > 0) {
          cqSpeakingRecordedChunks.push(event.data);
        }
      };
      
      cqSpeakingMediaRecorder.onstop = () => {
  console.log("Audio recording stopped, processing...");
  if (cqSpeakingRecordedChunks.length === 0) {
    console.error("No audio data recorded");
    alert("No audio data was recorded. Please try again.");
    return;
  }
  const mimeType = cqSpeakingMediaRecorder.mimeType || 'audio/webm';
  const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });
  console.log("Created audio blob:", blob.size, "bytes, type:", blob.type);

  const audioURL = URL.createObjectURL(blob);
  const audioElement = document.getElementById('cq-speaking-audioPlayback');
  if (audioElement) {
    audioElement.src = audioURL;
    audioElement.style.display = 'block';
    audioElement.controls = true;
    console.log("Audio playback element updated");
    audioElement.addEventListener('loadedmetadata', () => {
      console.log("Audio metadata loaded, duration:", audioElement.duration);
    });
    audioElement.addEventListener('error', (e) => {
      console.error("Audio playback error:", e);
    });
  } else {
    console.error("Audio playback element not found in DOM");
  }

  // Download & Upload section - THIS IS WHAT YOU WANT
  const downloadBtn = document.getElementById('cq-speaking-downloadBtn');
  if (downloadBtn && blob) {
    downloadBtn.style.display = 'inline-block';
    downloadBtn.onclick = function() {
      // Create a temporary link and trigger download
      const url = URL.createObjectURL(blob);
      const filename = `CertQuest_Response_${Date.now()}.mp4`;
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);

      // Show the upload box immediately after download click
      document.getElementById('cq-speaking-uploadBox').style.display = 'block';
    };
  }

  isRecording = false;
};

      cqSpeakingMediaRecorder.onerror = (event) => {
        console.error("MediaRecorder error:", event.error);
        alert("Recording error: " + event.error.message);
        isRecording = false;
      };
      
      // Start recording
      cqSpeakingMediaRecorder.start(1000); // Collect data every second
      isRecording = true;
      console.log("Audio recording started");
      
      // Show stop button
      const stopBtn = document.getElementById('cq-speaking-stopBtn');
      if (stopBtn) {
        stopBtn.style.display = 'inline-block';
        stopBtn.textContent = '⏹ Stop Audio Recording';
      }
      
      // Hide video preview if showing
      const videoPreview = document.getElementById('cq-speaking-videoPreview');
      if (videoPreview) {
        videoPreview.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Audio recording error:', error);
      let errorMessage = 'Failed to access microphone: ';
      if (error.name === 'NotAllowedError') {
        errorMessage += 'Permission denied. Please allow microphone access and try again.';
      } else if (error.name === 'NotFoundError') {
        errorMessage += 'No microphone found.';
      } else if (error.name === 'NotReadableError') {
        errorMessage += 'Microphone is already in use.';
      } else {
        errorMessage += error.message;
      }
      alert(errorMessage);
      isRecording = false;
    });
  }

  // Fixed video recording function
  function startVideoRecording() {
    document.getElementById('cq-speaking-downloadBtn').style.display = 'none';

    console.log("Starting video recording...");
    
    if (!checkRecordingSupport()) return;
    
    // Stop any existing recording first
    cqSpeakingStopAllMedia();
    cqSpeakingRecordedChunks = [];
    
    navigator.mediaDevices.getUserMedia({ 
      video: {
        width: { min: 640, ideal: 1280, max: 1920 },
        height: { min: 480, ideal: 720, max: 1080 },
        frameRate: { min: 15, ideal: 30, max: 60 }
      }, 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    })
    .then(stream => {
      console.log("Video stream obtained successfully");
      cqSpeakingMediaStream = stream;
      
      const videoElement = document.getElementById('cq-speaking-videoPreview');
      if (!videoElement) {
        console.error("Video preview element not found in DOM");
        alert("Video preview element not found");
        return;
      }
      
      // Set up video preview
      videoElement.srcObject = stream;
      videoElement.muted = true; // Prevent feedback
      videoElement.autoplay = true;
      videoElement.playsInline = true; // Important for mobile
      videoElement.style.display = 'block';
      
      // Wait for video to be ready before starting recording
      videoElement.addEventListener('loadedmetadata', () => {
        videoElement.play().catch(e => {
          console.error("Error playing video preview:", e);
        });
      });
      
      // Hide audio playback if showing
      const audioPlayback = document.getElementById('cq-speaking-audioPlayback');
      if (audioPlayback) {
        audioPlayback.style.display = 'none';
      }
      
      // Set up MediaRecorder with best available format
      let options = {};
      if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
        options.mimeType = 'video/webm;codecs=vp9';
      } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
        options.mimeType = 'video/webm;codecs=vp8';
      } else if (MediaRecorder.isTypeSupported('video/webm')) {
        options.mimeType = 'video/webm';
      } else if (MediaRecorder.isTypeSupported('video/mp4')) {
        options.mimeType = 'video/mp4';
      }
      
      cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
      console.log("MediaRecorder created with mimeType:", cqSpeakingMediaRecorder.mimeType);
      
      cqSpeakingMediaRecorder.ondataavailable = (event) => {
        console.log("Video data available:", event.data.size, "bytes");
        if (event.data.size > 0) {
          cqSpeakingRecordedChunks.push(event.data);
        }
      };
      
      cqSpeakingMediaRecorder.onstop = () => {
  console.log("Video recording stopped, processing...");
  if (cqSpeakingRecordedChunks.length === 0) {
    console.error("No video data recorded");
    alert("No video data was recorded. Please try again.");
    return;
  }
  const mimeType = cqSpeakingMediaRecorder.mimeType || 'video/webm';
  const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });
  console.log("Created video blob:", blob.size, "bytes, type:", blob.type);

  const videoURL = URL.createObjectURL(blob);
  const videoElement = document.getElementById('cq-speaking-videoPreview');
  // Switch from live preview to recorded video
  if (videoElement) {
    videoElement.srcObject = null;
    videoElement.src = videoURL;
    videoElement.controls = true;
    videoElement.muted = false;
    videoElement.autoplay = false;
    videoElement.style.display = 'block';
    videoElement.addEventListener('loadedmetadata', () => {
      console.log("Recorded video metadata loaded, duration:", videoElement.duration);
    });
    videoElement.addEventListener('error', (e) => {
      console.error("Video playback error:", e);
    });
    videoElement.load();
  } else {
    console.error("Video preview element not found in DOM");
  }

  // Download & Upload section - THIS IS WHAT YOU WANT
  const downloadBtn = document.getElementById('cq-speaking-downloadBtn');
  if (downloadBtn && blob) {
    downloadBtn.style.display = 'inline-block';
    downloadBtn.onclick = function() {
      // Create a temporary link and trigger download
      const url = URL.createObjectURL(blob);
      const filename = `CertQuest_Response_${Date.now()}.webm`;
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);

      // Show the upload box immediately after download click
      document.getElementById('cq-speaking-uploadBox').style.display = 'block';
    };
  }

  isRecording = false;
};

      cqSpeakingMediaRecorder.onerror = (event) => {
        console.error("MediaRecorder error:", event.error);
        alert("Recording error: " + event.error.message);
        isRecording = false;
      };
      
      // Start recording
      cqSpeakingMediaRecorder.start(1000); // Collect data every second
      isRecording = true;
      console.log("Video recording started");
      
      // Show stop button
      const stopBtn = document.getElementById('cq-speaking-stopBtn');
      if (stopBtn) {
        stopBtn.style.display = 'inline-block';
        stopBtn.textContent = '⏹ Stop Video Recording';
      }
    })
    .catch(error => {
      console.error('Video recording error:', error);
      let errorMessage = 'Failed to access camera/microphone: ';
      if (error.name === 'NotAllowedError') {
        errorMessage += 'Permission denied. Please allow camera and microphone access and try again.';
      } else if (error.name === 'NotFoundError') {
        errorMessage += 'No camera or microphone found.';
      } else if (error.name === 'NotReadableError') {
        errorMessage += 'Camera or microphone is already in use.';
      } else {
        errorMessage += error.message;
      }
      alert(errorMessage);
      isRecording = false;
    });
  }

  
  function cqSpeakingStopAllMedia() {
    console.log("Stopping all media...");
    
    // Stop MediaRecorder
    if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state !== "inactive") {
      try {
        cqSpeakingMediaRecorder.stop();
      } catch (e) {
        console.error("Error stopping MediaRecorder:", e);
      }
    }
    
    // Stop all media tracks
    if (cqSpeakingMediaStream) {
      cqSpeakingMediaStream.getTracks().forEach(track => {
        track.stop();
        console.log("Stopped track:", track.kind, track.label);
      });
      cqSpeakingMediaStream = null;
    }
    
    // Clear recorded data
    cqSpeakingRecordedChunks = [];
    
    // Hide stop button
    const stopBtn = document.getElementById('cq-speaking-stopBtn');
    if (stopBtn) {
      stopBtn.style.display = 'none';
    }
    
    // Reset video element
    const videoElement = document.getElementById('cq-speaking-videoPreview');
    if (videoElement) {
      videoElement.srcObject = null;
      videoElement.src = '';
      videoElement.controls = false;
    }
    
    isRecording = false;
    console.log("All media stopped and cleaned up");
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Check recording support on page load
    checkRecordingSupport();

    // Assign global variables
    modal = document.getElementById('goalModal');
    backdrop = document.querySelector('.modal-backdrop');
    goalSubmitBtn = document.getElementById('goalSubmitBtn');
    compsInput = document.getElementById('comps');
    goalCards = document.querySelectorAll('.goal-card');
    isMentorCheckbox = document.getElementById('isMentor');
    mentorCompDiv = document.getElementById('mentorCompDiv');
    mentorCompInput = document.getElementById('mentorComp');
    selectedGoal = null;

    // Set up recording button event listeners
    const audioBtn = document.getElementById('cq-speaking-audioBtn');
    const videoBtn = document.getElementById('cq-speaking-videoBtn');
    const stopBtn = document.getElementById('cq-speaking-stopBtn');
    const submitBtn = document.getElementById('cq-speaking-submitBtn');
    const closeBtn = document.querySelector('.cq-speaking-close');

    if (audioBtn) {
      audioBtn.addEventListener('click', startAudioRecording);
    }
    
    if (videoBtn) {
      videoBtn.addEventListener('click', startVideoRecording);
    }
    
    if (stopBtn) {
      stopBtn.addEventListener('click', stopRecording);
    }
    
    if (submitBtn) {
      submitBtn.addEventListener('click', submitSpeakingResponse);
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', closeSpeakingAssignmentModal);
    }

    

    // === DRAG AND DROP UPLOAD FUNCTIONALITY ===
    let selectedUploadFile = null;

    function setupDragAndDrop() {
      const dropZone = document.getElementById('cq-speaking-dropZone');
      const uploadInput = document.getElementById('cq-speaking-uploadInput');
      const submitBtn = document.getElementById('cq-speaking-uploadSubmitBtn');
      const dropZoneText = document.getElementById('cq-speaking-dropZone-text');

      if (!dropZone || !uploadInput || !submitBtn || !dropZoneText) {
        return; // Elements don't exist yet
      }

      // Click on dropZone opens file dialog
      dropZone.addEventListener('click', (e) => {
        e.preventDefault();
        uploadInput.click();
      });

      // Drag over styling
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.background = '#e0ebff';
        dropZone.style.borderColor = '#1e40af';
        dropZone.style.transform = 'scale(1.02)';
      });

      // Drag enter
      dropZone.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });

      // Drag leave styling
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        // Only reset if we're leaving the dropZone itself
        if (!dropZone.contains(e.relatedTarget)) {
          dropZone.style.background = '#f3f6fd';
          dropZone.style.borderColor = '#2563eb';
          dropZone.style.transform = 'scale(1)';
        }
      });

      // Drop handler
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.background = '#f3f6fd';
        dropZone.style.borderColor = '#2563eb';
        dropZone.style.transform = 'scale(1)';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleUploadFile(files[0]);
        }
      });

      // File input change handler
      uploadInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          handleUploadFile(file);
        }
      });

      function handleUploadFile(file) {
        console.log('File selected:', file.name, file.type, file.size);
        
        // Check file type
        if (!file.type.startsWith('audio/') && !file.type.startsWith('video/')) {
          dropZoneText.innerHTML = '❌ Please upload an audio or video file';
          submitBtn.disabled = true;
          
          selectedUploadFile = null;
          setTimeout(() => resetDropZone(), 3000);
          return;
        }

        // Check file size (limit to 100MB)
        const maxSize = 100 * 1024 * 1024; // 100MB
        if (file.size > maxSize) {
          dropZoneText.innerHTML = '❌ File too large (max 100MB)';
          submitBtn.disabled = true;
          selectedUploadFile = null;
          setTimeout(() => resetDropZone(), 3000);
          return;
        }

        // File is valid
        selectedUploadFile = file;
        dropZoneText.innerHTML = `✅ Selected: ${file.name}`;
        submitBtn.disabled = false;
      }

      function resetDropZone() {
        selectedUploadFile = null;
        dropZoneText.textContent = 'Drop file here or click to select';
        submitBtn.disabled = true;
      }

      // Set up upload submit button
submitBtn.addEventListener('click', async () => {
  if (!selectedUploadFile) {
    alert('Please select a file first');
    return;
  }

  submitBtn.textContent = 'Uploading...';
  submitBtn.disabled = true;

  try {
    // Upload to GitHub
    const arrayBuffer = await selectedUploadFile.arrayBuffer();
    const typedArray = new Uint8Array(arrayBuffer);
    recordedChunks = [typedArray.buffer];

    await submitSpeakingResponse(); // this uploads to GitHub and updates Firestore

    // ✅ Mark assignment as completed in Firestore
    const user = firebase.auth().currentUser;
    const userId = user?.uid;
    const assignmentId = window.currentAssignment?.id;
    const filename = selectedUploadFile.name;
    const githubUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

    if (userId && assignmentId) {
      await db
        .collection('users')
        .doc(userId)
        .collection('assignments')
        .doc(assignmentId)
        .update({
          status: 'completed',
          submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
          fileUrl: githubUrl,
          fileType: 'video',
        });
    }

    alert('Uploaded and marked as complete!');
    document.getElementById('cq-speaking-modal').style.display = 'none';
    markAllNotificationsRead();

  } catch (error) {
    console.error(error);
    alert('Upload failed: ' + (error?.message || error));
  }

  submitBtn.textContent = 'Send to Mentor';
  submitBtn.disabled = false;
});


  // --- Get mentee and assignment info ---
  const user = firebase.auth().currentUser;
  const menteeName = user?.displayName || user?.email || 'Anonymous';
  const assignmentTitle = window.currentAssignment?.title || "Assignment";
  
  // --- Get mentor email ---
    }

    // Call setup function
    setupDragAndDrop();

    function updateSaveState() {
      goalSubmitBtn.disabled = !(
        selectedGoal &&
        compsInput.value.trim() &&
        (!isMentorCheckbox.checked || mentorCompInput.value.trim())
      );
    }

    goalCards.forEach(card => {
      card.addEventListener('click', function() {
        goalCards.forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        selectedGoal = this.dataset.goal;
        updateSaveState();
      });
    });
 document.addEventListener('DOMContentLoaded', function() {
    const compsInput = document.getElementById('compsInput'); // Make sure this ID is correct
    if (compsInput) {
        compsInput.addEventListener('input', updateSaveState);
    }
});
    // Mentor logic
    if (isMentorCheckbox && mentorCompDiv && mentorCompInput) {
      isMentorCheckbox.addEventListener('change', function() {
        mentorCompDiv.style.display = isMentorCheckbox.checked ? 'block' : 'none';
        updateSaveState();
      });
      mentorCompInput.addEventListener('input', updateSaveState);
    }

    goalSubmitBtn.addEventListener('click', function() {
      if (
        selectedGoal &&
        compsInput.value.trim() &&
        (!isMentorCheckbox.checked || mentorCompInput.value.trim())
      ) {
        document.getElementById('userComps').textContent = compsInput.value.trim();
        const user = auth.currentUser;
        if (user) {
          // Parse competitions input as array, trim each, and remove blanks
          const competitionsArr = compsInput.value
            .split(',')
            .map(x => x.trim())
            .filter(Boolean);
          db.collection('users').doc(user.uid).set({
            competitions: competitionsArr,
            isMentor: isMentorCheckbox.checked,
            mentorCompetition: isMentorCheckbox.checked ? mentorCompInput.value.trim() : "",
            studyGoalSet: true
          }, { merge: true });
        }
        modal.style.display = 'none';
        backdrop.style.display = 'none';
      }
    });

    if (backdrop) {
      backdrop.addEventListener('click', function() {
        modal.style.display = 'none';
        backdrop.style.display = 'none';
      });
    }

    // ---- Show full name from Firestore and modal logic ----
    auth.onAuthStateChanged(function(user) {
      if (user) {
        db.collection('users').doc(user.uid).get()
          .then(function(doc) {
            let fullName = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
            if (doc.exists && doc.data().name) {
              fullName = doc.data().name;
            }
            document.getElementById('userName').textContent = fullName;

            if (doc.exists && doc.data().competitions) {
              document.getElementById('userComps').textContent = doc.data().competitions;
            }

            // DEBUG: See exactly what Firestore returns!
            console.log("User doc.exists:", doc.exists);
            console.log("User doc.data:", doc.data());
            // Only show modal if not set (boolean false, undefined, or null)
            if (!doc.exists || !doc.data().studyGoalSet) {
              modal.style.display = 'block';
              backdrop.style.display = 'block';
            } else {
              modal.style.display = 'none';
              backdrop.style.display = 'none';
            }
          })
          .catch(function(error) {
            let fallbackName = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
            document.getElementById('userName').textContent = fallbackName;
          });
          setupNotifications();
          // --- Mentor Comment Modal Check ---
(async function checkMentorComments() {
  try {
    const snapshot = await db.collection('notifications')
      .where('menteeId', '==', user.uid)
      .where('read', '==', false)
      .where('type', '==', 'mentorComment')  // Add this filter
      .get();

    snapshot.forEach(doc => {
      const notif = doc.data();
      console.log("Found mentor feedback notification:", notif); // Debug log
      showMentorCommentModal(
        notif.assignmentName || "Assignment",
        notif.comment || notif.message || "No feedback provided.", // Try both fields
        doc.id
      );
    });
  } catch (err) {
    console.error("Failed to check mentor comments:", err);
  }
})();

      } else {
        window.location.href = "/Public/index.html";
      }
    });

    // ============ MEILISEARCH INTEGRATION ============
    const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
    const index = client.index('content');
    const searchBox = document.getElementById('navbarSearch');
    const searchDropdown = document.getElementById('searchDropdown');
    const searchIcon = document.getElementById('navbarSearchIcon');

    if (searchBox && searchDropdown) {
      searchBox.addEventListener('input', async function(e) {
        const query = e.target.value.trim();
        if (!query) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
          return;
        }
        try {
          const result = await index.search(query, { limit: 5 });
          if (!result.hits.length) {
            searchDropdown.style.display = 'none';
            searchDropdown.innerHTML = '';
            return;
          }
          searchDropdown.style.display = 'block';
          searchDropdown.innerHTML = result.hits.map(doc => `
            <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
              <b>${doc.title}</b><br>
              <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
            </div>
          `).join('');
        } catch (err) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
        }
      });

      // Handle result click
      searchDropdown.addEventListener('click', function(e) {
        const target = e.target.closest('.dropdown-result');
        if (target && target.dataset.url) {
          window.location = target.dataset.url;
        }
      });

      // Optional: Allow Enter key to open first result
      searchBox.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && searchDropdown.innerHTML) {
          const first = searchDropdown.querySelector('.dropdown-result');
          if (first && first.dataset.url) {
            window.location = first.dataset.url;
          }
        }
      });

      // Hide dropdown on outside click
      document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.style.display = 'none';
        }
      });

      // Click magnifier icon triggers search
      if (searchIcon) {
        searchIcon.addEventListener('click', () => {
          searchBox.dispatchEvent(new Event('input'));
        });
      }
    }

    // === REALTIME ASSIGNMENT LISTENER ===
    auth.onAuthStateChanged(function(user) {
      if (!user) return;
      
      
      console.log("Setting up assignment listener for user:", user.uid);
      
      db.collection('assignments')
        .where('to', '==', user.uid)
        .where('status', '==', 'assigned')
        .onSnapshot(snapshot => {
          console.log("Assignment snapshot received:", snapshot.size, "documents");
          
          snapshot.forEach(doc => {
            const data = doc.data();
            console.log("Assignment data:", data);
            
            if (data.status === "assigned") {
              showAssignmentModal(data, doc.id);
            }
          });
        }, error => {
          console.error("Assignment listener error:", error);
        });
    });
        document.head.insertAdjacentHTML('beforeend', uploadModalCSS);

  });

  // === ASSIGNMENT MODAL FUNCTIONS ===
function showAssignmentModal(assignment, docId) {
    console.log("showAssignmentModal called with:", assignment, docId);
    
    // Set the global assignment ID for later use
    window.latestAssignmentId = docId;
    window.currentAssignment = assignment;
    
    // Store notification in Firebase
    const user = firebase.auth().currentUser;
    if (user) {
        const notificationData = {
            menteeId: user.uid,
            type: 'assignment',
            assignmentId: docId,
            assignmentName: assignment.title || "New Assignment",
            message: `New Assignment: ${assignment.title || "Assignment"}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            read: false,
            showModal: false, // Don't auto-show modal for assignments
            assignmentType: assignment.type || 'quiz',
            competencies: assignment.competencies || [],
            difficulty: assignment.difficulty || 'Medium',
            time: assignment.time || '10 mins'
        };
        
        // Add assignment-specific details
        if (assignment.type === "speaking" || assignment.type === "case") {
            notificationData.questions = assignment.questions || [];
            notificationData.description = assignment.description || '';
        } else if (assignment.type === "written") {
            notificationData.questionCount = assignment.writtenQuestions ? assignment.writtenQuestions.length : 10;
        } else {
            notificationData.questions = assignment.questions || 'n/a';
            notificationData.simulate = assignment.simulate || false;
        }
        
        // Store in Firebase
        db.collection('notifications').add(notificationData)
            .then(() => {
                console.log("Assignment notification stored in Firebase");
            })
            .catch(error => {
                console.error("Error storing assignment notification:", error);
            });
    }
    
    // Create in-app notification content
    const notificationTitle = "New Assignment: " + (assignment.title || "Assignment");
    let notificationContent = "";
    
    if (assignment.type === "speaking" || assignment.type === "case") {
        notificationContent = `Type: ${assignment.type === "speaking" ? "Speaking" : "Case"} Assignment\n`;
        notificationContent += `Competencies: ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}\n`;
        notificationContent += `Questions:\n${assignment.questions ? assignment.questions.join('\n') : 'n/a'}`;
    } else {
        notificationContent = `
            Time: ${assignment.time || 'n/a'}
            Competencies: ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}
            Questions: ${assignment.questions || 'n/a'}
            Difficulty: ${assignment.difficulty || 'n/a'}
        `;
    }
    
    // Show notification with full details
    showNotification(notificationTitle, notificationContent, () => {
        // When clicked, open the full modal with all details
        openFullAssignmentModal(assignment);
    });
    
    // Mark assignment as seen (but not completed)
    db.collection('assignments').doc(docId).update({
        status: "seen"
    }).catch(error => {
        console.error("Error updating assignment status:", error);
    });
}
function openFullAssignmentModal(assignment) {
    // Set the modal title
    document.getElementById('cq-assignment-title').innerText = assignment.title || "New Assignment";
    
    // Show info section, hide quiz section
    document.getElementById('cq-assignment-info').style.display = 'block';
    document.getElementById('cq-assignment-quiz').style.display = 'none';
    
    // Fill in all assignment details
    const fieldsElement = document.getElementById('cq-assignment-fields');
    if (fieldsElement) {
        if (assignment.type === "speaking" || assignment.type === "case") {
            // Speaking/Case assignment format
            const q1 = assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided";
            const q2 = assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided";
            
            fieldsElement.innerHTML = `
                <div><b>Type:</b> ${assignment.type === "speaking" ? "Speaking" : "Case"} Assignment</div>
                <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
                <div><b>Description:</b> ${assignment.description || 'n/a'}</div>
                <div><b>Questions:</b></div>
                <ul>
                    <li>${q1}</li>
                    <li>${q2}</li>
                </ul>
            `;
        } else {
            // Regular assignment format
            fieldsElement.innerHTML = `
                <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
                <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
                <div><b>Questions:</b><br> <span style="font-weight:400; color:#333">${assignment.questions || 'n/a'}</span></div>
                <div><b>Difficulty:</b> ${assignment.difficulty || 'n/a'}</div>
                <div><b>Simulate:</b> ${assignment.simulate ? "Yes" : "No"}</div>
            `;
        }
    }
    
    // Show the modal
    document.getElementById('cq-assignment-modal').style.display = 'block';
}

  function showSpeakingAssignmentInfo(assignment, docId) {
    // Store for later use
    window.latestAssignmentId = docId;
    window.currentAssignment = assignment;
    
    // Set title
    document.getElementById('cq-assignment-title').innerText = assignment.title || "Speaking Assignment";
    
    // Hide quiz, show info
    document.getElementById('cq-assignment-info').style.display = 'block';
    document.getElementById('cq-assignment-quiz').style.display = 'none';
    
    // Fill in assignment fields for speaking
    document.getElementById('cq-assignment-fields').innerHTML = `
      <div><b>Type:</b> Speaking Assignment</div>
      <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
      <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
      <div><b>Description:</b><br> <span style="font-weight:400; color:#333">${assignment.description || assignment.questions || 'Practice your speaking skills'}</span></div>
      <div><b>Question 1:</b> ${assignment.question1 || 'No question provided'}</div>
      <div><b>Question 2:</b> ${assignment.question2 || 'No question provided'}</div>
    `;
    
    // Show the assignment modal (same as regular assignments)
    document.getElementById('cq-assignment-modal').style.display = 'block';
  }

function acceptAssignmentNow() {
    console.log("🚀 acceptAssignmentNow() called");
    
    const assignment = window.currentAssignment;
    console.log("📋 Current assignment:", assignment);
    
    if (!assignment) {
        console.error("❌ No current assignment found");
        return;
    }
    
    // ✅ IMMEDIATELY mark assignment as complete when user clicks "I'll do it now"
    if (window.latestAssignmentId) {
        console.log("✅ Marking assignment as complete immediately");
        
        // Build update data conditionally to avoid undefined values
        const updateData = {
            status: "seen",
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            acceptedAt: firebase.firestore.FieldValue.serverTimestamp(),
            autoCompleted: true
        };
        
        // Only add score fields for written assignments
        if (assignment.type === 'written') {
            updateData.score = 0;
            updateData.maxScore = assignment.writtenQuestions?.length || 10;
        }
        
        db.collection('assignments').doc(window.latestAssignmentId).update(updateData)
        .then(() => {
            console.log("✅ Assignment marked as complete successfully");
        }).catch(error => {
            console.error("❌ Error marking assignment as complete:", error);
        });
    }

    // Handle different assignment types but they're already marked complete above
    if (assignment.type === 'speaking' || assignment.type === 'case') {
        console.log("🎤 Opening camera modal for speaking/case assignment");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        
        // Store assignment questions globally for the camera modal
        window.currentAssignmentQuestions = {
            q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
            q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
            title: assignment.title || "Speaking Assignment",
            description: assignment.description || ""
        };
        
        openCameraModal();
        return;
    }

    if (assignment.type === 'written') {
        console.log("✍️ Opening written assignment (already marked complete)");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        openWrittenPracticeModal(assignment);
        return;
    }

    // Handle regular quiz assignments (already marked complete)
    console.log("📝 Setting up regular quiz assignment (already marked complete)");
    
    document.getElementById('cq-assignment-info').style.display = 'none';
    document.getElementById('cq-assignment-quiz').style.display = 'block';

    document.getElementById('quizDifficulty').textContent = 'Difficulty: ' + (assignment.difficulty || 'Medium');
    document.getElementById('quizTime').textContent = 'Time: ' + (assignment.time || '10 mins');

    console.log("🎯 Rendering quiz with questions:", quizQuestions);
    renderQuiz(quizQuestions);

    const radioInputs = document.querySelectorAll('#cq-assignment-quiz input[type="radio"]');
    const submitBtn = document.getElementById('submitQuizBtn');
    
    if (!submitBtn) {
        console.error("❌ Submit button not found!");
        return;
    }
    
    // Enable submit button immediately since assignment is already complete
    submitBtn.disabled = false;
    submitBtn.textContent = "Finish Practice"; // Change text since it's already "complete"
    
    console.log("🔓 Submit button enabled immediately");

    // Add event listeners for interactive feedback (optional)
    radioInputs.forEach((input, index) => {
        input.addEventListener('change', () => {
            console.log(`📡 Radio input ${index} changed to:`, input.value);
        });
    });

    // Set up the submit button click handler (for practice/feedback only)
    submitBtn.onclick = function() {
        console.log("🔥 FINISH PRACTICE CLICKED (assignment already complete)");
        
        // Show completion modal immediately
        closeAssignmentModal();
        
        showCongratsModal({
            message: `Assignment completed! Thanks for practicing.`,
            assignmentName: document.getElementById('cq-assignment-title').textContent
        });
        
        // Show confetti
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 }
        });
        
        // Clear assignment data
        window.latestAssignmentId = null;
        window.currentAssignment = null;
    };
    
    console.log("✅ acceptAssignmentNow() completed - assignment marked complete immediately");
}

const downloadModalHTML = `
<div id="downloadModal" class="download-modal-overlay" style="display: none;">
    <div class="download-modal-container">
        <div class="download-modal-header">
            <h2>Recording Complete!</h2>
            <button onclick="closeDownloadModal()">&times;</button>
        </div>
        <div class="download-modal-body">
            <div style="font-size: 4rem; margin: 20px 0;">🎬</div>
            <p>Your recording is ready!</p>
            <div id="recordingPreview" style="margin: 20px 0;"></div>
        </div>
        <div class="download-modal-footer">
            <button id="downloadRecordingBtn" onclick="downloadRecording()">📥 Download MP4</button>
            <button onclick="closeDownloadModal()">Continue</button>
        </div>
    </div>
</div>`;

function addCameraModalHTML() {
    const cameraModalHTML = `
    <!-- Camera Recording Modal -->
    <div id="cameraModal" class="camera-modal-overlay">
        <div class="camera-container">
            <!-- Header -->
            <div class="camera-header">
                <h2 class="camera-title" id="cameraModalTitle">Record Your Response</h2>
                <button class="camera-close" onclick="closeCameraModal()">&times;</button>
            </div>
            
            <!-- Assignment Questions Display -->
            <div class="assignment-questions">
                <div class="question-card">
                    <strong>Question 1:</strong>
                    <p id="cameraQ1">What is your strategy for this scenario?</p>
                </div>
                <div class="question-card">
                    <strong>Question 2:</strong>
                    <p id="cameraQ2">How would you handle unexpected challenges?</p>
                </div>
            </div>
            
            <!-- Main Video Area -->
            <div class="camera-main">
                <div class="video-preview">
                    <video id="cameraPreview" autoplay muted playsinline></video>
                    <div id="recordingIndicator" class="recording-indicator">● RECORDING</div>
                    <div id="recordingTimer" class="recording-timer">00:00</div>
                    <div id="noCameraView" class="no-camera" style="display: none;">
                        <div class="no-camera-icon">🎤</div>
                        <div>Audio Only Mode</div>
                        <div class="audio-wave">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="camera-controls">
                <button id="cameraToggle" class="camera-toggle" onclick="toggleCamera()" title="Toggle Camera">📹</button>
                <button id="recordButton" class="record-btn" onclick="toggleRecording()">●</button>
                <button id="micToggle" class="camera-toggle" onclick="toggleMic()" title="Toggle Microphone">🎤</button>
            </div>
            
            <!-- Actions -->
            <div class="camera-actions">
                <button id="submitRecording" class="action-btn" onclick="submitCameraRecording()" disabled>Submit Response</button>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', cameraModalHTML);
}

function openCameraModal() {
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('cameraModal')) {
        addCameraModalHTML();
        addCameraModalCSS();
    }
    
    // Set assignment questions
    if (window.currentAssignmentQuestions) {
        document.getElementById('cameraModalTitle').textContent = window.currentAssignmentQuestions.title;
        document.getElementById('cameraQ1').textContent = window.currentAssignmentQuestions.q1;
        document.getElementById('cameraQ2').textContent = window.currentAssignmentQuestions.q2;
    }
    
    // Show modal with animation
    const modal = document.getElementById('cameraModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
    
    // Initialize camera
    initializeCamera();
}

function closeCameraModal() {
    const modal = document.getElementById('cameraModal');
    modal.classList.remove('active');
    setTimeout(() => {
        modal.style.display = 'none';
        stopAllMedia();
    }, 300);
    
    // Clear assignment data
    window.latestAssignmentId = null;
    window.currentAssignment = null;
    window.currentAssignmentQuestions = null;
}

async function initializeCamera() {
    try {
        const constraints = {
            video: cameraEnabled,
            audio: micEnabled
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElement = document.getElementById('cameraPreview');
        
        if (cameraEnabled) {
            videoElement.srcObject = cameraStream;
            videoElement.style.display = 'block';
            document.getElementById('noCameraView').style.display = 'none';
        } else {
            videoElement.style.display = 'none';
            document.getElementById('noCameraView').style.display = 'flex';
        }
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Could not access camera/microphone. Please ensure permissions are granted.');
    }
}

function toggleCamera() {
    cameraEnabled = !cameraEnabled;
    const toggleBtn = document.getElementById('cameraToggle');
    
    if (cameraEnabled) {
        toggleBtn.textContent = '📹';
        toggleBtn.classList.remove('camera-off');
    } else {
        toggleBtn.textContent = '📹';
        toggleBtn.classList.add('camera-off');
    }
    
    // Restart stream with new constraints
    stopAllMedia();
    initializeCamera();
}

function toggleMic() {
    micEnabled = !micEnabled;
    const toggleBtn = document.getElementById('micToggle');
    
    if (micEnabled) {
        toggleBtn.textContent = '🎤';
        toggleBtn.classList.remove('camera-off');
    } else {
        toggleBtn.textContent = '🎤';
        toggleBtn.classList.add('camera-off');
    }
    
    // Restart stream with new constraints
    stopAllMedia();
    initializeCamera();
}

function toggleRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

function startRecording() {
    if (!cameraStream) {
        alert('Camera not initialized');
        return;
    }
    
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(cameraStream);
    
    mediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };
    
    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/mp4' });
        console.log('Recording finished, blob size:', blob.size);
        document.getElementById('submitRecording').disabled = false;
    };
    
    mediaRecorder.start();
    isRecording = true;
    
    // Update UI
    document.getElementById('recordButton').textContent = '⏹';
    document.getElementById('recordButton').classList.add('recording');
    document.getElementById('recordingIndicator').classList.add('active');
    document.getElementById('recordingTimer').classList.add('active');
    
    // Start timer
    recordingSeconds = 0;
    recordingTimer = setInterval(() => {
        recordingSeconds++;
        const minutes = Math.floor(recordingSeconds / 60);
        const seconds = recordingSeconds % 60;
        document.getElementById('recordingTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopRecording() {
    if (!mediaRecorder || !isRecording) return;
    
    mediaRecorder.stop();
    isRecording = false;
    
    // Update UI
    document.getElementById('recordButton').textContent = '●';
    document.getElementById('recordButton').classList.remove('recording');
    document.getElementById('recordingIndicator').classList.remove('active');
    document.getElementById('recordingTimer').classList.remove('active');
    
    // Stop timer
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
    }
    
    // Show download modal after a brief delay
    setTimeout(() => {
        showDownloadModal();
    }, 500);
}
function showDownloadModal() {
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('downloadModal')) {
        document.body.insertAdjacentHTML('beforeend', downloadModalHTML);
        addDownloadModalCSS();
    }
    
    // Create blob and preview
    if (recordedChunks.length > 0) {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        
        // Store for download
        window.recordingBlob = blob;
        window.recordingURL = url;
        
        // Show preview
        const preview = document.getElementById('recordingPreview');
        if (cameraEnabled) {
            preview.innerHTML = `<video src="${url}" controls style="width:100%; max-height:200px; border-radius:10px;"></video>`;
        } else {
            preview.innerHTML = `<audio src="${url}" controls style="width:100%;"></audio>`;
        }
    }
    
    // Show modal
    const modal = document.getElementById('downloadModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
}

function downloadRecording() {
    if (!window.recordingBlob) {
        alert('No recording available');
        return;
    }
    
    // Create download link
    const url = URL.createObjectURL(window.recordingBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CertQuest_Recording_${Date.now()}.${cameraEnabled ? 'webm' : 'webm'}`;
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 100);
    
    // MODIFIED: Close download modal and show upload modal
    closeDownloadModal();
    showUploadModal();
}

// 5. ADD THESE NEW FUNCTIONS
function showUploadModal() {
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('uploadModal')) {
        document.body.insertAdjacentHTML('beforeend', uploadModalHTML);
        setupUploadModal(); // Make sure this is called
    }
    
    // Show modal with animation
    const modal = document.getElementById('uploadModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
}


function closeUploadModal() {
    const modal = document.getElementById('uploadModal');
    modal.classList.remove('active');
    setTimeout(() => {
        modal.style.display = 'none';
        resetUploadModal();
    }, 300);
}

function setupUploadModal() {
    const dropZone = document.getElementById('uploadDropZone');
    const fileInput = document.getElementById('uploadFileInput');
    const submitBtn = document.getElementById('uploadSubmitBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');

    if (!dropZone || !fileInput || !submitBtn) {
        console.error("Upload modal elements not found!");
        return;
    }

    // Click to browse
    dropZone.addEventListener('click', (e) => {
        e.preventDefault();
        fileInput.click();
    });

    // Drag and drop events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!dropZone.contains(e.relatedTarget)) {
            dropZone.classList.remove('dragover');
        }
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleFileSelection(file);
        }
    });

    function handleFileSelection(file) {
        console.log('File selected:', file.name, file.type, file.size);
        
        // Validate file type
        const validTypes = ['video/webm', 'video/mp4', 'video/quicktime', 'video/x-msvideo', 'audio/webm', 'audio/mp4', 'audio/mpeg'];
        const validExtensions = ['.webm', '.mp4', '.mov', '.avi', '.mp3', '.wav'];
        
        const isValidType = validTypes.some(type => file.type.includes(type)) || 
                           validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
        
        if (!isValidType) {
            alert('Please select a valid video or audio file (WebM, MP4, MOV, AVI, MP3, WAV)');
            resetUploadModal();
            return;
        }

        // Check file size (max 200MB)
        const maxSize = 200 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('File size too large. Maximum size is 200MB.');
            resetUploadModal();
            return;
        }

        // File is valid
        selectedUploadFile = file;
        
        // Update UI
        dropZone.classList.add('file-selected');
        dropZone.innerHTML = `
            <div class="upload-text">File Selected!</div>
            <div class="upload-subtext">Click to select a different file</div>
        `;
        
        // Show file info
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'flex';
        
        // Enable submit button
        submitBtn.disabled = false;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
}


function resetUploadModal() {
    selectedUploadFile = null;
    const dropZone = document.getElementById('uploadDropZone');
    const fileInfo = document.getElementById('fileInfo');
    const submitBtn = document.getElementById('uploadSubmitBtn');
    
    if (dropZone) {
        dropZone.classList.remove('file-selected', 'dragover');
        dropZone.innerHTML = `
            <div class="upload-icon">🎬</div>
            <div class="upload-text">Drop your recording here</div>
            <div class="upload-subtext">or click to browse files</div>
            <div class="upload-subtext">Supports WebM, MP4, MOV, AVI</div>
            <input type="file" id="uploadFileInput" class="upload-file-input" accept=".webm,.mp4,.mov,.avi,video/*,audio/*">
        `;
    }
    
    if (fileInfo) {
        fileInfo.style.display = 'none';
    }
    
    if (submitBtn) {
        submitBtn.disabled = true;
    }
}

async function submitUploadedFile() {
  if (!selectedUploadFile) {
    alert('No file selected');
    return;
  }

  const submitBtn = document.getElementById('uploadSubmitBtn');
  submitBtn.textContent = 'Sending...';
  submitBtn.disabled = true;

  try {
    // --- Setup variables ---
    const user = firebase.auth().currentUser;
    const uid = user?.uid;
    const menteeName = user?.displayName || user?.email || 'Anonymous';
    const assignmentTitle = window.currentAssignment?.title || "Assignment";
    const assignmentId = window.latestAssignmentId;

    // GitHub info
    const GITHUB_USERNAME = "Anjay209";
    const GITHUB_REPO = "video-storage";
    const GITHUB_TOKEN = "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";

    const filename = `${uid}-${Date.now()}-${selectedUploadFile.name}`;
    const githubApiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
    const githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

    // Convert file to base64
    const base64 = await blobToBase64(selectedUploadFile);

    // Upload to GitHub
    const uploadRes = await fetch(githubApiUrl, {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Upload ${filename}`,
        content: base64,
        branch: 'main'
      })
    });

    if (!uploadRes.ok) throw new Error("GitHub upload failed");

    // Mark assignment as completed in Firestore
    await firebase.firestore()
      .collection('assignments')
      .doc(assignmentId)
      .update({
        status: "complete",
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        recordingUrl: githubPagesUrl
      });

    // UI feedback
    alert('Successfully sent to mentor!');
    closeUploadModal();
    if (document.getElementById('cameraModal')) {
      closeCameraModal();
    }

    confetti({
      particleCount: 150,
      spread: 70,
      origin: { y: 0.6 }
    });

  } catch (error) {
    console.error('Upload error:', error);
    alert("Failed to send file: " + (error?.text || error?.message || error));
  }

  submitBtn.textContent = 'Send to Mentor';
  submitBtn.disabled = false;
}


function closeDownloadModal() {
    const modal = document.getElementById('downloadModal');
    modal.classList.remove('active');
    setTimeout(() => {
        modal.style.display = 'none';
        // Cleanup URLs
        if (window.recordingURL) {
            URL.revokeObjectURL(window.recordingURL);
            window.recordingURL = null;
        }
        window.recordingBlob = null;
    }, 300);
}

// 4. Add basic CSS (add to your existing CSS or in a <style> tag)
function addDownloadModalCSS() {
    const style = document.createElement('style');
    style.textContent = `
        .download-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
            align-items: center; justify-content: center; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .download-modal-overlay.active { opacity: 1; }
        .download-modal-container {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px; max-width: 500px; width: 90%;
            color: white; transform: scale(0.9); transition: transform 0.3s ease;
        }
        .download-modal-overlay.active .download-modal-container { transform: scale(1); }
        .download-modal-header {
            padding: 25px 30px 15px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .download-modal-header button {
            background: rgba(255,255,255,0.1); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; font-size: 24px;
            cursor: pointer;
        }
        .download-modal-body { padding: 30px; text-align: center; }
        .download-modal-footer {
            padding: 20px 30px 30px; display: flex; gap: 15px; justify-content: center;
        }
        .download-modal-footer button {
            padding: 12px 24px; border-radius: 25px; font-weight: 600;
            cursor: pointer; border: none;
        }
        #downloadRecordingBtn {
            background: linear-gradient(45deg, #4CAF50, #45a049); color: white;
        }
    `;
    document.head.appendChild(style);
}
// Fixed submitQuiz function
function submitQuiz() {
    console.log("🎯 submitQuiz() CALLED - STARTING SUBMISSION PROCESS");
    console.log("📊 Assignment ID:", window.latestAssignmentId);
    console.log("📋 Current assignment:", window.currentAssignment);
    
    // Clear timer if it exists (but don't error if it doesn't)
    if (typeof quizTimer !== 'undefined' && quizTimer) {
        console.log("⏱️ Clearing quiz timer");
        clearInterval(quizTimer);
        quizTimer = null;
    }
    
    // Verify all questions were answered BEFORE calculating results
    console.log("🔍 Checking if all questions are answered...");
    const unansweredQuestions = quizQuestions.filter((_, idx) => {
        const checked = document.querySelector(`input[name="q${idx+1}"]:checked`);
        console.log(`❓ Question ${idx+1}:`, checked ? `✅ ${checked.value}` : "❌ Not answered");
        return !checked;
    });
    
    if (unansweredQuestions.length > 0) {
        console.error(`❌ ${unansweredQuestions.length} questions not answered`);
        alert(`Please answer all questions. ${unansweredQuestions.length} questions remaining.`);
        return;
    }
    
    console.log("✅ All questions answered, calculating results...");
    
    // Calculate results
    const quizResults = calculateQuizResults();
    console.log("📊 Quiz Results calculated:", quizResults);
    
    // Verify we have a valid assignment ID
    if (!window.latestAssignmentId) {
        console.error("❌ No assignment ID found");
        alert("Error: No assignment ID found. Cannot save results.");
        return;
    }

    console.log("💾 Saving results to Firebase...");
    
    // Save to Firebase and show results
    saveQuizResultsToFirebase(quizResults)
        .then(() => {
            console.log("✅ Results saved successfully");
            
            // Close quiz modal and show results
            closeAssignmentModal();
            
            showCongratsModal({
                message: `Great job! You scored ${quizResults.correct}/${quizResults.total}`,
                assignmentName: document.getElementById('cq-assignment-title').textContent,
                score: quizResults.correct,
                totalQuestions: quizResults.total,
                competencyStats: quizResults.competencyStats,
                percentage: quizResults.percentage
            });
            
            // Show confetti celebration
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            // Clear assignment data
            window.latestAssignmentId = null;
            window.currentAssignment = null;
            
            console.log("🎉 Quiz submission completed successfully!");
        })
        .catch(error => {
            console.error('❌ Error saving quiz results:', error);
            alert('Error saving results: ' + error.message);
        });
}


// 3. Test function to manually trigger quiz submission
function testQuizSubmission() {
    console.log("🧪 TESTING QUIZ SUBMISSION");
    
    // Set up fake assignment data
    window.latestAssignmentId = "test-assignment-123";
    window.currentAssignment = {
        title: "Test Quiz",
        type: "quiz",
        difficulty: "Easy",
        time: "10 mins"
    };
    
    console.log("🎯 Fake assignment set up:", window.currentAssignment);
    console.log("📊 Assignment ID:", window.latestAssignmentId);
    console.log("🔘 Submit button element:", document.getElementById('submitQuizBtn'));
    
    // Try to submit
    submitQuiz();
}

// Make test function available globally
window.testQuizSubmission = testQuizSubmission;


function openWrittenPracticeModal(assignment) {
    console.log("Opening written practice modal with assignment:", assignment);
    
    // Use assignment questions or fallback to sample questions
    writtenQuestions = assignment.writtenQuestions || sampleWrittenQuestions;
    currentQuestionIndex = 0;
    writtenAnswers = {};
    
    // Set up timer (convert minutes to seconds)
    const timeInMinutes = parseInt(assignment.time) || 15;
    writtenTimeRemaining = timeInMinutes * 60;
    
    // Show modal
    document.getElementById('cq-written-modal').style.display = 'flex';
    
    // Load first question
    loadWrittenQuestion();
    
    // Start timer
    startWrittenTimer();
    
    console.log("Written practice modal opened with", writtenQuestions.length, "questions");
}

function loadWrittenQuestion() {
    const question = writtenQuestions[currentQuestionIndex];
    if (!question) {
        console.error("No question found at index", currentQuestionIndex);
        return;
    }
    
    console.log("Loading question", currentQuestionIndex + 1, ":", question.question);
    
    // Update header
    document.getElementById('cq-written-title').textContent = window.currentAssignment?.title || 'Written Practice';
    document.getElementById('cq-written-question-count').textContent = 
        `Question ${currentQuestionIndex + 1} of ${writtenQuestions.length}`;
    
    // Update question content
    document.getElementById('cq-written-competency').textContent = question.competency;
    document.getElementById('cq-written-question').textContent = question.question;
    
    // Create options
    const optionsContainer = document.getElementById('cq-written-options');
    optionsContainer.innerHTML = question.options.map((option, index) => `
        <label class="cq-written-option" data-option="${option}">
            <input type="radio" name="written-q${currentQuestionIndex}" value="${option}">
            <span class="cq-written-option-text">${option}</span>
        </label>
    `).join('');
    
    // Restore previous answer if exists
    const previousAnswer = writtenAnswers[currentQuestionIndex];
    if (previousAnswer) {
        const radio = optionsContainer.querySelector(`input[value="${previousAnswer}"]`);
        if (radio) {
            radio.checked = true;
            radio.closest('.cq-written-option').classList.add('selected');
        }
    }
    
    // Add click handlers for options
    optionsContainer.querySelectorAll('.cq-written-option').forEach(option => {
        option.addEventListener('click', function(e) {
            // Prevent double-triggering if radio button itself was clicked
            if (e.target.type === 'radio') return;
            
            // Remove previous selection
            optionsContainer.querySelectorAll('.cq-written-option').forEach(opt => 
                opt.classList.remove('selected'));
            
            // Add selection to clicked option
            this.classList.add('selected');
            
            // Check the radio button
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
            
            // Save answer
            writtenAnswers[currentQuestionIndex] = radio.value;
            console.log("Answer saved:", currentQuestionIndex, "->", radio.value);
        });
    });
    
    // Add change handlers for radio buttons (for keyboard navigation)
    optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                // Remove previous selection
                optionsContainer.querySelectorAll('.cq-written-option').forEach(opt => 
                    opt.classList.remove('selected'));
                
                // Add selection to parent option
                this.closest('.cq-written-option').classList.add('selected');
                
                // Save answer
                writtenAnswers[currentQuestionIndex] = this.value;
                console.log("Answer saved via radio:", currentQuestionIndex, "->", this.value);
            }
        });
    });
    
    // Update progress bar
    updateWrittenProgress();
    
    // Update navigation buttons
    updateWrittenNavButtons();
}

function updateWrittenProgress() {
    const progress = ((currentQuestionIndex + 1) / writtenQuestions.length) * 100;
    document.getElementById('cq-written-progress-fill').style.width = `${progress}%`;
}


function updateWrittenNavButtons() {
    const prevBtn = document.getElementById('cq-written-prev');
    const nextBtn = document.getElementById('cq-written-next');
    
    // Update previous button
    prevBtn.disabled = currentQuestionIndex === 0;
    
    // Update next/submit button
    if (currentQuestionIndex === writtenQuestions.length - 1) {
        nextBtn.textContent = 'Submit';
        nextBtn.onclick = submitWrittenPractice; // ✅ Fixed: no parentheses
        nextBtn.classList.remove('cq-written-btn-primary');
        nextBtn.classList.add('cq-written-btn-primary');
        nextBtn.style.background = '#dc2626'; // Red color for submit
    } else {
        nextBtn.textContent = 'Next';
        nextBtn.onclick = nextQuestion;
        nextBtn.classList.add('cq-written-btn-primary');
        nextBtn.style.background = '#3b82f6'; // Blue color for next
    }
}

function previousQuestion() {
    console.log("Previous question clicked, current index:", currentQuestionIndex);
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadWrittenQuestion();
    }
}

function nextQuestion() {
    console.log("Next question clicked, current index:", currentQuestionIndex);
    if (currentQuestionIndex < writtenQuestions.length - 1) {
        currentQuestionIndex++;
        loadWrittenQuestion();
    }
}

function startWrittenTimer() {
    clearInterval(writtenTimer);
    
    console.log("Starting timer with", writtenTimeRemaining, "seconds");
    
    // Update initial display
    updateTimerDisplay();
    
    writtenTimer = setInterval(() => {
        writtenTimeRemaining--;
        updateTimerDisplay();
        
        if (writtenTimeRemaining <= 0) {
            console.log("Time's up! Auto-submitting...");
            clearInterval(writtenTimer);
            submitWrittenPractice();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(writtenTimeRemaining / 60);
    const seconds = writtenTimeRemaining % 60;
    const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('cq-written-timer').textContent = display;
    
    // Change color when time is running low (last 2 minutes)
    const timerElement = document.getElementById('cq-written-timer');
    if (writtenTimeRemaining <= 120) { // 2 minutes
        timerElement.style.color = '#dc2626'; // Red
        timerElement.style.fontWeight = '600';
    } else {
        timerElement.style.color = '#64748b'; // Default gray
        timerElement.style.fontWeight = '500';
    }
}

async function submitWrittenPractice() {
    try {
        console.log("=== SUBMITTING WRITTEN PRACTICE ===");
        console.log("Assignment ID:", window.latestAssignmentId);
        console.log("Current Assignment:", window.currentAssignment);
        console.log("Questions:", writtenQuestions.length);
        console.log("Answers:", writtenAnswers);

        clearInterval(writtenTimer);
        
        // CRITICAL: Check if we have an assignment ID
        if (!window.latestAssignmentId) {
            console.error("❌ CRITICAL ERROR: No assignment ID found!");
            alert("Error: No assignment ID found. Cannot submit written practice.");
            closeWrittenModal();
            return;
        }
        
        // Calculate score and competency stats
        let score = 0;
        const competencyStats = {};
        const detailedAnswers = [];
        const totalQuestions = writtenQuestions.length;
        
        writtenQuestions.forEach((question, index) => {
            const userAnswer = writtenAnswers[index];
            const isCorrect = userAnswer === question.correctAnswer;
            
            if (isCorrect) score++;
            
            // Track competency performance
            if (!competencyStats[question.competency]) {
                competencyStats[question.competency] = { 
                    total: 0, 
                    correct: 0,
                    questions: []
                };
            }
            competencyStats[question.competency].total++;
            if (isCorrect) competencyStats[question.competency].correct++;
            
            // Store detailed answer info
            detailedAnswers.push({
                questionIndex: index,
                question: question.question,
                competency: question.competency,
                userAnswer: userAnswer || "No answer",
                correctAnswer: question.correctAnswer,
                isCorrect: isCorrect
            });
        });
        
        // Calculate time spent and percentage
        const originalTime = parseInt(window.currentAssignment?.time) * 60 || 900;
        const timeSpent = originalTime - writtenTimeRemaining;
        const percentage = Math.round((score / totalQuestions) * 100);
        
        console.log("Final score:", score, "/", totalQuestions);
        console.log("Competency stats:", competencyStats);
        console.log("Time spent:", timeSpent, "seconds");
        
        // CRITICAL: This is the key update that marks it as complete for mentors
        const updateData = {
            status: "complete",  // CRITICAL: This is what mentors filter by
            completedAt: firebase.firestore.FieldValue.serverTimestamp(), // CRITICAL: This is what mentors sort by
            score: score,
            totalQuestions: totalQuestions,
            maxScore: totalQuestions,  // CRITICAL: Mentors expect this field
            competencyStats: competencyStats,
            timeSpent: timeSpent,
            detailedAnswers: detailedAnswers,
            competencies: Object.keys(competencyStats),
            correctCompetencies: Object.entries(competencyStats)
                .filter(([_, stats]) => stats.correct === stats.total)
                .map(([comp, _]) => comp),
            percentage: percentage,
            submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        console.log("=== FIREBASE UPDATE DATA ===");
        console.log("Document ID:", window.latestAssignmentId);
        console.log("Update Data:", updateData);
        
        // Update assignment in Firestore
        await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
        
        console.log("✅ Assignment updated successfully in Firestore");
        console.log("✅ Status set to 'complete'");
        console.log("✅ CompletedAt timestamp added");
        console.log("✅ MaxScore field added");
        
        // Prepare data for modal
        const resultsData = {
            message: `Excellent work! You scored ${score}/${totalQuestions}`,
            assignmentName: window.currentAssignment?.title || 'Written Practice',
            competencyStats: competencyStats,
            score: score,
            totalQuestions: totalQuestions,
            percentage: percentage,
            timeSpent: timeSpent
        };
        
        console.log("Congrats modal data:", resultsData);
        
        // Close modal first
        closeWrittenModal(true);
        
        // Show celebration
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 },
            colors: ['#3b82f6', '#1d4ed8', '#1e40af']
        });
        
        // Show results modal
        showCongratsModal(resultsData);
        
        // Clear globals AFTER successful submission
        window.latestAssignmentId = null;
        window.currentAssignment = null;
        
        console.log("=== WRITTEN PRACTICE SUBMISSION COMPLETE ===");
        
    } catch (error) {
        console.error("❌ Written practice submission error:", error);
        console.error("❌ Assignment ID was:", window.latestAssignmentId);
        console.error("❌ Current assignment was:", window.currentAssignment);
        alert("Failed to submit practice: " + error.message);
    }
}


function calculateQuizResults() {
    console.log("🧮 Calculating quiz results...");
    
    const results = {
        correct: 0,
        total: quizQuestions.length,
        answers: {},
        competencyStats: {},
        percentage: 0
    };
    
    console.log("📝 Processing", quizQuestions.length, "questions");
    
    // Calculate correct answers and build competency stats
    quizQuestions.forEach((question, idx) => {
        const selectedAnswer = document.querySelector(`input[name="q${idx+1}"]:checked`);
        if (selectedAnswer) {
            const answerValue = selectedAnswer.value;
            results.answers[`q${idx+1}`] = answerValue;
            
            console.log(`Q${idx+1}: Selected "${answerValue}", Correct: "${question.correctAnswer}"`);
            
            // Check if correct
            const isCorrect = answerValue === question.correctAnswer;
            if (isCorrect) {
                results.correct++;
                console.log(`✅ Q${idx+1} CORRECT`);
            } else {
                console.log(`❌ Q${idx+1} WRONG`);
            }
            
            // Track competency performance
            const competency = question.competency;
            if (!results.competencyStats[competency]) {
                results.competencyStats[competency] = {
                    total: 0,
                    correct: 0
                };
            }
            results.competencyStats[competency].total++;
            if (isCorrect) {
                results.competencyStats[competency].correct++;
            }
        }
    });
    
    results.percentage = Math.round((results.correct / results.total) * 100);
    
    console.log("📊 Final results:", results);
    return results;
}


function saveQuizResultsToFirebase(quizResults) {
    console.log("💾 Saving quiz results to Firebase:", quizResults);
    
    if (!window.latestAssignmentId) {
        return Promise.reject(new Error("No assignment ID found"));
    }
    
    const db = firebase.firestore();
    const user = firebase.auth().currentUser;
    
    if (!user) {
        return Promise.reject(new Error("User not authenticated"));
    }
    
    // Prepare the update data
    const updateData = {
        status: "complete",  // CRITICAL: This is what the mentor code filters by
        completedAt: firebase.firestore.FieldValue.serverTimestamp(), // CRITICAL: This is what mentor code sorts by
        score: quizResults.correct,  // The score achieved
        maxScore: quizResults.total, // Total possible score (mentor code expects this)
        percentage: quizResults.percentage,
        competencyStats: quizResults.competencyStats || {},
        submittedAnswers: quizResults.answers || {},
        timeTaken: quizResults.timeTaken || null,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    console.log("🔥 Updating assignment document:", window.latestAssignmentId);
    console.log("📊 Update data:", updateData);
    
    return db.collection("assignments")
        .doc(window.latestAssignmentId)
        .update(updateData)
        .then(() => {
            console.log("✅ Assignment updated successfully!");
            console.log("✅ Status set to 'complete'");
            console.log("✅ CompletedAt timestamp added");
            console.log("✅ Score:", quizResults.correct, "/", quizResults.total);
            
            // Optional: Create a notification for the mentor
            if (window.currentAssignment?.from) {
                return db.collection('notifications').add({
                    mentorId: window.currentAssignment.from,
                    menteeId: user.uid,
                    message: `${user.displayName || 'A mentee'} completed an assignment with score ${quizResults.correct}/${quizResults.total}`,
                    assignmentId: window.latestAssignmentId,
                    assignmentName: window.currentAssignment?.title || "Assignment",
                    type: "completion",
                    read: false,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        })
        .then(() => {
            console.log("✅ All Firebase operations completed successfully");
        })
        .catch(error => {
            console.error("❌ Firebase update error:", error);
            throw error;
        });
}


// FIXED: closeWrittenModal function - add parameter to indicate if completed
function closeWrittenModal(wasCompleted = false) {
    console.log("Closing written modal, wasCompleted:", wasCompleted);
    
    // Clear timer
    clearInterval(writtenTimer);
    
    // Hide modal
    document.getElementById('cq-written-modal').style.display = 'none';
    
    // Reset state
    writtenQuestions = [];
    currentQuestionIndex = 0;
    writtenAnswers = {};
    writtenTimeRemaining = 0;
    writtenTimer = null;
    
    // ONLY mark as "seen" if the user closed without completing
    if (!wasCompleted && window.latestAssignmentId && window.currentAssignment) {
        console.log("User closed modal without completing - marking as seen");
        db.collection('assignments').doc(window.latestAssignmentId)
            .update({ status: "complete" })
            .then(() => {
                console.log("Assignment marked as seen (user closed without completing)");
                window.latestAssignmentId = null;
                window.currentAssignment = null;
            })
            .catch(error => {
                console.error("Error updating assignment status:", error);
            });
    } else if (wasCompleted) {
        console.log("Modal closed after completion - not changing status");
        // Don't update status - submitWrittenPractice already set it to "complete"
        // Don't clear globals here either - let submitWrittenPractice handle it
    }
}



window.previousQuestion = previousQuestion;
window.nextQuestion = nextQuestion;
window.openWrittenPracticeModal = openWrittenPracticeModal;

function testWrittenModal() {
    window.currentAssignment = {
        type: 'written',
        title: 'Business Fundamentals Practice',
        time: '15', // 15 minutes
        writtenQuestions: sampleWrittenQuestions
    };
    window.latestAssignmentId = 'test-assignment-id';
    openWrittenPracticeModal(window.currentAssignment);
}

// Make test function globally available
window.testWrittenModal = testWrittenModal;


  function closeAssignmentModal() {
    document.getElementById('cq-assignment-modal').style.display = 'none';
  }

  function snoozeAssignment() {
    closeAssignmentModal(); // Status remains "assigned"
  }

  // === SPEAKING ASSIGNMENT FUNCTIONS ===
function submitCameraRecording() {
    // Show success and close
    closeCameraModal();
    
    confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
    });
    
    showCongratsModal({
        message: `Great job completing the speaking assignment!`,
        assignmentName: window.currentAssignmentQuestions?.title || "Assignment"
    });
}

function stopAllMedia() {
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
    }
    
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
    }
    
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    recordedChunks = [];
    recordingSeconds = 0;
}

// 1. ADD THIS CSS TO YOUR EXISTING STYLES
const uploadModalCSS = `
<style>
/* Upload Modal Styles */
.upload-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  z-index: 10002;
  display: none;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.upload-modal-overlay.active {
  opacity: 1;
}

.upload-modal-container {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 20px;
  max-width: 600px;
  width: 90%;
  color: white;
  transform: scale(0.9);
  transition: transform 0.3s ease;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
}

.upload-modal-overlay.active .upload-modal-container {
  transform: scale(1);
}

.upload-modal-header {
  padding: 25px 30px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.upload-modal-header h2 {
  margin: 0;
  font-size: 1.4rem;
  font-weight: 600;
}

.upload-modal-close {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.upload-modal-close:hover {
  background: rgba(255, 255, 255, 0.2);
}

.upload-modal-body {
  padding: 30px;
}

.upload-drop-zone {
  border: 3px dashed rgba(255, 255, 255, 0.3);
  border-radius: 15px;
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
}

.upload-drop-zone:hover {
  border-color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-2px);
}

.upload-drop-zone.dragover {
  border-color: #4CAF50;
  background: rgba(76, 175, 80, 0.1);
  transform: scale(1.02);
}

.upload-icon {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.7;
}

.upload-text {
  font-size: 1.1rem;
  margin-bottom: 10px;
  font-weight: 500;
}

.upload-subtext {
  font-size: 0.9rem;
  opacity: 0.7;
  margin-bottom: 20px;
}

.upload-file-input {
  display: none;
}

.upload-modal-footer {
  padding: 20px 30px 30px;
  display: flex;
  gap: 15px;
  justify-content: center;
}

.upload-btn {
  padding: 12px 24px;
  border-radius: 25px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  font-size: 1rem;
  transition: all 0.3s ease;
  min-width: 120px;
}

.upload-btn-primary {
  background: linear-gradient(45deg, #4CAF50, #45a049);
  color: white;
}

.upload-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
}

.upload-btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.upload-btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.upload-btn-secondary:hover {
  background: rgba(255, 255, 255, 0.2);
}

.file-selected {
  background: rgba(76, 175, 80, 0.2);
  border-color: #4CAF50;
  padding: 20px;
}

.file-info {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}

.file-name {
  font-weight: 600;
  color: #4CAF50;
}

.file-size {
  opacity: 0.7;
  font-size: 0.9rem;
}
</style>
`;


// 2. ADD THIS HTML TO YOUR BODY (before closing </body> tag)
const uploadModalHTML = `
<div id="uploadModal" class="upload-modal-overlay">
  <div class="upload-modal-container">
    <div class="upload-modal-header">
      <h2>Upload Your Recording</h2>
      <button class="upload-modal-close" onclick="closeUploadModal()">&times;</button>
    </div>
    <div class="upload-modal-body">
      <div id="uploadDropZone" class="upload-drop-zone">
        <div class="upload-icon">🎬</div>
        <div class="upload-text">Drop your recording here</div>
        <div class="upload-subtext">or click to browse files</div>
        <div class="upload-subtext">Supports WebM, MP4, MOV, AVI</div>
        <input type="file" id="uploadFileInput" class="upload-file-input" accept=".webm,.mp4,.mov,.avi,video/*,audio/*">
      </div>
      <div id="fileInfo" class="file-info" style="display: none;">
        <span class="file-name" id="fileName"></span>
        <span class="file-size" id="fileSize"></span>
      </div>
    </div>
    <div class="upload-modal-footer">
      <button class="upload-btn upload-btn-secondary" onclick="closeUploadModal()">Cancel</button>
      <button id="uploadSubmitBtn" class="upload-btn upload-btn-primary" disabled onclick="submitUploadedFile()">Send to Mentor</button>
    </div>
  </div>
</div>
`;


// 4. Add CSS styles
function addCameraModalCSS() {
    const styles = `
    <style>
        .camera-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d1b69 100%);
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .camera-modal-overlay.active {
            opacity: 1;
        }
        
        .camera-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .camera-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        
        .camera-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .camera-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .assignment-questions {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            gap: 20px;
        }
        
        .question-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            color: white;
        }
        
        .question-card strong {
            color: #64b5f6;
            display: block;
            margin-bottom: 8px;
        }
        
        .camera-main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }
        
        .video-preview {
            width: 80%;
            max-width: 800px;
            height: 60vh;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .recording-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff4757;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: none;
            animation: pulse 1.5s infinite;
        }
        
        .recording-indicator.active {
            display: block;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .recording-timer {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 1rem;
            font-family: monospace;
            display: none;
        }
        
        .recording-timer.active {
            display: block;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .camera-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 16px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .camera-toggle.camera-off {
            background: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
        }
        
        .record-btn {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            border: none;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(255, 71, 87, 0.3);
            color: white;
        }
        
        .record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 35px rgba(255, 71, 87, 0.4);
        }
        
        .record-btn.recording {
            background: #2ecc71;
        }
        
        .camera-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .action-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .no-camera {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .no-camera-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .audio-wave {
            display: flex;
            gap: 4px;
            margin: 20px 0;
        }
        
        .wave-bar {
            width: 4px;
            height: 20px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
        }
        
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes wave {
            0%, 40%, 100% { transform: scaleY(0.4); }
            20% { transform: scaleY(1); }
        }
    </style>`;
    
    document.head.insertAdjacentHTML('beforeend', styles);
}

// 5. Remove old speaking modal functions and replace with simple redirect
function openSpeakingAssignmentModal(q1, q2) {
    // This is now just a redirect to the camera modal
    window.currentAssignmentQuestions = {
        q1: q1 || "Question 1 here",
        q2: q2 || "Question 2 here", 
        title: "Speaking Assignment"
    };
    openCameraModal();
}
  function closeSpeakingAssignmentModal() {
    document.getElementById('cq-speaking-downloadBtn').style.display = 'none';

    // Stop any active recordings
    cqSpeakingStopAllMedia();
    
    // Hide modal
    document.getElementById('cq-speaking-modal').style.display = 'none';
    
    // Mark as seen (if assignment exists)
    if (window.latestAssignmentId) {
      db.collection('assignments').doc(window.latestAssignmentId)
        .update({ status: "complete" })
        .then(() => {
          window.latestAssignmentId = null;
          window.currentAssignment = null;
        })
        .catch(error => {
          console.error("Error updating assignment status:", error);
        });
    }
  }


async function submitSpeakingResponse() {
  if (!window.latestAssignmentId || recordedChunks.length === 0) {
    alert("Recording not found or assignment ID missing.");
    return;
  }

  const blob = new Blob(recordedChunks, { type: 'video/webm' });
  const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

  const GITHUB_USERNAME = "Anjay209";
  const GITHUB_REPO = "video-storage";
  const GITHUB_TOKEN = "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"; // 🔐 Rotate in production

  const githubApiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
  const githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

  try {
    const base64 = await blobToBase64(blob);

    const uploadRes = await fetch(githubApiUrl, {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Upload ${filename}`,
        content: base64,
        branch: 'main'
      })
    });

    if (!uploadRes.ok) {
      const errData = await uploadRes.json();
      throw new Error(errData?.message || "GitHub upload failed");
    }

    // Firestore update - setting status to "complete"
    await firebase.firestore()
      .collection('assignments')
      .doc(window.latestAssignmentId)
      .update({
        status: "complete", // Changed from "seen" to "complete"
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        recordingUrl: githubPagesUrl
      });

    // Optional UI feedback
    showCongratsModal({
      message: "Assignment submitted successfully!",
      assignmentName: window.currentAssignment?.title || "Assignment"
    });

    // Close the modal after submission
    closeSpeakingAssignmentModal();

  } catch (err) {
    console.error("Upload Error:", err);
    alert("Something went wrong while uploading your recording.");
  }
}

function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}


function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}




  // === NOTIFICATION FUNCTIONS ===
 function setupNotifications() {
  const user = auth.currentUser;
  if (!user) {
    console.log("No user logged in");
    return;
  }

  console.log("Setting up notifications for user:", user.uid);

  db.collection('notifications')
    .where('menteeId', '==', user.uid)
    .where('showModal', '==', true)
    .where('read', '==', false)
    .orderBy('timestamp', 'desc')
    .onSnapshot((snapshot) => {
      console.log("Received notifications snapshot with", snapshot.size, "items");
      
      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          console.log("New notification received:", change.doc.data());
          showCongratsModal(change.doc.data());
          
          // ONLY mark showModal as false to prevent re-showing
          // DON'T mark as read - let user dismiss manually
          setTimeout(() => {
            change.doc.ref.update({
              showModal: false  // Remove this line: read: true,
            });
          }, 1000);
        }
      });
    }, (error) => {
      console.error("Notifications error:", error);
    });

  // NEW: Load ALL notifications (read and unread) for the notification panel
  // REMOVED the showModal filter so notifications persist after reload
  // Load ALL notifications (read and unread) for the notification panel
db.collection('notifications')
    .where('menteeId', '==', user.uid)
    .orderBy('timestamp', 'desc')
    .limit(20) // Show last 20 notifications
    .onSnapshot((snapshot) => {
      const notificationList = document.getElementById("notificationList");
      if (!notificationList) return;
      
      notificationList.innerHTML = ''; // Clear existing
      
      snapshot.forEach((doc) => {
        const notif = doc.data();
        const item = document.createElement("div");
        item.className = `notification-item ${notif.read ? 'read' : ''}`;
        
        // Format timestamp
        let timeText = "Just now";
        if (notif.timestamp && notif.timestamp.toDate) {
          const date = notif.timestamp.toDate();
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          if (diffMins < 1) timeText = "Just now";
          else if (diffMins < 60) timeText = `${diffMins}m ago`;
          else if (diffHours < 24) timeText = `${diffHours}h ago`;
          else timeText = `${diffDays}d ago`;
        }
        
        // Different content based on notification type
        let bodyContent = '';
        if (notif.type === 'assignment') {
          bodyContent = `
            <div class="notification-body">
              Type: ${notif.assignmentType || 'Quiz'}<br>
              Competencies: ${notif.competencies ? notif.competencies.join(', ') : 'n/a'}<br>
              ${notif.time ? `Time: ${notif.time}<br>` : ''}
              ${notif.difficulty ? `Difficulty: ${notif.difficulty}` : ''}
            </div>
          `;
        } else {
          bodyContent = `
            <div class="notification-body">
              Assignment: ${notif.assignmentName || 'Unknown'}
              ${notif.score !== undefined ? `<br>Score: ${notif.score}/${notif.totalQuestions}` : ''}
            </div>
          `;
        }
        
        item.innerHTML = `
          <div class="notification-header">
            <strong>${notif.message || 'Notification'}</strong>
            <span class="notification-time">${timeText}</span>
          </div>
          ${bodyContent}
        `;
        
        // Add click handler based on notification type
        if (notif.type === 'assignment' && notif.assignmentId) {
          item.addEventListener("click", () => {
            // Mark as read
            if (!notif.read) {
              doc.ref.update({ read: true });
            }
            item.classList.add("read");
            
            // Fetch and show assignment details
            db.collection('assignments').doc(notif.assignmentId).get()
              .then(assignmentDoc => {
                if (assignmentDoc.exists) {
                  window.currentAssignment = assignmentDoc.data();
                  window.latestAssignmentId = notif.assignmentId;
                  openFullAssignmentModal(assignmentDoc.data());
                }
              })
              .catch(error => {
                console.error("Error fetching assignment:", error);
                alert("Could not load assignment details");
              });
          });
        } else {
          // Regular notification click handler
          item.addEventListener("click", () => {
            if (!notif.read) {
              doc.ref.update({ read: true });
            }
            item.classList.add("read");
          });
        }
        
        notificationList.appendChild(item);
      });
      
      // Update notification badge count
      const unreadCount = snapshot.docs.filter(doc => !doc.data().read).length;
      const notificationBadge = document.querySelector('.nav-icons li a[onclick="toggleCommentPanel()"] .notification-badge');
      if (notificationBadge) {
        if (unreadCount > 0) {
          notificationBadge.style.display = 'inline-block';
          notificationBadge.textContent = unreadCount;
        } else {
          notificationBadge.style.display = 'none';
        }
      }
    });
}

// ADD this new function to mark all notifications as read:
function markAllNotificationsRead() {
  const user = auth.currentUser;
  if (!user) return;
  
  db.collection('notifications')
    .where('menteeId', '==', user.uid)
    .where('read', '==', false)
    .get()
    .then((snapshot) => {
      const batch = db.batch();
      snapshot.forEach((doc) => {
        batch.update(doc.ref, { read: true });
      });
      return batch.commit();
    })
    .then(() => {
      console.log("All notifications marked as read");
      // Hide the badge
      const notificationBadge = document.querySelector('.nav-icons li a[onclick="toggleCommentPanel()"] .notification-badge');
      if (notificationBadge) {
        notificationBadge.style.display = 'none';
      }
    })
    .catch((error) => {
      console.error("Error marking notifications as read:", error);
    });
}

// Make the function globally available
window.markAllNotificationsRead = markAllNotificationsRead;

function showCongratsModal(results) {
  const modal = document.getElementById('congratsModal');
  const content = modal.querySelector('.cq-modal-fields');
  
  // Calculate percentage if not provided
  const percentage = results.percentage || Math.round((results.score / results.totalQuestions) * 100);
  
  // Build competency breakdown HTML
  let competenciesHTML = '';
  if (results.competencyStats) {
    competenciesHTML = `
      <div style="margin-top:1.25rem;">
        <b>Competency Breakdown:</b>
        ${Object.entries(results.competencyStats).map(([comp, stats]) => `
          <div style="margin-top:0.5rem;">
            <div>${comp}: ${stats.correct}/${stats.total} correct</div>
            <div style="height:6px; background:#e2e8f0; border-radius:3px; margin-top:2px;">
              <div style="height:100%; width:${(stats.correct/stats.total)*100}%; background:#4ade80; border-radius:3px;"></div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  content.innerHTML = `
    <div style="text-align:center; padding:1rem;">
      <div style="font-size:1.25rem; margin-bottom:1rem;">
        ${results.message || 'Quiz Completed!'}
      </div>
      <div style="font-size:0.9rem; color:#666; margin-bottom:0.5rem;">
        For completing: <strong>${results.assignmentName || 'the quiz'}</strong>
      </div>
      
      ${competenciesHTML}
    </div>
  `;
  
  modal.style.display = 'block';
  confetti({
    particleCount: 150,
    spread: 70,
    origin: { y: 0.6 }
  });
}


function closeCongratsModal(docId) {
  document.getElementById('congratsModal').style.display = 'none';
  db.collection('assignments').doc(docId).update({
        status: "complete"
    }).catch(error => {
        console.error("Error updating assignment status:", error);
    });
}

// ... rest of your code ...

  console.log("🔥 Firebase initialized and script loaded successfully");

 function toggleCommentPanel() {
  document.getElementById("commentPanel").classList.toggle("active");
}

window.toggleCommentPanel = toggleCommentPanel;

 
// Add these functions to your existing comprehensive script

// ============ NOTIFICATION LOADING SYSTEM ============

// Add this after your Firebase initialization
let notificationSystem = {
  notifications: [],
  initialized: false
};

// Add this function to load notifications when user is authenticated
async function loadUserNotifications(userId) {
  if (!userId || !db) return;
  
  try {
    // Load from Firestore
    const notificationsRef = db.collection(`users/${userId}/notifications`);
    const snapshot = await notificationsRef
      .orderBy('timestamp', 'desc')
      .limit(20)
      .get();
    
    const list = document.getElementById("notificationList");
    if (!list) {
      console.log("Notification list element not found");
      return;
    }
    
    // Clear existing notifications
    list.innerHTML = '';
    notificationSystem.notifications = [];
    
    if (snapshot.empty) {
      // Show a default message if no notifications
      list.innerHTML = `
        <div class="notification-item">
          <div class="notification-body" style="text-align: center; color: #666;">
            No notifications yet
          </div>
        </div>
      `;
      return;
    }
    
    // Render notifications
    snapshot.forEach(doc => {
      const data = doc.data();
      const notification = {
        id: doc.id,
        title: data.title || 'Notification',
        description: data.description || data.message || '',
        timestamp: data.timestamp?.toDate() || new Date(),
        read: data.read || false,
        onClick: data.clickAction || null
      };
      
      notificationSystem.notifications.push(notification);
      renderNotificationItem(notification);
    });
    
    updateNotificationBadge();
    console.log(`Loaded ${notificationSystem.notifications.length} notifications`);
    
  } catch (error) {
    console.error("Error loading notifications:", error);
    const list = document.getElementById("notificationList");
    if (list) {
      list.innerHTML = `
        <div class="notification-item">
          <div class="notification-body" style="text-align: center; color: #dc3545;">
            Error loading notifications
          </div>
        </div>
      `;
    }
  }
}

// Function to render a single notification item
function renderNotificationItem(notification) {
  const list = document.getElementById("notificationList");
  if (!list) return;
  
  const item = document.createElement("div");
  item.className = `notification-item ${notification.read ? 'read' : ''}`;
  item.dataset.notificationId = notification.id;
  
  item.innerHTML = `
    <div class="notification-header">
      <strong>${notification.title}</strong>
      <span class="notification-time">${formatNotificationTime(notification.timestamp)}</span>
    </div>
    <div class="notification-body">${notification.description}</div>
  `;
  
  if (notification.onClick) {
    item.addEventListener("click", () => {
      eval(notification.onClick); // Be careful with this - better to use a function registry
      markNotificationAsRead(notification.id);
    });
    item.style.cursor = 'pointer';
  }
  
  list.appendChild(item);
}

// Function to format notification timestamp
function formatNotificationTime(timestamp) {
  const now = new Date();
  const time = new Date(timestamp);
  const diff = now - time;
  
  if (diff < 60000) return 'Just now';
  if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
  if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
  return time.toLocaleDateString();
}

// Function to update notification badge
function updateNotificationBadge() {
  const unreadCount = notificationSystem.notifications.filter(n => !n.read).length;
  const badges = document.querySelectorAll('.notification-badge');
  
  badges.forEach(badge => {
    if (unreadCount > 0) {
      badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
      badge.style.display = 'inline-block';
    } else {
      badge.style.display = 'none';
    }
  });
}

// Function to mark notification as read
async function markNotificationAsRead(notificationId) {
  const userId = await getCurrentUserId();
  if (!userId || !db) return;
  
  try {
    await db.doc(`users/${userId}/notifications/${notificationId}`).update({
      read: true
    });
    
    // Update local state
    const notification = notificationSystem.notifications.find(n => n.id === notificationId);
    if (notification) {
      notification.read = true;
    }
    
    // Update UI
    const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
    if (item) {
      item.classList.add('read');
    }
    
    updateNotificationBadge();
  } catch (error) {
    console.error("Error marking notification as read:", error);
  }
}

// Enhanced showNotification function that saves to Firebase
async function showNotification(title, description, onClick = null) {
  const userId = await getCurrentUserId();
  
  // Show immediately in UI
  const list = document.getElementById("notificationList");
  if (list) {
    const item = document.createElement("div");
    item.className = "notification-item";
    item.innerHTML = `
      <div class="notification-header">
        <strong>${title}</strong>
        <span class="notification-time">Just now</span>
      </div>
      <div class="notification-body">${description}</div>
    `;

    if (onClick) {
      item.addEventListener("click", () => {
        onClick();
        item.classList.add("read");
      });
      item.style.cursor = 'pointer';
    }

    list.prepend(item);
  }
  
  // Save to Firebase if user is authenticated
  if (userId && db) {
    try {
      await db.collection(`users/${userId}/notifications`).add({
        title,
        description,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        read: false,
        clickAction: onClick ? onClick.toString() : null
      });
      console.log("Notification saved to Firebase");
    } catch (error) {
      console.error("Error saving notification:", error);
    }
  }
  
  updateNotificationBadge();
}

// Add this to your startAppWithUserId function
async function startAppWithUserId(userId) {
  mentorId = userId;
  console.log("Starting app with Firebase Auth UID:", userId);

  // Load notifications first
  await loadUserNotifications(userId);

  // Your existing code...
  db.collection(`users/${userId}/trainingProgress`).onSnapshot((snap) => {
    const progress = {};
    snap.forEach(doc => progress[doc.id] = doc.data().status);
    lastProgress = progress;
    
    const activeTab = document.querySelector(".tab.active");
    if (activeTab && tabs.length >= 2 && activeTab === tabs[1]) {
      renderTrainingGrid(progress, true);
    } else {
      renderTrainingGrid(progress, false);
    }
  });

  // Set up real-time notification listener
  db.collection(`users/${userId}/notifications`)
    .orderBy('timestamp', 'desc')
    .limit(20)
    .onSnapshot((snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          // Only add if it's a new notification (not from initial load)
          if (notificationSystem.initialized) {
            const data = change.doc.data();
            const notification = {
              id: change.doc.id,
              title: data.title || 'Notification',
              description: data.description || data.message || '',
              timestamp: data.timestamp?.toDate() || new Date(),
              read: data.read || false
            };
            
            // Add to beginning of array and render
            notificationSystem.notifications.unshift(notification);
            const list = document.getElementById("notificationList");
            if (list && list.children.length > 0 && list.children[0].textContent.includes("No notifications")) {
              list.innerHTML = ''; // Clear the "no notifications" message
            }
            renderNotificationItem(notification);
            updateNotificationBadge();
          }
        }
      });
      notificationSystem.initialized = true;
    });

  showGridView();
}

// Test function to create sample notifications (remove in production)
async function createTestNotifications() {
  const userId = await getCurrentUserId();
  if (!userId) return;
  
  await showNotification("Welcome to CertQuest!", "Your dashboard is ready to use");
  await showNotification("Training Available", "New business management modules are available");
  await showNotification("XP Earned", "You earned 10 XP for completing a module!");
}

// Notification System Core
function toggleCommentPanel() {
  const panel = document.getElementById('commentPanel');
  panel.classList.toggle('hidden');
  
  if (!panel.classList.contains('hidden')) {
    loadNotifications();
  }
}

// 1. UPDATE NOTIFICATION LOADER
async function loadNotifications() {
  try {
    const user = firebase.auth().currentUser;
    if (!user) return;

    // Fetch both notifications AND assignments
    const [notifications, assignments] = await Promise.all([
      firebase.firestore().collection('notifications')
        .where('userId', '==', user.uid)
        .orderBy('timestamp', 'desc')
        .limit(10)
        .get(),
        
      firebase.firestore().collection('assignments')
        .where('userId', '==', user.uid)
        .where('status', '==', 'pending')
        .limit(3)
        .get()
    ]);

    // Combine and sort all items
    const allItems = [
      ...notifications.docs.map(doc => ({
        type: 'notification',
        ...doc.data(),
        timestamp: doc.data().timestamp?.toDate()
      })),
      ...assignments.docs.map(doc => ({
        type: 'assignment',
        id: doc.id,
        title: `New Assignment: ${doc.data().title}`,
        message: `Due: ${doc.data().dueDate?.toDate().toLocaleDateString()}`,
        timestamp: doc.data().assignedAt?.toDate()
      }))
    ].sort((a, b) => b.timestamp - a.timestamp);

    renderNotifications(allItems);
    
  } catch (error) {
    console.error("Load error:", error);
  }
}

// 2. UPDATE RENDER FUNCTION
function renderNotifications(items) {
  const container = document.getElementById('notificationList');
  if (!container) return;

  container.innerHTML = items.map(item => `
    <div class="notification-item ${item.type}">
      <strong>${item.title || 'New Item'}</strong>
      <p>${item.message || ''}</p>
      <small>${item.timestamp?.toLocaleString() || ''}</small>
      ${item.type === 'assignment' ? 
        `<button class="btn-small" onclick="openAssignment('${item.id}')">
          View
        </button>` : ''
      }
    </div>
  `).join('');
}

// 3. ADD THIS TO YOUR INITIALIZATION
function setupNotificationHandlers() {
  // Refresh notifications every 5 minutes
  setInterval(loadNotifications, 300000);
  
  // Also load when panel opens
  document.getElementById('commentPanel').addEventListener('click', (e) => {
    if (e.target.classList.contains('notification-item')) {
      loadNotifications();
    }
  });
}

// 4. RUN THIS IMMEDIATELY
if (document.getElementById('commentPanel')) {
  setupNotificationHandlers();
  loadNotifications(); // Initial load
}


 function toggleCommentPanel() {
  document.getElementById("commentPanel").classList.toggle("active");
}

window.toggleCommentPanel = toggleCommentPanel;

</script>





</body>
</html>