<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mentor Dashboard | FBLAZE</title>
  <link rel="stylesheet" href="mentor1.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
  authDomain: "certquest-94959.firebaseapp.com",
  projectId: "certquest-94959",
  storageBucket: "certquest-94959.firebasestorage.app",
  messagingSenderId: "323956529033",
  appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
  measurementId: "G-F5JHTGGN6K"
};
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
</script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="module" src="/js/firebase.js"></script></head>
<body>
  <!-- Space Background -->
  <div class="space-background" id="spaceBackground">
    <div class="star-field" id="starField"></div>
    <div class="nebula nebula-1"></div>
    <div class="nebula nebula-2"></div>
  </div>

  <!-- Header -->
  <header class="mentor-header">
    <div class="mentor-header-content">
      <div class="header-left">
        <button class="hamburger-menu" id="hamburgerMenu" onclick="toggleMobileNav()" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <h1 class="blaze-logo">FBLAZE</h1>
      </div>
      <button id="backButton" class="back-button" style="display: none;" onclick="goBack()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>
      <h1 class="blaze-logo desktop-logo">FBLAZE</h1>
      <nav class="mentor-nav" id="mainNav">
        <button class="mobile-nav-close" onclick="toggleMobileNav()" aria-label="Close menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <a href="home3.html" class="nav-link">HOME</a>
        <a href="javascript:void(0)" onclick="toggleNotificationPanel()" class="nav-link" style="position: relative;">
          NOTIFICATIONS
          <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="practice.html" class="nav-link">PRACTICE</a>
        <a href="Forum/forum.html" class="nav-link">FORUM</a>
        <a href="Calendar/calendar1.html" class="nav-link">CALENDAR</a>
        <a href="mentor1.html" class="nav-link" id="mentorNavLink" style="display: none;">MENTOR</a>
      </nav>
    </div>
    
    <div class="mentor-subnav">
      <div class="mentor-subnav-content">
        <button class="subnav-btn active" onclick="selectSubnav(this, 'dashboard')">Dashboard</button>
        <a href="assigned1.html" class="subnav-btn">Assignments</a>
        <a href="meeting1.html" class="subnav-btn">Meetings</a>
  </div>
    </div>
  </header>

  <!-- Notification Panel -->
  <div id="notificationPanel" class="notification-panel hidden">
    <div class="notification-panel-header">
      <h3 class="notification-panel-title">NOTIFICATIONS</h3>
      <button onclick="toggleNotificationPanel()" class="close-notifications">‚úï</button>
    </div>
    <div id="notificationList" class="notification-list"></div>
  </div>

  <!-- Main Content -->
  <main class="mentor-main" id="mentorMain">
    <!-- Dashboard View -->
    <div id="dashboardView" class="mentor-view">
      <!-- Hero Section -->
      <div class="mentor-hero">
        <h2 class="mentor-hero-title">
          How are your
          <span class="mentor-hero-gradient">mentees progressing?</span>
        </h2>
        <p class="mentor-hero-subtitle">Track performance, accuracy, and growth across all your mentees</p>
      </div>

      <!-- Stats Grid -->
      <div class="mentor-stats-grid" id="statsGrid">
        <div class="stat-card">
          <div class="stat-content">
            <div>
              <p class="stat-label">Total Mentees</p>
              <p class="stat-value" id="totalMentees">0</p>
            </div>
            <svg class="stat-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
    </svg>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-content">
            <div>
              <p class="stat-label">Avg Accuracy</p>
              <p class="stat-value" id="avgAccuracy">0%</p>
            </div>
            <svg class="stat-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
  </svg>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-content">
            <div>
              <p class="stat-label">Avg Progress</p>
              <p class="stat-value" id="avgProgress">0%</p>
            </div>
            <svg class="stat-icon" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
    </svg>
          </div>
        </div>
      </div>

      <!-- Mentees Section -->
      <div class="mentor-mentees-section">
        <h3 class="mentor-section-title">Your Mentees</h3>
        <div class="mentor-mentees-grid" id="menteesGrid">
          <!-- Mentee cards will be populated here -->
        </div>
      </div>
    </div>

    <!-- Mentee Detail View -->
    <div id="menteeDetailView" class="mentor-view" style="display: none;">
      <h2 class="mentor-detail-title">MCQ Accuracy Over Time</h2>
      <p class="mentor-detail-subtitle">Tracking performance across individual questions</p>

      <!-- Controls -->
      <div class="mentor-chart-controls">
        <button class="control-btn" onclick="shiftQuestionRange(-50)" id="prevRangeBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
          Previous 50
        </button>

        <button class="control-btn" onclick="shiftQuestionRange(50)" id="nextRangeBtn">
          Next 50
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
        </button>

        <div class="control-input-group">
          <input type="text" id="questionRangeInput" placeholder="Questions 1-100" disabled class="control-input" />
          <select id="jumpSelect" class="control-select">
            <option>Jump to...</option>
            <option>1-50</option>
            <option>51-100</option>
          </select>
          <button class="control-jump-btn" onclick="jumpToQuestionRange()">Jump</button>
      </div>

        <select id="competitionFilter" class="control-select">
          <option>Competition: All</option>
    </select>
  </div>

      <!-- Chart -->
      <div class="mentor-chart-container">
        <canvas id="mcqChart"></canvas>
</div>

      <!-- Recent Activity -->
      <div class="mentor-activity-section">
        <h3 class="mentor-section-title">Recent Activity</h3>
        <div class="mentor-activity-list" id="recentActivityList">
          <!-- Activity items will be populated here -->
</div>
      </div>
    </div>
  </main>

  <!-- Assignment Modal -->
  <div id="cq-assignment-modal" class="cq-modal" style="display: none;">
    <div class="cq-modal-content">
      <span class="cq-close" onclick="closeAssignmentModal()">&times;</span>
      <div id="cq-assignment-title" class="cq-modal-title">New Assignment</div>
      
      <!-- Assignment Info (shown first) -->
      <div id="cq-assignment-info">
        <div id="cq-assignment-fields" class="cq-modal-fields"></div>
        <div class="cq-modal-footer" style="margin-top:1.5rem; text-align:right;">
          <button class="cq-modal-btn" onclick="acceptAssignmentNow()">I'll do it now</button>
          <button class="cq-modal-btn" onclick="snoozeAssignment()">I'll do it later</button>
</div>
</div>

      <!-- Quiz Section (hidden initially) -->
      <div id="cq-assignment-quiz" style="display:none;">
        <div class="quiz-meta">
          <span id="quizDifficulty">Difficulty: Medium</span>
          <span id="quizTime">Time: 10 mins</span>
          <span id="quizScore" style="margin-left: auto; font-weight: 600;">Score: 0/5</span>
        </div>
        <div id="quizQuestions" class="cq-modal-fields"></div>
        <div class="cq-modal-footer">
          <button class="cq-modal-btn" id="submitQuizBtn" disabled>Submit Answers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz Modal - Fullscreen -->
  <div id="quizModal" style="display: none;" class="practice-quiz-fullscreen">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="quizStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
</div>

    <!-- Top Bar -->
    <div class="practice-quiz-topbar">
      <div class="practice-quiz-topbar-content">
  <div>
          <h1 id="quizTitle" class="practice-quiz-topbar-title">Easy Written Practice</h1>
          <p class="practice-quiz-topbar-subtitle">
            <span id="quizProgress">Question 1 of 14</span>
          </p>
  </div>
        
        <div class="practice-quiz-topbar-right">
          <div class="practice-quiz-timer-section">
            <p class="practice-quiz-timer-label">Time Remaining</p>
            <p id="quizTimer" class="practice-quiz-timer-value">14:53</p>
          </div>
          
          <button class="practice-quiz-close-btn" onclick="closeQuizModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
  </div>
</div>

    <!-- Main Content -->
    <div class="practice-quiz-main">
      <!-- Competency Badge -->
      <div class="practice-quiz-competency-badge">
        <span id="questionCompetency" class="practice-quiz-competency-text">Business Communication</span>
      </div>

      <!-- Question -->
      <div class="practice-quiz-question-section">
        <h2 id="questionText" class="practice-quiz-question">Loading question...</h2>
        <p class="practice-quiz-question-hint">Select the best answer from the options below</p>
</div>

      <!-- Answer Options -->
      <div id="optionsContainer" class="practice-quiz-options">
        <!-- Options will be populated dynamically -->
      </div>

      <!-- Progress Section -->
      <div class="practice-quiz-progress-section">
        <div class="practice-quiz-progress-header">
          <p class="practice-quiz-progress-label">Overall Progress</p>
          <p class="practice-quiz-progress-value"><span id="progressPercent">0</span>%</p>
        </div>
        <div class="practice-quiz-progress-bar">
          <div class="practice-quiz-progress-fill" id="progressFill" style="width: 0%"></div>
  </div>
</div>

      <!-- Navigation Buttons -->
      <div class="practice-quiz-actions">
        <button id="quizPrevBtn" class="practice-quiz-prev-btn" onclick="previousQuestion()" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Previous Question
        </button>
        <button id="quizNextBtn" class="practice-quiz-next-btn" onclick="nextQuestion()">Next Question</button>
        <button id="quizSubmitBtn" class="practice-quiz-submit-btn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
      </div>
    </div>
  </div>

  <!-- Congratulations Modal - Fullscreen -->
  <div id="congratsModal" class="practice-quiz-fullscreen" style="display:none;">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="congratsStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Main Content - Centered -->
    <div class="practice-quiz-main" style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px);">
      <div class="congrats-content">
        <!-- Congratulations Header - Centered -->
        <div class="congrats-header">
          <h1 id="congratsTitle" class="congrats-title">Congratulations!</h1>
          <p class="congrats-subtitle" id="congratsSubtitle">
            Excellent work! You scored <span id="congratsScore">0/0</span>
          </p>
        </div>

        <!-- Assignment Info - Centered -->
        <div class="congrats-assignment-info">
          <p class="congrats-assignment-label">For completing:</p>
          <h2 id="congratsAssignmentName" class="congrats-assignment-name">Written Practice</h2>
        </div>

        <!-- Competency Breakdown - Grid Layout -->
        <div class="congrats-competencies-grid" id="congratsCompetencies">
          <!-- Competencies will be populated here -->
        </div>

        <!-- Action Button -->
        <div class="congrats-actions">
          <button class="practice-quiz-next-btn" onclick="closeCongratsModal()">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assignment Loader - Fullscreen Blurred -->
  <div id="assignmentLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 10000; justify-content: center; align-items: center; flex-direction: column;">
    <div class="circular-progress-loader">
      <svg class="circular-progress-svg" viewBox="0 0 100 100">
        <defs>
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#f97316;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#eab308;stop-opacity:1" />
          </linearGradient>
        </defs>
        <circle class="circular-progress-bg" cx="50" cy="50" r="45"></circle>
        <circle class="circular-progress-fill" cx="50" cy="50" r="45" id="circularProgressFill"></circle>
      </svg>
      <div class="circular-progress-text" id="circularProgressText">0%</div>
    </div>
  </div>

  <div id="cq-written-loading" class="cq-written-loading" style="display:none;">
    <!-- Gradient balls background -->
    <div class="gradient-balls">
        <div class="ball ball-1"></div>
        <div class="ball ball-2"></div>
        <div class="ball ball-3"></div>
        <div class="ball ball-4"></div>
    </div>
    
    <!-- Loading content -->
    <div class="cq-loading-container">
        <div class="cq-loading-spinner"></div>
        <div class="cq-loading-text">Loading Assignment!</div>
        <div class="cq-loading-subtext">Analyzing your competencies and creating personalized content...</div>
        <div class="cq-loading-progress">
            <div class="cq-loading-progress-bar" id="cq-loading-progress-bar"></div>
        </div>
    </div>
  </div>

  <!-- Speaking Assignment Modal -->
  <div id="cq-speaking-modal" class="cq-speaking-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-speaking-stars" id="cq-speaking-stars"></div>
    <div class="cq-speaking-glow-1"></div>
    <div class="cq-speaking-glow-2"></div>
    
    <div class="cq-speaking-modal-content">
      <!-- Header -->
      <div class="cq-speaking-header">
        <h1 class="cq-speaking-title" id="cq-speaking-title">Speaking Assessment</h1>
        <button class="cq-speaking-close" onclick="closeSpeakingAssignmentModal()">√ó</button>
      </div>
      
      <!-- Main Container -->
      <div class="cq-speaking-main-container">
        <!-- Questions Row -->
        <div class="cq-speaking-questions">
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 1:</h2>
            <p id="cq-speaking-q1" class="cq-speaking-question-text">What is your strategy for this scenario?</p>
          </div>
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 2:</h2>
            <p id="cq-speaking-q2" class="cq-speaking-question-text">How would you handle unexpected challenges?</p>
          </div>
        </div>
        
        <!-- Video Feed -->
        <div class="cq-speaking-video-container">
          <video id="cq-speaking-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-speaking-noVideoView" class="cq-speaking-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-speaking-recordingIndicator" class="cq-speaking-recording-indicator">
            <div class="cq-speaking-recording-dot"></div>
            <span class="cq-speaking-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Controls -->
        <div class="cq-speaking-controls-wrapper">
          <div class="cq-speaking-controls">
            <button id="cq-speaking-documentBtn" class="cq-speaking-control-btn" title="Document">
              üìÑ
            </button>
            <button id="cq-speaking-recordBtn" class="cq-speaking-record-btn" onclick="toggleSpeakingRecording()">
              üé§
            </button>
            <button id="cq-speaking-micBtn" class="cq-speaking-control-btn" title="Settings">
              ‚öôÔ∏è
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-speaking-submitBtn" class="cq-speaking-submit-btn" style="display:none;" onclick="submitSpeakingResponse()">Submit Assessment</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-speaking-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-speaking-audioBtn" style="display:none;"></button>
      <button id="cq-speaking-videoBtn" style="display:none;"></button>
      <button id="cq-speaking-stopBtn" style="display:none;"></button>
      <button id="cq-speaking-downloadBtn" style="display:none;"></button>
    </div>
  </div>

  <!-- Case Study Assignment Modal -->
  <div id="cq-case-study-modal" class="cq-case-study-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-case-study-stars" id="cq-case-study-stars"></div>
    <div class="cq-case-study-glow-1"></div>
    <div class="cq-case-study-glow-2"></div>
    
    <div class="cq-case-study-modal-content">
      <!-- Header -->
      <div class="cq-case-study-header">
        <h1 class="cq-case-study-title" id="cq-case-study-title">Case Study</h1>
        <div class="cq-case-study-header-right">
          <!-- Timer -->
          <div id="cq-case-study-timer" class="cq-case-study-timer" onclick="toggleCaseStudyTimer()">
            <div id="cq-case-study-timer-dot" class="cq-case-study-timer-dot"></div>
            <span id="cq-case-study-timer-text" class="cq-case-study-timer-text">20:00</span>
            <span id="cq-case-study-timer-start" class="cq-case-study-timer-start">Start</span>
          </div>
          <button class="cq-case-study-close" onclick="closeCaseStudyModal()">√ó</button>
        </div>
      </div>
      
      <!-- Main Container -->
      <div class="cq-case-study-main-container">
        <!-- Top Info Section (when content collapsed) -->
        <div id="cq-case-study-top-info" class="cq-case-study-top-info">
          <div class="cq-case-study-info-card">
            <p class="cq-case-study-info-label">Case Name</p>
            <p id="cq-case-study-name" class="cq-case-study-info-value">Market Expansion Strategy</p>
          </div>
          <div id="cq-case-study-content-preview" class="cq-case-study-info-card cq-case-study-clickable" onclick="expandCaseStudyContent()">
            <p class="cq-case-study-info-label">Case Study Content</p>
            <p id="cq-case-study-content-preview-text" class="cq-case-study-info-preview">Loading...</p>
            <p class="cq-case-study-read-more">Read More ‚Üí</p>
          </div>
        </div>
        
        <!-- Expanded Content (when content expanded) -->
        <div id="cq-case-study-expanded-content" class="cq-case-study-expanded-content" style="display:none;">
          <div class="cq-case-study-expanded-header">
            <div>
              <p class="cq-case-study-expanded-label">Case Study Content</p>
              <h3 id="cq-case-study-expanded-title" class="cq-case-study-expanded-title">Market Expansion Strategy</h3>
            </div>
            <button class="cq-case-study-expanded-close" onclick="collapseCaseStudyContent()">√ó</button>
          </div>
          <p id="cq-case-study-full-content" class="cq-case-study-full-content">Loading...</p>
        </div>
        
        <!-- Video Feed (hidden when content expanded) -->
        <div id="cq-case-study-video-container" class="cq-case-study-video-container">
          <video id="cq-case-study-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-case-study-noVideoView" class="cq-case-study-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-case-study-recordingIndicator" class="cq-case-study-recording-indicator">
            <div class="cq-case-study-recording-dot"></div>
            <span class="cq-case-study-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Bottom Info Section (hidden when content expanded) -->
        <div id="cq-case-study-bottom-info" class="cq-case-study-bottom-info">
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 1</p>
            <p id="cq-case-study-q1" class="cq-case-study-question-text">What are the key market opportunities and challenges?</p>
          </div>
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 2</p>
            <p id="cq-case-study-q2" class="cq-case-study-question-text">How would you develop a comprehensive expansion strategy?</p>
          </div>
        </div>
        
        <!-- Controls (hidden when content expanded) -->
        <div id="cq-case-study-controls-wrapper" class="cq-case-study-controls-wrapper">
          <div class="cq-case-study-controls">
            <button id="cq-case-study-recordBtn" class="cq-case-study-record-btn" onclick="toggleCaseStudyRecording()">
              üé§
            </button>
            <button id="cq-case-study-downloadBtn" class="cq-case-study-control-btn" title="Download" style="display:none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="7" y="7" width="10" height="10" rx="2.5" fill="#60a5fa"/>
                <path d="M12 9.5v4.5m0 0l-2.5-2.5m2.5 2.5l2.5-2.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-case-study-submitBtn" class="cq-case-study-submit-btn" style="display:none;" onclick="submitCaseStudyResponse()">Submit Case Study</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-case-study-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-case-study-audioBtn" style="display:none;"></button>
      <button id="cq-case-study-videoBtn" style="display:none;"></button>
      <button id="cq-case-study-stopBtn" style="display:none;"></button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
<script>
    // Firebase Configuration

    if (!firebase.apps.length) {
    }

  const db = firebase.firestore();
  const auth = firebase.auth();

    // Global state
    let selectedMentee = null;
    let questionRange = 1;
    let mentees = [];
    let allData = {};
    let mcqChartObj = null;
    let mentorComps = [];

    // Create star field
    // Mobile Navigation Toggle
    window.toggleMobileNav = function() {
      const nav = document.getElementById('mainNav');
      const hamburger = document.getElementById('hamburgerMenu');
      
      if (nav && hamburger) {
        nav.classList.toggle('active');
        hamburger.classList.toggle('active');
        document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
      }
    };
    
    // Close mobile nav when clicking a nav link
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.mentor-nav .nav-link').forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            toggleMobileNav();
          }
        });
      });
    });

    function createStarField() {
      const starField = document.getElementById('starField');
      if (!starField) return;
      
      starField.innerHTML = '';
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.top = Math.random() * 100 + '%';
        star.style.left = Math.random() * 100 + '%';
        star.style.width = (Math.random() * 2 + 0.5) + 'px';
        star.style.height = star.style.width;
        star.style.opacity = Math.random() * 0.7 + 0.3;
        star.style.animationDuration = (Math.random() * 3 + 2) + 's';
        starField.appendChild(star);
      }
    }

    // Navigation
    function selectSubnav(button, view) {
      document.querySelectorAll('.subnav-btn').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      
      if (view === 'assignments') {
        window.location.href = 'assigned.html';
      } else if (view === 'meetings') {
        window.location.href = 'meeting.html';
      }
    }

    function goBack() {
      document.getElementById('dashboardView').style.display = 'block';
      document.getElementById('menteeDetailView').style.display = 'none';
      document.getElementById('backButton').style.display = 'none';
      selectedMentee = null;
    }

    function showMenteeDetail(mentee) {
      selectedMentee = mentee;
      document.getElementById('dashboardView').style.display = 'none';
      document.getElementById('menteeDetailView').style.display = 'block';
      document.getElementById('backButton').style.display = 'block';
      updateMenteeChart(mentee);
    }

    // Notification Pipeline
    function toggleNotificationPanel() {
      const panel = document.getElementById("notificationPanel");
      if (!panel) return;
      
      if (panel.classList.contains("active")) {
        panel.classList.remove("active");
        setTimeout(() => panel.classList.add("hidden"), 300);
      } else {
        panel.classList.remove("hidden");
        setTimeout(() => panel.classList.add("active"), 10);
        loadNotifications();
      }
    }
    window.toggleNotificationPanel = toggleNotificationPanel;

    function updateNotificationBadge(count) {
      const notificationLink = document.querySelector('a[onclick*="toggleNotificationPanel"]');
      if (notificationLink) {
        let notificationBadge = notificationLink.querySelector('.notification-badge');
        if (!notificationBadge && count > 0) {
          notificationBadge = document.createElement('span');
          notificationBadge.className = 'notification-badge';
          notificationBadge.id = 'notificationBadge';
          notificationBadge.textContent = count;
          notificationLink.style.position = 'relative';
          notificationLink.appendChild(notificationBadge);
        } else if (notificationBadge) {
          if (count > 0) {
            notificationBadge.style.display = 'inline-flex';
            notificationBadge.textContent = count;
          } else {
            notificationBadge.style.display = 'none';
          }
        }
      }
    }
    window.updateNotificationBadge = updateNotificationBadge;

    function setupNotifications() {
      const user = auth.currentUser;
  if (!user) return;
      
      const notificationList = document.getElementById('notificationList');
      if (!notificationList) return;
      
      db.collection('notifications')
        .where('menteeId', '==', user.uid)
        .limit(50)
        .onSnapshot((snapshot) => {
          notificationList.innerHTML = '';
          
          let unreadCount = 0;
          const notifications = [];
          
          if (snapshot.empty) {
            notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
            updateNotificationBadge(0);
            return;
          }
          
          snapshot.forEach((doc) => {
            notifications.push({ id: doc.id, data: doc.data(), ref: doc.ref });
          });
          
          notifications.sort((a, b) => {
            const aTime = a.data.timestamp?.toDate?.() || new Date(0);
            const bTime = b.data.timestamp?.toDate?.() || new Date(0);
            return bTime - aTime;
          });
          
          notifications.forEach(({ id, data: notif, ref }) => {
            if (!notif.read) {
              unreadCount++;
            }
            
            const item = document.createElement('div');
            item.className = `notification-item ${notif.read ? 'read' : ''}`;
            
            let timeText = 'Just now';
            if (notif.timestamp && notif.timestamp.toDate) {
              const date = notif.timestamp.toDate();
              const now = new Date();
              const diffMs = now - date;
              const diffMins = Math.floor(diffMs / 60000);
              const diffHours = Math.floor(diffMs / 3600000);
              const diffDays = Math.floor(diffMs / 86400000);
              
              if (diffMins < 1) timeText = 'Just now';
              else if (diffMins < 60) timeText = `${diffMins}m ago`;
              else if (diffHours < 24) timeText = `${diffHours}h ago`;
              else timeText = `${diffDays}d ago`;
            }
            
            if (notif.type === 'assignment' && notif.assignmentId) {
              db.collection('assignments').doc(notif.assignmentId).get().then((assignmentDoc) => {
                if (assignmentDoc.exists) {
                  const assignment = assignmentDoc.data();
                  item.innerHTML = `
                    <div class="notification-header">
                      <strong>${notif.message || notif.title || 'New Assignment'}</strong>
                      <span class="notification-time">${timeText}</span>
                    </div>
                    <div class="notification-body">
                      Type: ${assignment.type || 'Quiz'}<br>
                      Competencies: ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}<br>
                      ${assignment.time ? `Time: ${assignment.time}<br>` : ''}
                      ${assignment.difficulty ? `Difficulty: ${assignment.difficulty}` : ''}
                    </div>
                  `;
                  
                  item.addEventListener('click', () => {
                    if (!notif.read) {
                      ref.update({ read: true });
                    }
                    item.classList.add('read');
                    
                    // Fetch and show assignment details
                    db.collection('assignments').doc(notif.assignmentId).get()
                      .then(assignmentDoc => {
                        if (assignmentDoc.exists) {
                          window.currentAssignment = assignmentDoc.data();
                          window.latestAssignmentId = notif.assignmentId;
                          openFullAssignmentModal(assignmentDoc.data());
                        }
                      })
                      .catch(error => {
                        console.error("Error fetching assignment:", error);
                        alert("Could not load assignment details");
                      });
                  });
                }
              });
            } else {
              item.innerHTML = `
                <div class="notification-header">
                  <strong>${notif.message || notif.title || 'Notification'}</strong>
                  <span class="notification-time">${timeText}</span>
                </div>
                <div class="notification-body">
                  ${notif.message || notif.title || 'Notification'}
                </div>
              `;
              
              item.addEventListener('click', () => {
                if (!notif.read) {
                  ref.update({ read: true });
                }
                item.classList.add('read');
              });
            }
            
            notificationList.appendChild(item);
          });
          
          updateNotificationBadge(unreadCount);
        }, (error) => {
          console.error('Error loading notifications:', error);
        });
    }

    function loadNotifications() {
      setupNotifications();
    }

    // Load mentees and data
    window.addEventListener('load', async function() {
      createStarField();
      
      const user = auth.currentUser || await new Promise(resolve => auth.onAuthStateChanged(resolve));
      if (!user) return;
      
      // Check mentor status and show/hide mentor link
      db.collection('users').doc(user.uid).get().then((doc) => {
        const mentorNavLink = document.getElementById('mentorNavLink');
        if (mentorNavLink) {
          const isMentor = doc.exists && doc.data().isMentor === true;
          mentorNavLink.style.display = isMentor ? 'block' : 'none';
        }
      }).catch((error) => {
        console.error('Error checking mentor status:', error);
      });
      
  const userDoc = await db.collection('users').doc(user.uid).get();
  const userData = userDoc.data();
mentorComps = Array.isArray(userData.mentorCompetition)
    ? userData.mentorCompetition
    : [userData.mentorCompetition].filter(Boolean);

      // Find mentees
  const usersSnap = await db.collection('users').get();
  mentees = [];
  usersSnap.forEach(doc => {
    if (doc.id === user.uid) return;
    const d = doc.data();
    let comps = Array.isArray(d.competitions) ? d.competitions : [d.competitions].filter(Boolean);
    if (comps.some(c => mentorComps.includes(c))) {
      mentees.push({
        id: doc.id,
        name: d.name || d.fullName || d.email || '(unnamed)',
        grade: d.grade || '',
        comps: comps.filter(Boolean)
      });
    }
  });

      // Populate competition filter
      const compFilter = document.getElementById('competitionFilter');
  if (compFilter) {
        compFilter.innerHTML = '<option>Competition: All</option>';
    mentorComps.forEach(c => {
      if (!c) return;
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      compFilter.appendChild(opt);
    });
      }

      // Calculate stats
      let totalAccuracy = 0;
      let totalProgress = 0;
      let accuracyCount = 0;
      let progressCount = 0;

      allData = {};
window.menteeIdNameMap = {};
  window.globalMenteeData = {};

  for (let mentee of mentees) {
        window.menteeIdNameMap[mentee.id] = mentee.name;
        
        const qs = await db.collection('assignments')
      .where('to', '==', mentee.id)
          .where('type', 'in', ['written', 'quiz'])
      .where('status', '==', 'complete')
      .get();
    
    let accuracyArr = [];
    let rawAssignments = [];
    
    qs.forEach(doc => {
          const d = doc.data();
      rawAssignments.push({
        ...d,
        id: doc.id,
        createdAt: d.createdAt
      });
      
      if (typeof d.score === "number" && typeof d.maxScore === "number" && d.maxScore > 0) {
            const accuracy = Math.round((d.score / d.maxScore) * 100);
            accuracyArr.push(accuracy);
            totalAccuracy += accuracy;
            accuracyCount++;
          }
        });
        
        allData[mentee.name] = accuracyArr;
    window.globalMenteeData[mentee.id] = {
      name: mentee.name,
      assignments: rawAssignments
    };
    
        // Calculate progress (simplified - can be enhanced)
        if (accuracyArr.length > 0) {
          const avgAcc = accuracyArr.reduce((a, b) => a + b, 0) / accuracyArr.length;
          totalProgress += avgAcc;
          progressCount++;
        }
      }

      // Update stats
      document.getElementById('totalMentees').textContent = mentees.length;
      document.getElementById('avgAccuracy').textContent = accuracyCount > 0 
        ? Math.round(totalAccuracy / accuracyCount) + '%' 
        : '0%';
      document.getElementById('avgProgress').textContent = progressCount > 0 
        ? Math.round(totalProgress / progressCount) + '%' 
        : '0%';

      // Render mentee cards
      renderMenteeCards();
      
      // Setup notifications
      setupNotifications();
      
      // Setup recent activity listener
      if (mentees.length > 0) {
        setupRecentActivityListener(mentees.map(m => m.id));
      }
    });

    function renderMenteeCards() {
      const grid = document.getElementById('menteesGrid');
      if (!grid) return;
      
      grid.innerHTML = '';
      
      mentees.forEach(mentee => {
        const accuracyArr = allData[mentee.name] || [];
        const avgAccuracy = accuracyArr.length > 0
          ? Math.round(accuracyArr.reduce((a, b) => a + b, 0) / accuracyArr.length)
          : 0;
        const progress = avgAccuracy; // Simplified
        
        const card = document.createElement('div');
        card.className = 'mentee-card';
        card.onclick = () => showMenteeDetail(mentee);
        card.innerHTML = `
          <div class="mentee-card-header">
            <h4 class="mentee-card-name">${mentee.name}</h4>
            <span class="mentee-card-id">ID: ${mentee.id.substring(0, 8)}</span>
          </div>
          <div class="mentee-card-stats">
            <div class="mentee-stat">
              <p class="mentee-stat-label">Accuracy</p>
              <div class="mentee-progress-bar">
                <div class="mentee-progress-fill" style="width: ${avgAccuracy}%"></div>
              </div>
              <p class="mentee-stat-value">${avgAccuracy}%</p>
            </div>
            <div class="mentee-stat">
              <p class="mentee-stat-label">Progress</p>
              <div class="mentee-progress-bar">
                <div class="mentee-progress-fill" style="width: ${progress}%"></div>
              </div>
              <p class="mentee-stat-value">${progress}%</p>
            </div>
          </div>
          <button class="mentee-view-btn">View Details ‚Üí</button>
        `;
        grid.appendChild(card);
      });
    }

    function updateMenteeChart(mentee) {
      const accuracyArr = allData[mentee.name] || [];
const canvas = document.getElementById('mcqChart');
      if (!canvas) return;
      
      if (mcqChartObj) {
        mcqChartObj.destroy();
      }
      
      // Use question range to slice data
      const startIndex = questionRange - 1;
      const endIndex = Math.min(startIndex + 50, accuracyArr.length);
      const slicedData = accuracyArr.slice(startIndex, endIndex);
      
      const labels = slicedData.map((_, i) => questionRange + i);
      const data = slicedData.map(v => v / 100);
      
      // Update range input
      const input = document.getElementById('questionRangeInput');
      if (input) {
        input.value = `Questions ${questionRange}-${Math.min(questionRange + slicedData.length - 1, accuracyArr.length)}`;
      }
      
      mcqChartObj = new Chart(canvas, {
  type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Accuracy',
            data: data,
            borderColor: '#f97316',
            backgroundColor: 'rgba(249, 115, 22, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4,
            pointRadius: 0
          }]
        },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
              display: false
      }
    },
    scales: {
      x: {
        title: {
          display: true,
          text: 'Question Numbers',
                color: '#94a3b8'
        },
              grid: {
                color: '#334155'
              },
        ticks: { 
                color: '#94a3b8'
        }
      },
      y: {
        title: {
          display: true,
          text: 'Accuracy (%)',
                color: '#94a3b8'
        },
              min: 0,
              max: 1,
        ticks: {
                callback: function(value) {
                  return Math.round(value * 100) + '%';
                },
                color: '#94a3b8'
        },
              grid: {
                color: '#334155'
              }
            }
          }
        }
      });
    }

    function shiftQuestionRange(amount) {
      if (!selectedMentee) return;
      const accuracyArr = allData[selectedMentee.name] || [];
      const maxQuestions = accuracyArr.length;
      
      questionRange += amount;
      if (questionRange < 1) questionRange = 1;
      if (questionRange > maxQuestions) questionRange = Math.max(1, maxQuestions - 49);
  
      updateMenteeChart(selectedMentee);
    }

    function jumpToQuestionRange() {
      if (!selectedMentee) return;
      const select = document.getElementById('jumpSelect');
      const value = select.value;
      if (value === '1-50') {
        questionRange = 1;
      } else if (value === '51-100') {
        questionRange = 51;
      }
      updateMenteeChart(selectedMentee);
    }

    function setupRecentActivityListener(menteeIdsArray) {
      const db = firebase.firestore();
      const batchSize = 10;
      const allActivities = [];
      let batchesDone = 0;
      let batches = [];
      
      for (let i = 0; i < menteeIdsArray.length; i += batchSize) {
        batches.push(menteeIdsArray.slice(i, i + batchSize));
      }

      function renderAllActivities() {
        const merged = allActivities
          .sort((a, b) => {
            const adate = a.completedAt?.toDate?.() || a.createdAt?.toDate?.() || new Date(0);
            const bdate = b.completedAt?.toDate?.() || b.createdAt?.toDate?.() || new Date(0);
            return bdate - adate;
          })
          .slice(0, 10);
        
        renderRecentActivity(merged);
      }

      batches.forEach((idBatch, idx) => {
        db.collection('assignments')
          .where('to', 'in', idBatch)
          .where('status', '==', 'complete')
          .orderBy('completedAt', 'desc')
          .limit(10)
          .onSnapshot(snapshot => {
            allActivities.splice(
              idx * batchSize,
              batchSize,
              ...snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }))
            );
            batchesDone++;
            if (batchesDone === batches.length) {
              renderAllActivities();
            }
  });
});
    }

    function renderRecentActivity(assignments) {
      const container = document.getElementById('recentActivityList');
      if (!container) return;
      
      container.innerHTML = '';
      
      if (assignments.length === 0) {
        container.innerHTML = '<div class="activity-empty">No recent activity.</div>';
        return;
      }
      
      assignments.forEach(a => {
        const dateObj = a.completedAt?.toDate?.() || a.createdAt?.toDate?.() || new Date();
        const now = new Date();
        const diffMs = now - dateObj;
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        let timeText = 'Just now';
        if (diffHours < 1) timeText = 'Just now';
        else if (diffHours < 24) timeText = `${diffHours} hours ago`;
        else timeText = `${diffDays} days ago`;

        const name = window.menteeIdNameMap?.[a.to] || 'Student';
        const title = a.title || (a.type ? a.type.charAt(0).toUpperCase() + a.type.slice(1) + " Assignment" : "Assignment");
        const scoreStr = (typeof a.score === 'number' && typeof a.maxScore === 'number')
          ? `${Math.round((a.score / a.maxScore) * 100)}%`
          : '‚Äî';
        
        const item = document.createElement('div');
        item.className = 'activity-item';
        item.innerHTML = `
          <div>
            <p class="activity-title">${name} ‚Ä¢ ${title}</p>
            <p class="activity-details">${scoreStr} accuracy</p>
          </div>
          <span class="activity-time">${timeText}</span>
        `;
        container.appendChild(item);
      });
    }

    // Assignment Pipeline Functions
    let quizQuestions = [];
    let currentQuestionIndex = 0;
    let quizAnswers = {};
    let quizTimer = null;
    let quizTimeRemaining = 0;

    function openFullAssignmentModal(assignment) {
      // Set the modal title
      document.getElementById('cq-assignment-title').innerText = assignment.title || "New Assignment";
      
      // Show info section, hide quiz section
      document.getElementById('cq-assignment-info').style.display = 'block';
      document.getElementById('cq-assignment-quiz').style.display = 'none';
      
      // Fill in all assignment details
      const fieldsElement = document.getElementById('cq-assignment-fields');
      if (fieldsElement) {
          if (assignment.type === "speaking" || assignment.type === "case") {
              // Speaking/Case assignment format
              const q1 = assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided";
              const q2 = assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided";
              
              fieldsElement.innerHTML = `
                  <div><b>Type:</b> ${assignment.type === "speaking" ? "Speaking" : "Case"} Assignment</div>
                  <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
                  <div><b>Description:</b> ${assignment.description || 'n/a'}</div>
                  <div><b>Questions:</b></div>
                  <ul>
                      <li>${q1}</li>
                      <li>${q2}</li>
                  </ul>
              `;
          } else {
              // Regular assignment format
              fieldsElement.innerHTML = `
                  <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
                  <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
                  <div><b>Questions:</b><br> <span style="font-weight:400; color:#374151">${assignment.questions || 'n/a'}</span></div>
                  <div><b>Difficulty:</b> ${assignment.difficulty || 'n/a'}</div>
                  <div><b>Simulate:</b> ${assignment.simulate ? "Yes" : "No"}</div>
              `;
          }

          if (assignment.trainingPDFs && assignment.trainingPDFs.length > 0) {
              assignment.trainingPDFs.forEach(pdf => {
                  const pdfBox = document.createElement('div');
                  pdfBox.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; font-weight: 500;';
                  pdfBox.textContent = pdf.name || 'Training Document';
                  pdfBox.onclick = () => downloadPDF(pdf);
                  fieldsElement.appendChild(pdfBox);
              });
          }
      }
      
      // Show the modal
      document.getElementById('cq-assignment-modal').style.display = 'block';
    }
    window.openFullAssignmentModal = openFullAssignmentModal;

    function closeAssignmentModal() {
      document.getElementById('cq-assignment-modal').style.display = 'none';
    }
    window.closeAssignmentModal = closeAssignmentModal;

    async function acceptAssignmentNow() {
      console.log("üöÄ acceptAssignmentNow() called");
      showLoader();

      const assignment = window.currentAssignment;
      console.log("üìã Current assignment:", assignment);

      if (!assignment) {
        console.error("‚ùå No current assignment found");
        hideLoader();
        return;
      }

      if (window.latestAssignmentId) {
        console.log("‚úÖ Marking assignment as seen");

        const updateData = {
          status: "seen",
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (assignment.type === 'written') {
          updateData.score = 0;
          updateData.maxScore = assignment.writtenQuestions?.length || 10;
        }

        try {
          await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
          console.log("‚úÖ Assignment marked as seen successfully");
        } catch (error) {
          console.error("‚ùå Error marking assignment as seen:", error);
        }
      }

      // Handle assignment types
      if (assignment.type === 'case') {
        console.log("üìã Opening case study modal for case assignment");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        hideLoader();
        
        // Store assignment questions globally for the case study modal
        window.currentAssignmentQuestions = {
          q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
          q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
          title: assignment.title || "Case Study",
          description: assignment.description || assignment.caseStudyContent || ""
        };
        
        if (typeof openCaseStudyModal === 'function') {
          openCaseStudyModal(assignment);
        } else {
          console.error("openCaseStudyModal function not found");
        }
        return;
      }
      
      if (assignment.type === 'speaking') {
        console.log("üé§ Opening speaking modal for speaking assignment");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        hideLoader();
        
        // Store assignment questions globally for the speaking modal
        window.currentAssignmentQuestions = {
          q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
          q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
          title: assignment.title || "Speaking Assignment",
          description: assignment.description || ""
        };
        
        if (typeof openSpeakingAssignmentModal === 'function') {
          openSpeakingAssignmentModal(assignment);
        } else {
          console.error("openSpeakingAssignmentModal function not found");
        }
        return;
      }

      if (assignment.type === 'written') {
        console.log("‚úçÔ∏è Opening written assignment (with GPT if needed)");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        if (typeof openWrittenPracticeModal === 'function') {
          await openWrittenPracticeModal(assignment);
        } else {
          console.error("openWrittenPracticeModal function not found");
          alert("Error: Written assignment handler not available");
        }
        return;
      }

      // Handle quiz assignments
      if (assignment.type === 'quiz') {
        console.log("üìù Quiz assignment - opening quiz modal");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        hideLoader();
        // Quiz assignments are handled in the assignment modal itself
        return;
      }

      // Unknown assignment type
      console.error("‚ùå Unknown assignment type:", assignment.type);
      hideLoader();
      alert(`Assignment type "${assignment.type || 'unknown'}" is not yet implemented. Please contact support.`);
    }
    window.acceptAssignmentNow = acceptAssignmentNow;

    function snoozeAssignment() {
      closeAssignmentModal();
    }
    window.snoozeAssignment = snoozeAssignment;

    async function openWrittenPracticeModal(assignment) {
      console.log("Opening written practice modal with assignment:", assignment);

      try {
        showLoader();
        startCircularProgress();
        
        currentQuestionIndex = 0;
        quizAnswers = {};

        const timeInMinutes = parseInt(assignment.time) || 15;
        quizTimeRemaining = timeInMinutes * 60;

        // Check if assignment has preloaded questions
        if (assignment.writtenQuestions && assignment.writtenQuestions.length > 0) {
          console.log("‚úÖ Using assignment's preloaded questions");
          quizQuestions = assignment.writtenQuestions;
        } else if (assignment.questions && Array.isArray(assignment.questions) && assignment.questions.length > 0) {
          console.log("‚úÖ Using assignment.questions");
          quizQuestions = assignment.questions;
        } else {
          // Generate new questions via GPT
          console.log("‚ö° No preloaded questions, generating via GPT...");
          const generatedQuestions = await generatePersonalizedQuestionsWithGPT({
            time: assignment.time || "15 mins",
            difficulty: assignment.difficulty || "Medium",
            competencies: assignment.competencies || ["General"],
            type: "written"
          });
          quizQuestions = generatedQuestions;
          assignment.writtenQuestions = generatedQuestions;
        }

        console.log("‚úÖ Questions ready:", quizQuestions);

        hideLoader();
        completeCircularProgress();
        
        // Show modal and create stars
        openQuizModal();

      } catch (err) {
        console.error("‚ùå Error in openWrittenPracticeModal:", err);
        hideLoader();
        alert("Could not load written practice. Please try again.");
      }
    }
    window.openWrittenPracticeModal = openWrittenPracticeModal;

    function getQuestionCount(timeStr) {
      if (!timeStr) return 5;
      const normalized = timeStr.toString().toLowerCase();
      if (normalized.includes("15")) return 10;
      if (normalized.includes("10")) return 7;
      if (normalized.includes("5")) return 5;
      return 5;
    }

    async function generatePersonalizedQuestionsWithGPT(formData) {
      const questionCount = getQuestionCount(formData.time);
      const competenciesText = formData.competencies.join(', ');

      let prompt = `Generate ${questionCount} FBLA-style multiple choice questions.
- Difficulty: ${formData.difficulty}
- Competencies to cover: ${competenciesText}
- Each question must have exactly 4 options and 1 correct answer
- Questions must be standalone, realistic for FBLA, and never reference "the document", "the text", "as stated", etc.
- Use business, finance, marketing, management, economics, law, and related topics depending on the competencies.`

      prompt += `\n\nReturn ONLY valid JSON array in format:
[
  {
    "text": "Question text?",
    "competency": "Marketing",
    "correctAnswer": "Correct option text",
    "options": ["A", "B", "C", "D"],
    "difficulty": "${formData.difficulty}",
    "source": "gpt_generated"
  }
]`;

      try {
        const response = await firebase.functions().httpsCallable("generateQuestionsWithAI")({
          messages: [
            { role: "system", content: `You are an expert FBLA written-competition exam designer.

Your role is to generate ORIGINAL, competition-accurate FBLA-style multiple-choice questions that match the structure, rigor, tone, and professional standards of official FBLA written tests.

You must follow ALL rules below.

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
CORE FBLA PHILOSOPHY
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
FBLA written tests assess professional correctness, precision, and applied business literacy.

They do NOT assess creativity, opinion, or open-ended reasoning.

Each question must test exactly ONE concept.

Questions must be concise, objective, and professionally worded.

Avoid unnecessary narrative unless the question type explicitly requires a scenario.

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
APPROVED FBLA QUESTION ARCHETYPES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Every question MUST clearly belong to ONE of the following archetypes:

1. Definition / Term Identification  
   - Identifying the correct term based on a definition  
   - Selecting the correct meaning of a professional word or concept  

2. Classification / Category Recognition  
   - Determining where an item belongs within a professional category system  
   - Examples include document types, account categories, system types, business forms, or classifications  

3. Procedural / Workflow Knowledge  
   - Understanding the stages of a professional workflow specific to the competition area  
   - Identifying where information originates within that workflow  
   - Determining which document, tool, or action is appropriate at a given stage  
   - Recognizing correct sequencing of professional tasks within the domain  

4. Tool-to-Function Matching  
   - Matching software features, commands, utilities, or tools to their correct purpose  
   - Selecting the correct function used to accomplish a professional task  

5. Quantitative / Calculation Application  
   - Performing single-step or limited multi-step calculations  
   - Selecting the correct numeric result based on provided data  
   - Avoid unnecessary complexity or advanced math  

6. Language Precision & Usage  
   - Correct use of professional vocabulary  
   - Distinguishing homophones, word meanings, spelling, grammar, and standard usage  

7. Error Detection / Exception Identification  
   - Identifying what is incorrect, misspelled, or does NOT belong  
   - Using negation ("NOT") carefully and intentionally  

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
QUESTION STRUCTURE RULES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Each question must assess ONE idea only.  
‚Ä¢ Do not combine multiple concepts in one question.  
‚Ä¢ Avoid ambiguous wording.  
‚Ä¢ Use professional, neutral language.

Acceptable stem styles include:
- "Which of the following‚Ä¶"
- "What term best describes‚Ä¶"
- "The document used to‚Ä¶"
- "Which action should be taken‚Ä¶"
- "Which of the following is NOT‚Ä¶"

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ANSWER CHOICE DESIGN (CRITICAL)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Each question MUST include exactly FOUR answer choices.

Answer choices must:
‚Ä¢ Be the same grammatical form  
‚Ä¢ Be similar in length  
‚Ä¢ Belong to the same conceptual family  

Wrong answer choices (distractors) must be plausible and realistic.

Allowed distractor strategies include:
‚Ä¢ Closely related terms within the same category  
‚Ä¢ Common student misconceptions  
‚Ä¢ Incorrect step within a workflow  
‚Ä¢ Reversed or misapplied professional rules  
‚Ä¢ Visually or linguistically similar words  
‚Ä¢ Typical calculation or classification errors  

Never include joke answers or obviously incorrect options.

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
DIFFICULTY CALIBRATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Easy:
‚Ä¢ Direct recall or recognition  
‚Ä¢ Minimal traps  

Medium:
‚Ä¢ Requires discrimination between similar concepts  
‚Ä¢ Includes common misconceptions  

Hard:
‚Ä¢ Includes negation ("NOT")  
‚Ä¢ Requires precise rule awareness  
‚Ä¢ Uses subtle wording differences  
‚Ä¢ Penalizes shallow memorization  

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
CONTENT INTEGRITY RULES
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ All questions must be ORIGINAL.  
‚Ä¢ Do NOT copy real FBLA questions.  
‚Ä¢ Do NOT closely paraphrase known questions.  
‚Ä¢ Use authentic structure only, not replicated wording.

Questions must feel realistic for competitive FBLA written events at the regional, state, or national level.

When study materials are provided, extract concepts, facts, names, dates, laws, and details from them. Present this information as established business knowledge. NEVER mention "the study guide", "the document", "the material", or use phrases like "according to", "as stated in", or "mentioned in".

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
OUTPUT REQUIREMENTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Generate ONLY the requested number of questions.  
‚Ä¢ Each question must have exactly four answer options.  
‚Ä¢ Only ONE option may be correct.  
‚Ä¢ Output valid JSON only.  
‚Ä¢ Do not include explanations, commentary, or headings.  

You are writing as a professional exam author ‚Äî not as a tutor or teacher.` },
            { role: "user", content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt }
          ]
        });

        const data = response.data;
        let content = data.content || data.choices?.[0]?.message?.content || data;
        
        if (typeof content !== 'string') {
          content = JSON.stringify(content);
  }
        
        content = content.trim();
        content = content.replace(/```json|```/g, "");
        const jsonStart = content.indexOf('[');
        const jsonEnd = content.lastIndexOf(']') + 1;
        
        if (jsonStart !== -1 && jsonEnd > jsonStart) {
          content = content.slice(jsonStart, jsonEnd);
        }
        
        const generated = JSON.parse(content);
        console.log(`‚úÖ Generated ${generated.length} GPT questions`);
        return generated;

      } catch (err) {
        console.error("‚ùå GPT error:", err);
        return getFallbackQuestions(questionCount, formData.competencies);
      }
    }

    function getFallbackQuestions(count, competencies) {
      const fallbackQuestions = [
        {
          text: "What is the primary purpose of parliamentary procedure?",
          competency: "Parliamentary Procedure",
          correctAnswer: "To make meetings more efficient",
          options: [
            "To make meetings more efficient",
            "To give the president more power",
            "To eliminate debate",
            "To make meetings longer"
          ]
        },
        {
          text: "Which motion is used to end a meeting?",
          competency: "Parliamentary Procedure",
          correctAnswer: "Adjourn",
          options: ["Adjourn", "Recess", "Postpone", "Table"]
        },
        {
          text: "What is the most effective way to communicate in business?",
          competency: "Business Communication",
          correctAnswer: "Clear and concise messaging",
          options: [
            "Clear and concise messaging",
            "Using complex terminology",
            "Lengthy detailed explanations",
            "Informal casual language"
          ]
        }
      ];
      
      const result = [];
      for (let i = 0; i < count; i++) {
        result.push(fallbackQuestions[i % fallbackQuestions.length]);
      }
      return result;
    }

    function openQuizModal() {
      const modal = document.getElementById('quizModal');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      currentQuestionIndex = 0;
      quizAnswers = {};
      
      createQuizStars();
      loadQuestion();
      startQuizTimer();
    }

    function createQuizStars() {
      const starsContainer = document.getElementById('quizStarsContainer');
      if (!starsContainer) return;
      
      starsContainer.innerHTML = '';
      
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'practice-quiz-star';
        
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.9 + 0.3;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
        star.style.animationDelay = delay + 's';
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
        
        starsContainer.appendChild(star);
      }
    }

    function loadQuestion() {
      if (!quizQuestions || quizQuestions.length === 0) return;
      
      const question = quizQuestions[currentQuestionIndex];
      if (!question) {
        console.error("No question found at index", currentQuestionIndex);
        return;
      }
      
      console.log("Loading question", currentQuestionIndex + 1, ":", question.question || question.text);
      
      const assignment = window.currentAssignment || {};
      const assignmentTitle = assignment.title || 'Written Practice';
      const difficulty = assignment.difficulty || 'Easy';
      document.getElementById('quizTitle').textContent = `${difficulty} ${assignmentTitle}`;
      document.getElementById('quizProgress').textContent = 
        `Question ${currentQuestionIndex + 1} of ${quizQuestions.length}`;
      
      document.getElementById('questionCompetency').textContent = question.competency || 'General';
      const questionTextEl = document.getElementById('questionText');
      questionTextEl.textContent = question.question || question.text;
      questionTextEl.style.color = '#fff';
      
      const optionsContainer = document.getElementById('optionsContainer');
      const previousAnswer = quizAnswers[currentQuestionIndex];
      
      optionsContainer.innerHTML = question.options.map((option, index) => {
        const isSelected = previousAnswer === option;
        return `
          <div class="practice-quiz-option ${isSelected ? 'selected' : ''}" data-option="${option}">
            ${option}
      </div>
    `;
      }).join('');
      
      const options = optionsContainer.querySelectorAll('.practice-quiz-option');
      options.forEach(optionEl => {
        optionEl.addEventListener('click', function() {
          options.forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          quizAnswers[currentQuestionIndex] = this.dataset.option;
          console.log("Answer saved:", currentQuestionIndex, "->", this.dataset.option);
        });
      });

      // Update progress
      const progress = ((currentQuestionIndex + 1) / quizQuestions.length) * 100;
      document.getElementById('progressPercent').textContent = Math.round(progress);
      document.getElementById('progressFill').style.width = progress + '%';
      
      // Update navigation buttons
      document.getElementById('quizPrevBtn').disabled = currentQuestionIndex === 0;
      document.getElementById('quizNextBtn').style.display = currentQuestionIndex === quizQuestions.length - 1 ? 'none' : 'block';
      document.getElementById('quizSubmitBtn').style.display = currentQuestionIndex === quizQuestions.length - 1 ? 'block' : 'none';
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadQuestion();
      }
    }
    window.previousQuestion = previousQuestion;

    function nextQuestion() {
      if (currentQuestionIndex < quizQuestions.length - 1) {
        currentQuestionIndex++;
        loadQuestion();
      }
    }
    window.nextQuestion = nextQuestion;

    function startQuizTimer() {
      const assignment = window.currentAssignment;
      if (!assignment || !assignment.time) return;
      
      const timeMatch = assignment.time.match(/(\d+)/);
      if (!timeMatch) return;
      
      quizTimeRemaining = parseInt(timeMatch[1]) * 60; // Convert to seconds
      
      quizTimer = setInterval(() => {
        quizTimeRemaining--;
        
        const mins = Math.floor(quizTimeRemaining / 60);
        const secs = quizTimeRemaining % 60;
        document.getElementById('quizTimer').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        
        if (quizTimeRemaining <= 0) {
          clearInterval(quizTimer);
          submitQuiz();
        }
      }, 1000);
    }

    async function submitQuiz() {
      if (quizTimer) {
        clearInterval(quizTimer);
      }
      
      let score = 0;
      const competencyStats = {};
      
      quizQuestions.forEach((q, index) => {
        const userAnswer = quizAnswers[index];
        const correctAnswer = q.correctAnswer;
        const isCorrect = userAnswer === correctAnswer;
        
        if (isCorrect) score++;
        
        const comp = q.competency || 'General';
        if (!competencyStats[comp]) {
          competencyStats[comp] = { correct: 0, total: 0 };
        }
        competencyStats[comp].total++;
        if (isCorrect) competencyStats[comp].correct++;
      });
      
      // Save to Firebase
      const user = firebase.auth().currentUser;
      if (user && window.latestAssignmentId) {
        await db.collection('assignments').doc(window.latestAssignmentId).update({
          status: 'complete',
          score: score,
          totalQuestions: quizQuestions.length,
          maxScore: quizQuestions.length,
          competencyStats: competencyStats
        });
      }
      
      // Close both quiz modal and assignment modal
      closeQuizModal();
      closeAssignmentModal();
      
      showCongratsModal({
        score: score,
        totalQuestions: quizQuestions.length,
        competencyStats: competencyStats,
        assignmentName: window.currentAssignment?.title || 'Written Practice'
  });
}
    window.submitQuiz = submitQuiz;

    function closeQuizModal() {
      if (quizTimer) {
        clearInterval(quizTimer);
      }
      document.getElementById('quizModal').style.display = 'none';
      document.body.style.overflow = 'auto';
  }
    window.closeQuizModal = closeQuizModal;

    function showCongratsModal(results) {
      const modal = document.getElementById('congratsModal');
      
      // Check if modal exists
      if (!modal) {
        // Fallback to alert if modal doesn't exist
        alert(results.message || `Congratulations! ${results.assignmentName || 'Assignment'} completed successfully!`);
        return;
      }
      
      // Handle case study assignments
      if (results.assignmentType === 'case') {
        const titleEl = document.getElementById('congratsTitle');
        const scoreEl = document.getElementById('congratsScore');
        const subtitleEl = document.getElementById('congratsSubtitle');
        const assignmentNameEl = document.getElementById('congratsAssignmentName');
        const competenciesContainer = document.getElementById('congratsCompetencies');
        
        if (titleEl) titleEl.textContent = 'Congratulations!';
        if (scoreEl) scoreEl.textContent = '';
        if (subtitleEl) subtitleEl.style.display = 'none'; // Hide the score line
        if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Case Study';
        
        // Display competencies from Firebase
        if (competenciesContainer) {
          if (results.competencies && results.competencies.length > 0) {
            competenciesContainer.innerHTML = results.competencies.map(comp => {
              return `
                <div class="congrats-competency-item">
                  <div class="congrats-competency-header">
                    <span class="congrats-competency-name">${comp}</span>
                  </div>
                </div>
              `;
            }).join('');
          } else {
            competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
          }
        }
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        createCongratsStars();
        return;
      }
      
      // Handle speaking assignments (simple message)
      if (results.assignmentType === 'speaking' || (results.message && !results.score && !results.totalQuestions)) {
        const titleEl = document.getElementById('congratsTitle');
        const scoreEl = document.getElementById('congratsScore');
        const subtitleEl = document.getElementById('congratsSubtitle');
        const assignmentNameEl = document.getElementById('congratsAssignmentName');
        const competenciesContainer = document.getElementById('congratsCompetencies');
        
        if (titleEl) titleEl.textContent = 'Congratulations!';
        if (scoreEl) scoreEl.textContent = '';
        if (subtitleEl) {
          subtitleEl.style.display = 'block';
          subtitleEl.innerHTML = results.message || 'Assignment submitted successfully!';
        }
        if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Assignment';
        
        // Display competencies if available
        if (competenciesContainer) {
          if (results.competencies && results.competencies.length > 0) {
            competenciesContainer.innerHTML = results.competencies.map(comp => {
              return `
                <div class="congrats-competency-item">
                  <div class="congrats-competency-header">
                    <span class="congrats-competency-name">${comp}</span>
                  </div>
                </div>
              `;
            }).join('');
          } else {
            competenciesContainer.innerHTML = '';
          }
        }
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        createCongratsStars();
        return;
      }
      
      // Handle written assignments (with scores)
      const percentage = results.percentage || (results.score && results.totalQuestions ? Math.round((results.score / results.totalQuestions) * 100) : 0);
      
      const titleEl = document.getElementById('congratsTitle');
      const scoreEl = document.getElementById('congratsScore');
      const subtitleEl = document.getElementById('congratsSubtitle');
      const assignmentNameEl = document.getElementById('congratsAssignmentName');
      const competenciesContainer = document.getElementById('congratsCompetencies');
      
      if (titleEl) titleEl.textContent = 'Congratulations!';
      if (scoreEl && results.score !== undefined && results.totalQuestions !== undefined) {
        scoreEl.textContent = `${results.score}/${results.totalQuestions}`;
      }
      if (subtitleEl) {
        subtitleEl.style.display = 'block'; // Reset display for other assignment types
        if (results.score !== undefined && results.totalQuestions !== undefined) {
          subtitleEl.innerHTML = 
            `Excellent work! You scored <span id="congratsScoreSpan" style="background: linear-gradient(to right, #ef4444, #f97316, #eab308); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; font-size: 1.75rem;">${results.score}/${results.totalQuestions}</span>`;
        } else if (results.message) {
          subtitleEl.innerHTML = results.message;
        }
      }
      
      if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Written Practice';
      
      if (competenciesContainer) {
        if (results.competencyStats && Object.keys(results.competencyStats).length > 0) {
          competenciesContainer.innerHTML = Object.entries(results.competencyStats).map(([comp, stats]) => {
            const percentage = Math.round((stats.correct / stats.total) * 100);
            const isFull = stats.correct === stats.total;
            return `
              <div class="congrats-competency-item">
                <div class="congrats-competency-header">
                  <span class="congrats-competency-name">${comp}</span>
                  <span class="congrats-competency-score">${stats.correct}/${stats.total} correct</span>
                </div>
                <div class="congrats-competency-progress-bar">
                  <div class="congrats-competency-progress-fill ${isFull ? 'full' : ''}" style="width: ${percentage}%"></div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
        }
      }
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      createCongratsStars();
    }
    window.showCongratsModal = showCongratsModal;

    function createCongratsStars() {
      const starsContainer = document.getElementById('congratsStarsContainer');
      if (!starsContainer) return;
      
      starsContainer.innerHTML = '';
      
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'practice-quiz-star';
        
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.9 + 0.3;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
        star.style.animationDelay = delay + 's';
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
        
        starsContainer.appendChild(star);
      }
    }

    function closeCongratsModal() {
      const modal = document.getElementById('congratsModal');
      if (modal) {
        modal.style.display = 'none';
      }
      document.body.style.overflow = 'auto';

      // Ensure assignment modal is also closed
      closeAssignmentModal();
    }
    window.closeCongratsModal = closeCongratsModal;

    function showLoader() {
      document.getElementById('assignmentLoader').style.display = 'flex';
    }
    window.showLoader = showLoader;

    function hideLoader() {
      document.getElementById('assignmentLoader').style.display = 'none';
    }
    window.hideLoader = hideLoader;

    function updateCircularProgress(percent) {
      const fill = document.getElementById('circularProgressFill');
      const text = document.getElementById('circularProgressText');
      if (fill) {
        const circumference = 2 * Math.PI * 45;
        const offset = circumference - (percent / 100) * circumference;
        fill.style.strokeDashoffset = offset;
      }
      if (text) {
        text.textContent = Math.round(percent) + '%';
      }
    }

    function startCircularProgress() {
      let progress = 0;
      const interval = setInterval(() => {
        progress += 2;
        if (progress > 90) {
          clearInterval(interval);
        }
        updateCircularProgress(progress);
      }, 100);
    }

    function completeCircularProgress() {
      updateCircularProgress(100);
      setTimeout(() => {
        hideLoader();
      }, 500);
    }

    function renderQuiz(questionsArr) {
      quizQuestions = questionsArr;
      currentQuestionIndex = 0;
      quizAnswers = {};
      loadQuestion();
      }
    window.renderQuiz = renderQuiz;

    // ========== SPEAKING AND CASE STUDY RECORDING VARIABLES ==========
    let cqSpeakingMediaRecorder = null;
    let cqSpeakingMediaStream = null;
    let cqSpeakingRecordedChunks = [];
    let isRecording = false;
    let isIntentionallyStopping = false;
    let recordingStateMonitor = null;
    
    // Case Study variables
    let cqCaseStudyIsRecording = false;
    let cqCaseStudyIsIntentionallyStopping = false;
    let cqCaseStudyRecordingStateMonitor = null;
    let cqCaseStudyMediaRecorder = null;
    let cqCaseStudyMediaStream = null;
    let cqCaseStudyRecordedChunks = [];
    let cqCaseStudyTimerInterval = null;
    let cqCaseStudyTimeLeft = 1200; // 20 minutes in seconds
    let cqCaseStudyTimerActive = false;

    // Helper function to convert blob to base64
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function cqCaseStudyBlobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // Complete Speaking Assignment Submission Function
    async function submitSpeakingResponse() {
      if (!window.latestAssignmentId || cqSpeakingRecordedChunks.length === 0) {
        alert("Recording not found or assignment ID missing.");
        return;
      }

      const submitBtn = document.getElementById('cq-speaking-submitBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      const blob = new Blob(cqSpeakingRecordedChunks, { type: 'video/webm' });
      const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

      const GITHUB_USERNAME = "Anjay209";
      const GITHUB_REPO = "video-storage";
      const GITHUB_TOKEN = "REDACTED_TOKEN";

      let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
      let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

      try {
        const base64 = await blobToBase64(blob);

        const uploadRes = await fetch(githubApiUrl, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Upload ${filename}`,
            content: base64,
            branch: 'main'
          })
        });

        if (!uploadRes.ok) {
          const errData = await uploadRes.json().catch(() => ({}));
          const errorMessage = errData?.message || "GitHub upload failed";
          
          if (uploadRes.status === 409) {
            console.log("File exists, attempting to update with SHA...");
            try {
              const getRes = await fetch(githubApiUrl, {
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (getRes.ok) {
                const existingFile = await getRes.json();
                const updateRes = await fetch(githubApiUrl, {
                  method: 'PUT',
                  headers: {
                    Authorization: `Bearer ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    message: `Update ${filename}`,
                    content: base64,
                    branch: 'main',
                    sha: existingFile.sha
                  })
                });
                
                if (!updateRes.ok) {
                  throw new Error("Failed to update existing file: " + (await updateRes.json().catch(() => ({}))).message);
                }
                console.log("Successfully updated existing file");
              } else {
                throw new Error("Could not get existing file info: " + errorMessage);
              }
            } catch (updateError) {
              console.log("Update failed, using unique filename...");
              const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
              const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
              const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
              
              const retryRes = await fetch(uniqueGithubApiUrl, {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Upload ${uniqueFilename}`,
                  content: base64,
                  branch: 'main'
                })
              });
              
              if (!retryRes.ok) {
                throw new Error("Failed to upload with unique filename: " + (await retryRes.json().catch(() => ({}))).message);
              }
              
              githubPagesUrl = uniqueGithubPagesUrl;
              console.log("Successfully uploaded with unique filename");
            }
          } else {
            throw new Error(errorMessage);
          }
        }

        // Firestore update
        await firebase.firestore()
          .collection('assignments')
          .doc(window.latestAssignmentId)
          .update({
            status: "complete",
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            recordingUrl: githubPagesUrl
          });

        // Update user's assignments collection
        const user = firebase.auth().currentUser;
        const userId = user?.uid;
        const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
        
        if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
          try {
            await firebase.firestore()
              .collection('users')
              .doc(userId)
              .collection('assignments')
              .doc(assignmentId)
              .set({
                status: 'completed',
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                fileUrl: githubPagesUrl,
                fileType: 'video',
              }, { merge: true });
          } catch (userAssignError) {
            console.warn("Could not update user assignments collection (non-critical):", userAssignError);
          }
        }

        // Fetch assignment data to get competencies
        let competencies = [];
        let assignmentName = 'Speaking Assessment';
        try {
          const assignmentDoc = await firebase.firestore()
            .collection('assignments')
            .doc(window.latestAssignmentId)
            .get();
          
          if (assignmentDoc.exists) {
            const assignmentData = assignmentDoc.data();
            competencies = assignmentData.competencies || [];
            assignmentName = assignmentData.title || 'Speaking Assessment';
          }
        } catch (error) {
          console.error("Error fetching assignment data:", error);
        }

        // Show success message and congrats modal
        showCongratsModal({ 
          score: undefined, 
          totalQuestions: undefined,
          assignmentName: assignmentName,
          competencies: competencies,
          assignmentType: 'speaking'
        });
        
        // Close modal
        closeSpeakingAssignmentModal();

      } catch (err) {
        console.error("Upload Error:", err);
        alert("Upload Error: " + err.message);
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Assessment';
        }
      }
    }
    window.submitSpeakingResponse = submitSpeakingResponse;

    // Complete Case Study Assignment Submission Function
    async function submitCaseStudyResponse() {
      if (!window.latestAssignmentId || cqCaseStudyRecordedChunks.length === 0) {
        alert("Recording not found or assignment ID missing.");
        return;
      }

      const submitBtn = document.getElementById('cq-case-study-submitBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      const blob = new Blob(cqCaseStudyRecordedChunks, { type: 'video/webm' });
      const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

      const GITHUB_USERNAME = "Anjay209";
      const GITHUB_REPO = "video-storage";
      const GITHUB_TOKEN = "REDACTED_TOKEN";

      let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
      let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

      try {
        const base64 = await cqCaseStudyBlobToBase64(blob);

        const uploadRes = await fetch(githubApiUrl, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Upload ${filename}`,
            content: base64,
            branch: 'main'
          })
        });

        if (!uploadRes.ok) {
          const errData = await uploadRes.json().catch(() => ({}));
          const errorMessage = errData?.message || "GitHub upload failed";
          
          if (uploadRes.status === 409) {
            console.log("File exists, attempting to update with SHA...");
            try {
              const getRes = await fetch(githubApiUrl, {
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (getRes.ok) {
                const existingFile = await getRes.json();
                const updateRes = await fetch(githubApiUrl, {
                  method: 'PUT',
                  headers: {
                    Authorization: `Bearer ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    message: `Update ${filename}`,
                    content: base64,
                    branch: 'main',
                    sha: existingFile.sha
                  })
                });
                
                if (!updateRes.ok) {
                  throw new Error("Failed to update existing file: " + (await updateRes.json().catch(() => ({}))).message);
                }
                console.log("Successfully updated existing file");
              } else {
                throw new Error("Could not get existing file info: " + errorMessage);
              }
            } catch (updateError) {
              console.log("Update failed, using unique filename...");
              const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
              const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
              const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
              
              const retryRes = await fetch(uniqueGithubApiUrl, {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Upload ${uniqueFilename}`,
                  content: base64,
                  branch: 'main'
                })
              });
              
              if (!retryRes.ok) {
                throw new Error("Failed to upload with unique filename: " + (await retryRes.json().catch(() => ({}))).message);
              }
              
              githubPagesUrl = uniqueGithubPagesUrl;
              console.log("Successfully uploaded with unique filename");
            }
          } else {
            throw new Error(errorMessage);
          }
        }

        // Firestore update
        await firebase.firestore()
          .collection('assignments')
          .doc(window.latestAssignmentId)
          .update({
            status: "complete",
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            recordingUrl: githubPagesUrl
          });

        // Update user's assignments collection
        const user = firebase.auth().currentUser;
        const userId = user?.uid;
        const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
        
        if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
          try {
            await firebase.firestore()
              .collection('users')
              .doc(userId)
              .collection('assignments')
              .doc(assignmentId)
              .set({
                status: "complete",
                completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                recordingUrl: githubPagesUrl
              }, { merge: true });
          } catch (userUpdateError) {
            console.error("Error updating user assignments:", userUpdateError);
          }
        }

        // Fetch assignment data to get competencies
        let competencies = [];
        let assignmentName = 'Case Study';
        try {
          const assignmentDoc = await firebase.firestore()
            .collection('assignments')
            .doc(window.latestAssignmentId)
            .get();
          
          if (assignmentDoc.exists) {
            const assignmentData = assignmentDoc.data();
            competencies = assignmentData.competencies || [];
            assignmentName = assignmentData.title || 'Case Study';
          }
        } catch (error) {
          console.error("Error fetching assignment data:", error);
        }

        // Show success message and congrats modal
        showCongratsModal({ 
          score: undefined, 
          totalQuestions: undefined,
          assignmentName: assignmentName,
          competencies: competencies,
          assignmentType: 'case'
        });
        
        // Close modal
        closeCaseStudyModal();
      } catch (error) {
        console.error("Upload Error:", error);
        alert("Upload Error: " + error.message);
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Case Study';
        }
      }
    }
    window.submitCaseStudyResponse = submitCaseStudyResponse;

    // ========== SPEAKING MODAL FUNCTIONS ==========
    function openSpeakingAssignmentModal(assignment) {
      if (assignment) {
        if (assignment.id) {
          window.latestAssignmentId = assignment.id;
        }
        window.currentAssignment = assignment;
      }
      
      document.getElementById('cq-speaking-title').textContent = "Speaking Assessment";
      
      if (window.currentAssignmentQuestions) {
        document.getElementById('cq-speaking-q1').textContent = window.currentAssignmentQuestions.q1;
        document.getElementById('cq-speaking-q2').textContent = window.currentAssignmentQuestions.q2;
      } else if (assignment && assignment.questions) {
        document.getElementById('cq-speaking-q1').textContent = assignment.questions[0] || "No question provided";
        document.getElementById('cq-speaking-q2').textContent = assignment.questions[1] || "No question provided";
      }
      
      const starsContainer = document.getElementById('cq-speaking-stars');
      if (starsContainer) {
        starsContainer.innerHTML = '';
        for (let i = 0; i < 150; i++) {
          const star = document.createElement('div');
          star.className = 'cq-speaking-star';
          star.style.top = Math.random() * 100 + '%';
          star.style.left = Math.random() * 100 + '%';
          const size = Math.random() * 2 + 0.5;
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          star.style.opacity = Math.random() * 0.7 + 0.3;
          star.style.animationDuration = (Math.random() * 3 + 2) + 's';
          starsContainer.appendChild(star);
        }
      }
      
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      const modal = document.getElementById('cq-speaking-modal');
      if (modal) {
        modal.style.display = 'flex';
      }
      
      setTimeout(() => {
        initializeVideoPreview();
      }, 100);
    }
    window.openSpeakingAssignmentModal = openSpeakingAssignmentModal;

    async function initializeVideoPreview() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: {
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            frameRate: { min: 15, ideal: 30, max: 60 }
          }, 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });
        
        const videoElement = document.getElementById('cq-speaking-videoPreview');
        const noVideoView = document.getElementById('cq-speaking-noVideoView');
        
        if (videoElement) {
          videoElement.srcObject = stream;
          videoElement.muted = true;
          videoElement.autoplay = true;
          videoElement.playsInline = true;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
          
          cqSpeakingMediaStream = stream;
          setupRecordingFromStream(stream);
          
          videoElement.addEventListener('loadedmetadata', () => {
            videoElement.play().catch(e => {
              console.error("Error playing video preview:", e);
            });
          });
        }
      } catch (error) {
        console.error('Error initializing video preview:', error);
        const noVideoView = document.getElementById('cq-speaking-noVideoView');
        if (noVideoView) {
          noVideoView.style.display = 'flex';
        }
      }
    }

    function setupRecordingFromStream(stream) {
      const videoElement = document.getElementById('cq-speaking-videoPreview');
      const noVideoView = document.getElementById('cq-speaking-noVideoView');
      if (!videoElement) {
        console.error("Video preview element not found in DOM");
        return;
      }
      
      videoElement.srcObject = stream;
      videoElement.muted = true;
      videoElement.autoplay = true;
      videoElement.playsInline = true;
      videoElement.style.display = 'block';
      if (noVideoView) noVideoView.style.display = 'none';
      
      videoElement.addEventListener('loadedmetadata', () => {
        videoElement.play().catch(e => {
          console.error("Error playing video preview:", e);
        });
      });
      
      let options = {};
      if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
        options.mimeType = 'video/webm;codecs=vp9';
      } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
        options.mimeType = 'video/webm;codecs=vp8';
      } else if (MediaRecorder.isTypeSupported('video/webm')) {
        options.mimeType = 'video/webm';
      } else if (MediaRecorder.isTypeSupported('video/mp4')) {
        options.mimeType = 'video/mp4';
      }
      
      cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
      
      cqSpeakingMediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) {
          cqSpeakingRecordedChunks.push(event.data);
        }
      };
      
      cqSpeakingMediaRecorder.onstop = () => {
        if (recordingStateMonitor) {
          clearInterval(recordingStateMonitor);
          recordingStateMonitor = null;
        }
        
        setTimeout(() => {
          if (cqSpeakingRecordedChunks.length === 0) {
            alert("No video data was recorded. Please try recording for at least 1 second.");
            return;
          }
          const mimeType = cqSpeakingMediaRecorder.mimeType || 'video/webm';
          const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });

          const videoURL = URL.createObjectURL(blob);
          const videoElement = document.getElementById('cq-speaking-videoPreview');
          const noVideoView = document.getElementById('cq-speaking-noVideoView');
          if (videoElement) {
            videoElement.srcObject = null;
            videoElement.src = videoURL;
            videoElement.controls = true;
            videoElement.muted = false;
            videoElement.style.display = 'block';
            if (noVideoView) noVideoView.style.display = 'none';
          }

          const recordBtn = document.getElementById('cq-speaking-recordBtn');
          if (recordBtn) {
            recordBtn.classList.remove('recording');
          }
          
          const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
          if (recordingIndicator) {
            recordingIndicator.classList.remove('active');
          }

          isRecording = false;
          
          const submitBtn = document.getElementById('cq-speaking-submitBtn');
          if (submitBtn && cqSpeakingRecordedChunks.length > 0) {
            submitBtn.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Assessment';
          }
        }, 1000);
      };
      
      cqSpeakingMediaRecorder.onerror = (event) => {
        console.error("MediaRecorder error:", event.error);
        alert("Recording error: " + (event.error?.message || "Unknown error."));
        isRecording = false;
        
        const recordBtn = document.getElementById('cq-speaking-recordBtn');
        if (recordBtn) {
          recordBtn.classList.remove('recording');
        }
        
        const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
        if (recordingIndicator) {
          recordingIndicator.classList.remove('active');
        }
      };
    }

    function stopRecording() {
      if (!cqSpeakingMediaRecorder || !isRecording) {
        return;
      }
      
      isIntentionallyStopping = true;
      
      if (recordingStateMonitor) {
        clearInterval(recordingStateMonitor);
        recordingStateMonitor = null;
      }
      
      isRecording = false;
      
      if (cqSpeakingMediaRecorder.state === 'recording') {
        try {
          cqSpeakingMediaRecorder.requestData();
          setTimeout(() => {
            try {
              cqSpeakingMediaRecorder.stop();
            const recordBtn = document.getElementById('cq-speaking-recordBtn');
              if (recordBtn) {
                recordBtn.classList.remove('recording');
              }
              
              const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
              if (recordingIndicator) {
                recordingIndicator.classList.remove('active');
              }
            } catch (e) {
              console.error("Error stopping recorder:", e);
            }
          }, 100);
        } catch (e) {
          console.error("Error requesting final data:", e);
        }
      }
    }

    function toggleSpeakingRecording() {
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (!recordBtn) return;
      
      if (isRecording) {
        stopRecording();
      } else {
        if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
          cqSpeakingRecordedChunks = [];
          try {
            isRecording = true;
            recordBtn.classList.add('recording');
            
            const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
            if (recordingIndicator) {
              recordingIndicator.classList.add('active');
            }
            
            cqSpeakingMediaRecorder.start();
          } catch (e) {
            console.error("Error starting recorder:", e);
            alert("Error starting recording: " + e.message);
            isRecording = false;
          }
        } else if (cqSpeakingMediaStream && !cqSpeakingMediaRecorder) {
          setupRecordingFromStream(cqSpeakingMediaStream);
          setTimeout(() => {
            if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
              cqSpeakingRecordedChunks = [];
              try {
                isRecording = true;
                recordBtn.classList.add('recording');
                
                const recordingIndicator2 = document.getElementById('cq-speaking-recordingIndicator');
                if (recordingIndicator2) {
                  recordingIndicator2.classList.add('active');
                }
                
                cqSpeakingMediaRecorder.start();
              } catch (e) {
                console.error("Error starting recorder after setup:", e);
                alert("Error starting recording: " + e.message);
                isRecording = false;
              }
            }
          }, 200);
        } else if (!cqSpeakingMediaStream) {
          initializeVideoPreview();
        } else {
          alert("Recording is already in progress or not ready. Please wait.");
        }
      }
    }
    window.toggleSpeakingRecording = toggleSpeakingRecording;

    function cqSpeakingStopAllMedia() {
      if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state !== 'inactive') {
        try {
          cqSpeakingMediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping recorder:", e);
        }
      }
      
      if (cqSpeakingMediaStream) {
        cqSpeakingMediaStream.getTracks().forEach(track => track.stop());
        cqSpeakingMediaStream = null;
      }
      
      cqSpeakingMediaRecorder = null;
      cqSpeakingRecordedChunks = [];
      isRecording = false;
      
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
    }

    function closeSpeakingAssignmentModal() {
      cqSpeakingStopAllMedia();
      document.getElementById('cq-speaking-modal').style.display = 'none';
    }
    window.closeSpeakingAssignmentModal = closeSpeakingAssignmentModal;

    // ========== CASE STUDY MODAL FUNCTIONS ==========
    function toggleCaseStudyTimer() {
      cqCaseStudyTimerActive = !cqCaseStudyTimerActive;
      const timerEl = document.getElementById('cq-case-study-timer');
      const timerStart = document.getElementById('cq-case-study-timer-start');
      
      if (cqCaseStudyTimerActive) {
        timerEl.classList.add('active');
        if (timerStart) timerStart.style.display = 'none';
        
        cqCaseStudyTimerInterval = setInterval(() => {
          if (cqCaseStudyTimeLeft > 0) {
            cqCaseStudyTimeLeft--;
            const timerText = document.getElementById('cq-case-study-timer-text');
            if (timerText) {
              const mins = Math.floor(cqCaseStudyTimeLeft / 60);
              const secs = cqCaseStudyTimeLeft % 60;
              timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
          } else {
            cqCaseStudyTimerActive = false;
            if (timerEl) timerEl.classList.remove('active');
            if (timerStart) timerStart.style.display = 'inline';
            if (cqCaseStudyTimerInterval) {
              clearInterval(cqCaseStudyTimerInterval);
              cqCaseStudyTimerInterval = null;
            }
            alert('Time is up!');
          }
        }, 1000);
      } else {
        timerEl.classList.remove('active');
        if (timerStart) timerStart.style.display = 'inline';
        if (cqCaseStudyTimerInterval) {
          clearInterval(cqCaseStudyTimerInterval);
          cqCaseStudyTimerInterval = null;
        }
      }
    }
    window.toggleCaseStudyTimer = toggleCaseStudyTimer;

    function expandCaseStudyContent() {
      document.getElementById('cq-case-study-top-info').style.display = 'none';
      document.getElementById('cq-case-study-video-container').style.display = 'none';
      document.getElementById('cq-case-study-bottom-info').style.display = 'none';
      document.getElementById('cq-case-study-controls-wrapper').style.display = 'none';
      document.getElementById('cq-case-study-expanded-content').style.display = 'flex';
    }
    window.expandCaseStudyContent = expandCaseStudyContent;

    function collapseCaseStudyContent() {
      document.getElementById('cq-case-study-top-info').style.display = 'grid';
      document.getElementById('cq-case-study-video-container').style.display = 'block';
      document.getElementById('cq-case-study-bottom-info').style.display = 'grid';
      document.getElementById('cq-case-study-controls-wrapper').style.display = 'flex';
      document.getElementById('cq-case-study-expanded-content').style.display = 'none';
    }
    window.collapseCaseStudyContent = collapseCaseStudyContent;

    function openCaseStudyModal(assignment) {
      if (assignment) {
        if (assignment.id) {
          window.latestAssignmentId = assignment.id;
        }
        window.currentAssignment = assignment;
      }
      
      document.getElementById('cq-case-study-title').textContent = "Case Study";
      
      const caseName = assignment.title || "Case Study";
      document.getElementById('cq-case-study-name').textContent = caseName;
      document.getElementById('cq-case-study-expanded-title').textContent = caseName;
      
      const caseContent = assignment.description || assignment.caseStudyContent || "No case study content provided.";
      const previewText = caseContent.substring(0, 100) + (caseContent.length > 100 ? '...' : '');
      document.getElementById('cq-case-study-content-preview-text').textContent = previewText;
      document.getElementById('cq-case-study-full-content').textContent = caseContent;
      
      if (assignment.questions && assignment.questions.length > 0) {
        document.getElementById('cq-case-study-q1').textContent = assignment.questions[0] || "No question provided";
        if (assignment.questions.length > 1) {
          document.getElementById('cq-case-study-q2').textContent = assignment.questions[1] || "No question provided";
        }
      }
      
      cqCaseStudyTimeLeft = 1200;
      const timerText = document.getElementById('cq-case-study-timer-text');
      if (timerText) {
        const mins = Math.floor(cqCaseStudyTimeLeft / 60);
        const secs = cqCaseStudyTimeLeft % 60;
        timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      }
      cqCaseStudyTimerActive = false;
      const timerEl = document.getElementById('cq-case-study-timer');
      if (timerEl) timerEl.classList.remove('active');
      
      const starsContainer = document.getElementById('cq-case-study-stars');
      if (starsContainer) {
        starsContainer.innerHTML = '';
        for (let i = 0; i < 150; i++) {
          const star = document.createElement('div');
          star.className = 'cq-case-study-star';
          star.style.top = Math.random() * 100 + '%';
          star.style.left = Math.random() * 100 + '%';
          const size = Math.random() * 2 + 0.5;
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          star.style.opacity = Math.random() * 0.7 + 0.3;
          star.style.animationDuration = (Math.random() * 3 + 2) + 's';
          starsContainer.appendChild(star);
        }
      }
      
      const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      collapseCaseStudyContent();
      document.getElementById('cq-case-study-submitBtn').style.display = 'none';
      document.getElementById('cq-case-study-downloadBtn').style.display = 'none';
      
      const modal = document.getElementById('cq-case-study-modal');
      if (modal) {
        modal.style.display = 'flex';
      }
      
      setTimeout(() => {
        cqCaseStudyInitializeVideoPreview();
      }, 100);
    }
    window.openCaseStudyModal = openCaseStudyModal;

    async function cqCaseStudyInitializeVideoPreview() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: {
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            frameRate: { min: 15, ideal: 30, max: 60 }
          }, 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });
        
        const videoElement = document.getElementById('cq-case-study-videoPreview');
        const noVideoView = document.getElementById('cq-case-study-noVideoView');
        
        if (videoElement) {
          videoElement.srcObject = stream;
          videoElement.muted = true;
          videoElement.autoplay = true;
          videoElement.playsInline = true;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
          
          cqCaseStudyMediaStream = stream;
          cqCaseStudySetupRecordingFromStream(stream);
          
          videoElement.addEventListener('loadedmetadata', () => {
            videoElement.play().catch(e => {
              console.error("Error playing video preview:", e);
            });
          });
        }
      } catch (error) {
        console.error('Error initializing video preview:', error);
        const noVideoView = document.getElementById('cq-case-study-noVideoView');
        if (noVideoView) {
          noVideoView.style.display = 'flex';
        }
      }
    }

    function cqCaseStudySetupRecordingFromStream(stream) {
      const videoElement = document.getElementById('cq-case-study-videoPreview');
      if (!videoElement) {
        console.error("Video preview element not found in DOM");
        return;
      }
      
      let options = {};
      if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
        options.mimeType = 'video/webm;codecs=vp9';
      } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
        options.mimeType = 'video/webm;codecs=vp8';
      } else if (MediaRecorder.isTypeSupported('video/webm')) {
        options.mimeType = 'video/webm';
      } else if (MediaRecorder.isTypeSupported('video/mp4')) {
        options.mimeType = 'video/mp4';
      }
      
      cqCaseStudyMediaRecorder = new MediaRecorder(stream, options);
      
      cqCaseStudyMediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          cqCaseStudyRecordedChunks.push(event.data);
        }
      };
      
      cqCaseStudyMediaRecorder.onstop = () => {
        if (cqCaseStudyRecordedChunks.length === 0) {
          alert("No video data was recorded. Please try again.");
          return;
        }
        
        const mimeType = cqCaseStudyMediaRecorder.mimeType || 'video/webm';
        const blob = new Blob(cqCaseStudyRecordedChunks, { type: mimeType });

        const videoURL = URL.createObjectURL(blob);
        const videoElement = document.getElementById('cq-case-study-videoPreview');
        const noVideoView = document.getElementById('cq-case-study-noVideoView');
        if (videoElement) {
          videoElement.srcObject = null;
          videoElement.src = videoURL;
          videoElement.controls = true;
          videoElement.muted = false;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
        }
        
        const submitBtn = document.getElementById('cq-case-study-submitBtn');
        if (submitBtn) {
          submitBtn.style.display = 'block';
        }
      };
      
      cqCaseStudyMediaRecorder.onerror = (event) => {
        console.error("Case Study MediaRecorder error:", event.error);
        alert("Recording error: " + event.error.message);
        cqCaseStudyIsRecording = false;
      };
    }

    function cqCaseStudyStopAllMedia() {
      if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state !== 'inactive') {
        try {
          cqCaseStudyMediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping recorder:", e);
        }
      }
      
      if (cqCaseStudyMediaStream) {
        cqCaseStudyMediaStream.getTracks().forEach(track => track.stop());
        cqCaseStudyMediaStream = null;
      }
      
      cqCaseStudyMediaRecorder = null;
      cqCaseStudyRecordedChunks = [];
      cqCaseStudyIsRecording = false;
      
      const recordBtn = document.getElementById('cq-case-study-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
    }

    function toggleCaseStudyRecording() {
      const recordBtn = document.getElementById('cq-case-study-recordBtn');
      if (!recordBtn) return;
      
      if (cqCaseStudyIsRecording) {
        cqCaseStudyStopRecording();
      } else {
        if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
          cqCaseStudyRecordedChunks = [];
          try {
            cqCaseStudyIsRecording = true;
            recordBtn.classList.add('recording');
            
            const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
            if (recordingIndicator) {
              recordingIndicator.classList.add('active');
            }
            
            cqCaseStudyMediaRecorder.start();
          } catch (e) {
            console.error("Error starting recorder:", e);
            alert("Error starting recording: " + e.message);
            cqCaseStudyIsRecording = false;
          }
        } else if (cqCaseStudyMediaStream && !cqCaseStudyMediaRecorder) {
          cqCaseStudySetupRecordingFromStream(cqCaseStudyMediaStream);
          setTimeout(() => {
            if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
              cqCaseStudyRecordedChunks = [];
              try {
                cqCaseStudyIsRecording = true;
                recordBtn.classList.add('recording');
                
                const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
                if (recordingIndicator) {
                  recordingIndicator.classList.add('active');
                }
                
                cqCaseStudyMediaRecorder.start();
              } catch (e) {
                console.error("Error starting recorder after setup:", e);
                alert("Error starting recording: " + e.message);
                cqCaseStudyIsRecording = false;
              }
            }
          }, 200);
        } else if (!cqCaseStudyMediaStream) {
          cqCaseStudyInitializeVideoPreview();
        } else {
          alert("Recording is already in progress or not ready. Please wait.");
        }
      }
    }
    window.toggleCaseStudyRecording = toggleCaseStudyRecording;

    function cqCaseStudyStopRecording() {
      if (!cqCaseStudyMediaRecorder || !cqCaseStudyIsRecording) {
        return;
      }
      
      cqCaseStudyIsIntentionallyStopping = true;
      cqCaseStudyIsRecording = false;
      
      if (cqCaseStudyMediaRecorder.state === 'recording') {
        try {
          cqCaseStudyMediaRecorder.requestData();
          cqCaseStudyMediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping recorder:", e);
        }
      }
      
      const recordBtn = document.getElementById('cq-case-study-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      cqCaseStudyIsIntentionallyStopping = false;
    }

    function closeCaseStudyModal() {
      if (cqCaseStudyTimerInterval) {
        clearInterval(cqCaseStudyTimerInterval);
        cqCaseStudyTimerInterval = null;
      }
      cqCaseStudyTimerActive = false;
      cqCaseStudyStopAllMedia();
      
      const modal = document.getElementById('cq-case-study-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    window.closeCaseStudyModal = closeCaseStudyModal;
</script>
</body>
</html>
