<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CertQuest Dashboard</title>
  <link rel="stylesheet" href="tools.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  


</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">üåê</div>
    <div class="nav-title">Dashboard <span class="new-badge">(New!)</span></div>
    <div class="nav-right">
      <input type="text" id="navbarSearch" placeholder="Search CertQuest..." />
      <span class="search-icon" id="navbarSearchIcon">üîç</span>
      <div id="searchDropdown"></div>
    </div>
  </div>

  <div class="main-layout">
    <!-- Sidebar -->
      <aside class="sidebar">
      <div class="logo">CQ</div>
      <ul class="nav-icons">
  <li>
     <a href="/Public/home.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3L20 9V21H15V15H9V21H4V9L12 3Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M12 3L4 9V21H9V15H15V21H20V9L12 3Z" stroke="#3b82f6" stroke-width="2" fill="none" stroke-linejoin="round"/>
      <rect x="10" y="17" width="4" height="4" fill="#3b82f6"/>
      <rect x="6" y="11" width="2" height="2" fill="#3b82f6"/>
      <rect x="16" y="11" width="2" height="2" fill="#3b82f6"/>
    </svg>
    
    <span class="nav-label">Home</span>
     </a>
  </li>
  <li>
  <a href="javascript:void(0)" onclick="toggleCommentPanel()">  
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Bell body main fill -->
      <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" fill="#3b82f6" fill-opacity="0.3"/>
      
      <!-- Bell body lighter overlay -->
      <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 12 6 15 6 15H18C18 15 18 12 18 8Z" fill="#3b82f6" fill-opacity="0.2"/>
      
      <!-- Bell outline -->
      <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
      
      <!-- Bell clapper -->
      <circle cx="12" cy="8" r="1" fill="#3b82f6"/>
      
      <!-- Sound waves -->
      <path d="M19 4L20 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
      <path d="M20.5 6.5L22 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
      <path d="M5 4L4 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
      <path d="M3.5 6.5L2 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
      
      <!-- Bottom notification indicator -->
      <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Notifications</span>
  </a>
</li>
  <li>
    <a href="/practice.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="9" fill="#3b82f6" fill-opacity="0.3"/>
      <circle cx="12" cy="12" r="6" fill="#3b82f6" fill-opacity="0.2"/>
      <circle cx="12" cy="12" r="9" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <circle cx="12" cy="12" r="6" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="3" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="1.5" fill="#3b82f6"/>
      <path d="M16 8L12 12L16 8Z" fill="#3b82f6"/>
      <line x1="16" y1="8" x2="19" y2="5" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Practice</span>
    </a>
  </li>
  <li>
    <a href="/Public/Forum/forum.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" fill="#3b82f6" fill-opacity="0.2"/>
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <line x1="11" y1="8" x2="17" y2="8" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="11" y1="10" x2="15" y2="10" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Forum</span>
    </a>
  </li>
  <li>
     <a href="/Public/Calendar/calendar.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="3" y="6" width="18" height="15" rx="2" fill="#3b82f6" fill-opacity="0.3"/>
      <rect x="3" y="6" width="18" height="4" rx="2" fill="#3b82f6" fill-opacity="0.2"/>
      <rect x="3" y="6" width="18" height="15" rx="2" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <line x1="7" y1="3" x2="7" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="17" y1="3" x2="17" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="10" x2="21" y2="10" stroke="#3b82f6" stroke-width="1" opacity="0.5"/>
      <line x1="7.5" y1="10" x2="7.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="12" y1="10" x2="12" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="16.5" y1="10" x2="16.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <circle cx="9" cy="13" r="1" fill="#3b82f6"/>
      <circle cx="15" cy="16" r="1" fill="#3b82f6"/>
      <circle cx="12" cy="18" r="1" fill="#3b82f6"/>
    </svg>
    <span class="nav-label">Calendar</span>
     </a>
  </li>
   <li>
     <a href="/Public/Calendar/calendar.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <!-- Base building blocks with layered opacity -->
  <rect x="2" y="16" width="6" height="6" rx="1" fill="#3b82f6" fill-opacity="0.3"/>
  <rect x="9" y="12" width="6" height="10" rx="1" fill="#3b82f6" fill-opacity="0.3"/>
  <rect x="16" y="8" width="6" height="14" rx="1" fill="#3b82f6" fill-opacity="0.3"/>
  
  <!-- Lighter overlay sections -->
  <rect x="2" y="16" width="6" height="3" rx="1" fill="#3b82f6" fill-opacity="0.2"/>
  <rect x="9" y="12" width="6" height="4" rx="1" fill="#3b82f6" fill-opacity="0.2"/>
  <rect x="16" y="8" width="6" height="5" rx="1" fill="#3b82f6" fill-opacity="0.2"/>
  
  <!-- Block outlines -->
  <rect x="2" y="16" width="6" height="6" rx="1" stroke="#3b82f6" stroke-width="2" fill="none"/>
  <rect x="9" y="12" width="6" height="10" rx="1" stroke="#3b82f6" stroke-width="2" fill="none"/>
  <rect x="16" y="8" width="6" height="14" rx="1" stroke="#3b82f6" stroke-width="2" fill="none"/>
  
  <!-- Building block connection dots -->
  <circle cx="5" cy="19" r="1" fill="#3b82f6"/>
  <circle cx="12" cy="17" r="1" fill="#3b82f6"/>
  <circle cx="19" cy="15" r="1" fill="#3b82f6"/>
  
  <!-- Subtle grid lines for construction feel -->
  <line x1="2" y1="19" x2="8" y2="19" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
  <line x1="9" y1="17" x2="15" y2="17" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
  <line x1="16" y1="15" x2="22" y2="15" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
  
  <!-- Additional detail lines -->
  <line x1="5" y1="16" x2="5" y2="22" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
  <line x1="12" y1="12" x2="12" y2="22" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
  <line x1="19" y1="8" x2="19" y2="22" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
</svg>
    <span class="nav-label">Study Tools</span>
     </a>
  </li>
 
</ul>
    </aside>


     



    <!-- Main Content -->
    <main class="content" style="margin-left: -70px; width: 150vw;">
        <div class="header">
            <h1 class="main-title">What will you design today?</h1>
            
            <div class="tab-container">
                <button class="tab active">Your designs</button>
                <button class="tab">Templates</button>
                <button class="tab">Canva AI</button>
            </div>
            
            <div class="search-container">
                <svg class="search-icon" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                </svg>
                <input type="text" class="search-box" placeholder="Search designs, folders and uploads" id="searchInput">
                <button class="search-btn" onclick="searchTools()" style="display:none;">
                   <button class="plus-btn" onclick="openModal()">
   <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
       <line x1="12" y1="5" x2="12" y2="19"></line>
       <line x1="5" y1="12" x2="19" y2="12"></line>
   </svg>
</button>
                </button>
            </div>
        </div>
 <div class="recent-section" style="margin-left: 70px;">
        <div class="section-header">
            <h2 class="section-title">Recent designs</h2>
            <button class="view-toggle" onclick="toggleView()">
                <svg width="16" height="16" fill="#6c757d" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 8a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 12a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 16a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"/>
                </svg>
            </button>
        </div>
        
        <div class="tools-grid">
            <div class="tool-card" onclick="openTool('art-presentation')">
                <div class="card-image" style="background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="color: #4caf50; font-weight: bold; font-size: 0.9rem;">COLORED PENCILS</div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="card-title">Art</div>
                    <div class="card-meta">
                        <div class="meta-icon" style="background: #ff9800; border-radius: 50%; width: 12px; height: 12px;"></div>
                        <span>Presentation ‚Ä¢ Edited 11 minutes ago</span>
                    </div>
                </div>
            </div>
            
            <div class="tool-card" onclick="openTool('moo-presentation')">
                <div class="card-image" style="background: linear-gradient(135deg, #87ceeb 0%, #4682b4 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                    <div style="color: white; text-align: center; z-index: 2;">
                        <div style="font-size: 1.2rem; margin-bottom: 8px;">üß†</div>
                        <div style="font-size: 0.9rem;">Mind exercises for better focus</div>
                    </div>
                    <div style="position: absolute; top: 20px; left: 20px; width: 40px; height: 40px; background: rgba(255,192,203,0.8); border-radius: 50%;"></div>
                    <div style="position: absolute; bottom: 20px; right: 20px; width: 30px; height: 30px; background: rgba(255,192,203,0.8); border-radius: 50%;"></div>
                </div>
                <div class="card-content">
                    <div class="card-title">moo</div>
                    <div class="card-meta">
                        <div class="meta-icon" style="background: #ff9800; border-radius: 50%; width: 12px; height: 12px;"></div>
                        <span>Presentation ‚Ä¢ Edited 4 years ago</span>
                    </div>
                </div>
            </div>
            
            <div class="tool-card" onclick="openTool('yoga-video')">
                <div class="card-image" style="background: linear-gradient(135deg, #8b4513 0%, #d2b48c 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                    <div style="text-align: center;">
                        <div style="font-size: 1.1rem; margin-bottom: 4px;">Clear your</div>
                        <div style="font-size: 1.1rem; margin-bottom: 4px;">mind through</div>
                        <div style="font-size: 1.1rem; margin-bottom: 8px;">yoga and</div>
                        <div style="font-size: 1.1rem;">meditation.</div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="card-title">Turquoise and White Yoga Gene...</div>
                    <div class="card-meta">
                        <div class="meta-icon" style="background: #e91e63; border-radius: 50%; width: 12px; height: 12px;"></div>
                        <span>Video ‚Ä¢ Edited 4 years ago</span>
                    </div>
                </div>
            </div>
            
            <div class="tool-card" onclick="openTool('talent-tv')">
                <div class="card-image" style="background: linear-gradient(135deg, #f5f5dc 0%, #deb887 100%); display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #333;">
                        <div style="font-size: 2rem; margin-bottom: 8px;">üì∫</div>
                        <div style="font-size: 0.9rem; font-weight: bold;">TALENT TV</div>
                    </div>
                </div>
                <div class="card-content">
                    <div class="card-title">Talent TV</div>
                    <div class="card-meta">
                        <div class="meta-icon" style="background: #ff9800; border-radius: 50%; width: 12px; height: 12px;"></div>
                        <span>Presentation ‚Ä¢ Edited 4 years ago</span>
                    </div>
                </div>
            </div>
            
            <div class="tool-card" onclick="openTool('club-fair')">
                <div class="card-image" style="background: linear-gradient(135deg, #ffffff 0%, #f0f0f0 100%); display: flex; align-items: center; justify-content: center; position: relative;">
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 20px;">
                        <div style="width: 30px; height: 20px; background: #ff6b6b; border-radius: 4px;"></div>
                        <div style="width: 30px; height: 20px; background: #4ecdc4; border-radius: 4px;"></div>
                        <div style="width: 30px; height: 20px; background: #45b7d1; border-radius: 4px;"></div>
                        <div style="width: 30px; height: 20px; background: #f9ca24; border-radius: 4px;"></div>
                        <div style="width: 30px; height: 20px; background: #6c5ce7; border-radius: 4px;"></div>
                        <div style="width: 30px; height: 20px; background: #fd79a8; border-radius: 4px;"></div>
                    </div>
                    <div class="card-overlay">View only</div>
                </div>
                <div class="card-content">
                    <div class="card-title">HHS Club Fair 2025 Layout</div>
                    <div class="card-meta">
                        <div class="meta-icon" style="background: #ff9800; border-radius: 50%; width: 12px; height: 12px;"></div>
                        <span>Presentation ‚Ä¢ Edited 21 days ago</span>
                    </div>
                </div>
            </div>
            
            <div class="tool-card" onclick="openTool('untitled-design')">
                <div class="card-image" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); display: flex; align-items: center; justify-content: center;">
                    <div style="color: #6c757d; font-size: 2rem;">üìÑ</div>
                </div>
                <div class="card-content">
                    <div class="card-title">Untitled Design</div>
                    <div class="card-meta">
                        <div class="meta-icon" style="background: #6f42c1; border-radius: 3px; width: 12px; height: 12px;"></div>
                        <span>1920 x 1080 px ‚Ä¢ Edited 4 years ago</span>
                    </div>
                </div>
            </div>
        </div>
    </main>
  </div>
      
    </div>
<div id="createModal" class="modal-overlay">
   <div class="modal-container"style="position:absolute; top: 7%; left: 11%;">
       <div class="modal-header">
           <h2>Create a study game</h2>
           <button class="close-btn" onclick="closeGameModal()">
               <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                   <line x1="18" y1="6" x2="6" y2="18"></line>
                   <line x1="6" y1="6" x2="18" y2="18"></line>
               </svg>
           </button>
       </div>
       
       <div class="modal-body">
           <div class="search-section">
               <div class="search-input-container">
                   <svg class="search-input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                       <circle cx="11" cy="11" r="8"></circle>
                       <path d="m21 21-4.35-4.35"></path>
                   </svg>
                   <input type="text" placeholder="What study game would you like to create?" class="modal-search-input">
               </div>
           </div>

           <div class="modal-content">
               <div class="modal-sidebar">
                   <div class="sidebar-section">
                       <div class="sidebar-item active">
                           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                               <circle cx="12" cy="7" r="4"></circle>
                           </svg>
                           Study Games
                       </div>
                       <div class="sidebar-item">
                           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <rect x="3" y="3" width="7" height="7"></rect>
                               <rect x="14" y="3" width="7" height="7"></rect>
                               <rect x="14" y="14" width="7" height="7"></rect>
                               <rect x="3" y="14" width="7" height="7"></rect>
                           </svg>
                           Flashcard Games
                       </div>
                       <div class="sidebar-item">
                           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <circle cx="12" cy="12" r="10"></circle>
                               <circle cx="12" cy="12" r="4"></circle>
                               <line x1="4.93" y1="4.93" x2="9.17" y2="9.17"></line>
                               <line x1="14.83" y1="14.83" x2="19.07" y2="19.07"></line>
                           </svg>
                           Quiz Modes
                       </div>
                       <div class="sidebar-item">
                           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                           </svg>
                           AI Study Battles
                       </div>
                       <div class="sidebar-item">
                           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <circle cx="12" cy="12" r="3"></circle>
                               <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                           </svg>
                           Interactive Maps
                       </div>
                       <div class="sidebar-item">
                           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                               <polyline points="14,2 14,8 20,8"></polyline>
                           </svg>
                           Study Materials
                       </div>
                       <div class="sidebar-item">
                           <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                               <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                               <line x1="8" y1="21" x2="16" y2="21"></line>
                               <line x1="12" y1="17" x2="12" y2="21"></line>
                           </svg>
                           Presentations
                       </div>
                   </div>
               </div>

               <div class="modal-main">
                  <div class="create-new-section">
    <h3>Create new study game</h3>
    <div class="empty-create-area">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#adb5bd" stroke-width="1.5">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="16"></line>
            <line x1="8" y1="12" x2="16" y2="12"></line>
        </svg>
        <h4>Design your own study mechanics</h4>
        <p>Create entirely new ways to learn - describe your game idea above</p>
    </div>
</div>
 <div class="recently-created-section">
        <div class="templates-header">
            <h3>Recently created & popular</h3>
            <div>
                <button class="refresh-btn" onclick="refreshPopularTools()">
  <svg class="refresh-icon" viewBox="0 0 16 16" fill="none">
    <path d="M13.65 2.35C12.2 0.9 10.2 0 8 0C3.58 0 0 3.58 0 8C0 12.42 3.58 16 8 16C11.73 16 14.84 13.45 15.73 10H13.65C12.83 12.33 10.61 14 8 14C4.69 14 2 11.31 2 8C2 4.69 4.69 2 8 2C9.66 2 11.14 2.69 12.22 3.78L9 7H16V0L13.65 2.35Z" fill="currentColor"/>
  </svg>
  Refresh
</button>
                <button class="see-all-btn" onclick="showAllTools()">See all</button>
            </div>
        </div>
        <div class="recent-games-grid" id="popularToolsGrid">
            <!-- Loading state -->
            <div class="game-card">
                <div class="loading-skeleton"></div>
                <div class="loading-skeleton" style="width: 60%;"></div>
                <div class="loading-skeleton" style="width: 80%;"></div>
            </div>
            <div class="game-card">
                <div class="loading-skeleton"></div>
                <div class="loading-skeleton" style="width: 70%;"></div>
                <div class="loading-skeleton" style="width: 90%;"></div>
            </div>
            <div class="game-card">
                <div class="loading-skeleton"></div>
                <div class="loading-skeleton" style="width: 55%;"></div>
                <div class="loading-skeleton" style="width: 75%;"></div>
            </div>
        </div>
    </div>

                   <div class="templates-section">
                       <div class="templates-header">
                           <h3>Study materials & sharing</h3>
                           <button class="see-all-btn">See all</button>
                       </div>
                       <div class="templates-grid">
                           <div class="template-card">
                               <div class="template-image notes-template"></div>
                               <div class="template-info">
                                   <h4>Study Notes</h4>
                                   <span>Create & share notes</span>
                               </div>
                           </div>
                           <div class="template-card">
                               <div class="template-image presentation-template"></div>
                               <div class="template-info">
                                   <h4>Study Presentation</h4>
                                   <span>Visual learning slides</span>
                               </div>
                           </div>
                           <div class="template-card">
                               <div class="template-image mindmap-template"></div>
                               <div class="template-info">
                                   <h4>Mind Map</h4>
                                   <span>Visual concept mapping</span>
                               </div>
                           </div>
                           <div class="template-card">
                               <div class="template-image shared-template"></div>
                               <div class="template-info">
                                   <h4>Shared Content</h4>
                                   <span>Community study materials</span>
                               </div>
                           </div>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>
</div>

<!-- Game Builder Modal (add after createModal) -->
<div class="game-builder-modal" id="gameBuilderModal">
  <div class="builder-container">
    <div class="chat-panel">
      <div class="chat-header">
  <h2>AI Game Designer</h2>
  <p>Let's build your study game together</p>
  
</div>
      <div class="chat-messages" id="chatMessages"></div>
      <div class="chat-input">
        <div class="input-container">
          <textarea class="chat-textarea" placeholder="Describe your game idea..." rows="1"></textarea>
          
          <button class="send-btn">Send</button>
        </div>
      </div>
    </div>
    <div class="resize-handle" id="resizeHandle"></div>
    <div class="preview-panel">
      <div class="preview-header">
        <h3>Live Game Preview</h3>
<button class="deploy-btn" onclick="deployGame()">Deploy Game</button>
      </div>
      <div class="game-canvas" id="gameCanvas">

  
  <div class="bottom-toolbar">
    <div></div>
    <button class="elements-toggle" onclick="toggleElements()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
      </svg>
      Elements
    </button>
  </div>
  
  <div class="elements-panel" id="elementsPanel">
    <div class="elements-header">Elements</div>
    <div class="elements-items">
      <div class="inventory-item" draggable="true" data-element="text">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#3b82f6">
          <path d="M3 17h18v-2H3v2zm0-4h18v-2H3v2zm0-4h18V7H3v2z"/>
        </svg>
        <span>Text</span>
      </div>
      <div class="inventory-item" draggable="true" data-element="button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#3b82f6">
          <rect x="3" y="9" width="18" height="6" rx="2"/>
        </svg>
        <span>Button</span>
      </div>
      <div class="inventory-item" draggable="true" data-element="input">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#3b82f6">
          <rect x="3" y="11" width="18" height="2" rx="1"/>
        </svg>
        <span>Input</span>
      </div>
      <div class="inventory-item" draggable="true" data-element="timer">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="#3b82f6">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12,6 12,12 16,14"/>
        </svg>
        <span>Timer</span>
      </div>
    </div>
  </div>
</div>
    </div>
  </div>
</div>

<div id="confirmationModal" class="confirmation-modal">
    <div class="confirmation-content">
        <h3 class="confirmation-title">Update Game?</h3>
        <p class="confirmation-message">Are you sure you want to update this game? This will overwrite the existing version.</p>
        <div class="confirmation-buttons">
            <button id="confirmUpdate" class="confirm-btn">Yes, Update</button>
            <button id="cancelUpdate" class="cancel-btn">Cancel</button>
        </div>
    </div>
</div>
   
<div id="successNotification" class="success-notification">
    <div class="success-icon">‚úì</div>
    <span>Game updated successfully!</span>
</div>

<!-- Add this modal HTML anywhere in your body -->
<div id="toolModal" class="game-portal">
    <div class="interactive-workspace">
        <button class="escape-button" onclick="justCloseTheModal()">√ó</button>
        <div id="tool-render-area" class="canvas-playground"></div>
        <div class="hammer-button" onclick="handleHammerClick()" data-game-id="">
    <svg class="hammer-icon" viewBox="0 0 24 24">
        <path d="M21 8H15L13.5 6.5L15 5H21C21.55 5 22 5.45 22 6V7C22 7.55 21.55 8 21 8ZM11.19 7.5L7.44 11.25L12.75 16.56L16.5 12.81L11.19 7.5ZM6.73 12.32L5.32 13.73C4.93 14.12 4.93 14.76 5.32 15.15L8.85 18.68C9.24 19.07 9.88 19.07 10.27 18.68L11.68 17.27L6.73 12.32Z"/>
    </svg>
</div>
    </div>
</div>


  <script>

const firebaseConfig = {
    apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
    authDomain: "certquest-94959.firebaseapp.com",
    projectId: "certquest-94959",
    storageBucket: "certquest-94959.appspot.com",
    messagingSenderId: "323956529033",
    appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
    measurementId: "G-F5JHTGGN6K"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
    
        // Tab switching functionality
        // Tab switching functionality
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        const tabText = this.textContent.toLowerCase();
        filterByTab(tabText);
        
        // Transform search bar for Canva AI tab
        if (tabText === 'canva ai') {
            transformToAISearchBar();
        } else {
            restoreNormalSearchBar();
        }
    });
});


   let clickTrackingData = {};
   // Generate random star rating between 4.5 and 5.0
        function generateStarRating() {
            return (Math.random() * 0.5 + 4.5).toFixed(1);
        }
        
        // Generate random play count
        function generatePlayCount() {
            const base = Math.floor(Math.random() * 3000) + 100;
            if (base > 1000) {
                return (base / 1000).toFixed(1) + 'k';
            }
            return base.toString();
        }
        
        // Determine game type based on tool name/content
        function determineGameType(toolName, description = '') {
            const content = (toolName + ' ' + description).toLowerCase();
            
            if (content.includes('speed') || content.includes('fast') || content.includes('quick') || content.includes('lightning')) {
                return 'Speed';
            } else if (content.includes('memory') || content.includes('remember') || content.includes('recall') || content.includes('match')) {
                return 'Memory';
            } else if (content.includes('strategy') || content.includes('build') || content.includes('conquest') || content.includes('plan')) {
                return 'Strategy';
            } else if (content.includes('puzzle') || content.includes('solve') || content.includes('logic')) {
                return 'Puzzle';
            } else if (content.includes('quiz') || content.includes('test') || content.includes('question')) {
                return 'Quiz';
            } else if (content.includes('creative') || content.includes('art') || content.includes('design')) {
                return 'Creative';
            } else {
                const types = ['Speed', 'Memory', 'Strategy', 'Puzzle', 'Quiz', 'Creative'];
                return types[Math.floor(Math.random() * types.length)];
            }
        }
        
        // Generate description based on game type and tool name
        function generateDescription(gameType, toolName) {
            const descriptions = {
                'Speed': [
                    `Race against time with ${toolName}`,
                    `Lightning-fast ${toolName} challenges`,
                    `Quick-fire ${toolName} rounds`,
                    `Beat the clock in ${toolName}`
                ],
                'Memory': [
                    `Remember and recall ${toolName} patterns`,
                    `Test your memory with ${toolName}`,
                    `Match and memorize ${toolName} elements`,
                    `Build memory skills through ${toolName}`
                ],
                'Strategy': [
                    `Plan your moves in ${toolName}`,
                    `Strategic thinking with ${toolName}`,
                    `Build and conquer in ${toolName}`,
                    `Tactical ${toolName} gameplay`
                ],
                'Puzzle': [
                    `Solve challenging ${toolName} puzzles`,
                    `Brain-teasing ${toolName} problems`,
                    `Logic puzzles with ${toolName}`,
                    `Critical thinking through ${toolName}`
                ],
                'Quiz': [
                    `Test your knowledge of ${toolName}`,
                    `Interactive ${toolName} questions`,
                    `Challenge yourself with ${toolName}`,
                    `Learn through ${toolName} quizzes`
                ],
                'Creative': [
                    `Express creativity with ${toolName}`,
                    `Design and build in ${toolName}`,
                    `Creative challenges with ${toolName}`,
                    `Artistic expression through ${toolName}`
                ]
            };
            
            const typeDescriptions = descriptions[gameType] || descriptions['Quiz'];
            return typeDescriptions[Math.floor(Math.random() * typeDescriptions.length)];
        }
        
        // Track click on study tool
        async function trackToolClick(toolName) {
            try {
                // Update local tracking
                if (!clickTrackingData[toolName]) {
                    clickTrackingData[toolName] = {
                        name: toolName,
                        clicks: 0,
                        lastClicked: new Date()
                    };
                }
                clickTrackingData[toolName].clicks++;
                clickTrackingData[toolName].lastClicked = new Date();
                
                console.log(`Tracked click for: ${toolName} (${clickTrackingData[toolName].clicks} total clicks)`);
                
                // Try to update Firebase if available
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    const trackingRef = db.collection('tool-analytics').doc(toolName);
                    
                    await trackingRef.set({
                        name: toolName,
                        clicks: firebase.firestore.FieldValue.increment(1),
                        lastClicked: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    console.log(`Updated Firebase analytics for: ${toolName}`);
                }
                
                // Refresh the popular section
                await refreshPopularTools();
                
            } catch (error) {
                console.error('Error tracking tool click:', error);
            }
        }
        
        // Load study tools from Firebase or demo data
        async function loadStudyTools() {
            try {
                if (typeof firebase !== 'undefined' && firebase.firestore) {
                    const db = firebase.firestore();
                    const toolsSnapshot = await db.collection('study-tools').limit(20).get();
                    const analyticsSnapshot = await db.collection('tool-analytics').orderBy('clicks', 'desc').get();
                    
                    // Build analytics map
                    const analyticsMap = {};
                    analyticsSnapshot.docs.forEach(doc => {
                        const data = doc.data();
                        analyticsMap[data.name] = data.clicks || 0;
                    });
                    
                    // Get tools with analytics
                    const tools = toolsSnapshot.docs.map(doc => {
                        const data = doc.data();
                        return {
                            name: data.name || 'Unnamed Tool',
                            description: data.description || '',
                            clicks: analyticsMap[data.name] || Math.floor(Math.random() * 1000),
                            createdAt: data.createdAt || new Date()
                        };
                    });
                    
                    console.log('Loaded', tools.length, 'tools from Firebase');
                    return tools;
                }
            } catch (error) {
                console.error('Error loading from Firebase:', error);
            }
            
            // Demo data with realistic study tool names
            return [
                { name: 'Lightning Vocab', description: 'Speed vocabulary training', clicks: Math.floor(Math.random() * 2000) + 500 },
                { name: 'Formula Builder', description: 'Interactive equation solving', clicks: Math.floor(Math.random() * 1500) + 300 },
                { name: 'History Conquest', description: 'Timeline building game', clicks: Math.floor(Math.random() * 2500) + 400 },
                { name: 'Memory Palace', description: 'Spatial memory techniques', clicks: Math.floor(Math.random() * 1200) + 200 },
                { name: 'Code Puzzle', description: 'Programming logic challenges', clicks: Math.floor(Math.random() * 1800) + 350 },
                { name: 'Language Lab', description: 'Interactive language learning', clicks: Math.floor(Math.random() * 2200) + 450 },
                { name: 'Math Sprint', description: 'Rapid calculation practice', clicks: Math.floor(Math.random() * 1600) + 250 },
                { name: 'Science Explorer', description: 'Interactive experiments', clicks: Math.floor(Math.random() * 1400) + 300 },
                { name: 'Art Studio', description: 'Creative design challenges', clicks: Math.floor(Math.random() * 900) + 150 },
                { name: 'Geography Quest', description: 'World exploration game', clicks: Math.floor(Math.random() * 1100) + 200 }
            ];
        }

       function closeGameModal() {
    const modals = [
        document.getElementById('toolModal'),
        document.querySelector('.modal-container'),
        document.getElementById('gameBuilderModal')
    ];
    
    modals.forEach(modal => {
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('active');
        }
    });
    
    document.body.style.overflow = 'auto';
    
    // Also hide the blurred overlay
    const overlay = document.querySelector('.modal-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
        closeGameModal();
    }
});

window.addEventListener('beforeunload', function() {
    document.body.style.overflow = '';
    document.body.classList.remove('modal-open', 'no-scroll', 'overflow-hidden');
});
        // Create game card HTML
        function createGameCard(tool, index) {
            const gameType = determineGameType(tool.name, tool.description);
            const description = tool.description || generateDescription(gameType, tool.name);
            const starRating = generateStarRating();
            const playCount = generatePlayCount();
            
            return `
                <div class="game-card" onclick="handleToolClick('${tool.name}')" data-tool-name="${tool.name}">
                    <div class="click-counter">${tool.clicks} clicks</div>
                    <span class="game-type ${gameType.toLowerCase()}">${gameType}</span>
                    <h4>${tool.name}</h4>
                    <p>${description}</p>
                    <span class="game-stats">
                        <span class="star">‚òÖ</span> ${starRating} ‚Ä¢ ${playCount} plays
                    </span>
                </div>
            `;
        }
        
        // Handle tool click
        async function handleToolClick(toolName) {
            console.log('Study tool clicked:', toolName);
            await trackToolClick(toolName);
            
            // Add visual feedback
            const card = document.querySelector(`[data-tool-name="${toolName}"]`);
            if (card) {
                card.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    card.style.transform = 'translateY(-5px)';
                }, 150);
            }
            
            // Here you could open the actual study tool modal
            // openStudyToolModal(toolName);
        }
        
        // Refresh popular tools section
        async function refreshPopularTools() {
            const grid = document.getElementById('popularToolsGrid');
            
            // Show loading state
            grid.innerHTML = `
                <div class="game-card">
                    <div class="loading-skeleton"></div>
                    <div class="loading-skeleton" style="width: 60%;"></div>
                    <div class="loading-skeleton" style="width: 80%;"></div>
                </div>
                <div class="game-card">
                    <div class="loading-skeleton"></div>
                    <div class="loading-skeleton" style="width: 70%;"></div>
                    <div class="loading-skeleton" style="width: 90%;"></div>
                </div>
                <div class="game-card">
                    <div class="loading-skeleton"></div>
                    <div class="loading-skeleton" style="width: 55%;"></div>
                    <div class="loading-skeleton" style="width: 75%;"></div>
                </div>
            `;
            
            try {
                // Load tools and sort by clicks
                const tools = await loadStudyTools();
                const topTools = tools
                    .sort((a, b) => b.clicks - a.clicks)
                    .slice(0, 5);
                
                if (topTools.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <h4>No study tools found</h4>
                            <p>Create some study tools to see them appear here!</p>
                        </div>
                    `;
                    return;
                }
                
                // Create cards
                grid.innerHTML = topTools.map((tool, index) => createGameCard(tool, index)).join('');
                
                console.log('Popular tools updated:', topTools.map(t => `${t.name} (${t.clicks} clicks)`));
                
            } catch (error) {
                console.error('Error refreshing popular tools:', error);
                grid.innerHTML = `
                    <div class="empty-state">
                        <h4>Error loading tools</h4>
                        <p>Please try again later.</p>
                        <button class="refresh-btn" onclick="refreshPopularTools()">üîÑ Retry</button>
                    </div>
                `;
            }
        }
        
        // Show all tools function
        function showAllTools() {
            console.log('Show all tools clicked');
            // This could open a full page view or expanded grid
            alert('This would show all available study tools!');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Initializing dynamic popular section...');
            refreshPopularTools();
        });
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            refreshPopularTools();
        }, 30000);
        
        // Make functions globally available
        window.trackToolClick = trackToolClick;
        window.refreshPopularTools = refreshPopularTools;
        window.showAllTools = showAllTools;
        
        console.log('Dynamic popular section system loaded!');
        // Search functionality
        function searchTools() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (query === '') {
                showAllCards();
                return;
            }
            
            const cards = document.querySelectorAll('.tool-card');
            let hasResults = false;
            
            cards.forEach(card => {
                const title = card.querySelector('.card-title').textContent.toLowerCase();
                const meta = card.querySelector('.card-meta').textContent.toLowerCase();
                
                if (title.includes(query) || meta.includes(query)) {
                    card.style.display = 'block';
                    hasResults = true;
                } else {
                    card.style.display = 'none';
                }
            });
            
            if (!hasResults) {
                console.log('No results found for:', query);
            }
        }

        // Real-time search
        document.getElementById('searchInput').addEventListener('input', function() {
            searchTools();
        });

        // Filter by tab
        function filterByTab(tabType) {
            const cards = document.querySelectorAll('.tool-card');
            
            if (tabType === 'your designs') {
                showAllCards();
            } else if (tabType === 'templates') {
                cards.forEach(card => {
                    const overlay = card.querySelector('.card-overlay');
                    const hasOverlay = overlay && overlay.textContent === 'View only';
                    card.style.display = hasOverlay ? 'block' : 'none';
                });
            } else if (tabType === 'canva ai') {
                cards.forEach(card => {
                    const title = card.querySelector('.card-title').textContent;
                    card.style.display = title.includes('AI') || title.includes('moo') ? 'block' : 'none';
                });
            }
        }

        function showAllCards() {
            document.querySelectorAll('.tool-card').forEach(card => {
                card.style.display = 'block';
            });
        }

        // Tool creation functions
        function createTool(type) {
            const query = document.getElementById('searchInput').value.trim();
            const message = query || `Create a new ${type} study tool`;
            
            console.log(`Creating ${type} tool with message: "${message}"`);
            alert(`Creating ${type} study tool!\n\nYour message: "${message}"\n\nThis would redirect to the ${type} creation interface.`);
        }

        function openTool(toolId) {
            console.log(`Opening tool: ${toolId}`);
            alert(`Opening ${toolId}!\n\nThis would launch the study tool interface.`);
        }

        function browseTools() {
            console.log('Browsing all tools');
            alert('Opening browse mode!\n\nThis would show all available study tools with advanced filtering options.');
        }

        function toggleView() {
            const grid = document.querySelector('.tools-grid');
            const isListView = grid.style.gridTemplateColumns === 'none';
            
            if (isListView) {
                grid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))';
                grid.style.display = 'grid';
            } else {
                grid.style.gridTemplateColumns = 'none';
                grid.style.display = 'flex';
                grid.style.flexDirection = 'column';
            }
        }

        function showHelp() {
            alert('StudyAI Help\n\n‚Ä¢ Click any tool type to create a new study tool\n‚Ä¢ Use the search box to find specific tools or subjects\n‚Ä¢ Switch between Your designs, Templates, and Canva AI tabs\n‚Ä¢ All tools are powered by AI for personalized learning');
        }

        // Add interactive feedback
        document.querySelectorAll('.tool-type, .tool-card').forEach(element => {
            element.addEventListener('mouseenter', function() {
                this.style.transform = this.classList.contains('tool-type') ? 'translateY(-2px)' : 'translateY(-4px)';
            });
            
            element.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });

        // Enter key search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchTools();
            }
        });

        // Smooth scroll behavior for better UX
        document.documentElement.style.scrollBehavior = 'smooth';

        // Add loading animation on tool creation
        function createTool(type) {
            const query = document.getElementById('searchInput').value.trim();
            const message = query || `Create a new ${type} design`;
            
            // Add loading state
            const button = event.target.closest('.tool-type');
            const originalContent = button.innerHTML;
            
            button.style.opacity = '0.7';
            button.innerHTML = `<div style="display: flex; flex-direction: column; align-items: center;"><div style="width: 20px; height: 20px; border: 2px solid #1976d2; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 8px;"></div><span style="font-size: 0.85rem;">Creating...</span></div>`;
            
            setTimeout(() => {
                button.style.opacity = '1';
                button.innerHTML = originalContent;
                alert(`Creating ${type} design!\n\nYour message: "${message}"\n\nThis would redirect to the ${type} creation interface.`);
            }, 1500);
        }

        

        // Add CSS animation for loading spinner
        // Transform search bar to AI mode
function transformToAISearchBar() {
    const searchContainer = document.querySelector('.search-container');
    const originalContent = searchContainer.innerHTML;
    searchContainer.dataset.originalContent = originalContent;
    
    searchContainer.innerHTML = `
    <div class="ai-search-wrapper">
        <div class="ai-top-row">
            <svg class="plus-icon" width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
            </svg>
            <input type="text" class="ai-search-input" placeholder="Describe your idea, and I'll bring it to life">
            <button class="mic-btn">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 715 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"/>
                </svg>
            </button>
            <button class="send-btn-ai">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>
        <div class="ai-suggestions">
            <button class="ai-suggestion">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                </svg>
                Design for me
            </button>
            <button class="ai-suggestion">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                </svg>
                Create an image
            </button>
            <button class="ai-suggestion">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                </svg>
                Draft a doc
            </button>
            
        </div>
    `;
    
    // Add event listeners
    const aiInput = searchContainer.querySelector('.ai-search-input');
    if (aiInput) {
        aiInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                handleAISearch();
            }
        });
    }
    
    const sendBtn = searchContainer.querySelector('.send-btn-ai');
    if (sendBtn) {
        sendBtn.addEventListener('click', handleAISearch);
    }
}

// Initialize OpenAI GPT API
const openAIApiKey = "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";

// Function to call GPT API
async function callGPTAPI(messages, temperature = 0.7, maxTokens = 2000) {
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${openAIApiKey}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                model: 'gpt-4',
                messages: messages,
                temperature: temperature,
                max_tokens: maxTokens
            })
        });
        if (!response.ok) {
            throw new Error(`API Error: ${response.status} - ${response.statusText}`);
        }
        const data = response.data;
        return data.content.trim();
        
    } catch (error) {
        console.error('GPT API Error:', error);
        throw error;
    }
}

// Store conversation history for context
conversationHistory = [
    {
        role: "system",
        content: `You are an enthusiastic AI game design assistant helping users create educational games. You should be conversational, helpful, and proactive.

CONVERSATION STYLE:
- Ask clarifying questions about game mechanics, subjects, difficulty levels
- Suggest creative features and improvements 
- Offer to create specific elements when appropriate
- Be encouraging and collaborative
- Help brainstorm ideas step by step

WHEN TO CREATE ELEMENTS:
When the user specifically requests an element OR when you offer to create something and they agree, respond with JSON in this format:

{
  "action": "create_element", 
  "element": {
    "type": "custom",
    "name": "descriptive-name",
    "html": "generated HTML based on request",
    "css": "generated CSS based on request", 
    "javascript": "generated JavaScript based on request",
    "x": position_x,
    "y": position_y,
    "description": "what this does"
  }
}

WHEN TO MODIFY ELEMENTS (user refers to existing elements):
- "change the button color"
- "make it bigger" 
- "update the text"
- "turn it red"

Use this JSON format:
{
  "action": "modify_element",
  "target": "button" (or "red button", "the element", etc.),
  "changes": {
    "text": "new text",
    "css": "background-color: red; font-size: 20px",
    "javascript": "this.addEventListener('click', function() { alert('Modified!'); });"
  }
}

After creating an element, always say "‚ú® [Element Name] created! You can drag it around or click √ó to delete it."

IMPORTANT JAVASCRIPT RULES:
- When user says "change the button's background" or "change its color", use: this.style.backgroundColor = 'color'
- When user says "change the element's [property]", use: this.style.property = 'value'
- Always use 'this' to refer to the clicked element, NOT document.body or other elements
- For click events, use: element.addEventListener('click', function() { this.style.property = 'value'; });

EXAMPLE CONVERSATIONS:
User: "I want a button"
You: "What should the button do? What text should it display? What color would you like? Should it be positioned in the center?"

User: "Make it red, say Hi, and toggle to Bye when clicked, centered"
You: {JSON for creating the button}
Then: "‚ú® Toggle Button created! You can drag it around or click √ó to delete it."

Always be helpful, ask questions, and offer to create things!`
    }
];

function restoreNormalSearchBar() {
    const searchContainer = document.querySelector('.search-container');
    if (searchContainer.dataset.originalContent) {
        searchContainer.innerHTML = searchContainer.dataset.originalContent;
        delete searchContainer.dataset.originalContent;
        
        // Re-bind search event listener
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', searchTools);
        }
    }
}

function handleAISearch() {
    const aiInput = document.querySelector('.ai-search-input');
    if (!aiInput) return;
    
    const query = aiInput.value.trim();
    if (!query) return;
    
    console.log('AI Search:', query);
    alert(`AI Processing: "${query}"\n\nThis would trigger AI content creation.`);
}

// Add CSS animation for loading spinner
const style = document.createElement('style');
        style.textContent = `
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .ai-search-wrapper {
    background: linear-gradient(135deg, rgba(147, 197, 253, 0.1) 0%, rgba(196, 181, 253, 0.1) 100%);
    border: 2px solid rgba(147, 197, 253, 0.3);
    border-radius: 50px;
    padding: 16px 20px;
    transition: all 0.3s ease;
    width: 100%;
    margin-bottom: 16px;
}

.ai-top-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}
    .ai-suggestions {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    padding-left: 32px;
}
    
    .ai-search-wrapper:hover {
        border-color: rgba(147, 197, 253, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(147, 197, 253, 0.15);
    }
    
    .plus-icon {
        color: #9ca3af;
        flex-shrink: 0;
    }
    
    .ai-search-input {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        font-size: 16px;
        color: #374151;
        padding: 8px 0;
    }
    
    .ai-search-input::placeholder {
        color: #9ca3af;
    }
    
    .mic-btn, .send-btn-ai {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .mic-btn:hover, .send-btn-ai:hover {
        background: rgba(147, 197, 253, 0.2);
        color: #3b82f6;
    }
    
    .ai-suggestions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .ai-suggestion {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.9);
        border: 1.5px solid rgba(229, 231, 235, 0.8);
        border-radius: 25px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s ease;
        white-space: nowrap;
    }
    
    .ai-suggestion:hover {
        border-color: #3b82f6;
        background: rgba(59, 130, 246, 0.05);
        transform: translateY(-2px);
    }
    
    .ai-suggestion.special {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.1) 0%, rgba(245, 158, 11, 0.1) 100%);
        border-color: rgba(251, 191, 36, 0.4);
        color: #92400e;
    }
    
    .ai-suggestion svg {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
    }
`;
        document.head.appendChild(style);

      function openModal() {
    const modal = document.getElementById('createModal');
    const overlay = document.querySelector('.modal-overlay');
    
    if (modal && overlay) {
        modal.classList.add('active');
        overlay.classList.add('active'); // Show overlay with class instead of display
        document.body.style.overflow = 'hidden';
    }
}

// FORCE IT TO STAY CLOSED - Override CSS timing

function closeModal() {
    // Close the regular modal first
    const modal = document.getElementById('createModal');
    if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
    
    // Close the overlay
    const overlay = document.querySelector('.modal-overlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
    
    // NUCLEAR OPTION FOR toolModal
    const toolModal = document.getElementById('toolModal');
    if (toolModal) {
        console.log('üöÄ LAUNCHING NUCLEAR MODAL DESTROYER');
        
        // IMMEDIATE DESTRUCTION
        const nukeModal = () => {
            // Remove all classes that might show it
            toolModal.className = '';
            
            // Nuclear CSS override
            toolModal.style.cssText = `
                display: none !important; 
                visibility: hidden !important; 
                opacity: 0 !important;
                transform: scale(0) !important;
                pointer-events: none !important;
                z-index: -9999 !important;
                position: absolute !important;
                top: -9999px !important;
                left: -9999px !important;
            `;
            
            // Also hide all its children
            const children = toolModal.querySelectorAll('*');
            children.forEach(child => {
                child.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important;';
            });
        };
        
        // Initial nuke
        nukeModal();
        
        // AGGRESSIVE WATCHER - Check every 50ms for the first 2 seconds
        let watchCount = 0;
        const aggressiveWatcher = setInterval(() => {
            const styles = window.getComputedStyle(toolModal);
            if (styles.display !== 'none' || styles.visibility !== 'hidden' || styles.opacity !== '0') {
                console.log('‚ö†Ô∏è MODAL TRYING TO RESURRECT - NUKING AGAIN');
                nukeModal();
            }
            
            watchCount++;
            if (watchCount > 40) { // Stop after 2 seconds (40 * 50ms)
                clearInterval(aggressiveWatcher);
                console.log('üéØ Aggressive watching complete');
            }
        }, 50);
        
        // MUTATION OBSERVER - Watch for attribute changes
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes') {
                    console.log(`üîç Detected ${mutation.attributeName} change - re-nuking`);
                    nukeModal();
                }
            });
        });
        
        observer.observe(toolModal, {
            attributes: true,
            attributeFilter: ['style', 'class', 'data-state', 'aria-hidden', 'hidden']
        });
        
        // CLEANUP - Stop watching after 5 seconds
        setTimeout(() => {
            observer.disconnect();
            console.log('üíÄ Modal destroyer mission complete');
        }, 5000);
        
        // BACKUP PLAN - If all else fails, try removing from DOM temporarily
        setTimeout(() => {
            if (window.getComputedStyle(toolModal).display !== 'none') {
                console.log('üß® LAST RESORT - Temporary DOM removal');
                const parent = toolModal.parentNode;
                const nextSibling = toolModal.nextSibling;
                
                parent.removeChild(toolModal);
                
                // Put it back after 100ms but keep it hidden
                setTimeout(() => {
                    if (nextSibling) {
                        parent.insertBefore(toolModal, nextSibling);
                    } else {
                        parent.appendChild(toolModal);
                    }
                    nukeModal();
                }, 100);
            }
        }, 1000);
        
        // GLOBAL CSS INJECTION - Add a style that can't be overridden easily
        const globalStyle = document.createElement('style');
        globalStyle.id = 'modal-destroyer-style';
        globalStyle.textContent = `
            #toolModal, 
            #toolModal.game-portal,
            #toolModal[data-state="open"],
            #toolModal.active,
            #toolModal.show,
            #toolModal.visible {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                transform: scale(0) translateX(-9999px) !important;
                pointer-events: none !important;
                z-index: -9999 !important;
            }
            
            /* Hide common modal backdrop patterns too */
            .modal-backdrop,
            .modal-overlay,
            .backdrop {
                display: none !important;
            }
        `;
        
        // Remove existing style if it exists
        const existingStyle = document.getElementById('modal-destroyer-style');
        if (existingStyle) {
            existingStyle.remove();
        }
        
        document.head.appendChild(globalStyle);
    }
}
function justCloseTheModal() {
    const modal = document.getElementById('toolModal');
    if (modal) {
        modal.style.display = 'none';
    }
}
function outsideClickHandler(e) {
    const modal = document.getElementById('createModal');
    if (e.target === modal) {
        closeModal();
    }
}

async function handleHammerClick() {
    console.log('Hammer button clicked!');
    
    // Get the game ID from the data attribute
    const hammerButton = document.querySelector('.hammer-button');
    const gameId = hammerButton.dataset.gameId;
    
    console.log('üîç DEBUG: gameId received:', gameId);
    
    if (!gameId) {
        console.error('‚ùå No gameId provided to handleHammerClick');
        return;
    }
    
    try {
        console.log('üîç Loading specific game:', gameId);
        
        // Load the specific game from Firebase
        const doc = await firebase.firestore().collection('study-tools').doc(gameId).get();
        
        if (!doc.exists) {
            console.error('‚ùå Game not found in Firebase with ID:', gameId);
            return;
        }
        
        const gameData = doc.data();
        console.log('‚úÖ Loaded specific game data:', gameData.name);
        
        // Close the tool modal first
        const toolModal = document.getElementById('toolModal');
        if (toolModal) toolModal.style.display = 'none';
        
        // Show the game builder modal
        const gameBuilderModal = document.getElementById('gameBuilderModal');
        if (gameBuilderModal) {
            gameBuilderModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Show the game canvas
        const gameCanvas = document.getElementById('gameCanvas');
        if (gameCanvas) gameCanvas.style.display = 'block';
        
        // Clear any existing elements
        gameCanvas.innerHTML = '<div class="canvas-grid"></div>';
        
        // Load the SPECIFIC game state
        const gameStateJson = JSON.stringify(gameData.gameState);
        gameStateManager.loadGameState(gameStateJson);
        
        // Store the specific game ID
        gameStateManager.currentGameId = gameId;
        localStorage.setItem('lastGameId', gameId);
        
        // ADD THE SUCCESS MESSAGE AFTER LOADING THE GAME
        const successContainer = document.createElement('div');
        successContainer.className = 'deploy-success-container';
        successContainer.innerHTML = `
            <div class="deploy-success-icon">üéÆ</div>
            <h2 class="deploy-success-title">Study Tool Loaded!</h2>
            <p class="success-message">Your tool "${gameData.name}" is now ready for editing!</p>
            
            <div class="deploy-success-actions">
                <button class="deploy-action-btn edit-btn" onclick="startEditing()">Start Editing</button>
                <button class="deploy-action-btn preview-btn" onclick="exportGamePreview()">
                    Preview Tool
                </button>
                <button class="deploy-action-btn share-btn" style="display:none;" onclick="shareGame('${gameData.id}')">
                    Share Tool
                </button>
            </div>
        `;

        // Add the exact same CSS styles
        const style = document.createElement('style');
        style.textContent = `
            .deploy-success-container {
                width: 100%;
                height: 100vh;
                background: #e5e7eb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                box-sizing: border-box;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1000;
            }
            
            .deploy-success-icon {
                font-size: 4rem;
                margin-bottom: 24px;
                animation: bounceIn 0.6s ease-out;
            }
            
            .deploy-success-title {
                color: #1f2937;
                font-size: 2.2rem;
                font-weight: 700;
                margin-bottom: 16px;
                text-align: center;
            }
            
            .success-message {
                color: #6b7280;
                font-size: 1.1rem;
                margin-bottom: 32px;
                text-align: center;
                max-width: 500px;
            }
            
            .deploy-success-actions {
                display: flex;
                gap: 16px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .deploy-action-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 120px;
            }
            
            .edit-btn {
                background: #374151;
                color: white;
            }
            
            .edit-btn:hover {
                background: #1f2937;
                transform: translateY(-2px);
            }
            
            .preview-btn, .share-btn {
                background: transparent;
                color: #374151;
                border: 2px solid #d1d5db;
            }
            
            .preview-btn:hover, .share-btn:hover {
                background: #f9fafb;
                transform: translateY(-2px);
            }
            
            @keyframes bounceIn {
                0% { transform: scale(0.3); opacity: 0; }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); opacity: 1; }
            }
        `;

        document.head.appendChild(style);
        gameCanvas.appendChild(successContainer);
        
        // CHANGE THE BUTTON TO "UPDATE GAME" - THIS IS THE KEY ADDITION
        setTimeout(() => {
            const modal = document.getElementById('gameBuilderModal');
            const deployBtn = modal?.querySelector('#deployGame') || modal?.querySelector('[onclick*="deploy"]');
            if (deployBtn) {
                deployBtn.textContent = 'Update Game';
                deployBtn.onclick = showUpdateConfirmation;
                console.log('‚úÖ Button changed to UPDATE GAME for specific game:', gameId);
            }
        }, 100);
        
        console.log('‚úÖ Specific game loaded successfully in edit mode:', gameId);
        
    } catch (error) {
        console.error('‚ùå Error loading specific game:', error);
        alert('Failed to load the specific game. Please try again.');
    }
}
// Add this helper function
function startEditing() {
    const successContainer = document.querySelector('.deploy-success-container');
    if (successContainer) {
        successContainer.remove();
    }
    // Any additional editing setup can go here
}
// Close modal when clicking outside
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('modal-overlay')) {
        closeModal();
    }
    if (e.target.classList.contains('close-btn')) {
        closeModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});

// Sidebar item selection
document.addEventListener('DOMContentLoaded', function() {
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    
    sidebarItems.forEach(item => {
        item.addEventListener('click', function() {
            sidebarItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
        });
    });
});

// Add to existing JavaScript
const searchInput = document.querySelector('.modal-search-input');
if (searchInput) {
    searchInput.addEventListener('input', function(e) {
        const value = e.target.value.trim();
        if (value.length > 15) {
            // Show "Create Game" button when user describes their idea
            showCreateButton(value);
        }
    });
}

function fixDragAndResize() {
    console.log('Applying fixes...');
    
    // Fix CSS first
    const style = document.createElement('style');
    style.textContent = `
        .builder-container { display: flex !important; height: 100vh; }
        .chat-panel { width: 400px; flex-shrink: 0; }
        .resize-handle {
    width: 4px;
    background: #f1f5f9;
    cursor: col-resize;
    flex-shrink: 0;
    position: relative;
    transition: background-color 0.2s ease;
}

.resize-handle::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 2px;
    height: 16px;
    background: #cbd5e1;
    border-radius: 1px;
    transition: background-color 0.2s ease;
}

.resize-handle:hover {
    background: #dbeafe;
}

.resize-handle:hover::after {
    background: #60a5fa;
}
        .preview-panel { flex: 1; }
        #dropZone { 
            position: relative !important; 
            min-height: 400px; 
            border: 2px dashed #cbd5e1;
            margin: 16px;
        }
        .dropped-element { 
            position: absolute !important;
            background: white;
            border: 2px solid #3b82f6;
            padding: 10px;
            border-radius: 8px;
            cursor: move;
        }
    `;
    document.head.appendChild(style);
    
    // Add resize functionality
    const resizeHandle = document.getElementById('resizeHandle');
    const chatPanel = document.querySelector('.chat-panel');
    
    if (resizeHandle && chatPanel) {
        resizeHandle.onmousedown = function(e) {
            e.preventDefault();
            document.onmousemove = function(e) {
                let newWidth = e.clientX;
                if (newWidth > 250 && newWidth < 800) {
                    chatPanel.style.width = newWidth + 'px';
                }
            };
            document.onmouseup = function() {
                document.onmousemove = null;
                document.onmouseup = null;
            };
        };
        console.log('‚úÖ Resize fixed');
    }
    
    // Add drag and drop
    const dropZone = document.getElementById('gameCanvas');
    if (dropZone) {
        dropZone.ondrop = function(e) {
            e.preventDefault();
            const data = e.dataTransfer.getData('text');
            const rect = dropZone.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const element = document.createElement('div');
            element.className = 'dropped-element';
            element.style.left = x + 'px';
            element.style.top = y + 'px';
            element.innerHTML = data + ' Element';
            element.onmousedown = function(e) {
                let shiftX = e.clientX - element.getBoundingClientRect().left;
                let shiftY = e.clientY - element.getBoundingClientRect().top;
                
                document.onmousemove = function(e) {
                    element.style.left = (e.clientX - shiftX - dropZone.getBoundingClientRect().left) + 'px';
                    element.style.top = (e.clientY - shiftY - dropZone.getBoundingClientRect().top) + 'px';
                };
                document.onmouseup = function() {
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };
            
            dropZone.appendChild(element);
            console.log('‚úÖ Element dropped:', data);
        };
        
        dropZone.ondragover = function(e) {
            e.preventDefault();
            this.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';
        };
        
        dropZone.ondragleave = function() {
            this.style.backgroundColor = '';
        };
        
        console.log('‚úÖ Drop zone fixed');
    }
    
    // Fix inventory items
    document.querySelectorAll('.inventory-item').forEach(item => {
        item.draggable = true;
        item.ondragstart = function(e) {
            e.dataTransfer.setData('text', this.dataset.element);
            console.log('Dragging:', this.dataset.element);
        };
    });
    
    console.log('‚úÖ All fixes applied');
}

// Run the fix
fixDragAndResize();

function showCreateButton(gameIdea) {
    const emptyArea = document.querySelector('.empty-create-area');
    if (!emptyArea.querySelector('.create-btn')) {
        const btn = document.createElement('button');
        btn.className = 'create-btn';
        btn.textContent = 'Create This Game';
        btn.style.cssText = `
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            color: white; border: none; padding: 12px 24px; border-radius: 12px;
            font-weight: 600; cursor: pointer; margin-top: 16px;
        `;
        btn.onclick = () => createCustomGame(gameIdea);
        emptyArea.appendChild(btn);
    }
}




// Add this to your existing JavaScript

// Content data for each tab
const tabContent = {
    'Study Games': {
        title: 'Create new study game',
        description: 'Design your own study mechanics',
        subtitle: 'Create entirely new ways to learn - describe your game idea above',
        recentGames: [
            { type: 'Speed', name: 'Lightning Vocab', desc: 'Type translations before time runs out', rating: '4.8', plays: '1.2k' },
            { type: 'Memory', name: 'Formula Builder', desc: 'Drag equations to solve physics problems', rating: '4.9', plays: '856' },
            { type: 'Strategy', name: 'History Conquest', desc: 'Build timeline by conquering territories', rating: '4.7', plays: '2.1k' }
        ]
    },
    'Flashcard Games': {
        title: 'Create new flashcard game',
        description: 'Interactive flashcard mechanics',
        subtitle: 'Transform traditional flashcards into engaging games',
        recentGames: [
            { type: 'Memory', name: 'Card Match Rush', desc: 'Match pairs before the timer expires', rating: '4.6', plays: '987' },
            { type: 'Speed', name: 'Flash Quiz Battle', desc: 'Answer flashcards in rapid succession', rating: '4.8', plays: '1.5k' },
            { type: 'Strategy', name: 'Stack Attack', desc: 'Build towers by answering correctly', rating: '4.5', plays: '743' }
        ]
    },
    'Quiz Modes': {
        title: 'Create new quiz mode',
        description: 'Dynamic quiz experiences',
        subtitle: 'Build interactive quizzes with unique gameplay elements',
        recentGames: [
            { type: 'Speed', name: 'Rapid Fire Quiz', desc: 'Answer as many questions as possible', rating: '4.7', plays: '2.3k' },
            { type: 'Strategy', name: 'Quiz Conquest', desc: 'Conquer territories by answering correctly', rating: '4.9', plays: '1.8k' },
            { type: 'Memory', name: 'Pattern Quiz', desc: 'Remember question patterns to win', rating: '4.4', plays: '654' }
        ]
    },
    'AI Study Battles': {
        title: 'Create new AI study battle',
        description: 'Compete against AI opponents',
        subtitle: 'Challenge AI tutors in personalized learning battles',
        recentGames: [
            { type: 'Strategy', name: 'Math Duel Arena', desc: 'Solve equations faster than AI opponents', rating: '4.8', plays: '1.1k' },
            { type: 'Speed', name: 'Vocab Showdown', desc: 'Vocabulary battles against smart AI', rating: '4.6', plays: '876' },
            { type: 'Memory', name: 'Fact Fighter', desc: 'Remember facts better than AI tutor', rating: '4.7', plays: '1.4k' }
        ]
    },
    'Interactive Maps': {
        title: 'Create new interactive map',
        description: 'Visual learning through maps',
        subtitle: 'Build geographical and conceptual maps for visual learning',
        recentGames: [
            { type: 'Strategy', name: 'World Explorer', desc: 'Learn geography through exploration', rating: '4.9', plays: '2.1k' },
            { type: 'Memory', name: 'Capital Quest', desc: 'Remember capitals by building routes', rating: '4.5', plays: '923' },
            { type: 'Speed', name: 'Map Race', desc: 'Locate places faster than opponents', rating: '4.7', plays: '1.3k' }
        ]
    },
    'Study Materials': {
        title: 'Create new study material',
        description: 'Organize and share resources',
        subtitle: 'Build comprehensive study materials and share with others',
        recentGames: [
            { type: 'Memory', name: 'Note Cards Pro', desc: 'Advanced note-taking with memory aids', rating: '4.8', plays: '1.7k' },
            { type: 'Strategy', name: 'Study Planner', desc: 'Strategic learning path creation', rating: '4.6', plays: '1.2k' },
            { type: 'Speed', name: 'Quick Reference', desc: 'Rapid access to key information', rating: '4.4', plays: '789' }
        ]
    },
    'Presentations': {
        title: 'Create new presentation',
        description: 'Interactive learning presentations',
        subtitle: 'Build engaging presentations with interactive elements',
        recentGames: [
            { type: 'Strategy', name: 'Story Builder', desc: 'Create narrative-driven presentations', rating: '4.7', plays: '1.5k' },
            { type: 'Memory', name: 'Visual Timeline', desc: 'Remember events through visual stories', rating: '4.8', plays: '1.1k' },
            { type: 'Speed', name: 'Slide Challenge', desc: 'Race through presentation content', rating: '4.5', plays: '834' }
        ]
    }
};

// Update the existing sidebar item click handler
document.addEventListener('DOMContentLoaded', function() {
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    
    sidebarItems.forEach(item => {
        item.addEventListener('click', function() {
            sidebarItems.forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            // Get the tab name and update content
            const tabName = this.textContent.trim();
            updateModalContent(tabName);
        });
    });
});

function updateModalContent(tabName) {
    const content = tabContent[tabName];
    if (!content) return;
    
    // Update main title
    const mainTitle = document.querySelector('.create-new-section h3');
    if (mainTitle) mainTitle.textContent = content.title;
    
    // Update description
    const description = document.querySelector('.empty-create-area h4');
    if (description) description.textContent = content.description;
    
    // Update subtitle
    const subtitle = document.querySelector('.empty-create-area p');
    if (subtitle) subtitle.textContent = content.subtitle;
    
    // Update recent games
    updateRecentGames(content.recentGames);
}

function updateRecentGames(games) {
    const gamesGrid = document.querySelector('.recent-games-grid');
    if (!gamesGrid) return;
    
    gamesGrid.innerHTML = '';
    
    games.forEach(game => {
        const gameCard = document.createElement('div');
        gameCard.className = 'game-card';
        gameCard.innerHTML = `
            <span class="game-type">${game.type}</span>
            <h4>${game.name}</h4>
            <p>${game.desc}</p>
            <span class="game-stats">‚òÖ ${game.rating} ‚Ä¢ ${game.plays} plays</span>
        `;
        gamesGrid.appendChild(gameCard);
    });
}



function toggleElements() {
    document.getElementById('elementsPanel').classList.toggle('active');
}

function addMessage(content, type) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${type}`;
    messageDiv.textContent = content;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}



// Update existing createCustomGame function
function createCustomGame(idea) {
    closeModal(); // Close the first modal
    setTimeout(() => {
        openGameBuilder(idea);
    }, 300);
}

// Add to your existing JavaScript, after the createCustomGame function

document.addEventListener('DOMContentLoaded', function() {
    // Handle both possible button selectors
    const sendBtn = document.getElementById('sendBtn') || document.querySelector('.send-btn');
    const messageInput = document.getElementById('messageInput') || document.querySelector('.chat-textarea');
    
    if (sendBtn) {
        sendBtn.addEventListener('click', handleSendMessage);
    }
    
    if (messageInput) {
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendMessage();
            }
        });
    }
});

// CSS for typing indicator
const typingStyles = document.createElement('style');
typingStyles.textContent = `
.typing-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #6b7280;
    font-style: italic;
}

.typing-indicator::after {
    content: '';
    width: 20px;
    height: 6px;
    background: linear-gradient(90deg, 
        #3b82f6 0%, #3b82f6 33%, 
        transparent 33%, transparent 66%, 
        #3b82f6 66%);
    background-size: 20px 6px;
    animation: typing 1.4s infinite ease-in-out;
}

@keyframes typing {
    0%, 60%, 100% {
        background-position: 0 0;
    }
    30% {
        background-position: -20px 0;
    }
}

.message.ai {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border: 1px solid #e2e8f0;
    padding: 16px 20px;
    margin: 16px 0;
    border-radius: 16px 16px 16px 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    position: relative;
    max-width: 85%;
    margin-left: 0;
    margin-right: auto;
    margin-bottom: -10px;
}



.message.user {
    background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
    color: white;
    padding: 16px 20px;
    margin: 16px 0;
    border-radius: 16px 16px 4px 16px;
    box-shadow: 0 3px 12px rgba(59, 130, 246, 0.25);
    text-align: left;
    max-width: 85%;
    margin-left: auto;
    margin-right: 0;
    position: relative;
    backdrop-filter: blur(10px);
}



.message-content {
    line-height: 1.5;
}
`;
document.head.appendChild(typingStyles);

// Remove the hardcoded elementKeywords object entirely

// Enhanced system prompt for better game element generation


// Function to detect elements in AI response
function detectElementsInResponse(aiResponse) {
    const detectedElements = [];
    const lowercaseResponse = aiResponse.toLowerCase();
    
    for (const [elementType, keywords] of Object.entries(elementKeywords)) {
        for (const keyword of keywords) {
            if (lowercaseResponse.includes(keyword)) {
                if (!detectedElements.includes(elementType)) {
                    detectedElements.push(elementType);
                }
            }
        }
    }
    
    return detectedElements;
}

// Function to automatically drop elements
function autoDropElements(elements) {
    const dropZone = document.getElementById('dropZone');
    if (!dropZone) return;
    
    elements.forEach((elementType, index) => {
        // Space elements out so they don't overlap
        const x = 100 + (index * 120);
        const y = 100 + (index * 80);
        
        setTimeout(() => {
            createDroppedElement(elementType, x, y);
            
            // Add visual feedback
            showElementAddedNotification(elementType);
        }, index * 500); // Stagger the drops
    });
}

// Visual notification when element is added
function showElementAddedNotification(elementType) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    notification.textContent = `‚ú® Added ${elementType} to canvas`;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Remove after delay
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
    }, 2500);
}


async function handleSendMessage() {
    const messageInput = document.getElementById('messageInput') || document.querySelector('.chat-textarea');
    const message = messageInput.value.trim();
    if (!message) return;

    addMessage(message, 'user');
    messageInput.value = '';
    
    conversationHistory.push({
        role: "user",
        content: message
    });

    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai typing';
    typingDiv.innerHTML = '<div class="typing-indicator">AI is thinking...</div>';
    document.getElementById('chatMessages').appendChild(typingDiv);
    
    try {
        const aiResponse = await callGPTAPI(conversationHistory);
        typingDiv.remove();
        
        console.log('ü§ñ AI Response:', aiResponse);
        
        // Enhanced JSON detection - looks for JSON in multiple formats
        let jsonMatch = null;
        let elementData = null;
        
        // Try different JSON patterns
        const patterns = [
            /```json\s*(\{[\s\S]*?\})\s*```/,  // Code block format
            /(\{\s*"action":\s*"(?:create_element|modify_element)"[\s\S]*?\})/,  // Plain JSON
            /(\{[\s\S]*?"action"[\s\S]*?\})/  // Any JSON with action
        ];
        
        for (const pattern of patterns) {
            jsonMatch = aiResponse.match(pattern);
            if (jsonMatch) {
                console.log('üîç JSON pattern matched:', pattern);
                break;
            }
        }
        
        if (jsonMatch) {
            try {
                const jsonString = jsonMatch[1].trim();
                console.log('üìã Raw JSON string:', jsonString);
                
                // Clean up template literals before parsing
const cleanJsonString = jsonString.replace(/`([^`]*)`/gs, function(match, content) {
    // Escape quotes and newlines in the content
    return '"' + content.replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r') + '"';
});
elementData = JSON.parse(cleanJsonString);

                console.log('‚úÖ Parsed element data:', elementData);
                
                // Remove JSON from the conversational response
                let textResponse = aiResponse.replace(jsonMatch[0], '').trim();
                textResponse = textResponse.replace(/‚ú®.*created!.*$/m, '').trim();
                
                // Show conversational part if it exists
                if (textResponse && textResponse.length > 10) {
                    addMessage(textResponse, 'ai');
                }
                
                // Process the action
                if (elementData.action === "create_element") {
                    console.log('üéÆ Creating element...');
                    const createdElement = createCustomElement(elementData.element);
                    if (createdElement) {
                        const elementName = elementData.element.name || elementData.element.type || 'Element';
                        addMessage(`‚ú® ${elementName} created! You can drag it around or click √ó to delete it.`, 'ai');
                        console.log('‚úÖ Element created successfully');
                    } else {
                        addMessage("Sorry, there was an issue creating the element.", 'ai');
                        console.log('‚ùå Element creation failed');
                    }
                } else if (elementData.action === "modify_element") {
                    console.log('üîß Modifying element...');
                    const success = modifyExistingElement(elementData.target, elementData.changes);
                    if (success) {
                        addMessage("‚ú® Element updated successfully!", 'ai');
                        console.log('‚úÖ Element modified successfully');
                    } else {
                        addMessage("I couldn't find that element to modify. Try being more specific.", 'ai');
                        console.log('‚ùå Element modification failed');
                    }
                }
                        
            } catch (parseError) {
                console.error('‚ùå JSON Parse Error:', parseError);
                console.error('üìã Problematic JSON:', jsonMatch[1]);
                addMessage("I tried to create something but there was a formatting issue. Let me try again.", 'ai');
            }
        } else {
            // No JSON found - just conversational response
            console.log('üí¨ No JSON detected, showing conversational response');
            addMessage(aiResponse, 'ai');
        }
        
        conversationHistory.push({
            role: "assistant",
            content: aiResponse
        });
        
    } catch (error) {
        typingDiv.remove();
        addMessage("Sorry, I'm having trouble connecting right now. Please try again.", 'ai');
        console.error('‚ùå API Error:', error);
    }
}

// Function to detect if user message is requesting a modification
function isModificationRequest(message) {
    const modifyKeywords = [
        'change', 'modify', 'update', 'edit', 'make it', 'turn it', 
        'make the', 'change the', 'update the', 'modify the',
        'bigger', 'smaller', 'different color', 'red', 'blue', 'green',
        'move it', 'resize', 'text to', 'color to', 'background'
    ];
    
    const lowerMessage = message.toLowerCase();
    return modifyKeywords.some(keyword => lowerMessage.includes(keyword)) &&
           (lowerMessage.includes('button') || lowerMessage.includes('element') || 
            lowerMessage.includes('it') || lowerMessage.includes('the'));
}

// Enhanced createCustomElement function with resize handles
window.createCustomElement = function(elementData) {
    const gameCanvas = document.getElementById('gameCanvas') || document.getElementById('dropZone');
    if (!gameCanvas) {
        console.error('Game canvas not found');
        return null;
    }
    
    console.log('Creating element with data:', elementData);
    
    // Remove placeholder if it exists
    const placeholder = gameCanvas.querySelector('.drop-placeholder');
    if (placeholder) {
        placeholder.style.display = 'none';
    }
    
    // Create element container
    const element = document.createElement('div');
    element.className = 'custom-game-element dropped-element'; // ADDED dropped-element class!
    
    // Use provided coordinates or defaults
    const x = elementData.x || 250;
    const y = elementData.y || 200;
    
    element.style.cssText = `
        position: absolute;
        left: ${x}px;
        top: ${y}px;
        cursor: move;
        z-index: 100;
        min-width: 80px;
        min-height: 40px;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.9);
        padding: 5px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    `;
    
    // Create the actual button/element content
    let actualElement;
    if (elementData.html && elementData.html.trim()) {
        if (elementData.html.includes('<')) {
            element.innerHTML = elementData.html;
            actualElement = element.querySelector('*') || element.firstChild;
        } else {
            if (elementData.type === 'button' || elementData.name.toLowerCase().includes('button')) {
                actualElement = document.createElement('button');
                actualElement.textContent = elementData.html;
                actualElement.style.cssText = `
                    padding: 8px 16px; 
                    border: none; 
                    border-radius: 4px; 
                    cursor: pointer; 
                    background: #3b82f6;
                    color: white;
                    font-weight: bold;
                `;
            } else {
                actualElement = document.createElement('div');
                actualElement.textContent = elementData.html;
                actualElement.style.cssText = `
                    padding: 8px; 
                    background: white;
                    border-radius: 4px;
                `;
            }
            element.appendChild(actualElement);
        }
    } else {
        if (elementData.type === 'button') {
            actualElement = document.createElement('button');
            actualElement.textContent = elementData.name || 'Button';
            actualElement.style.cssText = `
                padding: 8px 16px; 
                border: none; 
                border-radius: 4px; 
                cursor: pointer; 
                background: #3b82f6;
                color: white;
                font-weight: bold;
            `;
        } else {
            actualElement = document.createElement('div');
            actualElement.textContent = elementData.name || 'Element';
            actualElement.style.cssText = `
                padding: 8px; 
                background: white;
                border-radius: 4px;
                border: 1px solid #ccc;
            `;
        }
        element.appendChild(actualElement);
    }
    
    // Give it a unique ID - FIXED: Apply to actualElement for CSS/JS targeting
    const uniqueId = 'element_' + Date.now();
    element.id = uniqueId; // Container ID for management
    if (actualElement) {
        actualElement.id = uniqueId + '_content'; // Content ID for CSS/JS targeting
        console.log('Element assigned ID:', uniqueId + '_content');
    }
    
    // Apply CSS to the actual element - FIXED: Use proper CSS parsing
    if (elementData.css) {
        console.log('Applying CSS:', elementData.css);
        
        // Method 1: Try to apply as inline styles first
        try {
            const cssProperties = elementData.css.split(';').filter(prop => prop.trim());
            cssProperties.forEach(prop => {
                const [property, value] = prop.split(':').map(s => s.trim());
                if (property && value) {
                    const camelProperty = property.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());
                    if (actualElement) {
                        actualElement.style[camelProperty] = value;
                    }
                }
            });
        } catch (e) {
            console.warn('Inline CSS application failed, trying style tag method');
        }
        
        // Method 2: Also add as style tag for more complex CSS
        const style = document.createElement('style');
        style.textContent = `#${uniqueId + '_content'} { ${elementData.css} }`;
        document.head.appendChild(style);
    }
    
    // Apply JavaScript - FIXED: Use proper element targeting with comprehensive error handling
   // REPLACE your JavaScript application section with this:

// Apply JavaScript - FIXED: Store and execute with proper ID replacement
if (elementData.javascript && elementData.javascript.trim()) {
    console.log('Applying JavaScript:', elementData.javascript);
    setTimeout(() => {
        try {
            const targetElement = document.getElementById(uniqueId + '_content');
            if (!targetElement) {
                console.warn('Target element not found for JavaScript execution:', uniqueId + '_content');
                return;
            }
            
            // Fix JavaScript by replacing getElementById calls with actual element ID
            let fixedJS = elementData.javascript.trim();
            fixedJS = fixedJS.replace(/document\.getElementById\(['"][^'"]*['"]\)/g, `document.getElementById('${targetElement.id}')`);
            fixedJS = fixedJS.replace(/\bthis\b/g, `document.getElementById('${targetElement.id}')`);
            
            // Store the fixed JavaScript for later extraction (this is the key addition!)
            targetElement._customJS = fixedJS;
            
            // Execute the JavaScript
            const handler = new Function('event', `
                try {
                    ${fixedJS}
                } catch(error) {
                    console.error('Element JavaScript execution error:', error);
                }
            `);
            
            targetElement.addEventListener('click', handler);
            
            console.log('‚úÖ JavaScript stored and executed successfully');
        } catch (e) {
            console.error('Script execution failed:', e);
        }
    }, 150);
}

    // FIXED: Add VISIBLE delete button (from first version)
    const deleteBtn = document.createElement('button');
    deleteBtn.innerHTML = '√ó';
    deleteBtn.title = 'Delete element';
    deleteBtn.style.cssText = `
        position: absolute;
        top: -10px;
        right: -10px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #ef4444;
        color: white;
        border: 2px solid white;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        line-height: 1;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        opacity: 1 !important;
    `;
    
    deleteBtn.onclick = (e) => {
        e.stopPropagation();
        e.preventDefault();
        console.log('Deleting element:', uniqueId);
        element.remove();
    };
    
    deleteBtn.onmousedown = (e) => {
        e.stopPropagation(); // Prevent dragging when clicking delete
    };
    
    element.appendChild(deleteBtn);
    
    // Add resize handles (from second version)
    if (window.addResizeHandles) {
        addResizeHandles(element);
    }
    
    // Make element draggable (simple version from first code, but enhanced)
    let isDragging = false;
    let dragStartX, dragStartY;
    
    element.addEventListener('mousedown', (e) => {
        if (e.target === deleteBtn) return; // Don't drag when clicking delete button
        
        isDragging = true;
        dragStartX = e.clientX - element.offsetLeft;
        dragStartY = e.clientY - element.offsetTop;
        element.style.zIndex = '1001';
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            element.style.left = (e.clientX - dragStartX) + 'px';
            element.style.top = (e.clientY - dragStartY) + 'px';
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            element.style.zIndex = '100';
        }
    });
    
    // Enhanced hover effects (combination of both versions)
    element.addEventListener('mouseenter', () => {
        element.style.borderColor = '#10b981';
        element.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
        deleteBtn.style.opacity = '1';
    });
    
    element.addEventListener('mouseleave', () => {
        if (!isDragging) {
            element.style.borderColor = '#3b82f6';
            element.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            deleteBtn.style.opacity = '1'; // Keep delete button visible
        }
    });
    
    // Add resizable functionality if available
    if (window.makeElementDraggableAndResizable) {
        makeElementDraggableAndResizable(element);
    }
    
    // Add to canvas
    gameCanvas.appendChild(element);
    
    console.log('‚úÖ Element added to canvas with all features: visible delete button, CSS styling, and JavaScript functionality');
    return element;
};

// Function to add resize handles
function addResizeHandles(element) {
    const handles = [
        { class: 'resize-se', cursor: 'se-resize', position: 'bottom: -4px; right: -4px;' },
        { class: 'resize-sw', cursor: 'sw-resize', position: 'bottom: -4px; left: -4px;' },
        { class: 'resize-ne', cursor: 'ne-resize', position: 'top: -4px; right: -4px;' },
        { class: 'resize-nw', cursor: 'nw-resize', position: 'top: -4px; left: -4px;' },
        { class: 'resize-n', cursor: 'n-resize', position: 'top: -4px; left: 50%; transform: translateX(-50%);' },
        { class: 'resize-s', cursor: 's-resize', position: 'bottom: -4px; left: 50%; transform: translateX(-50%);' },
        { class: 'resize-e', cursor: 'e-resize', position: 'right: -4px; top: 50%; transform: translateY(-50%);' },
        { class: 'resize-w', cursor: 'w-resize', position: 'left: -4px; top: 50%; transform: translateY(-50%);' }
    ];
    
    handles.forEach(handle => {
        const resizeHandle = document.createElement('div');
        resizeHandle.className = `resize-handle ${handle.class}`;
        resizeHandle.style.cssText = `
            position: absolute;
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border: 1px solid white;
            border-radius: 50%;
            cursor: ${handle.cursor};
            z-index: 103;
            opacity: 0;
            transition: opacity 0.2s ease;
            ${handle.position}
        `;
        element.appendChild(resizeHandle);
    });
}

// Enhanced draggable and resizable functionality
function makeElementDraggableAndResizable(element) {
    let isDragging = false;
    let isResizing = false;
    let startX, startY, initialX, initialY, initialWidth, initialHeight;
    let resizeDirection = '';
    
    // Show/hide controls on hover
    element.addEventListener('mouseenter', () => {
        element.style.borderColor = '#3b82f6';
        element.querySelectorAll('.resize-handle').forEach(handle => {
            if (handle) handle.style.opacity = '1';
        });
        
        // Find delete button more safely
        const deleteButton = element.querySelector('button');
        if (deleteButton && deleteButton.innerHTML === '√ó') {
            deleteButton.style.opacity = '1';
        }
    });
    
    element.addEventListener('mouseleave', () => {
        if (!isDragging && !isResizing) {
            element.style.borderColor = 'transparent';
            element.querySelectorAll('.resize-handle').forEach(handle => {
                if (handle) handle.style.opacity = '0';
            });
            
            // Find delete button more safely
            const deleteButton = element.querySelector('button');
            if (deleteButton && deleteButton.innerHTML === '√ó') {
                deleteButton.style.opacity = '0';
            }
        }
    });
    
    // Rest of your function stays the same...
    element.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('resize-handle')) {
            isResizing = true;
            resizeDirection = e.target.className.split(' ')[1].replace('resize-', '');
            
            startX = e.clientX;
            startY = e.clientY;
            initialWidth = element.offsetWidth;
            initialHeight = element.offsetHeight;
            initialX = parseInt(element.style.left) || 0;
            initialY = parseInt(element.style.top) || 0;
            
            e.preventDefault();
            e.stopPropagation();
            return;
        }
        
        // Regular dragging
        if (e.target.tagName === 'BUTTON' && e.target.innerHTML === '√ó') return;
        
        isDragging = true;
        const rect = element.getBoundingClientRect();
        const parent = element.parentElement;
        if (!parent) return; // Safety check
        
        const dropZoneRect = parent.getBoundingClientRect();
        
        startX = e.clientX;
        startY = e.clientY;
        initialX = rect.left - dropZoneRect.left;
        initialY = rect.top - dropZoneRect.top;
        
        element.style.zIndex = '200';
        element.style.opacity = '0.8';
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (isResizing) {
            handleResize(e, element, startX, startY, initialX, initialY, initialWidth, initialHeight, resizeDirection);
        } else if (isDragging) {
            handleDrag(e, element, startX, startY, initialX, initialY);
        }
    });
    
    document.addEventListener('mouseup', () => {
        if (isDragging || isResizing) {
            element.style.zIndex = '100';
            element.style.opacity = '1';
            isDragging = false;
            isResizing = false;
            resizeDirection = '';
        }
    });
}

function handleResize(e, element, startX, startY, initialX, initialY, initialWidth, initialHeight, direction) {
    const deltaX = e.clientX - startX;
    const deltaY = e.clientY - startY;
    
    let newWidth = initialWidth;
    let newHeight = initialHeight;
    let newX = initialX;
    let newY = initialY;
    
    // Calculate new dimensions based on resize direction
    switch (direction) {
        case 'se': // bottom-right
            newWidth = Math.max(50, initialWidth + deltaX);
            newHeight = Math.max(30, initialHeight + deltaY);
            break;
        case 'sw': // bottom-left
            newWidth = Math.max(50, initialWidth - deltaX);
            newHeight = Math.max(30, initialHeight + deltaY);
            newX = initialX + (initialWidth - newWidth);
            break;
        case 'ne': // top-right
            newWidth = Math.max(50, initialWidth + deltaX);
            newHeight = Math.max(30, initialHeight - deltaY);
            newY = initialY + (initialHeight - newHeight);
            break;
        case 'nw': // top-left
            newWidth = Math.max(50, initialWidth - deltaX);
            newHeight = Math.max(30, initialHeight - deltaY);
            newX = initialX + (initialWidth - newWidth);
            newY = initialY + (initialHeight - newHeight);
            break;
        case 'n': // top
            newHeight = Math.max(30, initialHeight - deltaY);
            newY = initialY + (initialHeight - newHeight);
            break;
        case 's': // bottom
            newHeight = Math.max(30, initialHeight + deltaY);
            break;
        case 'e': // right
            newWidth = Math.max(50, initialWidth + deltaX);
            break;
        case 'w': // left
            newWidth = Math.max(50, initialWidth - deltaX);
            newX = initialX + (initialWidth - newWidth);
            break;
    }
    
    // Apply new dimensions and position
    element.style.width = newWidth + 'px';
    element.style.height = newHeight + 'px';
    element.style.left = newX + 'px';
    element.style.top = newY + 'px';
}

function handleDrag(e, element, startX, startY, initialX, initialY) {
    const deltaX = e.clientX - startX;
    const deltaY = e.clientY - startY;
    const newX = initialX + deltaX;
    const newY = initialY + deltaY;
    
    // Keep element within bounds
    const dropZone = element.parentElement;
    const maxX = dropZone.offsetWidth - element.offsetWidth;
    const maxY = dropZone.offsetHeight - element.offsetHeight;
    
    element.style.left = `${Math.max(0, Math.min(newX, maxX))}px`;
    element.style.top = `${Math.max(0, Math.min(newY, maxY))}px`;
}

// Game State Management System
class GameStateManager {
    constructor() {
        this.gameState = {
            elements: [],
            metadata: {
                title: '',
                description: '',
                created: null,
                lastModified: null,
                version: '1.0'
            }
        };
    }

    // Load the most recent game for this author
async loadLatestGameFromFirebase() {
    try {
        const gamesRef = db.collection('study-tools')
            .where('authorId', '==', firebase.auth().currentUser?.uid || 'anonymous')
            .where('gameState', '!=', null)
            .orderBy('publishedAt', 'desc')
            .limit(1);
        
        const querySnapshot = await gamesRef.get();
        
        if (!querySnapshot.empty) {
            const doc = querySnapshot.docs[0];
            const data = doc.data();
            // Add this line after successfully loading:
this.currentGameId = doc.id; // Store the current game ID
            return {
                id: doc.id,
                gameState: data.gameState,
                name: data.name,
                description: data.description
            };
        }
        return null;
    } catch (error) {
        console.error('Error loading latest game from Firebase:', error);
        throw error;
    }
}

// Update existing game in Firebase
async updateGameInFirebase(gameId, gameStateData, title = 'My Study Game', description = '') {
    try {
        const docRef = db.collection('study-tools').doc(gameId);
        
        await docRef.update({
            gameState: gameStateData,
            name: title,
            description: description,
            publishedAt: new Date().toISOString()
        });
        
        console.log('Game updated successfully in Firebase');
        return gameId;
    } catch (error) {
        console.error('Error updating game in Firebase:', error);
        throw error;
    }
}

    // Serialize all game elements to JSON
    saveGameState(title = 'My Game', description = '') {
        const gameCanvas = document.getElementById('gameCanvas') || document.getElementById('dropZone');
        if (!gameCanvas) {
            console.error('Game canvas not found');
            return null;
        }

        this.gameState.elements = [];
        this.gameState.metadata = {
            title,
            description,
            created: this.gameState.metadata.created || new Date().toISOString(),
            lastModified: new Date().toISOString(),
            version: '1.0'
        };

        const elements = gameCanvas.querySelectorAll('.custom-game-element, .dropped-element');
        
        elements.forEach((element, index) => {
            const elementData = this.serializeElement(element, index);
            if (elementData) {
                this.gameState.elements.push(elementData);
            }
        });

        console.log('Game state saved:', this.gameState);
        return JSON.stringify(this.gameState, null, 2);
    }

    // Serialize individual element
 // Add this after extracting events in serializeElement method
serializeElement(element, index) {
    try {
        const interactiveElement = element.querySelector('button, input, div[contenteditable], div:not(.resize-handle):not([style*="position: absolute"])') 
                                || element.firstElementChild;
        const actualElement = element.querySelector('*:not(button[title="Delete element"])') || element;

        
        if (!interactiveElement || interactiveElement.classList.contains('resize-handle') || 
            interactiveElement.innerHTML === '√ó') {
            return null;
        }

        // GET COMPUTED STYLES FOR ACCURATE DIMENSIONS
        const containerStyles = window.getComputedStyle(element);
        const elementStyles = window.getComputedStyle(interactiveElement);

        const elementData = {
            id: `element_${index}_${Date.now()}`,
            type: interactiveElement.tagName.toLowerCase(),
            position: {
                x: parseInt(element.style.left) || 0,
                y: parseInt(element.style.top) || 0,
                containerWidth: containerStyles.width,
                containerHeight: containerStyles.height,
                elementWidth: elementStyles.width,
                elementHeight: elementStyles.height
            },
            content: {
                text: interactiveElement.textContent || interactiveElement.value || '',
                html: interactiveElement.innerHTML || '',
                placeholder: interactiveElement.placeholder || ''
            },
            styles: this.extractStyles(interactiveElement),
            events: this.extractEventListeners(interactiveElement),
            properties: this.extractProperties(interactiveElement),
            containerStyles: this.extractStyles(element),
            // ADD THIS LINE:
            javascript: this.extractJavaScript(interactiveElement)
            
        };

        // ADD this section at the end of your serializeElement method, just before the return statement:

        // Extract JavaScript in Firebase format
        if (actualElement._customJS) {
            elementData.javascript = {
                clickEvents: [{
                    code: actualElement._customJS,
                    event: "click"
                }],
                customFunctions: [],
                eventHandlers: {},
                inlineScripts: []
            };
            console.log('‚úÖ Extracted JavaScript for Firebase:', elementData.javascript);
        } else {
            elementData.javascript = {
                clickEvents: [],
                customFunctions: [],
                eventHandlers: {},
                inlineScripts: []
            };
        }
        

        return elementData;
    } catch (error) {
        console.error('Error serializing element:', error);
        return null;
    }
}

// Extract any JavaScript code associated with element
extractJavaScript(element) {
    const jsData = {
        inlineScripts: [],
        eventHandlers: {},
        customFunctions: [],
        clickEvents: [],
        dynamicProperties: {},
        elementBindings: {}
    };

    try {
        console.log('Extracting JavaScript from element:', element.id || element.tagName);

        // 1. CAPTURE STORED CUSTOM JAVASCRIPT
        // This handles custom JS that was added programmatically
        if (element._customJS) {
            jsData.customFunctions.push({
                type: 'custom',
                code: element._customJS.trim(),
                timestamp: Date.now()
            });
            console.log('‚úÖ Captured custom JS:', element._customJS.substring(0, 50) + '...');
        }

        // 2. CAPTURE ALL INLINE EVENT HANDLERS FROM ATTRIBUTES
        // Comprehensive list of all possible event attributes
        const eventAttributes = [
            'onclick', 'ondblclick', 'onmousedown', 'onmouseup', 'onmouseover', 
            'onmouseout', 'onmousemove', 'onmouseenter', 'onmouseleave',
            'onchange', 'oninput', 'onkeydown', 'onkeyup', 'onkeypress',
            'onfocus', 'onblur', 'onsubmit', 'onreset', 'onselect',
            'onload', 'onerror', 'onabort', 'onresize', 'onscroll'
        ];

        eventAttributes.forEach(eventAttr => {
            const handler = element.getAttribute(eventAttr);
            if (handler && handler.trim()) {
                const eventType = eventAttr.substring(2); // Remove 'on' prefix
                if (!jsData.eventHandlers[eventType]) {
                    jsData.eventHandlers[eventType] = [];
                }
                jsData.eventHandlers[eventType].push({
                    source: 'attribute',
                    code: handler.trim()
                });
                console.log(`‚úÖ Captured ${eventAttr} handler`);
            }
        });

        // 3. CAPTURE ADDEVENTLISTENER FUNCTIONS
        // Enhanced capture of programmatically added event listeners
        if (element._eventListeners) {
            Object.entries(element._eventListeners).forEach(([eventType, handlers]) => {
                if (!Array.isArray(handlers)) handlers = [handlers];
                
                handlers.forEach((handler, index) => {
                    let handlerCode = '';
                    
                    if (typeof handler === 'function') {
                        handlerCode = handler.toString();
                    } else if (typeof handler === 'string') {
                        handlerCode = handler;
                    } else if (handler && handler.toString) {
                        handlerCode = handler.toString();
                    }

                    if (handlerCode && handlerCode !== '[object Object]') {
                        jsData.clickEvents.push({
                            event: eventType,
                            code: handlerCode,
                            source: 'addEventListener',
                            index: index
                        });
                        console.log(`‚úÖ Captured addEventListener ${eventType} #${index}`);
                    }
                });
            });
        }

        // 4. CAPTURE DIRECT FUNCTION PROPERTIES
        // Get all function properties attached directly to the element
        Object.getOwnPropertyNames(element).forEach(prop => {
            try {
                const value = element[prop];
                if (typeof value === 'function') {
                    // Handle event handler functions (onXXX properties)
                    if (prop.startsWith('on') && prop.length > 2) {
                        const eventType = prop.substring(2).toLowerCase();
                        if (!jsData.eventHandlers[eventType]) {
                            jsData.eventHandlers[eventType] = [];
                        }
                        jsData.eventHandlers[eventType].push({
                            source: 'property',
                            code: value.toString()
                        });
                        console.log(`‚úÖ Captured direct property ${prop}`);
                    }
                    // Handle custom function properties
                    else if (!prop.startsWith('_') && 
                             !['constructor', 'toString', 'valueOf'].includes(prop) &&
                             !prop.includes('HTML') && 
                             !prop.includes('DOM')) {
                        jsData.customFunctions.push({
                            type: 'property',
                            name: prop,
                            code: value.toString()
                        });
                        console.log(`‚úÖ Captured custom function property: ${prop}`);
                    }
                }
            } catch (error) {
                console.warn(`Error capturing property ${prop}:`, error);
            }
        });

        // 5. CAPTURE DYNAMIC BEHAVIORS AND STATE
        // Store any dynamic state that needs to be restored
        if (element.dataset) {
            Object.entries(element.dataset).forEach(([key, value]) => {
                if (key.startsWith('js') || key.includes('handler') || key.includes('function')) {
                    jsData.dynamicProperties[`data-${key}`] = value;
                }
            });
        }

        // 6. CAPTURE STYLE TRANSITIONS AND ANIMATIONS
        // Some JavaScript might be embedded in CSS animations or transitions
        const computedStyle = window.getComputedStyle(element);
        if (computedStyle.transition && computedStyle.transition !== 'none') {
            jsData.dynamicProperties.transition = computedStyle.transition;
        }
        if (computedStyle.animation && computedStyle.animation !== 'none') {
            jsData.dynamicProperties.animation = computedStyle.animation;
        }

        // 7. CAPTURE ELEMENT BINDINGS AND REFERENCES
        // Store references to other elements this element might interact with
        jsData.elementBindings = {
            id: element.id,
            className: element.className,
            tagName: element.tagName,
            parentId: element.parentElement ? element.parentElement.id : null
        };

        // 8. DETECT AND CAPTURE CLOSURE VARIABLES
        // Try to capture any closure variables stored on the element
        if (element._closureVars) {
            jsData.dynamicProperties._closureVars = JSON.stringify(element._closureVars);
        }

        console.log('‚úÖ JavaScript extraction completed. Captured:', {
            customFunctions: jsData.customFunctions.length,
            eventHandlers: Object.keys(jsData.eventHandlers).length,
            clickEvents: jsData.clickEvents.length,
            dynamicProperties: Object.keys(jsData.dynamicProperties).length
        });

        // 9. STORE JAVASCRIPT DATA ON ELEMENT FOR gameStateManager
        // This ensures gameStateManager.saveGameState() will capture the JavaScript
        element._extractedJavaScript = jsData;
        element._lastJavaScriptExtraction = Date.now();

        return jsData;

    } catch (error) {
        console.error('Error extracting JavaScript:', error);
        return jsData; // Return partial data rather than failing completely
    }
}


// Extract computed styles
   // Update your extractStyles function too
// Update your extractStyles function too
extractStyles(element) {
    const computedStyles = window.getComputedStyle(element);
    const importantStyles = [
        'backgroundColor', 'color', 'fontSize', 'fontWeight', 'fontFamily',
        'padding', 'margin', 'border', 'borderRadius', 'boxShadow',
        'textAlign', 'display', 'cursor', 'opacity', 'transform'
    ];

    const styles = {};
    importantStyles.forEach(property => {
        const value = computedStyles[property];
        if (value && value !== 'initial' && value !== 'normal') {
            styles[property] = value;
        }
    });

    // Only store the cssText, not the array-like properties
    if (element.style.cssText) {
        styles.inline = element.style.cssText;
    }

    return styles;
}

// Restore JavaScript functionality
// Replace your existing restoreJavaScript function with this fixed version
restoreJavaScript(element, javascriptData) {
    try {
        // Validate inputs first
        if (!element || !javascriptData) {
            console.warn('Invalid element or javascriptData provided');
            return;
        }

        // Ensure element is in DOM and ready
        if (!document.body.contains(element)) {
            console.warn('Element not in DOM, retrying...');
            setTimeout(() => this.restoreJavaScript(element, javascriptData), 100);
            return;
        }

        // Create a safe execution context
        const createSafeExecutionContext = (targetElement) => {
            return {
                element: targetElement,
                document: document,
                console: console,
                setTimeout: setTimeout,
                Math: Math
            };
        };

        // Create a dynamic handler function for this specific element
        const createDynamicHandler = (element) => {
            return function handler(elementRef, event) {
                console.log('Handler called for element:', elementRef?.id || 'unknown');
                // Default handler behavior can be added here
            };
        };

        // Handle click events from Firebase structure
        if (javascriptData.clickEvents && Array.isArray(javascriptData.clickEvents)) {
            javascriptData.clickEvents.forEach(eventData => {
                try {
                    let code = eventData.code;
                    if (!code || typeof code !== 'string') return;
                    
                    // Wait for element to be ready
                    setTimeout(() => {
                        try {
                            // Check if element still exists and has addEventListener
                            if (!element || !element.addEventListener || !document.body.contains(element)) {
                                console.warn('Element not ready for event binding');
                                return;
                            }

                            // Check if code references a 'handler' function
                            if (code.includes('handler(this, event)')) {
                                const dynamicHandler = createDynamicHandler(element);
                                code = code.replace('handler(this, event)', 'arguments.callee.handler(this, event)');
                                
                                const handlerFunc = new Function('event', code);
                                handlerFunc.handler = dynamicHandler;
                                element.addEventListener(eventData.event || 'click', handlerFunc);
                            } else {
                                // Clean up function wrapper if present
                                if (code.startsWith('function')) {
                                    code = code.replace(/^function[^{]*{/, '').replace(/}$/, '');
                                }
                                
                                // Fix 'this' references to use the element
                                code = code.replace(/\bthis\./g, 'this.');
                                
                                const handler = new Function('event', code);
                                element.addEventListener(eventData.event || 'click', handler.bind(element));
                            }
                        } catch (error) {
                            console.error('Error binding click event:', error);
                        }
                    }, 150);
                } catch (error) {
                    console.error('Error processing click event:', error);
                }
            });
        }

        // Handle custom functions from Firebase structure
        if (javascriptData.customFunctions && Array.isArray(javascriptData.customFunctions)) {
            javascriptData.customFunctions.forEach(funcData => {
                try {
                    if (!funcData.code || funcData.type !== 'custom') return;
                    
                    let code = funcData.code;
                    
                    // Fix ID references - replace hardcoded IDs with current element ID
                    const idMatches = code.match(/getElementById\(['"`]([^'"`]+)['"`]\)/g);
                    if (idMatches && element.id) {
                        idMatches.forEach(match => {
                            const hardcodedId = match.match(/getElementById\(['"`]([^'"`]+)['"`]\)/)[1];
                            console.log(`Replacing hardcoded ID '${hardcodedId}' with actual ID '${element.id}'`);
                            code = code.replace(
                                new RegExp(`getElementById\\(['"\`]${hardcodedId}['"\`]\\)`, 'g'),
                                `getElementById('${element.id}')`
                            );
                        });
                    }

                    // Replace getElementById calls with direct element reference
                    code = code.replace(
                        /document\.getElementById\(['"`][^'"`]+['"`]\)/g,
                        'element'
                    );

                    // Execute with proper timing and safety
                    setTimeout(() => {
                        try {
                            // Final check that element is still valid
                            if (!element || !document.body.contains(element)) {
                                console.warn('Element no longer valid for custom function execution');
                                return;
                            }

                            // Create safe execution environment
                            const context = createSafeExecutionContext(element);
                            
                            // Create function with controlled scope
                            const func = new Function(
                                'element', 'document', 'console', 'setTimeout', 'Math',
                                `
                                try {
                                    ${code}
                                } catch (e) {
                                    console.error('Error in custom function execution:', e);
                                    return false;
                                }
                                return true;
                                `
                            );
                            
                            const result = func(
                                context.element, 
                                context.document, 
                                context.console, 
                                context.setTimeout, 
                                context.Math
                            );
                            
                            if (result) {
                                console.log('‚úÖ Custom function executed successfully');
                            }
                        } catch (evalError) {
                            console.error('Error executing custom function:', evalError);
                            
                            // Fallback for common color-changing functionality
                            if (code.includes('addEventListener') && code.includes('backgroundColor')) {
                                console.log('Applying fallback color-changing event listener');
                                if (element && element.addEventListener) {
                                    element.addEventListener('click', function() {
                                        this.style.backgroundColor = 'rgb(' + 
                                            Math.floor(Math.random()*256) + ',' + 
                                            Math.floor(Math.random()*256) + ',' + 
                                            Math.floor(Math.random()*256) + ')';
                                    });
                                }
                            }
                        }
                    }, 200);
                } catch (error) {
                    console.error('Error processing custom function:', error);
                }
            });
        }

        // Handle event handlers from Firebase structure
        if (javascriptData.eventHandlers && typeof javascriptData.eventHandlers === 'object') {
            Object.entries(javascriptData.eventHandlers).forEach(([eventType, handlers]) => {
                if (!Array.isArray(handlers)) return;
                
                handlers.forEach(handlerData => {
                    setTimeout(() => {
                        try {
                            // Verify element is still valid
                            if (!element || !element.addEventListener || !document.body.contains(element)) {
                                console.warn(`Element not ready for ${eventType} handler`);
                                return;
                            }

                            let code = handlerData.code || handlerData;
                            if (typeof code !== 'string') return;
                            
                            // Clean up function wrapper
                            if (code.startsWith('function')) {
                                code = code.replace(/^function[^{]*{/, '').replace(/}$/, '');
                            }
                            
                            // Fix element references
                            code = code.replace(
                                /document\.getElementById\(['"`][^'"`]+['"`]\)/g,
                                'this'
                            );
                            
                            const handler = new Function('event', code);
                            element.addEventListener(eventType, handler);
                            console.log(`‚úÖ Event handler attached for ${eventType}`);
                        } catch (error) {
                            console.error(`Error restoring ${eventType} handler:`, error);
                        }
                    }, 100);
                });
            });
        }

        // Handle inline scripts
        if (javascriptData.inlineScripts && Array.isArray(javascriptData.inlineScripts)) {
            javascriptData.inlineScripts.forEach(scriptData => {
                setTimeout(() => {
                    try {
                        // Verify element is still valid
                        if (!element || !document.body.contains(element)) {
                            console.warn('Element not ready for inline script');
                            return;
                        }

                        let code = scriptData.code || scriptData;
                        if (typeof code !== 'string') return;
                        
                        // Fix element references
                        code = code.replace(
                            /document\.getElementById\(['"`][^'"`]+['"`]\)/g,
                            'element'
                        );
                        
                        const context = createSafeExecutionContext(element);
                        const func = new Function(
                            'element', 'document', 'console', 'setTimeout', 'Math',
                            code
                        );
                        func(
                            context.element,
                            context.document,
                            context.console,
                            context.setTimeout,
                            context.Math
                        );
                        console.log('‚úÖ Inline script executed');
                    } catch (error) {
                        console.error('Error executing inline script:', error);
                    }
                }, 150);
            });
        }

        // Legacy support - if javascript data is a string (old format)
        if (typeof javascriptData === 'string') {
            setTimeout(() => {
                try {
                    // Verify element is still valid
                    if (!element || !document.body.contains(element)) {
                        console.warn('Element not ready for legacy JavaScript');
                        return;
                    }

                    let code = javascriptData;
                    code = code.replace(
                        /document\.getElementById\(['"`][^'"`]+['"`]\)/g,
                        'element'
                    );
                    
                    const context = createSafeExecutionContext(element);
                    const func = new Function(
                        'element', 'document', 'console', 'setTimeout', 'Math',
                        `
                        try {
                            if (!element || !element.nodeType) {
                                console.warn('Invalid element for legacy JavaScript');
                                return;
                            }
                            ${code}
                        } catch (e) {
                            console.error('Error in legacy JavaScript:', e);
                        }
                        `
                    );
                    func(
                        context.element,
                        context.document,
                        context.console,
                        context.setTimeout,
                        context.Math
                    );
                    console.log('‚úÖ Legacy JavaScript executed');
                } catch (error) {
                    console.error('Error executing legacy JavaScript:', error);
                }
            }, 200);
        }

        console.log('‚úÖ restoreJavaScript completed for element:', element.id);

    } catch (error) {
        console.error('Critical error in restoreJavaScript:', error);
        // Don't throw - just log and continue
    }
}

// Extract event listeners
    extractEventListeners(element) {
        const events = {};
        
        if (element.onclick) {
            events.click = element.onclick.toString();
        }

        const eventTypes = ['click', 'mouseover', 'mouseout', 'change', 'input'];
        eventTypes.forEach(eventType => {
            const handler = element[`on${eventType}`];
            if (handler && typeof handler === 'function') {
                events[eventType] = handler.toString();
            }
        });

        return events;
    }

    // Extract element properties
    extractProperties(element) {
        const properties = {
            tagName: element.tagName,
            className: element.className,
            id: element.id,
            name: element.name || '',
            type: element.type || '',
            disabled: element.disabled || false,
            readonly: element.readonly || false,
            contentEditable: element.contentEditable || false
        };

        Array.from(element.attributes).forEach(attr => {
            if (attr.name.startsWith('data-')) {
                properties[attr.name] = attr.value;
            }
        });

        return properties;
    }

    // Load and recreate game state
    loadGameState(gameStateJson) {
        try {
            const gameState = JSON.parse(gameStateJson);
            this.gameState = gameState;
            
            const gameCanvas = document.getElementById('gameCanvas') || document.getElementById('dropZone');
            if (!gameCanvas) {
                console.error('Game canvas not found');
                return false;
            }

            const existingElements = gameCanvas.querySelectorAll('.custom-game-element, .dropped-element');
            existingElements.forEach(element => element.remove());

            gameState.elements.forEach(elementData => {
                this.recreateElement(elementData, gameCanvas);
            });

            console.log('Game state loaded successfully');
            return true;
        } catch (error) {
            console.error('Error loading game state:', error);
            return false;
        }
    }

    // Recreate individual element
   // Replace your recreateElement function with this fixed version
// Replace your recreateElement function with this fixed version

recreateElement(elementData, gameCanvas) {
    try {
        console.log('Element events to restore:', elementData.events);
        const container = document.createElement('div');
        container.className = 'custom-game-element';
        container.style.cssText = `
            position: absolute;
            left: ${elementData.position.x}px;
            top: ${elementData.position.y}px;
            width: ${elementData.position.containerWidth || '200px'};
            height: ${elementData.position.containerHeight || '40px'};
            cursor: move;
            z-index: 100;
            min-width: 50px;
            min-height: 30px;
            border: 2px solid transparent;
            transition: border-color 0.2s ease;
        `;

        const interactiveElement = document.createElement(elementData.type);
        interactiveElement.id = elementData.id;

        // Restore content
        if (elementData.content.text && !elementData.content.html.includes('<')) {
            interactiveElement.textContent = elementData.content.text;
        } else if (elementData.content.html) {
            interactiveElement.innerHTML = elementData.content.html;
        }

        if (elementData.content.placeholder) {
            interactiveElement.placeholder = elementData.content.placeholder;
        }

        // Apply properties BEFORE styles
        if (elementData.properties) {
            Object.entries(elementData.properties).forEach(([prop, value]) => {
                try {
                    if (prop.startsWith('data-')) {
                        interactiveElement.setAttribute(prop, value);
                    } else if (prop in interactiveElement && prop !== 'tagName') {
                        interactiveElement[prop] = value;
                    }
                } catch (error) {
                    console.warn(`Failed to set property ${prop}:`, error);
                }
            });
        }

        // RESTORE EXACT DIMENSIONS
        if (elementData.position.elementWidth && elementData.position.elementHeight) {
            interactiveElement.style.width = elementData.position.elementWidth;
            interactiveElement.style.height = elementData.position.elementHeight;
        } else {
            // Fallback to fill container
            interactiveElement.style.width = '100%';
            interactiveElement.style.height = '100%';
        }
        interactiveElement.style.boxSizing = 'border-box';

        // Apply other styles
        if (elementData.styles) {
            Object.entries(elementData.styles).forEach(([property, value]) => {
                try {
                    if (property !== 'inline' && property !== 'width' && property !== 'height' && 
                        value && typeof value === 'string') {
                        
                        if (!isNaN(property) || property === 'length') {
                            return;
                        }
                        
                        const kebabProperty = property.replace(/([A-Z])/g, '-$1').toLowerCase();
                        interactiveElement.style.setProperty(kebabProperty, value);
                    }
                } catch (styleError) {
                    console.warn(`Failed to apply style ${property}: ${value}`, styleError);
                }
            });

            // Apply inline styles (excluding dimensions)
            if (elementData.styles.inline) {
                try {
                    const inlineStyles = elementData.styles.inline.split(';');
                    inlineStyles.forEach(style => {
                        const [prop, val] = style.split(':').map(s => s.trim());
                        if (prop && val && !prop.includes('width') && !prop.includes('height')) {
                            interactiveElement.style.setProperty(prop, val);
                        }
                    });
                } catch (inlineError) {
                    console.warn('Failed to apply inline styles:', inlineError);
                }
            }
        }

        // Restore event listeners
        if (elementData.events) {
            Object.entries(elementData.events).forEach(([eventType, handlerString]) => {
                try {
                    let cleanHandler = handlerString;
                    if (cleanHandler.startsWith('function')) {
                        cleanHandler = cleanHandler.replace(/^function[^{]*{/, '').replace(/}$/, '');
                    }
                    
                    const handler = new Function('event', cleanHandler);
                    interactiveElement.addEventListener(eventType, handler);
                } catch (error) {
                    console.error(`Error recreating ${eventType} event:`, error);
                }
            });
        }

        // ‚úÖ ENHANCED JAVASCRIPT RESTORATION - This is the key addition!
        if (elementData.javascript) {
            this.restoreJavaScript(interactiveElement, elementData.javascript);
        }

        container.appendChild(interactiveElement);

        // Add delete button and drag functionality...
        const deleteBtn = document.createElement('button');
        deleteBtn.innerHTML = '√ó';
        deleteBtn.style.cssText = `
            position: absolute; top: -8px; right: -8px; width: 20px; height: 20px;
            border-radius: 50%; background: #ef4444; color: white; border: none;
            cursor: pointer; font-size: 14px; line-height: 1; z-index: 102;
            opacity: 0; transition: opacity 0.2s ease;
        `;
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            container.remove();
        };
        container.appendChild(deleteBtn);

        this.makeDraggable(container);

        container.addEventListener('mouseenter', () => {
            deleteBtn.style.opacity = '1';
        });
        container.addEventListener('mouseleave', () => {
            deleteBtn.style.opacity = '0';
        });

        gameCanvas.appendChild(container);

    } catch (error) {
        console.error('Error recreating element:', error);
    }
}

// ADD: Make sure drag functionality is restored
makeDraggable(element) {
    let isDragging = false;
    let startX, startY, startLeft, startTop;

    element.addEventListener('mousedown', (e) => {
        if (e.target.innerHTML === '√ó') return; // Don't drag when clicking delete button
        
        isDragging = true;
        element.style.cursor = 'grabbing';
        
        startX = e.clientX;
        startY = e.clientY;
        startLeft = parseInt(element.style.left) || 0;
        startTop = parseInt(element.style.top) || 0;
        
        e.preventDefault();
    });

    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        element.style.left = `${startLeft + deltaX}px`;
        element.style.top = `${startTop + deltaY}px`;
    });

    document.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            element.style.cursor = 'move';
        }
    });
}

// Update existing game in Firebase
async updateGameInFirebase(gameId, gameStateData, title = 'My Study Game', description = '') {
    try {
        const docRef = db.collection('study-tools').doc(gameId);
        
        await docRef.update({
            gameState: gameStateData,
            name: title,
            description: description,
            publishedAt: new Date().toISOString()
        });
        
        console.log('‚úÖ Game updated successfully in Firebase document:', gameId);
        return gameId;
    } catch (error) {
        console.error('‚ùå Error updating game in Firebase:', error);
        throw error;
    }
}


    // Export as static HTML (NO SCRIPT TAGS)
    exportAsStandaloneGame() {
        const gameState = this.saveGameState();
        const gameData = JSON.parse(gameState);
        
        let elementsHTML = '';
        gameData.elements.forEach(elementData => {
            const styles = this.buildInlineStyles(elementData.styles);
            const containerStyles = `position: absolute; left: ${elementData.position.x}px; top: ${elementData.position.y}px; width: ${elementData.position.width}px; height: ${elementData.position.height}px;`;
            
            let eventHandlers = '';
            if (elementData.events && elementData.events.click) {
                const cleanHandler = elementData.events.click.replace(/^function[^{]*{/, '').replace(/}$/, '');
                eventHandlers = `onclick="${cleanHandler.replace(/"/g, '&quot;')}"`;
            }
            
            elementsHTML += `
                <div style="${containerStyles}">
                    <${elementData.type} style="${styles} width: 100%; height: 100%; box-sizing: border-box;" ${eventHandlers}>${elementData.content.text || elementData.content.html}</${elementData.type}>
                </div>
            `;
        });
        
        return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${gameData.metadata.title}</title>
    <style>
        body { margin: 0; padding: 20px; font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .game-container { position: relative; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); min-height: 600px; max-width: 1200px; margin: 0 auto; }
        .game-title { text-align: center; color: #333; margin-bottom: 30px; font-size: 2rem; }
        #gameArea { position: relative; min-height: 500px; }
    </style>
</head>
<body>
    <div class="game-container">
        <h1 class="game-title">${gameData.metadata.title}</h1>
        <div id="gameArea">${elementsHTML}</div>
    </div>
</body>
</html>`;
    }

    buildInlineStyles(stylesObj) {
        if (!stylesObj) return '';
        
        let styleString = '';
        Object.entries(stylesObj).forEach(([property, value]) => {
            if (property !== 'inline' && value) {
                const kebabProperty = property.replace(/([A-Z])/g, '-$1').toLowerCase();
                styleString += `${kebabProperty}: ${value}; `;
            }
        });
        
        if (stylesObj.inline) {
            styleString += stylesObj.inline;
        }
        
        return styleString.trim();
    }
}


// Initialize
const gameStateManager = new GameStateManager();

// Add this function (paste this in)
async function handlePublishSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const toolData = {
        name: formData.get('toolName'),
        description: formData.get('toolDescription'),
        tags: formData.get('toolTags'),
        coverImage: formData.get('coverImage'),
        gameState: localStorage.getItem('lastGameId'),
        publishedAt: new Date().toISOString(),
         landingTemplate: getCurrentSelectedTemplate() 
    };

    // Save to Firebase with JavaScript included
    try {
        const gameId = localStorage.getItem('lastGameId');
        
        // USE gameStateManager to get complete game state with JavaScript
        // Get the existing game state from what's currently loaded, don't create new one
let gameStateData;
if (gameStateManager.gameState && gameStateManager.gameState.elements.length > 0) {
    // Use existing loaded game state
    gameStateData = gameStateManager.gameState;
    gameStateData.metadata.title = toolData.name;
    gameStateData.metadata.description = toolData.description;
    gameStateData.metadata.lastModified = new Date().toISOString();
} else {
    // Fallback: scan current canvas
    const gameStateJson = gameStateManager.saveGameState(toolData.name, toolData.description);
    gameStateData = JSON.parse(gameStateJson);
}
        
        // Handle cover image upload to Firebase Storage if exists
        // Handle cover image - convert to base64 instead of uploading to Storage
let coverImageData = null;
const coverImageFile = toolData.coverImage;
if (coverImageFile && coverImageFile instanceof File && coverImageFile.size > 0) {
    try {
        // Convert image to base64
        coverImageData = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(coverImageFile);
        });
        console.log('Image converted to base64');
    } catch (error) {
        console.warn('Image conversion failed:', error);
    }
} else {
    console.log('No image file to upload');
}
        
        const firebaseData = {
            name: toolData.name,
            description: toolData.description,
            tags: formData.get('toolTags'),
            coverImage: coverImageData,
            gameState: gameStateData, // Now includes JavaScript from gameStateManager
            publishedAt: toolData.publishedAt,
            id: gameId,
            authorId: firebase.auth().currentUser?.uid || 'anonymous'
        };
        
        await firebase.firestore().collection('study-tools').doc(gameId).set(firebaseData);
        console.log('‚úÖ Saved to Firebase successfully with JavaScript:', firebaseData);
        console.log('Elements with JS saved:', firebaseData.gameState.elements.map(el => ({
            type: el.type,
            hasJavaScript: !!el.javascript,
            jsData: el.javascript
        })));
    } catch (error) {
        console.error('‚ùå Firebase save failed:', error);
    }
    
    // Your original success message UI (EXACTLY as you had it)
    const gameCanvas = document.getElementById('gameCanvas');
    gameCanvas.innerHTML = `
        <div class="deploy-success-container">
            <div class="deploy-success-icon">üéÆ</div>
            <h2 class="deploy-success-title">Study Tool Published!</h2>
            <p class="success-message">Your tool "${toolData.name}" is now live and ready to share!</p>
            
            <div class="deploy-success-actions">
               <button class="deploy-action-btn edit-btn" onclick="updateGameMode()">Edit Tool</button>
                <button class="deploy-action-btn preview-btn" onclick="exportGamePreview()">
                    Preview Tool
                </button>
            </div>
        </div>
        
        <style>
            .deploy-success-container {
                width: 100%;
                height: 100vh;
                background: #e5e7eb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                box-sizing: border-box;
            }
            
            .deploy-success-icon {
                font-size: 4rem;
                margin-bottom: 24px;
                animation: bounceIn 0.6s ease-out;
            }
            
            .deploy-success-title {
                color: #1f2937;
                font-size: 2.2rem;
                font-weight: 700;
                margin-bottom: 16px;
                text-align: center;
            }
            
            .success-message {
                color: #6b7280;
                font-size: 1.1rem;
                margin-bottom: 32px;
                text-align: center;
                max-width: 500px;
            }
            
            .deploy-success-actions {
                display: flex;
                gap: 16px;
            }
            
            .deploy-action-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 120px;
            }
            
            .edit-btn {
                background: #374151;
                color: white;
            }
            
            .edit-btn:hover {
                background: #1f2937;
                transform: translateY(-2px);
            }
            
            .preview-btn {
                background: transparent;
                color: #374151;
                border: 2px solid #d1d5db;
            }
            
            .preview-btn:hover {
                background: #f9fafb;
                transform: translateY(-2px);
            }
            
            @keyframes bounceIn {
                0% { transform: scale(0.3); opacity: 0; }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); opacity: 1; }
            }
        </style>
    `;
    
    console.log('Tool published with JavaScript:', toolData);
}

function getCurrentSelectedTemplate() {
    const activeSlide = document.querySelector('.slide.active');
    return activeSlide ? parseInt(activeSlide.dataset.template) : 1;
}

function showUpdateConfirmation() {
    const modal = document.getElementById('confirmationModal');
    modal.classList.add('show');
    
    // Handle confirm button
    document.getElementById('confirmUpdate').onclick = async () => {
        hideUpdateConfirmation();
        await performUpdate();
    };
    
    // Handle cancel button
    document.getElementById('cancelUpdate').onclick = () => {
        hideUpdateConfirmation();
    };
    
    // Close on backdrop click
    modal.onclick = (e) => {
        if (e.target === modal) {
            hideUpdateConfirmation();
        }
    };
}

function hideUpdateConfirmation() {
    const modal = document.getElementById('confirmationModal');
    modal.classList.remove('show');
}

async function performUpdate() {
    try {
        // Get current game state
        const gameStateJson = gameStateManager.saveGameState('My Study Game', 'Updated game');
        const gameStateData = JSON.parse(gameStateJson);
        
        // Get the current game ID
        const currentGameId = gameStateManager.currentGameId;
        
        if (!currentGameId) {
            alert('No game to update. Please load a game first.');
            return;
        }
        
        // Update in Firebase
        await gameStateManager.updateGameInFirebase(currentGameId, gameStateData, 'My Study Game', 'Updated game');
        
        showSuccessNotification();
    } catch (error) {
        console.error('Error updating game:', error);
        alert('Failed to update game');
    }
}

// Replace your deployGame function with this:
function deployGame() {
    const gameTitle = 'My Study Game';
    
    const gameStateJson = gameStateManager.saveGameState(gameTitle, '');
    
    if (!gameStateJson) {
        alert('No elements to save! Add some elements to your game first.');
        return;
    }
    
    const gameId = 'game_' + Date.now();
    localStorage.setItem(gameId, gameStateJson);
    localStorage.setItem('lastGameId', gameId);
    
    const gameCanvas = document.getElementById('gameCanvas');
    gameCanvas.innerHTML = `
        <div class="deploy-form-container">
            <div class="deploy-form-card">
                <div class="form-header">
                    <div class="header-accent"></div>
                    <h2>Publish Your Study Tool</h2>
                    <p>Share your creation with educators and learners</p>
                </div>
                
                <form class="publish-form" onsubmit="handleFormSubmit(event)">
                    <div class="form-group">
                        <label for="toolName">Tool Name</label>
                        <input type="text" id="toolName" name="toolName" required 
                               placeholder="Enter a descriptive name for your study tool" 
                               value="${gameTitle}">
                    </div>
                    
                    <div class="form-group">
                        <label for="toolDescription">Description</label>
                        <textarea id="toolDescription" name="toolDescription" required 
                                  placeholder="Describe what your study tool teaches and how it helps learners achieve their goals..."
                                  rows="4"></textarea>
                    </div>

                    <div class="form-group">
    <label for="toolTags">FBLA Category</label>
    <div class="tag-selection-container">
        <div class="predefined-tags">
            <button type="button" class="tag-btn" data-tag="written" onclick="selectTag('written')">Written</button>
            <button type="button" class="tag-btn" data-tag="speaking" onclick="selectTag('speaking')">Speaking</button>
            <button type="button" class="tag-btn" data-tag="case" onclick="selectTag('case')">Case Study</button>
            
        </div>
        <div class="custom-tag-input">
            <input type="text" id="customTag" placeholder="Or type your own category..." 
                   onkeyup="handleCustomTag(event)" oninput="clearSelectedTags()">
        </div>
        <input type="hidden" id="toolTags" name="toolTags" required>
    </div>
    <div id="selectedTagDisplay" class="selected-tag-display"></div>
</div>
                    
                    <div class="form-group">
                        <label for="coverImage">Cover Image</label>
                        <div class="file-upload-area" onclick="document.getElementById('coverImage').click()">
                            <div class="upload-content">
                                <div class="upload-icon-wrapper">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <circle cx="8.5" cy="8.5" r="1.5"/>
                                        <polyline points="21,15 16,10 5,21"/>
                                    </svg>
                                </div>
                                <div class="upload-text">
                                    <span class="upload-title">Choose a cover image</span>
                                    <span class="upload-subtitle">PNG, JPG up to 5MB</span>
                                </div>
                            </div>
                            <input type="file" id="coverImage" name="coverImage" 
                                   accept="image/*" style="display: none;" 
                                   onchange="handleImageUpload(event)">
                        </div>
                        <div id="imagePreview" class="image-preview" style="display: none;"></div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="editGame()">
                            Back to Edit
                        </button>
                        <button type="submit" class="btn-primary">
                            <span class="btn-text">Publish Tool</span>
                            <div class="btn-shine"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <style>
            .deploy-form-container {
                width: 100%;
                height: 100vh;
                min-height: 650px;
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
                box-sizing: border-box;
            }

            .deploy-form-card::-webkit-scrollbar {
    display: none;
}
            
            .deploy-form-card {
                background: white;
                border: 1px solid #e9ecef;
                border-radius: 12px;
                box-shadow: 0 4px 20px rgba(26, 115, 232, 0.08), 0 1px 3px rgba(0,0,0,0.04);
                max-width: 480px;
                  max-height: 600px;

                width: 100%;
                overflow: auto;
                position: relative;
                margin-top: -50px;
            }
            
            .form-header {
                text-align: center;
                padding: 32px 32px 24px;
                border-bottom: 1px solid #f1f3f4;
                position: relative;
                background: linear-gradient(135deg, #fafbff 0%, #f8f9ff 100%);
            }
            
            .header-accent {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, #1a73e8 0%, #4285f4 50%, #34a853 100%);
            }
            
            .form-header h2 {
                color: #202124;
                font-size: 1.5rem;
                font-weight: 600;
                margin: 0 0 8px 0;
                letter-spacing: -0.01em;
            }
            
            .form-header p {
                color: #5f6368;
                margin: 0;
                font-size: 0.875rem;
                line-height: 1.4;
            }
            
            .publish-form {
                padding: 24px 32px 32px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                display: block;
                margin-bottom: 6px;
                color: #1a73e8;
                font-weight: 600;
                font-size: 0.875rem;
                position: relative;
            }
            
            .form-group input[type="text"],
            .form-group textarea {
                width: 100%;
                padding: 12px 16px;
                border: 2px solid #e8eaed;
                border-radius: 8px;
                font-size: 0.875rem;
                line-height: 1.4;
                transition: all 0.2s ease-in-out;
                box-sizing: border-box;
                font-family: inherit;
                color: #3c4043;
                background: #fafbff;
            }
            
            .form-group input[type="text"]:focus,
            .form-group textarea:focus {
                outline: none;
                border-color: #1a73e8;
                box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
                background: white;
                transform: translateY(-1px);
            }
            
            .form-group input[type="text"]::placeholder,
            .form-group textarea::placeholder {
                color: #9aa0a6;
            }
            
            .form-group textarea {
                resize: vertical;
                min-height: 80px;
            }
            
            .file-upload-area {
                border: 2px dashed #dadce0;
                border-radius: 8px;
                padding: 24px;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease-in-out;
                background: linear-gradient(135deg, #fafbff 0%, #f8f9ff 100%);
                position: relative;
                overflow: hidden;
            }
            
            .file-upload-area::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(26, 115, 232, 0.1), transparent);
                transition: left 0.5s;
            }
            
            .file-upload-area:hover {
                border-color: #1a73e8;
                background: linear-gradient(135deg, #f0f4ff 0%, #e8f0fe 100%);
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
            }
            
            .file-upload-area:hover::before {
                left: 100%;
            }
            
            .upload-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 12px;
                position: relative;
                z-index: 1;
            }
            
            .upload-icon-wrapper {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                background: linear-gradient(135deg, #e8f0fe 0%, #f0f4ff 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }
            
            .file-upload-area:hover .upload-icon-wrapper {
                background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
                transform: scale(1.1);
            }
            
            .upload-content svg {
                color: #1a73e8;
                transition: color 0.2s ease;
            }
            
            .file-upload-area:hover .upload-content svg {
                color: white;
            }
            
            .upload-text {
                display: flex;
                flex-direction: column;
                gap: 2px;
            }
            
            .upload-title {
                color: #1a73e8;
                font-weight: 600;
                font-size: 0.875rem;
            }
            
            .upload-subtitle {
                color: #5f6368;
                font-size: 0.75rem;
            }
            
            .image-preview {
                margin-top: 12px;
                text-align: center;
            }
            
            .image-preview img {
                max-width: 100%;
                max-height: 120px;
                border-radius: 8px;
                border: 2px solid #e8eaed;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .form-actions {
                display: flex;
                gap: 12px;
                margin-top: 32px;
            }
            
            .btn-secondary,
            .btn-primary {
                flex: 1;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.875rem;
                cursor: pointer;
                transition: all 0.2s ease-in-out;
                border: 2px solid transparent;
                position: relative;
                overflow: hidden;
            }
            
            .btn-secondary {
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                color: #3c4043;
                border-color: #dadce0;
            }
            
            .btn-secondary:hover {
                background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
                border-color: #c4c7c5;
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            
            .btn-primary {
                background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
                color: white;
                border-color: #1a73e8;
                position: relative;
                overflow: hidden;
            }
            
            .btn-shine {
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                transition: left 0.6s;
            }
            
            .btn-primary:hover .btn-shine {
                left: 100%;
            }
            
            .btn-primary:hover {
                background: linear-gradient(135deg, #1557b0 0%, #3367d6 100%);
                border-color: #1557b0;
                transform: translateY(-2px);
                box-shadow: 0 4px 16px rgba(26, 115, 232, 0.3);
            }
            
            .btn-text {
                position: relative;
                z-index: 1;
            }
            
            .btn-primary:active,
            .btn-secondary:active {
                transform: translateY(0);
            }
            
            /* Subtle animations */
            @keyframes float {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-2px); }
            }
            
            .deploy-form-card {
                animation: float 6s ease-in-out infinite;
            }
            
            @media (max-width: 640px) {
                .deploy-form-card {
                    margin: 10px;
                    border-radius: 8px;
                    animation: none;
                }
                
                .form-header,
                .publish-form {
                    padding-left: 20px;
                    padding-right: 20px;
                }
                
                .form-actions {
                    flex-direction: column;
                }
            }

          .tag-selection-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.predefined-tags {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
}
.tag-btn {
    padding: 8px 16px;
    border: 2px solid #e8eaed;
    border-radius: 5px;
    background: #fafbff;
    color: #3c4043;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    font-family: inherit;
}

.tag-btn:hover {
    border-color: #1a73e8;
    background: #f0f4ff;
    transform: translateY(-1px);
}

.tag-btn.selected {
    border-color: #1a73e8;
    background: #1a73e8;
    color: white;
    box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
}

.custom-tag-input input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e8eaed;
    border-radius: 8px;
    font-size: 0.875rem;
    line-height: 1.4;
    transition: all 0.2s ease-in-out;
    box-sizing: border-box;
    font-family: inherit;
    color: #3c4043;
    background: #fafbff;
}

.custom-tag-input input:focus {
    outline: none;
    border-color: #1a73e8;
    box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
    background: white;
    transform: translateY(-1px);
}

.custom-tag-input input::placeholder {
    color: #9aa0a6;
}

.selected-tag-display {
    margin-top: 8px;
    font-size: 0.875rem;
    color: #1a73e8;
    font-weight: 600;
}
        </style>
    `;
}

function selectTag(tagValue) {
    // Clear custom input
    document.getElementById('customTag').value = '';
    
    // Update visual selection
    document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('selected'));
    document.querySelector(`[data-tag="${tagValue}"]`).classList.add('selected');
    
    // Map button values to display names
    const displayNames = {
        'written': 'Written',
        'speaking': 'Prepared Speaking',  // Changed this line
        'case': 'Case Study',
        'impromptu': 'Impromptu',
        'qna': 'Q&A'
    };
    
    // Set hidden input value with display name
    document.getElementById('toolTags').value = displayNames[tagValue];
    
    // Update display
    document.getElementById('selectedTagDisplay').textContent = `Selected: ${displayNames[tagValue]}`;
}

function handleCustomTag(event) {
    const customValue = event.target.value.trim();
    
    if (customValue) {
        // Clear predefined selections
        document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('selected'));
        
        // Set hidden input value
        document.getElementById('toolTags').value = customValue;
        
        // Update display
        document.getElementById('selectedTagDisplay').textContent = `Custom Tag: ${customValue}`;
    } else {
        document.getElementById('toolTags').value = '';
        document.getElementById('selectedTagDisplay').textContent = '';
    }
}

function clearSelectedTags() {
    if (document.getElementById('customTag').value.trim()) {
        document.querySelectorAll('.tag-btn').forEach(btn => btn.classList.remove('selected'));
    }
}


function handleImageUpload(event) {
    const file = event.target.files[0];
    const preview = document.getElementById('imagePreview');
    const uploadArea = document.querySelector('.file-upload-area');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `<img src="${e.target.result}" alt="Cover preview">`;
            preview.style.display = 'block';
            uploadArea.style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
}

function handleFormSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    window.storedFormData = formData;
    
    const gameCanvas = document.getElementById('gameCanvas');
    gameCanvas.innerHTML = `
        <div class="template-selection-page">
            <div class="template-container">
                <div class="template-header">
                    <div class="header-accent"></div>
                    <h2>Choose Your Tool's Landing Page</h2>
                    <p>Select a template that matches your study tool's style</p>
                </div>
                
                
                   <div class="slideshow-wrapper">
    <div class="slide-container">
        <div class="slide active" data-template="1">
            <div class="template-card gradient-1">
                <div class="gradient-blob blob-1"></div>
                <div class="gradient-blob blob-2"></div>
                <div class="template-preview">
                    <h3>[Tool Name]</h3>
                    <p>Ready to begin?</p>
                    <button>Start</button>
                </div>
            </div>
        </div>
        
        <div class="slide" data-template="2">
            <div class="template-card gradient-2">
                <div class="gradient-blob blob-3"></div>
                <div class="gradient-blob blob-4"></div>
                <div class="gradient-blob blob-5"></div>
                <div class="template-preview">
                    <h3>Learn [Tool Name]</h3>
                    <p>Interactive study experience</p>
                    <button>Begin</button>
                </div>
            </div>
        </div>
        
        <div class="slide" data-template="3">
            <div class="template-card gradient-3">
                <div class="gradient-blob blob-6"></div>
                <div class="gradient-blob blob-7"></div>
                <div class="template-preview">
                    <h3>Master [Tool Name]</h3>
                    <p>Click to continue</p>
                    <button>Continue</button>
                </div>
            </div>
        </div>
    </div>
    
    <button class="nav-btn prev" onclick="changeSlide(-1)">‚Äπ</button>
    <button class="nav-btn next" onclick="changeSlide(1)">‚Ä∫</button>
</div>
                
                <div class="dots-wrapper">
                    <span class="dot active" onclick="currentSlide(1)"></span>
                    <span class="dot" onclick="currentSlide(2)"></span>
                    <span class="dot" onclick="currentSlide(3)"></span>
                </div>
                
                <button class="select-template-btn" onclick="submitWithTemplate()">
                    <span>Select This Template</span>
                    <div class="btn-shine"></div>
                </button>
            </div>
        </div>
        
        <style>
.template-selection-page {
    width: 100%;
    height: 100vh;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.template-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(26, 115, 232, 0.08), 0 1px 3px rgba(0,0,0,0.04);
    max-width: 600px;
    width: 100%;
    overflow: hidden;
    position: relative;
}

.template-header {
    text-align: center;
    padding: 32px 32px 24px;
    border-bottom: 1px solid #f1f3f4;
    background: linear-gradient(135deg, #fafbff 0%, #f8f9ff 100%);
    position: relative;
}

.header-accent {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #1a73e8 0%, #4285f4 50%, #34a853 100%);
}

.template-header h2 {
    color: #202124;
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 8px 0;
}

.template-header p {
    color: #5f6368;
    margin: 0;
    font-size: 0.875rem;
}

.slideshow-wrapper {
    position: relative;
    padding: 40px 20px;
}

.slide-container {
    position: relative;
    height: 280px;
    max-width: 400px;
    margin: 0 auto;
}

.slide {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    transition: opacity 0.4s ease;
}

.slide.active {
    opacity: 1;
}

.template-card {
    width: 100%;
    height: 100%;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 12px 50px rgba(0,0,0,0.15);
    transition: transform 0.3s ease;
    position: relative;
}

.template-card:hover {
    transform: translateY(-6px);
}

.gradient-blob {
    position: absolute;
    border-radius: 50%;
    filter: blur(40px);
    opacity: 0.4;
    animation: float 6s ease-in-out infinite;
}

.blob-1 {
    width: 200px;
    height: 200px;
    background: rgba(100,200,255,0.2);
    top: -50px;
    right: -50px;
    animation-delay: 0s;
}

.blob-2 {
    width: 150px;
    height: 150px;
    background: rgba(80,180,120,0.18);
    bottom: -30px;
    left: -30px;
    animation-delay: 2s;
}

.blob-3 {
    width: 180px;
    height: 180px;
    background: rgba(255,120,80,0.2);
    top: -40px;
    left: -40px;
    animation-delay: 1s;
}

.blob-4 {
    width: 120px;
    height: 120px;
    background: rgba(180,100,255,0.18);
    bottom: -20px;
    right: -20px;
    animation-delay: 3s;
}

.blob-5 {
    width: 100px;
    height: 100px;
    background: rgba(255,180,100,0.16);
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    animation-delay: 4s;
}

.blob-6 {
    width: 160px;
    height: 160px;
    background: rgba(120,255,180,0.2);
    top: -30px;
    right: -30px;
    animation-delay: 0.5s;
}

.blob-7 {
    width: 140px;
    height: 140px;
    background: rgba(255,100,150,0.18);
    bottom: -40px;
    left: -40px;
    animation-delay: 2.5s;
}

@keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    33% { transform: translate(15px, -15px) rotate(120deg); }
    66% { transform: translate(-10px, 10px) rotate(240deg); }
}

.template-preview {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 50px 30px;
    box-sizing: border-box;
    position: relative;
    z-index: 2;
}

.gradient-1 {
    background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
    color: white;
}

.gradient-2 {
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    color: white;
}

.gradient-3 {
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
    color: white;
}

.template-preview h3 {
    margin: 0 0 16px 0;
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    text-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.template-preview p {
    margin: 0 0 28px 0;
    font-size: 1rem;
    opacity: 0.9;
    font-weight: 400;
}

.template-preview button {
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.2);
    color: inherit;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(20px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.template-preview button:hover {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.3);
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(0,0,0,0.15);
}

.nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: white;
    color: #6c757d;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 20px;
    font-weight: 300;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10;
}

.nav-btn:hover {
    background: #f8f9fa;
    color: #495057;
    transform: translateY(-50%) scale(1.1);
}

.prev { left: 25px; }
.next { right: 25px; }

.dots-wrapper {
    text-align: center;
    padding: 0 32px 24px;
}

.dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #dadce0;
    display: inline-block;
    margin: 0 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.dot.active {
    background: #1a73e8;
    transform: scale(1.2);
}

.select-template-btn {
    width: calc(100% - 64px);
    margin: 0 32px 32px;
    padding: 14px 24px;
    background: linear-gradient(135deg, #1a73e8 0%, #4285f4 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
}

.select-template-btn:hover {
    background: linear-gradient(135deg, #1557b0 0%, #3367d6 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(26, 115, 232, 0.3);
}

.btn-shine {
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.6s;
}

.select-template-btn:hover .btn-shine {
    left: 100%;
}
</style>
    `;
}

let currentSlideIndex = 1;

function changeSlide(n) {
    showSlide(currentSlideIndex += n);
}

function currentSlide(n) {
    showSlide(currentSlideIndex = n);
}

function showSlide(n) {
    const slides = document.querySelectorAll('.slide');
    const dots = document.querySelectorAll('.dot');
    
    if (n > slides.length) currentSlideIndex = 1;
    if (n < 1) currentSlideIndex = slides.length;
    
    slides.forEach(slide => slide.classList.remove('active'));
    dots.forEach(dot => dot.classList.remove('active'));
    
    slides[currentSlideIndex - 1].classList.add('active');
    dots[currentSlideIndex - 1].classList.add('active');
}

function submitWithTemplate() {
    // Store selected template
    const selectedTemplate = currentSlideIndex;
    window.selectedTemplate = selectedTemplate;
    
    // Call your original submit function
    runOriginalSubmit();
}


async function runOriginalSubmit() {
    const formData = window.storedFormData;
    const selectedTemplate = window.selectedTemplate || 1; // Get selected template
    
    const toolData = {
        name: formData.get('toolName'),
        description: formData.get('toolDescription'),
        tags: formData.get('toolTags'),
        coverImage: formData.get('coverImage'),
        gameState: localStorage.getItem('lastGameId'),
        publishedAt: new Date().toISOString(),
        id: localStorage.getItem('lastGameId') // Add this for showSuccessMessage
    };

    try {
        const gameId = localStorage.getItem('lastGameId');
        
        let gameStateData;
        if (gameStateManager.gameState && gameStateManager.gameState.elements.length > 0) {
            gameStateData = gameStateManager.gameState;
            gameStateData.metadata.title = toolData.name;
            gameStateData.metadata.description = toolData.description;
            gameStateData.metadata.lastModified = new Date().toISOString();
        } else {
            const gameStateJson = gameStateManager.saveGameState(toolData.name, toolData.description);
            gameStateData = JSON.parse(gameStateJson);
        }
        
        // Handle cover image conversion
        let coverImageData = null;
        const coverImageFile = toolData.coverImage;
        if (coverImageFile && coverImageFile instanceof File && coverImageFile.size > 0) {
            try {
                coverImageData = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(coverImageFile);
                });
            } catch (error) {
                console.warn('Image conversion failed:', error);
            }
        }
        
        const firebaseData = {
            name: toolData.name,
            description: toolData.description,
            tags: toolData.tags,
            coverImage: coverImageData,
            gameState: gameStateData,
            publishedAt: toolData.publishedAt,
            id: gameId,
            authorId: firebase.auth().currentUser?.uid || 'anonymous',
            landingTemplate: selectedTemplate // ADD THIS LINE
        };
        
        await firebase.firestore().collection('study-tools').doc(gameId).set(firebaseData);
        console.log('Saved to Firebase with template:', selectedTemplate);
        
        showSuccessMessage(toolData);
        
    } catch (error) {
        console.error('Firebase save failed:', error);
    }
}

function showSuccessNotification() {
    const notification = document.getElementById('successNotification');
    notification.classList.add('show');
    
    // Hide after 3 seconds
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

async function handlePublishSubmit(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const toolData = {
        name: formData.get('toolName'),
        description: formData.get('toolDescription'),
        tags: formData.get('toolTags'),
        coverImage: formData.get('coverImage'),
        gameState: localStorage.getItem('lastGameId'),
        publishedAt: new Date().toISOString()
    };

    // Save to Firebase with JavaScript included
    try {
        const gameId = localStorage.getItem('lastGameId');
        
        // USE gameStateManager to get complete game state with JavaScript
        // Get the existing game state from what's currently loaded, don't create new one
let gameStateData;
if (gameStateManager.gameState && gameStateManager.gameState.elements.length > 0) {
    // Use existing loaded game state
    gameStateData = gameStateManager.gameState;
    gameStateData.metadata.title = toolData.name;
    gameStateData.metadata.description = toolData.description;
    gameStateData.metadata.lastModified = new Date().toISOString();
} else {
    // Fallback: scan current canvas
    const gameStateJson = gameStateManager.saveGameState(toolData.name, toolData.description);
    gameStateData = JSON.parse(gameStateJson);
}
        
        // Handle cover image upload to Firebase Storage if exists
        // Handle cover image - convert to base64 instead of uploading to Storage
let coverImageData = null;
const coverImageFile = toolData.coverImage;
if (coverImageFile && coverImageFile instanceof File && coverImageFile.size > 0) {
    try {
        // Convert image to base64
        coverImageData = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(coverImageFile);
        });
        console.log('Image converted to base64');
    } catch (error) {
        console.warn('Image conversion failed:', error);
    }
} else {
    console.log('No image file to upload');
}
        
        const firebaseData = {
            name: toolData.name,
            description: toolData.description,
            tags: formData.get('toolTags'),
            coverImage: coverImageData,
            gameState: gameStateData, // Now includes JavaScript from gameStateManager
            publishedAt: toolData.publishedAt,
            id: gameId,
            authorId: firebase.auth().currentUser?.uid || 'anonymous'
        };
        
        await firebase.firestore().collection('study-tools').doc(gameId).set(firebaseData);
        console.log('‚úÖ Saved to Firebase successfully with JavaScript:', firebaseData);
        console.log('Elements with JS saved:', firebaseData.gameState.elements.map(el => ({
            type: el.type,
            hasJavaScript: !!el.javascript,
            jsData: el.javascript
        })));
    } catch (error) {
        console.error('‚ùå Firebase save failed:', error);
    }
    
    // Your original success message UI (EXACTLY as you had it)
    const gameCanvas = document.getElementById('gameCanvas');
    gameCanvas.innerHTML = `
        <div class="deploy-success-container">
            <div class="deploy-success-icon">üéÆ</div>
            <h2 class="deploy-success-title">Study Tool Published!</h2>
            <p class="success-message">Your tool "${toolData.name}" is now live and ready to share!</p>
            
            <div class="deploy-success-actions">
               <button class="deploy-action-btn edit-btn" onclick="updateGameMode()">Edit Tool</button>
                <button class="deploy-action-btn preview-btn" onclick="exportGamePreview()">
                    Preview Tool
                </button>
            </div>
        </div>
        
        <style>
            .deploy-success-container {
                width: 100%;
                height: 100vh;
                background: #e5e7eb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                box-sizing: border-box;
            }
            
            .deploy-success-icon {
                font-size: 4rem;
                margin-bottom: 24px;
                animation: bounceIn 0.6s ease-out;
            }
            
            .deploy-success-title {
                color: #1f2937;
                font-size: 2.2rem;
                font-weight: 700;
                margin-bottom: 16px;
                text-align: center;
            }
            
            .success-message {
                color: #6b7280;
                font-size: 1.1rem;
                margin-bottom: 32px;
                text-align: center;
                max-width: 500px;
            }
            
            .deploy-success-actions {
                display: flex;
                gap: 16px;
            }
            
            .deploy-action-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 120px;
            }
            
            .edit-btn {
                background: #374151;
                color: white;
            }
            
            .edit-btn:hover {
                background: #1f2937;
                transform: translateY(-2px);
            }
            
            .preview-btn {
                background: transparent;
                color: #374151;
                border: 2px solid #d1d5db;
            }
            
            .preview-btn:hover {
                background: #f9fafb;
                transform: translateY(-2px);
            }
            
            @keyframes bounceIn {
                0% { transform: scale(0.3); opacity: 0; }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); opacity: 1; }
            }
        </style>
    `;
    
    console.log('Tool published with JavaScript:', toolData);
}

function playDeployedGame() {
    const gameId = localStorage.getItem('lastGameId');
    const gameStateJson = localStorage.getItem(gameId);
    
    if (!gameStateJson) {
        alert('Game not found!');
        return;
    }
    
    gameStateManager.loadGameState(gameStateJson);
    
    // Remove editing controls for play mode
    document.querySelectorAll('.resize-handle').forEach(handle => handle.style.display = 'none');
    document.querySelectorAll('button[style*="√ó"]').forEach(btn => btn.style.display = 'none');
    document.querySelectorAll('.custom-game-element').forEach(element => {
        element.style.cursor = 'default';
        element.style.border = 'none';
    });
}

// Your original editGame function (NO CHANGES)
async function editGame() {
    const gameCanvas = document.getElementById('gameCanvas');
    
    // Clear the deploy success UI and restore the original canvas
    gameCanvas.innerHTML = `
        <div class="canvas-grid"></div>
    `;
    
    // Restore the canvas styling and grid
    gameCanvas.style.cssText = `
        width: 100%;
        height: 100%;
        position: relative;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        background-image: 
             radial-gradient(circle at 1px 1px, rgba(0,0,0,0.1) 1px, transparent 0);
        background-size: 20px 20px;
    `;
    
    // Load the saved game state if it exists
    // Load from Firebase instead of localStorage
try {
    const gameData = await gameStateManager.loadLatestGameFromFirebase();
    if (gameData && gameStateManager.loadGameState) {
        const gameStateJson = JSON.stringify(gameData.gameState);
        gameStateManager.loadGameState(gameStateJson);
    }
} catch (error) {
    console.error('Error loading game from Firebase:', error);
}
    
    console.log('Returned to edit mode');
    await updateGameMode();
}

// Add this new function (paste this in)
async function updateGameMode() {
    const gameCanvas = document.getElementById('gameCanvas');
    
    // Clear the deploy success UI and restore the original canvas
    gameCanvas.innerHTML = `
        <div class="canvas-grid"></div>
    `;
    
    // Restore the canvas styling and grid
    gameCanvas.style.cssText = `
        width: 100%;
        height: 100%;
        position: relative;
        background: white;
        border-radius: 12px;
        overflow: hidden;
        background-image: 
             radial-gradient(circle at 1px 1px, rgba(0,0,0,0.1) 1px, transparent 0);
        background-size: 20px 20px;
    `;
    
    let isExistingGame = false;
    let gameInfo = null;
    
    // Load from Firebase
    try {
        const gameData = await gameStateManager.loadLatestGameFromFirebase();
        if (gameData && gameStateManager.loadGameState) {
            const gameStateJson = JSON.stringify(gameData.gameState);
            gameStateManager.loadGameState(gameStateJson);
            isExistingGame = true;
            gameInfo = gameData;
            
            console.log('‚úÖ Found existing game in Firebase!');
            console.log('Game ID:', gameData.id);
            console.log('Game Name:', gameData.name);
            console.log('üîÑ Changing button to UPDATE GAME');
        }
    } catch (error) {
        console.error('‚ùå No existing game found in Firebase:', error);
        console.log('üìù Keeping button as DEPLOY GAME (new game)');
    }
    
    // Only change button if we loaded an existing game
    if (isExistingGame && gameInfo) {
        setTimeout(() => {
            const modal = document.getElementById('gameBuilderModal');
            const deployBtn = modal?.querySelector('#deployGame') || modal?.querySelector('[onclick*="deploy"]');
            if (deployBtn) {
                deployBtn.textContent = 'Update Game';
                deployBtn.onclick = showUpdateConfirmation;
                console.log('‚úÖ Button changed to UPDATE GAME');
            }
        }, 100);
    }
    
    console.log('Entered update game mode, existing game:', isExistingGame);
}
// Your original exportGamePreview function (NO CHANGES)
function exportGamePreview() {
    const htmlContent = gameStateManager.exportAsStandaloneGame();
    const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(htmlContent);
    window.open(dataUrl, '_blank');
}

async function updateGame() {
    try {
        const gameId = localStorage.getItem('lastGameId');
        
        // Get existing document to preserve name, description, tags, etc.
        const existingDoc = await firebase.firestore().collection('study-tools').doc(gameId).get();
        const existingData = existingDoc.data();
        
        // Don't scan the canvas - just use what's already loaded in memory
        const gameStateData = gameStateManager.gameState;
        gameStateData.metadata.lastModified = new Date().toISOString();
        
        // Update Firebase 
        const firebaseData = {
            ...existingData,
            gameState: gameStateData,
            publishedAt: new Date().toISOString()
        };
        
        await firebase.firestore().collection('study-tools').doc(gameId).set(firebaseData);
        console.log('Game updated in Firebase');
        
        showSuccessNotification();
        
    } catch (error) {
        console.error('Update failed:', error);
    }
}


function showSuccessMessage(toolData) {
   const gameCanvas = document.getElementById('gameCanvas');
    gameCanvas.innerHTML = `
        <div class="deploy-success-container">
            <div class="deploy-success-icon">üéÆ</div>
            <h2 class="deploy-success-title">Study Tool Published!</h2>
            <p class="success-message">Your tool "${toolData.name}" is now live and ready to share!</p>
            
            <div class="deploy-success-actions">
                <button class="deploy-action-btn edit-btn" onclick="updateGameMode()">Edit Tool</button>
                <button class="deploy-action-btn preview-btn" onclick="exportGamePreview()">
                    Preview Tool
                </button>
                <button class="deploy-action-btn share-btn"  style="display:none;" onclick="shareGame('${toolData.id}')">
                    Share Tool
                </button>
            </div>
        </div>
        
        <style>
            .deploy-success-container {
                width: 100%;
                height: 100vh;
                background: #e5e7eb;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 40px 20px;
                box-sizing: border-box;
            }
            
            .deploy-success-icon {
                font-size: 4rem;
                margin-bottom: 24px;
                animation: bounceIn 0.6s ease-out;
            }
             
            .deploy-success-title {
                color: #1f2937;
                font-size: 2.2rem;
                font-weight: 700;
                margin-bottom: 16px;
                text-align: center;
            }
            
            .success-message {
                color: #6b7280;
                font-size: 1.1rem;
                margin-bottom: 32px;
                text-align: center;
                max-width: 500px;
            }
            
            .deploy-success-actions {
                display: flex;
                gap: 16px;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .deploy-action-btn {
                padding: 12px 24px;
                border: none;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                cursor: pointer;
                transition: all 0.3s ease;
                min-width: 120px;
            }
            
            .edit-btn {
                background: #374151;
                color: white;
            }
            
            .edit-btn:hover {
                background: #1f2937;
                transform: translateY(-2px);
            }
            
            .preview-btn, .share-btn {
                background: transparent;
                color: #374151;
                border: 2px solid #d1d5db;
            }
            
            .preview-btn:hover, .share-btn:hover {
                background: #f9fafb;
                transform: translateY(-2px);
            }
            
            @keyframes bounceIn {
                0% { transform: scale(0.3); opacity: 0; }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); opacity: 1; }
            }
        </style>
    `;
}

// Bonus: Function to share a published game
function shareGame(gameId) {
    const shareUrl = `${window.location.origin}/play/${gameId}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Check out this study tool!',
            url: shareUrl
        });
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
            alert('Share link copied to clipboard!');
        }).catch(() => {
            prompt('Copy this link to share:', shareUrl);
        });
    }
}

async function loadPublishedGame(gameId) {
    try {
        const doc = await firebase.firestore()
            .collection('study-tools')
            .doc(gameId)
            .get();
        
        if (!doc.exists) {
            throw new Error('Game not found');
        }
        
        const toolData = doc.data();
        const gameStateJson = JSON.stringify(toolData.gameState);
        
        // Load the game state
        gameStateManager.loadGameState(gameStateJson);
        
        // Remove editing controls for play mode
        document.querySelectorAll('.resize-handle').forEach(handle => handle.style.display = 'none');
        document.querySelectorAll('button[style*="√ó"]').forEach(btn => btn.style.display = 'none');
        document.querySelectorAll('.custom-game-element').forEach(element => {
            element.style.cursor = 'default';
            element.style.border = 'none';
        });
        
        return toolData;
        
    } catch (error) {
        console.error('Error loading published game:', error);
        alert('Failed to load the study tool');
        return null;
    }
}

// Update the existing makeElementDraggable function to use the new one
function makeElementDraggable(element) {
    // This function is now handled by makeElementDraggableAndResizable
    // Keep it for backwards compatibility but just call the new function
    makeElementDraggableAndResizable(element);
}

function makeElementDraggable(element) {
    let isDragging = false;
    let startX, startY, initialX, initialY;
    
    element.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialX = parseInt(element.style.left) || 0;
        initialY = parseInt(element.style.top) || 0;
        element.style.cursor = 'grabbing';
    });
    
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        
        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;
        
        element.style.left = (initialX + deltaX) + 'px';
        element.style.top = (initialY + deltaY) + 'px';
    });
    
    document.addEventListener('mouseup', () => {
        isDragging = false;
        element.style.cursor = 'move';
    });
}

function updateGamePreview() {
    const gameCanvas = document.getElementById('gameCanvas');
    gameCanvas.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(59, 130, 246, 0.1); text-align: center;">
            <h3 style="color: #3b82f6; margin-bottom: 16px;">Your Game Preview</h3>
            <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                <p style="color: #1e40af;">Game mechanics are being generated...</p>
            </div>
            <button onclick="updateGame()" style="background: linear-gradient(135deg, #10b981 0%, #34d399 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">Update Game</button>
        </div>
    `;
}

function modifyExistingElement(targetName, changes) {
    console.log('üîç Looking for element:', targetName);
    console.log('üìù Changes to apply:', changes);
    
    const elements = document.querySelectorAll('.custom-game-element');
    console.log('üìä Found', elements.length, 'elements to search through');
    
    for (const container of elements) {
        const element = container.querySelector('button, input, div[contenteditable], div, span, label');
        if (!element) continue;
        
        console.log('üîé Checking element:', {
            id: element.id,
            textContent: element.textContent,
            tagName: element.tagName,
            className: element.className
        });
        
        // Enhanced matching - check multiple criteria
        const textMatch = element.textContent?.toLowerCase().includes(targetName.toLowerCase());
        const idMatch = element.id?.toLowerCase().includes(targetName.toLowerCase());
        const classMatch = element.className?.toLowerCase().includes(targetName.toLowerCase());
        const tagMatch = element.tagName?.toLowerCase() === targetName.toLowerCase();
        
        // Also check if targetName is a partial ID match
        const partialIdMatch = targetName.toLowerCase().includes('element') && 
                              element.id?.toLowerCase().includes('element');
        
        // Check if it's referring to "button", "input", etc.
        const typeMatch = (targetName.toLowerCase().includes('button') && element.tagName === 'BUTTON') ||
                         (targetName.toLowerCase().includes('input') && element.tagName === 'INPUT') ||
                         (targetName.toLowerCase().includes('text') && element.tagName === 'DIV');
        
        // Check if we're looking for "first", "last", etc.
        const positionMatch = (targetName.toLowerCase().includes('first') && container === elements[0]) ||
                             (targetName.toLowerCase().includes('last') && container === elements[elements.length - 1]);
        
        const matches = textMatch || idMatch || classMatch || tagMatch || partialIdMatch || typeMatch || positionMatch;
        
        console.log('üéØ Match results:', {
            textMatch, idMatch, classMatch, tagMatch, partialIdMatch, typeMatch, positionMatch,
            finalMatch: matches
        });
        
        if (matches) {
            console.log('‚úÖ Found matching element:', element);
            
            // Apply CSS changes
            if (changes.css) {
                console.log('üé® Applying CSS:', changes.css);
                const cssProperties = changes.css.split(';').filter(prop => prop.trim());
                cssProperties.forEach(prop => {
                    const [property, value] = prop.split(':').map(s => s.trim());
                    if (property && value) {
                        const camelProperty = property.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());
                        element.style[camelProperty] = value;
                        console.log(`‚úÖ Applied ${camelProperty}: ${value}`);
                    }
                });
            }
            
            // Apply JavaScript changes - FIXED VERSION
            if (changes.javascript) {
                console.log('‚ö° Applying JavaScript:', changes.javascript);
                try {
                    // Validate element exists and is valid
                    if (!element || !element.nodeType) {
                        console.error('‚ùå Invalid element for JavaScript modification');
                        return false;
                    }
                    
                    // Store the JavaScript code on the element for later saving
                    element._customJS = (element._customJS || '') + '\n' + changes.javascript;
                    
                    // Store event listeners for extraction
                    if (!element._eventListeners) {
                        element._eventListeners = {};
                    }
                    
                    // Create and execute the JavaScript
                    let jsCode = changes.javascript;
                    
                    // Fix element references - replace getElementById with safe references
                    jsCode = jsCode.replace(
                        /document\.getElementById\(['"`]([^'"`]+)['"`]\)/g,
                        '(function() { return element && element.nodeType ? element : null; })()'
                    );
                    
                    // Add safety checks for addEventListener calls
                    jsCode = jsCode.replace(
                        /(\w+)\.addEventListener\(/g,
                        '(function(el) { return el && el.addEventListener && el.nodeType ? el : null; })($1) && $1.addEventListener('
                    );
                    
                    // Replace 'this' with proper element reference
                    jsCode = jsCode.replace(/\bthis\./g, 'element.');
                    jsCode = jsCode.replace(/\bthis\b(?!\.)/g, 'element');
                    
                    // Create function with proper context and safety checks
                    const func = new Function('element', 'event', `
                        try {
                            // Ensure element is valid before any operations
                            if (!element || !element.nodeType) {
                                console.warn('Element not valid for JavaScript execution');
                                return;
                            }
                            
                            ${jsCode}
                        } catch (e) {
                            console.error('Error in JavaScript execution:', e);
                        }
                    `);
                    
                    // For click events, add event listener with proper safety
                    if (changes.javascript.includes('click') || changes.javascript.includes('addEventListener')) {
                        // Ensure element can accept event listeners
                        if (!element.addEventListener) {
                            console.error('‚ùå Element does not support addEventListener');
                            return false;
                        }
                        
                        const wrappedHandler = function(event) {
                            try {
                                // Double-check element is still valid
                                if (!this || !this.nodeType) {
                                    console.warn('Element invalid during event handler execution');
                                    return;
                                }
                                func(this, event);
                            } catch (error) {
                                console.error('Error in event handler:', error);
                            }
                        };
                        
                        element.addEventListener('click', wrappedHandler);
                        
                        // Store for extraction
                        if (!element._eventListeners.click) {
                            element._eventListeners.click = [];
                        }
                        element._eventListeners.click.push(wrappedHandler);
                        console.log('‚úÖ Click event listener added safely');
                    } else {
                        // Execute immediately for property changes
                        setTimeout(() => {
                            try {
                                // Final check before execution
                                if (element && element.nodeType && document.body.contains(element)) {
                                    func(element);
                                    console.log('‚úÖ JavaScript executed immediately');
                                } else {
                                    console.warn('Element not in DOM for immediate execution');
                                }
                            } catch (error) {
                                console.error('Error in immediate JavaScript execution:', error);
                            }
                        }, 50);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error executing JavaScript modification:', error);
                }
            }
            
            // Apply text changes
            if (changes.text) {
                console.log('üìù Applying text:', changes.text);
                if (element && element.nodeType) {
                    element.textContent = changes.text;
                } else {
                    console.error('‚ùå Invalid element for text changes');
                }
            }
            
            // Apply content changes
            if (changes.content) {
                console.log('üìÑ Applying content:', changes.content);
                if (element && element.nodeType) {
                    element.innerHTML = changes.content;
                } else {
                    console.error('‚ùå Invalid element for content changes');
                }
            }
            
            // Apply attribute changes
            if (changes.attributes) {
                console.log('üè∑Ô∏è Applying attributes:', changes.attributes);
                if (element && element.nodeType && element.setAttribute) {
                    Object.entries(changes.attributes).forEach(([attr, value]) => {
                        try {
                            element.setAttribute(attr, value);
                            console.log(`‚úÖ Set attribute ${attr}: ${value}`);
                        } catch (error) {
                            console.error(`‚ùå Error setting attribute ${attr}:`, error);
                        }
                    });
                } else {
                    console.error('‚ùå Invalid element for attribute changes');
                }
            }
            
            console.log('üéâ Element modification completed successfully');
            return true;
        }
    }
    
    console.log('‚ùå No matching element found for:', targetName);
    console.log('üí° Available elements:');
    elements.forEach((container, index) => {
        const element = container.querySelector('button, input, div[contenteditable], div, span, label');
        if (element) {
            console.log(`  ${index + 1}. ID: "${element.id}", Text: "${element.textContent}", Tag: ${element.tagName}`);
        }
    });
    
    return false;
}

document.querySelector('.empty-create-area').onclick = function() {
    closeModal();
    setTimeout(() => {
        document.getElementById('gameBuilderModal').classList.add('active');
        document.body.style.overflow = 'hidden';
    }, 300);
};

function addMessage(text, type) {
    const messages = document.getElementById('chatMessages');
    const msg = document.createElement('div');
    msg.className = `message ${type}`;
    
    if (type === 'ai') {
        // Add some styling for AI messages
        msg.innerHTML = `<div class="message-content">${text}</div>`;
    } else {
        msg.textContent = text;
    }
    
    messages.appendChild(msg);
    messages.scrollTop = messages.scrollHeight;
}

// Simple Firebase v8 syntax
function loadRecentTools() {
    firebase.firestore().collection('study-tools').get()
        .then(snapshot => {
            const toolsGrid = document.querySelector('.tools-grid');
            toolsGrid.innerHTML = '';
            
            snapshot.docs.forEach(doc => {
                const tool = doc.data();
                const card = createToolCard(tool);
                toolsGrid.appendChild(card);
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function createToolCard(tool) {
    const card = document.createElement('div');
    card.className = 'tool-card';
    card.onclick = () => openToolModal(tool);
    
    card.innerHTML = `
        <div class="card-image" style="${tool.coverImage ? 
    `background-image: url('${tool.coverImage}'); background-size: cover; background-position: center;` : 
    `background: linear-gradient(135deg, #4285f4, #34a853); display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;`
}">
    ${tool.coverImage ? '' : tool.name[0]}
</div>
        <div class="card-content">
    <div class="card-title">${tool.name}</div>
    <div class="card-meta">
        <div class="meta-icon" style="background: ${getTagColor(tool.tags)}; border-radius: 50%; width: 12px; height: 12px;"></div>
        <span>${tool.tags || 'Study Tool'}</span>
    </div>
</div>
    `;
    
    return card;
}

function getTagColor(tag) {
    if (!tag) return '#4285f4'; // Default blue for Study Tool
    
    const tagLower = tag.toLowerCase();
    
    if (tagLower === 'case' || tagLower === 'case study') return '#34a853'; // Green
    if (tagLower === 'written') return '#ea4335'; // Red
    if (tagLower === 'speaking' || tagLower === 'prepared speaking') return '#fbbc04'; // Yellow
    if (tagLower === 'impromptu') return '#ff6d01'; // Orange
    if (tagLower === 'qna' || tagLower === 'q&a') return '#9c27b0'; // Purple
    
    return '#757575'; // Gray for custom/other tags
}

function openToolModal(tool) {
    const modal = document.getElementById('toolModal');
    const renderArea = document.getElementById('tool-render-area');

    const hammerButton = document.querySelector('.hammer-button');
    hammerButton.dataset.gameId = tool.id;
    
    // Store tool data for landing page
    window.currentToolData = {
        name: tool.name,
        description: tool.description,
        landingTemplate: tool.landingTemplate || 1,
        originalTool: tool
    };
    
    // Show landing page first
    renderArea.innerHTML = generateLandingPage(window.currentToolData);
    
    modal.style.display = 'flex';
}

function closeModal() {
    document.getElementById('toolModal').style.display = 'none';
}

// Load on page ready
loadRecentTools();

function handleSend() {
  const textarea = document.querySelector('.chat-textarea');
  const text = textarea.value.trim();
  if (!text) return;
  addMessage(text, 'user');
  textarea.value = '';
  setTimeout(() => addMessage('Great idea! What subject should this cover?', 'ai'), 1000);
}

document.querySelector('.send-btn').onclick = handleSend;

function initializeResizeAndDrag() {
    const resizeHandle = document.getElementById('resizeHandle');
    const chatPanel = document.querySelector('.chat-panel');
    const builderContainer = document.querySelector('.builder-container');
    let isResizing = false;

    // Resize functionality
    resizeHandle.addEventListener('mousedown', (e) => {
        e.preventDefault();
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        
        const handleMouseMove = (e) => {
            if (!isResizing) return;
            const containerRect = builderContainer.getBoundingClientRect();
            const newWidth = e.clientX - containerRect.left;
            
            if (newWidth > 250 && newWidth < containerRect.width - 250) {
                chatPanel.style.width = `${newWidth}px`;
                chatPanel.style.flexShrink = '0';
            }
        };
        
        const handleMouseUp = () => {
            isResizing = false;
            document.body.style.cursor = '';
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
    });

    // Drag and drop functionality
    const inventoryItems = document.querySelectorAll('.inventory-item');
    const dropZone = document.getElementById('dropZone');

    inventoryItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', e.target.dataset.element);
            e.dataTransfer.effectAllowed = 'copy';
        });
    });

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
        dropZone.style.background = 'rgba(59, 130, 246, 0.1)';
        dropZone.style.borderColor = '#3b82f6';
    });

    dropZone.addEventListener('dragleave', (e) => {
        if (!dropZone.contains(e.relatedTarget)) {
            dropZone.style.background = '';
            dropZone.style.borderColor = '';
        }
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.background = '';
        dropZone.style.borderColor = '';
        
        const elementType = e.dataTransfer.getData('text/plain');
        const rect = dropZone.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        createDroppedElement(elementType, x, y);
    });
}

function createDroppedElement(type, x, y) {
    const dropZone = document.getElementById('dropZone');
    
    // Remove placeholder if it exists
    const placeholder = dropZone.querySelector('.drop-placeholder');
    if (placeholder) {
        placeholder.style.display = 'none';
    }
    
    const element = document.createElement('div');
    element.className = 'dropped-element';
    element.style.cssText = `
        position: absolute;
        left: ${x - 50}px;
        top: ${y - 25}px;
        background: white;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        padding: 12px;
        cursor: move;
        user-select: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        min-width: 100px;
        z-index: 10;
    `;
    
    const elementTemplates = {
        text: '<div contenteditable="true" style="border: none; outline: none;">Sample Text</div>',
        button: '<button style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Click Me</button>',
        input: '<input type="text" placeholder="Enter text..." style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 150px;">',
        timer: '<div style="font-weight: bold; color: #3b82f6;">Timer: <span>60s</span></div>'
    };
    
    element.innerHTML = elementTemplates[type] || 'Unknown Element';
    
    // Add delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.innerHTML = '√ó';
    deleteBtn.style.cssText = `
        position: absolute;
        top: -8px;
        right: -8px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #ef4444;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 14px;
        line-height: 1;
    `;
    deleteBtn.onclick = () => element.remove();
    element.appendChild(deleteBtn);
    
    dropZone.appendChild(element);
    makeDraggable(element);
}

function makeDraggable(element) {
    let isDragging = false;
    let startX, startY;
    let initialX, initialY;

    element.addEventListener('mousedown', (e) => {
        if (e.target.tagName === 'BUTTON' && e.target.innerHTML === '√ó') return;
        
        isDragging = true;
        const rect = element.getBoundingClientRect();
        const dropZoneRect = element.parentElement.getBoundingClientRect();
        
        startX = e.clientX;
        startY = e.clientY;
        initialX = rect.left - dropZoneRect.left;
        initialY = rect.top - dropZoneRect.top;
        
        element.style.zIndex = '100';
        element.style.opacity = '0.8';
        
        const handleMouseMove = (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            const newX = initialX + deltaX;
            const newY = initialY + deltaY;
            
            // Keep element within bounds
            const dropZone = element.parentElement;
            const maxX = dropZone.offsetWidth - element.offsetWidth;
            const maxY = dropZone.offsetHeight - element.offsetHeight;
            
            element.style.left = `${Math.max(0, Math.min(newX, maxX))}px`;
            element.style.top = `${Math.max(0, Math.min(newY, maxY))}px`;
        };
        
        const handleMouseUp = () => {
            isDragging = false;
            element.style.zIndex = '10';
            element.style.opacity = '1';
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        };
        
        document.addEventListener('mousemove', handleMouseMove);
        document.addEventListener('mouseup', handleMouseUp);
        
        e.preventDefault();
    });
}


// Unified function to close ALL modals and overlay
function closeAllModals() {
    // Close createModal
    const createModal = document.getElementById('createModal');
    if (createModal) createModal.classList.remove('active');
    
    // Close other modals
    const modals = [
        document.getElementById('toolModal'),
        document.getElementById('gameBuilderModal'),
        document.querySelector('.modal-container')
    ];
    
    modals.forEach(modal => {
        if (modal) modal.classList.remove('active');
    });
    
    // Hide the blurred overlay with class instead of display
    const overlay = document.querySelector('.modal-overlay');
    if (overlay) overlay.classList.remove('active');
    
    // Restore scrolling
    document.body.style.overflow = 'auto';
}

// Simplified individual functions
function closeModal() {
    closeAllModals();
}

function closeGameModal() {
    closeAllModals();
}

// Update openGameBuilder function to initialize
function openGameBuilder(gameIdea) {
    // First close any other modals
    closeModal();
    closeGameModal();
    
    document.getElementById('gameBuilderModal').classList.add('active');
    document.body.style.overflow = 'hidden';
    
    setTimeout(() => {
        fixDragAndResize();
    }, 100);
}

// Function to generate the landing page HTML based on template choice
function generateLandingPage(toolData) {
    const { name, description, landingTemplate } = toolData;
    
    const templates = {
        1: { gradient: 'linear-gradient(135deg, #1e293b 0%, #334155 100%)', buttonText: 'Start' },
        2: { gradient: 'linear-gradient(135deg, #0f172a 0%, #1e293b 100%)', buttonText: 'Begin' },
        3: { gradient: 'linear-gradient(135deg, #374151 0%, #4b5563 100%)', buttonText: 'Continue' }
    };
    
    const template = templates[landingTemplate] || templates[1];
    
    return `
        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
            <div style="width: 400px; height: 300px; border-radius: 20px; position: relative; overflow: hidden; box-shadow: 0 12px 50px rgba(0,0,0,0.15); background: ${template.gradient}; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: white;">
                <h1 style="margin: 0 0 16px 0; font-size: 2rem; font-weight: 700;">${name}</h1>
                <p style="margin: 0 0 28px 0; font-size: 1.1rem; opacity: 0.9;">${description}</p>
                <button onclick="loadOriginalGame()" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 14px 32px; border-radius: 12px; font-weight: 600; font-size: 1rem; cursor: pointer;">${template.buttonText}</button>
            </div>
        </div>
    `;
}

function loadOriginalGame() {
    const tool = window.currentToolData.originalTool;
    const modal = document.getElementById('toolModal');
    const renderArea = document.getElementById('tool-render-area');

    const hammerButton = document.querySelector('.hammer-button');
    hammerButton.dataset.gameId = tool.id;
    
    // Parse gameState if it's a string
    let gameState = tool.gameState;
    if (typeof gameState === 'string') {
        gameState = JSON.parse(gameState);
    }
    
    // Clear render area
    renderArea.innerHTML = '';
    
    // Add back button
    const backButton = document.createElement('button');
    backButton.innerHTML = '‚Üê';
    backButton.onclick = () => {
        renderArea.innerHTML = generateLandingPage(window.currentToolData);
    };
    backButton.style.cssText = 'position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; color: black; border: 0.5px solid grey; padding: 8px 12px; border-radius: 6px; cursor: pointer;';
    renderArea.appendChild(backButton);
    
    // ADD THIS: Make render area relative positioned for absolute children
    renderArea.style.position = 'relative';
    renderArea.style.width = '100%';
    renderArea.style.height = '100%';
    
    // ALL YOUR ORIGINAL CODE FROM HERE DOWN - EXACTLY AS IT WAS
    if (gameState && gameState.elements) {
        gameState.elements.forEach((element, index) => {
            // Create container div
            const container = document.createElement('div');
            if (element.containerStyles && element.containerStyles.inline) {
                container.style.cssText = element.containerStyles.inline;
            }
            
            // ADD THIS: Ensure container is visible
            if (container.style.position === 'absolute') {
                container.style.zIndex = '10';
            }
            
            let childElement;
            
            // Create the actual element
            if (element.properties && element.properties.tagName === 'BUTTON') {
                childElement = document.createElement('button');
                childElement.textContent = element.content.text || element.content.html || '';
                
                // Set button properties
                if (element.properties.type) childElement.type = element.properties.type;
                if (element.properties.id) childElement.id = element.properties.id;
                if (element.properties.className) childElement.className = element.properties.className;
                if (element.properties.disabled) childElement.disabled = element.properties.disabled;
                
            } else {
                // Handle other element types (div, span, etc.)
                const tagName = element.properties?.tagName || 'div';
                childElement = document.createElement(tagName.toLowerCase());
                
                if (element.content.html) {
                    childElement.innerHTML = element.content.html;
                } else if (element.content.text) {
                    childElement.textContent = element.content.text;
                }
                
                // Set common properties
                if (element.properties?.id) childElement.id = element.properties.id;
                if (element.properties?.className) childElement.className = element.properties.className;
            }
            
            // Apply styles
            if (element.styles && element.styles.inline) {
                childElement.style.cssText = element.styles.inline;
            }
            
            // Add JavaScript event handlers
            // Define a handler function globally if the code references it
            window.handler = function(element, event) {
                console.log('Handler called for:', element);
                alert('Button clicked via handler!');
            };
            
            // Handle click events from javascript.clickEvents array (Firebase structure)
            if (element.javascript && element.javascript.clickEvents) {
                element.javascript.clickEvents.forEach(clickEventObj => {
                    let code = null; // Declare code variable outside try block
                    try {
                        // Check if it's an object with code property (Firebase structure)
                        if (typeof clickEventObj === 'object' && clickEventObj.code) {
                            code = clickEventObj.code;
                        } else if (typeof clickEventObj === 'string') {
                            code = clickEventObj;
                        }
                        
                        if (code) {
                            childElement.addEventListener('click', function(event) {
                                console.log('Element clicked:', element.id);
                                
                                try {
                                    // If the code is a complete function, execute it directly
                                    if (code.startsWith('function')) {
                                        const func = eval(`(${code})`);
                                        func.call(childElement, event);
                                    } else {
                                        // Otherwise, create a function from the code
                                        const func = new Function('event', 'element', code);
                                        func.call(childElement, event, element);
                                    }
                                } catch (error) {
                                    console.error('Error executing click event:', error);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Error setting up click event:', error);
                        if (code) console.error('Code was:', code);
                    }
                });
            }
            
            if (element.events) {
                
                // Handle inline click handler if it exists
                if (element.events.click) {
                    childElement.addEventListener('click', function(event) {
                        try {
                            const func = new Function('event', 'element', element.events.click);
                            func.call(childElement, event, element);
                        } catch (error) {
                            console.error('Error executing click handler:', error);
                        }
                    });
                }
                
                // Handle other event types (mouseover, mouseout, etc.)
                Object.keys(element.events).forEach(eventType => {
                    if (eventType !== 'click' && element.events[eventType]) {
                        childElement.addEventListener(eventType, function(event) {
                            try {
                                const func = new Function('event', 'element', element.events[eventType]);
                                func.call(childElement, event, element);
                            } catch (error) {
                                console.error(`Error executing ${eventType} handler:`, error);
                            }
                        });
                    }
                });
            }
            
            // Execute custom functions (updated for Firebase structure)
            if (element.javascript && element.javascript.customFunctions) {
                element.javascript.customFunctions.forEach(funcObj => {
                    let code = null; // Declare code variable outside try block
                    try {
                        // Check if it's an object with code property (Firebase structure)
                        if (typeof funcObj === 'object' && funcObj.code) {
                            code = funcObj.code;
                        } else if (typeof funcObj === 'string') {
                            code = funcObj;
                        }
                        
                        if (code) {
                            // Get the actual element ID that was assigned
                            const actualElementId = childElement.id || element.properties?.id;
                            
                            // Fix hardcoded IDs in the code - replace 'rainbowButton' with actual element ID
                            let fixedCode = code.replace(/getElementById\(['"]rainbowButton['"]\)/g, `getElementById('${actualElementId}')`);
                            
                            console.log('Original code:', code);
                            console.log('Fixed code:', fixedCode);
                            console.log('Target element ID:', actualElementId);
                            console.log('Element exists in DOM:', !!document.getElementById(actualElementId));
                            
                            // Wait a moment for the element to be in the DOM, then execute
                            setTimeout(() => {
                                try {
                                    // Execute the fixed code
                                    const func = new Function('element', fixedCode);
                                    func.call(childElement, element);
                                } catch (error) {
                                    console.error('Error executing custom function (delayed):', error);
                                    console.error('Code was:', fixedCode);
                                }
                            }, 10);
                        }
                    } catch (error) {
                        console.error('Error executing custom function:', error);
                        if (code) console.error('Code was:', code);
                    }
                });
            }
            
            // Execute inline scripts (updated for potential Firebase structure)
            if (element.javascript && element.javascript.inlineScripts) {
                element.javascript.inlineScripts.forEach(scriptObj => {
                    let code = null; // Declare code variable outside try block
                    try {
                        // Check if it's an object with code property
                        if (typeof scriptObj === 'object' && scriptObj.code) {
                            code = scriptObj.code;
                        } else if (typeof scriptObj === 'string') {
                            code = scriptObj;
                        }
                        
                        if (code) {
                            const func = new Function('element', code);
                            func.call(childElement, element);
                        }
                    } catch (error) {
                        console.error('Error executing inline script:', error);
                        if (code) console.error('Code was:', code);
                    }
                });
            }
            
            // Add child to container
            container.appendChild(childElement);
            
            // Add container to render area
            renderArea.appendChild(container);
        });
    }
}

// Function to show the modal with the landing page
function showModalWithLanding(toolData) {
    const modal = document.getElementById('toolModal');
    const renderArea = document.getElementById('tool-render-area');
    
    // Generate and insert the landing page
    renderArea.innerHTML = generateLandingPage(toolData);
    
    // Show the modal
    modal.style.display = 'block';
}

// Function to start the actual game/tool
function startGame() {
    const renderArea = document.getElementById('tool-render-area');
    
    // Replace landing page with canvas
    renderArea.innerHTML = `
        <div class="game-canvas-container">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
            <div class="game-ui">
                <button onclick="backToLanding()" class="back-button">‚Üê</button>
            </div>
        </div>
        
        <style>
        .game-canvas-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }
        
        #gameCanvas {
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .game-ui {
            margin-top: 15px;
        }
        
        .back-button {
            background: white;
            color: black;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .back-button:hover {
            background: #5a6268;
        }
        </style>
    `;
    
    // Initialize your canvas game here
    initializeGame();
}

// Function to go back to landing
function backToLanding() {
    // Get the current tool data and regenerate landing
    const currentToolData = window.currentToolData; // Store this when opening modal
    const renderArea = document.getElementById('tool-render-area');
    renderArea.innerHTML = generateLandingPage(currentToolData);
}

// Initialize game function
function initializeGame() {
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // Your game initialization code goes here
    ctx.fillStyle = '#e9ecef';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#495057';
    ctx.font = '24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Game Canvas Ready!', canvas.width/2, canvas.height/2);
}

// Example usage when opening modal:
// const toolData = {
//     name: "My Study Game",
//     description: "a",
//     landingTemplate: 3
// };
// window.currentToolData = toolData;
// showModalWithLanding(toolData);
    </script>
</body>
</html>