<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FBLAZE Dashboard</title>
  <link rel="stylesheet" href="practice1.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Speaking Assignment Modal Styles - Matching React Design */
    .cq-speaking-modal {
      position: fixed;
      z-index: 3100;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: #020617; /* slate-950 */
      color: white;
      overflow: hidden;
    }
    
    /* Star Field Background */
    .cq-speaking-stars {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .cq-speaking-star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle linear infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.9; }
    }
    .cq-speaking-glow-1 {
      position: absolute;
      top: 5rem;
      left: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    .cq-speaking-glow-2 {
      position: absolute;
      bottom: 0;
      right: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    
    .cq-speaking-modal-content {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
    }
    
    .cq-speaking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30, 41, 59, 0.3); /* slate-800/30 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }
    .cq-speaking-title {
      font-size: 1.875rem; /* text-3xl */
      font-weight: 700;
      color: #f97316; /* orange-500 */
      margin: 0;
    }
    .cq-speaking-close {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: #f97316; /* orange-500 */
      color: white;
      border: none;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
    }
    .cq-speaking-close:hover {
      background: #ea580c; /* orange-600 */
    }
    
    .cq-speaking-main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 0;
    }
    
    .cq-speaking-questions {
      display: flex;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-speaking-question-card {
      flex: 1;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700 */
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .cq-speaking-question-label {
      font-size: 0.75rem; /* text-xs */
      font-weight: 600;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.25rem;
    }
    .cq-speaking-question-text {
      font-size: 0.875rem; /* text-sm */
      color: white;
      line-height: 1.5;
    }
    
    .cq-speaking-video-container {
      flex: 1;
      position: relative;
      border-radius: 1rem; /* rounded-2xl */
      overflow: hidden;
      border: 2px solid rgba(249, 115, 22, 0.3); /* border-orange-500/30 */
      background: #000;
      min-height: 0;
    }
    .cq-speaking-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cq-speaking-no-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1rem;
    }
    
    /* Recording Indicator */
    .cq-speaking-recording-indicator {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      backdrop-filter: blur(8px);
      font-size: 0.75rem;
    }
    .cq-speaking-recording-indicator.active {
      display: flex;
    }
    .cq-speaking-recording-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .cq-speaking-recording-text {
      font-weight: 600;
      color: #fca5a5; /* red-400 */
    }
    
    .cq-speaking-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-speaking-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }
    .cq-speaking-control-btn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: rgba(30, 41, 59, 0.4); /* slate-800/40 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #94a3b8; /* slate-400 */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1.25rem;
    }
    .cq-speaking-control-btn:hover {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #cbd5e1; /* slate-300 */
    }
    .cq-speaking-record-btn {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background: linear-gradient(to right, #f97316, #ef4444); /* orange-500 to red-500 */
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
      font-size: 2rem;
      font-weight: 600;
    }
    .cq-speaking-record-btn:hover {
      box-shadow: 0 0 30px rgba(249, 115, 22, 0.7);
    }
    .cq-speaking-record-btn.recording {
      background: #ef4444; /* red-500 */
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
    
    .cq-speaking-submit-btn {
      padding: 0.5rem 2.5rem;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700 */
      border-radius: 0.5rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1rem;
    }
    .cq-speaking-submit-btn:hover:not(:disabled) {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
    }
    .cq-speaking-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Case Study Assignment Modal Styles - Matching React Design */
    .cq-case-study-modal {
      position: fixed;
      z-index: 3100;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: #020617; /* slate-950 */
      color: white;
      overflow: hidden;
    }
    
    /* Star Field Background */
    .cq-case-study-stars {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .cq-case-study-star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: cq-case-study-twinkle linear infinite;
    }
    @keyframes cq-case-study-twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.9; }
    }
    .cq-case-study-glow-1 {
      position: absolute;
      top: 5rem;
      left: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    .cq-case-study-glow-2 {
      position: absolute;
      bottom: 0;
      right: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    
    .cq-case-study-modal-content {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
    }
    
    .cq-case-study-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30, 41, 59, 0.3); /* slate-800/30 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }
    .cq-case-study-title {
      font-size: 1.875rem; /* text-3xl */
      font-weight: 700;
      color: #f97316; /* orange-500 */
      margin: 0;
    }
    .cq-case-study-header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .cq-case-study-timer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      backdrop-filter: blur(8px);
    }
    .cq-case-study-timer:hover {
      border-color: rgba(249, 115, 22, 0.3); /* orange-500/30 */
    }
    .cq-case-study-timer.active {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }
    .cq-case-study-timer-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: #f97316; /* orange-500 */
      transition: all 0.2s;
    }
    .cq-case-study-timer.active .cq-case-study-timer-dot {
      background: #ef4444; /* red-500 */
      animation: cq-case-study-pulse-dot 1.5s ease-in-out infinite;
    }
    @keyframes cq-case-study-pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .cq-case-study-timer-text {
      font-size: 0.875rem;
      font-family: monospace;
      font-weight: 600;
      color: #cbd5e1; /* slate-300 */
    }
    .cq-case-study-timer.active .cq-case-study-timer-text {
      color: #fca5a5; /* red-400 */
    }
    .cq-case-study-timer-start {
      font-size: 0.75rem;
      color: #94a3b8; /* slate-400 */
      margin-left: 0.25rem;
    }
    .cq-case-study-timer.active .cq-case-study-timer-start {
      display: none;
    }
    .cq-case-study-close {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: #f97316; /* orange-500 */
      color: white;
      border: none;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
    }
    .cq-case-study-close:hover {
      background: #ea580c; /* orange-600 */
    }
    
    .cq-case-study-main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 0;
    }
    
    .cq-case-study-top-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-info-card {
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 1rem;
      backdrop-filter: blur(8px);
    }
    .cq-case-study-info-card.cq-case-study-clickable {
      cursor: pointer;
      transition: all 0.2s;
    }
    .cq-case-study-info-card.cq-case-study-clickable:hover {
      border-color: rgba(249, 115, 22, 0.3); /* orange-500/30 */
    }
    .cq-case-study-info-label {
      font-size: 0.75rem;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.25rem;
    }
    .cq-case-study-info-value {
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
    }
    .cq-case-study-info-preview {
      font-size: 0.75rem;
      color: white;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: color 0.2s;
    }
    .cq-case-study-clickable:hover .cq-case-study-info-preview {
      color: #fb923c; /* orange-400 */
    }
    .cq-case-study-read-more {
      font-size: 0.75rem;
      color: #fb923c; /* orange-400 */
      margin-top: 0.5rem;
    }
    
    .cq-case-study-expanded-content {
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 1.5rem;
      backdrop-filter: blur(8px);
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .cq-case-study-expanded-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }
    .cq-case-study-expanded-label {
      font-size: 0.875rem;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.25rem;
    }
    .cq-case-study-expanded-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: white;
    }
    .cq-case-study-expanded-close {
      color: #94a3b8; /* slate-400 */
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      transition: color 0.2s;
      padding: 0;
      width: 1.25rem;
      height: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cq-case-study-expanded-close:hover {
      color: #fb923c; /* orange-400 */
    }
    .cq-case-study-full-content {
      font-size: 0.875rem;
      color: white;
      line-height: 1.75;
      flex: 1;
    }
    
    .cq-case-study-video-container {
      flex: 1;
      position: relative;
      border-radius: 1rem; /* rounded-2xl */
      overflow: hidden;
      border: 2px solid rgba(249, 115, 22, 0.3); /* border-orange-500/30 */
      background: #000;
      min-height: 0;
    }
    .cq-case-study-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cq-case-study-no-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1rem;
    }
    
    /* Recording Indicator */
    .cq-case-study-recording-indicator {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      backdrop-filter: blur(8px);
      font-size: 0.75rem;
    }
    .cq-case-study-recording-indicator.active {
      display: flex;
    }
    .cq-case-study-recording-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: #ef4444;
      border-radius: 50%;
      animation: cq-case-study-pulse-dot 1.5s ease-in-out infinite;
    }
    .cq-case-study-recording-text {
      font-weight: 600;
      color: #fca5a5; /* red-400 */
    }
    
    .cq-case-study-bottom-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-question-card {
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 0.75rem;
      backdrop-filter: blur(8px);
    }
    .cq-case-study-question-label {
      font-size: 0.75rem;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.5rem;
    }
    .cq-case-study-question-text {
      font-size: 0.75rem;
      color: white;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .cq-case-study-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }
    .cq-case-study-control-btn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: rgba(30, 41, 59, 0.4); /* slate-800/40 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #94a3b8; /* slate-400 */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1.25rem;
    }
    .cq-case-study-control-btn:hover {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #cbd5e1; /* slate-300 */
    }
    .cq-case-study-record-btn {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background: linear-gradient(to right, #f97316, #ef4444); /* orange-500 to red-500 */
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
      font-size: 2rem;
      font-weight: 600;
    }
    .cq-case-study-record-btn:hover {
      box-shadow: 0 0 30px rgba(249, 115, 22, 0.7);
    }
    .cq-case-study-record-btn.recording {
      background: #ef4444; /* red-500 */
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
    
    .cq-case-study-submit-btn {
      padding: 0.5rem 2.5rem;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700 */
      border-radius: 0.5rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1rem;
    }
    .cq-case-study-submit-btn:hover:not(:disabled) {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
    }
    .cq-case-study-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Resources Section Styles */
    .drop-resource-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, #dc2626 0%, #ea580c 50%, #f97316 100%);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 16px rgba(220, 38, 38, 0.4), 0 0 0 2px rgba(220, 38, 38, 0.2);
      position: relative;
      overflow: hidden;
    }

    .drop-resource-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
      transition: left 0.5s;
    }

    .drop-resource-btn:hover::before {
      left: 100%;
    }

    .drop-resource-btn:hover {
      transform: translateY(-2px) scale(1.02);
      background: linear-gradient(135deg, #ea580c 0%, #f97316 50%, #fb923c 100%);
      box-shadow: 0 8px 24px rgba(220, 38, 38, 0.6), 0 0 0 4px rgba(220, 38, 38, 0.3);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .drop-resource-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 8px rgba(255, 87, 34, 0.4);
    }

    .drop-resource-btn svg {
      width: 20px;
      height: 20px;
      stroke-width: 3;
      transition: transform 0.3s;
    }

    .drop-resource-btn:hover svg {
      transform: rotate(90deg);
    }

    /* Drop Resource Button in Search Bar */
    .drop-resource-btn-search {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      width: 2.25rem;
      height: 2.25rem;
      border-radius: 1.125rem;
      background: linear-gradient(135deg, #dc2626 0%, #ea580c 50%, #f97316 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
      z-index: 2;
      overflow: hidden;
    }

    .drop-resource-btn-search::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.4s, height 0.4s;
    }

    .drop-resource-btn-search:hover::before {
      width: 100px;
      height: 100px;
    }

    .drop-resource-btn-search:hover {
      transform: translateY(-50%) scale(1.1);
      background: linear-gradient(135deg, #ea580c 0%, #f97316 50%, #fb923c 100%);
      box-shadow: 0 6px 20px rgba(220, 38, 38, 0.6), 0 0 0 3px rgba(220, 38, 38, 0.3);
    }

    .drop-resource-btn-search:active {
      transform: translateY(-50%) scale(0.95);
    }

    .drop-resource-btn-search svg {
      color: white;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 1;
    }

    .drop-resource-btn-search:hover svg {
      transform: rotate(90deg);
    }

    /* Search & Filter Section */
    .filters-section {
      max-width: 80rem;
      margin: 0 auto;
      padding: 0.75rem 2rem;
    }

    .search-container {
      position: relative;
      margin-bottom: 0.75rem;
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #ff5722;
      width: 20px;
      height: 20px;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 3rem;
      border-radius: 1.5rem;
      background: rgba(26, 26, 26, 0.4);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .search-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .search-input:focus {
      outline: none;
      border-color: rgba(255, 87, 34, 0.5);
      background: rgba(26, 26, 26, 0.6);
      box-shadow: 0 8px 32px rgba(255, 87, 34, 0.2), 0 0 0 2px rgba(255, 87, 34, 0.1);
    }

    .category-filters {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.25rem;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.875rem;
      border: 2px solid #2a2a2a;
      background-color: #1a1a1a;
      color: #888;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .filter-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 87, 34, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .filter-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .filter-btn:hover {
      background-color: #2a2a2a;
      border-color: #ff5722;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
    }

    .filter-btn.active {
      background-color: #ff5722;
      color: #fff;
      border: none;
      box-shadow: 0 4px 12px rgba(255, 87, 34, 0.4);
    }

    .filter-btn.active:hover {
      background-color: #f97316;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 87, 34, 0.5);
    }

    .tag-section {
      margin-top: 1.5rem;
    }

    .tag-section-label {
      color: #999;
      font-size: 0.875rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .tag-filters {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .tag-btn {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
      border: 1px solid #2a2a2a;
      background-color: #1a1a1a;
      color: #888;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .tag-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 87, 34, 0.15);
      transform: translate(-50%, -50%);
      transition: width 0.5s, height 0.5s;
    }

    .tag-btn:hover::before {
      width: 200px;
      height: 200px;
    }

    .tag-btn:hover {
      background-color: #2a2a2a;
      border-color: #ff5722;
      color: #fff;
      transform: translateY(-1px) scale(1.05);
      box-shadow: 0 2px 8px rgba(255, 87, 34, 0.25);
    }

    .tag-btn.active {
      background-color: #ff5722;
      color: #fff;
      border: none;
      box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3);
    }

    .tag-btn.active:hover {
      background-color: #f97316;
      transform: translateY(-1px) scale(1.05);
      box-shadow: 0 4px 12px rgba(255, 87, 34, 0.4);
    }

    /* Resources Grid */
    .resources-section {
      max-width: 80rem;
      margin: 0 auto;
      padding: 1rem 2rem 3rem;
    }

    .resources-grid {
      display: grid;
      gap: 2rem;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }

    .resource-card {
      border-radius: 0.75rem;
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 1.5rem;
      background: rgba(15, 15, 15, 0.4);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      transition: all 0.3s ease;
      cursor: pointer;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .resource-card:hover {
      transform: scale(1.02);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 87, 34, 0.3);
      border-color: rgba(255, 87, 34, 0.5);
      background: rgba(15, 15, 15, 0.6);
    }

    .resource-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .resource-title {
      font-size: 1.25rem;
      font-weight: 900;
      color: white;
      margin-bottom: 0.5rem;
      line-height: 1.25;
    }

    .resource-description {
      color: #999;
      font-size: 0.875rem;
    }

    .resource-tags {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .tag {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 700;
      color: white;
      background-color: #1a1a1a;
    }

    .category-badge {
      display: inline-block;
      margin-bottom: 1rem;
    }

    .category-badge span {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 900;
      text-transform: uppercase;
      background-color: #ff5722;
      color: #fff;
    }

    .resource-meta {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #1a1a1a;
    }

    .resource-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .like-btn {
      background-color: #1a1a1a;
      color: #888;
    }

    .like-btn.liked {
      background-color: #ff5722;
      color: #fff;
    }

    .visit-btn {
      background-color: #ff5722;
      color: #fff;
    }

    .action-btn:hover {
      opacity: 0.8;
    }

    .share-btn {
      padding: 0.5rem;
      border-radius: 0.5rem;
      background-color: #1a1a1a;
      color: #ff5722;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .share-btn:hover {
      opacity: 0.8;
    }

    .delete-btn {
      padding: 0.5rem;
      border-radius: 0.5rem;
      background-color: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
      cursor: pointer;
      transition: all 0.2s;
    }

    .delete-btn:hover {
      background-color: rgba(239, 68, 68, 0.3);
      border-color: rgba(239, 68, 68, 0.5);
      transform: scale(1.05);
    }

    .empty-state {
      text-align: center;
      padding: 5rem 0;
    }

    .empty-state p {
      color: #999;
      font-size: 1.125rem;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1rem;
    }

    .modal {
      border-radius: 0.75rem;
      border: 2px solid #1a1a1a;
      padding: 2rem;
      max-width: 28rem;
      width: 100%;
      background-color: #0f0f0f;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 900;
      color: white;
    }

    .modal-close {
      padding: 0.5rem;
      background-color: #1a1a1a;
      color: #ff5722;
      border: none;
      cursor: pointer;
      border-radius: 0.25rem;
      transition: all 0.2s;
    }

    .modal-close:hover {
      opacity: 0.8;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      color: white;
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background-color: #1a1a1a;
      border: 2px solid #1a1a1a;
      color: white;
      font-size: 1rem;
    }

    .form-textarea {
      resize: none;
      min-height: 80px;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: #ff5722;
    }

    .submit-btn {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-weight: 900;
      color: white;
      background-color: #ff5722;
      border: none;
      cursor: pointer;
      font-size: 1.125rem;
      transition: all 0.2s;
    }

    .submit-btn:hover {
      transform: scale(1.05);
    }

    .submit-btn:active {
      transform: scale(0.95);
    }

    /* Study Mode Sticky Button */
    .study-mode-button {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background: linear-gradient(135deg, #dc2626 0%, #ea580c 50%, #f97316 100%);
      border: 2px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(220, 38, 38, 0.5), 0 0 0 4px rgba(220, 38, 38, 0.2);
      z-index: 1000;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
    }

    .study-mode-button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .study-mode-button:hover::before {
      width: 200px;
      height: 200px;
    }

    .study-mode-button:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 12px 32px rgba(220, 38, 38, 0.6), 0 0 0 6px rgba(220, 38, 38, 0.3);
    }

    .study-mode-button:active {
      transform: scale(0.95);
    }

    .study-mode-button svg {
      width: 2rem;
      height: 2rem;
      color: white;
      position: relative;
      z-index: 1;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
      display: block;
      margin: 0 auto;
    }

    /* Study Mode Modal - Using Quiz Design */
    .study-mode-modal {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display: none;
      flex-direction: column;
      min-height: 100vh;
      overflow-y: auto;
      color: #fff;
    }

    .study-mode-modal.active {
      display: flex !important;
    }

    .study-mode-option-large {
      padding: 3rem 2rem !important;
      font-size: 2rem !important;
      min-height: 120px !important;
    }

    .study-mode-option-large .practice-quiz-option-text {
      font-size: 2rem !important;
      font-weight: 900 !important;
    }

    /* Darts Game Styles */
    .darts-game-container {
      position: fixed;
      inset: 0;
      z-index: 20000;
      display: none;
      flex-direction: column;
      background: #0a0a0a;
      color: white;
      overflow-y: auto;
    }

    .darts-game-container.active {
      display: flex;
    }

    .darts-stars-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .darts-star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      border-radius: 50%;
      animation: darts-twinkle 3s infinite;
    }

    @keyframes darts-twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 0.8; }
    }

    .darts-menu-content {
      position: relative;
      z-index: 10;
      min-height: calc(100vh - 80px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
    }

    .darts-menu-title {
      font-size: 4.5rem;
      font-weight: 900;
      color: white;
      margin-bottom: 1.5rem;
    }

    .darts-menu-subtitle {
      font-size: 3.75rem;
      font-weight: 900;
      color: #ff5722;
      margin-bottom: 2rem;
    }

    .darts-menu-desc {
      color: #94a3b8;
      font-size: 1.125rem;
      margin-bottom: 3rem;
      max-width: 32rem;
    }

    .darts-start-btn {
      padding: 1rem 3rem;
      border-radius: 0.75rem;
      font-weight: 900;
      color: white;
      background: #ff5722;
      border: none;
      cursor: pointer;
      font-size: 1.125rem;
      transition: all 0.2s;
    }

    .darts-start-btn:hover {
      transform: scale(1.05);
    }

    .darts-start-btn:active {
      transform: scale(0.95);
    }

    /* Hearts */
    .darts-hearts-container {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .darts-heart {
      transition: all 0.3s;
      filter: drop-shadow(0 0 4px rgba(239, 68, 68, 0.5));
    }

    .darts-heart.broken {
      opacity: 0.3;
      filter: grayscale(100%) drop-shadow(0 0 2px rgba(100, 100, 100, 0.3));
      transform: scale(0.8);
    }

    .darts-heart.breaking {
      animation: darts-heart-break 0.5s ease-out;
    }

    @keyframes darts-heart-break {
      0% { transform: scale(1) rotate(0deg); opacity: 1; }
      50% { transform: scale(1.2) rotate(180deg); opacity: 0.7; }
      100% { transform: scale(0.8) rotate(360deg); opacity: 0.3; }
    }

    .darts-game-area {
      position: relative;
      z-index: 10;
      width: 100%;
      min-height: calc(100vh - 160px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      padding-top: 6rem;
      padding-bottom: 8rem;
    }

    .darts-board-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #dartsBoardCanvas {
      border-radius: 50%;
      box-shadow: 0 0 40px rgba(255, 87, 34, 0.6), 0 0 80px rgba(255, 87, 34, 0.4), 0 10px 40px rgba(0, 0, 0, 0.8);
      cursor: crosshair;
      position: relative;
    }

    #dartsDartCanvas {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }

    .darts-top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      border-bottom: 1px solid #1a1a1a;
      background: #000000;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .darts-title {
      font-size: 1.875rem;
      font-weight: 900;
      color: #ff5722;
      margin: 0;
    }

    .darts-stats-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      align-items: flex-end;
      text-align: right;
    }

    .darts-stats-label {
      color: #94a3b8;
      font-size: 0.875rem;
      margin: 0;
    }

    .darts-bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 10;
      border-top: 1px solid #1a1a1a;
      background: #000000;
      padding: 1.5rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .darts-hit-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .darts-hit-label {
      color: #94a3b8;
      font-size: 0.875rem;
    }

    .darts-hit-text {
      color: #ff5722;
      font-weight: 700;
    }

    .darts-end-btn {
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      font-weight: 900;
      color: white;
      background: #ff5722;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .darts-end-btn:hover {
      transform: scale(1.05);
    }

    .darts-results-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(20px);
      z-index: 30000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .darts-results-modal.active {
      display: flex;
    }

    .darts-results-content {
      background: #0f0f0f;
      border: 2px solid #ff5722;
      border-radius: 0.75rem;
      padding: 3rem;
      max-width: 28rem;
      width: 100%;
    }

    .darts-results-title {
      font-size: 2.25rem;
      font-weight: 900;
      color: white;
      margin-bottom: 0.5rem;
    }

    .darts-results-subtitle {
      color: #94a3b8;
      font-size: 1.125rem;
      margin-bottom: 3rem;
    }

    .darts-results-stats {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-bottom: 3rem;
      background: #1a1a1a;
      border-radius: 0.75rem;
      padding: 2rem;
    }

    .darts-stat-item {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .darts-stat-label {
      color: #94a3b8;
      font-size: 0.875rem;
      font-weight: 700;
    }

    .darts-stat-value {
      font-size: 2.25rem;
      font-weight: 900;
      color: #ff5722;
    }

    .darts-stat-value.white {
      color: white;
    }

    .darts-stat-value.green {
      color: #4caf50;
    }

    .darts-play-again-btn {
      width: 100%;
      padding: 1rem;
      border-radius: 0.75rem;
      font-weight: 900;
      color: white;
      background: #ff5722;
      border: none;
      cursor: pointer;
      font-size: 1.125rem;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .darts-play-again-btn:hover {
      transform: scale(1.02);
    }

    /* Blackjack Game Styles */
    .blackjack-game-container {
      position: fixed;
      inset: 0;
      z-index: 20000;
      display: none;
      flex-direction: column;
      background: #0a0a0a;
      color: white;
      overflow-y: auto;
    }

    .blackjack-game-container.active {
      display: flex;
    }

    .blackjack-stars-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .blackjack-star {
      position: absolute;
      width: 4px;
      height: 4px;
      background: white;
      border-radius: 50%;
    }

    @keyframes blackjack-twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 0.8; }
    }

    .blackjack-menu-content {
      position: relative;
      z-index: 10;
      min-height: calc(100vh - 80px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
    }

    .blackjack-menu-title {
      font-size: 3.5rem;
      font-weight: 900;
      color: white;
      margin-bottom: 1.5rem;
    }

    .blackjack-menu-subtitle {
      font-size: 3rem;
      font-weight: 900;
      color: #ff5722;
      margin-bottom: 2rem;
    }

    .blackjack-menu-desc {
      color: #9ca3af;
      font-size: 1.125rem;
      margin-bottom: 1rem;
      max-width: 32rem;
    }

    .blackjack-menu-subdesc {
      color: #ff5722;
      font-size: 0.875rem;
      margin-bottom: 2rem;
      font-style: italic;
      max-width: 32rem;
    }

    .blackjack-start-btn {
      padding: 1rem 3rem;
      border-radius: 12px;
      font-weight: 900;
      color: white;
      background: #ff5722;
      border: none;
      cursor: pointer;
      font-size: 1.125rem;
      transition: transform 0.2s;
    }

    .blackjack-start-btn:hover {
      transform: scale(1.05);
    }

    .blackjack-start-btn:active {
      transform: scale(0.95);
    }

    .blackjack-top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      border-bottom: 1px solid #1a1a1a;
      background: #000000;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .blackjack-title {
      font-size: 1.875rem;
      font-weight: 900;
      color: #ff5722;
      margin: 0;
    }

    .blackjack-stats-info {
      display: flex;
      gap: 2rem;
      color: white;
      font-weight: 700;
    }

    .blackjack-game-area {
      position: relative;
      z-index: 10;
      width: 100%;
      min-height: calc(100vh - 160px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      padding-top: 6rem;
      padding-bottom: 8rem;
      max-width: 56rem;
      margin: 0 auto;
    }

    .blackjack-dealer-section,
    .blackjack-player-section {
      width: 100%;
      text-align: center;
      margin-bottom: 4rem;
    }

    .blackjack-section-label {
      color: #9ca3af;
      font-size: 0.875rem;
      margin-bottom: 1rem;
      font-weight: 700;
    }

    .blackjack-cards-container {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .blackjack-card {
      display: inline-block;
    }

    .blackjack-hand-total {
      color: white;
      font-weight: 700;
      margin-top: 1rem;
    }

    .blackjack-betting-section {
      text-align: center;
      margin-top: 2rem;
    }

    .blackjack-betting-label {
      color: #9ca3af;
      font-size: 1.125rem;
      margin-bottom: 2rem;
    }

    .blackjack-bet-buttons {
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .blackjack-bet-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 700;
      color: white;
      background: #ff5722;
      border: none;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .blackjack-bet-btn:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .blackjack-bet-btn:disabled {
      background: #666666;
      cursor: default;
      opacity: 0.5;
    }

    .blackjack-playing-section {
      text-align: center;
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
    }

    .blackjack-action-btn {
      padding: 0.75rem 2rem;
      border-radius: 12px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: transform 0.2s;
      font-size: 1rem;
    }

    .blackjack-hit-btn {
      color: white;
      background: #ff5722;
    }

    .blackjack-hit-btn:hover {
      transform: scale(1.05);
    }

    .blackjack-stand-btn {
      color: #ff5722;
      background: #1a1a1a;
      border: 2px solid #ff5722;
    }

    .blackjack-stand-btn:hover {
      transform: scale(1.05);
    }

    .blackjack-result-section {
      text-align: center;
      margin-top: 2rem;
    }

    .blackjack-result-text {
      font-size: 2.25rem;
      font-weight: 900;
      margin-bottom: 2rem;
      color: #ff5722;
    }

    .blackjack-play-again-btn {
      padding: 0.75rem 2rem;
      border-radius: 12px;
      font-weight: 700;
      color: white;
      background: #ff5722;
      border: none;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .blackjack-play-again-btn:hover {
      transform: scale(1.05);
    }

    /* Memory Match Game Styles */
    .memory-game-container {
      position: fixed;
      inset: 0;
      z-index: 20000;
      display: none;
      flex-direction: column;
      background: #0a0a0a;
      color: white;
      overflow-y: auto;
    }

    .memory-game-container.active {
      display: flex;
    }

    .memory-stars-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .memory-star {
      position: absolute;
      width: 4px;
      height: 4px;
      background: white;
      border-radius: 50%;
    }

    @keyframes memory-twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 0.8; }
    }

    .memory-menu-content {
      position: relative;
      z-index: 10;
      min-height: calc(100vh - 80px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      text-align: center;
    }

    .memory-menu-title {
      font-size: 3.5rem;
      font-weight: 900;
      color: white;
      margin-bottom: 1.5rem;
    }

    .memory-menu-subtitle {
      font-size: 3rem;
      font-weight: 900;
      color: #ff5722;
      margin-bottom: 2rem;
    }

    .memory-menu-desc {
      color: #9ca3af;
      font-size: 1.125rem;
      margin-bottom: 1rem;
      max-width: 32rem;
    }

    .memory-menu-subdesc {
      color: #ff5722;
      font-size: 0.875rem;
      margin-bottom: 2rem;
      font-style: italic;
      max-width: 32rem;
    }

    .memory-start-btn {
      padding: 1rem 3rem;
      border-radius: 12px;
      font-weight: 900;
      color: white;
      background: #ff5722;
      border: none;
      cursor: pointer;
      font-size: 1.125rem;
      transition: transform 0.2s;
    }

    .memory-start-btn:hover {
      transform: scale(1.05);
    }

    .memory-start-btn:active {
      transform: scale(0.95);
    }

    .memory-top-bar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      border-bottom: 1px solid #1a1a1a;
      background: #000000;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .memory-title {
      font-size: 1.875rem;
      font-weight: 900;
      color: #ff5722;
      margin: 0;
    }

    .memory-stats-info {
      display: flex;
      gap: 2rem;
      color: white;
      font-weight: 700;
    }

    .memory-game-area {
      position: relative;
      z-index: 10;
      width: 100%;
      min-height: calc(100vh - 160px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      padding-top: 6rem;
      padding-bottom: 8rem;
    }

    .memory-cards-grid {
      display: grid;
      grid-template-columns: repeat(4, 80px);
      gap: 12px;
      margin-bottom: 3rem;
    }

    .memory-card {
      width: 80px;
      height: 110px;
      padding: 0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      background-color: transparent;
    }

    .memory-card:hover:not(:disabled) {
      transform: scale(1.05);
    }

    .memory-card:disabled {
      cursor: default;
    }

    .memory-complete-section,
    .memory-out-of-turns-section {
      text-align: center;
    }

    .memory-complete-text,
    .memory-out-of-turns-text {
      font-size: 2.25rem;
      font-weight: 900;
      margin-bottom: 2rem;
      color: #ff5722;
    }

    .memory-complete-subtext,
    .memory-out-of-turns-subtext {
      font-size: 1.125rem;
      color: white;
      margin-bottom: 2rem;
    }

    .memory-play-again-btn,
    .memory-answer-questions-btn {
      padding: 0.75rem 2rem;
      border-radius: 12px;
      font-weight: 700;
      color: white;
      background: #ff5722;
      border: none;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .memory-play-again-btn:hover,
    .memory-answer-questions-btn:hover {
      transform: scale(1.05);
    }

    /* Responsive styles for game selection grid */
    @media (max-width: 768px) {
      #studyModeOptions {
        grid-template-columns: 1fr !important;
      }
      
      .memory-cards-grid {
        grid-template-columns: repeat(3, 80px) !important;
      }
    }

    @media (max-width: 480px) {
      .memory-cards-grid {
        grid-template-columns: repeat(2, 70px) !important;
        gap: 8px !important;
      }
      
      .memory-card {
        width: 70px !important;
        height: 95px !important;
      }
    }

    /* 2048 Game Styles */
    .game2048-container {
      position: fixed;
      inset: 0;
      z-index: 20000;
      display: none;
      flex-direction: column;
      background: #000;
      color: white;
      overflow-y: auto;
      font-family: 'Inter', sans-serif;
    }

    .game2048-container.active {
      display: flex;
    }

    .game2048-stars-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .game2048-star {
      position: absolute;
      background: white;
      border-radius: 50%;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.8), 0 0 12px rgba(255, 87, 34, 0.6);
    }

    @keyframes game2048-twinkle {
      0%, 100% {
        opacity: 0.2;
        transform: scale(1);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
    }

    .game2048-container::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(255, 87, 34, 0.08) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(255, 99, 0, 0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 1;
    }

    .game2048-content {
      text-align: center;
      position: relative;
      z-index: 2;
      width: 100%;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      max-height: 100vh;
      overflow-y: auto;
    }

    .game2048-title {
      font-family: 'Inter', sans-serif;
      color: #FF5722;
      font-size: clamp(48px, 12vw, 72px);
      font-weight: 900;
      margin-bottom: 0.5rem;
      letter-spacing: -2px;
      text-shadow: 0 0 40px rgba(255, 87, 34, 0.3);
    }

    .game2048-subtitle {
      color: #94a3b8;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 1rem;
      opacity: 0.8;
    }

    .game2048-score-container {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      width: 100%;
    }

    .game2048-score-box {
      background: rgba(20, 20, 20, 0.8);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1.25rem;
      border-radius: 0.75rem;
      border: 2px solid #FF5722;
      box-shadow: 
        0 0 30px rgba(255, 87, 34, 0.2),
        inset 0 1px 1px rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
      min-width: 110px;
      flex: 1;
      max-width: 150px;
    }

    .game2048-score-box:hover {
      background: rgba(20, 20, 20, 0.95);
      border-color: #FF5722;
      box-shadow: 
        0 0 40px rgba(255, 87, 34, 0.4),
        inset 0 1px 1px rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .game2048-score-label {
      color: #FF5722;
      font-size: 0.625rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
      opacity: 0.9;
    }

    .game2048-score-value {
      color: #FF5722;
      font-size: clamp(20px, 6vw, 28px);
      font-weight: 900;
      font-family: 'Inter', sans-serif;
    }

    .game2048-grid {
      background: rgba(20, 20, 20, 0.6);
      backdrop-filter: blur(20px);
      border-radius: 1rem;
      padding: clamp(8px, 2vw, 16px);
      box-shadow: 
        0 0 60px rgba(255, 87, 34, 0.25),
        0 0 120px rgba(255, 99, 0, 0.15),
        inset 0 1px 1px rgba(255, 255, 255, 0.05);
      display: inline-block;
      border: 2px solid #FF5722;
      margin: 1rem 0;
    }

    .game2048-grid-row {
      display: flex;
      gap: clamp(8px, 1.5vw, 12px);
      margin-bottom: clamp(8px, 1.5vw, 12px);
    }

    .game2048-grid-row:last-child {
      margin-bottom: 0;
    }

    .game2048-grid-cell {
      width: clamp(60px, 15vw, 100px);
      height: clamp(60px, 15vw, 100px);
      background: rgba(40, 40, 40, 0.7);
      border-radius: 0.625rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(24px, 8vw, 44px);
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      transition: all 0.12s cubic-bezier(0.23, 1, 0.320, 1);
      border: 2px solid #333;
      position: relative;
    }
    
    .game2048-grid-cell:hover {
      background: rgba(50, 50, 50, 0.8);
      border-color: #FF5722;
    }

    .game2048-tile {
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      position: absolute;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.75rem;
      font-family: 'Inter', sans-serif;
      font-weight: 700;
    }

    .game2048-tile-2 {
      background: linear-gradient(135deg, #FF5722 0%, #FF7043 100%);
      box-shadow: 0 0 20px rgba(255, 87, 34, 0.6);
    }

    .game2048-tile-4 {
      background: linear-gradient(135deg, #E64A19 0%, #FF5722 100%);
      box-shadow: 0 0 20px rgba(230, 74, 25, 0.6);
    }

    .game2048-tile-8 {
      background: linear-gradient(135deg, #D84315 0%, #E64A19 100%);
      box-shadow: 0 0 25px rgba(216, 67, 21, 0.7);
    }

    .game2048-tile-16 {
      background: linear-gradient(135deg, #BF360C 0%, #D84315 100%);
      box-shadow: 0 0 25px rgba(191, 54, 12, 0.7);
      font-size: 2.5rem;
    }

    .game2048-tile-32 {
      background: linear-gradient(135deg, #FF6F00 0%, #FF5722 100%);
      box-shadow: 0 0 30px rgba(255, 111, 0, 0.8);
      font-size: 2.5rem;
    }

    .game2048-tile-64 {
      background: linear-gradient(135deg, #FF9100 0%, #FF6F00 100%);
      box-shadow: 0 0 30px rgba(255, 145, 0, 0.8);
      font-size: 2.5rem;
    }

    .game2048-tile-128 {
      background: linear-gradient(135deg, #FFB300 0%, #FF9100 100%);
      box-shadow: 0 0 35px rgba(255, 179, 0, 0.9);
      font-size: 2.25rem;
    }

    .game2048-tile-256 {
      background: linear-gradient(135deg, #FFC400 0%, #FFB300 100%);
      box-shadow: 0 0 35px rgba(255, 196, 0, 0.9);
      font-size: 2.25rem;
    }

    .game2048-tile-512 {
      background: linear-gradient(135deg, #FFEA00 0%, #FFC400 100%);
      box-shadow: 0 0 40px rgba(255, 234, 0, 1);
      font-size: 2.25rem;
      color: #333;
    }

    .game2048-tile-1024 {
      background: linear-gradient(135deg, #FFD600 0%, #FFEA00 100%);
      box-shadow: 0 0 40px rgba(255, 214, 0, 1);
      font-size: 2rem;
      color: #333;
    }

    .game2048-tile-2048 {
      background: linear-gradient(135deg, #FFC400 0%, #FFD600 100%);
      box-shadow: 0 0 50px rgba(255, 196, 0, 1);
      font-size: 2rem;
      color: #333;
    }

    .game2048-tile-4096 {
      background: linear-gradient(135deg, #FF5722 0%, #FFC400 100%);
      box-shadow: 0 0 50px rgba(255, 87, 34, 1);
      font-size: 1.875rem;
    }

    .game2048-tile-8192 {
      background: linear-gradient(135deg, #E91E63 0%, #FF5722 100%);
      box-shadow: 0 0 55px rgba(233, 30, 99, 1);
      font-size: 1.75rem;
    }

    @keyframes game2048-slideIn {
      from {
        opacity: 0;
        transform: scale(0.5);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes game2048-mergePulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }

    @keyframes game2048-fadeOut {
      from {
        opacity: 1;
        transform: scale(1);
      }
      to {
        opacity: 0;
        transform: scale(0.7);
      }
    }

    .game2048-new-tile {
      animation: game2048-slideIn 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .game2048-merge-tile {
      animation: game2048-mergePulse 0.2s ease-out;
    }

    .game2048-merge-out {
      animation: game2048-fadeOut 0.2s ease-out forwards;
    }

    .game2048-controls {
      margin-top: 1rem;
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .game2048-btn {
      background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%);
      color: white;
      border: none;
      padding: clamp(10px, 2vw, 14px) clamp(20px, 4vw, 32px);
      font-size: clamp(13px, 3vw, 16px);
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      border-radius: 0.625rem;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(255, 87, 34, 0.4);
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      backdrop-filter: blur(10px);
      border: 2px solid #FF5722;
    }

    .game2048-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(255, 87, 34, 0.6);
      background: linear-gradient(135deg, #FF6E40 0%, #FF5722 100%);
    }

    .game2048-btn:active {
      transform: translateY(0);
    }

    .game2048-continue-btn {
      background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%);
      border-color: #333;
      margin-top: 0;
      margin-left: 1rem;
    }

    .game2048-continue-btn:hover {
      background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
      border-color: #FF5722;
      box-shadow: 0 6px 30px rgba(255, 87, 34, 0.3);
    }

    .game2048-instructions {
      color: #ccc;
      margin-top: 1rem;
      font-size: clamp(12px, 3vw, 15px);
      background: rgba(20, 20, 20, 0.7);
      backdrop-filter: blur(10px);
      padding: 0.75rem;
      border-radius: 0.625rem;
      max-width: 90%;
      border: 2px solid #FF5722;
      line-height: 1.5;
    }
    
    .game2048-instructions strong {
      color: #FF5722;
    }

    .game2048-over {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
      z-index: 20001;
      animation: game2048-fadeIn 0.3s ease;
    }

    .game2048-over.active {
      display: flex;
    }

    @keyframes game2048-fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .game2048-over-content {
      background: linear-gradient(135deg, rgba(20, 20, 20, 0.98) 0%, rgba(30, 30, 30, 0.98) 100%);
      padding: clamp(30px, 6vw, 48px);
      border-radius: 1rem;
      text-align: center;
      border: 3px solid #FF5722;
      box-shadow: 
        0 0 80px rgba(255, 87, 34, 0.4),
        0 0 160px rgba(255, 87, 34, 0.2);
      animation: game2048-slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    @keyframes game2048-slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .game2048-over h2 {
      font-family: 'Inter', sans-serif;
      color: #FF5722;
      font-size: clamp(36px, 8vw, 48px);
      margin-bottom: 0.75rem;
      font-weight: 900;
    }

    .game2048-over p {
      color: #ccc;
      font-size: clamp(16px, 5vw, 22px);
      margin-bottom: 1rem;
      font-family: 'Inter', sans-serif;
    }

    .game2048-stats {
      color: #FF5722;
      font-size: clamp(11px, 3vw, 13px);
      margin-bottom: 1rem;
      line-height: 1.8;
    }

    .game2048-expansion-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
      z-index: 20002;
      animation: game2048-fadeIn 0.3s ease;
    }

    .game2048-expansion-modal.active {
      display: flex;
    }

    .game2048-expansion-content {
      background: linear-gradient(135deg, rgba(20, 20, 20, 0.98) 0%, rgba(30, 30, 30, 0.98) 100%);
      padding: clamp(30px, 6vw, 48px);
      border-radius: 1rem;
      text-align: center;
      border: 3px solid #FF5722;
      box-shadow: 
        0 0 80px rgba(255, 87, 34, 0.4),
        0 0 160px rgba(255, 87, 34, 0.2);
      animation: game2048-slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .game2048-expansion-content h2 {
      font-family: 'Inter', sans-serif;
      color: #FF5722;
      font-size: clamp(36px, 8vw, 48px);
      margin-bottom: 1rem;
      font-weight: 900;
    }

    .game2048-expansion-content p {
      color: #fff;
      font-size: clamp(20px, 5vw, 28px);
      margin-bottom: 1.5rem;
      font-family: 'Inter', sans-serif;
      font-weight: 600;
    }
  </style>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
<script type="module" src="/js/firebase.js"></script></head>
<body>
  <div class="min-h-screen text-white overflow-hidden">
    <!-- Galaxy Background -->
    <div class="galaxy-background">
      <div class="galaxy-gradient"></div>
      <div class="stars-container" id="starsContainer"></div>
      <div class="nebula nebula-1"></div>
      <div class="nebula nebula-2"></div>
      <div class="nebula nebula-3"></div>
    </div>

    <!-- Header -->
    <div class="blaze-header">
      <div class="blaze-header-content">
        <div class="header-left">
          <button class="hamburger-menu" id="hamburgerMenu" onclick="toggleMobileNav()" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <h1 class="blaze-logo">FBLAZE</h1>
        </div>
        <h1 class="blaze-logo desktop-logo">FBLAZE</h1>
        <!-- Nav Links -->
        <nav class="blaze-nav" id="mainNav">
          <button class="mobile-nav-close" onclick="toggleMobileNav()" aria-label="Close menu">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
          <a href="home3.html" class="nav-link">Home</a>
          <a href="javascript:void(0)" onclick="toggleNotificationPanel()" class="nav-link">
            Notifications
            <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
          </a>
          <a href="practice.html" class="nav-link">Practice</a>
          <a href="Forum/forum.html" class="nav-link">Forum</a>
          <a href="Calendar/calendar1.html" class="nav-link">Calendar</a>
          <a href="mentor1.html" class="nav-link" id="mentorNavLink" style="display: none;">Mentor</a>
        </nav>
      </div>
      
      <!-- Sub-Navigation Tabs -->
      <div class="create-sub-nav">
        <div class="create-sub-nav-content">
          <a href="Competitions/competition1.html" class="create-sub-nav-link">Your Journey</a>
          <a href="practice.html" class="create-sub-nav-link active">Practice Hub</a>
          <a href="statistics1.html" class="create-sub-nav-link">Your Statistics</a>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="practice-container">
      <!-- Hero Section -->
      <div class="practice-hero">
        <h1 class="practice-hero-title">
          What will you
          <br />
          <span class="practice-hero-gradient">practice today?</span>
        </h1>

        <!-- Search Section -->
        <div class="practice-search-section">
          <div class="search-container" style="max-width: 80rem; margin: 0 auto; position: relative;">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #ff5722; width: 20px; height: 20px; z-index: 1;">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input 
              type="text" 
              id="searchInput"
              placeholder="Search resources..." 
              class="search-input"
              style="width: 100%; padding: 0.75rem 3.25rem 0.75rem 3rem; border-radius: 1.5rem; background: rgba(26, 26, 26, 0.4); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); color: white; font-size: 1rem; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);"
            />
            <button class="drop-resource-btn-search" id="dropResourceBtn" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); width: 2.25rem; height: 2.25rem; border-radius: 1.125rem; background: linear-gradient(135deg, #dc2626 0%, #ea580c 50%, #f97316 100%); border: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4); z-index: 2;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" style="color: white; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="practice-tabs">
          <button class="practice-tab active" id="resourcesTab" onclick="selectTab(this)">Resources</button>
          <button class="practice-tab" id="createTab" onclick="selectTab(this)">Create</button>
        </div>
      </div>

      <!-- Featured Challenge -->
      <div class="featured-challenge">
        <div class="challenge-content">
          <div class="challenge-text">
            <h3 class="challenge-title">FBLA Competitions Challenge</h3>
            <p class="challenge-desc">Compete against other competitions in a bracket style tournament match to see who is the best competition is!</p>
            <button class="challenge-button" onclick="toggleCompete()">Compete</button>
          </div>
          <div class="challenge-emoji"></div>
        </div>
      </div>

      <!-- Resources Section -->
      <div class="resources-section-wrapper" style="margin-bottom: 3rem;">
        <!-- Search & Filter Section -->
        <section class="filters-section">
          <!-- Category Filter -->
          <div class="category-filters" id="categoryFilters">
            <button class="filter-btn active" data-category="all">all</button>
            <button class="filter-btn" data-category="tutorial">tutorial</button>
            <button class="filter-btn" data-category="course">course</button>
            <button class="filter-btn" data-category="reference">reference</button>
            <button class="filter-btn" data-category="article">article</button>
            <button class="filter-btn" data-category="tool">tool</button>
            <button class="filter-btn" data-category="tool">quizlet</button>
          </div>

          <!-- Tag Filter -->
          <div class="tag-section">
            <p class="tag-section-label">FILTER BY COMPETITION</p>
            <div class="tag-filters" id="tagFilters">
              <!-- Competition buttons will be dynamically generated -->
            </div>
          </div>
        </section>

        <!-- Resources Grid -->
        <section class="resources-section">
          <div class="resources-grid" id="resourcesGrid">
            <!-- Resources will be dynamically inserted here -->
          </div>
          <div class="empty-state" id="emptyState" style="display: none;">
            <p>No resources match your filters. Try something else!</p>
          </div>
        </section>
      </div>

      <!-- CTA -->
      <div class="practice-cta">
        <p class="cta-label">Ready to Dominate</p>
        <h2 class="cta-title">Keep grinding. Your success is our mission.</h2>
        <p class="cta-desc">Complete assignments, master topics, and unlock your full potential. One practice session at a time.</p>
        <button class="cta-button" onclick="window.location.href='create1.html'">Start Practicing</button>
      </div>
    </div>
  </div>

  <!-- Notification Panel -->
  <div id="notificationPanel" class="notification-panel hidden">
    <div class="notification-panel-header">
      <h3 class="notification-panel-title">NOTIFICATIONS</h3>
      <button onclick="toggleNotificationPanel()" class="close-notifications"></button>
    </div>
    <div id="notificationList" class="notification-list"></div>
  </div>

<!-- Flashcard Modal -->
<div id="flashcardModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeFlashcardModal()">&times;</span>
    <div class="modal-header">
      <h2>Your Flashcard Decks</h2>
      <div class="competency-filter" id="competencyFilter"></div>
    </div>
    <div class="flashcard-view">
      <div class="flashcard-controls">
        <button id="prevCard"> Previous</button>
        <span id="cardCounter">1/10</span>
        <button id="nextCard">Next </button>
      </div>
      <div class="flashcard" id="currentFlashcard">
        <div class="flashcard-front">
          <h3>Loading flashcards...</h3>
        </div>
        <div class="flashcard-back hidden">
          <p>Answer will appear here</p>
        </div>
      </div>
      <div class="flashcard-actions">
        <button class="difficulty-btn easy" onclick="rateDifficulty('easy')">Easy</button>
        <button class="difficulty-btn medium" onclick="rateDifficulty('medium')">Medium</button>
        <button class="difficulty-btn hard" onclick="rateDifficulty('hard')">Hard</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>

<script>





  // ADD THIS CODE AT THE TOP OF YOUR practice.html <script> TAG
  // This removes duplicate click listeners from the record button

  // Initialize recording variables
  let isRecording = false;
  let isIntentionallyStopping = false;
  let recordingStateMonitor = null;
  let cqSpeakingMediaRecorder = null;
  let cqSpeakingMediaStream = null;
  let cqSpeakingRecordedChunks = [];

  // Remove duplicate click listeners when page loads
  document.addEventListener('DOMContentLoaded', function() {
    // Wait a moment for all listeners to be attached
    setTimeout(function() {
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      
      if (recordBtn && typeof getEventListeners !== 'undefined') {
        try {
          const listeners = getEventListeners(recordBtn);
          
          if (listeners.click && listeners.click.length > 1) {
            console.log('Found ' + listeners.click.length + ' click listeners');
            
            // Remove all except the first one (which is the onclick attribute)
            for (let i = listeners.click.length - 1; i > 0; i--) {
              recordBtn.removeEventListener('click', listeners.click[i].listener);
              console.log('Removed duplicate click listener #' + (i + 1));
            }
            
            // Verify cleanup
            const newListeners = getEventListeners(recordBtn);
            console.log('Click listeners remaining: ' + newListeners.click.length);
            console.log(' Recording button listeners cleaned up');
          }
        } catch (e) {
          console.log('Could not clean up listeners (may not be in DevTools): ' + e.message);
        }
      }
    }, 500);
  });


 const competencyIcons = {
  'Business Communication': '',
  'Marketing': '',
  'Accounting': '',
  'Economics': '',
  'Management': '',
  'Parliamentary Procedure': '',
  'Business Ethics': '',
  'Finance': '',
  'Entrepreneurship': '',
  'General': ''
};

const competitionTypes = {
  'written': '',
  'speaking': '', 
  'case': ''
};



  // Initialize Firebase
  const auth = firebase.auth();
  const db = firebase.firestore();
let recentlyStudiedDecks = [];
let currentDeck = null;

  // ========== SPEAKING ASSIGNMENT RECORDING VARIABLES ==========
  // Variables are now initialized at the top of the script tag

  // Define toggleNotificationPanel immediately to make it available for onclick handlers
  window.toggleNotificationPanel = function() {
    const panel = document.getElementById("notificationPanel");
    if (!panel) return;
    
    if (panel.classList.contains("active")) {
      panel.classList.remove("active");
      setTimeout(() => panel.classList.add("hidden"), 300);
    } else {
      panel.classList.remove("hidden");
      setTimeout(() => panel.classList.add("active"), 10);
      if (typeof loadNotifications === 'function') {
        loadNotifications();
      }
    }
  };
let currentCardIndex = 0;
let isFlipped = false;
let timer; // For quiz timer



// Close flashcard modal
function closeFlashcardModal() {
  document.getElementById('flashcardModal').style.display = 'none';
  currentDeck = null;
  currentCardIndex = 0;
  isFlipped = false;
}

function openNotificationsOnHome() {
    // Set a flag in sessionStorage (gets cleared when browser is closed)
    sessionStorage.setItem('openNotifications', 'true');
    // Navigate to home page - CHANGE THIS PATH to match your structure
    window.location.href = 'public/home.html';
}

// Show current flashcard
function showCurrentFlashcard() {
  if (!currentDeck || !currentDeck.cards.length) return;
  
  const card = currentDeck.cards[currentCardIndex];
  const flashcardElement = document.getElementById('currentFlashcard');
  const counterElement = document.getElementById('cardCounter');
  
  // Update counter
  counterElement.textContent = `${currentCardIndex + 1}/${currentDeck.cards.length}`;
  
  // Reset flip state
  isFlipped = false;
  flashcardElement.classList.remove('flipped');
  
  // Update card content
  flashcardElement.querySelector('.flashcard-front h3').textContent = card.question;
  flashcardElement.querySelector('.flashcard-back p').innerHTML = `
    <strong>Correct Answer:</strong> ${card.answer}<br>
    ${card.userAnswer ? `<strong>Your Answer:</strong> ${card.userAnswer}` : ''}
  `;
  
  // Add click to flip
  flashcardElement.onclick = () => {
    isFlipped = !isFlipped;
    flashcardElement.classList.toggle('flipped');
  };
}

async function loadCompetitionName() {
  try {
    const user = firebase.auth().currentUser;
    
    if (!user) {
      console.log('No user authenticated, waiting...');
      return;
    }
    
    const userId = user.uid;
    console.log(' Loading competition for user:', userId);
    
    // Get user document
    const userDoc = await db.collection('users').doc(userId).get();
    
    if (!userDoc.exists) {
      console.log('User document not found');
      const compElement = document.getElementById('comp');
      if (compElement) {
        compElement.textContent = 'User not found';
      }
      return;
    }
    
    const userData = userDoc.data();
    const competitions = userData.competitions;
    
    // DEBUG: Log the entire competitions array
    console.log(' DEBUG - Full competitions array:', competitions);
    console.log(' DEBUG - Type of first competition:', typeof competitions[0]);
    console.log(' DEBUG - First competition value:', competitions[0]);
    
    const compElement = document.getElementById('comp');
    if (!compElement) {
      console.log('Competition element not found in DOM');
      return;
    }
    
    if (!competitions || competitions.length === 0) {
      compElement.textContent = 'No competition assigned';
      return;
    }
    
    const competitionValue = competitions[0];
    
    // If it looks like a name string, use it directly
    if (typeof competitionValue === 'string' && competitionValue.length > 0) {
      console.log(' Using competition name directly:', competitionValue);
      compElement.textContent = competitionValue;
      return;
    }
    
    // Otherwise try to look it up as a document ID
    console.log(' Looking for competition as document ID:', competitionValue);
    const competitionDoc = await db.collection('competitions').doc(competitionValue).get();
    
    if (!competitionDoc.exists) {
      console.log(' Competition document not found:', competitionValue);
      compElement.textContent = 'Competition not found';
      return;
    }
    
    const competitionData = competitionDoc.data();
    const competitionName = competitionData.name || 'Unnamed Competition';
    
    console.log(' Found competition name:', competitionName);
    compElement.textContent = competitionName;
    
  } catch (error) {
    console.error(' Error:', error);
    const compElement = document.getElementById('comp');
    if (compElement) {
      compElement.textContent = 'Error loading';
    }
  }
}

// Make sure this runs AFTER authentication
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    console.log(' User authenticated, loading competition...');
    loadCompetitionName();
    loadIncompleteAssignments();
    loadRecentlyStudiedDecks();
  }
});
// Call when auth state changes
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadCompetitionName();
  }
});


    // Tab selection + underline animation
    function selectTab(selectedTab) {
      const tabText = selectedTab.textContent.trim();
      
      // Remove active class from all tabs
      document.querySelectorAll('.practice-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Add active class to selected tab
      selectedTab.classList.add('active');
  
      // Redirect if "Create" is clicked
      if (tabText === "Create") {
        window.location.href = "create1.html";
        return;
      }

      // Resources tab - stay on page, just update UI
      if (tabText === "Resources") {
        // Already on resources page, just ensure it's active
        return;
      }

      if (tabText === "Judging") {
        window.location.href = "judging.html"; // replace with your correct path
        return;
      }
  
      // Handle in-page tab selection
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      selectedTab.classList.add('active');
  
      const underline = document.querySelector('.tab-underline');
      underline.style.transform = `translateX(${selectedTab.offsetLeft}px)`;
      underline.style.width = `${selectedTab.offsetWidth}px`;
    }
  
    // On page load: position underline
    window.addEventListener('load', () => {
      const activeTab = document.querySelector('.tab.active');
      const underline = document.querySelector('.tab-underline');
      if (activeTab && underline) {
        underline.style.transform = `translateX(${activeTab.offsetLeft}px)`;
        underline.style.width = `${activeTab.offsetWidth}px`;
      }
  
      feather.replace(); // renders all feather icons
    });
  
    // Accordion toggle logic
  // ============ MEILISEARCH INTEGRATION ============
    // Meilisearch client setup (adjust if you use a different host)
    const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
    const index = client.index('content');
    // Search bar removed
    const searchBox = null;
    const searchDropdown = null;
    const searchIcon = null;

    if (false && searchBox && searchDropdown) {
      searchBox.addEventListener('input', async function(e) {
        const query = e.target.value.trim();
        if (!query) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
          return;
        }
        try {
          const result = await index.search(query, { limit: 5 });
          if (!result.hits.length) {
            searchDropdown.style.display = 'none';
            searchDropdown.innerHTML = '';
            return;
          }
          searchDropdown.style.display = 'block';
          searchDropdown.innerHTML = result.hits.map(doc => `
            <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
              <b>${doc.title}</b><br>
              <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
            </div>
          `).join('');
        } catch (err) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
        }
      });

      // Handle result click
      searchDropdown.addEventListener('click', function(e) {
        const target = e.target.closest('.dropdown-result');
        if (target && target.dataset.url) {
          window.location = target.dataset.url;
        }
      });

      // Optional: Allow Enter key to open first result
      searchBox.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && searchDropdown.innerHTML) {
          const first = searchDropdown.querySelector('.dropdown-result');
          if (first && first.dataset.url) {
            window.location = first.dataset.url;
          }
        }
      });

      // Hide dropdown on outside click
      document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.style.display = 'none';
        }
      });

      // Click magnifier icon triggers search
      if (searchIcon) {
        searchIcon.addEventListener('click', () => {
          searchBox.dispatchEvent(new Event('input'));
        });
      }
    }
    // =========== END MEILISEARCH ============
function capitalize(word) {
      return word.charAt(0).toUpperCase() + word.slice(1);
    }

async function loadRecentlyStudiedDecks() {
  console.log('=== Starting loadRecentlyStudiedDecks ===');
  try {
    const user = firebase.auth().currentUser;
    
    if (!user) {
      renderEmptyRecentlyStudied();
      return;
    }

    // Simple query to avoid index issues
    const assignmentsSnapshot = await db.collection('assignments')
      .where('to', '==', user.uid)
      .where('status', '==', 'complete')
      .limit(10)
      .get();

    console.log('Completed assignments found:', assignmentsSnapshot.size);

    if (assignmentsSnapshot.empty) {
      renderEmptyRecentlyStudied();
      return;
    }

    // Process assignments to create flashcard decks from missed questions
    const decksByCompetency = {};
    
    assignmentsSnapshot.forEach(doc => {
      const assignment = doc.data();
      
      // Only process written assignments
      if (assignment.type !== 'written' || !assignment.detailedAnswers) {
        return;
      }
      
      console.log('Processing written assignment:', assignment.title);
      
      // Process detailedAnswers array to find incorrect answers
      assignment.detailedAnswers.forEach((answer) => {
        // Only add incorrect answers to flashcards
        if (answer.isCorrect === false) {
          const competency = answer.competency || 'General';
          
          if (!decksByCompetency[competency]) {
            decksByCompetency[competency] = {
              cards: [],
              lastStudied: assignment.completedAt || new Date()
            };
          }
          
          decksByCompetency[competency].cards.push({
            question: answer.question,
            answer: answer.correctAnswer,
            userAnswer: answer.userAnswer,
            competency: competency,
            source: assignment.title || 'Written Practice',
            difficulty: assignment.difficulty || 'medium'
          });
        }
      });
    });

    console.log('Final decks created:', Object.keys(decksByCompetency));
    
    // Store the decks
    recentlyStudiedDecks = decksByCompetency;
    
    // Render the decks
    renderRecentlyStudiedDecks(decksByCompetency);
    
  } catch (error) {
    console.error("Error in loadRecentlyStudiedDecks:", error);
    renderEmptyRecentlyStudied();
  }
}

// Updated renderRecentlyStudiedDecks function - kept for flashcard functionality
function renderRecentlyStudiedDecks(decks) {
  // This function is kept for flashcard functionality but not displayed in new design
  // Flashcard decks can still be accessed via the "See all studied" link
  console.log('Recently studied decks loaded:', Object.keys(decks).length, 'topics');
}

// Render empty state for recently studied
function renderEmptyRecentlyStudied() {
  // No longer needed in new design, but kept for compatibility
}

// Open flashcard modal
function openFlashcardModal(competency, cards) {
  try {
    // Parse cards if they're a string
    if (typeof cards === 'string') {
      cards = JSON.parse(cards);
    }
    
    // Validate cards array
    if (!Array.isArray(cards) || cards.length === 0) {
      console.error('Invalid cards data:', cards);
      alert('No flashcards available for this competency.');
      return;
    }
    
    // Store the deck data in localStorage for flashcard.html to retrieve
    const deckData = {
      name: competency,
      cards: cards,
      source: 'missed_questions',
      timestamp: Date.now()
    };
    
    localStorage.setItem('currentFlashcardDeck', JSON.stringify(deckData));
    
    // Redirect to flashcard.html with competency parameter
    window.location.href = `flashcard.html?deck=${encodeURIComponent(competency)}&source=missed`;
    
  } catch (error) {
    console.error('Error opening flashcard deck:', error);
    alert('Error loading flashcards. Please try again.');
  }
}

// Learning Zone Toggle Function
function toggleLearningZone(section) {
  const contentPanel = document.getElementById(section + 'Content');
  const chevron = document.getElementById(section + 'Chevron');
  
  if (!contentPanel || !chevron) return;
  
  if (contentPanel.classList.contains('hidden')) {
    contentPanel.classList.remove('hidden');
    chevron.style.transform = 'rotate(180deg)';
  } else {
    contentPanel.classList.add('hidden');
    chevron.style.transform = 'rotate(0deg)';
  }
}

// Keep old function for compatibility
function toggleAccordion(button) {
  const content = button.nextElementSibling;
  const icon = button.querySelector('.chevron-icon');
  
  const isHidden = content.classList.contains('hidden');
  
  if (isHidden) {
    // Open accordion
    button.classList.add('active');
    content.classList.remove('hidden');
    content.style.maxHeight = content.scrollHeight + "px";
    if (icon) icon.classList.add('rotate');
  } else {
    // Close accordion
    button.classList.remove('active');
    content.classList.add('hidden');
    content.style.maxHeight = "0px";
    if (icon) icon.classList.remove('rotate');
  }
  
  feather.replace();
}

    function startAssignment(id, type) {
      alert(`Starting ${type} assignment with ID: ${id}`);
      // You can redirect or load another modal here
    }

function toggleCompete() {
  // Create modal overlay with more blur
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
  `;

  // Create modal content with black/red/orange theme
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: linear-gradient(to bottom right, rgba(0, 0, 0, 0.95), rgba(30, 0, 0, 0.95));
    border: 2px solid rgba(239, 68, 68, 0.5);
    border-radius: 16px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    position: relative;
    box-shadow: 0 20px 25px -5px rgba(239, 68, 68, 0.3), 0 0 50px rgba(239, 68, 68, 0.2);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  `;

  modal.innerHTML = `
    <button style="
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: #f87171;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    " onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='#f87171'" onclick="this.closest('.modal-overlay').remove()"></button>
    
    <h2 style="
      font-size: 24px;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 16px 0;
    ">Challenge</h2>
    
    <p style="
      font-size: 16px;
      color: #cbd5e1;
      margin: 0 0 24px 0;
      line-height: 1.5;
    ">Choose your competition type and get ready to compete!</p>
    
    <div style="
      margin-bottom: 32px;
    ">
      <label style="
        font-size: 14px;
        font-weight: 700;
        color: #f87171;
        margin-bottom: 12px;
        display: block;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      ">Competition Type</label>
      
      <div style="
        display: flex;
        flex-direction: column;
        gap: 12px;
      ">
        <label style="
          display: flex;
          align-items: center;
          padding: 16px;
          border: 2px solid rgba(185, 28, 28, 0.3);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
          background: rgba(15, 23, 42, 0.3);
        " onmouseover="this.style.borderColor='rgba(239, 68, 68, 0.6)'; this.style.backgroundColor='rgba(127, 29, 29, 0.2)';" 
           onmouseout="updateBorderColor(this);" 
           onclick="selectCompetitionType(this, 'written')">
          <input type="radio" name="competitionType" value="written" style="
            margin-right: 12px;
            width: 16px;
            height: 16px;
            accent-color: #ef4444;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 4px;
            ">
              <span style="font-size: 18px; margin-right: 8px;"></span>
              <span style="font-weight: 700; color: #fff;">Written</span>
            </div>
            <div style="
              font-size: 13px;
              color: #cbd5e1;
            ">Test your knowledge with written questions and problems</div>
          </div>
        </label>
        
        <label style="
          display: flex;
          align-items: center;
          padding: 16px;
          border: 2px solid rgba(234, 88, 12, 0.3);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
          background: rgba(15, 23, 42, 0.3);
        " onmouseover="this.style.borderColor='rgba(251, 146, 60, 0.6)'; this.style.backgroundColor='rgba(154, 52, 18, 0.2)';" 
           onmouseout="updateBorderColor(this);" 
           onclick="selectCompetitionType(this, 'speaking')">
          <input type="radio" name="competitionType" value="speaking" style="
            margin-right: 12px;
            width: 16px;
            height: 16px;
            accent-color: #f97316;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 4px;
            ">
              <span style="font-size: 18px; margin-right: 8px;"></span>
              <span style="font-weight: 700; color: #fff;">Speaking</span>
            </div>
            <div style="
              font-size: 13px;
              color: #cbd5e1;
            ">Demonstrate your presentation and communication skills</div>
          </div>
        </label>
        
        <label style="
          display: flex;
          align-items: center;
          padding: 16px;
          border: 2px solid rgba(234, 179, 8, 0.3);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
          background: rgba(15, 23, 42, 0.3);
        " onmouseover="this.style.borderColor='rgba(250, 204, 21, 0.6)'; this.style.backgroundColor='rgba(161, 98, 7, 0.2)';" 
           onmouseout="updateBorderColor(this);" 
           onclick="selectCompetitionType(this, 'case')">
          <input type="radio" name="competitionType" value="case" style="
            margin-right: 12px;
            width: 16px;
            height: 16px;
            accent-color: #facc15;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 4px;
            ">
              <span style="font-size: 18px; margin-right: 8px;"></span>
              <span style="font-weight: 700; color: #fff;">Case Study</span>
            </div>
            <div style="
              font-size: 13px;
              color: #cbd5e1;
            ">Analyze business scenarios and provide strategic solutions</div>
          </div>
        </label>
      </div>
    </div>
    
    <div style="
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    ">
      <button style="
        padding: 8px 16px;
        border: 1px solid rgba(185, 28, 28, 0.5);
        background: rgba(15, 23, 42, 0.3);
        color: #cbd5e1;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      " onmouseover="this.style.borderColor='rgba(239, 68, 68, 0.7)'; this.style.backgroundColor='rgba(127, 29, 29, 0.2)';" 
         onmouseout="this.style.borderColor='rgba(185, 28, 28, 0.5)'; this.style.backgroundColor='rgba(15, 23, 42, 0.3)';"
         onclick="this.closest('.modal-overlay').remove()">Cancel</button>
      
      <button id="startChallengeBtn" style="
        padding: 8px 16px;
        background: linear-gradient(to right, #dc2626, #f97316);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: not-allowed;
        font-size: 14px;
        font-weight: 700;
        opacity: 0.6;
        transition: all 0.2s;
      " disabled onclick="startChallengeWithType()">Start Challenge</button>
    </div>
  `;

  overlay.appendChild(modal);
  overlay.className = 'modal-overlay';
  
  // Close on overlay click
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.remove();
    }
  });

  document.body.appendChild(overlay);
}

function updateBorderColor(element) {
  const radio = element.querySelector('input[type="radio"]');
  if (radio && radio.checked) {
    // Keep selected state with red/orange theme
    if (element.getAttribute('onclick').includes('written')) {
      element.style.borderColor = 'rgba(239, 68, 68, 0.8)';
      element.style.backgroundColor = 'rgba(127, 29, 29, 0.3)';
    } else if (element.getAttribute('onclick').includes('speaking')) {
      element.style.borderColor = 'rgba(251, 146, 60, 0.8)';
      element.style.backgroundColor = 'rgba(154, 52, 18, 0.3)';
    } else if (element.getAttribute('onclick').includes('case')) {
      element.style.borderColor = 'rgba(250, 204, 21, 0.8)';
      element.style.backgroundColor = 'rgba(161, 98, 7, 0.3)';
    }
  } else {
    // Reset to default based on type
    if (element.getAttribute('onclick').includes('written')) {
      element.style.borderColor = 'rgba(185, 28, 28, 0.3)';
      element.style.backgroundColor = 'rgba(15, 23, 42, 0.3)';
    } else if (element.getAttribute('onclick').includes('speaking')) {
      element.style.borderColor = 'rgba(234, 88, 12, 0.3)';
      element.style.backgroundColor = 'rgba(15, 23, 42, 0.3)';
    } else if (element.getAttribute('onclick').includes('case')) {
      element.style.borderColor = 'rgba(234, 179, 8, 0.3)';
      element.style.backgroundColor = 'rgba(15, 23, 42, 0.3)';
    }
  }
}

function selectCompetitionType(labelElement, type) {
  // Update all labels to default state
  const allLabels = document.querySelectorAll('label[onclick*="selectCompetitionType"]');
  allLabels.forEach(label => {
    const labelType = label.getAttribute('onclick').match(/'(\w+)'/)?.[1];
    if (labelType === 'written') {
      label.style.borderColor = 'rgba(185, 28, 28, 0.3)';
      label.style.backgroundColor = 'rgba(15, 23, 42, 0.3)';
    } else if (labelType === 'speaking') {
      label.style.borderColor = 'rgba(234, 88, 12, 0.3)';
      label.style.backgroundColor = 'rgba(15, 23, 42, 0.3)';
    } else if (labelType === 'case') {
      label.style.borderColor = 'rgba(234, 179, 8, 0.3)';
      label.style.backgroundColor = 'rgba(15, 23, 42, 0.3)';
    }
    const radio = label.querySelector('input[type="radio"]');
    if (radio) radio.checked = false;
  });
  
  // Highlight selected label based on type
  if (type === 'written') {
    labelElement.style.borderColor = 'rgba(239, 68, 68, 0.8)';
    labelElement.style.backgroundColor = 'rgba(127, 29, 29, 0.3)';
  } else if (type === 'speaking') {
    labelElement.style.borderColor = 'rgba(251, 146, 60, 0.8)';
    labelElement.style.backgroundColor = 'rgba(154, 52, 18, 0.3)';
  } else if (type === 'case') {
    labelElement.style.borderColor = 'rgba(250, 204, 21, 0.8)';
    labelElement.style.backgroundColor = 'rgba(161, 98, 7, 0.3)';
  }
  
  // Check the radio button
  const radio = labelElement.querySelector('input[type="radio"]');
  if (radio) radio.checked = true;
  
  // Enable the start button
  const startBtn = document.getElementById('startChallengeBtn');
  startBtn.style.background = 'linear-gradient(to right, #dc2626, #f97316)';
  startBtn.style.cursor = 'pointer';
  startBtn.style.opacity = '1';
  startBtn.disabled = false;
  
  // Store selected type
  window.selectedCompetitionType = type;
}

// Updated start challenge function
async function startChallengeWithType() {
  const selectedType = window.selectedCompetitionType;
  
  if (!selectedType) {
    alert('Please select a competition type');
    return;
  }
  
  // Remove modal
  document.querySelector('.modal-overlay').remove();
  
  // Show loading state
  showLoadingScreen();
  
  try {
    // Get current user's team and find opponent
    const { currentTeam, opponentTeam, hasAvailableOpponents } = await findTeamsForCompetition();
    
    // Create fullscreen competition page with selected type
    createCompetitionPage(currentTeam, opponentTeam, hasAvailableOpponents, selectedType);
  } catch (error) {
    console.error('Error starting challenge:', error);
    // Show error state or fallback
    createCompetitionPage('Your Team', 'Loading...', false, selectedType);
  }
}


async function startChallenge() {
  // Remove modal
  document.querySelector('.modal-overlay').remove();
  
  // Show loading state
  showLoadingScreen();
  
  try {
    // Get current user's team and find opponent
    const { currentTeam, opponentTeam, hasAvailableOpponents } = await findTeamsForCompetition();
    
    // Create fullscreen competition page
    createCompetitionPage(currentTeam, opponentTeam, hasAvailableOpponents);
  } catch (error) {
    console.error('Error starting challenge:', error);
    // Show error state or fallback
    createCompetitionPage('Your Team', 'Loading...', false);
  }
}



function showLoadingScreen() {
  const loadingPage = document.createElement('div');
  loadingPage.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  `;
  
  loadingPage.innerHTML = `
    <div style="text-align: center;">
      <div style="
        font-size: 24px;
        color: #00d4ff;
        margin-bottom: 20px;
        animation: pulse 1.5s ease-in-out infinite;
      ">Finding opponents...</div>
      <div style="
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 212, 255, 0.3);
        border-top: 3px solid #00d4ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      "></div>
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
    </style>
  `;
  
  loadingPage.id = 'loading-page';
  document.body.appendChild(loadingPage);
}

async function findTeamsForCompetition() {
  // Get current user ID (you'll need to implement this based on your auth system)
  const currentUserId = getCurrentUserId(); // You need to implement this
  
  if (!currentUserId) {
    throw new Error('User not authenticated');
  }
  
  // Get current user's data
  const currentUserRef = db.collection('users').doc(currentUserId);
  const currentUserDoc = await currentUserRef.get();
  
  if (!currentUserDoc.exists) {
    throw new Error('User not found');
  }
  
  const currentUserData = currentUserDoc.data();
  const currentUserCompetitions = currentUserData.competitions;
  
  // Check if competitions exists and is an array
  if (!Array.isArray(currentUserCompetitions)) {
    throw new Error('User has no competitions or competitions is not an array');
  }
  
  // Filter out mentorCompetition entries and get regular competitions
  const regularCompetitions = currentUserCompetitions.filter(comp => 
    typeof comp === 'string' && comp !== 'mentorCompetition'
  );
  
  if (regularCompetitions.length === 0) {
    throw new Error('User has no regular competitions');
  }
  
  // Use the first competition as current team
  const currentTeam = regularCompetitions[0];
  
  console.log('Current user team:', currentTeam);
  console.log('Current user competitions:', regularCompetitions);
  
  // Get all users to find potential opponents
  const usersSnapshot = await db.collection('users').get();
  const availableOpponents = [];
  
  usersSnapshot.forEach(doc => {
    const userData = doc.data();
    const userId = doc.id;
    
    // Skip current user
    if (userId === currentUserId) return;
    
    // Check if user has competitions and it's an array
    const userCompetitions = userData.competitions;
    if (!Array.isArray(userCompetitions)) {
      console.log(`User ${userId} has no competitions array`);
      return;
    }
    
    const userRegularCompetitions = userCompetitions.filter(comp => 
      typeof comp === 'string' && comp !== 'mentorCompetition'
    );
    
    // Check if user has competitions, is not currently competing, AND is not in the same competition
    if (userRegularCompetitions.length > 0 && !userData.isActivelyCompeting) {
      // Case-insensitive check to ensure not same competition
      const isSameCompetition = regularCompetitions.some(currentComp => 
        userRegularCompetitions.some(userComp => 
          currentComp.toLowerCase() === userComp.toLowerCase()
        )
      );
      
      if (!isSameCompetition) {
        const opponentTeamName = userRegularCompetitions[0];
        console.log(`Adding opponent: ${userId} with team: ${opponentTeamName}`);
        availableOpponents.push({
          userId: userId,
          teamName: opponentTeamName,
          userData: userData
        });
      } else {
        console.log(`Skipping user ${userId} - same competition`);
      }
    }
  });
  
  console.log('Available opponents found:', availableOpponents.length);
  console.log('Opponents:', availableOpponents);
  
  let opponentTeam = 'Waiting for opponents...';
  let hasAvailableOpponents = availableOpponents.length > 0;
  
  if (hasAvailableOpponents) {
    // Select random opponent
    const randomOpponent = availableOpponents[Math.floor(Math.random() * availableOpponents.length)];
    opponentTeam = randomOpponent.teamName;
    
    // Optional: Mark both users as actively competing
    await Promise.all([
      currentUserRef.update({ isActivelyCompeting: true }),
      db.collection('users').doc(randomOpponent.userId).update({ isActivelyCompeting: true })
    ]);
  }
  
  return {
    currentTeam,
    opponentTeam,
    hasAvailableOpponents
  };
}

function getCurrentUserId() {
  // Using Firebase Auth to get current user
  return firebase.auth().currentUser?.uid;
}

async function notifyTeamsReady() {
  // This function will notify other teams that someone is ready to compete
  try {
    // You can implement this by:
    // 1. Adding a notification to a global notifications collection
    // 2. Updating a "seeking opponents" status
    // 3. Sending push notifications to other users
    
    const currentUserId = getCurrentUserId();
    const currentUserRef = db.collection('users').doc(currentUserId);
    
    // Mark user as seeking opponents
    await currentUserRef.update({
      seekingOpponents: true,
      lastSeekingTime: new Date()
    });
    
    // Add to a global ready queue (optional)
    await db.collection('readyToCompete').add({
      userId: currentUserId,
      timestamp: new Date(),
      status: 'seeking'
    });
    
    alert('Other teams have been notified that you\'re ready to compete!');
    
  } catch (error) {
    console.error('Error notifying teams:', error);
    alert('Failed to notify other teams. Please try again.');
  }
}

function createCompetitionPage(currentTeam, opponentTeam, hasAvailableOpponents) {
  // Remove loading screen
  const loadingPage = document.getElementById('loading-page');
  if (loadingPage) loadingPage.remove();
  
  // Create fullscreen competition page
  const competePage = document.createElement('div');
  competePage.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    overflow: hidden;
  `;

  competePage.innerHTML = `
    <div style="
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 80%, #0066ff33 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, #ff006633 0%, transparent 50%);
      opacity: 0.7;
    "></div>
    
    <div style="
      text-align: center;
      z-index: 1;
      max-width: 800px;
      padding: 0 20px;
    ">
      <div style="
        font-size: 64px;
        font-weight: 800;
        background: linear-gradient(45deg, #00d4ff, #ff0080);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 40px;
        text-transform: uppercase;
        letter-spacing: 3px;
        animation: glow 2s ease-in-out infinite alternate;
      ">COMPETING</div>
      
      <div style="
        font-size: 24px;
        color: #ffffff;
        margin-bottom: 20px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 0.5s forwards;
      ">You are competing against</div>
      
      <div id="team1" style="
        font-size: 36px;
        font-weight: 700;
        color: #00d4ff;
        margin-bottom: 30px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 1s forwards;
        text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
      ">${currentTeam.toUpperCase()}</div>
      
      <div style="
        font-size: 48px;
        color: #ff0080;
        margin: 20px 0;
        opacity: 0;
        animation: fadeInUp 1s ease-out 1.5s forwards;
      ">VS</div>
      
      <div id="team2" style="
        font-size: 36px;
        font-weight: 700;
        color: #ff0080;
        margin-bottom: 60px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 2s forwards;
        text-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
      ">${opponentTeam.toUpperCase()}</div>
      
      ${!hasAvailableOpponents ? `
        <div style="
          background: rgba(255, 165, 0, 0.1);
          border: 1px solid rgba(255, 165, 0, 0.3);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 30px;
          opacity: 0;
          animation: fadeInUp 1s ease-out 2.2s forwards;
        ">
          <div style="color: #ffa500; font-size: 18px; margin-bottom: 10px;"> No opponents available</div>
          <div style="color: #ffffff; font-size: 14px; margin-bottom: 15px;">
            There are currently no teams available to compete against.
          </div>
          <button onclick="notifyTeamsReady()" style="
            padding: 10px 20px;
            background: linear-gradient(45deg, #ffa500, #ff8c00);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
          ">Notify Other Teams</button>
        </div>
      ` : ''}
      
      <div style="
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
        opacity: 0;
        animation: fadeInUp 1s ease-out 2.5s forwards;
      ">
        <button onclick="closeCompetePage()" style="
          padding: 15px 30px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.3);
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.1)'"> Back</button>
        
        <button onclick="viewBracket()" style="
          padding: 15px 30px;
          background: rgba(0, 212, 255, 0.2);
          border: 2px solid #00d4ff;
          color: #00d4ff;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        " onmouseover="this.style.background='rgba(0,212,255,0.3)'" 
           onmouseout="this.style.background='rgba(0,212,255,0.2)'">View Bracket</button>
        
        <button style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #00d4ff, #ff0080);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
          box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
          transition: all 0.3s ease;
          ${!hasAvailableOpponents ? 'opacity: 0.5; cursor: not-allowed;' : ''}
        " ${hasAvailableOpponents ? `onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : 'disabled'}>
          ${hasAvailableOpponents ? 'Compete Now' : 'Waiting for Opponents'}
        </button>
      </div>
    </div>
    
    <style>
      @keyframes glow {
        from { text-shadow: 0 0 20px rgba(0, 212, 255, 0.5), 0 0 30px rgba(255, 0, 128, 0.3); }
        to { text-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 0 40px rgba(255, 0, 128, 0.6); }
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  `;

  competePage.id = 'compete-page';
  document.body.appendChild(competePage);
}


function createCompetitionPage(currentTeam, opponentTeam, hasAvailableOpponents, competitionType = 'written') {
   const typeIcon = competitionTypes[competitionType] || '';
  const typeName = competitionType.charAt(0).toUpperCase() + competitionType.slice(1);
  
  // Remove loading screen
  const loadingPage = document.getElementById('loading-page');
  if (loadingPage) loadingPage.remove();
  
  // Create fullscreen competition page
  const competePage = document.createElement('div');
  competePage.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    overflow: hidden;
  `;

  competePage.innerHTML = `
    <div style="
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 80%, #0066ff33 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, #ff006633 0%, transparent 50%);
      opacity: 0.7;
    "></div>
    
    <div style="
      text-align: center;
      z-index: 1;
      max-width: 800px;
      padding: 0 20px;
    ">
      <div style="
        font-size: 64px;
        font-weight: 800;
        background: linear-gradient(45deg, #00d4ff, #ff0080);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 3px;
        animation: glow 2s ease-in-out infinite alternate;
      ">COMPETING</div>
      
      <div style="
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 0.3s forwards;
      ">
        <span style="font-size: 32px; margin-right: 12px;">${typeIcon}</span>
        <span style="
          font-size: 24px;
          color: #ffffff;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
        ">${typeName} Competition</span>
      </div>
      
      <div style="
        font-size: 24px;
        color: #ffffff;
        margin-bottom: 20px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 0.5s forwards;
      ">You are competing against</div>
      
      <div id="team1" style="
        font-size: 36px;
        font-weight: 700;
        color: #00d4ff;
        margin-bottom: 30px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 1s forwards;
        text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
      ">${currentTeam.toUpperCase()}</div>
      
      <div style="
        font-size: 48px;
        color: #ff0080;
        margin: 20px 0;
        opacity: 0;
        animation: fadeInUp 1s ease-out 1.5s forwards;
      ">VS</div>
      
      <div id="team2" style="
        font-size: 36px;
        font-weight: 700;
        color: #ff0080;
        margin-bottom: 60px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 2s forwards;
        text-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
      ">${opponentTeam.toUpperCase()}</div>
      
      ${!hasAvailableOpponents ? `
        <div style="
          background: rgba(255, 165, 0, 0.1);
          border: 1px solid rgba(255, 165, 0, 0.3);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 30px;
          opacity: 0;
          animation: fadeInUp 1s ease-out 2.2s forwards;
        ">
          <div style="color: #ffa500; font-size: 18px; margin-bottom: 10px;"> No opponents available</div>
          <div style="color: #ffffff; font-size: 14px; margin-bottom: 15px;">
            There are currently no teams available to compete against.
          </div>
          <button onclick="notifyTeamsReady()" style="
            padding: 10px 20px;
            background: linear-gradient(45deg, #ffa500, #ff8c00);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
          ">Notify Other Teams</button>
        </div>
      ` : ''}
      
      <div style="
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
        opacity: 0;
        animation: fadeInUp 1s ease-out 2.5s forwards;
      ">
        <button onclick="closeCompetePage()" style="
          padding: 15px 30px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.3);
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.1)'"> Back</button>
        
        <button onclick="viewBracket()" style="
          padding: 15px 30px;
          background: rgba(0, 212, 255, 0.2);
          border: 2px solid #00d4ff;
          color: #00d4ff;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        " onmouseover="this.style.background='rgba(0,212,255,0.3)'" 
           onmouseout="this.style.background='rgba(0,212,255,0.2)'">View Bracket</button>
        
        <button onclick="startCompetitionWithType('${competitionType}')" style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #00d4ff, #ff0080);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
          box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
          transition: all 0.3s ease;
          ${!hasAvailableOpponents ? 'opacity: 0.5; cursor: not-allowed;' : ''}
        " ${hasAvailableOpponents ? `onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : 'disabled'}>
          ${hasAvailableOpponents ? `Start ${typeName} Competition` : 'Waiting for Opponents'}
        </button>
      </div>
    </div>
    
    <style>
      @keyframes glow {
        from { text-shadow: 0 0 20px rgba(0, 212, 255, 0.5), 0 0 30px rgba(255, 0, 128, 0.3); }
        to { text-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 0 40px rgba(255, 0, 128, 0.6); }
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  `;

  competePage.id = 'compete-page';
  document.body.appendChild(competePage);
}
function closeCompetePage() {
  const competePage = document.getElementById('compete-page');
  if (competePage) {
    competePage.remove();
  }
}

async function viewBracket() {
  // Close competition page
  closeCompetePage();
  
  // Show loading
  showLoadingScreen();
  
  try {
    // Get all user pairings for the bracket
    const pairings = await getAllCompetitionPairings();
    createBracketView(pairings);
  } catch (error) {
    console.error('Error loading bracket:', error);
    // Remove loading and show error
    const loadingPage = document.getElementById('loading-page');
    if (loadingPage) loadingPage.remove();
    alert('Failed to load bracket. Please try again.');
  }
}

async function getAllCompetitionPairings() {
  const usersSnapshot = await db.collection('users').get();
  const usersByCompetition = {};
  const pairings = [];
  
  // Group users by competition
  usersSnapshot.forEach(doc => {
    const userData = doc.data();
    const userId = doc.id;
    const userCompetitions = userData.competitions;
    
    if (Array.isArray(userCompetitions)) {
      const regularCompetitions = userCompetitions.filter(comp => 
        typeof comp === 'string' && comp !== 'mentorCompetition'
      );
      
      if (regularCompetitions.length > 0) {
        const competition = regularCompetitions[0];
        if (!usersByCompetition[competition]) {
          usersByCompetition[competition] = [];
        }
        usersByCompetition[competition].push({
          uid: userId,
          name: userData.name || `User ${userId.slice(0, 6)}`,
          competition: competition,
          isActivelyCompeting: userData.isActivelyCompeting || false
        });
      }
    }
  });
  
  // Create pairings from different competitions
  const competitions = Object.keys(usersByCompetition);
  console.log('Competitions found:', competitions);
  console.log('Users by competition:', usersByCompetition);
  
  // Generate all possible matchups between different competitions
  for (let i = 0; i < competitions.length; i++) {
    for (let j = i + 1; j < competitions.length; j++) {
      const comp1 = competitions[i];
      const comp2 = competitions[j];
      const users1 = usersByCompetition[comp1];
      const users2 = usersByCompetition[comp2];
      
      // Create pairings between competitions
      const maxPairs = Math.min(users1.length, users2.length);
      for (let k = 0; k < maxPairs; k++) {
        pairings.push({
          id: `${comp1}-vs-${comp2}-${k}`,
          team1: {
            ...users1[k],
            teamName: comp1
          },
          team2: {
            ...users2[k],
            teamName: comp2
          },
          status: (users1[k].isActivelyCompeting && users2[k].isActivelyCompeting) ? 'active' : 'pending',
          round: 1
        });
      }
    }
  }
  
  return pairings;
}

function createBracketView(pairings) {
  // Remove loading screen
  const loadingPage = document.getElementById('loading-page');
  if (loadingPage) loadingPage.remove();
  
  const bracketPage = document.createElement('div');
  bracketPage.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    overflow-y: auto;
    z-index: 2000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 20px;
  `;
  
  bracketPage.innerHTML = `
    <div style="
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    ">
      <div style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
      ">
        <h1 style="
          font-size: 36px;
          font-weight: 800;
          background: linear-gradient(45deg, #00d4ff, #ff0080);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          margin: 0;
          text-transform: uppercase;
          letter-spacing: 2px;
        ">Tournament Bracket</h1>
        
        <button onclick="closeBracketView()" style="
          padding: 12px 24px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.3);
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
        "> Back</button>
      </div>
      
      <div style="
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      ">
        ${pairings.length > 0 ? pairings.map(pairing => `
          <div style="
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            position: relative;
            ${pairing.status === 'active' ? 'border-color: #00d4ff; box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);' : ''}
          ">
            <div style="
              position: absolute;
              top: 12px;
              right: 12px;
              padding: 4px 12px;
              border-radius: 20px;
              font-size: 12px;
              font-weight: 600;
              ${pairing.status === 'active' 
                ? 'background: rgba(0, 212, 255, 0.2); color: #00d4ff; border: 1px solid #00d4ff;' 
                : 'background: rgba(255, 165, 0, 0.2); color: #ffa500; border: 1px solid #ffa500;'
              }
            ">${pairing.status === 'active' ? 'LIVE' : 'PENDING'}</div>
            
            <div style="
              text-align: center;
              margin-top: 20px;
            ">
              <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
              ">
                <div style="
                  flex: 1;
                  text-align: center;
                ">
                  <div style="
                    font-size: 18px;
                    font-weight: 700;
                    color: #00d4ff;
                    margin-bottom: 8px;
                    text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
                  ">${pairing.team1.teamName.toUpperCase()}</div>
                  <div style="
                    font-size: 14px;
                    color: #ffffff;
                    opacity: 0.8;
                  ">${pairing.team1.name}</div>
                </div>
                
                <div style="
                  font-size: 24px;
                  color: #ff0080;
                  margin: 0 20px;
                  font-weight: bold;
                ">VS</div>
                
                <div style="
                  flex: 1;
                  text-align: center;
                ">
                  <div style="
                    font-size: 18px;
                    font-weight: 700;
                    color: #ff0080;
                    margin-bottom: 8px;
                    text-shadow: 0 0 10px rgba(255, 0, 128, 0.5);
                  ">${pairing.team2.teamName.toUpperCase()}</div>
                  <div style="
                    font-size: 14px;
                    color: #ffffff;
                    opacity: 0.8;
                  ">${pairing.team2.name}</div>
                </div>
              </div>
              
              <div style="
                font-size: 12px;
                color: #888;
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
              ">
                Match ID: ${pairing.id}
              </div>
            </div>
          </div>
        `).join('') : `
          <div style="
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
          ">
            <div style="
              font-size: 48px;
              margin-bottom: 20px;
            "></div>
            <div style="
              font-size: 24px;
              color: #ffffff;
              margin-bottom: 12px;
            ">No matches found</div>
            <div style="
              font-size: 16px;
              color: #888;
            ">Teams need to be in different competitions to create matches</div>
          </div>
        `}
      </div>
    </div>
  `;
  
  bracketPage.id = 'bracket-page';
  document.body.appendChild(bracketPage);
}

function closeBracketView() {
  const bracketPage = document.getElementById('bracket-page');
  if (bracketPage) {
    bracketPage.remove();
  }
}

    async function loadIncompleteAssignments() {
  console.log('Loading incomplete assignments...');
  const user = firebase.auth().currentUser;
  const container = document.getElementById('incompleteAssignments');
  
  if (!user) {
    console.log('No user found, waiting for auth...');
    container.innerHTML = '<p class="empty-msg">Please wait, loading...</p>';
    return;
  }

  container.innerHTML = '<p class="empty-msg">Loading assignments...</p>';

  try {
    const snapshot = await firebase.firestore().collection('assignments')
      .where('to', '==', user.uid)
      .where('status', '!=', 'complete')
      .get();

    console.log('Query returned:', snapshot.size, 'documents');

    if (snapshot.empty) {
      container.innerHTML = '<p class="empty-msg">No incomplete assignments yet </p>';
      return;
    }

    container.innerHTML = ''; // Clear loading message

    snapshot.forEach(doc => {
      const data = doc.data();
      const card = document.createElement('div');
      card.className = 'learning-zone-list-item';
      card.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
          <div style="flex: 1;">
            <strong>${data.title || 'Untitled Assignment'}</strong>
            <span style="display: block; margin-top: 0.25rem; font-size: 0.8125rem; color: #cbd5e1;">${data.type || 'N/A'}  ${data.difficulty || 'N/A'}  ${data.time || 'N/A'}</span>
          </div>
          <button class="challenge-button" onclick="startAssignment('${doc.id}', '${data.type}'); event.stopPropagation();">
            Start
          </button>
        </div>
      `;
      container.appendChild(card);
    });

    // Content is loaded, no need to recalculate height in new structure

  } catch (err) {
    console.error('Error loading assignments:', err);
    container.innerHTML = '<p class="empty-msg" style="color: #dc2626;">Failed to load assignments. Please try again.</p>';
  }
}

   function startAssignment(id, type) {
    // redirect or open modal as needed
    console.log(`Starting assignment ${id} of type ${type}`);
  }

  // Initialize when DOM is loaded

  document.addEventListener('DOMContentLoaded', () => {
  // Previous card button
  document.getElementById('prevCard')?.addEventListener('click', () => {
    if (currentDeck && currentCardIndex > 0) {
      currentCardIndex--;
      showCurrentFlashcard();
    }
  });
  
  // Next card button
  document.getElementById('nextCard')?.addEventListener('click', () => {
    if (currentDeck && currentCardIndex < currentDeck.cards.length - 1) {
      currentCardIndex++;
      showCurrentFlashcard();
    }
  });
});

// Rate difficulty (placeholder for future functionality)
function rateDifficulty(level) {
  console.log(`Rated current card as ${level}`);
  // Could save this rating to Firebase for spaced repetition
}

// Modified DOMContentLoaded to include flashcard loading
document.addEventListener('DOMContentLoaded', () => {
  feather.replace();
  
  // Handle authentication state changes
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      console.log('User authenticated:', user.uid);
      loadIncompleteAssignments();
      loadRecentlyStudiedDecks(); // Add this line
    } else {
      console.log('No user, signing in anonymously...');
      firebase.auth().signInAnonymously().catch(err => {
        console.error('Anonymous sign-in failed:', err);
      });
    }
  });

  // Set up speaking assignment recording button event listeners
  const audioBtn = document.getElementById('cq-speaking-audioBtn');
  const videoBtn = document.getElementById('cq-speaking-videoBtn');
  const stopBtn = document.getElementById('cq-speaking-stopBtn');
  const submitBtn = document.getElementById('cq-speaking-submitBtn');
  const closeBtn = document.querySelector('.cq-speaking-close');
  const documentBtn = document.getElementById('cq-speaking-documentBtn');
  const micBtn = document.getElementById('cq-speaking-micBtn');

  if (audioBtn) {
    audioBtn.addEventListener('click', startAudioRecording);
  }
  
  if (videoBtn) {
    videoBtn.addEventListener('click', startVideoRecording);
  }
  
  if (stopBtn) {
    stopBtn.addEventListener('click', stopRecording);
  }
  
  if (submitBtn) {
    submitBtn.addEventListener('click', submitSpeakingResponse);
  }
  
  if (closeBtn) {
    closeBtn.addEventListener('click', closeSpeakingAssignmentModal);
  }

  // New UI button handlers
  if (recordBtn) {
    recordBtn.addEventListener('click', toggleSpeakingRecording);
  }

  if (documentBtn) {
    documentBtn.addEventListener('click', function() {
      // Document button functionality (can be used for downloading or viewing instructions)
      const downloadBtn = document.getElementById('cq-speaking-downloadBtn');
      if (downloadBtn && downloadBtn.onclick) {
        downloadBtn.click();
      }
    });
  }

  if (micBtn) {
    micBtn.addEventListener('click', function() {
      // Toggle between audio and video recording
      if (isRecording) {
        stopRecording();
      } else {
        startAudioRecording();
      }
    });
  }

  // Check recording support on page load
  checkRecordingSupport();
});


// Function to show competition type selection after clicking "Compete Now"
function showCompetitionTypeSelection() {
  const competePage = document.getElementById('compete-page');
  
  // Create overlay on top of competition page
  const selectionOverlay = document.createElement('div');
  selectionOverlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    backdrop-filter: blur(10px);
  `;

  selectionOverlay.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 90%;
      position: relative;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    ">
      <button style="
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 24px;
        color: #9CA3AF;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      " onclick="this.closest('[style*=\"backdrop-filter\"]').remove()"></button>
      
      <h2 style="
        font-size: 28px;
        font-weight: 700;
        background: linear-gradient(45deg, #00d4ff, #ff0080);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0 0 20px 0;
        text-align: center;
      ">Choose Competition Type</h2>
      
      <p style="
        font-size: 16px;
        color: #9CA3AF;
        margin: 0 0 32px 0;
        line-height: 1.5;
        text-align: center;
      ">Select the type of challenge you want to compete in!</p>
      
      <div style="
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 32px;
      ">
        <label style="
          display: flex;
          align-items: center;
          padding: 20px;
          border: 2px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: blur(10px);
        " onmouseover="this.style.borderColor='#00d4ff'; this.style.backgroundColor='rgba(0, 212, 255, 0.1)';" 
           onmouseout="updateCompTypeBorderColor(this);" 
           onclick="selectCompType(this, 'written')">
          <input type="radio" name="compType" value="written" style="
            margin-right: 16px;
            width: 18px;
            height: 18px;
            accent-color: #00d4ff;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 6px;
            ">
              <span style="font-size: 24px; margin-right: 12px;"></span>
              <span style="font-weight: 700; color: #ffffff; font-size: 18px;">Written Competition</span>
            </div>
            <div style="
              font-size: 14px;
              color: #9CA3AF;
              line-height: 1.4;
            ">Kahoot-style quiz with multiple choice questions and live leaderboard</div>
          </div>
        </label>
        
        <label style="
          display: flex;
          align-items: center;
          padding: 20px;
          border: 2px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: blur(10px);
        " onmouseover="this.style.borderColor='#00d4ff'; this.style.backgroundColor='rgba(0, 212, 255, 0.1)';" 
           onmouseout="updateCompTypeBorderColor(this);" 
           onclick="selectCompType(this, 'speaking')">
          <input type="radio" name="compType" value="speaking" style="
            margin-right: 16px;
            width: 18px;
            height: 18px;
            accent-color: #00d4ff;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 6px;
            ">
              <span style="font-size: 24px; margin-right: 12px;"></span>
              <span style="font-weight: 700; color: #ffffff; font-size: 18px;">Speaking Competition</span>
            </div>
            <div style="
              font-size: 14px;
              color: #9CA3AF;
              line-height: 1.4;
            ">Record a presentation with camera and get scored on delivery</div>
          </div>
        </label>
        
        <label style="
          display: flex;
          align-items: center;
          padding: 20px;
          border: 2px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: blur(10px);
        " onmouseover="this.style.borderColor='#00d4ff'; this.style.backgroundColor='rgba(0, 212, 255, 0.1)';" 
           onmouseout="updateCompTypeBorderColor(this);" 
           onclick="selectCompType(this, 'case')">
          <input type="radio" name="compType" value="case" style="
            margin-right: 16px;
            width: 18px;
            height: 18px;
            accent-color: #00d4ff;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 6px;
            ">
              <span style="font-size: 24px; margin-right: 12px;"></span>
              <span style="font-weight: 700; color: #ffffff; font-size: 18px;">Case Study Competition</span>
            </div>
            <div style="
              font-size: 14px;
              color: #9CA3AF;
              line-height: 1.4;
            ">Analyze business scenarios and present strategic solutions</div>
          </div>
        </label>
      </div>
      
      <div style="
        display: flex;
        gap: 16px;
        justify-content: flex-end;
      ">
        <button style="
          padding: 12px 24px;
          border: 1px solid rgba(255, 255, 255, 0.2);
          background: rgba(255, 255, 255, 0.1);
          color: #ffffff;
          border-radius: 12px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          backdrop-filter: blur(10px);
        " onclick="this.closest('[style*=\"backdrop-filter\"]').remove()">Cancel</button>
        
        <button id="startCompBtn" style="
          padding: 12px 24px;
          background: #6B7280;
          color: white;
          border: none;
          border-radius: 12px;
          cursor: not-allowed;
          font-size: 14px;
          font-weight: 600;
          opacity: 0.6;
        " disabled onclick="startSelectedCompetition()">Start Competition</button>
      </div>
    </div>
  `;

  document.body.appendChild(selectionOverlay);
}

function updateCompTypeBorderColor(element) {
  const radio = element.querySelector('input[type="radio"]');
  if (radio && radio.checked) {
    element.style.borderColor = '#00d4ff';
    element.style.backgroundColor = 'rgba(0, 212, 255, 0.15)';
  } else {
    element.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    element.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
  }
}

function selectCompType(labelElement, type) {
  // Update all labels to default state
  const allLabels = document.querySelectorAll('label[onclick*="selectCompType"]');
  allLabels.forEach(label => {
    label.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    label.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
  });
  
  // Highlight selected label
  labelElement.style.borderColor = '#00d4ff';
  labelElement.style.backgroundColor = 'rgba(0, 212, 255, 0.15)';
  
  // Enable the start button
  const startBtn = document.getElementById('startCompBtn');
  startBtn.style.background = 'linear-gradient(45deg, #00d4ff, #ff0080)';
  startBtn.style.cursor = 'pointer';
  startBtn.style.opacity = '1';
  startBtn.disabled = false;
  
  // Store selected type
  window.selectedCompType = type;
}

function startSelectedCompetition() {
  const selectedType = window.selectedCompType;
  
  if (!selectedType) {
    alert('Please select a competition type');
    return;
  }
  
  // Remove selection overlay
  document.querySelector('[style*="backdrop-filter"]').remove();
  
  // Close the competition page
  closeCompetePage();
  
  // Start the selected competition
  startCompetitionWithType(selectedType);
}
function startCompetitionWithType(type) {
  // Close the competition page
  closeCompetePage();
  
  switch(type) {
    case 'written':
      startWrittenCompetition();
      break;
    case 'speaking':
      startSpeakingCompetition();
      break;
    case 'case':
      startCaseCompetition();
      break;
    default:
      console.error('Unknown competition type:', type);
  }
}

// Written Competition - Quiz/Kahoot style
async function startWrittenCompetition() {
  const modal = createFullPageModal();
  
  // Sample questions - in real app, fetch from Firebase
  const questions = [
    {
      question: "What is the primary purpose of a business plan?",
      options: [
        "To secure funding",
        "To guide business operations", 
        "To attract customers",
        "To comply with regulations"
      ],
      correct: 1,
      competency: "Entrepreneurship"
    },
    {
      question: "Which financial statement shows a company's profitability?",
      options: [
        "Balance Sheet",
        "Cash Flow Statement",
        "Income Statement", 
        "Statement of Equity"
      ],
      correct: 2,
      competency: "Accounting"
    },
    {
      question: "What does ROI stand for in business?",
      options: [
        "Rate of Interest",
        "Return on Investment",
        "Risk of Investment", 
        "Revenue over Income"
      ],
      correct: 1,
      competency: "Finance"
    }
  ];
  
  let currentQuestionIndex = 0;
  let score = 0;
  let timeLeft = 30;
  let timer;
  let answers = [];
  
  function showQuestion() {
    const question = questions[currentQuestionIndex];
    
    modal.innerHTML = `
      <div style="
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <!-- Header -->
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px 40px;
          background: rgba(0,0,0,0.1);
        ">
          <div style="font-size: 24px; font-weight: bold;">
            Question ${currentQuestionIndex + 1}/${questions.length}
          </div>
          <div id="timer" style="
            font-size: 32px;
            font-weight: bold;
            padding: 10px 20px;
            background: ${timeLeft <= 10 ? '#ff4757' : '#2ed573'};
            border-radius: 50%;
            min-width: 80px;
            text-align: center;
          ">${timeLeft}</div>
          <button onclick="exitCompetition()" style="
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
          ">Exit</button>
        </div>
        
        <!-- Progress Bar -->
        <div style="
          height: 4px;
          background: rgba(255,255,255,0.2);
          margin: 0 40px 20px 40px;
        ">
          <div style="
            height: 100%;
            background: #2ed573;
            width: ${((currentQuestionIndex) / questions.length) * 100}%;
            transition: width 0.3s ease;
          "></div>
        </div>
        
        <!-- Question -->
        <div style="
          flex: 1;
          display: flex;
          flex-direction: column;
          justify-content: center;
          padding: 0 40px;
          max-width: 800px;
          margin: 0 auto;
          width: 100%;
        ">
          <div style="
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 60px;
            line-height: 1.2;
          ">${question.question}</div>
          
          <div style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
          ">
            ${question.options.map((option, index) => `
              <button onclick="selectAnswer(${index})" style="
                padding: 20px;
                font-size: 18px;
                background: rgba(255,255,255,0.1);
                border: 2px solid rgba(255,255,255,0.2);
                color: white;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: left;
              " onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                 onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <div style="font-weight: bold; margin-bottom: 5px;">
                  ${String.fromCharCode(65 + index)}
                </div>
                ${option}
              </button>
            `).join('')}
          </div>
        </div>
        
        <!-- Score -->
        <div style="
          text-align: center;
          padding: 20px;
          font-size: 18px;
        ">
          Score: ${score}/${questions.length}
        </div>
      </div>
    `;
    
    // Start timer
    startTimer();
  }
  
  function startTimer() {
    timer = setInterval(() => {
      timeLeft--;
      const timerEl = document.getElementById('timer');
      if (timerEl) {
        timerEl.textContent = timeLeft;
        timerEl.style.background = timeLeft <= 10 ? '#ff4757' : '#2ed573';
      }
      
      if (timeLeft <= 0) {
        clearInterval(timer);
        selectAnswer(-1); // Time up, no answer
      }
    }, 1000);
  }
  
  window.selectAnswer = function(selectedIndex) {
    clearInterval(timer);
    const question = questions[currentQuestionIndex];
    const isCorrect = selectedIndex === question.correct;
    
    if (isCorrect) score++;
    
    answers.push({
      question: question.question,
      selected: selectedIndex >= 0 ? question.options[selectedIndex] : 'Time Up',
      correct: question.options[question.correct],
      isCorrect: isCorrect,
      timeRemaining: timeLeft
    });
    
    // Show answer feedback
    showAnswerFeedback(isCorrect, question.options[question.correct]);
    
    setTimeout(() => {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        timeLeft = 30;
        showQuestion();
      } else {
        showResults();
      }
    }, 2000);
  };
  
  function showAnswerFeedback(isCorrect, correctAnswer) {
    const feedbackOverlay = document.createElement('div');
    feedbackOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    `;
    
    feedbackOverlay.innerHTML = `
      <div style="
        text-align: center;
        color: white;
        font-size: 32px;
        font-weight: bold;
      ">
        <div style="
          font-size: 64px;
          margin-bottom: 20px;
        ">${isCorrect ? '' : ''}</div>
        <div style="margin-bottom: 10px;">
          ${isCorrect ? 'Correct!' : 'Incorrect'}
        </div>
        <div style="font-size: 18px; opacity: 0.8;">
          Answer: ${correctAnswer}
        </div>
      </div>
    `;
    
    document.body.appendChild(feedbackOverlay);
    
    setTimeout(() => {
      feedbackOverlay.remove();
    }, 2000);
  }
  
  async function showResults() {
    // Save results to Firebase (placeholder)
    const resultData = {
      userId: firebase.auth().currentUser?.uid,
      score: score,
      totalQuestions: questions.length,
      answers: answers,
      timestamp: new Date()
    };
    
    // In real app, save to Firebase here
    console.log('Competition results:', resultData);
    
    modal.innerHTML = `
      <div style="
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        text-align: center;
        padding: 40px;
      ">
        <h1 style="
          font-size: 48px;
          margin-bottom: 20px;
          font-weight: bold;
        "> Competition Complete!</h1>
        
        <div style="
          font-size: 72px;
          font-weight: bold;
          margin: 40px 0;
        ">${score}/${questions.length}</div>
        
        <div style="
          font-size: 24px;
          margin-bottom: 40px;
          opacity: 0.9;
        ">
          ${score === questions.length ? 'Perfect Score!' : 
            score >= questions.length * 0.8 ? 'Excellent!' :
            score >= questions.length * 0.6 ? 'Good Job!' :
            'Keep Practicing!'}
        </div>
        
        <!-- Leaderboard -->
        <div style="
          background: rgba(255,255,255,0.1);
          border-radius: 16px;
          padding: 30px;
          margin: 20px auto;
          max-width: 600px;
          width: 100%;
        ">
          <h3 style="margin-bottom: 20px; font-size: 24px;"> Leaderboard</h3>
          <div style="text-align: left;">
            <div style="
              display: flex;
              justify-content: space-between;
              padding: 15px;
              background: rgba(255,215,0,0.2);
              border-radius: 8px;
              margin-bottom: 10px;
              border-left: 4px solid gold;
            ">
              <span> You</span>
              <span>${score}/${questions.length}</span>
            </div>
            <div style="
              display: flex;
              justify-content: space-between;
              padding: 15px;
              background: rgba(255,255,255,0.1);
              border-radius: 8px;
              margin-bottom: 10px;
            ">
              <span> Team Alpha</span>
              <span>${Math.max(0, score - 1)}/${questions.length}</span>
            </div>
            <div style="
              display: flex;
              justify-content: space-between;
              padding: 15px;
              background: rgba(255,255,255,0.1);
              border-radius: 8px;
            ">
              <span> Team Beta</span>
              <span>${Math.max(0, score - 2)}/${questions.length}</span>
            </div>
          </div>
        </div>
        
        <div style="
          display: flex;
          gap: 20px;
          justify-content: center;
          margin-top: 40px;
        ">
          <button onclick="closeModal()" style="
            padding: 15px 30px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">Back to Home</button>
          <button onclick="startWrittenCompetition()" style="
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">Play Again</button>
        </div>
      </div>
    `;
  }
  
  // Start the quiz
  showQuestion();
}

// Speaking Competition
function startSpeakingCompetition() {
  const modal = createFullPageModal();
  
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow:auto;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    ">
      <!-- Header -->
      <div style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
        background: rgba(0,0,0,0.1);
      ">
        <h1 style="font-size: 28px; margin: 0;"> Speaking Competition</h1>
        <button onclick="closeModal()" style="
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        ">Exit</button>
      </div>
      
      <!-- Main Content -->
      <div style="
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 40px;
        text-align: center;
      ">
        <div id="challenge-prompt" style="
          background: rgba(255,255,255,0.1);
          border-radius: 16px;
          padding: 40px;
          margin-bottom: 40px;
          max-width: 700px;
        ">
          <h2 style="
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: bold;
          ">Your Challenge</h2>
          <p style="
            font-size: 20px;
            line-height: 1.5;
            margin-bottom: 20px;
          ">
            "Present a 3-minute elevator pitch for a new mobile app that helps students manage their finances. 
            Include the problem, solution, target market, and monetization strategy."
          </p>
          <div style="
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            font-size: 16px;
          ">
            <div> Time Limit: 3 minutes</div>
            <div> Points: 100</div>
            <div> Judged on: Content, Delivery, Clarity</div>
          </div>
        </div>
        
        <!-- Camera Section -->
        <div id="camera-section" style="
          background: rgba(0,0,0,0.3);
          border-radius: 16px;
          padding: 30px;
          margin-bottom: 30px;
          width: 100%;
          max-width: 600px;
        ">
          <video id="video" autoplay muted style="
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 12px;
            object-fit: cover;
          "></video>
          
          <div style="
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
          ">
            <button id="start-recording" onclick="startRecording()" style="
              padding: 15px 30px;
              background: #ff4757;
              border: none;
              color: white;
              border-radius: 12px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              display: flex;
              align-items: center;
              gap: 10px;
            ">
               Start Recording
            </button>
            
            <button id="stop-recording" onclick="stopRecording()" style="
              padding: 15px 30px;
              background: #2ed573;
              border: none;
              color: white;
              border-radius: 12px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              display: none;
              align-items: center;
              gap: 10px;
            ">
               Stop & Submit
            </button>
          </div>
          
          <div id="timer-display" style="
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
            display: none;
          ">Time: <span id="recording-timer">00:00</span></div>
        </div>
      </div>
    </div>
  `;
  
  // Initialize camera
  initializeCamera();
}

async function initializeCaseCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: true, 
      audio: true 
    });
    const video = document.getElementById('case-video');
    if (video) {
      video.srcObject = stream;
      // Store the stream globally so we can access it later
      window.caseStream = stream;
    }
  } catch (err) {
    console.error('Error accessing camera:', err);
    alert('Unable to access camera. Please check permissions.');
  }
}


// Case Competition
function startCaseCompetition() {
  const modal = createFullPageModal();
  
  modal.innerHTML = `
    <div style="
      display: flex;
      height: 100vh;
      flex-direction: column;
      overflow: auto;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    ">
      <!-- Header -->
      <div style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
        background: rgba(0,0,0,0.1);
      ">
        <h1 style="font-size: 28px; margin: 0;"> Case Study Competition</h1>
        <button onclick="closeModal()" style="
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        ">Exit</button>
      </div>
      
      <!-- Main Content -->
      <div style="
        flex: 1;
        display: flex;
        padding: 20px;
        gap: 20px;
      ">
        <!-- Case Study Document -->
        <div style="
          flex: 2;
          background: rgba(255,255,255,0.1);
          border-radius: 16px;
          padding: 30px;
          overflow-y: auto;
        ">
          <h2 style="margin-bottom: 20px; font-size: 24px;"> Case Study: TechStart Inc.</h2>
          
          <div style="
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            line-height: 1.6;
          ">
            <h3 style="color: #ffd700; margin-bottom: 15px;">Background</h3>
            <p>TechStart Inc. is a 3-year-old software company that developed a project management tool for small businesses. Initially successful with 10,000 users and $2M ARR, they're now facing increased competition from larger tech companies.</p>
          </div>
          
          <div style="
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            line-height: 1.6;
          ">
            <h3 style="color: #ffd700; margin-bottom: 15px;">Current Challenges</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li>Customer acquisition cost has increased by 200%</li>
              <li>Monthly churn rate is 8% (industry average: 5%)</li>
              <li>Limited development resources (5 engineers)</li>
              <li>New competitor launched with 50% lower pricing</li>
            </ul>
          </div>
          
          <div style="
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            line-height: 1.6;
          ">
            <h3 style="color: #ffd700; margin-bottom: 15px;">Financial Data</h3>
            <p><strong>Monthly Revenue:</strong> $167K<br>
            <strong>Operating Costs:</strong> $140K/month<br>
            <strong>Cash on Hand:</strong> $800K<br>
            <strong>Runway:</strong> 10 months at current burn rate</p>
          </div>
        </div>
        
        <!-- Response Section -->
        <div style="
          flex: 1;
          background: rgba(255,255,255,0.1);
          border-radius: 16px;
          padding: 30px;
          display: flex;
          flex-direction: column;
        ">
          <h3 style="margin-bottom: 20px; font-size: 20px;">Your Strategic Response</h3>
          
          <div style="
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
          ">
            <h4 style="margin-bottom: 15px; color: #ffd700;">Question 1</h4>
            <p style="margin-bottom: 15px; font-size: 14px;">
              What are the top 3 strategic priorities TechStart should focus on immediately?
            </p>
            <textarea placeholder="Enter your response..." style="
              width: 100%;
              height: 100px;
              background: rgba(255,255,255,0.1);
              border: 1px solid rgba(255,255,255,0.3);
              border-radius: 8px;
              padding: 15px;
              color: white;
              font-size: 14px;
              resize: vertical;
            "></textarea>
          </div>
          
          <div style="
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
          ">
            <h4 style="margin-bottom: 15px; color: #ffd700;">Question 2</h4>
            <p style="margin-bottom: 15px; font-size: 14px;">
              Develop a 6-month action plan to reduce churn and improve unit economics.
            </p>
            <textarea placeholder="Enter your response..." style="
              width: 100%;
              height: 120px;
              background: rgba(255,255,255,0.1);
              border: 1px solid rgba(255,255,255,0.3);
              border-radius: 8px;
              padding: 15px;
              color: white;
              font-size: 14px;
              resize: vertical;
            "></textarea>
          </div>
          
          <!-- Camera Section for Presentation -->
          <div style="
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
          ">
            <h4 style="margin-bottom: 15px; text-align: center;"> Present Your Solution</h4>
            <video id="case-video" autoplay muted style="
              width: 100%;
              height: 150px;
              background: #000;
              border-radius: 8px;
              object-fit: cover;
              margin-bottom: 15px;
            "></video>
            
            <div style="
              display: flex;
              justify-content: center;
              gap: 10px;
              margin-bottom: 15px;
            ">
              <button id="start-recording" onclick="startRecording()" style="
                padding: 10px 20px;
                background: #ff4757;
                border: none;
                color: white;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
              ">
                 Start Recording
              </button>
              
              <button id="stop-recording" onclick="stopRecording()" style="
                padding: 10px 20px;
                background: #2ed573;
                border: none;
                color: white;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                display: none;
                align-items: center;
                gap: 8px;
              ">
                 Stop & Submit
              </button>
            </div>
            
            <div id="timer-display" style="
              text-align: center;
              font-size: 16px;
              font-weight: bold;
              display: none;
            ">Recording: <span id="recording-timer">00:00</span></div>
            
            <div style="
              text-align: center;
              margin-top: 15px;
              font-size: 12px;
              opacity: 0.7;
            "> Time Remaining: 45:00</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Initialize camera for case study
  initializeCaseCamera();
}
// Helper function to create full page modal
function createFullPageModal() {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
  `;
  modal.id = 'competition-modal';
  document.body.appendChild(modal);
  return modal;
}

// Camera functions
async function initializeCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: true, 
      audio: true 
    });
    const video = document.getElementById('video');
    if (video) {
      video.srcObject = stream;
    }
  } catch (err) {
    console.error('Error accessing camera:', err);
    alert('Unable to access camera. Please check permissions.');
  }
}



let mediaRecorder;
let recordedChunks = [];
let recordingTimer;
let recordingTime = 0;
let caseStream = null;

function startRecording() {
  // Check which video element exists
  const video = document.getElementById('video') || document.getElementById('case-video');
  const startBtn = document.getElementById('start-recording');
  const stopBtn = document.getElementById('stop-recording');
  const timerDisplay = document.getElementById('timer-display');
  const recordingTimerEl = document.getElementById('recording-timer');
  
  if (!video || !video.srcObject) {
    alert('Camera not initialized. Please refresh and try again.');
    return;
  }
  
  const stream = video.srcObject;
  
  recordedChunks = [];
  mediaRecorder = new MediaRecorder(stream);
  
  mediaRecorder.ondataavailable = function(event) {
    if (event.data.size > 0) {
      recordedChunks.push(event.data);
    }
  };
  
  mediaRecorder.onstop = function() {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    // Here you would upload to Firebase or process the recording
    console.log('Recording completed:', blob);
    
    // Show different completion screens based on competition type
    if (document.getElementById('case-video')) {
      showCaseRecordingComplete();
    } else {
      showRecordingComplete();
    }
  };
  
  mediaRecorder.start();
  
  // Update UI
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'flex';
  if (timerDisplay) timerDisplay.style.display = 'block';
  
  // Start timer
  recordingTime = 0;
  recordingTimer = setInterval(() => {
    recordingTime++;
    const minutes = Math.floor(recordingTime / 60);
    const seconds = recordingTime % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (recordingTimerEl) {
      recordingTimerEl.textContent = timeString;
    }
    
    // Auto-stop at 3 minutes for speaking, 10 minutes for case study
    const maxTime = document.getElementById('case-video') ? 600 : 180;
    if (recordingTime >= maxTime) {
      stopRecording();
    }
  }, 1000);
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  if (recordingTimer) {
    clearInterval(recordingTimer);
  }
  
  // Reset UI
  const startBtn = document.getElementById('start-recording');
  const stopBtn = document.getElementById('stop-recording');
  
  if (startBtn) startBtn.style.display = 'flex';
  if (stopBtn) stopBtn.style.display = 'none';
}

// New function specifically for case study recording completion
function showCaseRecordingComplete() {
  // Collect all text responses
  const responses = document.querySelectorAll('textarea');
  const answers = Array.from(responses).map(textarea => textarea.value);
  
  console.log('Case study responses:', answers);
  
  const modal = document.getElementById('competition-modal');
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center;
      padding: 40px;
      justify-content: center;
      align-items: center;
    ">
      <h1 style="font-size: 48px; margin-bottom: 20px;"> Case Study Complete!</h1>
      <p style="font-size: 24px; margin-bottom: 40px;">
        Your strategic analysis and presentation have been successfully submitted.
      </p>
      
      <!-- Mock Scoring for Case Study -->
      <div style="
        background: rgba(255,255,255,0.1);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        max-width: 500px;
        width: 100%;
      ">
        <h3 style="margin-bottom: 20px; font-size: 24px;"> Preliminary Assessment</h3>
        <div style="text-align: left; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Strategic Analysis</span>
            <span style="color: #2ed573; font-weight: bold;">88/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Financial Understanding</span>
            <span style="color: #2ed573; font-weight: bold;">82/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Presentation Quality</span>
            <span style="color: #ffa500; font-weight: bold;">91/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Implementation Plan</span>
            <span style="color: #2ed573; font-weight: bold;">85/100</span>
          </div>
          <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">
          <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
            <span>Overall Score</span>
            <span style="color: #ffd700;">346/400</span>
          </div>
        </div>
      </div>
      
      <p style="font-size: 16px; margin-bottom: 40px; opacity: 0.9;">
        Detailed feedback from industry experts will be available within 48 hours.
      </p>
      
      <div style="display: flex; gap: 20px;">
        <button onclick="closeModal()" style="
          padding: 15px 30px;
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Back to Home</button>
        <button onclick="startCaseCompetition()" style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #ff6b6b, #ee5a52);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Try Another Case</button>
      </div>
    </div>
  `;
}

function startCaseRecording() {
  // Similar to startRecording but for case study
  console.log('Starting case study recording...');
}

function submitCaseStudy() {
  // Collect all responses and submit
  const responses = document.querySelectorAll('textarea');
  const answers = Array.from(responses).map(textarea => textarea.value);
  
  console.log('Case study responses:', answers);
  
  // Show completion screen
  const modal = document.getElementById('competition-modal');
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center;
      padding: 40px;
      justify-content: center;
      align-items: center;
    ">
      <h1 style="font-size: 48px; margin-bottom: 20px;"> Case Study Submitted!</h1>
      <p style="font-size: 24px; margin-bottom: 40px;">
        Your strategic analysis has been submitted for review.
      </p>
      <p style="font-size: 18px; margin-bottom: 40px; opacity: 0.9;">
        You'll receive feedback and scores within 24 hours.
      </p>
      <button onclick="closeModal()" style="
        padding: 15px 30px;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
      ">Back to Home</button>
    </div>
  `;
}

function showRecordingComplete() {
  const modal = document.getElementById('competition-modal');
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center;
      padding: 40px;
      justify-content: center;
      align-items: center;
    ">
      <h1 style="font-size: 48px; margin-bottom: 20px;"> Presentation Recorded!</h1>
      <p style="font-size: 24px; margin-bottom: 40px;">
        Your speaking presentation has been successfully recorded and submitted.
      </p>
      
      <!-- Mock Scoring -->
      <div style="
        background: rgba(255,255,255,0.1);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        max-width: 500px;
        width: 100%;
      ">
        <h3 style="margin-bottom: 20px; font-size: 24px;"> Preliminary Scores</h3>
        <div style="text-align: left; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Content Quality</span>
            <span style="color: #2ed573; font-weight: bold;">85/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Delivery & Clarity</span>
            <span style="color: #2ed573; font-weight: bold;">92/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Time Management</span>
            <span style="color: #ffa500; font-weight: bold;">78/100</span>
          </div>
          <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">
          <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
            <span>Total Score</span>
            <span style="color: #ffd700;">255/300</span>
          </div>
        </div>
      </div>
      
      <p style="font-size: 16px; margin-bottom: 40px; opacity: 0.9;">
        Final judges' scores will be available after all participants have completed their presentations.
      </p>
      
      <div style="display: flex; gap: 20px;">
        <button onclick="closeModal()" style="
          padding: 15px 30px;
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Back to Home</button>
        <button onclick="startSpeakingCompetition()" style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #ff6b6b, #ee5a52);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Try Again</button>
      </div>
    </div>
  `;
}

// Global exit function
window.exitCompetition = function() {
  if (confirm('Are you sure you want to exit the competition? Your progress will be lost.')) {
    closeModal();
  }
};

// Global close modal function
window.closeModal = function() {
  const modal = document.getElementById('competition-modal');
  if (modal) {
    // Stop any ongoing timers
    if (timer) clearInterval(timer);
    if (recordingTimer) clearInterval(recordingTimer);
    
    // Stop camera streams
    const videos = modal.querySelectorAll('video');
    videos.forEach(video => {
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
    });
    
    modal.remove();
  }
};

// Additional helper functions for Firebase integration

async function saveCompetitionResult(type, data) {
  try {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    const result = {
      userId: user.uid,
      competitionType: type,
      timestamp: new Date(),
      ...data
    };
    
    await db.collection('competitionResults').add(result);
    console.log('Competition result saved:', result);
  } catch (error) {
    console.error('Error saving competition result:', error);
  }
}

async function getLeaderboard(competitionType) {
  try {
    const snapshot = await db.collection('competitionResults')
      .where('competitionType', '==', competitionType)
      .orderBy('score', 'desc')
      .limit(10)
      .get();
    
    const leaderboard = [];
    snapshot.forEach(doc => {
      leaderboard.push(doc.data());
    });
    
    return leaderboard;
  } catch (error) {
    console.error('Error getting leaderboard:', error);
    return [];
  }
}

// Enhanced written competition with real Firebase leaderboard
async function showWrittenResults() {
  // Save results to Firebase
  const resultData = {
    score: score,
    totalQuestions: questions.length,
    answers: answers,
    timestamp: new Date()
  };
  
  await saveCompetitionResult('written', resultData);
  
  // Get real leaderboard
  const leaderboard = await getLeaderboard('written');
  
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center;
      padding: 40px;
    ">
      <h1 style="
        font-size: 48px;
        margin-bottom: 20px;
        font-weight: bold;
      "> Competition Complete!</h1>
      
      <div style="
        font-size: 72px;
        font-weight: bold;
        margin: 40px 0;
      ">${score}/${questions.length}</div>
      
      <div style="
        font-size: 24px;
        margin-bottom: 40px;
        opacity: 0.9;
      ">
        ${score === questions.length ? 'Perfect Score!' : 
          score >= questions.length * 0.8 ? 'Excellent!' :
          score >= questions.length * 0.6 ? 'Good Job!' :
          'Keep Practicing!'}
      </div>
      
      <!-- Real Firebase Leaderboard -->
      <div style="
        background: rgba(255,255,255,0.1);
        border-radius: 16px;
        padding: 30px;
        margin: 20px auto;
        max-width: 600px;
        width: 100%;
      ">
        <h3 style="margin-bottom: 20px; font-size: 24px;"> Live Leaderboard</h3>
        <div style="text-align: left;">
          ${leaderboard.map((entry, index) => `
            <div style="
              display: flex;
              justify-content: space-between;
              padding: 15px;
              background: ${index === 0 ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.1)'};
              border-radius: 8px;
              margin-bottom: 10px;
              ${index === 0 ? 'border-left: 4px solid gold;' : ''}
            ">
              <span>${index === 0 ? '' : index === 1 ? '' : index === 2 ? '' : ''} ${entry.userId === firebase.auth().currentUser?.uid ? 'You' : `Player ${index + 1}`}</span>
              <span>${entry.score}/${entry.totalQuestions}</span>
            </div>
          `).join('')}
        </div>
      </div>
      
      <div style="
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 40px;
      ">
        <button onclick="closeModal()" style="
          padding: 15px 30px;
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Back to Home</button>
        <button onclick="startWrittenCompetition()" style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #ff6b6b, #ee5a52);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Play Again</button>
      </div>
    </div>
  `;
}

window.backToHome = function() {
  closeModal();
  // If you're in a subdirectory, adjust the path accordingly
  // For example, if you're in /public/home.html, use '../index.html' or the correct path
  window.location.href = 'home.html'; // Adjust this path as needed
};

  // Create stars for background
  function createStars() {
    const starsContainer = document.getElementById("starsContainer");
    if (!starsContainer) return;
    
    for (let i = 0; i < 200; i++) {
      const star = document.createElement("div");
      star.className = "star";
      const size = Math.random() * 3 + 0.5;
      const duration = Math.random() * 4 + 2;
      const delay = Math.random() * 2;
      const randomLeft = Math.random() * 100;
      const randomTop = Math.random() * 100;
      const randomOpacity = Math.random() * 0.9 + 0.3;
      
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = randomLeft + '%';
      star.style.top = randomTop + '%';
      star.style.opacity = randomOpacity;
      star.style.animation = `twinkle ${duration}s ease-in-out infinite`;
      star.style.animationDelay = delay + 's';
      star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
      
      starsContainer.appendChild(star);
    }
  }

  // Initialize stars on page load
  document.addEventListener('DOMContentLoaded', function() {
    createStars();
  });

  // Notification Panel Toggle
  // Mobile Navigation Toggle
  window.toggleMobileNav = function() {
    const nav = document.getElementById('mainNav');
    const hamburger = document.getElementById('hamburgerMenu');
    
    if (nav && hamburger) {
      nav.classList.toggle('active');
      hamburger.classList.toggle('active');
      document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
    }
  };
  
  // Close mobile nav when clicking a nav link
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.blaze-nav .nav-link').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          toggleMobileNav();
        }
      });
    });
  });

  function toggleNotificationPanel() {
    const panel = document.getElementById("notificationPanel");
    if (!panel) return;
    
    if (panel.classList.contains("active")) {
      panel.classList.remove("active");
      setTimeout(() => panel.classList.add("hidden"), 300);
    } else {
      panel.classList.remove("hidden");
      setTimeout(() => panel.classList.add("active"), 10);
      loadNotifications();
    }
  }
  window.toggleNotificationPanel = toggleNotificationPanel;
  window.updateNotificationBadge = updateNotificationBadge;

  // Update notification badge in nav
  function updateNotificationBadge(count) {
    const notificationLink = document.querySelector('a[onclick*="toggleNotificationPanel"]');
    if (notificationLink) {
      let notificationBadge = notificationLink.querySelector('.notification-badge');
      if (!notificationBadge && count > 0) {
        notificationBadge = document.createElement('span');
        notificationBadge.className = 'notification-badge';
        notificationBadge.textContent = count;
        notificationLink.style.position = 'relative';
        notificationLink.appendChild(notificationBadge);
      } else if (notificationBadge) {
        if (count > 0) {
          notificationBadge.style.display = 'inline-flex';
          notificationBadge.textContent = count;
        } else {
          notificationBadge.style.display = 'none';
        }
      }
    }
  }

  // Load Notifications (for initial load)
  function loadNotifications() {
    setupNotifications();
  }

  // Initialize notifications when user is authenticated
  auth.onAuthStateChanged((user) => {
    if (user) {
      setupNotifications();
      // Check mentor status and show/hide mentor link
      db.collection('users').doc(user.uid).get().then((doc) => {
        const mentorNavLink = document.getElementById('mentorNavLink');
        if (mentorNavLink) {
          const isMentor = doc.exists && doc.data().isMentor === true;
          mentorNavLink.style.display = isMentor ? 'block' : 'none';
        }
      }).catch((error) => {
        console.error('Error checking mentor status:', error);
      });
    }
  });

  // ========== ASSIGNMENT MODAL FUNCTIONS ==========
  function openFullAssignmentModal(assignment) {
    console.log(' openFullAssignmentModal called with:', assignment);
    
    if (!assignment) {
      console.error(' No assignment provided to openFullAssignmentModal');
      return;
    }
    
    const modal = document.getElementById('cq-assignment-modal');
    const titleEl = document.getElementById('cq-assignment-title');
    const infoEl = document.getElementById('cq-assignment-info');
    const quizEl = document.getElementById('cq-assignment-quiz');
    const fieldsElement = document.getElementById('cq-assignment-fields');
    
    if (!modal) {
      console.error(' Modal element not found: cq-assignment-modal');
      alert('Assignment modal not found. Please refresh the page.');
      return;
    }
    
    if (!titleEl) {
      console.error(' Title element not found: cq-assignment-title');
      return;
    }
    
    if (!fieldsElement) {
      console.error(' Fields element not found: cq-assignment-fields');
      return;
    }
    
    // Set the modal title
    titleEl.innerText = assignment.title || "New Assignment";
    
    // Show info section, hide quiz section
    if (infoEl) infoEl.style.display = 'block';
    if (quizEl) quizEl.style.display = 'none';
    
    // Fill in all assignment details
    if (assignment.type === "speaking" || assignment.type === "case") {
      // Speaking/Case assignment format
      const q1 = assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided";
      const q2 = assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided";
      const q3 = assignment.questions && assignment.questions[2] ? assignment.questions[2] : null;
      
      fieldsElement.innerHTML = `
        <div><b>Type:</b> ${assignment.type === "speaking" ? "Speaking" : "Case"} Assignment</div>
        <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
        <div><b>Description:</b> ${assignment.description || 'n/a'}</div>
        ${assignment.time ? `<div><b>Time Limit:</b> ${assignment.time}</div>` : ''}
        <div><b>Questions:</b></div>
        <ul>
          <li>${q1}</li>
          <li>${q2}</li>
          ${q3 ? `<li>${q3}</li>` : ''}
        </ul>
      `;
    } else {
      // Regular assignment format
      fieldsElement.innerHTML = `
        <div><b>Type:</b> ${assignment.type || 'Quiz'} Assignment</div>
        <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
        <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
        <div><b>Questions:</b><br> <span style="font-weight:400; color:#e2e8f0">${assignment.questions || 'n/a'}</span></div>
        <div><b>Difficulty:</b> ${assignment.difficulty || 'n/a'}</div>
        <div><b>Simulate:</b> ${assignment.simulate ? "Yes" : "No"}</div>
      `;
    }

    if (assignment.trainingPDFs && assignment.trainingPDFs.length > 0) {
      assignment.trainingPDFs.forEach(pdf => {
        const pdfBox = document.createElement('div');
        pdfBox.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; font-weight: 500;';
        pdfBox.textContent = pdf.name || 'Training Document';
        pdfBox.onclick = () => downloadPDF(pdf);
        fieldsElement.appendChild(pdfBox);
      });
    }
    
    // Show the modal
    console.log(' Showing modal');
    modal.style.display = 'block';
  }
  window.openFullAssignmentModal = openFullAssignmentModal;

  // Function to close assignment modal
  function closeAssignmentModal() {
    document.getElementById('cq-assignment-modal').style.display = 'none';
  }

  // ========== STATE ==========
  let writtenQuestions = [];
  let currentQuestionIndex = 0;
  let writtenAnswers = {};
  let writtenTimer = null;
  let writtenTimeRemaining = 0;

  async function acceptAssignmentNow() {
  console.log("\n ACCEPT ASSIGNMENT NOW\n");
  
  showLoader();

  const assignment = window.currentAssignment;
  
  if (!assignment) {
    console.error(" No assignment");
    hideLoader();
    return;
  }

  console.log(" Assignment type:", assignment.type);

  try {
    // Mark as seen
    if (window.latestAssignmentId) {
      const updateData = {
        status: "seen",
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (assignment.type === 'written') {
        updateData.score = 0;
        updateData.maxScore = assignment.writtenQuestions?.length || 10;
      }

      try {
        await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
        console.log(" Assignment marked as seen");
      } catch (error) {
        console.error(" Error marking as seen:", error);
      }
    }

    // Handle speaking/case
    if (assignment.type === 'speaking' || assignment.type === 'case') {
      console.log(" Speaking/case assignment");
      document.getElementById('cq-assignment-modal').style.display = 'none';
      hideLoader();
      openCameraModal();
      return;
    }

    // Handle written
    if (assignment.type === 'written') {
      console.log(" Written assignment");
      console.log(" CIRCULAR PROGRESS LOADER VISIBLE");

      const competencies = assignment.competencies;
      const questionCount = assignment.totalQuestions || 10;
      const difficulty = assignment.difficulty || 'medium';

      if (!competencies || competencies.length === 0) {
        console.warn(" No competencies");
        hideLoader();
        return;
      }

      // FETCH COMPETITION ID FROM FIREBASE
      console.log(" Fetching competition ID from Firebase...");
      let competitionId = assignment.competitionId 
        || window.currentCompetition?.id 
        || window.competitionId 
        || window.currentUser?.competitions?.[0];

      if (!competitionId) {
        try {
          const userId = firebase.auth().currentUser?.uid;
          if (userId) {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists && userDoc.data().competitions?.[0]) {
              competitionId = userDoc.data().competitions[0];
              console.log(" Fetched competition from Firebase:", competitionId);
            }
          }
        } catch (err) {
          console.warn(" Could not fetch competition from Firebase:", err);
        }
      }

      console.log(" Competition ID:", competitionId);

      // FETCH BASELINE
      console.log(" Fetching baseline...");
      let baselineText = "";

      if (competitionId) {
        try {
          const competitionDoc = await db.collection('competitions').doc(competitionId).get();
          if (competitionDoc.exists) {
            const baseline = competitionDoc.data().baseline || {};
            if (baseline.text) {
              baselineText = baseline.text;
              console.log(" Baseline fetched:", baselineText.length, "characters");
            }
          }
        } catch (err) {
          console.warn(" Baseline fetch failed");
        }
      } else {
        console.log(" No competition ID, skipping baseline");
      }

      // FETCH GPT CONTEXT
      console.log(" Fetching GPT context...");
      let gptContextData = {};

      try {
        const userId = firebase.auth().currentUser?.uid;
        if (userId) {
          const userTrainingDoc = await db.collection('userTraining').doc(userId).get();
          if (userTrainingDoc.exists && userTrainingDoc.data().gptTrainingContext) {
            gptContextData = userTrainingDoc.data().gptTrainingContext;
            console.log(" GPT context fetched");
          }
        }
      } catch (err) {
        console.warn(" GPT context fetch failed");
      }

      // BUILD CONTEXT STRING - Let GPT filter intelligently
      console.log(" Building context with full baseline + training data...");
      let contextString = "";
      
      if (baselineText) {
        contextString += "=== COMPETITION BASELINE STUDY MATERIAL ===\n";
        contextString += "Use the following baseline material to generate questions focused on: " + competencies.join(", ") + "\n";
        contextString += "Filter and extract the most relevant information for the specified competencies.\n\n";
        contextString += baselineText + "\n\n";
      }
      
      if (gptContextData.content) {
        contextString += "=== USER BACKGROUND AND TRAINING CONTEXT ===\n";
        contextString += "Consider the user's background when generating questions:\n";
        contextString += gptContextData.content;
      }
      
      window.__CERTQUEST_CONTEXT__ = contextString;
      console.log(" Context ready:", contextString.length, "chars");
      console.log(" Competencies to focus on:", competencies);

      // GENERATE QUESTIONS
      console.log(" Generating questions WITH FULL BASELINE + TRAINING DATA...");
      console.log(" LOADER PROGRESS BAR VISIBLE & ANIMATING");
      
      const questions = await generatePersonalizedQuestionsWithGPT({
        competencies,
        time: 15,
        difficulty,
        questionCount
      });

      console.log(" Generated", questions.length, "questions");

      // UPDATE ASSIGNMENT
      const updatedAssignment = {
        ...assignment,
        generatedQuestions: questions,
        baselineText,
        gptContext: gptContextData
      };

      window.currentAssignment = updatedAssignment;
      window.writtenQuestions = questions;

      console.log(" Opening modal...");

      // OPEN MODAL
      document.getElementById('cq-assignment-modal').style.display = 'none';
      await openWrittenPracticeModal(updatedAssignment);
    }

  } catch (error) {
    console.error(" Error:", error);
    hideLoader();
  }
}


/**
 * Gathers baseline data for competencies from the competitions collection
 */
async function gatherBaselineData(competitionId, competencies) {
  try {
    if (!competitionId) {
      console.warn(" No competition ID provided");
      return {};
    }

    const competitionDoc = await db
      .collection('competitions')
      .doc(competitionId)
      .get();

    if (!competitionDoc.exists) {
      console.warn(" Competition not found:", competitionId);
      return {};
    }

    const competitionData = competitionDoc.data();
    console.log(" Full competition data structure:", competitionData);
    console.log(" Baseline field:", competitionData.baseline);

    const baseline = {};

    // Extract baseline for each competency from competition.baseline
    competencies.forEach(competencyId => {
      const competencyBaseline = competitionData.baseline?.[competencyId];

      if (competencyBaseline) {
        baseline[competencyId] = competencyBaseline;
        console.log(` Found baseline for ${competencyId}:`, competencyBaseline);
      } else {
        console.log(` No baseline found for competency: ${competencyId}`);
      }
    });

    console.log(" Final baseline object:", baseline);
    return baseline;
  } catch (error) {
    console.error(" Error gathering baseline data:", error);
    return {};
  }
}

  // Circular progress loader state
  let progressInterval = null;
  let currentProgress = 0;

  function updateCircularProgress(progress) {
    const fill = document.getElementById('circularProgressFill');
    const text = document.getElementById('circularProgressText');
    
    if (fill && text) {
      const circumference = 2 * Math.PI * 45;
      const offset = circumference - (progress / 100) * circumference;
      fill.style.strokeDashoffset = offset;
      text.textContent = Math.round(progress) + '%';
    }
  }

  function startCircularProgress() {
    currentProgress = 0;
    updateCircularProgress(0);
    
    progressInterval = setInterval(() => {
      currentProgress += 2;
      if (currentProgress > 95) {
        currentProgress = 95;
      }
      updateCircularProgress(currentProgress);
    }, 100);
  }

  function completeCircularProgress() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
    updateCircularProgress(100);
  }

  function stopCircularProgress() {
    if (progressInterval) {
      clearInterval(progressInterval);
      progressInterval = null;
    }
    currentProgress = 0;
  }

  function showLoader() {
    const loader = document.getElementById("assignmentLoader");
    if (loader) {
      loader.style.display = "flex";
      startCircularProgress();
    }
  }

  function hideLoader() {
    completeCircularProgress();
    setTimeout(() => {
      stopCircularProgress();
      const loader = document.getElementById("assignmentLoader");
      if (loader) {
        loader.style.display = "none";
      }
    }, 300);
  }

  // ========== SPEAKING ASSIGNMENT FUNCTIONS ==========
  
  function checkRecordingSupport() {
    const issues = [];
    
    if (!navigator.mediaDevices) {
      issues.push("mediaDevices not supported");
    }
    
    if (!navigator.mediaDevices.getUserMedia) {
      issues.push("getUserMedia not supported");
    }
    
    if (!window.MediaRecorder) {
      issues.push("MediaRecorder not supported");
    }
    
    if (issues.length > 0) {
      console.error("Recording not supported:", issues.join(", "));
      alert("Your browser does not support audio/video recording: " + issues.join(", "));
      return false;
    }
    
    return true;
  }

  function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  function cqSpeakingStopAllMedia() {
    console.log("Stopping all media...");
    
    // Stop MediaRecorder
    if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state !== "inactive") {
      try {
        cqSpeakingMediaRecorder.stop();
      } catch (e) {
        console.error("Error stopping MediaRecorder:", e);
      }
    }
    
    // Stop all media tracks
    if (cqSpeakingMediaStream) {
      cqSpeakingMediaStream.getTracks().forEach(track => {
        track.stop();
        console.log("Stopped track:", track.kind, track.label);
      });
      cqSpeakingMediaStream = null;
    }
    
    // Clear recorded data
    cqSpeakingRecordedChunks = [];
    
    // Hide stop button
    const stopBtn = document.getElementById('cq-speaking-stopBtn');
    if (stopBtn) {
      stopBtn.style.display = 'none';
    }
    
    // Reset video element
    const videoElement = document.getElementById('cq-speaking-videoPreview');
    const noVideoView = document.getElementById('cq-speaking-noVideoView');
    if (videoElement) {
      videoElement.srcObject = null;
      videoElement.src = '';
      videoElement.controls = false;
      videoElement.style.display = 'none';
    }
    if (noVideoView) {
      noVideoView.style.display = 'flex';
    }
    
    // Update record button state
    const recordBtn = document.getElementById('cq-speaking-recordBtn');
    if (recordBtn) {
      recordBtn.classList.remove('recording');
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    isRecording = false;
    console.log("All media stopped and cleaned up");
  }

  function startAudioRecording() {
    document.getElementById('cq-speaking-downloadBtn').style.display = 'none';
    console.log("Starting audio recording...");
    
    if (!checkRecordingSupport()) return;
    
    // Stop any existing recording first
    cqSpeakingStopAllMedia();
    cqSpeakingRecordedChunks = [];
    
    navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    })
    .then(stream => {
      console.log("Audio stream obtained successfully");
      cqSpeakingMediaStream = stream;
      
      // Check MediaRecorder support and set up with best available format
      let options = {};
      if (MediaRecorder.isTypeSupported('audio/webm')) {
        options.mimeType = 'audio/webm';
      } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
        options.mimeType = 'audio/mp4';
      } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
        options.mimeType = 'audio/ogg';
      }
      
      cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
      console.log("MediaRecorder created with mimeType:", cqSpeakingMediaRecorder.mimeType);
      
      cqSpeakingMediaRecorder.ondataavailable = (event) => {
        console.log("Audio data available:", event.data.size, "bytes");
        if (event.data.size > 0) {
          cqSpeakingRecordedChunks.push(event.data);
        }
      };
      
      cqSpeakingMediaRecorder.onstop = () => {
        console.log("Audio recording stopped, processing...");
        if (cqSpeakingRecordedChunks.length === 0) {
          console.error("No audio data recorded");
          alert("No audio data was recorded. Please try again.");
          return;
        }
        const mimeType = cqSpeakingMediaRecorder.mimeType || 'audio/webm';
        const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });
        console.log("Created audio blob:", blob.size, "bytes, type:", blob.type);

        const audioURL = URL.createObjectURL(blob);
        const audioElement = document.getElementById('cq-speaking-audioPlayback');
        if (audioElement) {
          audioElement.src = audioURL;
          audioElement.style.display = 'block';
          audioElement.controls = true;
          console.log("Audio playback element updated");
        } else {
          console.error("Audio playback element not found in DOM");
        }

        // Download & Upload section
        const downloadBtn = document.getElementById('cq-speaking-downloadBtn');
        if (downloadBtn && blob) {
          downloadBtn.style.display = 'inline-block';
          downloadBtn.onclick = function() {
            const url = URL.createObjectURL(blob);
            const filename = `CertQuest_Response_${Date.now()}.webm`;
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, 100);
          };
        }

        isRecording = false;
      };
      
      cqSpeakingMediaRecorder.onerror = (event) => {
        console.error("MediaRecorder error:", event.error);
        alert("Recording error: " + event.error.message);
        isRecording = false;
      };
      
      // Start recording
      cqSpeakingMediaRecorder.start(1000); // Collect data every second
      isRecording = true;
      console.log("Audio recording started");
      
      // Show stop button
      const stopBtn = document.getElementById('cq-speaking-stopBtn');
      if (stopBtn) {
        stopBtn.style.display = 'inline-block';
        stopBtn.textContent = ' Stop Audio Recording';
      }
      
      // Show no video view for audio-only recording
      const videoPreview = document.getElementById('cq-speaking-videoPreview');
      const noVideoView = document.getElementById('cq-speaking-noVideoView');
      if (videoPreview) {
        videoPreview.style.display = 'none';
      }
      if (noVideoView) {
        noVideoView.style.display = 'flex';
      }
    })
    .catch(error => {
      console.error('Audio recording error:', error);
      let errorMessage = 'Failed to access microphone: ';
      if (error.name === 'NotAllowedError') {
        errorMessage += 'Permission denied. Please allow microphone access and try again.';
      } else if (error.name === 'NotFoundError') {
        errorMessage += 'No microphone found.';
      } else if (error.name === 'NotReadableError') {
        errorMessage += 'Microphone is already in use.';
      } else {
        errorMessage += error.message;
      }
      alert(errorMessage);
      isRecording = false;
    });
  }

  function startVideoRecording() {
    document.getElementById('cq-speaking-downloadBtn').style.display = 'none';

    console.log("Starting video recording...");
    
    if (!checkRecordingSupport()) return;
    
    // Stop any existing recording first
    cqSpeakingStopAllMedia();
    cqSpeakingRecordedChunks = [];
    
    navigator.mediaDevices.getUserMedia({ 
      video: {
        width: { min: 640, ideal: 1280, max: 1920 },
        height: { min: 480, ideal: 720, max: 1080 },
        frameRate: { min: 15, ideal: 30, max: 60 }
      }, 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    })
    .then(stream => {
      console.log("Video stream obtained successfully");
      cqSpeakingMediaStream = stream;
      setupRecordingFromStream(stream);
      // Don't auto-start recording - wait for user to click record button
    })
    .catch(error => {
      console.error('Video recording error:', error);
      let errorMessage = 'Failed to access camera/microphone: ';
      if (error.name === 'NotAllowedError') {
        errorMessage += 'Permission denied. Please allow camera and microphone access and try again.';
      } else if (error.name === 'NotFoundError') {
        errorMessage += 'No camera or microphone found.';
      } else if (error.name === 'NotReadableError') {
        errorMessage += 'Camera or microphone is already in use.';
      } else {
        errorMessage += error.message;
      }
      alert(errorMessage);
      isRecording = false;
    });
  }

  function setupRecordingFromStream(stream) {
    const videoElement = document.getElementById('cq-speaking-videoPreview');
    const noVideoView = document.getElementById('cq-speaking-noVideoView');
    if (!videoElement) {
      console.error("Video preview element not found in DOM");
      alert("Video preview element not found");
      return;
    }
    
    // Set up video preview
    videoElement.srcObject = stream;
    videoElement.muted = true; // Prevent feedback
    videoElement.autoplay = true;
    videoElement.playsInline = true; // Important for mobile
    videoElement.style.display = 'block';
    if (noVideoView) noVideoView.style.display = 'none';
    
    // Wait for video to be ready before starting recording
    videoElement.addEventListener('loadedmetadata', () => {
      videoElement.play().catch(e => {
        console.error("Error playing video preview:", e);
      });
    });
    
    // Hide audio playback if showing
    const audioPlayback = document.getElementById('cq-speaking-audioPlayback');
    if (audioPlayback) {
      audioPlayback.style.display = 'none';
    }
    
    // Set up MediaRecorder with best available format
    let options = {};
    if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
      options.mimeType = 'video/webm;codecs=vp9';
    } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
      options.mimeType = 'video/webm;codecs=vp8';
    } else if (MediaRecorder.isTypeSupported('video/webm')) {
      options.mimeType = 'video/webm';
    } else if (MediaRecorder.isTypeSupported('video/mp4')) {
      options.mimeType = 'video/mp4';
    }
    
    cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
    console.log("MediaRecorder created with mimeType:", cqSpeakingMediaRecorder.mimeType);
    
    cqSpeakingMediaRecorder.ondataavailable = (event) => {
      if (event.data && event.data.size > 0) {
        cqSpeakingRecordedChunks.push(event.data);
        console.log("Added chunk, total chunks:", cqSpeakingRecordedChunks.length, "total size:", cqSpeakingRecordedChunks.reduce((sum, chunk) => sum + chunk.size, 0), "bytes");
      }
      // Ignore empty chunks - they're normal and don't need to be logged
    };
    
    cqSpeakingMediaRecorder.onstop = () => {
      console.log("Video recording stopped, processing...");
      console.log("Total chunks collected:", cqSpeakingRecordedChunks.length);
      console.log("Recording duration check - chunks:", cqSpeakingRecordedChunks.length);
      
      // Clear state monitor when recording stops
      if (recordingStateMonitor) {
        clearInterval(recordingStateMonitor);
        recordingStateMonitor = null;
        console.log(" State monitor cleared in onstop handler");
      }
      
      // Only process if recording was intentionally stopped (not an error)
      if (!isRecording || isIntentionallyStopping) {
        console.log(" Recording was intentionally stopped by user");
      } else {
        console.warn(" Recording stopped but isRecording flag is still true - unexpected stop!");
      }
      
      // Request final data - this ensures we get any remaining data
      try {
        if (cqSpeakingMediaRecorder.state !== 'inactive') {
          cqSpeakingMediaRecorder.requestData();
        }
      } catch (e) {
        console.warn("Could not request final data:", e);
      }
      
      // Wait longer for final data to arrive (dataavailable event is async)
      // Use a longer timeout to ensure all data chunks are collected
      setTimeout(() => {
        console.log("Processing after stop, chunks:", cqSpeakingRecordedChunks.length);
        
        if (cqSpeakingRecordedChunks.length === 0) {
          console.error("No video data recorded after stop");
          alert("No video data was recorded. Please try recording for at least 1 second.");
          return;
        }
        const mimeType = cqSpeakingMediaRecorder.mimeType || 'video/webm';
        const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });
        console.log("Created video blob:", blob.size, "bytes, type:", blob.type);

        const videoURL = URL.createObjectURL(blob);
        const videoElement = document.getElementById('cq-speaking-videoPreview');
        const noVideoView = document.getElementById('cq-speaking-noVideoView');
        if (videoElement) {
          videoElement.srcObject = null;
          videoElement.src = videoURL;
          videoElement.controls = true;
          videoElement.muted = false;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
          console.log("Video playback element updated");
        }

        // Update record button state
        const recordBtn = document.getElementById('cq-speaking-recordBtn');
        if (recordBtn) {
          recordBtn.classList.remove('recording');
        }
        
        // Hide recording indicator
        const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
        if (recordingIndicator) {
          recordingIndicator.classList.remove('active');
        }

        // Download button (hidden but kept for functionality)
        const downloadBtn = document.getElementById('cq-speaking-downloadBtn');
        if (downloadBtn && blob) {
          downloadBtn.style.display = 'none';
          downloadBtn.onclick = function() {
            const url = URL.createObjectURL(blob);
            const filename = `CertQuest_Response_${Date.now()}.webm`;
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, 100);
          };
        }

        isRecording = false;
        
        // Show submit button after recording stops
        const submitBtn = document.getElementById('cq-speaking-submitBtn');
        if (submitBtn && cqSpeakingRecordedChunks.length > 0) {
          submitBtn.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Response';
        }
      }, 1000); // Increased timeout to wait for final data chunks
    };
    
    cqSpeakingMediaRecorder.onerror = (event) => {
      console.error("MediaRecorder error:", event.error);
      console.error("MediaRecorder state:", cqSpeakingMediaRecorder.state);
      alert("Recording error: " + (event.error?.message || "Unknown error. Recording may have stopped unexpectedly."));
      isRecording = false;
      
      // Update UI
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      // Hide recording indicator
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
    };
    
    // Add listener for when recording stops unexpectedly
    cqSpeakingMediaRecorder.onpause = () => {
      console.warn(" MediaRecorder paused unexpectedly");
      if (isRecording) {
        console.warn(" Recording was paused while still marked as recording");
        alert("Recording was paused unexpectedly. This may indicate a browser or system issue.");
      }
    };
    
    // Monitor recording state to catch unexpected stops
    // Use global variable so we can clear it from stopRecording
    cqSpeakingMediaRecorder.addEventListener('start', () => {
      console.log(" MediaRecorder start event fired");
      // Reset intentional stop flag
      isIntentionallyStopping = false;
      
      // Clear any existing check
      if (recordingStateMonitor) {
        clearInterval(recordingStateMonitor);
        recordingStateMonitor = null;
      }
      
      // Periodically check that recording is still active
      recordingStateMonitor = setInterval(() => {
        // Skip check if we're intentionally stopping
        if (isIntentionallyStopping) {
          console.log(" Skipping state check - intentional stop in progress");
          return;
        }
        
        if (cqSpeakingMediaRecorder && isRecording) {
          const state = cqSpeakingMediaRecorder.state;
          if (state === 'recording') {
            console.log(" Recording still active, state:", state, "chunks:", cqSpeakingRecordedChunks.length);
          } else if (state === 'inactive' || state === 'paused') {
            // Only alert if this wasn't an intentional stop
            if (!isIntentionallyStopping) {
              console.error(" Recording stopped unexpectedly! State:", state);
              clearInterval(recordingStateMonitor);
              recordingStateMonitor = null;
              isRecording = false;
              const recordBtn = document.getElementById('cq-speaking-recordBtn');
              if (recordBtn) {
                recordBtn.classList.remove('recording');
              }
              
              // Hide recording indicator
              const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
              if (recordingIndicator) {
                recordingIndicator.classList.remove('active');
              }
              
              alert(" Recording stopped unexpectedly. State: " + state + ". This may be a browser or system issue. Please try again.");
            } else {
              console.log(" Recording stopped intentionally - no alert needed");
              clearInterval(recordingStateMonitor);
              recordingStateMonitor = null;
            }
          }
        } else if (!isRecording && !isIntentionallyStopping) {
          // Recording was stopped but not intentionally (shouldn't happen, but clear monitor)
          console.log(" Recording stopped but isRecording flag is false and not intentional");
          clearInterval(recordingStateMonitor);
          recordingStateMonitor = null;
        }
      }, 1000); // Check every second
    });
    
    // Don't start recording automatically - wait for user to click record button
    // The record button will call start() when clicked
  }

  // Global variables are now initialized at the top of the script tag
  
  function stopRecording() {
    console.log(" stopRecording() called - user intentionally stopping");
    
    if (!cqSpeakingMediaRecorder || !isRecording) {
      console.log("Cannot stop: no recorder or not recording");
      return;
    }
    
    // Set flag to indicate this is an intentional stop
    isIntentionallyStopping = true;
    
    // Clear the state monitor immediately
    if (recordingStateMonitor) {
      clearInterval(recordingStateMonitor);
      recordingStateMonitor = null;
      console.log(" State monitor cleared");
    }
    
    console.log("Stopping recording, current state:", cqSpeakingMediaRecorder.state);
    console.log("Chunks before stop:", cqSpeakingRecordedChunks.length);
    
    // Set flag first to prevent re-entry
    isRecording = false;
    
    // Request final data before stopping to ensure we capture everything
    if (cqSpeakingMediaRecorder.state === 'recording') {
      try {
        cqSpeakingMediaRecorder.requestData();
        console.log("Requested final data before stop");
        // Give a small delay to allow the dataavailable event to fire
        setTimeout(() => {
          try {
            cqSpeakingMediaRecorder.stop();
            console.log(" Recorder stopped after requesting data");
          } catch (e) {
            console.error("Error stopping recorder:", e);
          }
        }, 100);
        // Update UI immediately
        const recordBtn = document.getElementById('cq-speaking-recordBtn');
        if (recordBtn) {
          recordBtn.classList.remove('recording');
        }
        
        // Hide recording indicator
        const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
        if (recordingIndicator) {
          recordingIndicator.classList.remove('active');
        }
        
        return; // Exit early, stop will happen in setTimeout
      } catch (e) {
        console.error("Error requesting final data:", e);
      }
    }
    
    // Stop the recorder if we didn't already schedule it
    try {
      cqSpeakingMediaRecorder.stop();
      console.log(" Recorder stopped, new state:", cqSpeakingMediaRecorder.state);
    } catch (e) {
      console.error("Error stopping recorder:", e);
    }
    
    // Update record button state
    const recordBtn = document.getElementById('cq-speaking-recordBtn');
    if (recordBtn) {
      recordBtn.classList.remove('recording');
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    // Hide stop button
    const stopBtn = document.getElementById('cq-speaking-stopBtn');
    if (stopBtn) {
      stopBtn.style.display = 'none';
    }
    
    console.log("Chunks after stop:", cqSpeakingRecordedChunks.length);
  }

  function openSpeakingAssignmentModal(assignment) {
    // Ensure assignment ID is set
    if (assignment && assignment.id) {
      window.latestAssignmentId = assignment.id;
      window.currentAssignment = assignment;
      console.log("Set assignment ID:", assignment.id);
    }
    
    // Set the modal title
    document.getElementById('cq-speaking-title').textContent = "Speaking Assessment";
    
    // Set assignment questions
    if (window.currentAssignmentQuestions) {
      document.getElementById('cq-speaking-q1').textContent = window.currentAssignmentQuestions.q1;
      document.getElementById('cq-speaking-q2').textContent = window.currentAssignmentQuestions.q2;
    } else if (assignment.questions) {
      document.getElementById('cq-speaking-q1').textContent = assignment.questions[0] || "No question provided";
      document.getElementById('cq-speaking-q2').textContent = assignment.questions[1] || "No question provided";
    }
    
    // Create star field
    const starsContainer = document.getElementById('cq-speaking-stars');
    if (starsContainer) {
      starsContainer.innerHTML = '';
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.className = 'cq-speaking-star';
        star.style.top = Math.random() * 100 + '%';
        star.style.left = Math.random() * 100 + '%';
        const size = Math.random() * 2 + 0.5;
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.opacity = Math.random() * 0.7 + 0.3;
        star.style.animationDuration = (Math.random() * 3 + 2) + 's';
        starsContainer.appendChild(star);
      }
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    // Show the modal
    const modal = document.getElementById('cq-speaking-modal');
    if (modal) {
      modal.style.display = 'flex';
    }
    
    // Initialize video preview (but don't start recording yet)
    setTimeout(() => {
      initializeVideoPreview();
    }, 100);
  }

  async function initializeVideoPreview() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: {
          width: { min: 640, ideal: 1280, max: 1920 },
          height: { min: 480, ideal: 720, max: 1080 },
          frameRate: { min: 15, ideal: 30, max: 60 }
        }, 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          sampleRate: 44100
        }
      });
      
      const videoElement = document.getElementById('cq-speaking-videoPreview');
      const noVideoView = document.getElementById('cq-speaking-noVideoView');
      
      if (videoElement) {
        videoElement.srcObject = stream;
        videoElement.muted = true;
        videoElement.autoplay = true;
        videoElement.playsInline = true;
        videoElement.style.display = 'block';
        if (noVideoView) noVideoView.style.display = 'none';
        
        // Store stream for later use
        cqSpeakingMediaStream = stream;
        
        // Set up recorder but don't start it yet
        setupRecordingFromStream(stream);
        
        videoElement.addEventListener('loadedmetadata', () => {
          videoElement.play().catch(e => {
            console.error("Error playing video preview:", e);
          });
        });
      }
    } catch (error) {
      console.error('Error initializing video preview:', error);
      const noVideoView = document.getElementById('cq-speaking-noVideoView');
      if (noVideoView) {
        noVideoView.style.display = 'flex';
      }
    }
  }

  // Toggle recording function for the record button
  function toggleSpeakingRecording() {
    const recordBtn = document.getElementById('cq-speaking-recordBtn');
    if (!recordBtn) return;
    
    if (isRecording) {
      // Stop recording
      console.log("Stopping recording via toggle button");
      stopRecording();
    } else {
      // Start recording
      console.log("Starting recording via toggle button");
      
      // If we have a ready recorder, start it
      if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
        cqSpeakingRecordedChunks = [];
        console.log("Starting existing recorder");
        try {
          //  KEY FIX: Set isRecording = true BEFORE calling start()
          isRecording = true;
          recordBtn.classList.add('recording');
          
          // Show recording indicator
          const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
          if (recordingIndicator) {
            recordingIndicator.classList.add('active');
          }
          
          cqSpeakingMediaRecorder.start();
          console.log(" Recording started successfully, state:", cqSpeakingMediaRecorder.state);
          console.log(" Recording will continue until you click stop - no auto-stop");
          
          // Verify the recorder is actually recording
          setTimeout(() => {
            if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'recording' && isRecording) {
              console.log(" Recording still active after 2 seconds - good!");
            } else {
              console.error(" Recording stopped unexpectedly! State:", cqSpeakingMediaRecorder?.state, "isRecording:", isRecording);
              alert("Recording stopped unexpectedly. Please check browser console for errors.");
            }
          }, 2000);
        } catch (e) {
          console.error("Error starting recorder:", e);
          alert("Error starting recording: " + e.message);
          isRecording = false;
        }
      } else if (cqSpeakingMediaStream && !cqSpeakingMediaRecorder) {
        // If we have a stream but no recorder, set it up
        console.log("Setting up recorder from existing stream");
        setupRecordingFromStream(cqSpeakingMediaStream);
        // Wait a moment for recorder to be created, then start
        setTimeout(() => {
          if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
            cqSpeakingRecordedChunks = [];
            try {
              //  KEY FIX: Set isRecording = true BEFORE calling start()
              isRecording = true;
              recordBtn.classList.add('recording');
              
              // Show recording indicator
              const recordingIndicator2 = document.getElementById('cq-speaking-recordingIndicator');
              if (recordingIndicator2) {
                recordingIndicator2.classList.add('active');
              }
              
              cqSpeakingMediaRecorder.start();
              console.log(" Recording started after setup, state:", cqSpeakingMediaRecorder.state);
              console.log(" Recording will continue until you click stop - no auto-stop");
              
              // Verify the recorder is actually recording
              setTimeout(() => {
                if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'recording' && isRecording) {
                  console.log(" Recording still active after 2 seconds - good!");
                } else {
                  console.error(" Recording stopped unexpectedly! State:", cqSpeakingMediaRecorder?.state, "isRecording:", isRecording);
                  alert("Recording stopped unexpectedly. Please check browser console for errors.");
                }
              }, 2000);
            } catch (e) {
              console.error("Error starting recorder after setup:", e);
              alert("Error starting recording: " + e.message);
              isRecording = false;
            }
          } else {
            console.error("Recorder not ready after setup");
          }
        }, 200);
      } else if (!cqSpeakingMediaStream) {
        // Need to get stream first
        console.log("Getting new stream and starting recording");
        startVideoRecording();
      } else {
        console.error("Cannot start recording: recorder state is", cqSpeakingMediaRecorder.state);
        alert("Recording is already in progress or not ready. Please wait.");
      }
    }
  }
  
  window.toggleSpeakingRecording = toggleSpeakingRecording;

  function closeSpeakingAssignmentModal() {
    document.getElementById('cq-speaking-downloadBtn').style.display = 'none';

    // Stop any active recordings
    cqSpeakingStopAllMedia();
    
    // Hide modal
    document.getElementById('cq-speaking-modal').style.display = 'none';
    
    // Mark as seen (if assignment exists)
    if (window.latestAssignmentId) {
      db.collection('assignments').doc(window.latestAssignmentId)
        .update({ status: "complete" })
        .then(() => {
          window.latestAssignmentId = null;
          window.currentAssignment = null;
        })
        .catch(error => {
          console.error("Error updating assignment status:", error);
        });
    }
  }

  // ========== CASE STUDY MODAL FUNCTIONS ==========
  // Initialize recording variables for case study
  let cqCaseStudyIsRecording = false;
  let cqCaseStudyIsIntentionallyStopping = false;
  let cqCaseStudyRecordingStateMonitor = null;
  let cqCaseStudyMediaRecorder = null;
  let cqCaseStudyMediaStream = null;
  let cqCaseStudyRecordedChunks = [];
  let cqCaseStudyTimerInterval = null;
  let cqCaseStudyTimeLeft = 1200; // 20 minutes in seconds
  let cqCaseStudyTimerActive = false;

  // Helper function to convert blob to base64
  async function cqCaseStudyBlobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  // Timer functions
  function toggleCaseStudyTimer() {
    cqCaseStudyTimerActive = !cqCaseStudyTimerActive;
    const timerEl = document.getElementById('cq-case-study-timer');
    const timerDot = document.getElementById('cq-case-study-timer-dot');
    const timerText = document.getElementById('cq-case-study-timer-text');
    const timerStart = document.getElementById('cq-case-study-timer-start');
    
    if (cqCaseStudyTimerActive) {
      timerEl.classList.add('active');
      if (timerStart) timerStart.style.display = 'none';
      
      // Start countdown
      cqCaseStudyTimerInterval = setInterval(() => {
        if (cqCaseStudyTimeLeft > 0) {
          cqCaseStudyTimeLeft--;
          if (timerText) {
            const mins = Math.floor(cqCaseStudyTimeLeft / 60);
            const secs = cqCaseStudyTimeLeft % 60;
            timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          }
        } else {
          cqCaseStudyTimerActive = false;
          if (timerEl) timerEl.classList.remove('active');
          if (timerStart) timerStart.style.display = 'inline';
          if (cqCaseStudyTimerInterval) {
            clearInterval(cqCaseStudyTimerInterval);
            cqCaseStudyTimerInterval = null;
          }
          alert('Time is up!');
        }
      }, 1000);
    } else {
      timerEl.classList.remove('active');
      if (timerStart) timerStart.style.display = 'inline';
      if (cqCaseStudyTimerInterval) {
        clearInterval(cqCaseStudyTimerInterval);
        cqCaseStudyTimerInterval = null;
      }
    }
  }
  window.toggleCaseStudyTimer = toggleCaseStudyTimer;

  // Expand/collapse content
  function expandCaseStudyContent() {
    document.getElementById('cq-case-study-top-info').style.display = 'none';
    document.getElementById('cq-case-study-video-container').style.display = 'none';
    document.getElementById('cq-case-study-bottom-info').style.display = 'none';
    document.getElementById('cq-case-study-controls-wrapper').style.display = 'none';
    document.getElementById('cq-case-study-expanded-content').style.display = 'flex';
  }
  window.expandCaseStudyContent = expandCaseStudyContent;

  function collapseCaseStudyContent() {
    document.getElementById('cq-case-study-top-info').style.display = 'grid';
    document.getElementById('cq-case-study-video-container').style.display = 'flex';
    document.getElementById('cq-case-study-bottom-info').style.display = 'grid';
    document.getElementById('cq-case-study-controls-wrapper').style.display = 'flex';
    document.getElementById('cq-case-study-expanded-content').style.display = 'none';
  }
  window.collapseCaseStudyContent = collapseCaseStudyContent;

  // Open case study modal
  function openCaseStudyModal(assignment) {
    // Ensure assignment ID is set
    if (assignment && assignment.id) {
      window.latestAssignmentId = assignment.id;
      window.currentAssignment = assignment;
      console.log("Set assignment ID:", assignment.id);
    }
    
    // Set the modal title
    document.getElementById('cq-case-study-title').textContent = "Case Study";
    
    // Set case name
    const caseName = assignment.title || "Case Study";
    document.getElementById('cq-case-study-name').textContent = caseName;
    document.getElementById('cq-case-study-expanded-title').textContent = caseName;
    
    // Set case study content
    const caseContent = assignment.description || assignment.caseStudyContent || "No case study content provided.";
    const previewText = caseContent.substring(0, 100) + (caseContent.length > 100 ? '...' : '');
    document.getElementById('cq-case-study-content-preview-text').textContent = previewText;
    document.getElementById('cq-case-study-full-content').textContent = caseContent;
    
    // Set assignment questions
    if (assignment.questions && assignment.questions.length > 0) {
      document.getElementById('cq-case-study-q1').textContent = assignment.questions[0] || "No question provided";
      if (assignment.questions.length > 1) {
        document.getElementById('cq-case-study-q2').textContent = assignment.questions[1] || "No question provided";
      }
    }
    
    // Reset timer to 20 minutes
    cqCaseStudyTimeLeft = 1200; // Always 20 minutes (1200 seconds)
    const timerText = document.getElementById('cq-case-study-timer-text');
    if (timerText) {
      const mins = Math.floor(cqCaseStudyTimeLeft / 60);
      const secs = cqCaseStudyTimeLeft % 60;
      timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    cqCaseStudyTimerActive = false;
    const timerEl = document.getElementById('cq-case-study-timer');
    if (timerEl) timerEl.classList.remove('active');
    
    // Create star field
    const starsContainer = document.getElementById('cq-case-study-stars');
    if (starsContainer) {
      starsContainer.innerHTML = '';
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.className = 'cq-case-study-star';
        star.style.top = Math.random() * 100 + '%';
        star.style.left = Math.random() * 100 + '%';
        const size = Math.random() * 2 + 0.5;
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.opacity = Math.random() * 0.7 + 0.3;
        star.style.animationDuration = (Math.random() * 3 + 2) + 's';
        starsContainer.appendChild(star);
      }
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    // Reset UI state
    collapseCaseStudyContent();
    document.getElementById('cq-case-study-submitBtn').style.display = 'none';
    document.getElementById('cq-case-study-downloadBtn').style.display = 'none';
    
    // Show the modal
    const modal = document.getElementById('cq-case-study-modal');
    if (modal) {
      modal.style.display = 'flex';
    }
    
    // Initialize video preview (but don't start recording yet)
    setTimeout(() => {
      cqCaseStudyInitializeVideoPreview();
    }, 100);
  }
  window.openCaseStudyModal = openCaseStudyModal;

  // Close case study modal
  function closeCaseStudyModal() {
    // Stop timer
    if (cqCaseStudyTimerInterval) {
      clearInterval(cqCaseStudyTimerInterval);
      cqCaseStudyTimerInterval = null;
    }
    cqCaseStudyTimerActive = false;
    
    // Stop all media
    cqCaseStudyStopAllMedia();
    
    // Hide modal
    const modal = document.getElementById('cq-case-study-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  window.closeCaseStudyModal = closeCaseStudyModal;

  // Initialize video preview
  async function cqCaseStudyInitializeVideoPreview() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: {
          width: { min: 640, ideal: 1280, max: 1920 },
          height: { min: 480, ideal: 720, max: 1080 },
          frameRate: { min: 15, ideal: 30, max: 60 }
        }, 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          sampleRate: 44100
        }
      });
      
      const videoElement = document.getElementById('cq-case-study-videoPreview');
      const noVideoView = document.getElementById('cq-case-study-noVideoView');
      
      if (videoElement) {
        videoElement.srcObject = stream;
        videoElement.muted = true;
        videoElement.autoplay = true;
        videoElement.playsInline = true;
        videoElement.style.display = 'block';
        if (noVideoView) noVideoView.style.display = 'none';
        
        // Store stream for later use
        cqCaseStudyMediaStream = stream;
        
        // Set up recorder but don't start it yet
        cqCaseStudySetupRecordingFromStream(stream);
        
        videoElement.addEventListener('loadedmetadata', () => {
          videoElement.play().catch(e => {
            console.error("Error playing video preview:", e);
          });
        });
      }
    } catch (error) {
      console.error('Error initializing video preview:', error);
      const noVideoView = document.getElementById('cq-case-study-noVideoView');
      if (noVideoView) {
        noVideoView.style.display = 'flex';
      }
    }
  }

  // Setup recording from stream
  function cqCaseStudySetupRecordingFromStream(stream) {
    const videoElement = document.getElementById('cq-case-study-videoPreview');
    if (!videoElement) {
      console.error("Video preview element not found in DOM");
      return;
    }
    
    // Set up MediaRecorder with best available format
    let options = {};
    if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
      options.mimeType = 'video/webm;codecs=vp9';
    } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
      options.mimeType = 'video/webm;codecs=vp8';
    } else if (MediaRecorder.isTypeSupported('video/webm')) {
      options.mimeType = 'video/webm';
    } else if (MediaRecorder.isTypeSupported('video/mp4')) {
      options.mimeType = 'video/mp4';
    }
    
    cqCaseStudyMediaRecorder = new MediaRecorder(stream, options);
    console.log("Case Study MediaRecorder created with mimeType:", cqCaseStudyMediaRecorder.mimeType);
    
    cqCaseStudyMediaRecorder.ondataavailable = (event) => {
      console.log("Case Study video data available:", event.data.size, "bytes");
      if (event.data.size > 0) {
        cqCaseStudyRecordedChunks.push(event.data);
        console.log("Added chunk, total chunks:", cqCaseStudyRecordedChunks.length, "total size:", cqCaseStudyRecordedChunks.reduce((sum, chunk) => sum + chunk.size, 0), "bytes");
      }
    };
    
    cqCaseStudyMediaRecorder.onstop = () => {
      console.log("Case Study video recording stopped, processing...");
      console.log("Total chunks collected:", cqCaseStudyRecordedChunks.length);
      
      if (cqCaseStudyRecordedChunks.length === 0) {
        console.error("No video data recorded");
        alert("No video data was recorded. Please try again.");
        return;
      }
      
      const mimeType = cqCaseStudyMediaRecorder.mimeType || 'video/webm';
      const blob = new Blob(cqCaseStudyRecordedChunks, { type: mimeType });
      console.log("Created video blob:", blob.size, "bytes, type:", blob.type);

      const videoURL = URL.createObjectURL(blob);
      const videoElement = document.getElementById('cq-case-study-videoPreview');
      const noVideoView = document.getElementById('cq-case-study-noVideoView');
      if (videoElement) {
        videoElement.srcObject = null;
        videoElement.src = videoURL;
        videoElement.controls = true;
        videoElement.muted = false;
        videoElement.style.display = 'block';
        if (noVideoView) noVideoView.style.display = 'none';
        console.log("Video playback element updated");
      }
      
      // Show download button
      const downloadBtn = document.getElementById('cq-case-study-downloadBtn');
      if (downloadBtn && blob) {
        downloadBtn.style.display = 'flex';
        downloadBtn.onclick = function() {
          const url = URL.createObjectURL(blob);
          const filename = `CertQuest_CaseStudy_${Date.now()}.webm`;
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 100);
        };
      }
      
      // Show submit button
      const submitBtn = document.getElementById('cq-case-study-submitBtn');
      if (submitBtn) {
        submitBtn.style.display = 'block';
      }
    };
    
    cqCaseStudyMediaRecorder.onerror = (event) => {
      console.error("Case Study MediaRecorder error:", event.error);
      alert("Recording error: " + event.error.message);
      cqCaseStudyIsRecording = false;
    };
  }

  // Stop all media
  function cqCaseStudyStopAllMedia() {
    if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state !== 'inactive') {
      try {
        cqCaseStudyMediaRecorder.stop();
      } catch (e) {
        console.error("Error stopping recorder:", e);
      }
    }
    
    if (cqCaseStudyMediaStream) {
      cqCaseStudyMediaStream.getTracks().forEach(track => track.stop());
      cqCaseStudyMediaStream = null;
    }
    
    cqCaseStudyMediaRecorder = null;
    cqCaseStudyRecordedChunks = [];
    cqCaseStudyIsRecording = false;
    
    const recordBtn = document.getElementById('cq-case-study-recordBtn');
    if (recordBtn) {
      recordBtn.classList.remove('recording');
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    // Hide download button
    const downloadBtn = document.getElementById('cq-case-study-downloadBtn');
    if (downloadBtn) {
      downloadBtn.style.display = 'none';
    }
  }

  // Toggle recording
  function toggleCaseStudyRecording() {
    const recordBtn = document.getElementById('cq-case-study-recordBtn');
    if (!recordBtn) return;
    
    if (cqCaseStudyIsRecording) {
      // Stop recording
      console.log("Stopping case study recording via toggle button");
      cqCaseStudyStopRecording();
    } else {
      // Start recording
      console.log("Starting case study recording via toggle button");
      if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
        cqCaseStudyRecordedChunks = [];
        try {
          cqCaseStudyIsRecording = true;
          recordBtn.classList.add('recording');
          
          // Show recording indicator
          const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
          if (recordingIndicator) {
            recordingIndicator.classList.add('active');
          }
          
          cqCaseStudyMediaRecorder.start();
          console.log(" Case Study recording started successfully, state:", cqCaseStudyMediaRecorder.state);
        } catch (e) {
          console.error("Error starting recorder:", e);
          alert("Error starting recording: " + e.message);
          cqCaseStudyIsRecording = false;
        }
      } else if (cqCaseStudyMediaStream && !cqCaseStudyMediaRecorder) {
        cqCaseStudySetupRecordingFromStream(cqCaseStudyMediaStream);
        setTimeout(() => {
          if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
            cqCaseStudyRecordedChunks = [];
            try {
              cqCaseStudyIsRecording = true;
              recordBtn.classList.add('recording');
              
              // Show recording indicator
              const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
              if (recordingIndicator) {
                recordingIndicator.classList.add('active');
              }
              
              cqCaseStudyMediaRecorder.start();
              console.log(" Case Study recording started after setup, state:", cqCaseStudyMediaRecorder.state);
            } catch (e) {
              console.error("Error starting recorder after setup:", e);
              alert("Error starting recording: " + e.message);
              cqCaseStudyIsRecording = false;
            }
          }
        }, 200);
      } else if (!cqCaseStudyMediaStream) {
        cqCaseStudyInitializeVideoPreview();
      } else {
        alert("Recording is already in progress or not ready. Please wait.");
      }
    }
  }
  window.toggleCaseStudyRecording = toggleCaseStudyRecording;

  // Stop recording
  function cqCaseStudyStopRecording() {
    if (!cqCaseStudyMediaRecorder || !cqCaseStudyIsRecording) {
      console.log("Cannot stop: no recorder or not recording");
      return;
    }
    
    cqCaseStudyIsIntentionallyStopping = true;
    
    console.log("Stopping case study recording, current state:", cqCaseStudyMediaRecorder.state);
    
    cqCaseStudyIsRecording = false;
    
    if (cqCaseStudyMediaRecorder.state === 'recording') {
      try {
        cqCaseStudyMediaRecorder.requestData();
        cqCaseStudyMediaRecorder.stop();
      } catch (e) {
        console.error("Error stopping recorder:", e);
      }
    }
    
    const recordBtn = document.getElementById('cq-case-study-recordBtn');
    if (recordBtn) {
      recordBtn.classList.remove('recording');
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    cqCaseStudyIsIntentionallyStopping = false;
  }

  // Submit case study response (same logic as speaking assignments)
  async function submitCaseStudyResponse() {
    if (!window.latestAssignmentId || cqCaseStudyRecordedChunks.length === 0) {
      alert("Recording not found or assignment ID missing.");
      return;
    }

    // Update submit button state
    const submitBtn = document.getElementById('cq-case-study-submitBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
    }

    const blob = new Blob(cqCaseStudyRecordedChunks, { type: 'video/webm' });
    const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

    const GITHUB_USERNAME = "Anjay209";
    const GITHUB_REPO = "video-storage";
    const GITHUB_TOKEN = "REDACTED_TOKEN";

    let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
    let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

    try {
      const base64 = await cqCaseStudyBlobToBase64(blob);

      const uploadRes = await fetch(githubApiUrl, {
        method: 'PUT',
        headers: {
          Authorization: `Bearer ${GITHUB_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Upload ${filename}`,
          content: base64,
          branch: 'main'
        })
      });

      if (!uploadRes.ok) {
        const errData = await uploadRes.json().catch(() => ({}));
        const errorMessage = errData?.message || "GitHub upload failed";
        
        if (uploadRes.status === 409) {
          // Handle conflict - try to update
          try {
            const getRes = await fetch(githubApiUrl, {
              headers: {
                Authorization: `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (getRes.ok) {
              const existingFile = await getRes.json();
              const updateRes = await fetch(githubApiUrl, {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Update ${filename}`,
                  content: base64,
                  branch: 'main',
                  sha: existingFile.sha
                })
              });
              
              if (!updateRes.ok) {
                throw new Error("Failed to update existing file");
              }
            } else {
              throw new Error("Could not get existing file info");
            }
          } catch (updateError) {
            const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
            const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
            const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
            
            const retryRes = await fetch(uniqueGithubApiUrl, {
              method: 'PUT',
              headers: {
                Authorization: `Bearer ${GITHUB_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Upload ${uniqueFilename}`,
                content: base64,
                branch: 'main'
              })
            });
            
            if (!retryRes.ok) {
              throw new Error("Failed to upload with unique filename");
            }
            
            githubPagesUrl = uniqueGithubPagesUrl;
          }
        } else {
          throw new Error(errorMessage);
        }
      }

      // Firestore update
      await firebase.firestore()
        .collection('assignments')
        .doc(window.latestAssignmentId)
        .update({
          status: "complete",
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          recordingUrl: githubPagesUrl
        });

      // Update user's assignments collection
      const user = firebase.auth().currentUser;
      const userId = user?.uid;
      const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
      
      if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
        try {
          await firebase.firestore()
            .collection('users')
            .doc(userId)
            .collection('assignments')
            .doc(assignmentId)
            .set({
              status: "complete",
              completedAt: firebase.firestore.FieldValue.serverTimestamp(),
              recordingUrl: githubPagesUrl
            }, { merge: true });
        } catch (userUpdateError) {
          console.error("Error updating user assignments:", userUpdateError);
        }
      }

      // Fetch assignment data to get competencies
      let competencies = [];
      let assignmentName = 'Case Study';
      try {
        const assignmentDoc = await firebase.firestore()
          .collection('assignments')
          .doc(window.latestAssignmentId)
          .get();
        
        if (assignmentDoc.exists) {
          const assignmentData = assignmentDoc.data();
          competencies = assignmentData.competencies || [];
          assignmentName = assignmentData.title || 'Case Study';
        }
      } catch (error) {
        console.error("Error fetching assignment data:", error);
      }

      // Show success message and congrats modal
      showCongratsModal({ 
        score: undefined, 
        totalQuestions: undefined,
        assignmentName: assignmentName,
        competencies: competencies,
        assignmentType: 'case'
      });
      
      // Close modal
      closeCaseStudyModal();
    } catch (error) {
      console.error("Upload Error:", error);
      alert("Upload Error: " + error.message);
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Case Study';
      }
    }
  }
  window.submitCaseStudyResponse = submitCaseStudyResponse;

  async function submitSpeakingResponse() {
    if (!window.latestAssignmentId || cqSpeakingRecordedChunks.length === 0) {
      alert("Recording not found or assignment ID missing.");
      return;
    }

    // Update submit button state
    const submitBtn = document.getElementById('cq-speaking-submitBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
    }

    const blob = new Blob(cqSpeakingRecordedChunks, { type: 'video/webm' });
    const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

    const GITHUB_USERNAME = "Anjay209";
    const GITHUB_REPO = "video-storage";
    const GITHUB_TOKEN = "REDACTED_TOKEN"; //  Rotate in production

    let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
    let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

    try {
      const base64 = await blobToBase64(blob);

      const uploadRes = await fetch(githubApiUrl, {
        method: 'PUT',
        headers: {
          Authorization: `Bearer ${GITHUB_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Upload ${filename}`,
          content: base64,
          branch: 'main'
        })
      });

      if (!uploadRes.ok) {
        const errData = await uploadRes.json().catch(() => ({}));
        const errorMessage = errData?.message || "GitHub upload failed";
        
        // Handle 409 Conflict - file already exists, try to update it
        if (uploadRes.status === 409) {
          console.log("File exists, attempting to update with SHA...");
          try {
            // Get the existing file's SHA
            const getRes = await fetch(githubApiUrl, {
              headers: {
                Authorization: `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (getRes.ok) {
              const existingFile = await getRes.json();
              // Update with SHA
              const updateRes = await fetch(githubApiUrl, {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Update ${filename}`,
                  content: base64,
                  branch: 'main',
                  sha: existingFile.sha
                })
              });
              
              if (!updateRes.ok) {
                throw new Error("Failed to update existing file: " + (await updateRes.json().catch(() => ({}))).message);
              }
              console.log("Successfully updated existing file");
            } else {
              throw new Error("Could not get existing file info: " + errorMessage);
            }
          } catch (updateError) {
            // If update fails, use a unique filename
            console.log("Update failed, using unique filename...");
            const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
            const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
            const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
            
            const retryRes = await fetch(uniqueGithubApiUrl, {
              method: 'PUT',
              headers: {
                Authorization: `Bearer ${GITHUB_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Upload ${uniqueFilename}`,
                content: base64,
                branch: 'main'
              })
            });
            
            if (!retryRes.ok) {
              throw new Error("Failed to upload with unique filename: " + (await retryRes.json().catch(() => ({}))).message);
            }
            
            // Update the URL to use the unique filename
            githubPagesUrl = uniqueGithubPagesUrl;
            console.log("Successfully uploaded with unique filename");
          }
        } else if (uploadRes.ok) {
          // Upload was successful (either first try or after conflict resolution)
          console.log("Successfully uploaded to GitHub");
        } else {
          // Check for authentication errors
          if (uploadRes.status === 401 || errorMessage.includes("Bad credentials") || errorMessage.includes("401")) {
            throw new Error("GitHub authentication failed. The token may be expired. Please contact the administrator to update the GitHub token.");
          }
          
          // Check for permission errors
          if (uploadRes.status === 403 || errorMessage.includes("Resource not accessible") || errorMessage.includes("403")) {
            throw new Error("GitHub permission denied. The token doesn't have write access to the repository. Please ensure the token has 'repo' scope and access to the 'Anjay209/video-storage' repository.");
          }
          
          throw new Error(errorMessage);
        }
      }

      // Firestore update - setting status to "complete" in assignments collection
      await firebase.firestore()
        .collection('assignments')
        .doc(window.latestAssignmentId)
        .update({
          status: "complete",
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          recordingUrl: githubPagesUrl
        });

      //  Also update user's assignments collection (like home.html does)
      const user = firebase.auth().currentUser;
      const userId = user?.uid;
      const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
      
      // Only update if we have both userId and assignmentId (non-empty and valid)
      if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
        console.log("Updating user assignments collection:", userId, assignmentId);
        try {
          // Use set with merge: true instead of update, in case document doesn't exist
          await firebase.firestore()
            .collection('users')
            .doc(userId)
            .collection('assignments')
            .doc(assignmentId)
            .set({
              status: 'completed',
              submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
              fileUrl: githubPagesUrl,
              fileType: 'video',
            }, { merge: true });
          console.log("Successfully updated user assignments collection");
        } catch (userAssignError) {
          console.warn("Could not update user assignments collection (non-critical):", userAssignError);
          // Don't throw - this is optional, the main assignment update already succeeded
        }
      } else {
        console.warn("Skipping user assignments update - missing userId or assignmentId", { userId, assignmentId });
      }

      // Show congrats modal
      if (typeof showCongratsModal === 'function') {
        showCongratsModal({
          message: "Assignment submitted successfully!",
          assignmentName: window.currentAssignment?.title || "Assignment"
        });
      }

      // Close the modal after submission
      closeSpeakingAssignmentModal();

    } catch (err) {
      console.error("Upload Error:", err);
      const errorMessage = err.message || "Something went wrong while uploading your recording.";
      
      // Suppress alert for empty path error (non-critical, assignment still submitted)
      if (errorMessage.includes("cannot be called with an empty path") || errorMessage.includes("empty path")) {
        console.log("Suppressed empty path error - assignment was still submitted successfully");
        // Don't show alert, just log it
        return;
      }
      
      // Show more helpful error message
      if (errorMessage.includes("authentication") || errorMessage.includes("token") || errorMessage.includes("credentials")) {
        alert(" Authentication Error: " + errorMessage + "\n\nPlease contact the administrator to update the GitHub token.");
      } else if (errorMessage.includes("permission") || errorMessage.includes("not accessible") || errorMessage.includes("403")) {
        alert(" Permission Error: " + errorMessage + "\n\nTo fix this:\n1. Go to GitHub  Settings  Developer settings  Personal access tokens\n2. Edit your token and ensure it has 'repo' scope (full control of private repositories)\n3. Make sure the token has access to the 'Anjay209/video-storage' repository");
      } else {
        alert(" Upload Error: " + errorMessage);
      }
      
      // Re-enable submit button on error
      const submitBtn = document.getElementById('cq-speaking-submitBtn');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Response';
      }
    }
  }

  function getQuestionCount(timeStr) {
    if (!timeStr) return 5;
    const normalized = timeStr.toString().toLowerCase();
    if (normalized.includes("15")) return 10;
    if (normalized.includes("10")) return 7;
    if (normalized.includes("5")) return 5;
    return 5;
  }

  async function generatePersonalizedQuestionsWithGPT(formData) {
    const questionCount = getQuestionCount(formData.time);
    const competenciesText = formData.competencies.join(', ');

    let prompt = `Generate ${questionCount} FBLA-style multiple choice questions.
- Difficulty: ${formData.difficulty}
- Competencies to cover: ${competenciesText}
- Each question must have exactly 4 options and 1 correct answer
- Questions must be standalone, realistic for FBLA, and never reference "the document", "the text", "as stated", etc.
- Use business, finance, marketing, management, economics, law, and related topics depending on the competencies.`

    prompt += `\n\nReturn ONLY valid JSON array in format:
[
  {
    "text": "Question text?",
    "competency": "Marketing",
    "correctAnswer": "Correct option text",
    "options": ["A", "B", "C", "D"],
    "difficulty": "${formData.difficulty}",
    "source": "gpt_generated"
  }
]`;

    try {
      const response = await firebase.functions().httpsCallable("generateQuestionsWithAI")({
        messages: [
          { role: "system", content: `You are an expert FBLA written-competition exam designer.

Your role is to generate ORIGINAL, competition-accurate FBLA-style multiple-choice questions that match the structure, rigor, tone, and professional standards of official FBLA written tests.

You must follow ALL rules below.


CORE FBLA PHILOSOPHY

FBLA written tests assess professional correctness, precision, and applied business literacy.

They do NOT assess creativity, opinion, or open-ended reasoning.

Each question must test exactly ONE concept.

Questions must be concise, objective, and professionally worded.

Avoid unnecessary narrative unless the question type explicitly requires a scenario.


APPROVED FBLA QUESTION ARCHETYPES

Every question MUST clearly belong to ONE of the following archetypes:

1. Definition / Term Identification  
   - Identifying the correct term based on a definition  
   - Selecting the correct meaning of a professional word or concept  

2. Classification / Category Recognition  
   - Determining where an item belongs within a professional category system  
   - Examples include document types, account categories, system types, business forms, or classifications  

3. Procedural / Workflow Knowledge  
   - Understanding the stages of a professional workflow specific to the competition area  
   - Identifying where information originates within that workflow  
   - Determining which document, tool, or action is appropriate at a given stage  
   - Recognizing correct sequencing of professional tasks within the domain  

4. Tool-to-Function Matching  
   - Matching software features, commands, utilities, or tools to their correct purpose  
   - Selecting the correct function used to accomplish a professional task  

5. Quantitative / Calculation Application  
   - Performing single-step or limited multi-step calculations  
   - Selecting the correct numeric result based on provided data  
   - Avoid unnecessary complexity or advanced math  

6. Language Precision & Usage  
   - Correct use of professional vocabulary  
   - Distinguishing homophones, word meanings, spelling, grammar, and standard usage  

7. Error Detection / Exception Identification  
   - Identifying what is incorrect, misspelled, or does NOT belong  
   - Using negation ("NOT") carefully and intentionally  


QUESTION STRUCTURE RULES

 Each question must assess ONE idea only.  
 Do not combine multiple concepts in one question.  
 Avoid ambiguous wording.  
 Use professional, neutral language.

Acceptable stem styles include:
- "Which of the following"
- "What term best describes"
- "The document used to"
- "Which action should be taken"
- "Which of the following is NOT"


ANSWER CHOICE DESIGN (CRITICAL)

Each question MUST include exactly FOUR answer choices.

Answer choices must:
 Be the same grammatical form  
 Be similar in length  
 Belong to the same conceptual family  

Wrong answer choices (distractors) must be plausible and realistic.

Allowed distractor strategies include:
 Closely related terms within the same category  
 Common student misconceptions  
 Incorrect step within a workflow  
 Reversed or misapplied professional rules  
 Visually or linguistically similar words  
 Typical calculation or classification errors  

Never include joke answers or obviously incorrect options.


DIFFICULTY CALIBRATION

Easy:
 Direct recall or recognition  
 Minimal traps  

Medium:
 Requires discrimination between similar concepts  
 Includes common misconceptions  

Hard:
 Includes negation ("NOT")  
 Requires precise rule awareness  
 Uses subtle wording differences  
 Penalizes shallow memorization  


CONTENT INTEGRITY RULES

 All questions must be ORIGINAL.  
 Do NOT copy real FBLA questions.  
 Do NOT closely paraphrase known questions.  
 Use authentic structure only, not replicated wording.

Questions must feel realistic for competitive FBLA written events at the regional, state, or national level.

When study materials are provided, extract concepts, facts, names, dates, laws, and details from them. Present this information as established business knowledge. NEVER mention "the study guide", "the document", "the material", or use phrases like "according to", "as stated in", or "mentioned in".


OUTPUT REQUIREMENTS

 Generate ONLY the requested number of questions.  
 Each question must have exactly four answer options.  
 Only ONE option may be correct.  
 Output valid JSON only.  
 Do not include explanations, commentary, or headings.  

You are writing as a professional exam author  not as a tutor or teacher.` },
          { role: "user", content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt }
        ]
      });

      const data = response.data;
      let content = data.content || data.choices?.[0]?.message?.content || data;
      
      if (typeof content !== 'string') {
        content = JSON.stringify(content);
      }
      
      content = content.trim();
      content = content.replace(/```json|```/g, "");
      const jsonStart = content.indexOf('[');
      const jsonEnd = content.lastIndexOf(']') + 1;
      
      if (jsonStart !== -1 && jsonEnd > jsonStart) {
        content = content.slice(jsonStart, jsonEnd);
      }
      
      const generated = JSON.parse(content);
      console.log(` Generated ${generated.length} GPT questions`);
      return generated;

    } catch (err) {
      console.error(" GPT error:", err);
      return getFallbackQuestions(questionCount, formData.competencies);
    }
  }

  function getFallbackQuestions(count, competencies) {
    const fallbackQuestions = [
      {
        text: "What is the primary purpose of parliamentary procedure?",
        competency: "Parliamentary Procedure",
        correctAnswer: "To make meetings more efficient",
        options: [
          "To make meetings more efficient",
          "To give the president more power",
          "To eliminate debate",
          "To make meetings longer"
        ]
      },
      {
        text: "Which motion is used to end a meeting?",
        competency: "Parliamentary Procedure",
        correctAnswer: "Adjourn",
        options: ["Adjourn", "Recess", "Postpone", "Table"]
      },
      {
        text: "What is the most effective way to communicate in business?",
        competency: "Business Communication",
        correctAnswer: "Clear and concise messaging",
        options: [
          "Clear and concise messaging",
          "Using complex terminology",
          "Lengthy detailed explanations",
          "Informal casual language"
        ]
      }
    ];
    
    const result = [];
    for (let i = 0; i < count; i++) {
      result.push(fallbackQuestions[i % fallbackQuestions.length]);
    }
    return result;
  }

  async function openWrittenPracticeModal(assignment) {
  console.log(" Opening modal - LOADER STILL VISIBLE");

  try {
    currentQuestionIndex = 0;
    writtenAnswers = {};
    if (!window.writtenAnswers) {
      window.writtenAnswers = {};
    }

    const timeInMinutes = parseInt(assignment.time) || 15;
    writtenTimeRemaining = timeInMinutes * 60;

    if (assignment.generatedQuestions && assignment.generatedQuestions.length > 0) {
      console.log(" Using generated questions WITH BASELINE + TRAINING DATA");
      writtenQuestions = assignment.generatedQuestions;
      window.writtenQuestions = assignment.generatedQuestions;
      window.baselineData = assignment.baselineData || {};
      window.gptContextData = assignment.gptContext || {};
    } else if (window.writtenQuestions && window.writtenQuestions.length > 0) {
      console.log(" Using window.writtenQuestions");
      writtenQuestions = window.writtenQuestions;
    } else {
      console.log(" Generating questions fallback...");
      writtenQuestions = await generatePersonalizedQuestionsWithGPT({
        time: assignment.time || "15 mins",
        difficulty: assignment.difficulty || "Medium",
        competencies: assignment.competencies || ["General"]
      });
      window.writtenQuestions = writtenQuestions;
    }

    // DISPLAY THE MODAL
    const modal = document.getElementById('quizModal');
    modal.style.display = 'flex';
    modal.style.zIndex = '500';
    document.body.style.overflow = 'hidden';
    
    createQuizStars();
    loadWrittenQuestion();
    startWrittenTimer();

    console.log(" Modal fully rendered");
    
    // NOW hide the loader with progress completion
    console.log(" Hiding loader - questions visible");
    hideLoader(); // This will complete the progress to 100% then hide
    console.log(" DONE");

  } catch (err) {
    console.error(" Error:", err);
    hideLoader();
    alert("Could not load written practice. Please try again.");
  }
}

  function loadWrittenQuestion() {
    // Use window.writtenQuestions if available (for "create your own"), otherwise use local writtenQuestions
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    const question = questions[currentQuestionIndex];
    if (!question) {
      console.error("No question found at index", currentQuestionIndex);
      return;
    }
    
    console.log("Loading question", currentQuestionIndex + 1, ":", question.question || question.text);
    
    const assignmentTitle = window.currentAssignment?.title || 'Written Practice';
    const difficulty = window.currentAssignment?.difficulty || 'Easy';
    document.getElementById('quizTitle').textContent = `${difficulty} ${assignmentTitle}`;
    document.getElementById('quizProgress').textContent = 
      `Question ${currentQuestionIndex + 1} of ${questions.length}`;
    
    document.getElementById('questionCompetency').textContent = question.competency || 'General';
    const questionTextEl = document.getElementById('questionText');
    questionTextEl.textContent = question.question || question.text;
    questionTextEl.style.color = '#fff';
    
    const optionsContainer = document.getElementById('optionsContainer');
    const answers = window.writtenAnswers || writtenAnswers;
    const previousAnswer = answers[currentQuestionIndex];
    
    optionsContainer.innerHTML = question.options.map((option, index) => {
      const isSelected = previousAnswer === option;
      return `
        <button class="practice-quiz-option-btn ${isSelected ? 'selected' : ''}" data-option="${option}">
          <div class="practice-quiz-option-radio ${isSelected ? 'selected' : ''}">
            ${isSelected ? '<div class="practice-quiz-option-dot"></div>' : ''}
          </div>
          <span class="practice-quiz-option-text">${option}</span>
        </button>
      `;
    }).join('');
    
    const options = optionsContainer.querySelectorAll('.practice-quiz-option-btn');
    options.forEach(optionBtn => {
      optionBtn.addEventListener('click', function(e) {
        options.forEach(opt => {
          opt.classList.remove("selected");
          const radio = opt.querySelector('.practice-quiz-option-radio');
          radio.classList.remove("selected");
          radio.innerHTML = '';
        });
        
        this.classList.add('selected');
        const radio = this.querySelector('.practice-quiz-option-radio');
        radio.classList.add('selected');
        radio.innerHTML = '<div class="practice-quiz-option-dot"></div>';
        
        // Save to both window.writtenAnswers and local writtenAnswers
        if (window.writtenAnswers) {
          window.writtenAnswers[currentQuestionIndex] = this.dataset.option;
        } else {
          writtenAnswers[currentQuestionIndex] = this.dataset.option;
        }
        console.log("Answer saved:", currentQuestionIndex, "->", this.dataset.option);
      });
    });
    
    updateWrittenProgress();
    updateWrittenNavButtons();
  }

  function updateWrittenProgress() {
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
    document.getElementById('progressFill').style.width = `${progress}%`;
    document.getElementById('progressPercent').textContent = Math.round(progress);
  }

  function updateWrittenNavButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    
    prevBtn.disabled = currentQuestionIndex === 0;
    
    if (currentQuestionIndex === questions.length - 1) {
      nextBtn.style.display = 'none';
      submitBtn.style.display = 'block';
    } else {
      nextBtn.style.display = 'block';
      submitBtn.style.display = 'none';
    }
  }

  function previousQuestion() {
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      loadWrittenQuestion();
    }
  }

  function nextQuestion() {
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    if (currentQuestionIndex < questions.length - 1) {
      currentQuestionIndex++;
      loadWrittenQuestion();
    }
  }

  function startWrittenTimer() {
    clearInterval(writtenTimer);
    
    console.log("Starting timer with", writtenTimeRemaining, "seconds");
    updateTimerDisplay();
    
    writtenTimer = setInterval(() => {
      writtenTimeRemaining--;
      updateTimerDisplay();
      
      if (writtenTimeRemaining <= 0) {
        console.log("Time's up! Auto-submitting...");
        clearInterval(writtenTimer);
        submitQuiz();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const minutes = Math.floor(writtenTimeRemaining / 60);
    const seconds = writtenTimeRemaining % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const timerElement = document.getElementById('quizTimer');
    if (timerElement) {
      timerElement.textContent = timeString;
      
      if (writtenTimeRemaining <= 60) {
        timerElement.style.color = '#ef4444';
      } else if (writtenTimeRemaining <= 300) {
        timerElement.style.color = '#f97316';
      } else {
        timerElement.style.color = '#fb923c';
      }
    }
  }

  function createQuizStars() {
    const starsContainer = document.getElementById('quizStarsContainer');
    if (!starsContainer) return;
    
    starsContainer.innerHTML = '';
    
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'practice-quiz-star';
      
      const size = Math.random() * 3 + 0.5;
      const duration = Math.random() * 4 + 2;
      const delay = Math.random() * 2;
      const randomLeft = Math.random() * 100;
      const randomTop = Math.random() * 100;
      const randomOpacity = Math.random() * 0.9 + 0.3;
      
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = randomLeft + '%';
      star.style.top = randomTop + '%';
      star.style.opacity = randomOpacity;
      star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
      star.style.animationDelay = delay + 's';
      star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
      
      starsContainer.appendChild(star);
    }
  }

  function closeQuizModal() {
    const modal = document.getElementById('quizModal');
    if (modal) {
      modal.style.display = 'none';
    }
    document.body.style.overflow = 'auto';
    clearInterval(writtenTimer);
    writtenQuestions = [];
    currentQuestionIndex = 0;
    writtenAnswers = {};
    writtenTimeRemaining = 0;
    writtenTimer = null;
  }

  async function submitQuiz() {
    // Check if this is a written practice assignment
    const hasWrittenQuestions = (window.writtenQuestions && window.writtenQuestions.length > 0) || 
                                (writtenQuestions && writtenQuestions.length > 0);
    
    if (hasWrittenQuestions) {
      if (window.latestAssignmentId) {
        await submitWrittenPractice();
        return;
      } else {
        await submitWrittenPracticeForCreateYourOwn();
        return;
      }
    }
  }

  async function submitWrittenPractice() {
    try {
      console.log("=== SUBMITTING WRITTEN PRACTICE ===");
      clearInterval(writtenTimer);
      
      if (!window.latestAssignmentId) {
        console.error(" CRITICAL ERROR: No assignment ID found!");
        alert("Error: No assignment ID found. Cannot submit written practice.");
        closeQuizModal();
        return;
      }
      
      const questions = writtenQuestions;
      const answers = writtenAnswers;
      
      let score = 0;
      const competencyStats = {};
      const detailedAnswers = [];
      const totalQuestions = questions.length;
      
      questions.forEach((question, index) => {
        const userAnswer = answers[index];
        const correctAnswer = question.correctAnswer;
        const isCorrect = userAnswer === correctAnswer;
        
        if (isCorrect) score++;
        
        const competency = question.competency;
        if (!competencyStats[competency]) {
          competencyStats[competency] = { total: 0, correct: 0 };
        }
        competencyStats[competency].total++;
        if (isCorrect) competencyStats[competency].correct++;
        
        detailedAnswers.push({
          questionIndex: index,
          question: question.question || question.text,
          competency: competency,
          userAnswer: userAnswer || "No answer",
          correctAnswer: correctAnswer,
          isCorrect: isCorrect
        });
      });
      
      const originalTime = parseInt(window.currentAssignment?.time) * 60 || 900;
      const timeSpent = originalTime - writtenTimeRemaining;
      const percentage = Math.round((score / totalQuestions) * 100);
      
      const updateData = {
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        score: score,
        totalQuestions: totalQuestions,
        maxScore: totalQuestions,
        competencyStats: competencyStats,
        timeSpent: timeSpent,
        detailedAnswers: detailedAnswers,
        competencies: Object.keys(competencyStats),
        correctCompetencies: Object.entries(competencyStats)
          .filter(([_, stats]) => stats.correct === stats.total)
          .map(([comp, _]) => comp),
        percentage: percentage,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
      console.log(" Assignment updated successfully");
      
      const resultsData = {
        message: `Excellent work! You scored ${score}/${totalQuestions}`,
        assignmentName: window.currentAssignment?.title || 'Written Practice',
        competencyStats: competencyStats,
        score: score,
        totalQuestions: totalQuestions,
        percentage: percentage,
        timeSpent: timeSpent
      };
      
      closeQuizModal();
      
      showCongratsModal(resultsData);
      
      window.latestAssignmentId = null;
      window.currentAssignment = null;
      
    } catch (error) {
      console.error(" Written practice submission error:", error);
      alert("Failed to submit practice: " + error.message);
    }
  }

  async function submitWrittenPracticeForCreateYourOwn() {
    try {
      console.log("=== SUBMITTING CREATE YOUR OWN WRITTEN PRACTICE ===");
      clearInterval(writtenTimer);
      
      const questions = window.writtenQuestions || writtenQuestions;
      const answers = window.writtenAnswers || writtenAnswers;
      
      if (!questions || questions.length === 0) {
        console.error(" CRITICAL ERROR: No questions found!");
        alert("Error: No questions found. Cannot submit written practice.");
        closeQuizModal();
        return;
      }
      
      let score = 0;
      const competencyStats = {};
      const detailedAnswers = [];
      const totalQuestions = questions.length;
      
      questions.forEach((question, index) => {
        const userAnswer = answers[index];
        const correctAnswer = question.correctAnswer;
        const isCorrect = userAnswer === correctAnswer;
        
        if (isCorrect) score++;
        
        const competency = question.competency;
        if (!competencyStats[competency]) {
          competencyStats[competency] = { total: 0, correct: 0 };
        }
        competencyStats[competency].total++;
        if (isCorrect) competencyStats[competency].correct++;
        
        detailedAnswers.push({
          questionIndex: index,
          question: question.question || question.text,
          competency: competency,
          userAnswer: userAnswer || "No answer",
          correctAnswer: correctAnswer,
          isCorrect: isCorrect
        });
      });
      
      const timeStr = document.getElementById('quizTitle')?.textContent?.match(/\d+/)?.[0] || '15';
      const originalTime = parseInt(timeStr) * 60 || 900;
      const timeSpent = originalTime - writtenTimeRemaining;
      const percentage = Math.round((score / totalQuestions) * 100);
      
      const resultsData = {
        message: `Excellent work! You scored ${score}/${totalQuestions}`,
        assignmentName: 'Written Practice',
        competencyStats: competencyStats,
        score: score,
        totalQuestions: totalQuestions,
        percentage: percentage,
        timeSpent: timeSpent
      };
      
      closeQuizModal();
      
      showCongratsModal(resultsData);
      
      window.writtenQuestions = null;
      window.writtenAnswers = null;
      
    } catch (error) {
      console.error(" Create your own written practice submission error:", error);
      alert("Failed to submit practice: " + error.message);
    }
  }

  function showCongratsModal(results) {
    const modal = document.getElementById('congratsModal');
    
    // Check if modal exists
    if (!modal) {
      // Fallback to alert if modal doesn't exist
      alert(results.message || `Congratulations! ${results.assignmentName || 'Assignment'} completed successfully!`);
      return;
    }
    
    // Handle case study assignments
    if (results.assignmentType === 'case') {
      const titleEl = document.getElementById('congratsTitle');
      const scoreEl = document.getElementById('congratsScore');
      const subtitleEl = document.getElementById('congratsSubtitle');
      const assignmentNameEl = document.getElementById('congratsAssignmentName');
      const competenciesContainer = document.getElementById('congratsCompetencies');
      
      if (titleEl) titleEl.textContent = 'Congratulations!';
      if (scoreEl) scoreEl.textContent = '';
      if (subtitleEl) subtitleEl.style.display = 'none'; // Hide the score line
      if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Case Study';
      
      // Display competencies from Firebase
      if (competenciesContainer) {
        if (results.competencies && results.competencies.length > 0) {
          competenciesContainer.innerHTML = results.competencies.map(comp => {
            return `
              <div class="congrats-competency-item">
                <div class="congrats-competency-header">
                  <span class="congrats-competency-name">${comp}</span>
                </div>
              </div>
            `;
          }).join('');
        } else {
          competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
        }
      }
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      createCongratsStars();
      return;
    }
    
    // Handle speaking assignments (simple message)
    if (results.message && !results.score && !results.totalQuestions) {
      const titleEl = document.getElementById('congratsTitle');
      const scoreEl = document.getElementById('congratsScore');
      const subtitleEl = document.getElementById('congratsSubtitle');
      const assignmentNameEl = document.getElementById('congratsAssignmentName');
      const competenciesContainer = document.getElementById('congratsCompetencies');
      
      if (titleEl) titleEl.textContent = 'Congratulations!';
      if (scoreEl) scoreEl.textContent = '';
      if (subtitleEl) subtitleEl.innerHTML = results.message || 'Assignment submitted successfully!';
      if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Assignment';
      if (competenciesContainer) competenciesContainer.innerHTML = '';
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      createCongratsStars();
      return;
    }
    
    // Handle written assignments (with scores)
    const percentage = results.percentage || (results.score && results.totalQuestions ? Math.round((results.score / results.totalQuestions) * 100) : 0);
    
    const titleEl = document.getElementById('congratsTitle');
    const scoreEl = document.getElementById('congratsScore');
    const subtitleEl = document.getElementById('congratsSubtitle');
    const assignmentNameEl = document.getElementById('congratsAssignmentName');
    const competenciesContainer = document.getElementById('congratsCompetencies');
    
    if (titleEl) titleEl.textContent = 'Congratulations!';
    if (scoreEl && results.score !== undefined && results.totalQuestions !== undefined) {
      scoreEl.textContent = `${results.score}/${results.totalQuestions}`;
    }
    if (subtitleEl) {
      subtitleEl.style.display = 'block'; // Reset display for other assignment types
      if (results.score !== undefined && results.totalQuestions !== undefined) {
        subtitleEl.innerHTML = 
          `Excellent work! You scored <span id="congratsScoreSpan" style="background: linear-gradient(to right, #ef4444, #f97316, #eab308); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; font-size: 1.75rem;">${results.score}/${results.totalQuestions}</span>`;
      } else if (results.message) {
        subtitleEl.innerHTML = results.message;
      }
    }
    
    if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Written Practice';
    
    if (competenciesContainer) {
      if (results.competencyStats && Object.keys(results.competencyStats).length > 0) {
        competenciesContainer.innerHTML = Object.entries(results.competencyStats).map(([comp, stats]) => {
          const percentage = Math.round((stats.correct / stats.total) * 100);
          const isFull = stats.correct === stats.total;
          return `
            <div class="congrats-competency-item">
              <div class="congrats-competency-header">
                <span class="congrats-competency-name">${comp}</span>
                <span class="congrats-competency-score">${stats.correct}/${stats.total} correct</span>
              </div>
              <div class="congrats-competency-progress-bar">
                <div class="congrats-competency-progress-fill ${isFull ? 'full' : ''}" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
      }
    }
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    createCongratsStars();
  }

  function createCongratsStars() {
    const starsContainer = document.getElementById('congratsStarsContainer');
    if (!starsContainer) return;
    
    starsContainer.innerHTML = '';
    
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'practice-quiz-star';
      
      const size = Math.random() * 3 + 0.5;
      const duration = Math.random() * 4 + 2;
      const delay = Math.random() * 2;
      const randomLeft = Math.random() * 100;
      const randomTop = Math.random() * 100;
      const randomOpacity = Math.random() * 0.9 + 0.3;
      
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = randomLeft + '%';
      star.style.top = randomTop + '%';
      star.style.opacity = randomOpacity;
      star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
      star.style.animationDelay = delay + 's';
      star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
      
      starsContainer.appendChild(star);
    }
  }

  function closeCongratsModal() {
    const modal = document.getElementById('congratsModal');
    if (modal) {
      modal.style.display = 'none';
    }
    document.body.style.overflow = 'auto';
  }

  function snoozeAssignment() {
    closeAssignmentModal();
  }

  // Setup Notifications
  function setupNotifications() {
    const user = auth.currentUser;
    if (!user) return;
    
    const notificationList = document.getElementById("notificationList");
    if (!notificationList) return;
    
    db.collection("notifications")
      .where("menteeId", "==", user.uid)
      .orderBy("timestamp", "desc")
      .limit(50)
      .onSnapshot((snapshot) => {
        notificationList.innerHTML = '';
        
        if (snapshot.empty) {
          notificationList.innerHTML = '<div class="notification-empty">No notifications</div>';
          updateNotificationBadge(0);
          return;
        }
        
        const notificationPromises = [];
        
        snapshot.forEach((doc) => {
          const notif = doc.data();
          const item = document.createElement("div");
          item.className = `notification-item ${notif.read ? 'read' : ''}`;
          
          let timeText = "Just now";
          if (notif.timestamp && notif.timestamp.toDate) {
            const date = notif.timestamp.toDate();
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) timeText = "Just now";
            else if (diffMins < 60) timeText = `${diffMins}m ago`;
            else if (diffHours < 24) timeText = `${diffHours}h ago`;
            else timeText = `${diffDays}d ago`;
          }
          
          // For assignment notifications, fetch assignment data to show all metadata
          if (notif.type === 'assignment' && notif.assignmentId) {
            // Fetch assignment data to get all metadata
            const promise = db.collection('assignments').doc(notif.assignmentId).get()
              .then(assignmentDoc => {
                if (assignmentDoc.exists) {
                  const assignment = assignmentDoc.data();
                  
                  // Build body content with all metadata from assignment
                  let competenciesText = 'n/a';
                  if (assignment.competencies && assignment.competencies.length > 0) {
                    competenciesText = assignment.competencies.join(', ');
                  } else if (notif.competencies && notif.competencies.length > 0) {
                    competenciesText = notif.competencies.join(', ');
                  }
                  
                  let questionsText = '';
                  if (assignment.questions) {
                    if (Array.isArray(assignment.questions)) {
                      questionsText = `Questions: ${assignment.questions.length}<br>`;
                    } else {
                      questionsText = `Questions: ${assignment.questions}<br>`;
                    }
                  } else if (notif.questionCount) {
                    questionsText = `Questions: ${notif.questionCount}<br>`;
                  }
                  
                  let bodyContent = `
                    <div class="notification-body">
                      Type: ${notif.assignmentType || assignment.type || 'Quiz'}<br>
                      Competencies: ${competenciesText}<br>
                      ${assignment.time || notif.time ? `Time: ${assignment.time || notif.time}<br>` : ''}
                      ${assignment.difficulty || notif.difficulty ? `Difficulty: ${assignment.difficulty || notif.difficulty}<br>` : ''}
                      ${questionsText}
                      ${assignment.simulate !== undefined ? `Simulate: ${assignment.simulate ? 'Yes' : 'No'}` : ''}
                    </div>
                  `;
                  
                  // Store assignment data on the element BEFORE setting innerHTML
                  // CRITICAL: These data attributes MUST be set for the click handler to work
                  item.setAttribute('data-assignment-id', notif.assignmentId);
                  item.setAttribute('data-assignment-type', assignment.type || notif.assignmentType || 'unknown');
                  item.dataset.assignmentId = notif.assignmentId; // Also set via dataset for compatibility
                  item.dataset.assignmentType = assignment.type || notif.assignmentType || 'unknown';
                  
                  console.log(' Set data attributes:', {
                    assignmentId: notif.assignmentId,
                    assignmentType: assignment.type || notif.assignmentType,
                    notificationType: notif.type
                  });
                  
                  item.innerHTML = `
                    <div class="notification-header">
                      <strong>${notif.message || notif.title || assignment.title || 'Notification'}</strong>
                      <span class="notification-time">${timeText}</span>
                    </div>
                    ${bodyContent}
                  `;
                  
                  // Add click handler AFTER innerHTML - MAKE IT WORK FOR ALL ASSIGNMENT TYPES
                  item.style.cursor = 'pointer';
                  item.style.pointerEvents = 'auto';
                  item.setAttribute('role', 'button');
                  item.setAttribute('tabindex', '0');
                  item.setAttribute('title', 'Click to open assignment');
                  
                  // SPECIAL LOGGING FOR SPEAKING ASSIGNMENTS
                  if (assignment.type === 'speaking') {
                    console.log(' SPEAKING ASSIGNMENT NOTIFICATION SETUP:', notif.assignmentId);
                    console.log(' Assignment data:', assignment);
                    item.style.border = '3px solid #f97316'; // Orange border for speaking
                  }
                  
                  console.log(' Setting up click handler for notification:', notif.assignmentId, 'Type:', assignment.type);
                  
                  // Use both onclick and addEventListener to ensure it works
                  // THIS HANDLER WORKS FOR ALL TYPES: speaking, written, case, quiz
                  const clickHandler = async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    
                    const assignmentType = assignment.type || 'unknown';
                    console.log(' NOTIFICATION CLICKED!');
                    console.log(' Assignment Type:', assignmentType);
                    console.log(' Assignment ID:', notif.assignmentId);
                    console.log(' Full Assignment:', assignment);
                    
                    // SPECIAL HANDLING FOR SPEAKING ASSIGNMENTS
                    if (assignmentType === 'speaking') {
                      console.log(' SPEAKING ASSIGNMENT DETECTED!');
                    }
                    
                    try {
                      // Mark as read
                      if (!notif.read) {
                        await doc.ref.update({ read: true });
                      }
                      item.classList.add("read");
                      
                      // Ensure assignment has ID
                      const assignmentWithId = { 
                        id: notif.assignmentId, 
                        ...assignment 
                      };
                      window.currentAssignment = assignmentWithId;
                      window.latestAssignmentId = notif.assignmentId;
                      
                      console.log(' Assignment with ID:', assignmentWithId);
                      console.log(' Assignment type:', assignmentWithId.type);
                      
                      // Close notification panel FIRST
                      const notificationPanel = document.getElementById('notificationPanel');
                      if (notificationPanel) {
                        notificationPanel.classList.add('hidden');
                      }
                      
                      // FORCE OPEN THE MODAL - WORKS FOR ALL TYPES INCLUDING SPEAKING
                      setTimeout(() => {
                        console.log(' Attempting to open modal for type:', assignmentWithId.type);
                        const modal = document.getElementById('cq-assignment-modal');
                        if (modal) {
                          console.log(' Modal element found, opening...');
                          modal.style.display = 'block';
                          modal.style.zIndex = '99999';
                          
                          // Set the modal content
                          const titleEl = document.getElementById('cq-assignment-title');
                          const fieldsEl = document.getElementById('cq-assignment-fields');
                          const infoEl = document.getElementById('cq-assignment-info');
                          const quizEl = document.getElementById('cq-assignment-quiz');
                          
                          if (titleEl) {
                            titleEl.innerText = assignmentWithId.title || "New Assignment";
                          }
                          
                          if (infoEl) infoEl.style.display = 'block';
                          if (quizEl) quizEl.style.display = 'none';
                          
                          if (fieldsEl) {
                            // HANDLE SPEAKING ASSIGNMENTS
                            if (assignmentWithId.type === "speaking") {
                              console.log(' Rendering SPEAKING assignment in modal');
                              const q1 = assignmentWithId.questions && assignmentWithId.questions[0] ? assignmentWithId.questions[0] : "No question provided";
                              const q2 = assignmentWithId.questions && assignmentWithId.questions[1] ? assignmentWithId.questions[1] : "No question provided";
                              const q3 = assignmentWithId.questions && assignmentWithId.questions[2] ? assignmentWithId.questions[2] : null;
                              
                              fieldsEl.innerHTML = `
                                <div><b>Type:</b> Speaking Assignment</div>
                                <div><b>Competencies:</b> ${assignmentWithId.competencies ? assignmentWithId.competencies.join(', ') : 'n/a'}</div>
                                <div><b>Description:</b> ${assignmentWithId.description || 'n/a'}</div>
                                ${assignmentWithId.time ? `<div><b>Time Limit:</b> ${assignmentWithId.time}</div>` : ''}
                                <div><b>Questions:</b></div>
                                <ul>
                                  <li>${q1}</li>
                                  <li>${q2}</li>
                                  ${q3 ? `<li>${q3}</li>` : ''}
                                </ul>
                              `;
                            } 
                            // HANDLE CASE ASSIGNMENTS
                            else if (assignmentWithId.type === "case") {
                              console.log(' Rendering CASE assignment in modal');
                              const q1 = assignmentWithId.questions && assignmentWithId.questions[0] ? assignmentWithId.questions[0] : "No question provided";
                              const q2 = assignmentWithId.questions && assignmentWithId.questions[1] ? assignmentWithId.questions[1] : "No question provided";
                              const q3 = assignmentWithId.questions && assignmentWithId.questions[2] ? assignmentWithId.questions[2] : null;
                              
                              fieldsEl.innerHTML = `
                                <div><b>Type:</b> Case Assignment</div>
                                <div><b>Competencies:</b> ${assignmentWithId.competencies ? assignmentWithId.competencies.join(', ') : 'n/a'}</div>
                                <div><b>Description:</b> ${assignmentWithId.description || 'n/a'}</div>
                                ${assignmentWithId.time ? `<div><b>Time Limit:</b> ${assignmentWithId.time}</div>` : ''}
                                <div><b>Questions:</b></div>
                                <ul>
                                  <li>${q1}</li>
                                  <li>${q2}</li>
                                  ${q3 ? `<li>${q3}</li>` : ''}
                                </ul>
                              `;
                            } 
                            // HANDLE WRITTEN ASSIGNMENTS
                            else if (assignmentWithId.type === "written") {
                              console.log(' Rendering WRITTEN assignment in modal');
                              fieldsEl.innerHTML = `
                                <div><b>Type:</b> Written Assignment</div>
                                <div><b>Competencies:</b> ${assignmentWithId.competencies ? assignmentWithId.competencies.join(', ') : 'n/a'}</div>
                                <div><b>Description:</b> ${assignmentWithId.description || 'n/a'}</div>
                                ${assignmentWithId.time ? `<div><b>Time:</b> ${assignmentWithId.time}</div>` : ''}
                                ${assignmentWithId.difficulty ? `<div><b>Difficulty:</b> ${assignmentWithId.difficulty}</div>` : ''}
                              `;
                            } 
                            // HANDLE QUIZ/OTHER ASSIGNMENTS
                            else {
                              console.log(' Rendering QUIZ/OTHER assignment in modal');
                              fieldsEl.innerHTML = `
                                <div><b>Type:</b> ${assignmentWithId.type || 'Quiz'} Assignment</div>
                                <div><b>Time:</b> ${assignmentWithId.time || 'n/a'}</div>
                                <div><b>Competencies:</b> ${assignmentWithId.competencies ? assignmentWithId.competencies.join(', ') : 'n/a'}</div>
                                <div><b>Difficulty:</b> ${assignmentWithId.difficulty || 'n/a'}</div>
                              `;
                            }
                          }
                          
                          console.log(' MODAL OPENED FOR TYPE:', assignmentWithId.type);
                        } else {
                          console.error(' Modal element NOT found!');
                          alert('Modal not found. Please refresh the page.');
                        }
                      }, 100);
                      
                    } catch (error) {
                      console.error(' Error handling notification click:', error);
                      alert('Error opening assignment: ' + error.message);
                    }
                    return false;
                  };
                  
                  // Attach click handler using MULTIPLE methods to ensure it works
                  item.onclick = clickHandler;
                  item.addEventListener('click', clickHandler, { capture: true, once: false });
                  
                  // Also add a mousedown handler as backup - ESPECIALLY FOR SPEAKING
                  item.addEventListener('mousedown', function(e) {
                    console.log(' Mouse down on notification:', notif.assignmentId, 'Type:', assignment.type);
                    if (assignment.type === 'speaking') {
                      console.log(' MOUSE DOWN ON SPEAKING ASSIGNMENT!');
                    }
                  });
                  
                  // Make sure the item is clickable
                  item.setAttribute('role', 'button');
                  item.setAttribute('tabindex', '0');
                  
                  // SPECIAL VERIFICATION FOR SPEAKING ASSIGNMENTS
                  if (assignment.type === 'speaking') {
                    console.log(' SPEAKING: Click handler attached:', !!item.onclick);
                    console.log(' SPEAKING: Event listeners count:', item.getEventListeners ? item.getEventListeners('click') : 'unknown');
                  }
                  
                  // Append to DOM AFTER setting up handlers
                  console.log(' Appending notification item to DOM:', notif.type, notif.assignmentId, 'Type:', assignment.type, 'Click handler attached:', !!item.onclick);
                  notificationList.appendChild(item);
                  
                  // IMMEDIATE TEST FOR SPEAKING ASSIGNMENTS
                  if (assignment.type === 'speaking') {
                    setTimeout(() => {
                      const speakingItem = document.querySelector(`[data-assignment-id="${notif.assignmentId}"][data-assignment-type="speaking"]`);
                      if (speakingItem) {
                        console.log(' SPEAKING item found in DOM!');
                        console.log(' Has onclick:', !!speakingItem.onclick);
                        // Test if we can manually trigger the click
                        console.log(' Testing manual click trigger...');
                        try {
                          // Don't actually trigger, just verify it exists
                          if (speakingItem.onclick) {
                            console.log(' SPEAKING CLICK HANDLER IS READY!');
                          }
                        } catch (err) {
                          console.error(' Error testing click handler:', err);
                        }
                      } else {
                        console.error(' SPEAKING item NOT found in DOM!');
                      }
                    }, 200);
                  }
                  
                  // Test click handler immediately after appending AND add a visual test
                  setTimeout(() => {
                    const testItem = document.querySelector(`[data-assignment-id="${notif.assignmentId}"]`);
                    if (testItem) {
                      if (testItem.onclick) {
                        console.log(' Click handler verified for:', notif.assignmentId, 'Type:', assignment.type);
                      } else {
                        console.error(' Click handler NOT found for:', notif.assignmentId);
                        // Re-attach if missing
                        testItem.onclick = clickHandler;
                        testItem.addEventListener('click', clickHandler, { capture: true });
                      }
                      
                      // Add a visual indicator that it's clickable
                      testItem.style.border = '2px solid rgba(239, 68, 68, 0.5)';
                      testItem.title = 'Click to open assignment';
                    } else {
                      console.error(' Notification item NOT found in DOM:', notif.assignmentId);
                    }
                  }, 100);
                  
                  // Verify click handler is attached after appending
                  setTimeout(() => {
                    const testItem = document.querySelector(`[data-assignment-id="${notif.assignmentId}"]`);
                    if (testItem) {
                      console.log(' Notification item found in DOM with onclick:', !!testItem.onclick);
                    } else {
                      console.error(' Notification item NOT found in DOM!');
                    }
                  }, 500);
                } else {
                  // Fallback if assignment doesn't exist - STILL ADD CLICK HANDLER
                  let bodyContent = `
              <div class="notification-body">
                Type: ${notif.assignmentType || 'Quiz'}<br>
                      Competencies: ${notif.competencies ? notif.competencies.join(', ') : 'n/a'}<br>
                ${notif.time ? `Time: ${notif.time}<br>` : ''}
                ${notif.difficulty ? `Difficulty: ${notif.difficulty}` : ''}
              </div>
            `;
                  
                  // STORE DATA ATTRIBUTES EVEN IN FALLBACK
                  item.dataset.assignmentId = notif.assignmentId;
                  item.dataset.assignmentType = notif.assignmentType || 'unknown';
                  
                  item.innerHTML = `
                    <div class="notification-header">
                      <strong>${notif.message || notif.title || 'Notification'}</strong>
                      <span class="notification-time">${timeText}</span>
              </div>
                    ${bodyContent}
                  `;
                  
                  // Add FULL click handler for fallback - TRY TO FETCH AND OPEN MODAL
                  item.style.cursor = 'pointer';
                  item.style.pointerEvents = 'auto';
                  item.onclick = async function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log(' FALLBACK: Notification clicked, fetching assignment:', notif.assignmentId);
                    
                    try {
                      // Try to fetch assignment again
                      const assignmentDoc = await db.collection('assignments').doc(notif.assignmentId).get();
                      if (assignmentDoc.exists) {
                        const assignment = { id: assignmentDoc.id, ...assignmentDoc.data() };
                        window.currentAssignment = assignment;
                        window.latestAssignmentId = assignmentDoc.id;
                        openFullAssignmentModal(assignment);
                        
                        // Mark as read
                        if (!notif.read) {
                          await doc.ref.update({ read: true });
                        }
                        item.classList.add("read");
                        
                        // Close notification panel
                        const notificationPanel = document.getElementById('notificationPanel');
                        if (notificationPanel) {
                          notificationPanel.classList.add('hidden');
                        }
          } else {
                        alert('Assignment not found');
                      }
                    } catch (error) {
                      console.error('Error in fallback click handler:', error);
                      alert('Error opening assignment: ' + error.message);
                    }
                  };
                  
                  notificationList.appendChild(item);
                }
              })
              .catch(error => {
                console.error("Error fetching assignment for notification:", error);
                console.error("Assignment ID:", notif.assignmentId, "Type:", notif.assignmentType);
                
                // Fallback display - BUT STILL ADD CLICK HANDLER AND DATA ATTRIBUTES
                let bodyContent = `
              <div class="notification-body">
                    Type: ${notif.assignmentType || 'Quiz'}<br>
                    Competencies: ${notif.competencies ? notif.competencies.join(', ') : 'n/a'}<br>
                    ${notif.time ? `Time: ${notif.time}<br>` : ''}
                    ${notif.difficulty ? `Difficulty: ${notif.difficulty}` : ''}
              </div>
            `;
                
                // STORE DATA ATTRIBUTES EVEN IN ERROR CASE
                item.dataset.assignmentId = notif.assignmentId;
                item.dataset.assignmentType = notif.assignmentType || 'unknown';
          
          item.innerHTML = `
            <div class="notification-header">
                    <strong>${notif.message || notif.title || 'Notification'}</strong>
              <span class="notification-time">${timeText}</span>
            </div>
            ${bodyContent}
          `;
          
                // Add FULL click handler even in error case - TRY TO FETCH AND OPEN MODAL
            item.style.cursor = 'pointer';
                item.style.pointerEvents = 'auto';
                item.onclick = async function(e) {
                  e.preventDefault();
                  e.stopPropagation();
                  console.log(' ERROR CASE: Notification clicked, retrying fetch:', notif.assignmentId);
                  
                  try {
                    // Retry fetching assignment
                    const assignmentDoc = await db.collection('assignments').doc(notif.assignmentId).get();
                    if (assignmentDoc.exists) {
                      const assignment = { id: assignmentDoc.id, ...assignmentDoc.data() };
                      window.currentAssignment = assignment;
                      window.latestAssignmentId = assignmentDoc.id;
                      openFullAssignmentModal(assignment);
                      
              // Mark as read
              if (!notif.read) {
                        await doc.ref.update({ read: true });
              }
              item.classList.add("read");
              
              // Close notification panel
                      const notificationPanel = document.getElementById('notificationPanel');
                      if (notificationPanel) {
                        notificationPanel.classList.add('hidden');
                      }
                    } else {
                      alert('Assignment not found');
                    }
                  } catch (retryError) {
                    console.error('Error in retry click handler:', retryError);
                    alert('Error opening assignment: ' + retryError.message);
                  }
                };
                
                notificationList.appendChild(item);
              });
            
            notificationPromises.push(promise);
          } else {
            // Non-assignment notifications - but check if it's a speaking notification that needs fixing
            if (notif.message && notif.message.includes('Speaking') && notif.assignmentId) {
              // This is a speaking notification that might have been created with wrong type
              // Treat it as an assignment notification
              const promise = db.collection('assignments').doc(notif.assignmentId).get()
                .then(assignmentDoc => {
                  if (assignmentDoc.exists) {
                    const assignment = assignmentDoc.data();
                    
                    let bodyContent = `
                      <div class="notification-body">
                        Type: Speaking Assignment<br>
                        ${assignment.competencies ? `Competencies: ${assignment.competencies.join(', ')}<br>` : ''}
                        ${assignment.time ? `Time: ${assignment.time}<br>` : ''}
                      </div>
                    `;
                    
                    // CRITICAL: Set data attributes
                    item.setAttribute('data-assignment-id', notif.assignmentId);
                    item.setAttribute('data-assignment-type', 'speaking');
                    item.dataset.assignmentId = notif.assignmentId;
                    item.dataset.assignmentType = 'speaking';
                    
                    item.innerHTML = `
                      <div class="notification-header">
                        <strong>${notif.message || notif.title || 'Notification'}</strong>
                        <span class="notification-time">${timeText}</span>
                      </div>
                      ${bodyContent}
                    `;
                    
                    // Add FULL click handler
            item.style.cursor = 'pointer';
                    item.style.pointerEvents = 'auto';
                    item.setAttribute('role', 'button');
                    item.setAttribute('tabindex', '0');
                    item.setAttribute('title', 'Click to open assignment');
                    
                    const clickHandler = async function(e) {
                      e.preventDefault();
                      e.stopPropagation();
                      e.stopImmediatePropagation();
                      
                      console.log(' SPEAKING NOTIFICATION CLICKED (FALLBACK PATH)!');
                      console.log(' Assignment ID:', notif.assignmentId);
                      
                      try {
                        const assignmentDoc = await db.collection('assignments').doc(notif.assignmentId).get();
                        if (assignmentDoc.exists) {
                          const assignment = { id: assignmentDoc.id, ...assignmentDoc.data() };
                          window.currentAssignment = assignment;
                          window.latestAssignmentId = assignmentDoc.id;
                          
                          // Mark as read
                          if (!notif.read) {
                            await doc.ref.update({ read: true });
                          }
                          item.classList.add("read");
                          
                          // Close notification panel
                          const notificationPanel = document.getElementById('notificationPanel');
                          if (notificationPanel) {
                            notificationPanel.classList.add('hidden');
                          }
                          
                          // Open modal
                          setTimeout(() => {
                            openFullAssignmentModal(assignment);
                          }, 100);
                        }
                      } catch (error) {
                        console.error('Error opening speaking assignment:', error);
                        alert('Error opening assignment: ' + error.message);
                      }
                    };
                    
                    item.onclick = clickHandler;
                    item.addEventListener('click', clickHandler, { capture: true });
                    
                    notificationList.appendChild(item);
                  } else {
                    // Assignment doesn't exist, render as regular notification
                    let bodyContent = `
                      <div class="notification-body">
                        ${notif.message || notif.title || 'Notification'}
                      </div>
                    `;
                    item.innerHTML = `
                      <div class="notification-header">
                        <strong>${notif.message || notif.title || 'Notification'}</strong>
                        <span class="notification-time">${timeText}</span>
                      </div>
                      ${bodyContent}
                    `;
                    notificationList.appendChild(item);
                  }
                })
                .catch(error => {
                  console.error("Error fetching speaking assignment:", error);
                  // Render as regular notification
                  let bodyContent = `
                    <div class="notification-body">
                      ${notif.message || notif.title || 'Notification'}
                    </div>
                  `;
                  item.innerHTML = `
                    <div class="notification-header">
                      <strong>${notif.message || notif.title || 'Notification'}</strong>
                      <span class="notification-time">${timeText}</span>
                    </div>
                    ${bodyContent}
                  `;
                  notificationList.appendChild(item);
                });
              
              notificationPromises.push(promise);
            } else {
            // Non-assignment notifications
            let bodyContent = `
              <div class="notification-body">
                ${notif.message || notif.title || 'Notification'}
                ${notif.score !== undefined ? `<br>Score: ${notif.score}/${notif.totalQuestions || notif.maxScore || ''}` : ''}
              </div>
            `;
            
            item.innerHTML = `
              <div class="notification-header">
                <strong>${notif.message || notif.title || 'Notification'}</strong>
                <span class="notification-time">${timeText}</span>
              </div>
              ${bodyContent}
            `;
            
            item.addEventListener("click", () => {
              if (!notif.read) {
                doc.ref.update({ read: true });
              }
              item.classList.add("read");
            });
          
          notificationList.appendChild(item);
          }
          }
        });
        
        // Update notification badge count
        const unreadCount = snapshot.docs.filter(doc => !doc.data().read).length;
        updateNotificationBadge(unreadCount);
        
        // FALLBACK FIX: Ensure ALL speaking notifications have click handlers
        // This runs after all notifications are rendered to catch any that were missed
        setTimeout(() => {
          document.querySelectorAll('.notification-item').forEach(item => {
            const itemText = item.textContent || '';
            const hasAssignmentId = item.dataset.assignmentId || item.getAttribute('data-assignment-id');
            
            // Check if this is a speaking notification without proper setup
            if (itemText.includes('Speaking') && !hasAssignmentId) {
              console.log(' FIXING: Found speaking notification without assignment ID');
              
              // Try to find assignment ID from notification text or try to fetch
              const strongEl = item.querySelector('strong');
              const title = strongEl ? strongEl.textContent : '';
              
              // Add styling to make it look clickable
              item.setAttribute('role', 'button');
              item.setAttribute('tabindex', '0');
              item.setAttribute('title', 'Click to open assignment');
              item.style.cursor = 'pointer';
              item.style.pointerEvents = 'auto';
              item.style.border = '2px solid rgba(239, 68, 68, 0.5)';
              
              // Add click handler that tries to find and open the assignment
              item.onclick = async function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                console.log(' SPEAKING NOTIFICATION CLICKED (FALLBACK FIX)!');
                console.log(' Title:', title);
                
                // Try to find assignment by searching notifications collection
                try {
                  const user = auth.currentUser;
                  if (!user) {
                    alert('Please sign in');
                    return;
                  }
                  
                  // Search for the assignment in user's notifications
                  const notifSnapshot = await db.collection('notifications')
                    .where('menteeId', '==', user.uid)
                    .where('message', '==', title)
                    .limit(1)
                    .get();
                  
                  if (!notifSnapshot.empty) {
                    const notifDoc = notifSnapshot.docs[0];
                    const notifData = notifDoc.data();
                    
                    if (notifData.assignmentId) {
                      // Found the assignment ID, fetch and open it
                      const assignmentDoc = await db.collection('assignments').doc(notifData.assignmentId).get();
                      if (assignmentDoc.exists) {
                        const assignment = { id: assignmentDoc.id, ...assignmentDoc.data() };
                        window.currentAssignment = assignment;
                        window.latestAssignmentId = assignmentDoc.id;
                        
                        // Update data attributes
                        item.setAttribute('data-assignment-id', assignmentDoc.id);
                        item.setAttribute('data-assignment-type', 'speaking');
                        
                        // Mark as read
                        await notifDoc.ref.update({ read: true });
                        item.classList.add("read");
                        
                        // Close notification panel
                        const notificationPanel = document.getElementById('notificationPanel');
                        if (notificationPanel) {
                          notificationPanel.classList.add('hidden');
                        }
                        
                        // Open modal
                        setTimeout(() => {
                          if (typeof openFullAssignmentModal === 'function') {
                            openFullAssignmentModal(assignment);
        } else {
                            // Fallback: manually open modal
                            const modal = document.getElementById('cq-assignment-modal');
                            if (modal) {
                              const modalTitle = document.getElementById('cq-assignment-title');
                              const fieldsEl = document.getElementById('cq-assignment-fields');
                              const infoEl = document.getElementById('cq-assignment-info');
                              
                              if (modalTitle) modalTitle.textContent = assignment.title || title;
                              if (infoEl) infoEl.style.display = 'block';
                              if (fieldsEl) {
                                if (assignment.type === 'speaking') {
                                  const q1 = assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided";
                                  const q2 = assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided";
                                  const q3 = assignment.questions && assignment.questions[2] ? assignment.questions[2] : null;
                                  
                                  fieldsEl.innerHTML = `
                                    <div><b>Type:</b> Speaking Assignment</div>
                                    <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
                                    <div><b>Description:</b> ${assignment.description || 'n/a'}</div>
                                    ${assignment.time ? `<div><b>Time Limit:</b> ${assignment.time}</div>` : ''}
                                    <div><b>Questions:</b></div>
                                    <ul>
                                      <li>${q1}</li>
                                      <li>${q2}</li>
                                      ${q3 ? `<li>${q3}</li>` : ''}
                                    </ul>
                                  `;
                                }
                              }
                              
                              modal.style.display = 'block';
                              modal.style.zIndex = '99999';
                            }
                          }
                        }, 100);
                        return;
                      }
                    }
                  }
                  
                  // If we can't find it, at least open a basic modal
                  const modal = document.getElementById('cq-assignment-modal');
                  if (modal) {
                    const modalTitle = document.getElementById('cq-assignment-title');
                    const fieldsEl = document.getElementById('cq-assignment-fields');
                    const infoEl = document.getElementById('cq-assignment-info');
                    
                    if (modalTitle) modalTitle.textContent = title;
                    if (infoEl) infoEl.style.display = 'block';
                    if (fieldsEl) {
                      fieldsEl.innerHTML = `
                        <div><b>Type:</b> Speaking Assignment</div>
                        <div><b>Note:</b> Assignment details could not be loaded. Please check your assignments page.</div>
                      `;
                    }
                    
                    modal.style.display = 'block';
                    modal.style.zIndex = '99999';
                    
                    // Close notification panel
                    const notificationPanel = document.getElementById('notificationPanel');
                    if (notificationPanel) {
                      notificationPanel.classList.add('hidden');
                    }
                    
                    console.log(' Modal opened (fallback)');
                  } else {
                    console.error(' Modal not found');
                    alert('Assignment modal not found. Please refresh the page.');
                  }
                } catch (error) {
                  console.error(' Error in fallback click handler:', error);
                  alert('Error opening assignment: ' + error.message);
                }
              };
              
              // Also handle Enter/Space key for accessibility
              item.onkeydown = function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                  e.preventDefault();
                  item.click();
                }
              };
              
              console.log(' Fixed speaking notification:', title);
            }
          });
          
          console.log(' Speaking notification fallback fix applied!');
        }, 500);
      }, (error) => {
        console.error("Error loading notifications:", error);
      });
  };
    // ============ RESOURCES FUNCTIONALITY ============
    // Resources data from Firebase
    let resources = [];
    
    // State
    let searchQuery = '';
    let selectedCompetitions = [];
    let selectedCategory = 'all';

    // Fetch resources from Firebase
    async function loadResourcesFromFirebase() {
      try {
        const snapshot = await db.collection('resources').get();
        resources = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          resources.push({
            id: doc.id,
            title: data.title || '',
            description: data.description || '',
            url: data.url || '',
            competitions: Array.isArray(data.competitions) ? data.competitions : (Array.isArray(data.tags) ? data.tags : []),
            category: data.category || 'tutorial',
            savedBy: data.savedBy || 0,
            addedBy: data.addedBy || 'Unknown',
            addedById: data.addedById || null,
            timestamp: data.timestamp || 'Unknown',
            liked: data.liked || false,
            createdAt: data.createdAt || null
          });
        });
        
        console.log(' Loaded', resources.length, 'resources from Firebase');
        
        // Generate competitions from resources
        generateCompetitionsFromResources();
        
        // Render resources
        renderResources();
      } catch (error) {
        console.error(' Error loading resources from Firebase:', error);
        resources = [];
        renderResources();
      }
    }

    // Generate unique competitions from all resources
    function generateCompetitionsFromResources() {
      const competitionSet = new Set();
      
      resources.forEach(resource => {
        const competitions = resource.competitions || resource.tags || [];
        if (Array.isArray(competitions)) {
          competitions.forEach(competition => {
            if (competition && competition.trim()) {
              competitionSet.add(competition.trim());
            }
          });
        }
      });
      
      const uniqueCompetitions = Array.from(competitionSet).sort();
      
      // Update competition filters container
      const tagFiltersContainer = document.getElementById('tagFilters');
      if (tagFiltersContainer) {
        tagFiltersContainer.innerHTML = uniqueCompetitions.map(competition => 
          `<button class="tag-btn" data-competition="${competition}">${competition}</button>`
        ).join('');
        
        // Re-attach event listeners
        document.querySelectorAll('.tag-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const competition = btn.dataset.competition;
            if (selectedCompetitions.includes(competition)) {
              selectedCompetitions = selectedCompetitions.filter(c => c !== competition);
              btn.classList.remove('active');
            } else {
              selectedCompetitions.push(competition);
              btn.classList.add('active');
            }
            renderResources();
          });
        });
      }
      
      console.log(' Generated', uniqueCompetitions.length, 'unique competitions:', uniqueCompetitions);
    }

    // Format timestamp
    function formatTimestamp(timestamp) {
      if (!timestamp) return 'Unknown';
      if (timestamp.toDate) {
        // Firestore timestamp
        const date = timestamp.toDate();
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
      }
      return timestamp;
    }

    // Render resources
    function renderResources() {
      const grid = document.getElementById('resourcesGrid');
      const emptyState = document.getElementById('emptyState');
      
      if (!grid || !emptyState) return;
      
      const filtered = resources.filter(resource => {
        const matchesSearch = resource.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
          resource.description.toLowerCase().includes(searchQuery.toLowerCase());
        const resourceCompetitions = resource.competitions || resource.tags || [];
        const matchesCompetitions = selectedCompetitions.length === 0 || selectedCompetitions.some(competition => resourceCompetitions.includes(competition));
        const matchesCategory = selectedCategory === 'all' || resource.category === selectedCategory;
        return matchesSearch && matchesCompetitions && matchesCategory;
      });

      if (filtered.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      grid.style.display = 'grid';
      emptyState.style.display = 'none';
      
      // Get current user for delete button visibility
      const user = firebase.auth().currentUser;
      const currentUserId = user?.uid || null;
      
      grid.innerHTML = filtered.map(resource => {
        const canDelete = currentUserId && resource.addedById === currentUserId;
        const deleteButton = canDelete ? `<button class="delete-btn" onclick="deleteResource('${resource.id}')" title="Delete resource">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
          </button>` : '';
        
        return `
        <div class="resource-card">
          <div class="resource-header">
            <div style="flex: 1;">
              <h3 class="resource-title">${resource.title}</h3>
              <p class="resource-description">${resource.description}</p>
            </div>
          </div>

          <div class="resource-tags">
            ${(resource.competitions || resource.tags || []).map(competition => `<span class="tag">#${competition}</span>`).join('')}
          </div>

          <div class="category-badge">
            <span>${resource.category}</span>
          </div>

          <div class="resource-meta">
            <p>Added by ${resource.addedBy}  ${formatTimestamp(resource.createdAt || resource.timestamp)}</p>
          </div>

          <div class="resource-actions">
            <div class="action-buttons">
              <button class="action-btn like-btn ${resource.liked ? 'liked' : ''}" onclick="toggleLike('${resource.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="${resource.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                ${resource.savedBy}
              </button>
              <button class="action-btn visit-btn" onclick="window.open('${resource.url}', '_blank')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                VISIT
              </button>
            </div>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
              <button class="share-btn" onclick="shareResource('${resource.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="18" cy="5" r="3"></circle>
                  <circle cx="6" cy="12" r="3"></circle>
                  <circle cx="18" cy="19" r="3"></circle>
                  <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                  <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
              </button>
              ${deleteButton}
            </div>
          </div>
        </div>
      `;
      }).join('');
    }

    // Toggle like
    window.toggleLike = async function(id) {
      const resource = resources.find(r => r.id === id);
      if (resource) {
        const wasLiked = resource.liked;
        resource.liked = !resource.liked;
        resource.savedBy += resource.liked ? 1 : -1;
        
        // Update in Firebase
        try {
          await db.collection('resources').doc(id).update({
            liked: resource.liked,
            savedBy: resource.savedBy
          });
        } catch (error) {
          console.error('Error updating like in Firebase:', error);
          // Revert on error
          resource.liked = wasLiked;
          resource.savedBy -= resource.liked ? 1 : -1;
        }
        
        renderResources();
      }
    };

    // Share resource
    window.shareResource = function(id) {
      const resource = resources.find(r => r.id === id);
      if (resource && navigator.share) {
        navigator.share({
          title: resource.title,
          text: resource.description,
          url: resource.url
        });
      }
    };

    // Delete resource
    window.deleteResource = async function(id) {
      const resource = resources.find(r => r.id === id);
      if (!resource) return;

      // Confirm deletion
      if (!confirm(`Are you sure you want to delete "${resource.title}"? This action cannot be undone.`)) {
        return;
      }

      try {
        // Delete from Firebase
        await db.collection('resources').doc(id).delete();
        console.log(' Resource deleted from Firebase:', id);
        
        // Reload resources from Firebase
        await loadResourcesFromFirebase();
      } catch (error) {
        console.error(' Error deleting resource from Firebase:', error);
        alert('Failed to delete resource. Please try again.');
      }
    };

    // Initialize resources functionality when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      // Modal handlers
      const dropResourceBtn = document.getElementById('dropResourceBtn');
      const modalOverlay = document.getElementById('modalOverlay');
      const modalClose = document.getElementById('modalClose');
      const resourceForm = document.getElementById('resourceForm');

      if (dropResourceBtn && modalOverlay) {
        dropResourceBtn.addEventListener('click', () => {
          modalOverlay.style.display = 'flex';
        });
      }

      if (modalClose && modalOverlay) {
        modalClose.addEventListener('click', () => {
          modalOverlay.style.display = 'none';
        });
      }

      if (modalOverlay) {
        modalOverlay.addEventListener('click', (e) => {
          if (e.target.id === 'modalOverlay') {
            modalOverlay.style.display = 'none';
          }
        });
      }

      // Form submission
      if (resourceForm) {
        resourceForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const title = document.getElementById('formTitle').value;
          const description = document.getElementById('formDescription').value;
          const url = document.getElementById('formUrl').value;
          const competitions = document.getElementById('formTags').value.split(',').map(c => c.trim()).filter(c => c);
          const category = document.getElementById('formCategory').value;

          if (title && url) {
            try {
              const user = firebase.auth().currentUser;
              const userDisplayName = user?.displayName || user?.email || 'Anonymous';
              
              // Save to Firebase
const newResourceData = {
  title,
  description,
  url,
  competitions,
  category,
  savedBy: 0,
  addedBy: userDisplayName,
  addedById: user?.uid || null,
  createdBy: user?.uid || null,  //  ADD THIS LINE
  timestamp: new Date().toLocaleDateString(),
  liked: false,
  createdAt: firebase.firestore.FieldValue.serverTimestamp()
};
              
              const docRef = await db.collection('resources').add(newResourceData);
              console.log(' Resource saved to Firebase with ID:', docRef.id);
              
              // Reload resources from Firebase
              await loadResourcesFromFirebase();
              
              resourceForm.reset();
              modalOverlay.style.display = 'none';
            } catch (error) {
              console.error(' Error saving resource to Firebase:', error);
              alert('Failed to save resource. Please try again.');
            }
          }
        });
      }

      // Search
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          searchQuery = e.target.value;
          renderResources();
        });
      }

      // Category filter
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          selectedCategory = btn.dataset.category;
          renderResources();
        });
      });

      // Competition filter - event listeners are attached in generateCompetitionsFromResources()
      
      // Load resources from Firebase when page loads
      firebase.auth().onAuthStateChanged(async (user) => {
        if (user) {
          await loadResourcesFromFirebase();
        } else {
          // Still load resources even if not logged in (public resources)
          await loadResourcesFromFirebase();
        }
      });
    });

    // Study Mode Modal Functions
    let selectedStudyMode = null;

    function openStudyModeModal() {
      const modal = document.getElementById('studyModeModal');
      if (modal) {
        modal.classList.add('active');
        createStudyModeStars();
        
        // Reset selection
        selectedStudyMode = null;
        const options = document.querySelectorAll('#studyModeOptions .practice-quiz-option-btn');
        options.forEach(opt => {
          opt.classList.remove('selected');
        });
        
      }
    }
    // Expose globally immediately
    window.openStudyModeModal = openStudyModeModal;

    function closeStudyModeModal() {
      const modal = document.getElementById('studyModeModal');
      if (modal) {
        modal.classList.remove('active');
      }
    }

    function createStudyModeStars() {
      const container = document.getElementById('studyModeStarsContainer');
      if (!container) return;
      
      container.innerHTML = '';
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'practice-quiz-star';
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.9 + 0.1;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
        star.style.animationDelay = delay + 's';
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
        
        container.appendChild(star);
      }
    }

    function confirmStudyMode() {
      if (selectedStudyMode) {
        console.log('Selected study mode:', selectedStudyMode);
        closeStudyModeModal();
        
        if (selectedStudyMode === 'darts') {
          // Start darts game
          startDartsGame();
        } else if (selectedStudyMode === '2048') {
          // Start 2048 game
          start2048Game();
        } else if (selectedStudyMode === 'blackjack') {
          // Start blackjack game
          startBlackjackGame();
        } else if (selectedStudyMode === 'memory') {
          // Start memory match game
          startMemoryGame();
        }
      }
    }

    // Initialize study mode option click handlers
    document.addEventListener('DOMContentLoaded', function() {
      const options = document.querySelectorAll('#studyModeOptions .practice-quiz-option-btn');
      options.forEach(optionBtn => {
        optionBtn.addEventListener('click', function() {
          // Remove selection from all options
          options.forEach(opt => {
            opt.classList.remove('selected');
          });
          
          // Select this option
          this.classList.add('selected');
          
          selectedStudyMode = this.dataset.mode;
          
          // Automatically confirm selection after a short delay
          setTimeout(() => {
            confirmStudyMode();
          }, 300);
        });
      });
    });

    // ============ DARTS GAME ============
    // Darts quiz state
    let dartsCurrentQuestion = null;
    let dartsHearts = 3;
    let dartsQuestionHistory = []; // Store answered questions for navigation
    let dartsCurrentQuestionIndex = -1; // Current position in history
    let dartsQuestionQueue = []; // Pre-generated questions ready to use
    let dartsIsGeneratingQuestions = false; // Prevent multiple simultaneous generations

    let dartsGameState = {
      phase: 'menu', // menu, quiz, game, results
      quizQuestionsCorrect: 0,
      quizSelectedAnswer: null,
      quizAnswered: false,
      dartScore: 0,
      dartsThrown: 0,
      lastHit: '',
      targetScore: 0,
      timeLeft: 0,
      timerInterval: null,
      stuckDarts: [],
      isAnimating: false
    };

    function startDartsGame() {
      const container = document.getElementById('dartsGameContainer');
      if (container) {
        container.classList.add('active');
        createDartsStars();
        dartsGameState.phase = 'menu';
        showDartsPhase('menu');
      }
    }
    window.startDartsGame = startDartsGame;

    function createDartsStars() {
      const container = document.getElementById('dartsStarsBg');
      if (!container) return;
      
      container.innerHTML = '';
      for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'darts-star';
        const size = Math.random() * 2 + 1;
        const duration = 2 + Math.random() * 3;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.5 + 0.2;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `darts-twinkle ${duration}s infinite`;
        star.style.animationDelay = delay + 's';
        
        container.appendChild(star);
      }
    }

    function showDartsPhase(phase) {
      const dartsContainer = document.getElementById('dartsGameContainer');
      if (dartsContainer) {
        dartsContainer.classList.add('active');
        dartsContainer.style.display = 'flex';
      }
      
      document.getElementById('dartsMenuPhase').style.display = phase === 'menu' ? 'flex' : 'none';
      if (phase === 'quiz') {
        document.getElementById('dartsQuizPhase').style.display = 'flex';
        document.body.style.overflow = 'hidden';
      } else {
        document.getElementById('dartsQuizPhase').style.display = 'none';
        if (phase !== 'game') {
          document.body.style.overflow = 'auto';
        }
      }
      document.getElementById('dartsGamePhase').style.display = phase === 'game' ? 'block' : 'none';
      dartsGameState.phase = phase;
    }

    async function startDartsQuiz() {
      // Reset 2048 quiz mode flag
      is2048QuizMode = false;
      
      dartsGameState.quizQuestionsCorrect = 0;
      dartsGameState.quizSelectedAnswer = null;
      dartsGameState.quizAnswered = false;
      dartsHearts = 3;
      dartsCurrentQuestion = null;
      dartsQuestionHistory = [];
      dartsCurrentQuestionIndex = -1;
      dartsQuestionQueue = [];
      dartsIsGeneratingQuestions = false;
      
      // Reset hearts
      for (let i = 1; i <= 3; i++) {
        const heart = document.getElementById(`dartsHeart${i}`);
        if (heart) {
          heart.classList.remove('broken', 'breaking');
        }
      }
      
      showDartsPhase('quiz');
      
      // Pre-generate 10 questions in the background
      console.log(' Pre-generating 10 questions...');
      dartsIsGeneratingQuestions = true;
      const questions = await generateDartsQuestionsBatch(10);
      dartsQuestionQueue = questions;
      dartsIsGeneratingQuestions = false;
      console.log(` Pre-generated ${questions.length} questions ready to use`);
      
      // Load first question instantly from queue
      loadDartsQuestionFromQueue();
      
      // Start background generation to keep queue full
      maintainQuestionQueue();
    }
    
    async function maintainQuestionQueue() {
      // Keep queue at 10 questions by generating more when it gets low
      while (dartsHearts > 0) {
        if (dartsQuestionQueue.length < 5 && !dartsIsGeneratingQuestions) {
          console.log(' Queue getting low, generating more questions...');
          dartsIsGeneratingQuestions = true;
          const newQuestions = await generateDartsQuestionsBatch(10);
          dartsQuestionQueue.push(...newQuestions);
          dartsIsGeneratingQuestions = false;
          console.log(` Added ${newQuestions.length} questions to queue. Total: ${dartsQuestionQueue.length}`);
        }
        await new Promise(resolve => setTimeout(resolve, 1000)); // Check every second
      }
    }
    
    function loadDartsQuestionFromQueue() {
      // Check which mode we're in and use the appropriate queue
      const questionQueue = is2048QuizMode ? game2048State.questionQueue : dartsQuestionQueue;
      const questionHistory = is2048QuizMode ? game2048State.questionHistory : dartsQuestionHistory;
      
      if (questionQueue.length === 0) {
        console.log(' Queue empty, waiting for questions...');
        // Show loading state
        document.getElementById('dartsQuizQuestion').textContent = 'Generating questions...';
        document.getElementById('dartsQuizOptions').innerHTML = '<div style="text-align: center; color: #94a3b8;">Please wait...</div>';
        return;
      }
      
      // Get question from queue
      const questionFromQueue = questionQueue.shift();
      
      // Add to history
      questionHistory.push({
        question: questionFromQueue,
        answered: false,
        selectedAnswer: null,
        isCorrect: null
      });
      
      if (is2048QuizMode) {
        game2048State.currentQuestionIndex = questionHistory.length - 1;
        game2048State.currentQuestion = questionFromQueue;
      } else {
        dartsCurrentQuestionIndex = questionHistory.length - 1;
        dartsCurrentQuestion = questionFromQueue;
      }
      
      displayDartsQuestion(questionFromQueue);
    }
    
    function displayDartsQuestion(question) {
      const questionHistory = is2048QuizMode ? game2048State.questionHistory : dartsQuestionHistory;
      const currentQuestionIndex = is2048QuizMode ? game2048State.currentQuestionIndex : dartsCurrentQuestionIndex;
      
      if (is2048QuizMode) {
        game2048State.currentQuestion = question;
      } else {
        dartsCurrentQuestion = question;
      }
      
      const historyItem = questionHistory[currentQuestionIndex];
      const questionNum = currentQuestionIndex + 1;
      
      document.getElementById('dartsQuizQuestion').textContent = question.question;
      document.getElementById('dartsQuizProgress').textContent = `Question ${questionNum}`;
      document.getElementById('dartsQuizCompetency').textContent = question.competency.toUpperCase();
      
      const progressPercent = Math.min(questionNum * 10, 100);
      document.getElementById('dartsQuizProgressPercent').textContent = progressPercent;
      document.getElementById('dartsQuizProgressFill').style.width = `${progressPercent}%`;

      const optionsContainer = document.getElementById('dartsQuizOptions');
      const wasAnswered = historyItem.answered;
      const selectedIdx = historyItem.selectedAnswer;
      
      optionsContainer.innerHTML = question.options.map((option, idx) => {
        let classes = 'practice-quiz-option-btn';
        let disabled = wasAnswered ? 'disabled' : '';
        let radioContent = '<div class="practice-quiz-option-radio"></div>';
        
        if (wasAnswered) {
          if (idx === question.correct) {
            classes += ' selected';
            radioContent = '<div class="practice-quiz-option-radio selected"><div class="practice-quiz-option-dot"></div></div>';
          } else if (idx === selectedIdx) {
            // Wrong answer
          }
        }
        
        return `
          <button class="${classes}" data-option="${idx}" onclick="dartsSelectAnswer(${idx})" ${disabled}>
            ${radioContent}
            <span class="practice-quiz-option-text">${option}</span>
          </button>
        `;
      }).join('');

      // Update navigation buttons
      document.getElementById('dartsQuizPrevBtn').disabled = dartsCurrentQuestionIndex === 0;
      document.getElementById('dartsQuizNextBtn').style.display = wasAnswered ? 'block' : 'none';
      
      dartsGameState.quizSelectedAnswer = historyItem.selectedAnswer;
      dartsGameState.quizAnswered = wasAnswered;
      
      // Create stars for quiz phase
      createDartsQuizStars();
    }
    window.startDartsQuiz = startDartsQuiz;
    window.startDartsQuiz = startDartsQuiz;

    // Helper functions for training data
    function getCurrentUserId() {
      return firebase.auth().currentUser?.uid;
    }

    async function fetchBaselineNotesForCompetition(competitionName) {
      try {
        console.log(" Fetching baseline notes for:", competitionName);
        if (!competitionName || competitionName === "general") {
          console.log(" No competition specified, skipping baseline notes");
          return "";
        }
        const docRef = db.collection("competitions").doc(competitionName);
        const docSnapshot = await docRef.get();
        if (docSnapshot.exists) {
          const baseline = docSnapshot.data().baseline;
          if (baseline && baseline.text) {
            console.log(" Baseline notes found, length:", baseline.text.length);
            return baseline.text;
          }
        }
        console.log(" No baseline notes found for", competitionName);
        return "";
      } catch (error) {
        console.error(" Error fetching baseline:", error);
        return "";
      }
    }

    async function getAllTrainingEntries(selectedCompetition) {
      const userId = getCurrentUserId();
      
      try {
        let combinedContent = '';
        let allUserQuestions = [];
        
        // Get baseline training data for the competition
        let baselineNotes = "";
        if (selectedCompetition && selectedCompetition !== "general") {
          baselineNotes = await fetchBaselineNotesForCompetition(selectedCompetition);
          if (baselineNotes) {
            combinedContent += baselineNotes + '\n\n';
            console.log(" Baseline notes ADDED to training content");
            console.log(`   Baseline length: ${baselineNotes.length}`);
          }
        }
        
        // Get all entries from the entries subcollection
        const entriesSnapshot = await db.collection('userTraining')
          .doc(userId)
          .collection('entries')
          .get();
        
        // Process each entry
        entriesSnapshot.forEach(doc => {
          const data = doc.data();
          
          // Filter by competition if specified (or include all if 'general' or no filter)
          if (!selectedCompetition || selectedCompetition === 'general' || data.competition === selectedCompetition) {
            // Combine PDF content
            if (data.content) {
              combinedContent += data.content + '\n\n';
            }
            
            // Combine user questions
            if (data.userQuestions && Array.isArray(data.userQuestions)) {
              allUserQuestions = allUserQuestions.concat(data.userQuestions);
            }
          }
        });
        
        // Also check old trainingEntries subcollection for backwards compatibility
        const trainingEntriesSnapshot = await db.collection('userTraining')
          .doc(userId)
          .collection('trainingEntries')
          .get();
          
        trainingEntriesSnapshot.forEach(doc => {
          const data = doc.data();
          
          if (!selectedCompetition || selectedCompetition === 'general' || data.competition === selectedCompetition) {
            if (data.content) {
              combinedContent += data.content + '\n\n';
            }
            
            if (data.userQuestions && Array.isArray(data.userQuestions)) {
              allUserQuestions = allUserQuestions.concat(data.userQuestions);
            }
          }
        });
        
        console.log(`Found ${entriesSnapshot.size + trainingEntriesSnapshot.size} total entries`);
        console.log(`Combined content length: ${combinedContent.length} characters`);
        console.log(`Total user questions: ${allUserQuestions.length}`);
        
        return {
          pdfContent: combinedContent.trim(),
          userQuestions: allUserQuestions
        };
        
      } catch (error) {
        console.error('Error getting all training entries:', error);
        return {
          pdfContent: '',
          userQuestions: []
        };
      }
    }

    async function getLatestKeyChanges(competitionName) {
      if (!competitionName) return null;
      
      try {
        const snapshot = await db.collection('competition-submissions')
          .where('competition', '==', competitionName)
          .orderBy('processedAt', 'desc')
          .limit(1)
          .get();
        
        if (!snapshot.empty) {
          const latestDoc = snapshot.docs[0].data();
          return latestDoc.keyChanges || null;
        }
        
        return null;
      } catch (error) {
        console.error('Error fetching latest key changes:', error);
        return null;
      }
    }

    async function getCompetenciesFromLatestSubmission(competitionName) {
      if (!competitionName) {
        console.log(' No competition name provided');
        return [];
      }
      
      try {
        console.log(' Searching for submissions for competition:', competitionName);
        
        const snapshot = await db.collection('competition-submissions')
          .where('competition', '==', competitionName)
          .orderBy('processedAt', 'desc')
          .limit(1)
          .get();
        
        console.log(' Snapshot empty?', snapshot.empty);
        console.log(' Number of docs found:', snapshot.size);
        
        if (!snapshot.empty) {
          const latestDoc = snapshot.docs[0].data();
          const extractedCompetencies = latestDoc.extractedCompetencies;
          
          console.log(' Raw extractedCompetencies:', extractedCompetencies);
          
          if (extractedCompetencies) {
            const competencyLines = extractedCompetencies
              .split('\n')
              .filter(line => /^[A-Z]\.\s+/.test(line.trim()))
              .map(line => line.replace(/^[A-Z]\.\s*/, '').trim())
              .filter(comp => comp.length > 0);
            
            console.log(' Extracted competency lines:', competencyLines);
            return competencyLines;
          }
        }
        
        return [];
      } catch (error) {
        console.error('Error fetching competencies from latest submission:', error);
        return [];
      }
    }

    async function generateDartsQuestionsBatch(count = 10) {
      // Generate multiple questions at once
      try {
        // Get competition - try to get from user's competitions array or use 'general'
        let selectedCompetition = 'general';
        try {
          const userId = getCurrentUserId();
          console.log(' Getting competition for user:', userId);
          if (userId) {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
              const userData = userDoc.data();
              console.log(' Full user data:', userData);
              
              // Check competitions array first (plural)
              if (userData.competitions && Array.isArray(userData.competitions) && userData.competitions.length > 0) {
                selectedCompetition = userData.competitions[0];
                console.log(' Found competition in competitions array:', selectedCompetition);
              } else if (userData.currentCompetition) {
                selectedCompetition = userData.currentCompetition;
                console.log(' Found competition in currentCompetition field:', selectedCompetition);
              } else if (userData.competition) {
                selectedCompetition = userData.competition;
                console.log(' Found competition in competition field:', selectedCompetition);
              } else {
                console.log(' No competition found in user data, using general');
              }
              
              console.log(' Competition fields checked:', {
                competitions: userData.competitions,
                currentCompetition: userData.currentCompetition,
                competition: userData.competition,
                selected: selectedCompetition
              });
            } else {
              console.log(' User document does not exist');
            }
          } else {
            console.log(' No user ID found');
          }
        } catch (e) {
          console.log(' Could not get user competition, using general:', e);
        }
        
        console.log(' Using competition for question generation:', selectedCompetition);

        // Get training data from Firebase (includes baseline)
        const trainingData = await getAllTrainingEntries(selectedCompetition);
        
        // Get latest key changes for this competition
        const latestKeyChanges = await getLatestKeyChanges(selectedCompetition);
        
        // Get dynamic competencies from latest submission
        const dynamicCompetencies = await getCompetenciesFromLatestSubmission(selectedCompetition);
        
        if (!trainingData || !trainingData.pdfContent) {
          console.log('No training data available, using fallback questions');
          // Return fallback questions
          const fallbacks = [];
          for (let i = 0; i < count; i++) {
            fallbacks.push({
              question: "What is the primary purpose of parliamentary procedure?",
              options: [
                "To make meetings more efficient",
                "To give the president more power",
                "To eliminate debate",
                "To make meetings longer"
              ],
              correct: 0,
              competency: "Parliamentary Procedure"
            });
          }
          return fallbacks;
        }
        
        // Build context-aware prompt - let AI determine competencies from content
        let prompt = `Generate ${count} FBLA multiple choice questions using concepts from the study material, but make each question completely standalone.

CRITICAL REQUIREMENTS:
- Difficulty: Medium
- Each question must have exactly 4 options
- Extract concepts from the study material but create original standalone questions
- Make questions realistic for FBLA competitions
- YOU must determine which FBLA competency each question belongs to based on the content`;

        // Add key changes to prompt if available
        if (latestKeyChanges) {
          prompt += `\n\nIMPORTANT RECENT CHANGES TO CONSIDER:
${latestKeyChanges}
Please incorporate these changes/updates when creating questions.`;
        }

        prompt += `\n\nABSOLUTE RULES - NEVER VIOLATE THESE:
- FORBIDDEN PHRASES: "the agreement", "the document", "the passage", "according to", "as stated", "mentioned above", "the text", "as specified", "the contract", "this document", "the material", "the content", "as outlined", "as described"
- NEVER ask what documents say, specify, outline, or contain
- DO use specific names, places, companies, activities, amounts, dates directly from the content
- Present specific details as if they are established facts, not as sourced from a document
- Ask about the specific things mentioned, not about what was mentioned

DIFFICULTY GUIDELINES:
- Easy: Straightforward definitions, basic concepts, obvious answers
- Medium: Application of concepts, moderate analysis, some calculation or reasoning required
- Hard: Complex scenarios, multiple concepts combined, requires deep understanding, tricky distractors that seem plausible

Study Material (USE CONCEPTS ONLY, DON'T REFERENCE):
${trainingData.pdfContent.substring(0, 5000)}`;

        // Add existing questions as style examples
        if (trainingData.userQuestions.length > 0) {
          prompt += `\n\nExample Question Style (note how they don't reference external material):`;
          trainingData.userQuestions.slice(0, 2).forEach((q, i) => {
            prompt += `\n${i + 1}. ${q.text}`;
          });
        }

        // Use dynamic competencies if available, otherwise use default FBLA competencies
        if (dynamicCompetencies.length > 0) {
          prompt += `\n\nAnalyze the study material concepts and create questions that naturally fit these specific competencies extracted from the latest submission:
${dynamicCompetencies.map(comp => `- ${comp}`).join('\n')}`;
        } else {
          prompt += `\n\nAnalyze the study material concepts and create questions that naturally fit these FBLA competencies:
- Business Communication
- Marketing
- Accounting
- Economics
- Business Law
- Management
- Entrepreneurship
- Finance
- International Business
- Business Ethics
- Parliamentary Procedure`;
        }

        prompt += `\n\nEXAMPLES - USE SPECIFIC CONTENT DIRECTLY WITHOUT REFERENCING THE SOURCE:

 FORBIDDEN: "What is the role of the Club in the Activities as specified in the agreement?"
 CORRECT: "What is San Jose Sharks' primary responsibility regarding participant safety during ice skating activities?"

 FORBIDDEN: "According to the document, what venue is mentioned?"
 CORRECT: "What safety requirements must be met at San Jose Arena for ice skating activities?"

 FORBIDDEN: "The agreement states activities include which of the following?"
 CORRECT: "Which of the following activities are typically included in ice skating programs: warm-ups, drills, games, or spectating?"

 FORBIDDEN: "As outlined in the contract, what are the liability provisions?"
 CORRECT: "What types of injuries would be covered under a comprehensive liability waiver for ice skating, gym activities, and athletic field exercises?"

 FORBIDDEN: "The document mentions compensation. What does it specify?"
 CORRECT: "What is the standard compensation structure for participants in recreational ice skating programs?"

USE the specific details (San Jose Sharks, ice skating, specific activities, etc.) but ask about them directly, not about what the document says about them.`;

        prompt += `\n\nReturn ONLY a JSON array in this exact format:
[
  {
    "text": "Question text here?",
    "competency": "Business Communication",
    "correctAnswer": "Correct option text",
    "options": ["Option A", "Option B", "Option C", "Option D"],
    "difficulty": "Medium",
    "source": "training_content"
  }
]`;

        const response = await firebase.functions().httpsCallable("generateQuestionsWithAI")({
          messages: [
            {
              role: 'system',
              content: `You are an expert FBLA exam question writer. Use specific names, companies, activities, amounts, and details directly from the study material in your questions. Never reference the source document itself. If the content mentions "San Jose Sharks" and "ice skating activities", ask about San Jose Sharks and ice skating directly. Present all specific details as established facts. Forbidden phrases: "the agreement", "as specified", "the document", "according to". Create questions about the specific content, not about what the content says. Always return valid JSON only.`
            },
            {
              role: 'user',
              content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt
            }
          ],
          temperature: 0.7,
          max_tokens: 4000
        });

        const data = response.data;
        let content = data.content || data.choices?.[0]?.message?.content || data;
        
        if (typeof content !== 'string') {
          content = JSON.stringify(content);
        }
        
        content = content.trim();
        content = content.replace(/```json|```/g, "");
        const jsonStart = content.indexOf('[');
        const jsonEnd = content.lastIndexOf(']') + 1;
        
        if (jsonStart !== -1 && jsonEnd > jsonStart) {
          content = content.slice(jsonStart, jsonEnd);
        }
        
        const generated = JSON.parse(content);
        const questions = [];
        
        if (generated && Array.isArray(generated)) {
          generated.forEach(q => {
            const correctIndex = q.options.findIndex(opt => opt === q.correctAnswer);
            questions.push({
              question: q.text,
              options: q.options,
              correct: correctIndex >= 0 ? correctIndex : 0,
              competency: q.competency || "General"
            });
          });
        }
        
        return questions;
      } catch (err) {
        console.error(" GPT error generating darts questions batch:", err);
        // Return fallback questions
        const fallbacks = [];
        for (let i = 0; i < count; i++) {
          fallbacks.push({
            question: "What is the primary purpose of parliamentary procedure?",
            options: [
              "To make meetings more efficient",
              "To give the president more power",
              "To eliminate debate",
              "To make meetings longer"
            ],
            correct: 0,
            competency: "Parliamentary Procedure"
          });
        }
        return fallbacks;
      }
    }


    async function loadDartsQuestion(isNewQuestion = true) {
      if (isNewQuestion) {
        // Load from queue (instant, no waiting)
        loadDartsQuestionFromQueue();
      } else {
        // Load from history
        if (dartsCurrentQuestionIndex >= 0 && dartsCurrentQuestionIndex < dartsQuestionHistory.length) {
          const questionToLoad = dartsQuestionHistory[dartsCurrentQuestionIndex].question;
          displayDartsQuestion(questionToLoad);
        }
      }
    }

    function createDartsQuizStars() {
      const container = document.getElementById('dartsQuizStarsContainer');
      if (!container) return;
      
      container.innerHTML = '';
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'practice-quiz-star';
        const size = Math.random() * 2 + 1;
        const duration = 2 + Math.random() * 3;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.5 + 0.2;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `practice-quiz-twinkle ${duration}s infinite`;
        star.style.animationDelay = delay + 's';
        
        container.appendChild(star);
      }
    }

    function dartsSelectAnswer(index) {
      const currentQuestion = is2048QuizMode ? game2048State.currentQuestion : dartsCurrentQuestion;
      if (dartsGameState.quizAnswered || !currentQuestion) return;

      dartsGameState.quizSelectedAnswer = index;
      dartsGameState.quizAnswered = true;
      
      // Update history
      const questionHistory = is2048QuizMode ? game2048State.questionHistory : dartsQuestionHistory;
      const currentQuestionIndex = is2048QuizMode ? game2048State.currentQuestionIndex : dartsCurrentQuestionIndex;
      const historyItem = questionHistory[currentQuestionIndex];
      historyItem.answered = true;
      historyItem.selectedAnswer = index;
      historyItem.isCorrect = index === currentQuestion.correct;

      const options = document.querySelectorAll('#dartsQuizOptions .practice-quiz-option-btn');
      
      options.forEach((opt, idx) => {
        opt.disabled = true;
        const radio = opt.querySelector('.practice-quiz-option-radio');
        if (idx === currentQuestion.correct) {
          opt.classList.add('selected');
          radio.classList.add('selected');
          radio.innerHTML = '<div class="practice-quiz-option-dot"></div>';
        } else if (idx === index) {
          opt.style.background = 'rgba(239, 68, 68, 0.3)';
          opt.style.borderColor = 'rgba(239, 68, 68, 0.7)';
        }
      });

      // Show next button
      document.getElementById('dartsQuizNextBtn').style.display = 'block';

      if (index === currentQuestion.correct) {
        // Correct answer
        if (is2048QuizMode) {
          // For 2048 mode: increment questions answered
          game2048State.questionsAnswered++;
          
          // After 5 correct answers, expand the grid
          if (game2048State.questionsAnswered >= 5) {
            setTimeout(() => {
              expand2048Grid();
            }, 1500);
          } else {
            // Auto-advance to next question
            setTimeout(() => {
              loadDartsQuestion(true);
            }, 1000);
          }
        } else {
          // For darts mode: increment score and auto-advance
          dartsGameState.quizQuestionsCorrect++;
          setTimeout(() => {
            loadDartsQuestion(true);
          }, 1000);
        }
      } else {
        // Wrong answer
        if (is2048QuizMode) {
          // For 2048 mode: break a heart
          if (game2048State.hearts > 0) {
            game2048State.hearts--;
            const heart = document.getElementById(`dartsHeart${game2048State.hearts + 1}`);
            if (heart) {
              heart.classList.add('breaking');
              setTimeout(() => {
                heart.classList.add('broken');
                heart.classList.remove('breaking');
              }, 500);
            }
            
            // If all hearts broken, expand grid anyway (but smaller expansion)
            if (game2048State.hearts <= 0) {
              setTimeout(() => {
                expand2048Grid();
              }, 1500);
            } else {
              // Continue to next question
              setTimeout(() => {
                loadDartsQuestion(true);
              }, 1500);
            }
          }
        } else {
          // For darts mode: break a heart
          breakDartsHeart();
        }
      }
    }

    function breakDartsHeart() {
      if (dartsHearts <= 0) return;
      
      dartsHearts--;
      const heart = document.getElementById(`dartsHeart${dartsHearts + 1}`);
      if (heart) {
        heart.classList.add('breaking');
        setTimeout(() => {
          heart.classList.remove('breaking');
          heart.classList.add('broken');
        }, 500);
      }
      
      // If all hearts broken, start darts game
      if (dartsHearts === 0) {
        setTimeout(() => {
          dartsGameState.targetScore = dartsGameState.quizQuestionsCorrect * 10;
          startDartsGamePhase();
        }, 1000);
      }
    }

    function dartsNextQuestion() {
      if (dartsCurrentQuestionIndex < dartsQuestionHistory.length - 1) {
        // Go to next question in history
        dartsCurrentQuestionIndex++;
        loadDartsQuestion(false);
      } else {
        // Generate new question
        loadDartsQuestion(true);
      }
    }
    
    function dartsPreviousQuestion() {
      if (dartsCurrentQuestionIndex > 0) {
        dartsCurrentQuestionIndex--;
        loadDartsQuestion(false);
      }
    }
    window.dartsPreviousQuestion = dartsPreviousQuestion;

    function startDartsGamePhase() {
      showDartsPhase('game');
      dartsGameState.dartScore = 0;
      dartsGameState.dartsThrown = 0;
      dartsGameState.lastHit = '';
      dartsGameState.stuckDarts = [];
      dartsGameState.timeLeft = dartsGameState.targetScore;
      dartsGameState.isAnimating = false;

      document.getElementById('dartsTargetScore').textContent = dartsGameState.targetScore;
      document.getElementById('dartsCurrentScore').textContent = '0';
      document.getElementById('dartsTimeLeft').textContent = dartsGameState.timeLeft;

      // Start timer
      if (dartsGameState.timerInterval) {
        clearInterval(dartsGameState.timerInterval);
      }
      dartsGameState.timerInterval = setInterval(() => {
        dartsGameState.timeLeft--;
        document.getElementById('dartsTimeLeft').textContent = dartsGameState.timeLeft;
        if (dartsGameState.timeLeft <= 0) {
          clearInterval(dartsGameState.timerInterval);
          endDartsGame();
        }
      }, 1000);

      initDartsBoard();
    }

    function initDartsBoard() {
      const canvas = document.getElementById('dartsBoardCanvas');
      const dartCanvas = document.getElementById('dartsDartCanvas');
      if (!canvas || !dartCanvas) return;

      const ctx = canvas.getContext('2d');
      const dartCtx = dartCanvas.getContext('2d');
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;

      const numbers = [20, 1, 18, 4, 13, 6, 10, 15, 2, 17, 3, 19, 7, 16, 8, 11, 14, 9, 12, 5];
      const colors = ['#000000', '#FF5722'];
      
      const bullseyeRadius = 11;
      const outerBullRadius = 29;
      const tripleInnerRadius = 121;
      const tripleOuterRadius = 136;
      const doubleInnerRadius = 186;
      const doubleOuterRadius = 200;
      const outerRadius = 207;

      function drawSegment(startAngle, endAngle, innerRadius, outerRadius, color, glow = false) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, outerRadius, startAngle, endAngle);
        ctx.arc(centerX, centerY, innerRadius, endAngle, startAngle, true);
        ctx.closePath();
        
        if (glow && color === '#FF5722') {
          ctx.shadowColor = '#FF5722';
          ctx.shadowBlur = 15;
        }
        
        ctx.fillStyle = color;
        ctx.fill();
        ctx.shadowBlur = 0;
      }

      function drawCircle(radius, color, glow = false) {
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        
        if (glow) {
          ctx.shadowColor = color;
          ctx.shadowBlur = 20;
        }
        
        ctx.fillStyle = color;
        ctx.fill();
        ctx.shadowBlur = 0;
      }

      function drawNumber(number, angle, radius) {
        const x = centerX + Math.cos(angle) * radius;
        const y = centerY + Math.sin(angle) * radius;
        
        ctx.save();
        ctx.translate(x, y);
        ctx.fillStyle = '#FF5722';
        ctx.font = 'bold 28px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = '#FF5722';
        ctx.shadowBlur = 10;
        ctx.fillText(number, 0, 0);
        ctx.restore();
      }

      function draw3DDart(context, x, y, angle, scale = 1) {
        context.save();
        context.translate(x, y);
        context.rotate(angle);
        context.scale(scale, scale);

        const flightGradient1 = context.createLinearGradient(-25, -18, -25, 0);
        flightGradient1.addColorStop(0, '#CC0000');
        flightGradient1.addColorStop(1, '#FF0000');
        
        context.fillStyle = flightGradient1;
        context.beginPath();
        context.moveTo(-30, 0);
        context.lineTo(-55, -25);
        context.lineTo(-38, -4);
        context.closePath();
        context.fill();
        
        context.strokeStyle = '#990000';
        context.lineWidth = 1.5;
        context.stroke();

        const flightGradient2 = context.createLinearGradient(-25, 0, -25, 18);
        flightGradient2.addColorStop(0, '#FF0000');
        flightGradient2.addColorStop(1, '#CC0000');
        
        context.fillStyle = flightGradient2;
        context.beginPath();
        context.moveTo(-30, 0);
        context.lineTo(-55, 25);
        context.lineTo(-38, 4);
        context.closePath();
        context.fill();
        
        context.strokeStyle = '#990000';
        context.stroke();

        const shaftGradient = context.createLinearGradient(-12, -2, -12, 2);
        shaftGradient.addColorStop(0, '#333333');
        shaftGradient.addColorStop(0.5, '#1a1a1a');
        shaftGradient.addColorStop(1, '#333333');
        
        context.fillStyle = shaftGradient;
        context.beginPath();
        context.moveTo(-30, -2);
        context.lineTo(-12, -3);
        context.lineTo(-12, 3);
        context.lineTo(-30, 2);
        context.closePath();
        context.fill();

        const barrelGradient = context.createLinearGradient(-12, -5, -12, 5);
        barrelGradient.addColorStop(0, '#2a2a2a');
        barrelGradient.addColorStop(0.15, '#4a4a4a');
        barrelGradient.addColorStop(0.5, '#666666');
        barrelGradient.addColorStop(0.85, '#4a4a4a');
        barrelGradient.addColorStop(1, '#2a2a2a');
        
        context.fillStyle = barrelGradient;
        context.beginPath();
        context.moveTo(-12, -4);
        context.lineTo(-6, -5);
        context.lineTo(-6, 5);
        context.lineTo(-12, 4);
        context.closePath();
        context.fill();

        context.strokeStyle = '#1a1a1a';
        context.lineWidth = 0.7;
        for (let i = -11; i < -6; i += 1.5) {
          context.beginPath();
          context.moveTo(i, -4);
          context.lineTo(i, 4);
          context.stroke();
        }

        context.strokeStyle = 'rgba(255, 255, 255, 0.4)';
        context.lineWidth = 2;
        context.beginPath();
        context.moveTo(-11, -3);
        context.lineTo(-7, -4);
        context.stroke();

        const pointGradient = context.createLinearGradient(-6, -3, 3, 0);
        pointGradient.addColorStop(0, '#888888');
        pointGradient.addColorStop(0.3, '#C0C0C0');
        pointGradient.addColorStop(0.7, '#E8E8E8');
        pointGradient.addColorStop(1, '#B0B0B0');
        
        context.fillStyle = pointGradient;
        context.beginPath();
        context.moveTo(-6, -3);
        context.lineTo(3, -1);
        context.lineTo(3, 1);
        context.lineTo(-6, 3);
        context.closePath();
        context.fill();

        context.strokeStyle = '#666666';
        context.lineWidth = 0.7;
        context.beginPath();
        context.moveTo(-6, -3);
        context.lineTo(3, -1);
        context.lineTo(3, 1);
        context.lineTo(-6, 3);
        context.closePath();
        context.stroke();

        context.strokeStyle = 'rgba(255, 255, 255, 0.9)';
        context.lineWidth = 1.5;
        context.beginPath();
        context.moveTo(-5, -2);
        context.lineTo(2, -0.5);
        context.stroke();

        context.fillStyle = 'rgba(255, 255, 255, 0.7)';
        context.beginPath();
        context.arc(2, 0, 0.7, 0, Math.PI * 2);
        context.fill();

        context.restore();
      }

      function drawDartboard() {
        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const outerGlow = ctx.createRadialGradient(centerX, centerY, outerRadius, centerX, centerY, outerRadius + 30);
        outerGlow.addColorStop(0, 'rgba(255, 87, 34, 0.3)');
        outerGlow.addColorStop(1, 'rgba(255, 87, 34, 0)');
        ctx.fillStyle = outerGlow;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        drawCircle(outerRadius + 5, '#000000');

        const segmentAngle = (Math.PI * 2) / 20;
        const startOffset = -Math.PI / 2 - segmentAngle / 2;

        for (let i = 0; i < 20; i++) {
          const startAngle = startOffset + i * segmentAngle;
          const endAngle = startAngle + segmentAngle;
          const colorIndex = i % 2;
          const segmentColor = colors[colorIndex];
          const oppositeColor = colors[1 - colorIndex];
          const isOrangeRed = segmentColor === '#FF5722';
          const isOppositeOrange = oppositeColor === '#FF5722';

          drawSegment(startAngle, endAngle, tripleOuterRadius, doubleInnerRadius, oppositeColor, isOppositeOrange);
          drawSegment(startAngle, endAngle, outerBullRadius, tripleInnerRadius, segmentColor, isOrangeRed);
          drawSegment(startAngle, endAngle, tripleInnerRadius, tripleOuterRadius, oppositeColor, isOppositeOrange);
          drawSegment(startAngle, endAngle, doubleInnerRadius, doubleOuterRadius, segmentColor, isOrangeRed);
        }

        drawCircle(outerBullRadius, '#FF5722', true);
        ctx.shadowColor = '#FF3D00';
        ctx.shadowBlur = 25;
        drawCircle(bullseyeRadius, '#FF3D00');
        ctx.shadowBlur = 0;

        ctx.strokeStyle = '#444444';
        ctx.lineWidth = 2;

        [outerRadius, doubleOuterRadius, doubleInnerRadius, 
         tripleOuterRadius, tripleInnerRadius, outerBullRadius, bullseyeRadius].forEach(radius => {
          ctx.beginPath();
          ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
          ctx.stroke();
        });

        for (let i = 0; i < 20; i++) {
          const angle = startOffset + i * segmentAngle;
          const x1 = centerX + Math.cos(angle) * outerBullRadius;
          const y1 = centerY + Math.sin(angle) * outerBullRadius;
          const x2 = centerX + Math.cos(angle) * outerRadius;
          const y2 = centerY + Math.sin(angle) * outerRadius;
          
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();
        }

        const numberRadius = 225;
        for (let i = 0; i < 20; i++) {
          const angle = startOffset + i * segmentAngle + segmentAngle / 2;
          drawNumber(numbers[i], angle, numberRadius);
        }

        dartsGameState.stuckDarts.forEach(dart => {
          draw3DDart(ctx, dart.x, dart.y, dart.angle, 1);
        });
      }

      function getScore(x, y) {
        const dx = x - centerX;
        const dy = y - centerY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance <= bullseyeRadius) {
          return { score: 50, zone: 'Double Bull' };
        }
        if (distance <= outerBullRadius) {
          return { score: 25, zone: 'Single Bull' };
        }
        if (distance > outerRadius) {
          return { score: 0, zone: 'Miss' };
        }

        let angle = Math.atan2(dy, dx) + Math.PI / 2;
        if (angle < 0) angle += Math.PI * 2;
        
        const segmentAngle = (Math.PI * 2) / 20;
        const segmentIndex = Math.floor((angle + segmentAngle / 2) / segmentAngle) % 20;
        const baseScore = numbers[segmentIndex];

        let multiplier = 1;
        let zone = 'Single';

        if (distance >= tripleInnerRadius && distance <= tripleOuterRadius) {
          multiplier = 3;
          zone = 'Triple';
        } else if (distance >= doubleInnerRadius && distance <= doubleOuterRadius) {
          multiplier = 2;
          zone = 'Double';
        }

        return { score: baseScore * multiplier, zone: `${zone} ${baseScore}` };
      }

      function animateDartThrow(targetX, targetY) {
        if (dartsGameState.isAnimating) return;
        dartsGameState.isAnimating = true;

        const accuracy = 0.7;
        const randomOffset = Math.random() > accuracy ? (Math.random() - 0.5) * 80 : 0;
        const angleOffset = Math.random() > accuracy ? (Math.random() - 0.5) * Math.PI / 4 : 0;
        
        const offsetDist = Math.sqrt(randomOffset * randomOffset);
        const finalTargetX = targetX + Math.cos(angleOffset) * offsetDist;
        const finalTargetY = targetY + Math.sin(angleOffset) * offsetDist;

        const startX = centerX;
        const startY = canvas.height + 50;
        
        const duration = 800;
        const startTime = Date.now();

        function animate() {
          const elapsed = Date.now() - startTime;
          const progress = Math.min(elapsed / duration, 1);

          const easeOut = 1 - Math.pow(1 - progress, 3);

          const currentX = startX + (finalTargetX - startX) * easeOut;
          const currentY = startY + (finalTargetY - startY) * easeOut - Math.sin(progress * Math.PI) * 100;

          const angle = Math.atan2(finalTargetY - currentY, finalTargetX - currentX);

          const scale = 1 + progress * 0.3;

          dartCtx.clearRect(0, 0, dartCanvas.width, dartCanvas.height);

          if (progress < 1) {
            draw3DDart(dartCtx, currentX, currentY, angle, scale);
            requestAnimationFrame(animate);
          } else {
            const finalAngle = Math.atan2(finalTargetY - centerY, finalTargetX - centerX);
            dartsGameState.stuckDarts.push({ x: finalTargetX, y: finalTargetY, angle: finalAngle });
            
            const result = getScore(finalTargetX, finalTargetY);
            dartsGameState.lastHit = `${result.zone}: ${result.score} points!`;
            dartsGameState.dartScore += result.score;
            dartsGameState.dartsThrown++;
            
            document.getElementById('dartsLastHit').textContent = dartsGameState.lastHit;
            document.getElementById('dartsCurrentScore').textContent = dartsGameState.dartScore;
            
            drawDartboard();
            
            setTimeout(() => {
              dartCtx.clearRect(0, 0, dartCanvas.width, dartCanvas.height);
              draw3DDart(dartCtx, centerX, canvas.height - 80, -Math.PI / 2, 1.5);
              dartsGameState.isAnimating = false;
            }, 300);
          }
        }

        animate();
      }

      canvas.addEventListener('click', (e) => {
        if (dartsGameState.isAnimating || dartsGameState.timeLeft <= 0) return;
        
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        animateDartThrow(x, y);
      });

      drawDartboard();
      draw3DDart(dartCtx, centerX, canvas.height - 80, -Math.PI / 2, 1.5);
    }

    function endDartsGame() {
      if (dartsGameState.timerInterval) {
        clearInterval(dartsGameState.timerInterval);
      }
      
      const modal = document.getElementById('dartsResultsModal');
      if (modal) {
        modal.classList.add('active');
        document.getElementById('dartsResultsTarget').textContent = dartsGameState.targetScore;
        document.getElementById('dartsResultsFinal').textContent = dartsGameState.dartScore;
        document.getElementById('dartsResultsThrown').textContent = dartsGameState.dartsThrown;
        
        if (dartsGameState.dartScore >= dartsGameState.targetScore) {
          document.getElementById('dartsResultsWin').style.display = 'block';
        } else {
          document.getElementById('dartsResultsWin').style.display = 'none';
        }
      }
    }

    function resetDartsGame() {
      const container = document.getElementById('dartsGameContainer');
      const modal = document.getElementById('dartsResultsModal');
      const quizPhase = document.getElementById('dartsQuizPhase');
      if (container) container.classList.remove('active');
      if (modal) modal.classList.remove('active');
      if (quizPhase) quizPhase.style.display = 'none';
      document.body.style.overflow = 'auto';
      
      if (dartsGameState.timerInterval) {
        clearInterval(dartsGameState.timerInterval);
      }
      
      dartsGameState = {
        phase: 'menu',
        quizQuestionsCorrect: 0,
        quizSelectedAnswer: null,
        quizAnswered: false,
        dartScore: 0,
        dartsThrown: 0,
        lastHit: '',
        targetScore: 0,
        timeLeft: 0,
        timerInterval: null,
        stuckDarts: [],
        isAnimating: false
      };
      
      dartsHearts = 3;
      dartsCurrentQuestion = null;
    }

    // Expose functions globally
    window.startDartsGame = startDartsGame;
    window.startDartsQuiz = startDartsQuiz;
    window.dartsSelectAnswer = dartsSelectAnswer;
    window.dartsNextQuestion = dartsNextQuestion;
    window.endDartsGame = endDartsGame;
    window.resetDartsGame = resetDartsGame;

    // ============ 2048 GAME ============
    let game2048State = {
      grid: [],
      gridSize: 3,
      score: 0,
      best: 0,
      moveCount: 0,
      mergesThisMove: [],
      questionQueue: [],
      isGeneratingQuestions: false,
      questionHistory: [],
      currentQuestionIndex: -1,
      currentQuestion: null,
      hearts: 3,
      questionsAnswered: 0
    };

    function create2048Stars() {
      const container = document.getElementById('game2048StarsContainer');
      if (!container) return;
      
      container.innerHTML = '';
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'game2048-star';
        
        const size = Math.random() * 2 + 1;
        const duration = 2 + Math.random() * 3;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.5 + 0.2;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `game2048-twinkle ${duration}s infinite`;
        star.style.animationDelay = delay + 's';
        
        container.appendChild(star);
      }
    }

    function start2048Game() {
      const container = document.getElementById('game2048Container');
      if (container) {
        container.classList.add('active');
        container.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Create stars background
        create2048Stars();
        
        // Load best score
        game2048State.best = parseInt(localStorage.getItem('best2048')) || 0;
        const bestEl = document.getElementById('game2048Best');
        if (bestEl) bestEl.textContent = game2048State.best;
        
        init2048Game();
      }
    }
    window.start2048Game = start2048Game;

    function init2048Game() {
      game2048State.gridSize = 3;
      game2048State.grid = Array(3).fill().map(() => Array(3).fill(0));
      game2048State.score = 0;
      game2048State.moveCount = 0;
      game2048State.mergesThisMove = [];
      game2048State.questionQueue = [];
      game2048State.questionHistory = [];
      game2048State.currentQuestionIndex = -1;
      game2048State.currentQuestion = null;
      game2048State.hearts = 3;
      game2048State.questionsAnswered = 0;
      
      const scoreEl = document.getElementById('game2048Score');
      if (scoreEl) scoreEl.textContent = '0';
      
      const gameOverEl = document.getElementById('game2048Over');
      if (gameOverEl) {
        gameOverEl.classList.remove('active');
        gameOverEl.style.display = 'none';
      }
      
      // Rebuild grid HTML
      const gameGrid = document.getElementById('game2048Grid');
      if (gameGrid) {
        gameGrid.innerHTML = '';
        
        for (let i = 0; i < 3; i++) {
          const row = document.createElement('div');
          row.className = 'game2048-grid-row';
          
          for (let j = 0; j < 3; j++) {
            const cell = document.createElement('div');
            cell.className = 'game2048-grid-cell';
            cell.setAttribute('data-row', i);
            cell.setAttribute('data-col', j);
            row.appendChild(cell);
          }
          
          gameGrid.appendChild(row);
        }
      }
      
      add2048NewTile();
      add2048NewTile();
      update2048Display();
      
      // Pre-generate questions
      maintain2048QuestionQueue();
    }

    function add2048NewTile() {
      const emptyCells = [];
      for (let i = 0; i < game2048State.gridSize; i++) {
        for (let j = 0; j < game2048State.gridSize; j++) {
          if (game2048State.grid[i][j] === 0) {
            emptyCells.push({row: i, col: j});
          }
        }
      }
      
      if (emptyCells.length > 0) {
        const {row, col} = emptyCells[Math.floor(Math.random() * emptyCells.length)];
        game2048State.grid[row][col] = Math.random() < 0.9 ? 2 : 4;
        
        setTimeout(() => {
          update2048Display();
          const cell = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
          if (cell) {
            const tile = cell.querySelector('.game2048-tile');
            if (tile) tile.classList.add('game2048-new-tile');
          }
        }, 10);
      }
    }

    function update2048Display() {
      for (let i = 0; i < game2048State.gridSize; i++) {
        for (let j = 0; j < game2048State.gridSize; j++) {
          const cell = document.querySelector(`[data-row="${i}"][data-col="${j}"]`);
          if (!cell) continue;
          const value = game2048State.grid[i][j];
          
          cell.innerHTML = '';
          
          if (value > 0) {
            const tile = document.createElement('div');
            tile.className = `game2048-tile game2048-tile-${value}`;
            tile.textContent = value;
            cell.appendChild(tile);
          }
        }
      }
    }

    function move2048(direction) {
      let moved = false;
      const oldGrid = JSON.stringify(game2048State.grid);
      game2048State.mergesThisMove = [];

      if (direction === 'left') {
        for (let i = 0; i < game2048State.gridSize; i++) {
          const row = game2048State.grid[i].filter(val => val !== 0);
          const newRow = [];
          
          for (let j = 0; j < row.length; j++) {
            if (j < row.length - 1 && row[j] === row[j + 1]) {
              const mergedValue = row[j] * 2;
              newRow.push(mergedValue);
              game2048State.mergesThisMove.push({row: i, col: newRow.length - 1, value: mergedValue});
              game2048State.score += mergedValue;
              j++;
            } else {
              newRow.push(row[j]);
            }
          }
          
          while (newRow.length < game2048State.gridSize) newRow.push(0);
          game2048State.grid[i] = newRow;
        }
      } else if (direction === 'right') {
        for (let i = 0; i < game2048State.gridSize; i++) {
          const row = game2048State.grid[i].filter(val => val !== 0);
          const newRow = [];
          
          for (let j = row.length - 1; j >= 0; j--) {
            if (j > 0 && row[j] === row[j - 1]) {
              const mergedValue = row[j] * 2;
              newRow.unshift(mergedValue);
              game2048State.mergesThisMove.push({row: i, col: game2048State.gridSize - newRow.length, value: mergedValue});
              game2048State.score += mergedValue;
              j--;
            } else {
              newRow.unshift(row[j]);
            }
          }
          
          while (newRow.length < game2048State.gridSize) newRow.unshift(0);
          game2048State.grid[i] = newRow;
        }
      } else if (direction === 'up') {
        for (let j = 0; j < game2048State.gridSize; j++) {
          const col = [];
          for (let i = 0; i < game2048State.gridSize; i++) {
            if (game2048State.grid[i][j] !== 0) col.push(game2048State.grid[i][j]);
          }
          
          const newCol = [];
          for (let i = 0; i < col.length; i++) {
            if (i < col.length - 1 && col[i] === col[i + 1]) {
              const mergedValue = col[i] * 2;
              newCol.push(mergedValue);
              game2048State.mergesThisMove.push({row: newCol.length - 1, col: j, value: mergedValue});
              game2048State.score += mergedValue;
              i++;
            } else {
              newCol.push(col[i]);
            }
          }
          
          while (newCol.length < game2048State.gridSize) newCol.push(0);
          for (let i = 0; i < game2048State.gridSize; i++) {
            game2048State.grid[i][j] = newCol[i];
          }
        }
      } else if (direction === 'down') {
        for (let j = 0; j < game2048State.gridSize; j++) {
          const col = [];
          for (let i = 0; i < game2048State.gridSize; i++) {
            if (game2048State.grid[i][j] !== 0) col.push(game2048State.grid[i][j]);
          }
          
          const newCol = [];
          for (let i = col.length - 1; i >= 0; i--) {
            if (i > 0 && col[i] === col[i - 1]) {
              const mergedValue = col[i] * 2;
              newCol.unshift(mergedValue);
              game2048State.mergesThisMove.push({row: game2048State.gridSize - newCol.length, col: j, value: mergedValue});
              game2048State.score += mergedValue;
              i--;
            } else {
              newCol.unshift(col[i]);
            }
          }
          
          while (newCol.length < game2048State.gridSize) newCol.unshift(0);
          for (let i = 0; i < game2048State.gridSize; i++) {
            game2048State.grid[i][j] = newCol[i];
          }
        }
      }

      if (JSON.stringify(game2048State.grid) !== oldGrid) {
        moved = true;
        game2048State.moveCount++;
        update2048Display();
        
        setTimeout(() => {
          game2048State.mergesThisMove.forEach(merge => {
            const cell = document.querySelector(`[data-row="${merge.row}"][data-col="${merge.col}"]`);
            const tile = cell?.querySelector('.game2048-tile');
            if (tile) {
              tile.classList.add('game2048-merge-tile');
            }
          });
        }, 50);
        
        const scoreEl = document.getElementById('game2048Score');
        if (scoreEl) scoreEl.textContent = game2048State.score;
        
        if (game2048State.score > game2048State.best) {
          game2048State.best = game2048State.score;
          const bestEl = document.getElementById('game2048Best');
          if (bestEl) bestEl.textContent = game2048State.best;
          localStorage.setItem('best2048', game2048State.best);
        }

        setTimeout(() => {
          add2048NewTile();
          update2048Display();
          setTimeout(() => {
            if (is2048GameOver()) {
              trigger2048GameOver();
            }
          }, 100);
        }, 150);
      } else {
        if (is2048GameOver()) {
          trigger2048GameOver();
        }
      }

      return moved;
    }

    function is2048GameOver() {
      for (let i = 0; i < game2048State.gridSize; i++) {
        for (let j = 0; j < game2048State.gridSize; j++) {
          if (game2048State.grid[i][j] === 0) {
            return false;
          }
        }
      }
      return true;
    }

    function trigger2048GameOver() {
      const gameOverEl = document.getElementById('game2048Over');
      if (gameOverEl) {
        gameOverEl.style.display = 'flex';
        gameOverEl.classList.add('active');
        const finalScoreEl = document.getElementById('game2048FinalScore');
        if (finalScoreEl) finalScoreEl.textContent = `Final Score: ${game2048State.score}`;
        const statsEl = document.getElementById('game2048Stats');
        if (statsEl) statsEl.innerHTML = `
          <div>Moves: ${game2048State.moveCount}</div>
          <div>Best Score: ${game2048State.best}</div>
        `;
      }
    }

    async function maintain2048QuestionQueue() {
      while (true) {
        if (game2048State.questionQueue.length < 5 && !game2048State.isGeneratingQuestions) {
          console.log(' 2048: Queue getting low, generating more questions...');
          game2048State.isGeneratingQuestions = true;
          const newQuestions = await generateDartsQuestionsBatch(10);
          game2048State.questionQueue.push(...newQuestions);
          game2048State.isGeneratingQuestions = false;
          console.log(` 2048: Added ${newQuestions.length} questions to queue. Total: ${game2048State.questionQueue.length}`);
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }

    function start2048Quiz() {
      // Hide 2048 game
      const container = document.getElementById('game2048Container');
      if (container) {
        container.classList.remove('active');
        container.style.display = 'none';
      }
      
      // Set flag to indicate we're in 2048 quiz mode
      is2048QuizMode = true;
      
      // Update quiz title
      const quizTitle = document.getElementById('dartsQuizTitle');
      if (quizTitle) {
        quizTitle.textContent = '2048 QUIZ';
      }
      
      // Update competency badge
      const competencyBadge = document.getElementById('dartsQuizCompetency');
      if (competencyBadge) {
        competencyBadge.textContent = '2048 CHALLENGE';
      }
      
      // Use the same quiz modal as darts
      showDartsPhase('quiz');
      game2048State.questionsAnswered = 0;
      game2048State.hearts = 3;
      game2048State.questionHistory = [];
      game2048State.currentQuestionIndex = -1;
      game2048State.currentQuestion = null;
      
      // Reset hearts
      for (let i = 1; i <= 3; i++) {
        const heart = document.getElementById(`dartsHeart${i}`);
        if (heart) {
          heart.classList.remove('broken', 'breaking');
        }
      }
      
      // Pre-generate questions immediately
      generateDartsQuestionsBatch(10).then(newQuestions => {
        game2048State.questionQueue.push(...newQuestions);
        console.log(` 2048: Added ${newQuestions.length} questions to queue. Total: ${game2048State.questionQueue.length}`);
        
        // Start background queue maintenance
        maintain2048QuestionQueue();
        
        // Load first question
        if (game2048State.questionQueue.length > 0) {
          loadDartsQuestionFromQueue();
        }
      }).catch(err => {
        console.error('Error generating 2048 questions:', err);
        // Start background queue maintenance anyway
        maintain2048QuestionQueue();
        // Try to load after a delay
        setTimeout(() => {
          loadDartsQuestionFromQueue();
        }, 2000);
      });
    }
    window.start2048Quiz = start2048Quiz;

    function expand2048Grid() {
      const oldSize = game2048State.gridSize;
      game2048State.gridSize = game2048State.gridSize + 1;
      
      console.log(`Expanding 2048 grid from ${oldSize}x${oldSize} to ${game2048State.gridSize}x${game2048State.gridSize}`);
      
      // Create new larger grid
      const newGrid = Array(game2048State.gridSize).fill().map(() => Array(game2048State.gridSize).fill(0));
      
      // Copy existing data to top-left corner
      for (let i = 0; i < oldSize; i++) {
        for (let j = 0; j < oldSize; j++) {
          newGrid[i][j] = game2048State.grid[i][j];
        }
      }
      
      // Replace old grid with new grid
      game2048State.grid = newGrid;
      
      // Rebuild the HTML grid
      const gameGrid = document.getElementById('game2048Grid');
      if (gameGrid) {
        gameGrid.innerHTML = '';
        
        for (let i = 0; i < game2048State.gridSize; i++) {
          const row = document.createElement('div');
          row.className = 'game2048-grid-row';
          
          for (let j = 0; j < game2048State.gridSize; j++) {
            const cell = document.createElement('div');
            cell.className = 'game2048-grid-cell';
            cell.setAttribute('data-row', i);
            cell.setAttribute('data-col', j);
            row.appendChild(cell);
          }
          
          gameGrid.appendChild(row);
        }
      }
      
      update2048Display();
      
      // Hide quiz and show game again
      showDartsPhase('menu');
      is2048QuizMode = false;
      
      const container = document.getElementById('game2048Container');
      if (container) {
        container.classList.add('active');
        container.style.display = 'flex';
      }
      
      // Show expansion modal
      setTimeout(() => {
        const expansionModal = document.getElementById('game2048ExpansionModal');
        const expansionMessage = document.getElementById('game2048ExpansionMessage');
        if (expansionModal && expansionMessage) {
          expansionMessage.textContent = `Grid expanded to ${game2048State.gridSize}x${game2048State.gridSize}!`;
          expansionModal.style.display = 'flex';
          expansionModal.classList.add('active');
        }
      }, 300);
    }

    // Keyboard controls for 2048
    document.addEventListener('keydown', (e) => {
      const container = document.getElementById('game2048Container');
      if (!container || !container.classList.contains('active')) return;
      
      if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.key)) {
        e.preventDefault();
        const directionMap = {
          'ArrowLeft': 'left',
          'ArrowRight': 'right',
          'ArrowUp': 'up',
          'ArrowDown': 'down'
        };
        move2048(directionMap[e.key]);
      }
    });

    // Touch controls for 2048
    let touch2048StartX = 0;
    let touch2048StartY = 0;

    document.addEventListener('touchstart', (e) => {
      const container = document.getElementById('game2048Container');
      if (!container || !container.classList.contains('active')) return;
      
      touch2048StartX = e.touches[0].clientX;
      touch2048StartY = e.touches[0].clientY;
    });

    document.addEventListener('touchend', (e) => {
      const container = document.getElementById('game2048Container');
      if (!container || !container.classList.contains('active')) return;
      
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      
      const dx = touchEndX - touch2048StartX;
      const dy = touchEndY - touch2048StartY;
      
      if (Math.abs(dx) > Math.abs(dy)) {
        if (dx > 30) move2048('right');
        else if (dx < -30) move2048('left');
      } else {
        if (dy > 30) move2048('down');
        else if (dy < -30) move2048('up');
      }
    });

    // Event listeners for 2048 and study mode button
    document.addEventListener('DOMContentLoaded', () => {
      const newGameBtn = document.getElementById('game2048NewGame');
      const restartBtn = document.getElementById('game2048Restart');
      const continueBtn = document.getElementById('game2048ContinueQuiz');
      const studyModeButton = document.getElementById('studyModeButton');
      
      if (newGameBtn) newGameBtn.addEventListener('click', init2048Game);
      if (restartBtn) restartBtn.addEventListener('click', init2048Game);
      if (continueBtn) {
        continueBtn.addEventListener('click', () => {
          // Hide game over modal
          const gameOverEl = document.getElementById('game2048Over');
          if (gameOverEl) {
            gameOverEl.style.display = 'none';
            gameOverEl.classList.remove('active');
          }
          // Start quiz
          start2048Quiz();
        });
      }
      
      // Add event listener for study mode button as fallback
      if (studyModeButton) {
        studyModeButton.addEventListener('click', () => {
          if (typeof openStudyModeModal === 'function') {
            openStudyModeModal();
          } else {
            console.error('openStudyModeModal is not defined');
          }
        });
      }
      
      // Add event listener for expansion modal close button
      const expansionCloseBtn = document.getElementById('game2048ExpansionClose');
      if (expansionCloseBtn) {
        expansionCloseBtn.addEventListener('click', () => {
          const expansionModal = document.getElementById('game2048ExpansionModal');
          if (expansionModal) {
            expansionModal.style.display = 'none';
            expansionModal.classList.remove('active');
          }
        });
      }
    });

    // ============ BLACKJACK GAME ============
    let blackjackGameState = {
      phase: 'menu', // menu, quiz, game
      currentQuestion: 0,
      questionsCorrect: 0,
      selectedAnswer: null,
      answered: false,
      bankroll: 0,
      currentBet: 0,
      playerHand: [],
      dealerHand: [],
      gameState: 'betting', // betting, playing, dealer-turn, result
      result: '',
      showResult: false,
      flippedCards: new Set(),
      deck: [],
      quizForContinue: false,
      questionQueue: [],
      questionHistory: [],
      currentQuestionIndex: -1,
      isGeneratingQuestions: false
    };

    function startBlackjackGame() {
      const container = document.getElementById('blackjackGameContainer');
      if (container) {
        container.style.display = 'flex';
        container.classList.add('active');
        createBlackjackStars();
        blackjackGameState.phase = 'menu';
        showBlackjackPhase('menu');
      }
    }
    window.startBlackjackGame = startBlackjackGame;

    function createBlackjackStars() {
      const container = document.getElementById('blackjackStarsBg');
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'blackjack-star';
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.5 + 0.2;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `blackjack-twinkle ${duration}s infinite`;
        star.style.animationDelay = delay + 's';
        
        container.appendChild(star);
      }
    }

    function showBlackjackPhase(phase) {
      const container = document.getElementById('blackjackGameContainer');
      if (!container) return;
      
      document.getElementById('blackjackMenuPhase').style.display = phase === 'menu' ? 'flex' : 'none';
      document.getElementById('blackjackQuizPhase').style.display = phase === 'quiz' ? 'flex' : 'none';
      document.getElementById('blackjackGamePhase').style.display = phase === 'game' ? 'block' : 'none';
      
      if (phase === 'quiz' || phase === 'game') {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = 'auto';
      }
      
      blackjackGameState.phase = phase;
    }

    async function startBlackjackQuiz() {
      blackjackGameState.questionsCorrect = 0;
      blackjackGameState.selectedAnswer = null;
      blackjackGameState.answered = false;
      blackjackGameState.currentQuestion = 0;
      blackjackGameState.questionQueue = [];
      blackjackGameState.questionHistory = [];
      blackjackGameState.currentQuestionIndex = -1;
      blackjackGameState.isGeneratingQuestions = false;
      
      showBlackjackPhase('quiz');
      
      // Create stars for quiz
      const starsContainer = document.getElementById('blackjackQuizStarsContainer');
      if (starsContainer) {
        starsContainer.innerHTML = '';
        for (let i = 0; i < 50; i++) {
          const star = document.createElement('div');
          star.className = 'practice-quiz-star';
          const size = Math.random() * 3 + 0.5;
          const duration = Math.random() * 4 + 2;
          const delay = Math.random() * 2;
          const randomLeft = Math.random() * 100;
          const randomTop = Math.random() * 100;
          const randomOpacity = Math.random() * 0.9 + 0.1;
          
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          star.style.left = randomLeft + '%';
          star.style.top = randomTop + '%';
          star.style.opacity = randomOpacity;
          star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
          star.style.animationDelay = delay + 's';
          star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
          
          starsContainer.appendChild(star);
        }
      }
      
      // Pre-generate questions
      console.log(' Pre-generating questions for Blackjack...');
      blackjackGameState.isGeneratingQuestions = true;
      const questions = await generateDartsQuestionsBatch(10);
      blackjackGameState.questionQueue = questions;
      blackjackGameState.isGeneratingQuestions = false;
      console.log(` Pre-generated ${questions.length} questions ready to use`);
      
      // Load first question
      loadBlackjackQuestionFromQueue();
      
      // Maintain question queue
      maintainBlackjackQuestionQueue();
    }
    window.startBlackjackQuiz = startBlackjackQuiz;

    async function maintainBlackjackQuestionQueue() {
      while (blackjackGameState.phase === 'quiz') {
        if (blackjackGameState.questionQueue.length < 5 && !blackjackGameState.isGeneratingQuestions) {
          console.log(' Queue getting low, generating more questions...');
          blackjackGameState.isGeneratingQuestions = true;
          const newQuestions = await generateDartsQuestionsBatch(10);
          blackjackGameState.questionQueue.push(...newQuestions);
          blackjackGameState.isGeneratingQuestions = false;
          console.log(` Added ${newQuestions.length} questions to queue. Total: ${blackjackGameState.questionQueue.length}`);
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }

    function loadBlackjackQuestionFromQueue() {
      if (blackjackGameState.questionQueue.length === 0) {
        console.log(' Queue empty, waiting for questions...');
        document.getElementById('blackjackQuizQuestion').textContent = 'Generating questions...';
        document.getElementById('blackjackQuizOptions').innerHTML = '<div style="text-align: center; color: #94a3b8;">Please wait...</div>';
        return;
      }
      
      const questionFromQueue = blackjackGameState.questionQueue.shift();
      
      blackjackGameState.questionHistory.push({
        question: questionFromQueue,
        answered: false,
        selectedAnswer: null,
        isCorrect: null
      });
      
      blackjackGameState.currentQuestionIndex = blackjackGameState.questionHistory.length - 1;
      blackjackGameState.currentQuestion = questionFromQueue;
      
      // Update title if in continue mode
      if (blackjackGameState.quizForContinue) {
        document.getElementById('blackjackQuizTitle').textContent = 'ANSWER TO CONTINUE';
      } else {
        document.getElementById('blackjackQuizTitle').textContent = 'BLACKJACK QUIZ';
      }
      
      displayBlackjackQuestion(questionFromQueue);
    }

    function displayBlackjackQuestion(question) {
      document.getElementById('blackjackQuizQuestion').textContent = question.text || question.question;
      
      // Update competency badge
      const competencyEl = document.getElementById('blackjackQuizCompetency');
      if (competencyEl && question.competency) {
        competencyEl.textContent = question.competency.toUpperCase();
      }
      
      // Update progress
      const totalQuestions = 5; // Show progress out of 5
      const progressPercent = Math.min((blackjackGameState.currentQuestionIndex + 1) / totalQuestions * 100, 100);
      document.getElementById('blackjackQuizProgress').textContent = `Question ${blackjackGameState.currentQuestionIndex + 1}`;
      document.getElementById('blackjackQuizProgressPercent').textContent = Math.min(blackjackGameState.currentQuestionIndex + 1, totalQuestions);
      document.getElementById('blackjackQuizProgressFill').style.width = progressPercent + '%';
      
      // Display options
      const optionsContainer = document.getElementById('blackjackQuizOptions');
      optionsContainer.innerHTML = '';
      
      const options = question.options || [];
      const correctAnswer = question.correctAnswer || question.correct;
      
      options.forEach((option, idx) => {
        const optionBtn = document.createElement('button');
        optionBtn.className = 'practice-quiz-option-btn';
        optionBtn.textContent = option;
        optionBtn.onclick = () => blackjackSelectAnswer(idx, question, correctAnswer);
        optionsContainer.appendChild(optionBtn);
      });
      
      // Reset state
      blackjackGameState.selectedAnswer = null;
      blackjackGameState.answered = false;
      document.getElementById('blackjackQuizNextBtn').style.display = 'none';
    }

    function blackjackSelectAnswer(index, question, correctAnswer) {
      if (blackjackGameState.answered) return;
      
      blackjackGameState.selectedAnswer = index;
      blackjackGameState.answered = true;
      
      const options = question.options || [];
      const isCorrect = (typeof correctAnswer === 'number' && index === correctAnswer) || 
                       (typeof correctAnswer === 'string' && options[index] === correctAnswer);
      
      // Update question history
      if (blackjackGameState.questionHistory[blackjackGameState.currentQuestionIndex]) {
        blackjackGameState.questionHistory[blackjackGameState.currentQuestionIndex].answered = true;
        blackjackGameState.questionHistory[blackjackGameState.currentQuestionIndex].selectedAnswer = index;
        blackjackGameState.questionHistory[blackjackGameState.currentQuestionIndex].isCorrect = isCorrect;
      }
      
      // Update UI
      const optionButtons = document.querySelectorAll('#blackjackQuizOptions .practice-quiz-option-btn');
      optionButtons.forEach((btn, idx) => {
        btn.disabled = true;
        if (idx === index) {
          btn.style.backgroundColor = isCorrect ? '#22c55e' : '#ef4444';
        } else if (typeof correctAnswer === 'number' && idx === correctAnswer) {
          btn.style.backgroundColor = '#22c55e';
        } else if (typeof correctAnswer === 'string' && options[idx] === correctAnswer) {
          btn.style.backgroundColor = '#22c55e';
        }
      });
      
      if (isCorrect) {
        if (blackjackGameState.quizForContinue) {
          // Adding chips for continue
          blackjackGameState.bankroll += 100;
          setTimeout(() => {
            blackjackGameState.quizForContinue = false;
            blackjackGameState.gameState = 'betting';
            blackjackGameState.currentQuestion = 0;
            blackjackGameState.selectedAnswer = null;
            blackjackGameState.answered = false;
            showBlackjackPhase('game');
            updateBlackjackUI();
          }, 1000);
          return;
        } else {
          blackjackGameState.questionsCorrect++;
        }
      } else {
        // Wrong answer
        if (blackjackGameState.quizForContinue) {
          // Wrong answer during continue - try next question
          setTimeout(() => {
            loadBlackjackQuestionFromQueue();
          }, 1000);
          return;
        } else if (blackjackGameState.questionsCorrect === 0) {
          // No correct answers, restart quiz
          setTimeout(() => {
            blackjackGameState.currentQuestion = 0;
            blackjackGameState.selectedAnswer = null;
            blackjackGameState.answered = false;
            loadBlackjackQuestionFromQueue();
          }, 1500);
          return;
        } else {
          // Start blackjack with bankroll
          const startingBankroll = blackjackGameState.questionsCorrect * 100;
          blackjackGameState.bankroll = startingBankroll;
          setTimeout(() => {
            showBlackjackPhase('game');
            updateBlackjackUI();
          }, 1500);
          return;
        }
      }
      
      // Show next button
      document.getElementById('blackjackQuizNextBtn').style.display = 'block';
    }
    window.blackjackSelectAnswer = blackjackSelectAnswer;

    function blackjackNextQuestion() {
      if (blackjackGameState.currentQuestionIndex + 1 >= 5) {
        // Reached 5 questions, start blackjack
        const startingBankroll = blackjackGameState.questionsCorrect * 100;
        blackjackGameState.bankroll = startingBankroll;
        showBlackjackPhase('game');
        updateBlackjackUI();
      } else {
        loadBlackjackQuestionFromQueue();
      }
    }
    window.blackjackNextQuestion = blackjackNextQuestion;

    function createDeck() {
      const suits = ['', '', '', ''];
      const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
      const newDeck = [];
      for (let suit of suits) {
        for (let rank of ranks) {
          newDeck.push({ rank, suit });
        }
      }
      return newDeck.sort(() => Math.random() - 0.5);
    }

    function getCardValue(card) {
      if (card.rank === 'A') return 11;
      if (['J', 'Q', 'K'].includes(card.rank)) return 10;
      return parseInt(card.rank);
    }

    function calculateHand(hand) {
      let total = 0;
      let aces = 0;
      for (let card of hand) {
        if (card.rank === 'A') aces++;
        total += getCardValue(card);
      }
      while (total > 21 && aces > 0) {
        total -= 10;
        aces--;
      }
      return total;
    }

    function updateBlackjackUI() {
      document.getElementById('blackjackBankroll').textContent = '$' + blackjackGameState.bankroll;
      document.getElementById('blackjackCurrentBet').textContent = '$' + blackjackGameState.currentBet;
      
      // Update bet buttons
      const betButtons = document.querySelectorAll('.blackjack-bet-btn');
      betButtons.forEach(btn => {
        const betAmount = parseInt(btn.textContent.replace('$', ''));
        if (betAmount > blackjackGameState.bankroll) {
          btn.disabled = true;
          btn.style.opacity = '0.5';
          btn.style.cursor = 'default';
        } else {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
        }
      });
    }

    function startNewHand() {
      const newDeck = createDeck();
      const player = [newDeck.pop(), newDeck.pop()];
      const dealer = [newDeck.pop(), newDeck.pop()];
      blackjackGameState.deck = newDeck;
      blackjackGameState.playerHand = player;
      blackjackGameState.dealerHand = dealer;
      blackjackGameState.flippedCards = new Set([0]); // Dealer's first card is face down
      blackjackGameState.gameState = 'playing';
      blackjackGameState.result = '';
      blackjackGameState.showResult = false;
      
      renderBlackjackCards();
      updateBlackjackHandTotals();
    }

    function renderBlackjackCards() {
      const dealerContainer = document.getElementById('blackjackDealerCards');
      const playerContainer = document.getElementById('blackjackPlayerCards');
      
      dealerContainer.innerHTML = '';
      playerContainer.innerHTML = '';
      
      // Render dealer cards
      blackjackGameState.dealerHand.forEach((card, idx) => {
        const cardEl = createCardElement(card, blackjackGameState.flippedCards.has(idx));
        dealerContainer.appendChild(cardEl);
      });
      
      // Render player cards
      blackjackGameState.playerHand.forEach((card, idx) => {
        const cardEl = createCardElement(card, false);
        playerContainer.appendChild(cardEl);
      });
    }

    function createCardElement(card, isFlipped) {
      const cardDiv = document.createElement('div');
      cardDiv.className = 'blackjack-card';
      
      if (isFlipped) {
        cardDiv.innerHTML = `
          <svg width="96" height="128" viewBox="0 0 96 128" style="border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
            <rect width="96" height="128" fill="#ffffff" rx="8" />
            <rect x="4" y="4" width="88" height="120" fill="#ff5722" rx="6" />
            <circle cx="24" cy="24" r="3" fill="#1a1a1a" opacity="0.6" />
            <circle cx="72" cy="24" r="3" fill="#1a1a1a" opacity="0.6" />
            <circle cx="24" cy="104" r="3" fill="#1a1a1a" opacity="0.6" />
            <circle cx="72" cy="104" r="3" fill="#1a1a1a" opacity="0.6" />
            <circle cx="48" cy="64" r="4" fill="#1a1a1a" opacity="0.8" />
          </svg>
        `;
      } else {
        const suitColor = ['', ''].includes(card.suit) ? '#ff5722' : '#000000';
        cardDiv.innerHTML = `
          <svg width="96" height="128" viewBox="0 0 96 128" style="border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
            <rect width="96" height="128" fill="#ffffff" rx="8" stroke="#1a1a1a" stroke-width="1" />
            <text x="6" y="14" font-size="12" font-weight="bold" fill="${suitColor}">${card.rank}</text>
            <text x="6" y="26" font-size="11" fill="${suitColor}">${card.suit}</text>
            <text x="48" y="72" text-anchor="middle" dy="0.3em" font-size="48" font-weight="bold" fill="${suitColor}">${card.suit}</text>
            <g transform="translate(90, 128) rotate(180)">
              <text x="6" y="14" font-size="12" font-weight="bold" fill="${suitColor}">${card.rank}</text>
              <text x="6" y="26" font-size="11" fill="${suitColor}">${card.suit}</text>
            </g>
          </svg>
        `;
      }
      
      return cardDiv;
    }

    function updateBlackjackHandTotals() {
      const playerTotal = calculateHand(blackjackGameState.playerHand);
      document.getElementById('blackjackPlayerTotalValue').textContent = playerTotal;
      document.getElementById('blackjackPlayerTotal').style.display = 'block';
      
      if (blackjackGameState.gameState === 'dealer-turn' || blackjackGameState.gameState === 'result') {
        const dealerTotal = calculateHand(blackjackGameState.dealerHand);
        document.getElementById('blackjackDealerTotalValue').textContent = dealerTotal;
        document.getElementById('blackjackDealerTotal').style.display = 'block';
      } else {
        document.getElementById('blackjackDealerTotal').style.display = 'none';
      }
    }

    function blackjackPlaceBet(amount) {
      if (amount > 0 && amount <= blackjackGameState.bankroll) {
        blackjackGameState.currentBet = amount;
        updateBlackjackUI();
        startNewHand();
        document.getElementById('blackjackBettingPhase').style.display = 'none';
        document.getElementById('blackjackPlayingPhase').style.display = 'flex';
      }
    }
    window.blackjackPlaceBet = blackjackPlaceBet;

    function blackjackHit() {
      const newCard = blackjackGameState.deck.pop();
      blackjackGameState.playerHand.push(newCard);
      renderBlackjackCards();
      updateBlackjackHandTotals();
      
      const playerTotal = calculateHand(blackjackGameState.playerHand);
      if (playerTotal > 21) {
        setTimeout(() => blackjackEndHand('bust'), 500);
      }
    }
    window.blackjackHit = blackjackHit;

    function blackjackStand() {
      blackjackGameState.flippedCards = new Set([0, 1]); // Show all dealer cards
      renderBlackjackCards();
      
      setTimeout(() => {
        blackjackGameState.gameState = 'dealer-turn';
        hitDealer();
      }, 800);
    }
    window.blackjackStand = blackjackStand;

    function hitDealer() {
      const dealerValue = calculateHand(blackjackGameState.dealerHand);
      
      if (dealerValue < 17) {
        // Dealer hits
        const newCard = blackjackGameState.deck.pop();
        blackjackGameState.dealerHand.push(newCard);
        renderBlackjackCards();
        updateBlackjackHandTotals();
        
        setTimeout(hitDealer, 1000);
      } else {
        // Dealer stands - determine outcome
        const playerValue = calculateHand(blackjackGameState.playerHand);
        const finalDealerValue = calculateHand(blackjackGameState.dealerHand);
        
        if (finalDealerValue > 21) {
          blackjackEndHand('dealer-bust');
        } else if (playerValue > finalDealerValue) {
          blackjackEndHand('win');
        } else if (playerValue === finalDealerValue) {
          blackjackEndHand('push');
        } else {
          blackjackEndHand('loss');
        }
      }
    }

    function blackjackEndHand(outcome) {
      blackjackGameState.gameState = 'result';
      let newBankroll = blackjackGameState.bankroll;
      let resultMessage = '';
      
      if (outcome === 'bust') {
        newBankroll -= blackjackGameState.currentBet;
        resultMessage = 'BUST! You went over 21 ';
      } else if (outcome === 'dealer-bust') {
        newBankroll += blackjackGameState.currentBet;
        resultMessage = 'DEALER BUST! You Win! ';
      } else if (outcome === 'win') {
        newBankroll += blackjackGameState.currentBet;
        resultMessage = 'YOU WIN! ';
      } else if (outcome === 'push') {
        resultMessage = 'PUSH - Tie Game ';
      } else if (outcome === 'loss') {
        newBankroll -= blackjackGameState.currentBet;
        resultMessage = 'DEALER WINS ';
      }
      
      blackjackGameState.bankroll = newBankroll;
      blackjackGameState.result = resultMessage;
      blackjackGameState.showResult = true;
      
      updateBlackjackUI();
      updateBlackjackHandTotals();
      
      document.getElementById('blackjackPlayingPhase').style.display = 'none';
      document.getElementById('blackjackResultPhase').style.display = 'block';
      document.getElementById('blackjackResultText').textContent = resultMessage;
    }

    function blackjackPlayAgain() {
      if (blackjackGameState.bankroll > 0) {
        blackjackGameState.currentBet = 0;
        blackjackGameState.gameState = 'betting';
        blackjackGameState.showResult = false;
        blackjackGameState.playerHand = [];
        blackjackGameState.dealerHand = [];
        blackjackGameState.flippedCards = new Set();
        
        document.getElementById('blackjackResultPhase').style.display = 'none';
        document.getElementById('blackjackBettingPhase').style.display = 'block';
        updateBlackjackUI();
      } else {
        // Need to answer more questions
        blackjackGameState.quizForContinue = true;
        blackjackGameState.currentQuestion = 0;
        blackjackGameState.selectedAnswer = null;
        blackjackGameState.answered = false;
        blackjackGameState.questionsCorrect = 0;
        showBlackjackPhase('quiz');
        loadBlackjackQuestionFromQueue();
      }
    }
    window.blackjackPlayAgain = blackjackPlayAgain;

    function resetBlackjackGame() {
      const container = document.getElementById('blackjackGameContainer');
      if (container) {
        container.classList.remove('active');
        container.style.display = 'none';
      }
      
      blackjackGameState.phase = 'menu';
      blackjackGameState.currentQuestion = 0;
      blackjackGameState.questionsCorrect = 0;
      blackjackGameState.selectedAnswer = null;
      blackjackGameState.answered = false;
      blackjackGameState.bankroll = 0;
      blackjackGameState.currentBet = 0;
      blackjackGameState.playerHand = [];
      blackjackGameState.dealerHand = [];
      blackjackGameState.gameState = 'betting';
      blackjackGameState.result = '';
      blackjackGameState.showResult = false;
      blackjackGameState.quizForContinue = false;
      blackjackGameState.flippedCards = new Set();
      
      document.body.style.overflow = 'auto';
    }
    window.resetBlackjackGame = resetBlackjackGame;

    // ============ MEMORY MATCH GAME ============
    let memoryGameState = {
      phase: 'menu', // menu, quiz, game
      currentQuestion: 0,
      questionsCorrect: 0,
      selectedAnswer: null,
      answered: false,
      cards: [],
      flipped: new Set(),
      matched: new Set(),
      turnsLeft: 10,
      score: 0,
      firstCard: null,
      secondCard: null,
      isChecking: false,
      gameComplete: false,
      quizToResume: false,
      savedGameState: null,
      questionQueue: [],
      questionHistory: [],
      currentQuestionIndex: -1,
      isGeneratingQuestions: false
    };

    const memoryCardPairs = [
      { id: 1, symbol: '', color: '#000000' },
      { id: 2, symbol: '', color: '#ff5722' },
      { id: 3, symbol: '', color: '#ff5722' },
      { id: 4, symbol: '', color: '#000000' },
      { id: 5, symbol: '', color: '#ff5722' },
      { id: 6, symbol: '', color: '#000000' },
      { id: 7, symbol: '', color: '#ff5722' },
      { id: 8, symbol: '', color: '#000000' },
    ];

    function startMemoryGame() {
      const container = document.getElementById('memoryGameContainer');
      if (container) {
        container.style.display = 'flex';
        container.classList.add('active');
        createMemoryStars();
        memoryGameState.phase = 'menu';
        showMemoryPhase('menu');
      }
    }
    window.startMemoryGame = startMemoryGame;

    function createMemoryStars() {
      const container = document.getElementById('memoryStarsBg');
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < 50; i++) {
        const star = document.createElement('div');
        star.className = 'memory-star';
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.5 + 0.2;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `memory-twinkle ${duration}s infinite`;
        star.style.animationDelay = delay + 's';
        
        container.appendChild(star);
      }
    }

    function showMemoryPhase(phase) {
      const container = document.getElementById('memoryGameContainer');
      if (!container) return;
      
      document.getElementById('memoryMenuPhase').style.display = phase === 'menu' ? 'flex' : 'none';
      document.getElementById('memoryQuizPhase').style.display = phase === 'quiz' ? 'flex' : 'none';
      document.getElementById('memoryGamePhase').style.display = phase === 'game' ? 'block' : 'none';
      
      if (phase === 'quiz' || phase === 'game') {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = 'auto';
      }
      
      memoryGameState.phase = phase;
    }

    function initializeMemoryGame() {
      const shuffled = [...memoryCardPairs, ...memoryCardPairs].sort(() => Math.random() - 0.5);
      memoryGameState.cards = shuffled;
      memoryGameState.flipped = new Set();
      memoryGameState.matched = new Set();
      memoryGameState.turnsLeft = 10;
      memoryGameState.score = 0;
      memoryGameState.firstCard = null;
      memoryGameState.secondCard = null;
      memoryGameState.isChecking = false;
      memoryGameState.gameComplete = false;
      memoryGameState.quizToResume = false;
      
      renderMemoryCards();
      updateMemoryUI();
    }

    function startMemoryGamePlay() {
      initializeMemoryGame();
      showMemoryPhase('game');
    }
    window.startMemoryGamePlay = startMemoryGamePlay;

    async function startMemoryQuiz() {
      memoryGameState.questionsCorrect = 0;
      memoryGameState.selectedAnswer = null;
      memoryGameState.answered = false;
      memoryGameState.currentQuestion = 0;
      memoryGameState.questionQueue = [];
      memoryGameState.questionHistory = [];
      memoryGameState.currentQuestionIndex = -1;
      memoryGameState.isGeneratingQuestions = false;
      memoryGameState.quizToResume = false;
      
      showMemoryPhase('quiz');
      
      // Create stars for quiz
      const starsContainer = document.getElementById('memoryQuizStarsContainer');
      if (starsContainer) {
        starsContainer.innerHTML = '';
        for (let i = 0; i < 50; i++) {
          const star = document.createElement('div');
          star.className = 'practice-quiz-star';
          const size = Math.random() * 3 + 0.5;
          const duration = Math.random() * 4 + 2;
          const delay = Math.random() * 2;
          const randomLeft = Math.random() * 100;
          const randomTop = Math.random() * 100;
          const randomOpacity = Math.random() * 0.9 + 0.1;
          
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          star.style.left = randomLeft + '%';
          star.style.top = randomTop + '%';
          star.style.opacity = randomOpacity;
          star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
          star.style.animationDelay = delay + 's';
          star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
          
          starsContainer.appendChild(star);
        }
      }
      
      // Pre-generate questions
      console.log(' Pre-generating questions for Memory Match...');
      memoryGameState.isGeneratingQuestions = true;
      const questions = await generateDartsQuestionsBatch(10);
      memoryGameState.questionQueue = questions;
      memoryGameState.isGeneratingQuestions = false;
      console.log(` Pre-generated ${questions.length} questions ready to use`);
      
      // Load first question
      loadMemoryQuestionFromQueue();
      
      // Maintain question queue
      maintainMemoryQuestionQueue();
    }

    async function startMemoryQuizToResume() {
      memoryGameState.quizToResume = true;
      memoryGameState.currentQuestion = 0;
      memoryGameState.selectedAnswer = null;
      memoryGameState.answered = false;
      await startMemoryQuiz();
    }
    window.startMemoryQuizToResume = startMemoryQuizToResume;

    async function maintainMemoryQuestionQueue() {
      while (memoryGameState.phase === 'quiz') {
        if (memoryGameState.questionQueue.length < 5 && !memoryGameState.isGeneratingQuestions) {
          console.log(' Queue getting low, generating more questions...');
          memoryGameState.isGeneratingQuestions = true;
          const newQuestions = await generateDartsQuestionsBatch(10);
          memoryGameState.questionQueue.push(...newQuestions);
          memoryGameState.isGeneratingQuestions = false;
          console.log(` Added ${newQuestions.length} questions to queue. Total: ${memoryGameState.questionQueue.length}`);
        }
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
    }

    function loadMemoryQuestionFromQueue() {
      if (memoryGameState.questionQueue.length === 0) {
        console.log(' Queue empty, waiting for questions...');
        document.getElementById('memoryQuizQuestion').textContent = 'Generating questions...';
        document.getElementById('memoryQuizOptions').innerHTML = '<div style="text-align: center; color: #94a3b8;">Please wait...</div>';
        return;
      }
      
      const questionFromQueue = memoryGameState.questionQueue.shift();
      
      memoryGameState.questionHistory.push({
        question: questionFromQueue,
        answered: false,
        selectedAnswer: null,
        isCorrect: null
      });
      
      memoryGameState.currentQuestionIndex = memoryGameState.questionHistory.length - 1;
      memoryGameState.currentQuestion = questionFromQueue;
      
      // Update title if in resume mode
      if (memoryGameState.quizToResume) {
        document.getElementById('memoryQuizTitle').textContent = 'ANSWER TO CONTINUE';
      } else {
        document.getElementById('memoryQuizTitle').textContent = 'MEMORY QUIZ';
      }
      
      displayMemoryQuestion(questionFromQueue);
    }

    function displayMemoryQuestion(question) {
      document.getElementById('memoryQuizQuestion').textContent = question.text || question.question;
      
      // Update competency badge
      const competencyEl = document.getElementById('memoryQuizCompetency');
      if (competencyEl && question.competency) {
        competencyEl.textContent = question.competency.toUpperCase();
      }
      
      // Update progress
      const totalQuestions = 5;
      const progressPercent = Math.min((memoryGameState.currentQuestionIndex + 1) / totalQuestions * 100, 100);
      document.getElementById('memoryQuizProgress').textContent = `Question ${memoryGameState.currentQuestionIndex + 1}`;
      document.getElementById('memoryQuizProgressPercent').textContent = Math.min(memoryGameState.currentQuestionIndex + 1, totalQuestions);
      document.getElementById('memoryQuizProgressFill').style.width = progressPercent + '%';
      
      // Display options
      const optionsContainer = document.getElementById('memoryQuizOptions');
      optionsContainer.innerHTML = '';
      
      const options = question.options || [];
      const correctAnswer = question.correctAnswer || question.correct;
      
      options.forEach((option, idx) => {
        const optionBtn = document.createElement('button');
        optionBtn.className = 'practice-quiz-option-btn';
        optionBtn.textContent = option;
        optionBtn.onclick = () => memorySelectAnswer(idx, question, correctAnswer);
        optionsContainer.appendChild(optionBtn);
      });
      
      // Reset state
      memoryGameState.selectedAnswer = null;
      memoryGameState.answered = false;
      document.getElementById('memoryQuizNextBtn').style.display = 'none';
    }

    function memorySelectAnswer(index, question, correctAnswer) {
      if (memoryGameState.answered) return;
      
      memoryGameState.selectedAnswer = index;
      memoryGameState.answered = true;
      
      const options = question.options || [];
      const isCorrect = (typeof correctAnswer === 'number' && index === correctAnswer) || 
                       (typeof correctAnswer === 'string' && options[index] === correctAnswer);
      
      // Update question history
      if (memoryGameState.questionHistory[memoryGameState.currentQuestionIndex]) {
        memoryGameState.questionHistory[memoryGameState.currentQuestionIndex].answered = true;
        memoryGameState.questionHistory[memoryGameState.currentQuestionIndex].selectedAnswer = index;
        memoryGameState.questionHistory[memoryGameState.currentQuestionIndex].isCorrect = isCorrect;
      }
      
      // Update UI
      const optionButtons = document.querySelectorAll('#memoryQuizOptions .practice-quiz-option-btn');
      optionButtons.forEach((btn, idx) => {
        btn.disabled = true;
        if (idx === index) {
          btn.style.backgroundColor = isCorrect ? '#22c55e' : '#ef4444';
        } else if (typeof correctAnswer === 'number' && idx === correctAnswer) {
          btn.style.backgroundColor = '#22c55e';
        } else if (typeof correctAnswer === 'string' && options[idx] === correctAnswer) {
          btn.style.backgroundColor = '#22c55e';
        }
      });
      
      if (isCorrect) {
        if (memoryGameState.quizToResume) {
          // Adding turns for resume
          memoryGameState.turnsLeft += 5;
          setTimeout(() => {
            memoryGameState.quizToResume = false;
            memoryGameState.currentQuestion = 0;
            memoryGameState.selectedAnswer = null;
            memoryGameState.answered = false;
            showMemoryPhase('game');
            updateMemoryUI();
            document.getElementById('memoryOutOfTurns').style.display = 'none';
          }, 1000);
          return;
        } else {
          memoryGameState.questionsCorrect++;
        }
      } else {
        // Wrong answer
        if (memoryGameState.quizToResume) {
          // Wrong answer during resume - try next question
          setTimeout(() => {
            loadMemoryQuestionFromQueue();
          }, 1000);
          return;
        } else if (memoryGameState.questionsCorrect === 0) {
          // No correct answers, restart quiz
          setTimeout(() => {
            memoryGameState.currentQuestion = 0;
            memoryGameState.selectedAnswer = null;
            memoryGameState.answered = false;
            loadMemoryQuestionFromQueue();
          }, 1500);
          return;
        } else {
          // Start game
          initializeMemoryGame();
          setTimeout(() => {
            showMemoryPhase('game');
          }, 1500);
          return;
        }
      }
      
      // Show next button
      document.getElementById('memoryQuizNextBtn').style.display = 'block';
    }
    window.memorySelectAnswer = memorySelectAnswer;

    function memoryNextQuestion() {
      if (memoryGameState.currentQuestionIndex + 1 >= 5) {
        // Reached 5 questions, start game
        initializeMemoryGame();
        setTimeout(() => {
          showMemoryPhase('game');
        }, 1000);
      } else {
        loadMemoryQuestionFromQueue();
      }
    }
    window.memoryNextQuestion = memoryNextQuestion;

    function renderMemoryCards() {
      const grid = document.getElementById('memoryCardsGrid');
      if (!grid) return;
      
      grid.innerHTML = '';
      grid.style.display = 'grid';
      
      memoryGameState.cards.forEach((card, idx) => {
        const cardBtn = createMemoryCardElement(card, idx);
        grid.appendChild(cardBtn);
      });
    }

    function createMemoryCardElement(card, index) {
      const cardBtn = document.createElement('button');
      cardBtn.className = 'memory-card';
      const isFlipped = memoryGameState.flipped.has(index);
      const isMatched = memoryGameState.matched.has(index);
      
      cardBtn.disabled = isMatched || isFlipped || memoryGameState.isChecking;
      cardBtn.style.opacity = isMatched ? '0.5' : '1';
      cardBtn.style.cursor = isMatched ? 'default' : 'pointer';
      
      if (!isFlipped && !isMatched) {
        // Card back
        cardBtn.innerHTML = `
          <svg width="80" height="110" viewBox="0 0 96 128" style="border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
            <rect width="96" height="128" fill="#ffffff" rx="8" />
            <rect x="4" y="4" width="88" height="120" fill="#ff5722" rx="6" />
            <circle cx="24" cy="24" r="3" fill="#1a1a1a" opacity="0.6" />
            <circle cx="72" cy="24" r="3" fill="#1a1a1a" opacity="0.6" />
            <circle cx="24" cy="104" r="3" fill="#1a1a1a" opacity="0.6" />
            <circle cx="72" cy="104" r="3" fill="#1a1a1a" opacity="0.6" />
            <circle cx="48" cy="64" r="4" fill="#1a1a1a" opacity="0.8" />
          </svg>
        `;
      } else {
        // Card front
        cardBtn.innerHTML = `
          <svg width="80" height="110" viewBox="0 0 96 128" style="border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.5);">
            <rect width="96" height="128" fill="#ffffff" rx="8" stroke="#1a1a1a" stroke-width="1" />
            <text x="48" y="72" text-anchor="middle" dy="0.3em" font-size="48" font-weight="bold" fill="${card.color}">${card.symbol}</text>
          </svg>
        `;
      }
      
      cardBtn.onclick = () => memoryFlipCard(index);
      
      return cardBtn;
    }

    function memoryFlipCard(index) {
      if (memoryGameState.isChecking || memoryGameState.flipped.has(index) || memoryGameState.matched.has(index)) return;

      const newFlipped = new Set(memoryGameState.flipped);
      newFlipped.add(index);
      memoryGameState.flipped = newFlipped;

      if (memoryGameState.firstCard === null) {
        memoryGameState.firstCard = index;
      } else if (memoryGameState.secondCard === null) {
        memoryGameState.secondCard = index;
        memoryGameState.isChecking = true;

        setTimeout(() => {
          const firstCardData = memoryGameState.cards[memoryGameState.firstCard];
          const secondCardData = memoryGameState.cards[index];

          if (firstCardData.id === secondCardData.id) {
            // Match found
            const newMatched = new Set(memoryGameState.matched);
            newMatched.add(memoryGameState.firstCard);
            newMatched.add(index);
            memoryGameState.matched = newMatched;
            memoryGameState.score++;

            if (newMatched.size === memoryGameState.cards.length) {
              memoryGameState.gameComplete = true;
              document.getElementById('memoryGameComplete').style.display = 'block';
              const turnsUsed = 10 - memoryGameState.turnsLeft;
              document.getElementById('memoryCompleteSubtext').textContent = `Matched all pairs in ${turnsUsed} turns!`;
            }
          } else {
            // No match
            const updatedFlipped = new Set(memoryGameState.flipped);
            updatedFlipped.delete(memoryGameState.firstCard);
            updatedFlipped.delete(index);
            memoryGameState.flipped = updatedFlipped;
          }

          memoryGameState.turnsLeft--;
          memoryGameState.firstCard = null;
          memoryGameState.secondCard = null;
          memoryGameState.isChecking = false;

          renderMemoryCards();
          updateMemoryUI();

          if (memoryGameState.turnsLeft === 0 && !memoryGameState.gameComplete) {
            document.getElementById('memoryOutOfTurns').style.display = 'block';
            document.getElementById('memoryOutOfTurnsSubtext').textContent = `You matched ${memoryGameState.score}/8 pairs. Answer questions to get 5 more turns!`;
          }
        }, 600);
      }

      renderMemoryCards();
    }
    window.memoryFlipCard = memoryFlipCard;

    function updateMemoryUI() {
      document.getElementById('memoryMatches').textContent = memoryGameState.score;
      const turnsEl = document.getElementById('memoryTurns');
      turnsEl.textContent = memoryGameState.turnsLeft;
      turnsEl.style.color = memoryGameState.turnsLeft <= 3 ? '#ef4444' : '#ff5722';
    }

    function resetMemoryGame() {
      const container = document.getElementById('memoryGameContainer');
      if (container) {
        container.classList.remove('active');
        container.style.display = 'none';
      }
      
      memoryGameState.phase = 'menu';
      memoryGameState.currentQuestion = 0;
      memoryGameState.questionsCorrect = 0;
      memoryGameState.selectedAnswer = null;
      memoryGameState.answered = false;
      memoryGameState.cards = [];
      memoryGameState.flipped = new Set();
      memoryGameState.matched = new Set();
      memoryGameState.turnsLeft = 10;
      memoryGameState.score = 0;
      memoryGameState.firstCard = null;
      memoryGameState.secondCard = null;
      memoryGameState.isChecking = false;
      memoryGameState.gameComplete = false;
      memoryGameState.quizToResume = false;
      
      document.body.style.overflow = 'auto';
    }
    window.resetMemoryGame = resetMemoryGame;

    window.addEventListener('load', function() {
      const loader = document.getElementById('assignmentLoader');
      if (loader) {
        loader.style.zIndex = '99999';
        loader.style.position = 'fixed';
      }

      const assignmentModal = document.getElementById('cq-assignment-modal');
      if (assignmentModal) {
        assignmentModal.style.zIndex = '1000';
      }

      const quizModal = document.getElementById('quizModal');
      if (quizModal) {
        quizModal.style.zIndex = '500';
      }
      
      console.log(" Z-indexes set: loader=99999, assignment=1000, quiz=500");
    });
  </script>

  <!-- Assignment Modal -->
  <div id="cq-assignment-modal" class="cq-modal" style="display: none;">
    <div class="cq-modal-content">
      <span class="cq-close" onclick="closeAssignmentModal()">&times;</span>
      <div id="cq-assignment-title" class="cq-modal-title">New Assignment</div>
      
      <!-- Assignment Info (shown first) -->
      <div id="cq-assignment-info">
        <div id="cq-assignment-fields" class="cq-modal-fields"></div>
        <div class="cq-modal-footer" style="margin-top:1.5rem; text-align:right;">
          <button class="cq-modal-btn" onclick="acceptAssignmentNow()">I'll do it now</button>
          <button class="cq-modal-btn" onclick="snoozeAssignment()">I'll do it later</button>
        </div>
      </div>
      
      <!-- Quiz Section (hidden initially) -->
      <div id="cq-assignment-quiz" style="display:none;">
        <div id="quizQuestions" class="cq-modal-fields"></div>
        <div class="cq-modal-footer">
          <button class="cq-modal-btn" id="submitQuizBtn" disabled>Submit Answers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Speaking Assignment Modal -->
  <div id="cq-speaking-modal" class="cq-speaking-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-speaking-stars" id="cq-speaking-stars"></div>
    <div class="cq-speaking-glow-1"></div>
    <div class="cq-speaking-glow-2"></div>
    
    <div class="cq-speaking-modal-content">
      <!-- Header -->
      <div class="cq-speaking-header">
        <h1 class="cq-speaking-title" id="cq-speaking-title">Speaking Assessment</h1>
        <button class="cq-speaking-close" onclick="closeSpeakingAssignmentModal()"></button>
      </div>
      
      <!-- Main Container -->
      <div class="cq-speaking-main-container">
        <!-- Questions Row -->
        <div class="cq-speaking-questions">
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 1:</h2>
            <p id="cq-speaking-q1" class="cq-speaking-question-text">What is your strategy for this scenario?</p>
          </div>
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 2:</h2>
            <p id="cq-speaking-q2" class="cq-speaking-question-text">How would you handle unexpected challenges?</p>
          </div>
        </div>
        
        <!-- Video Feed -->
        <div class="cq-speaking-video-container">
          <video id="cq-speaking-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-speaking-noVideoView" class="cq-speaking-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-speaking-recordingIndicator" class="cq-speaking-recording-indicator">
            <div class="cq-speaking-recording-dot"></div>
            <span class="cq-speaking-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Controls -->
        <div class="cq-speaking-controls-wrapper">
          <div class="cq-speaking-controls">
            <button id="cq-speaking-documentBtn" class="cq-speaking-control-btn" title="Document">
              
            </button>
            <button id="cq-speaking-recordBtn" class="cq-speaking-record-btn" onclick="toggleSpeakingRecording()">
              
            </button>
            <button id="cq-speaking-micBtn" class="cq-speaking-control-btn" title="Settings">
              
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-speaking-submitBtn" class="cq-speaking-submit-btn" style="display:none;" onclick="submitSpeakingResponse()">Submit Assessment</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-speaking-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-speaking-audioBtn" style="display:none;"></button>
      <button id="cq-speaking-videoBtn" style="display:none;"></button>
      <button id="cq-speaking-stopBtn" style="display:none;"></button>
      <button id="cq-speaking-downloadBtn" style="display:none;"></button>
    </div>
  </div>

  <!-- Case Study Assignment Modal -->
  <div id="cq-case-study-modal" class="cq-case-study-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-case-study-stars" id="cq-case-study-stars"></div>
    <div class="cq-case-study-glow-1"></div>
    <div class="cq-case-study-glow-2"></div>
    
    <div class="cq-case-study-modal-content">
      <!-- Header -->
      <div class="cq-case-study-header">
        <h1 class="cq-case-study-title" id="cq-case-study-title">Case Study</h1>
        <div class="cq-case-study-header-right">
          <!-- Timer -->
          <div id="cq-case-study-timer" class="cq-case-study-timer" onclick="toggleCaseStudyTimer()">
            <div id="cq-case-study-timer-dot" class="cq-case-study-timer-dot"></div>
            <span id="cq-case-study-timer-text" class="cq-case-study-timer-text">20:00</span>
            <span id="cq-case-study-timer-start" class="cq-case-study-timer-start">Start</span>
          </div>
          <button class="cq-case-study-close" onclick="closeCaseStudyModal()"></button>
        </div>
      </div>
      
      <!-- Main Container -->
      <div class="cq-case-study-main-container">
        <!-- Top Info Section (when content collapsed) -->
        <div id="cq-case-study-top-info" class="cq-case-study-top-info">
          <div class="cq-case-study-info-card">
            <p class="cq-case-study-info-label">Case Name</p>
            <p id="cq-case-study-name" class="cq-case-study-info-value">Market Expansion Strategy</p>
          </div>
          <div id="cq-case-study-content-preview" class="cq-case-study-info-card cq-case-study-clickable" onclick="expandCaseStudyContent()">
            <p class="cq-case-study-info-label">Case Study Content</p>
            <p id="cq-case-study-content-preview-text" class="cq-case-study-info-preview">Loading...</p>
            <p class="cq-case-study-read-more">Read More </p>
          </div>
        </div>
        
        <!-- Expanded Content (when content expanded) -->
        <div id="cq-case-study-expanded-content" class="cq-case-study-expanded-content" style="display:none;">
          <div class="cq-case-study-expanded-header">
            <div>
              <p class="cq-case-study-expanded-label">Case Study Content</p>
              <h3 id="cq-case-study-expanded-title" class="cq-case-study-expanded-title">Market Expansion Strategy</h3>
            </div>
            <button class="cq-case-study-expanded-close" onclick="collapseCaseStudyContent()"></button>
          </div>
          <p id="cq-case-study-full-content" class="cq-case-study-full-content">Loading...</p>
        </div>
        
        <!-- Video Feed (hidden when content expanded) -->
        <div id="cq-case-study-video-container" class="cq-case-study-video-container">
          <video id="cq-case-study-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-case-study-noVideoView" class="cq-case-study-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-case-study-recordingIndicator" class="cq-case-study-recording-indicator">
            <div class="cq-case-study-recording-dot"></div>
            <span class="cq-case-study-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Bottom Info Section (hidden when content expanded) -->
        <div id="cq-case-study-bottom-info" class="cq-case-study-bottom-info">
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 1</p>
            <p id="cq-case-study-q1" class="cq-case-study-question-text">What are the key market opportunities and challenges?</p>
          </div>
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 2</p>
            <p id="cq-case-study-q2" class="cq-case-study-question-text">How would you develop a comprehensive expansion strategy?</p>
          </div>
        </div>
        
        <!-- Controls (hidden when content expanded) -->
        <div id="cq-case-study-controls-wrapper" class="cq-case-study-controls-wrapper">
          <div class="cq-case-study-controls">
            <button id="cq-case-study-recordBtn" class="cq-case-study-record-btn" onclick="toggleCaseStudyRecording()">
              
            </button>
            <button id="cq-case-study-downloadBtn" class="cq-case-study-control-btn" title="Download" style="display:none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="7" y="7" width="10" height="10" rx="2.5" fill="#60a5fa"/>
                <path d="M12 9.5v4.5m0 0l-2.5-2.5m2.5 2.5l2.5-2.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-case-study-submitBtn" class="cq-case-study-submit-btn" style="display:none;" onclick="submitCaseStudyResponse()">Submit Case Study</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-case-study-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-case-study-audioBtn" style="display:none;"></button>
      <button id="cq-case-study-videoBtn" style="display:none;"></button>
      <button id="cq-case-study-stopBtn" style="display:none;"></button>
      <button id="cq-case-study-downloadBtn" style="display:none;"></button>
    </div>
  </div>

  <!-- Quiz Modal - Fullscreen -->
  <div id="quizModal" style="display: none;" class="practice-quiz-fullscreen">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="quizStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Top Bar -->
    <div class="practice-quiz-topbar">
      <div class="practice-quiz-topbar-content">
        <div>
          <h1 id="quizTitle" class="practice-quiz-topbar-title">Easy Written Practice</h1>
          <p class="practice-quiz-topbar-subtitle">
            <span id="quizProgress">Question 1 of 14</span>
          </p>
        </div>
        
        <div class="practice-quiz-topbar-right">
          <div class="practice-quiz-timer-section">
            <p class="practice-quiz-timer-label">Time Remaining</p>
            <p id="quizTimer" class="practice-quiz-timer-value">14:53</p>
          </div>
          
          <button class="practice-quiz-close-btn" onclick="closeQuizModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="practice-quiz-main">
      <!-- Competency Badge -->
      <div class="practice-quiz-competency-badge">
        <span id="questionCompetency" class="practice-quiz-competency-text">Business Communication</span>
      </div>

      <!-- Question -->
      <div class="practice-quiz-question-section">
        <h2 id="questionText" class="practice-quiz-question">Loading question...</h2>
        <p class="practice-quiz-question-hint">Select the best answer from the options below</p>
      </div>

      <!-- Answer Options -->
      <div id="optionsContainer" class="practice-quiz-options">
        <!-- Options will be populated dynamically -->
      </div>

      <!-- Progress Section -->
      <div class="practice-quiz-progress-section">
        <div class="practice-quiz-progress-header">
          <p class="practice-quiz-progress-label">Overall Progress</p>
          <p class="practice-quiz-progress-value"><span id="progressPercent">0</span>/100</p>
        </div>
        <div class="practice-quiz-progress-bar">
          <div class="practice-quiz-progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="practice-quiz-actions">
        <button id="prevBtn" class="practice-quiz-prev-btn" onclick="previousQuestion()" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Previous Question
        </button>
        <button id="nextBtn" class="practice-quiz-next-btn" onclick="nextQuestion()">Next Question</button>
        <button id="submitBtn" class="practice-quiz-submit-btn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
      </div>
    </div>
  </div>

  <!-- Congratulations Modal - Fullscreen -->
  <div id="congratsModal" class="practice-quiz-fullscreen" style="display:none;">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="congratsStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Main Content - Centered -->
    <div class="practice-quiz-main" style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px);">
      <div class="congrats-content">
        <!-- Congratulations Header - Centered -->
        <div class="congrats-header">
          <h1 id="congratsTitle" class="congrats-title">Congratulations!</h1>
          <p class="congrats-subtitle" id="congratsSubtitle">
            Excellent work! You scored <span id="congratsScore">0/0</span>
          </p>
        </div>

        <!-- Assignment Info - Centered -->
        <div class="congrats-assignment-info">
          <p class="congrats-assignment-label">For completing:</p>
          <h2 id="congratsAssignmentName" class="congrats-assignment-name">Written Practice</h2>
        </div>

        <!-- Competency Breakdown - Grid Layout -->
        <div class="congrats-competencies-grid" id="congratsCompetencies">
          <!-- Competencies will be populated here -->
        </div>

        <!-- Action Button -->
        <div class="congrats-actions">
          <button class="practice-quiz-next-btn" onclick="closeCongratsModal()">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assignment Loader - Fullscreen Blurred -->
  <div id="assignmentLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 10000; justify-content: center; align-items: center; flex-direction: column;">
    <div class="circular-progress-loader">
      <svg class="circular-progress-svg" viewBox="0 0 100 100">
        <defs>
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#f97316;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#eab308;stop-opacity:1" />
          </linearGradient>
        </defs>
        <circle class="circular-progress-bg" cx="50" cy="50" r="45"></circle>
        <circle class="circular-progress-fill" cx="50" cy="50" r="45" id="circularProgressFill"></circle>
      </svg>
      <div class="circular-progress-text" id="circularProgressText">0%</div>
    </div>
  </div>

  <!-- Add Resource Modal -->
  <div class="modal-overlay" id="modalOverlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">ADD A RESOURCE</h2>
        <button class="modal-close" id="modalClose">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <form class="modal-form" id="resourceForm">
        <div class="form-group">
          <label class="form-label">TITLE</label>
          <input type="text" class="form-input" id="formTitle" placeholder="Resource title" required>
        </div>

        <div class="form-group">
          <label class="form-label">DESCRIPTION</label>
          <textarea class="form-textarea" id="formDescription" placeholder="What's this resource about?" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="url" class="form-input" id="formUrl" placeholder="https://example.com" required>
        </div>

        <div class="form-group">
          <label class="form-label">COMPETITIONS (comma-separated)</label>
          <input type="text" class="form-input" id="formTags" placeholder="Hospitality Management, Business Management, Marketing">
        </div>

        <div class="form-group">
          <label class="form-label">CATEGORY</label>
          <select class="form-select" id="formCategory">
            <option value="tutorial">Tutorial</option>
            <option value="course">Course</option>
            <option value="reference">Reference</option>
            <option value="article">Article</option>
            <option value="tool">Tool</option>
            <option value="tool">Quizlet</option>
          </select>
        </div>

        <button type="submit" class="submit-btn">SUBMIT RESOURCE</button>
      </form>
    </div>
  </div>

  <!-- Study Mode Sticky Button -->
  <button class="study-mode-button" id="studyModeButton" onclick="openStudyModeModal()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <!-- Wrench tool icon -->
      <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
    </svg>
  </button>

  <!-- Study Mode Modal -->
  <div class="study-mode-modal practice-quiz-fullscreen" id="studyModeModal">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="studyModeStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Top Bar -->
    <div class="practice-quiz-topbar">
      <div class="practice-quiz-topbar-content">
        <div>
          <h1 class="practice-quiz-topbar-title">Study Mode Selection</h1>
          <p class="practice-quiz-topbar-subtitle">
            <span>Choose your mode</span>
          </p>
        </div>
        
        <div class="practice-quiz-topbar-right">
          <button class="practice-quiz-close-btn" onclick="closeStudyModeModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="practice-quiz-main" style="display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: calc(100vh - 80px);">
      <!-- Question -->
      <div class="practice-quiz-question-section" style="text-align: center; margin-bottom: 4rem;">
        <h2 class="practice-quiz-question">Pick your study mode</h2>
        <p class="practice-quiz-question-hint">Select the best option from the choices below</p>
      </div>

      <!-- Answer Options -->
      <div class="practice-quiz-options" id="studyModeOptions" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; width: 100%; max-width: 1000px;">
        <button class="practice-quiz-option-btn study-mode-option-large" data-mode="2048">
          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; width: 100%;">
            <span class="practice-quiz-option-text">2048</span>
            <span style="color: #94a3b8; font-size: 0.875rem; font-weight: 400; text-align: left;">Play and get the highest score possible on 2048! Increase your score by answering questions.</span>
          </div>
        </button>
        <button class="practice-quiz-option-btn study-mode-option-large" data-mode="darts">
          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; width: 100%;">
            <span class="practice-quiz-option-text">DARTS</span>
            <span style="color: #94a3b8; font-size: 0.875rem; font-weight: 400; text-align: left;">Answer as many questions correct in a row as possible! Depending on how many questions you get right, thats how long you'll get to play darts for.</span>
          </div>
        </button>
        <button class="practice-quiz-option-btn study-mode-option-large" data-mode="blackjack">
          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; width: 100%;">
            <span class="practice-quiz-option-text">Blackjack</span>
            <span style="color: #94a3b8; font-size: 0.875rem; font-weight: 400; text-align: left;">Answer questions to get your starting bankroll. Then play blackjack!<br><br>Get a hand total closer to 21 than the dealer without going over, and you win!</span>
          </div>
        </button>
        <button class="practice-quiz-option-btn study-mode-option-large" data-mode="memory">
          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 0.5rem; width: 100%;">
            <span class="practice-quiz-option-text">Memory Match</span>
            <span style="color: #94a3b8; font-size: 0.875rem; font-weight: 400; text-align: left;">Flip cards to find matching pairs. You have 10 turns!<br><br>Match all pairs before your turns run out, or answer questions to get more turns.</span>
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- Darts Game Container -->
  <div class="darts-game-container" id="dartsGameContainer">
    <!-- Stars Background -->
    <div class="darts-stars-bg" id="dartsStarsBg"></div>

    <!-- Menu Phase -->
    <div id="dartsMenuPhase" class="darts-menu-content">
      <h1 class="darts-menu-title">Darts</h1>
      <h2 class="darts-menu-subtitle">Challenge</h2>
      <p class="darts-menu-desc">Answer questions to set your target score. Then throw darts to reach it!</p>
      <button class="darts-start-btn" onclick="startDartsQuiz()">START</button>
    </div>

    <!-- Quiz Phase -->
    <div id="dartsQuizPhase" class="practice-quiz-fullscreen" style="display: none;">
      <!-- Galaxy Background -->
      <div class="practice-quiz-galaxy-bg">
        <div class="practice-quiz-galaxy-gradient"></div>
        <div class="practice-quiz-stars-container" id="dartsQuizStarsContainer"></div>
        <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
        <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
        <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
      </div>

      <!-- Top Bar -->
      <div class="practice-quiz-topbar">
        <div class="practice-quiz-topbar-content">
          <div>
            <h1 class="practice-quiz-topbar-title" id="dartsQuizTitle">DARTS QUIZ</h1>
            <p class="practice-quiz-topbar-subtitle">
              <span id="dartsQuizProgress">Question 1</span>
            </p>
          </div>
          
          <div class="practice-quiz-topbar-right">
            <!-- Hearts -->
            <div class="darts-hearts-container" id="dartsHeartsContainer">
              <svg class="darts-heart" id="dartsHeart1" width="32" height="32" viewBox="0 0 24 24" fill="#ef4444" stroke="#ef4444" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
              <svg class="darts-heart" id="dartsHeart2" width="32" height="32" viewBox="0 0 24 24" fill="#ef4444" stroke="#ef4444" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
              <svg class="darts-heart" id="dartsHeart3" width="32" height="32" viewBox="0 0 24 24" fill="#ef4444" stroke="#ef4444" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
              </svg>
            </div>
            <button class="practice-quiz-close-btn" onclick="resetDartsGame()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="practice-quiz-main">
        <!-- Competency Badge -->
        <div class="practice-quiz-competency-badge">
          <span id="dartsQuizCompetency" class="practice-quiz-competency-text">DARTS CHALLENGE</span>
        </div>

        <!-- Question -->
        <div class="practice-quiz-question-section">
          <h2 id="dartsQuizQuestion" class="practice-quiz-question">Loading question...</h2>
          <p class="practice-quiz-question-hint">Select the best answer from the options below</p>
        </div>

        <!-- Answer Options -->
        <div id="dartsQuizOptions" class="practice-quiz-options">
          <!-- Options will be populated dynamically -->
        </div>

        <!-- Progress Section -->
        <div class="practice-quiz-progress-section">
          <div class="practice-quiz-progress-header">
            <p class="practice-quiz-progress-label">Overall Progress</p>
            <p class="practice-quiz-progress-value"><span id="dartsQuizProgressPercent">0</span>/100</p>
          </div>
          <div class="practice-quiz-progress-bar">
            <div class="practice-quiz-progress-fill" id="dartsQuizProgressFill"></div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="practice-quiz-actions">
          <button id="dartsQuizPrevBtn" class="practice-quiz-prev-btn" onclick="dartsPreviousQuestion()" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
            Previous Question
          </button>
          <button id="dartsQuizNextBtn" class="practice-quiz-next-btn" onclick="dartsNextQuestion()" style="display: none;">Next Question</button>
        </div>
      </div>
    </div>

    <!-- Darts Game Phase -->
    <div id="dartsGamePhase" style="display: none;">
      <div class="darts-top-bar">
        <h1 class="darts-title">FBLAZE</h1>
        <div class="darts-stats-info">
          <p class="darts-stats-label">GAME STATS</p>
          <div style="display: flex; gap: 2rem; color: #ff5722; font-weight: 700;">
            <div>Target: <span id="dartsTargetScore">0</span></div>
            <div>Score: <span id="dartsCurrentScore">0</span></div>
            <div>Time: <span id="dartsTimeLeft">0</span>s</div>
          </div>
        </div>
      </div>
      <div class="darts-game-area">
        <div class="darts-board-container">
          <canvas id="dartsBoardCanvas" width="500" height="500"></canvas>
          <canvas id="dartsDartCanvas" width="500" height="500"></canvas>
        </div>
      </div>
      <div class="darts-bottom-bar">
        <div class="darts-hit-info">
          <p class="darts-hit-label">CLICK ANYWHERE ON BOARD TO THROW</p>
          <p class="darts-hit-text" id="dartsLastHit">Ready to throw...</p>
        </div>
        <button class="darts-end-btn" onclick="endDartsGame()">END GAME</button>
      </div>
    </div>

    <!-- Results Modal -->
    <div class="darts-results-modal" id="dartsResultsModal">
      <div class="darts-results-content">
        <h2 class="darts-results-title">GAME OVER!</h2>
        <p class="darts-results-subtitle">Here's how you did:</p>
        <div class="darts-results-stats">
          <div class="darts-stat-item">
            <p class="darts-stat-label">TARGET SCORE</p>
            <p class="darts-stat-value" id="dartsResultsTarget">0</p>
          </div>
          <div class="darts-stat-item">
            <p class="darts-stat-label">FINAL SCORE</p>
            <p class="darts-stat-value white" id="dartsResultsFinal">0</p>
          </div>
          <div class="darts-stat-item">
            <p class="darts-stat-label">DARTS THROWN</p>
            <p class="darts-stat-value white" id="dartsResultsThrown">0</p>
          </div>
          <div class="darts-stat-item" id="dartsResultsWin" style="display: none;">
            <p class="darts-stat-label">RESULT</p>
            <p class="darts-stat-value green">YOU WON! </p>
          </div>
        </div>
        <button class="darts-play-again-btn" onclick="resetDartsGame()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
          PLAY AGAIN
        </button>
      </div>
    </div>
  </div>

  <!-- 2048 Game Container -->
  <div class="game2048-container" id="game2048Container" style="display: none;">
    <div class="game2048-stars-container" id="game2048StarsContainer"></div>
    <div class="game2048-content">
      <h1 class="game2048-title">2048</h1>
      <div class="game2048-subtitle">Merge tiles to reach 2048</div>
      
      <div class="game2048-score-container">
        <div class="game2048-score-box">
          <div class="game2048-score-label">Score</div>
          <div class="game2048-score-value" id="game2048Score">0</div>
        </div>
        <div class="game2048-score-box">
          <div class="game2048-score-label">Best</div>
          <div class="game2048-score-value" id="game2048Best">0</div>
        </div>
      </div>

      <div class="game2048-grid" id="game2048Grid"></div>

      <div class="game2048-controls">
        <button class="game2048-btn" id="game2048NewGame">New Game</button>
      </div>

      <div class="game2048-instructions">
        <strong>Use arrow keys</strong>     <strong>or swipe</strong> to move tiles.<br>
        Tiles with the same number merge into one. Reach <strong>2048</strong> to win!
      </div>
    </div>

    <!-- 2048 Game Over Modal -->
    <div class="game2048-over" id="game2048Over" style="display: none;">
      <div class="game2048-over-content">
        <h2>Game Over!</h2>
        <p id="game2048FinalScore">Final Score: 0</p>
        <div class="game2048-stats" id="game2048Stats"></div>
        <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 1.5rem;">
          <button class="game2048-btn" id="game2048Restart">Play Again</button>
          <button class="game2048-btn game2048-continue-btn" id="game2048ContinueQuiz">Answer Questions to Expand</button>
        </div>
      </div>
    </div>

    <!-- 2048 Grid Expansion Modal -->
    <div class="game2048-expansion-modal" id="game2048ExpansionModal" style="display: none;">
      <div class="game2048-expansion-content">
        <h2>Grid Expanded!</h2>
        <p id="game2048ExpansionMessage">Grid expanded to 4x4!</p>
        <button class="game2048-btn" id="game2048ExpansionClose">Continue Playing</button>
      </div>
    </div>
  </div>

  <!-- Blackjack Game Container -->
  <div class="blackjack-game-container" id="blackjackGameContainer" style="display: none;">
    <div class="blackjack-stars-bg" id="blackjackStarsBg"></div>

    <!-- Menu Phase -->
    <div id="blackjackMenuPhase" class="blackjack-menu-content">
      <h1 class="blackjack-menu-title">Blackjack</h1>
      <h2 class="blackjack-menu-subtitle">21</h2>
      <p class="blackjack-menu-desc">Answer questions to get your starting bankroll. Then play blackjack!</p>
      <p class="blackjack-menu-subdesc">Get a hand total closer to 21 than the dealer without going over, and you win!</p>
      <button class="blackjack-start-btn" onclick="startBlackjackQuiz()">START</button>
    </div>

    <!-- Quiz Phase -->
    <div id="blackjackQuizPhase" class="practice-quiz-fullscreen" style="display: none;">
      <!-- Galaxy Background -->
      <div class="practice-quiz-galaxy-bg">
        <div class="practice-quiz-galaxy-gradient"></div>
        <div class="practice-quiz-stars-container" id="blackjackQuizStarsContainer"></div>
        <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
        <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
        <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
      </div>

      <!-- Top Bar -->
      <div class="practice-quiz-topbar">
        <div class="practice-quiz-topbar-content">
          <div>
            <h1 class="practice-quiz-topbar-title" id="blackjackQuizTitle">BLACKJACK QUIZ</h1>
            <p class="practice-quiz-topbar-subtitle">
              <span id="blackjackQuizProgress">Question 1</span>
            </p>
          </div>
          
          <div class="practice-quiz-topbar-right">
            <button class="practice-quiz-close-btn" onclick="resetBlackjackGame()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="practice-quiz-main">
        <!-- Competency Badge -->
        <div class="practice-quiz-competency-badge">
          <span id="blackjackQuizCompetency" class="practice-quiz-competency-text">BLACKJACK CHALLENGE</span>
        </div>

        <!-- Question -->
        <div class="practice-quiz-question-section">
          <h2 id="blackjackQuizQuestion" class="practice-quiz-question">Loading question...</h2>
          <p class="practice-quiz-question-hint">Select the best answer from the options below</p>
        </div>

        <!-- Answer Options -->
        <div id="blackjackQuizOptions" class="practice-quiz-options">
          <!-- Options will be populated dynamically -->
        </div>

        <!-- Progress Section -->
        <div class="practice-quiz-progress-section">
          <div class="practice-quiz-progress-header">
            <p class="practice-quiz-progress-label">Overall Progress</p>
            <p class="practice-quiz-progress-value"><span id="blackjackQuizProgressPercent">0</span>/100</p>
          </div>
          <div class="practice-quiz-progress-bar">
            <div class="practice-quiz-progress-fill" id="blackjackQuizProgressFill"></div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="practice-quiz-actions">
          <button id="blackjackQuizNextBtn" class="practice-quiz-next-btn" onclick="blackjackNextQuestion()" style="display: none;">Next Question</button>
        </div>
      </div>
    </div>

    <!-- Blackjack Game Phase -->
    <div id="blackjackGamePhase" style="display: none;">
      <div class="blackjack-top-bar">
        <h1 class="blackjack-title">BLACKJACK</h1>
        <div class="blackjack-stats-info">
          <div style="display: flex; gap: 2rem; color: white; font-weight: 700;">
            <div>Bankroll: <span style="color: #ff5722;" id="blackjackBankroll">$0</span></div>
            <div>Bet: <span style="color: #ff5722;" id="blackjackCurrentBet">$0</span></div>
          </div>
        </div>
      </div>
      
      <div class="blackjack-game-area">
        <div class="blackjack-dealer-section">
          <p class="blackjack-section-label">DEALER</p>
          <div class="blackjack-cards-container" id="blackjackDealerCards"></div>
          <p class="blackjack-hand-total" id="blackjackDealerTotal" style="display: none;">Total: <span style="color: #ff5722;" id="blackjackDealerTotalValue">0</span></p>
        </div>
        
        <div class="blackjack-player-section">
          <p class="blackjack-section-label">YOUR HAND</p>
          <div class="blackjack-cards-container" id="blackjackPlayerCards"></div>
          <p class="blackjack-hand-total" id="blackjackPlayerTotal">Total: <span style="color: #ff5722;" id="blackjackPlayerTotalValue">0</span></p>
        </div>
        
        <!-- Betting Phase -->
        <div id="blackjackBettingPhase" class="blackjack-betting-section">
          <p class="blackjack-betting-label">Place your bet:</p>
          <div class="blackjack-bet-buttons">
            <button class="blackjack-bet-btn" onclick="blackjackPlaceBet(10)">$10</button>
            <button class="blackjack-bet-btn" onclick="blackjackPlaceBet(25)">$25</button>
            <button class="blackjack-bet-btn" onclick="blackjackPlaceBet(50)">$50</button>
            <button class="blackjack-bet-btn" onclick="blackjackPlaceBet(100)">$100</button>
            <button class="blackjack-bet-btn" onclick="blackjackPlaceBet(250)">$250</button>
          </div>
        </div>
        
        <!-- Playing Phase -->
        <div id="blackjackPlayingPhase" class="blackjack-playing-section" style="display: none;">
          <button class="blackjack-action-btn blackjack-hit-btn" onclick="blackjackHit()">HIT</button>
          <button class="blackjack-action-btn blackjack-stand-btn" onclick="blackjackStand()">STAND</button>
        </div>
        
        <!-- Result Phase -->
        <div id="blackjackResultPhase" class="blackjack-result-section" style="display: none;">
          <p class="blackjack-result-text" id="blackjackResultText"></p>
          <button class="blackjack-play-again-btn" onclick="blackjackPlayAgain()" id="blackjackPlayAgainBtn">PLAY AGAIN</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Memory Match Game Container -->
  <div class="memory-game-container" id="memoryGameContainer" style="display: none;">
    <div class="memory-stars-bg" id="memoryStarsBg"></div>

    <!-- Menu Phase -->
    <div id="memoryMenuPhase" class="memory-menu-content">
      <h1 class="memory-menu-title">Memory</h1>
      <h2 class="memory-menu-subtitle">Match</h2>
      <p class="memory-menu-desc">Flip cards to find matching pairs. You have 10 turns!</p>
      <p class="memory-menu-subdesc">Match all pairs before your turns run out, or answer questions to get more turns.</p>
      <button class="memory-start-btn" onclick="startMemoryGamePlay()">START</button>
    </div>

    <!-- Quiz Phase -->
    <div id="memoryQuizPhase" class="practice-quiz-fullscreen" style="display: none;">
      <!-- Galaxy Background -->
      <div class="practice-quiz-galaxy-bg">
        <div class="practice-quiz-galaxy-gradient"></div>
        <div class="practice-quiz-stars-container" id="memoryQuizStarsContainer"></div>
        <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
        <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
        <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
      </div>

      <!-- Top Bar -->
      <div class="practice-quiz-topbar">
        <div class="practice-quiz-topbar-content">
          <div>
            <h1 class="practice-quiz-topbar-title" id="memoryQuizTitle">MEMORY QUIZ</h1>
            <p class="practice-quiz-topbar-subtitle">
              <span id="memoryQuizProgress">Question 1</span>
            </p>
          </div>
          
          <div class="practice-quiz-topbar-right">
            <button class="practice-quiz-close-btn" onclick="resetMemoryGame()">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="practice-quiz-main">
        <!-- Competency Badge -->
        <div class="practice-quiz-competency-badge">
          <span id="memoryQuizCompetency" class="practice-quiz-competency-text">MEMORY CHALLENGE</span>
        </div>

        <!-- Question -->
        <div class="practice-quiz-question-section">
          <h2 id="memoryQuizQuestion" class="practice-quiz-question">Loading question...</h2>
          <p class="practice-quiz-question-hint">Select the best answer from the options below</p>
        </div>

        <!-- Answer Options -->
        <div id="memoryQuizOptions" class="practice-quiz-options">
          <!-- Options will be populated dynamically -->
        </div>

        <!-- Progress Section -->
        <div class="practice-quiz-progress-section">
          <div class="practice-quiz-progress-header">
            <p class="practice-quiz-progress-label">Overall Progress</p>
            <p class="practice-quiz-progress-value"><span id="memoryQuizProgressPercent">0</span>/100</p>
          </div>
          <div class="practice-quiz-progress-bar">
            <div class="practice-quiz-progress-fill" id="memoryQuizProgressFill"></div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="practice-quiz-actions">
          <button id="memoryQuizNextBtn" class="practice-quiz-next-btn" onclick="memoryNextQuestion()" style="display: none;">Next Question</button>
        </div>
      </div>
    </div>

    <!-- Memory Game Phase -->
    <div id="memoryGamePhase" style="display: none;">
      <div class="memory-top-bar">
        <h1 class="memory-title">MEMORY MATCH</h1>
        <div class="memory-stats-info">
          <div style="display: flex; gap: 2rem; color: white; font-weight: 700;">
            <div>Matches: <span style="color: #ff5722;" id="memoryMatches">0</span>/8</div>
            <div>Turns: <span style="color: #ff5722;" id="memoryTurns">10</span></div>
          </div>
        </div>
      </div>
      
      <div class="memory-game-area">
        <div class="memory-cards-grid" id="memoryCardsGrid"></div>
        
        <!-- Game Complete -->
        <div id="memoryGameComplete" class="memory-complete-section" style="display: none;">
          <p class="memory-complete-text">YOU WON! </p>
          <p class="memory-complete-subtext" id="memoryCompleteSubtext">Matched all pairs in 10 turns!</p>
          <button class="memory-play-again-btn" onclick="resetMemoryGame()">PLAY AGAIN</button>
        </div>
        
        <!-- Out of Turns -->
        <div id="memoryOutOfTurns" class="memory-out-of-turns-section" style="display: none;">
          <p class="memory-out-of-turns-text">OUT OF TURNS!</p>
          <p class="memory-out-of-turns-subtext" id="memoryOutOfTurnsSubtext">You matched 0/8 pairs. Answer questions to get 5 more turns!</p>
          <button class="memory-answer-questions-btn" onclick="startMemoryQuizToResume()">ANSWER QUESTIONS</button>
        </div>
      </div>
    </div>
  </div>
  
</body>
</html>

