<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CertQuest Dashboard</title>
  <link rel="stylesheet" href="practice.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">üåê</div>
    <div class="nav-title"><div class="nav-pills">
    <a class="nav-pill" href="Public/Competitions/competition.html">Your Journey</a>
    <a class="nav-pill active" href="/practice.html">Practice Hub</a>
    <a class="nav-pill" href="/statistics.html">Your Statistics</a>
  </div></div>
    <div class="nav-right">
  <input type="text" id="navbarSearch" placeholder="Search CertQuest..." />
  <span class="search-icon" id="navbarSearchIcon">üîç</span>
  <div id="searchDropdown"></div>
</div>
  </div>

  <!-- Section Header -->
<div class="section-header-background glassmorphic">
  <!-- Competition header -->

<!-- Add these blobs to your HTML body -->
<div class="gradient-blob-1"></div>
<div class="gradient-blob-2"></div>
  <!-- Main title - Canva style -->
  <h1 class="main-title">What will you practice today?</h1>

<div class="search-section">
  <div class="search-container">
    <input type="text" placeholder="Search practice materials, topics and more..." class="main-search">
    <span class="search-icon">üîç</span>
  </div>
</div>

  <!-- Question tabs -->
  <div class="question-tabs glassmorphic">
    <div class="tab active" onclick="selectTab(this)">Resources</div>
    <div class="tab" onclick="selectTab(this)">Create</div> 
    <div class="tab" onclick="selectTab(this)">Judging</div> 
  </div>

  
</div>

<!-- Search bar section (optional - can be integrated into header) -->


  <div class="main-layout">
    <!-- Sidebar -->
      <aside class="sidebar">
      <div class="logo">CQ</div>
      <ul class="nav-icons">
  <li>
     <a href="/Public/home.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3L20 9V21H15V15H9V21H4V9L12 3Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M12 3L4 9V21H9V15H15V21H20V9L12 3Z" stroke="#3b82f6" stroke-width="2" fill="none" stroke-linejoin="round"/>
      <rect x="10" y="17" width="4" height="4" fill="#3b82f6"/>
      <rect x="6" y="11" width="2" height="2" fill="#3b82f6"/>
      <rect x="16" y="11" width="2" height="2" fill="#3b82f6"/>
    </svg>
    
    <span class="nav-label">Home</span>
     </a>
  </li>
  <li>
  <a href="#" onclick="openNotificationsOnHome(); return false;">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <!-- Bell body main fill -->
    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" fill="#3b82f6" fill-opacity="0.3"/>
    <!-- Bell body lighter overlay -->
    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 12 6 15 6 15H18C18 15 18 12 18 8Z" fill="#3b82f6" fill-opacity="0.2"/>
    <!-- Bell outline -->
    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
    <!-- Bell clapper -->
    <circle cx="12" cy="8" r="1" fill="#3b82f6"/>
    <!-- Sound waves -->
    <path d="M19 4L20 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
    <path d="M20.5 6.5L22 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
    <path d="M5 4L4 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
    <path d="M3.5 6.5L2 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
    <!-- Bottom notification indicator -->
    <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <span class="nav-label">Notifications</span>
</a>
</li>
  <li>
    <a href="/practice.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="9" fill="#3b82f6" fill-opacity="0.3"/>
      <circle cx="12" cy="12" r="6" fill="#3b82f6" fill-opacity="0.2"/>
      <circle cx="12" cy="12" r="9" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <circle cx="12" cy="12" r="6" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="3" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="1.5" fill="#3b82f6"/>
      <path d="M16 8L12 12L16 8Z" fill="#3b82f6"/>
      <line x1="16" y1="8" x2="19" y2="5" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Practice</span>
    </a>
  </li>
  <li>
    <a href="/Public/Forum/forum.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" fill="#3b82f6" fill-opacity="0.2"/>
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <line x1="11" y1="8" x2="17" y2="8" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="11" y1="10" x2="15" y2="10" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Forum</span>
    </a>
  </li>
  <li>
     <a href="/Public/Calendar/calendar.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="3" y="6" width="18" height="15" rx="2" fill="#3b82f6" fill-opacity="0.3"/>
      <rect x="3" y="6" width="18" height="4" rx="2" fill="#3b82f6" fill-opacity="0.2"/>
      <rect x="3" y="6" width="18" height="15" rx="2" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <line x1="7" y1="3" x2="7" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="17" y1="3" x2="17" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="10" x2="21" y2="10" stroke="#3b82f6" stroke-width="1" opacity="0.5"/>
      <line x1="7.5" y1="10" x2="7.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="12" y1="10" x2="12" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="16.5" y1="10" x2="16.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <circle cx="9" cy="13" r="1" fill="#3b82f6"/>
      <circle cx="15" cy="16" r="1" fill="#3b82f6"/>
      <circle cx="12" cy="18" r="1" fill="#3b82f6"/>
    </svg>
    <span class="nav-label">Calendar</span>
     </a>
  </li>
</ul>
    </aside>

    <!-- Sub Sidebar -->
    <aside class="sub-sidebar hidden">
      <div class="sidebar-header">
        <span id="comp"></span>
        <span class="dots">‚ãØ</span>
      </div>
      <div class="sub-nav-wrapper">
        <ul class="sub-nav"> 
          <li><a class="link" href="Public/Competitions/competition.html">Your Journey</a></li>
          <li class="active"><a href="/practice.html" class="link">Practice Hub</a></li>
          <li><a href="/statistics.html" class="link">Your Statistics</a></li>
        </ul>
      </div>
    </aside>
  </div>
<div class="content">
    <section class="challenge-card">
        <div class="challenge-header">
          <div class="challenge-info">
            <h2>FBLA Competitions Challenge</h2>
            <p>Compete against other competitions in a bracket style tournament match to see who the best competition is!</p>
            <button class="deadline-badge" onclick="toggleCompete()">Compete</button>
          </div>
        </div>
      </section>
    
      <div class="cards">
        <h3 class="studied">Recently studied <a href="flashcard.html" class="study">See all studied</a></h3>
      </div>
        
       
      <!-- üìö Assigned Section -->
      <section class="faq-wrapper">
        <div class="faq-category"><strong>Learning Zone</strong></div>
        <div class="accordion">
      
         
          
         <div class="accordion-item">
  <button class="accordion-toggle" onclick="toggleAccordion(this)">
    <span class="accordion-label">Your Incomplete Assignments</span>
    <i data-feather="chevron-down" class="chevron-icon"></i>
  </button>
  <div class="accordion-content hidden" id="incompleteAssignments">
    <p class="empty-msg">Loading assignments...</p>
  </div>
</div>


          <div class="accordion-item">
            <button class="accordion-toggle" onclick="toggleAccordion(this)">
              <span class="accordion-label">Speaking Practice</span>
              <i data-feather="chevron-down" class="chevron-icon"></i>
            </button>
            <div class="accordion-content hidden">
                written
            </div>
          </div>

          <div class="accordion-item">
            <button class="accordion-toggle" onclick="toggleAccordion(this)">
              <span class="accordion-label">Case Study Practice</span>
              <i data-feather="chevron-down" class="chevron-icon"></i>
            </button>
            <div class="accordion-content hidden">
                written
            </div>
          </div>
      
        </div>
      </section>
      <br>
      
</div>

<!-- Flashcard Modal -->
<div id="flashcardModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeFlashcardModal()">&times;</span>
    <div class="modal-header">
      <h2>Your Flashcard Decks</h2>
      <div class="competency-filter" id="competencyFilter"></div>
    </div>
    <div class="flashcard-view">
      <div class="flashcard-controls">
        <button id="prevCard">‚Üê Previous</button>
        <span id="cardCounter">1/10</span>
        <button id="nextCard">Next ‚Üí</button>
      </div>
      <div class="flashcard" id="currentFlashcard">
        <div class="flashcard-front">
          <h3>Loading flashcards...</h3>
        </div>
        <div class="flashcard-back hidden">
          <p>Answer will appear here</p>
        </div>
      </div>
      <div class="flashcard-actions">
        <button class="difficulty-btn easy" onclick="rateDifficulty('easy')">Easy</button>
        <button class="difficulty-btn medium" onclick="rateDifficulty('medium')">Medium</button>
        <button class="difficulty-btn hard" onclick="rateDifficulty('hard')">Hard</button>
      </div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>

<script>

    const firebaseConfig = {
    apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
    authDomain: "certquest-94959.firebaseapp.com",
    projectId: "certquest-94959",
    storageBucket: "certquest-94959.appspot.com",
    messagingSenderId: "323956529033",
    appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
    measurementId: "G-F5JHTGGN6K"
  };

 const competencyIcons = {
  'Business Communication': 'üí¨',
  'Marketing': 'üìà',
  'Accounting': 'üí∞',
  'Economics': 'üìä',
  'Management': 'üë•',
  'Parliamentary Procedure': '‚öñÔ∏è',
  'Business Ethics': 'ü§ù',
  'Finance': 'üí≥',
  'Entrepreneurship': 'üöÄ',
  'General': 'üìö'
};

const competitionTypes = {
  'written': 'üìù',
  'speaking': 'üé§', 
  'case': 'üíº'
};



  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
let recentlyStudiedDecks = [];
let currentDeck = null;
let currentCardIndex = 0;
let isFlipped = false;
let timer; // For quiz timer



// Close flashcard modal
function closeFlashcardModal() {
  document.getElementById('flashcardModal').style.display = 'none';
  currentDeck = null;
  currentCardIndex = 0;
  isFlipped = false;
}

function openNotificationsOnHome() {
    // Set a flag in sessionStorage (gets cleared when browser is closed)
    sessionStorage.setItem('openNotifications', 'true');
    // Navigate to home page - CHANGE THIS PATH to match your structure
    window.location.href = 'public/home.html';
}

// Show current flashcard
function showCurrentFlashcard() {
  if (!currentDeck || !currentDeck.cards.length) return;
  
  const card = currentDeck.cards[currentCardIndex];
  const flashcardElement = document.getElementById('currentFlashcard');
  const counterElement = document.getElementById('cardCounter');
  
  // Update counter
  counterElement.textContent = `${currentCardIndex + 1}/${currentDeck.cards.length}`;
  
  // Reset flip state
  isFlipped = false;
  flashcardElement.classList.remove('flipped');
  
  // Update card content
  flashcardElement.querySelector('.flashcard-front h3').textContent = card.question;
  flashcardElement.querySelector('.flashcard-back p').innerHTML = `
    <strong>Correct Answer:</strong> ${card.answer}<br>
    ${card.userAnswer ? `<strong>Your Answer:</strong> ${card.userAnswer}` : ''}
  `;
  
  // Add click to flip
  flashcardElement.onclick = () => {
    isFlipped = !isFlipped;
    flashcardElement.classList.toggle('flipped');
  };
}

async function loadCompetitionName() {
  try {
    const user = firebase.auth().currentUser;
    
    if (!user) {
      console.log('No user authenticated, waiting...');
      return;
    }
    
    const userId = user.uid;
    console.log('üî• Loading competition for user:', userId);
    
    // Get user document
    const userDoc = await db.collection('users').doc(userId).get();
    
    if (!userDoc.exists) {
      console.log('User document not found');
      document.getElementById('comp').textContent = 'User not found';
      return;
    }
    
    const userData = userDoc.data();
    const competitions = userData.competitions;
    
    // DEBUG: Log the entire competitions array
    console.log('üîç DEBUG - Full competitions array:', competitions);
    console.log('üîç DEBUG - Type of first competition:', typeof competitions[0]);
    console.log('üîç DEBUG - First competition value:', competitions[0]);
    
    if (!competitions || competitions.length === 0) {
      document.getElementById('comp').textContent = 'No competition assigned';
      return;
    }
    
    const competitionValue = competitions[0];
    
    // If it looks like a name string, use it directly
    if (typeof competitionValue === 'string' && competitionValue.length > 0) {
      console.log('‚úÖ Using competition name directly:', competitionValue);
      document.getElementById('comp').textContent = competitionValue;
      return;
    }
    
    // Otherwise try to look it up as a document ID
    console.log('üî• Looking for competition as document ID:', competitionValue);
    const competitionDoc = await db.collection('competitions').doc(competitionValue).get();
    
    if (!competitionDoc.exists) {
      console.log('‚ùå Competition document not found:', competitionValue);
      document.getElementById('comp').textContent = 'Competition not found';
      return;
    }
    
    const competitionData = competitionDoc.data();
    const competitionName = competitionData.name || 'Unnamed Competition';
    
    console.log('‚úÖ Found competition name:', competitionName);
    document.getElementById('comp').textContent = competitionName;
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    document.getElementById('comp').textContent = 'Error loading';
  }
}

// Make sure this runs AFTER authentication
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    console.log('üî• User authenticated, loading competition...');
    loadCompetitionName();
    loadIncompleteAssignments();
    loadRecentlyStudiedDecks();
  }
});
// Call when auth state changes
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadCompetitionName();
  }
});


    // Tab selection + underline animation
    function selectTab(selectedTab) {
      const tabText = selectedTab.textContent.trim();
  
      // Redirect if "Create" is clicked
      if (tabText === "Create") {
        window.location.href = "create.html"; // replace with your correct path
        return;
      }

      if (tabText === "Resources") {
        window.location.href = "practice.html"; // replace with your correct path
        return;
      }

      if (tabText === "Judging") {
        window.location.href = "judging.html"; // replace with your correct path
        return;
      }
  
      // Handle in-page tab selection
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      selectedTab.classList.add('active');
  
      const underline = document.querySelector('.tab-underline');
      underline.style.transform = `translateX(${selectedTab.offsetLeft}px)`;
      underline.style.width = `${selectedTab.offsetWidth}px`;
    }
  
    // On page load: position underline
    window.addEventListener('load', () => {
      const activeTab = document.querySelector('.tab.active');
      const underline = document.querySelector('.tab-underline');
      if (activeTab && underline) {
        underline.style.transform = `translateX(${activeTab.offsetLeft}px)`;
        underline.style.width = `${activeTab.offsetWidth}px`;
      }
  
      feather.replace(); // renders all feather icons
    });
  
    // Accordion toggle logic
  // ============ MEILISEARCH INTEGRATION ============
    // Meilisearch client setup (adjust if you use a different host)
    const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
    const index = client.index('content');
    const searchBox = document.getElementById('navbarSearch');
    const searchDropdown = document.getElementById('searchDropdown');
    const searchIcon = document.getElementById('navbarSearchIcon');

    if (searchBox && searchDropdown) {
      searchBox.addEventListener('input', async function(e) {
        const query = e.target.value.trim();
        if (!query) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
          return;
        }
        try {
          const result = await index.search(query, { limit: 5 });
          if (!result.hits.length) {
            searchDropdown.style.display = 'none';
            searchDropdown.innerHTML = '';
            return;
          }
          searchDropdown.style.display = 'block';
          searchDropdown.innerHTML = result.hits.map(doc => `
            <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
              <b>${doc.title}</b><br>
              <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
            </div>
          `).join('');
        } catch (err) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
        }
      });

      // Handle result click
      searchDropdown.addEventListener('click', function(e) {
        const target = e.target.closest('.dropdown-result');
        if (target && target.dataset.url) {
          window.location = target.dataset.url;
        }
      });

      // Optional: Allow Enter key to open first result
      searchBox.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && searchDropdown.innerHTML) {
          const first = searchDropdown.querySelector('.dropdown-result');
          if (first && first.dataset.url) {
            window.location = first.dataset.url;
          }
        }
      });

      // Hide dropdown on outside click
      document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.style.display = 'none';
        }
      });

      // Click magnifier icon triggers search
      if (searchIcon) {
        searchIcon.addEventListener('click', () => {
          searchBox.dispatchEvent(new Event('input'));
        });
      }
    }
    // =========== END MEILISEARCH ============
function capitalize(word) {
      return word.charAt(0).toUpperCase() + word.slice(1);
    }

async function loadRecentlyStudiedDecks() {
  console.log('=== Starting loadRecentlyStudiedDecks ===');
  try {
    const user = firebase.auth().currentUser;
    
    if (!user) {
      renderEmptyRecentlyStudied();
      return;
    }

    // Simple query to avoid index issues
    const assignmentsSnapshot = await db.collection('assignments')
      .where('to', '==', user.uid)
      .where('status', '==', 'complete')
      .limit(10)
      .get();

    console.log('Completed assignments found:', assignmentsSnapshot.size);

    if (assignmentsSnapshot.empty) {
      renderEmptyRecentlyStudied();
      return;
    }

    // Process assignments to create flashcard decks from missed questions
    const decksByCompetency = {};
    
    assignmentsSnapshot.forEach(doc => {
      const assignment = doc.data();
      
      // Only process written assignments
      if (assignment.type !== 'written' || !assignment.detailedAnswers) {
        return;
      }
      
      console.log('Processing written assignment:', assignment.title);
      
      // Process detailedAnswers array to find incorrect answers
      assignment.detailedAnswers.forEach((answer) => {
        // Only add incorrect answers to flashcards
        if (answer.isCorrect === false) {
          const competency = answer.competency || 'General';
          
          if (!decksByCompetency[competency]) {
            decksByCompetency[competency] = {
              cards: [],
              lastStudied: assignment.completedAt || new Date()
            };
          }
          
          decksByCompetency[competency].cards.push({
            question: answer.question,
            answer: answer.correctAnswer,
            userAnswer: answer.userAnswer,
            competency: competency,
            source: assignment.title || 'Written Practice',
            difficulty: assignment.difficulty || 'medium'
          });
        }
      });
    });

    console.log('Final decks created:', Object.keys(decksByCompetency));
    
    // Store the decks
    recentlyStudiedDecks = decksByCompetency;
    
    // Render the decks
    renderRecentlyStudiedDecks(decksByCompetency);
    
  } catch (error) {
    console.error("Error in loadRecentlyStudiedDecks:", error);
    renderEmptyRecentlyStudied();
  }
}

// Updated renderRecentlyStudiedDecks function
function renderRecentlyStudiedDecks(decks) {
  const container = document.querySelector('.cards');
  
  if (!container) {
    console.error('Cards container not found');
    return;
  }
  
  const studiedHeader = container.querySelector('.studied');
  
  // Remove old flashcard deck cards
  const oldFlashcardDecks = container.querySelectorAll('.flashcard-deck-card');
  oldFlashcardDecks.forEach(card => card.remove());

  if (Object.keys(decks).length === 0) {
    renderEmptyRecentlyStudied();
    return;
  }

  // Update the header to show count
  if (studiedHeader) {
    const deckCount = Object.keys(decks).length;
    studiedHeader.innerHTML = `Recently studied (${deckCount} topics) <a href="flashcard.html" class="study">See all studied</a>`;
  }

  // Create flashcard deck cards - show top 3 competencies with most missed questions
  const sortedDecks = Object.entries(decks)
    .sort(([,a], [,b]) => b.cards.length - a.cards.length)
    .slice(0, 3);

  sortedDecks.forEach(([competency, deckData]) => {
    const icon = competencyIcons[competency] || 'üìö';
    const cardCount = deckData.cards.length;
    
    const deckCard = document.createElement('div');
    deckCard.className = 'schoolhouse-card flashcard-deck-card';
    
    deckCard.innerHTML = `
      <div class="card-content">
        <div class="card-header">
          <span class="card-icon">${icon}</span>
          <h3>${competency}</h3>
        </div>
        <p class="desc">${cardCount} missed questions to review</p>
        <a href="#" class="study-deck-link">Study Now ‚Üí</a>
      </div>
    `;
    
    // Add click handler
    const studyLink = deckCard.querySelector('.study-deck-link');
    studyLink.addEventListener('click', (e) => {
      e.preventDefault();
      openFlashcardModal(competency, deckData.cards);
    });
    
    // Insert after the "Recently studied" header
    if (studiedHeader && studiedHeader.nextElementSibling) {
      container.insertBefore(deckCard, studiedHeader.nextElementSibling);
    } else if (studiedHeader) {
      studiedHeader.insertAdjacentElement('afterend', deckCard);
    } else {
      container.appendChild(deckCard);
    }
  });
}

// Render empty state for recently studied
function renderEmptyRecentlyStudied() {
  const studiedHeader = document.querySelector('.studied');
  if (studiedHeader) {
    studiedHeader.innerHTML = 'Recently studied <a href="flashcard.html" class="study">See all studied ‚Üí</a>';
  }
}

// Open flashcard modal
function openFlashcardModal(competency, cards) {
  try {
    // Parse cards if they're a string
    if (typeof cards === 'string') {
      cards = JSON.parse(cards);
    }
    
    // Validate cards array
    if (!Array.isArray(cards) || cards.length === 0) {
      console.error('Invalid cards data:', cards);
      alert('No flashcards available for this competency.');
      return;
    }
    
    // Store the deck data in localStorage for flashcard.html to retrieve
    const deckData = {
      name: competency,
      cards: cards,
      source: 'missed_questions',
      timestamp: Date.now()
    };
    
    localStorage.setItem('currentFlashcardDeck', JSON.stringify(deckData));
    
    // Redirect to flashcard.html with competency parameter
    window.location.href = `flashcard.html?deck=${encodeURIComponent(competency)}&source=missed`;
    
  } catch (error) {
    console.error('Error opening flashcard deck:', error);
    alert('Error loading flashcards. Please try again.');
  }
}

function toggleAccordion(button) {
  const content = button.nextElementSibling;
  const icon = button.querySelector('.chevron-icon');
  
  const isHidden = content.classList.contains('hidden');
  
  if (isHidden) {
    // Open accordion
    button.classList.add('active');
    content.classList.remove('hidden');
    content.style.maxHeight = content.scrollHeight + "px";
    if (icon) icon.classList.add('rotate');
  } else {
    // Close accordion
    button.classList.remove('active');
    content.classList.add('hidden');
    content.style.maxHeight = "0px";
    if (icon) icon.classList.remove('rotate');
  }
  
  feather.replace();
}

    function startAssignment(id, type) {
      alert(`Starting ${type} assignment with ID: ${id}`);
      // You can redirect or load another modal here
    }

function toggleCompete() {
  // Create modal overlay
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  `;

  // Create modal content
  const modal = document.createElement('div');
  modal.style.cssText = `
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    position: relative;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  `;

  modal.innerHTML = `
    <button style="
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: #9CA3AF;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    " onclick="this.closest('.modal-overlay').remove()">√ó</button>
    
    <h2 style="
      font-size: 24px;
      font-weight: 600;
      color: #111827;
      margin: 0 0 16px 0;
    ">Challenge</h2>
    
    <p style="
      font-size: 16px;
      color: #6B7280;
      margin: 0 0 24px 0;
      line-height: 1.5;
    ">Choose your competition type and get ready to compete!</p>
    
    <div style="
      margin-bottom: 32px;
    ">
      <label style="
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 12px;
        display: block;
      ">Competition Type</label>
      
      <div style="
        display: flex;
        flex-direction: column;
        gap: 12px;
      ">
        <label style="
          display: flex;
          align-items: center;
          padding: 16px;
          border: 2px solid #E5E7EB;
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
          background: white;
        " onmouseover="this.style.borderColor='#3B82F6'; this.style.backgroundColor='#F8FAFC';" 
           onmouseout="updateBorderColor(this);" 
           onclick="selectCompetitionType(this, 'written')">
          <input type="radio" name="competitionType" value="written" style="
            margin-right: 12px;
            width: 16px;
            height: 16px;
            accent-color: #3B82F6;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 4px;
            ">
              <span style="font-size: 18px; margin-right: 8px;">üìù</span>
              <span style="font-weight: 600; color: #111827;">Written</span>
            </div>
            <div style="
              font-size: 13px;
              color: #6B7280;
            ">Test your knowledge with written questions and problems</div>
          </div>
        </label>
        
        <label style="
          display: flex;
          align-items: center;
          padding: 16px;
          border: 2px solid #E5E7EB;
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
          background: white;
        " onmouseover="this.style.borderColor='#3B82F6'; this.style.backgroundColor='#F8FAFC';" 
           onmouseout="updateBorderColor(this);" 
           onclick="selectCompetitionType(this, 'speaking')">
          <input type="radio" name="competitionType" value="speaking" style="
            margin-right: 12px;
            width: 16px;
            height: 16px;
            accent-color: #3B82F6;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 4px;
            ">
              <span style="font-size: 18px; margin-right: 8px;">üé§</span>
              <span style="font-weight: 600; color: #111827;">Speaking</span>
            </div>
            <div style="
              font-size: 13px;
              color: #6B7280;
            ">Demonstrate your presentation and communication skills</div>
          </div>
        </label>
        
        <label style="
          display: flex;
          align-items: center;
          padding: 16px;
          border: 2px solid #E5E7EB;
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
          background: white;
        " onmouseover="this.style.borderColor='#3B82F6'; this.style.backgroundColor='#F8FAFC';" 
           onmouseout="updateBorderColor(this);" 
           onclick="selectCompetitionType(this, 'case')">
          <input type="radio" name="competitionType" value="case" style="
            margin-right: 12px;
            width: 16px;
            height: 16px;
            accent-color: #3B82F6;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 4px;
            ">
              <span style="font-size: 18px; margin-right: 8px;">üíº</span>
              <span style="font-weight: 600; color: #111827;">Case Study</span>
            </div>
            <div style="
              font-size: 13px;
              color: #6B7280;
            ">Analyze business scenarios and provide strategic solutions</div>
          </div>
        </label>
      </div>
    </div>
    
    <div style="
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    ">
      <button style="
        padding: 8px 16px;
        border: 1px solid #D1D5DB;
        background: white;
        color: #374151;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
      " onclick="this.closest('.modal-overlay').remove()">Cancel</button>
      
      <button id="startChallengeBtn" style="
        padding: 8px 16px;
        background: #9CA3AF;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: not-allowed;
        font-size: 14px;
        font-weight: 500;
        opacity: 0.6;
      " disabled onclick="startChallengeWithType()">Start Challenge</button>
    </div>
  `;

  overlay.appendChild(modal);
  overlay.className = 'modal-overlay';
  
  // Close on overlay click
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.remove();
    }
  });

  document.body.appendChild(overlay);
}

function updateBorderColor(element) {
  const radio = element.querySelector('input[type="radio"]');
  if (radio && radio.checked) {
    element.style.borderColor = '#3B82F6';
    element.style.backgroundColor = '#EFF6FF';
  } else {
    element.style.borderColor = '#E5E7EB';
    element.style.backgroundColor = 'white';
  }
}

function selectCompetitionType(labelElement, type) {
  // Update all labels to default state
  const allLabels = document.querySelectorAll('label[onclick*="selectCompetitionType"]');
  allLabels.forEach(label => {
    label.style.borderColor = '#E5E7EB';
    label.style.backgroundColor = 'white';
  });
  
  // Highlight selected label
  labelElement.style.borderColor = '#3B82F6';
  labelElement.style.backgroundColor = '#EFF6FF';
  
  // Enable the start button
  const startBtn = document.getElementById('startChallengeBtn');
  startBtn.style.background = '#3B82F6';
  startBtn.style.cursor = 'pointer';
  startBtn.style.opacity = '1';
  startBtn.disabled = false;
  
  // Store selected type
  window.selectedCompetitionType = type;
}

// Updated start challenge function
async function startChallengeWithType() {
  const selectedType = window.selectedCompetitionType;
  
  if (!selectedType) {
    alert('Please select a competition type');
    return;
  }
  
  // Remove modal
  document.querySelector('.modal-overlay').remove();
  
  // Show loading state
  showLoadingScreen();
  
  try {
    // Get current user's team and find opponent
    const { currentTeam, opponentTeam, hasAvailableOpponents } = await findTeamsForCompetition();
    
    // Create fullscreen competition page with selected type
    createCompetitionPage(currentTeam, opponentTeam, hasAvailableOpponents, selectedType);
  } catch (error) {
    console.error('Error starting challenge:', error);
    // Show error state or fallback
    createCompetitionPage('Your Team', 'Loading...', false, selectedType);
  }
}


async function startChallenge() {
  // Remove modal
  document.querySelector('.modal-overlay').remove();
  
  // Show loading state
  showLoadingScreen();
  
  try {
    // Get current user's team and find opponent
    const { currentTeam, opponentTeam, hasAvailableOpponents } = await findTeamsForCompetition();
    
    // Create fullscreen competition page
    createCompetitionPage(currentTeam, opponentTeam, hasAvailableOpponents);
  } catch (error) {
    console.error('Error starting challenge:', error);
    // Show error state or fallback
    createCompetitionPage('Your Team', 'Loading...', false);
  }
}



function showLoadingScreen() {
  const loadingPage = document.createElement('div');
  loadingPage.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  `;
  
  loadingPage.innerHTML = `
    <div style="text-align: center;">
      <div style="
        font-size: 24px;
        color: #00d4ff;
        margin-bottom: 20px;
        animation: pulse 1.5s ease-in-out infinite;
      ">Finding opponents...</div>
      <div style="
        width: 40px;
        height: 40px;
        border: 3px solid rgba(0, 212, 255, 0.3);
        border-top: 3px solid #00d4ff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
      "></div>
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
    </style>
  `;
  
  loadingPage.id = 'loading-page';
  document.body.appendChild(loadingPage);
}

async function findTeamsForCompetition() {
  // Get current user ID (you'll need to implement this based on your auth system)
  const currentUserId = getCurrentUserId(); // You need to implement this
  
  if (!currentUserId) {
    throw new Error('User not authenticated');
  }
  
  // Get current user's data
  const currentUserRef = db.collection('users').doc(currentUserId);
  const currentUserDoc = await currentUserRef.get();
  
  if (!currentUserDoc.exists) {
    throw new Error('User not found');
  }
  
  const currentUserData = currentUserDoc.data();
  const currentUserCompetitions = currentUserData.competitions;
  
  // Check if competitions exists and is an array
  if (!Array.isArray(currentUserCompetitions)) {
    throw new Error('User has no competitions or competitions is not an array');
  }
  
  // Filter out mentorCompetition entries and get regular competitions
  const regularCompetitions = currentUserCompetitions.filter(comp => 
    typeof comp === 'string' && comp !== 'mentorCompetition'
  );
  
  if (regularCompetitions.length === 0) {
    throw new Error('User has no regular competitions');
  }
  
  // Use the first competition as current team
  const currentTeam = regularCompetitions[0];
  
  console.log('Current user team:', currentTeam);
  console.log('Current user competitions:', regularCompetitions);
  
  // Get all users to find potential opponents
  const usersSnapshot = await db.collection('users').get();
  const availableOpponents = [];
  
  usersSnapshot.forEach(doc => {
    const userData = doc.data();
    const userId = doc.id;
    
    // Skip current user
    if (userId === currentUserId) return;
    
    // Check if user has competitions and it's an array
    const userCompetitions = userData.competitions;
    if (!Array.isArray(userCompetitions)) {
      console.log(`User ${userId} has no competitions array`);
      return;
    }
    
    const userRegularCompetitions = userCompetitions.filter(comp => 
      typeof comp === 'string' && comp !== 'mentorCompetition'
    );
    
    // Check if user has competitions, is not currently competing, AND is not in the same competition
    if (userRegularCompetitions.length > 0 && !userData.isActivelyCompeting) {
      // Case-insensitive check to ensure not same competition
      const isSameCompetition = regularCompetitions.some(currentComp => 
        userRegularCompetitions.some(userComp => 
          currentComp.toLowerCase() === userComp.toLowerCase()
        )
      );
      
      if (!isSameCompetition) {
        const opponentTeamName = userRegularCompetitions[0];
        console.log(`Adding opponent: ${userId} with team: ${opponentTeamName}`);
        availableOpponents.push({
          userId: userId,
          teamName: opponentTeamName,
          userData: userData
        });
      } else {
        console.log(`Skipping user ${userId} - same competition`);
      }
    }
  });
  
  console.log('Available opponents found:', availableOpponents.length);
  console.log('Opponents:', availableOpponents);
  
  let opponentTeam = 'Waiting for opponents...';
  let hasAvailableOpponents = availableOpponents.length > 0;
  
  if (hasAvailableOpponents) {
    // Select random opponent
    const randomOpponent = availableOpponents[Math.floor(Math.random() * availableOpponents.length)];
    opponentTeam = randomOpponent.teamName;
    
    // Optional: Mark both users as actively competing
    await Promise.all([
      currentUserRef.update({ isActivelyCompeting: true }),
      db.collection('users').doc(randomOpponent.userId).update({ isActivelyCompeting: true })
    ]);
  }
  
  return {
    currentTeam,
    opponentTeam,
    hasAvailableOpponents
  };
}

function getCurrentUserId() {
  // Using Firebase Auth to get current user
  return firebase.auth().currentUser?.uid;
}

async function notifyTeamsReady() {
  // This function will notify other teams that someone is ready to compete
  try {
    // You can implement this by:
    // 1. Adding a notification to a global notifications collection
    // 2. Updating a "seeking opponents" status
    // 3. Sending push notifications to other users
    
    const currentUserId = getCurrentUserId();
    const currentUserRef = db.collection('users').doc(currentUserId);
    
    // Mark user as seeking opponents
    await currentUserRef.update({
      seekingOpponents: true,
      lastSeekingTime: new Date()
    });
    
    // Add to a global ready queue (optional)
    await db.collection('readyToCompete').add({
      userId: currentUserId,
      timestamp: new Date(),
      status: 'seeking'
    });
    
    alert('Other teams have been notified that you\'re ready to compete!');
    
  } catch (error) {
    console.error('Error notifying teams:', error);
    alert('Failed to notify other teams. Please try again.');
  }
}

function createCompetitionPage(currentTeam, opponentTeam, hasAvailableOpponents) {
  // Remove loading screen
  const loadingPage = document.getElementById('loading-page');
  if (loadingPage) loadingPage.remove();
  
  // Create fullscreen competition page
  const competePage = document.createElement('div');
  competePage.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    overflow: hidden;
  `;

  competePage.innerHTML = `
    <div style="
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 80%, #0066ff33 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, #ff006633 0%, transparent 50%);
      opacity: 0.7;
    "></div>
    
    <div style="
      text-align: center;
      z-index: 1;
      max-width: 800px;
      padding: 0 20px;
    ">
      <div style="
        font-size: 64px;
        font-weight: 800;
        background: linear-gradient(45deg, #00d4ff, #ff0080);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 40px;
        text-transform: uppercase;
        letter-spacing: 3px;
        animation: glow 2s ease-in-out infinite alternate;
      ">COMPETING</div>
      
      <div style="
        font-size: 24px;
        color: #ffffff;
        margin-bottom: 20px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 0.5s forwards;
      ">You are competing against</div>
      
      <div id="team1" style="
        font-size: 36px;
        font-weight: 700;
        color: #00d4ff;
        margin-bottom: 30px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 1s forwards;
        text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
      ">${currentTeam.toUpperCase()}</div>
      
      <div style="
        font-size: 48px;
        color: #ff0080;
        margin: 20px 0;
        opacity: 0;
        animation: fadeInUp 1s ease-out 1.5s forwards;
      ">VS</div>
      
      <div id="team2" style="
        font-size: 36px;
        font-weight: 700;
        color: #ff0080;
        margin-bottom: 60px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 2s forwards;
        text-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
      ">${opponentTeam.toUpperCase()}</div>
      
      ${!hasAvailableOpponents ? `
        <div style="
          background: rgba(255, 165, 0, 0.1);
          border: 1px solid rgba(255, 165, 0, 0.3);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 30px;
          opacity: 0;
          animation: fadeInUp 1s ease-out 2.2s forwards;
        ">
          <div style="color: #ffa500; font-size: 18px; margin-bottom: 10px;">‚ö†Ô∏è No opponents available</div>
          <div style="color: #ffffff; font-size: 14px; margin-bottom: 15px;">
            There are currently no teams available to compete against.
          </div>
          <button onclick="notifyTeamsReady()" style="
            padding: 10px 20px;
            background: linear-gradient(45deg, #ffa500, #ff8c00);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
          ">Notify Other Teams</button>
        </div>
      ` : ''}
      
      <div style="
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
        opacity: 0;
        animation: fadeInUp 1s ease-out 2.5s forwards;
      ">
        <button onclick="closeCompetePage()" style="
          padding: 15px 30px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.3);
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.1)'">‚Üê Back</button>
        
        <button onclick="viewBracket()" style="
          padding: 15px 30px;
          background: rgba(0, 212, 255, 0.2);
          border: 2px solid #00d4ff;
          color: #00d4ff;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        " onmouseover="this.style.background='rgba(0,212,255,0.3)'" 
           onmouseout="this.style.background='rgba(0,212,255,0.2)'">View Bracket</button>
        
        <button style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #00d4ff, #ff0080);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
          box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
          transition: all 0.3s ease;
          ${!hasAvailableOpponents ? 'opacity: 0.5; cursor: not-allowed;' : ''}
        " ${hasAvailableOpponents ? `onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : 'disabled'}>
          ${hasAvailableOpponents ? 'Compete Now' : 'Waiting for Opponents'}
        </button>
      </div>
    </div>
    
    <style>
      @keyframes glow {
        from { text-shadow: 0 0 20px rgba(0, 212, 255, 0.5), 0 0 30px rgba(255, 0, 128, 0.3); }
        to { text-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 0 40px rgba(255, 0, 128, 0.6); }
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  `;

  competePage.id = 'compete-page';
  document.body.appendChild(competePage);
}


function createCompetitionPage(currentTeam, opponentTeam, hasAvailableOpponents, competitionType = 'written') {
   const typeIcon = competitionTypes[competitionType] || 'üìö';
  const typeName = competitionType.charAt(0).toUpperCase() + competitionType.slice(1);
  
  // Remove loading screen
  const loadingPage = document.getElementById('loading-page');
  if (loadingPage) loadingPage.remove();
  
  // Create fullscreen competition page
  const competePage = document.createElement('div');
  competePage.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    overflow: hidden;
  `;

  competePage.innerHTML = `
    <div style="
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 80%, #0066ff33 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, #ff006633 0%, transparent 50%);
      opacity: 0.7;
    "></div>
    
    <div style="
      text-align: center;
      z-index: 1;
      max-width: 800px;
      padding: 0 20px;
    ">
      <div style="
        font-size: 64px;
        font-weight: 800;
        background: linear-gradient(45deg, #00d4ff, #ff0080);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 20px;
        text-transform: uppercase;
        letter-spacing: 3px;
        animation: glow 2s ease-in-out infinite alternate;
      ">COMPETING</div>
      
      <div style="
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 40px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 0.3s forwards;
      ">
        <span style="font-size: 32px; margin-right: 12px;">${typeIcon}</span>
        <span style="
          font-size: 24px;
          color: #ffffff;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
        ">${typeName} Competition</span>
      </div>
      
      <div style="
        font-size: 24px;
        color: #ffffff;
        margin-bottom: 20px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 0.5s forwards;
      ">You are competing against</div>
      
      <div id="team1" style="
        font-size: 36px;
        font-weight: 700;
        color: #00d4ff;
        margin-bottom: 30px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 1s forwards;
        text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
      ">${currentTeam.toUpperCase()}</div>
      
      <div style="
        font-size: 48px;
        color: #ff0080;
        margin: 20px 0;
        opacity: 0;
        animation: fadeInUp 1s ease-out 1.5s forwards;
      ">VS</div>
      
      <div id="team2" style="
        font-size: 36px;
        font-weight: 700;
        color: #ff0080;
        margin-bottom: 60px;
        opacity: 0;
        animation: fadeInUp 1s ease-out 2s forwards;
        text-shadow: 0 0 20px rgba(255, 0, 128, 0.5);
      ">${opponentTeam.toUpperCase()}</div>
      
      ${!hasAvailableOpponents ? `
        <div style="
          background: rgba(255, 165, 0, 0.1);
          border: 1px solid rgba(255, 165, 0, 0.3);
          border-radius: 12px;
          padding: 20px;
          margin-bottom: 30px;
          opacity: 0;
          animation: fadeInUp 1s ease-out 2.2s forwards;
        ">
          <div style="color: #ffa500; font-size: 18px; margin-bottom: 10px;">‚ö†Ô∏è No opponents available</div>
          <div style="color: #ffffff; font-size: 14px; margin-bottom: 15px;">
            There are currently no teams available to compete against.
          </div>
          <button onclick="notifyTeamsReady()" style="
            padding: 10px 20px;
            background: linear-gradient(45deg, #ffa500, #ff8c00);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
          ">Notify Other Teams</button>
        </div>
      ` : ''}
      
      <div style="
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
        opacity: 0;
        animation: fadeInUp 1s ease-out 2.5s forwards;
      ">
        <button onclick="closeCompetePage()" style="
          padding: 15px 30px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.3);
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        " onmouseover="this.style.background='rgba(255,255,255,0.2)'" 
           onmouseout="this.style.background='rgba(255,255,255,0.1)'">‚Üê Back</button>
        
        <button onclick="viewBracket()" style="
          padding: 15px 30px;
          background: rgba(0, 212, 255, 0.2);
          border: 2px solid #00d4ff;
          color: #00d4ff;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
          transition: all 0.3s ease;
        " onmouseover="this.style.background='rgba(0,212,255,0.3)'" 
           onmouseout="this.style.background='rgba(0,212,255,0.2)'">View Bracket</button>
        
        <button onclick="startCompetitionWithType('${competitionType}')" style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #00d4ff, #ff0080);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 1px;
          box-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
          transition: all 0.3s ease;
          ${!hasAvailableOpponents ? 'opacity: 0.5; cursor: not-allowed;' : ''}
        " ${hasAvailableOpponents ? `onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'"` : 'disabled'}>
          ${hasAvailableOpponents ? `Start ${typeName} Competition` : 'Waiting for Opponents'}
        </button>
      </div>
    </div>
    
    <style>
      @keyframes glow {
        from { text-shadow: 0 0 20px rgba(0, 212, 255, 0.5), 0 0 30px rgba(255, 0, 128, 0.3); }
        to { text-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 0 40px rgba(255, 0, 128, 0.6); }
      }
      
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  `;

  competePage.id = 'compete-page';
  document.body.appendChild(competePage);
}
function closeCompetePage() {
  const competePage = document.getElementById('compete-page');
  if (competePage) {
    competePage.remove();
  }
}

async function viewBracket() {
  // Close competition page
  closeCompetePage();
  
  // Show loading
  showLoadingScreen();
  
  try {
    // Get all user pairings for the bracket
    const pairings = await getAllCompetitionPairings();
    createBracketView(pairings);
  } catch (error) {
    console.error('Error loading bracket:', error);
    // Remove loading and show error
    const loadingPage = document.getElementById('loading-page');
    if (loadingPage) loadingPage.remove();
    alert('Failed to load bracket. Please try again.');
  }
}

async function getAllCompetitionPairings() {
  const usersSnapshot = await db.collection('users').get();
  const usersByCompetition = {};
  const pairings = [];
  
  // Group users by competition
  usersSnapshot.forEach(doc => {
    const userData = doc.data();
    const userId = doc.id;
    const userCompetitions = userData.competitions;
    
    if (Array.isArray(userCompetitions)) {
      const regularCompetitions = userCompetitions.filter(comp => 
        typeof comp === 'string' && comp !== 'mentorCompetition'
      );
      
      if (regularCompetitions.length > 0) {
        const competition = regularCompetitions[0];
        if (!usersByCompetition[competition]) {
          usersByCompetition[competition] = [];
        }
        usersByCompetition[competition].push({
          uid: userId,
          name: userData.name || `User ${userId.slice(0, 6)}`,
          competition: competition,
          isActivelyCompeting: userData.isActivelyCompeting || false
        });
      }
    }
  });
  
  // Create pairings from different competitions
  const competitions = Object.keys(usersByCompetition);
  console.log('Competitions found:', competitions);
  console.log('Users by competition:', usersByCompetition);
  
  // Generate all possible matchups between different competitions
  for (let i = 0; i < competitions.length; i++) {
    for (let j = i + 1; j < competitions.length; j++) {
      const comp1 = competitions[i];
      const comp2 = competitions[j];
      const users1 = usersByCompetition[comp1];
      const users2 = usersByCompetition[comp2];
      
      // Create pairings between competitions
      const maxPairs = Math.min(users1.length, users2.length);
      for (let k = 0; k < maxPairs; k++) {
        pairings.push({
          id: `${comp1}-vs-${comp2}-${k}`,
          team1: {
            ...users1[k],
            teamName: comp1
          },
          team2: {
            ...users2[k],
            teamName: comp2
          },
          status: (users1[k].isActivelyCompeting && users2[k].isActivelyCompeting) ? 'active' : 'pending',
          round: 1
        });
      }
    }
  }
  
  return pairings;
}

function createBracketView(pairings) {
  // Remove loading screen
  const loadingPage = document.getElementById('loading-page');
  if (loadingPage) loadingPage.remove();
  
  const bracketPage = document.createElement('div');
  bracketPage.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
    overflow-y: auto;
    z-index: 2000;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 20px;
  `;
  
  bracketPage.innerHTML = `
    <div style="
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    ">
      <div style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
      ">
        <h1 style="
          font-size: 36px;
          font-weight: 800;
          background: linear-gradient(45deg, #00d4ff, #ff0080);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
          background-clip: text;
          margin: 0;
          text-transform: uppercase;
          letter-spacing: 2px;
        ">Tournament Bracket</h1>
        
        <button onclick="closeBracketView()" style="
          padding: 12px 24px;
          background: rgba(255, 255, 255, 0.1);
          border: 2px solid rgba(255, 255, 255, 0.3);
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
          backdrop-filter: blur(10px);
        ">‚Üê Back</button>
      </div>
      
      <div style="
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      ">
        ${pairings.length > 0 ? pairings.map(pairing => `
          <div style="
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            backdrop-filter: blur(10px);
            position: relative;
            ${pairing.status === 'active' ? 'border-color: #00d4ff; box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);' : ''}
          ">
            <div style="
              position: absolute;
              top: 12px;
              right: 12px;
              padding: 4px 12px;
              border-radius: 20px;
              font-size: 12px;
              font-weight: 600;
              ${pairing.status === 'active' 
                ? 'background: rgba(0, 212, 255, 0.2); color: #00d4ff; border: 1px solid #00d4ff;' 
                : 'background: rgba(255, 165, 0, 0.2); color: #ffa500; border: 1px solid #ffa500;'
              }
            ">${pairing.status === 'active' ? 'LIVE' : 'PENDING'}</div>
            
            <div style="
              text-align: center;
              margin-top: 20px;
            ">
              <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
              ">
                <div style="
                  flex: 1;
                  text-align: center;
                ">
                  <div style="
                    font-size: 18px;
                    font-weight: 700;
                    color: #00d4ff;
                    margin-bottom: 8px;
                    text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
                  ">${pairing.team1.teamName.toUpperCase()}</div>
                  <div style="
                    font-size: 14px;
                    color: #ffffff;
                    opacity: 0.8;
                  ">${pairing.team1.name}</div>
                </div>
                
                <div style="
                  font-size: 24px;
                  color: #ff0080;
                  margin: 0 20px;
                  font-weight: bold;
                ">VS</div>
                
                <div style="
                  flex: 1;
                  text-align: center;
                ">
                  <div style="
                    font-size: 18px;
                    font-weight: 700;
                    color: #ff0080;
                    margin-bottom: 8px;
                    text-shadow: 0 0 10px rgba(255, 0, 128, 0.5);
                  ">${pairing.team2.teamName.toUpperCase()}</div>
                  <div style="
                    font-size: 14px;
                    color: #ffffff;
                    opacity: 0.8;
                  ">${pairing.team2.name}</div>
                </div>
              </div>
              
              <div style="
                font-size: 12px;
                color: #888;
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
              ">
                Match ID: ${pairing.id}
              </div>
            </div>
          </div>
        `).join('') : `
          <div style="
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
          ">
            <div style="
              font-size: 48px;
              margin-bottom: 20px;
            ">üèÜ</div>
            <div style="
              font-size: 24px;
              color: #ffffff;
              margin-bottom: 12px;
            ">No matches found</div>
            <div style="
              font-size: 16px;
              color: #888;
            ">Teams need to be in different competitions to create matches</div>
          </div>
        `}
      </div>
    </div>
  `;
  
  bracketPage.id = 'bracket-page';
  document.body.appendChild(bracketPage);
}

function closeBracketView() {
  const bracketPage = document.getElementById('bracket-page');
  if (bracketPage) {
    bracketPage.remove();
  }
}

    async function loadIncompleteAssignments() {
  console.log('Loading incomplete assignments...');
  const user = firebase.auth().currentUser;
  const container = document.getElementById('incompleteAssignments');
  
  if (!user) {
    console.log('No user found, waiting for auth...');
    container.innerHTML = '<p class="empty-msg">Please wait, loading...</p>';
    return;
  }

  container.innerHTML = '<p class="empty-msg">Loading assignments...</p>';

  try {
    const snapshot = await firebase.firestore().collection('assignments')
      .where('to', '==', user.uid)
      .where('status', '!=', 'complete')
      .get();

    console.log('Query returned:', snapshot.size, 'documents');

    if (snapshot.empty) {
      container.innerHTML = '<p class="empty-msg">No incomplete assignments yet üéâ</p>';
      return;
    }

    container.innerHTML = ''; // Clear loading message

    snapshot.forEach(doc => {
      const data = doc.data();
      const card = document.createElement('div');
      card.className = 'assignment-card';

      card.innerHTML = `
        <div class="assignment-info">
          <h4>${data.title || 'Untitled Assignment'}</h4>
          <p>${data.description || 'No description provided'}</p>
          <p><strong>Type:</strong> ${data.type || 'N/A'}</p>
          <p><strong>Difficulty:</strong> ${data.difficulty || 'N/A'}</p>
          <p><strong>Time:</strong> ${data.time || 'N/A'}</p>
        </div>
        <button class="start-btn" onclick="startAssignment('${doc.id}', '${data.type}')">
          Start
        </button>
      `;
      container.appendChild(card);
    });

    // Recalculate accordion height after content is loaded
    const accordion = container.closest('.accordion-content');
    if (accordion && !accordion.classList.contains('hidden')) {
      accordion.style.maxHeight = accordion.scrollHeight + "px";
    }

  } catch (err) {
    console.error('Error loading assignments:', err);
    container.innerHTML = '<p class="empty-msg" style="color: #dc2626;">Failed to load assignments. Please try again.</p>';
  }
}

   function startAssignment(id, type) {
    // redirect or open modal as needed
    console.log(`Starting assignment ${id} of type ${type}`);
  }

  // Initialize when DOM is loaded

  document.addEventListener('DOMContentLoaded', () => {
  // Previous card button
  document.getElementById('prevCard')?.addEventListener('click', () => {
    if (currentDeck && currentCardIndex > 0) {
      currentCardIndex--;
      showCurrentFlashcard();
    }
  });
  
  // Next card button
  document.getElementById('nextCard')?.addEventListener('click', () => {
    if (currentDeck && currentCardIndex < currentDeck.cards.length - 1) {
      currentCardIndex++;
      showCurrentFlashcard();
    }
  });
});

// Rate difficulty (placeholder for future functionality)
function rateDifficulty(level) {
  console.log(`Rated current card as ${level}`);
  // Could save this rating to Firebase for spaced repetition
}

// Modified DOMContentLoaded to include flashcard loading
document.addEventListener('DOMContentLoaded', () => {
  feather.replace();
  
  // Handle authentication state changes
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      console.log('User authenticated:', user.uid);
      loadIncompleteAssignments();
      loadRecentlyStudiedDecks(); // Add this line
    } else {
      console.log('No user, signing in anonymously...');
      firebase.auth().signInAnonymously().catch(err => {
        console.error('Anonymous sign-in failed:', err);
      });
    }
  });
});


// Function to show competition type selection after clicking "Compete Now"
function showCompetitionTypeSelection() {
  const competePage = document.getElementById('compete-page');
  
  // Create overlay on top of competition page
  const selectionOverlay = document.createElement('div');
  selectionOverlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    backdrop-filter: blur(10px);
  `;

  selectionOverlay.innerHTML = `
    <div style="
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 90%;
      position: relative;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    ">
      <button style="
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 24px;
        color: #9CA3AF;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
      " onclick="this.closest('[style*=\"backdrop-filter\"]').remove()">√ó</button>
      
      <h2 style="
        font-size: 28px;
        font-weight: 700;
        background: linear-gradient(45deg, #00d4ff, #ff0080);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin: 0 0 20px 0;
        text-align: center;
      ">Choose Competition Type</h2>
      
      <p style="
        font-size: 16px;
        color: #9CA3AF;
        margin: 0 0 32px 0;
        line-height: 1.5;
        text-align: center;
      ">Select the type of challenge you want to compete in!</p>
      
      <div style="
        display: flex;
        flex-direction: column;
        gap: 16px;
        margin-bottom: 32px;
      ">
        <label style="
          display: flex;
          align-items: center;
          padding: 20px;
          border: 2px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: blur(10px);
        " onmouseover="this.style.borderColor='#00d4ff'; this.style.backgroundColor='rgba(0, 212, 255, 0.1)';" 
           onmouseout="updateCompTypeBorderColor(this);" 
           onclick="selectCompType(this, 'written')">
          <input type="radio" name="compType" value="written" style="
            margin-right: 16px;
            width: 18px;
            height: 18px;
            accent-color: #00d4ff;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 6px;
            ">
              <span style="font-size: 24px; margin-right: 12px;">üìù</span>
              <span style="font-weight: 700; color: #ffffff; font-size: 18px;">Written Competition</span>
            </div>
            <div style="
              font-size: 14px;
              color: #9CA3AF;
              line-height: 1.4;
            ">Kahoot-style quiz with multiple choice questions and live leaderboard</div>
          </div>
        </label>
        
        <label style="
          display: flex;
          align-items: center;
          padding: 20px;
          border: 2px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: blur(10px);
        " onmouseover="this.style.borderColor='#00d4ff'; this.style.backgroundColor='rgba(0, 212, 255, 0.1)';" 
           onmouseout="updateCompTypeBorderColor(this);" 
           onclick="selectCompType(this, 'speaking')">
          <input type="radio" name="compType" value="speaking" style="
            margin-right: 16px;
            width: 18px;
            height: 18px;
            accent-color: #00d4ff;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 6px;
            ">
              <span style="font-size: 24px; margin-right: 12px;">üé§</span>
              <span style="font-weight: 700; color: #ffffff; font-size: 18px;">Speaking Competition</span>
            </div>
            <div style="
              font-size: 14px;
              color: #9CA3AF;
              line-height: 1.4;
            ">Record a presentation with camera and get scored on delivery</div>
          </div>
        </label>
        
        <label style="
          display: flex;
          align-items: center;
          padding: 20px;
          border: 2px solid rgba(255, 255, 255, 0.1);
          border-radius: 16px;
          cursor: pointer;
          transition: all 0.3s ease;
          background: rgba(255, 255, 255, 0.05);
          backdrop-filter: blur(10px);
        " onmouseover="this.style.borderColor='#00d4ff'; this.style.backgroundColor='rgba(0, 212, 255, 0.1)';" 
           onmouseout="updateCompTypeBorderColor(this);" 
           onclick="selectCompType(this, 'case')">
          <input type="radio" name="compType" value="case" style="
            margin-right: 16px;
            width: 18px;
            height: 18px;
            accent-color: #00d4ff;
          " />
          <div>
            <div style="
              display: flex;
              align-items: center;
              margin-bottom: 6px;
            ">
              <span style="font-size: 24px; margin-right: 12px;">üíº</span>
              <span style="font-weight: 700; color: #ffffff; font-size: 18px;">Case Study Competition</span>
            </div>
            <div style="
              font-size: 14px;
              color: #9CA3AF;
              line-height: 1.4;
            ">Analyze business scenarios and present strategic solutions</div>
          </div>
        </label>
      </div>
      
      <div style="
        display: flex;
        gap: 16px;
        justify-content: flex-end;
      ">
        <button style="
          padding: 12px 24px;
          border: 1px solid rgba(255, 255, 255, 0.2);
          background: rgba(255, 255, 255, 0.1);
          color: #ffffff;
          border-radius: 12px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          backdrop-filter: blur(10px);
        " onclick="this.closest('[style*=\"backdrop-filter\"]').remove()">Cancel</button>
        
        <button id="startCompBtn" style="
          padding: 12px 24px;
          background: #6B7280;
          color: white;
          border: none;
          border-radius: 12px;
          cursor: not-allowed;
          font-size: 14px;
          font-weight: 600;
          opacity: 0.6;
        " disabled onclick="startSelectedCompetition()">Start Competition</button>
      </div>
    </div>
  `;

  document.body.appendChild(selectionOverlay);
}

function updateCompTypeBorderColor(element) {
  const radio = element.querySelector('input[type="radio"]');
  if (radio && radio.checked) {
    element.style.borderColor = '#00d4ff';
    element.style.backgroundColor = 'rgba(0, 212, 255, 0.15)';
  } else {
    element.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    element.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
  }
}

function selectCompType(labelElement, type) {
  // Update all labels to default state
  const allLabels = document.querySelectorAll('label[onclick*="selectCompType"]');
  allLabels.forEach(label => {
    label.style.borderColor = 'rgba(255, 255, 255, 0.1)';
    label.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
  });
  
  // Highlight selected label
  labelElement.style.borderColor = '#00d4ff';
  labelElement.style.backgroundColor = 'rgba(0, 212, 255, 0.15)';
  
  // Enable the start button
  const startBtn = document.getElementById('startCompBtn');
  startBtn.style.background = 'linear-gradient(45deg, #00d4ff, #ff0080)';
  startBtn.style.cursor = 'pointer';
  startBtn.style.opacity = '1';
  startBtn.disabled = false;
  
  // Store selected type
  window.selectedCompType = type;
}

function startSelectedCompetition() {
  const selectedType = window.selectedCompType;
  
  if (!selectedType) {
    alert('Please select a competition type');
    return;
  }
  
  // Remove selection overlay
  document.querySelector('[style*="backdrop-filter"]').remove();
  
  // Close the competition page
  closeCompetePage();
  
  // Start the selected competition
  startCompetitionWithType(selectedType);
}
function startCompetitionWithType(type) {
  // Close the competition page
  closeCompetePage();
  
  switch(type) {
    case 'written':
      startWrittenCompetition();
      break;
    case 'speaking':
      startSpeakingCompetition();
      break;
    case 'case':
      startCaseCompetition();
      break;
    default:
      console.error('Unknown competition type:', type);
  }
}

// Written Competition - Quiz/Kahoot style
async function startWrittenCompetition() {
  const modal = createFullPageModal();
  
  // Sample questions - in real app, fetch from Firebase
  const questions = [
    {
      question: "What is the primary purpose of a business plan?",
      options: [
        "To secure funding",
        "To guide business operations", 
        "To attract customers",
        "To comply with regulations"
      ],
      correct: 1,
      competency: "Entrepreneurship"
    },
    {
      question: "Which financial statement shows a company's profitability?",
      options: [
        "Balance Sheet",
        "Cash Flow Statement",
        "Income Statement", 
        "Statement of Equity"
      ],
      correct: 2,
      competency: "Accounting"
    },
    {
      question: "What does ROI stand for in business?",
      options: [
        "Rate of Interest",
        "Return on Investment",
        "Risk of Investment", 
        "Revenue over Income"
      ],
      correct: 1,
      competency: "Finance"
    }
  ];
  
  let currentQuestionIndex = 0;
  let score = 0;
  let timeLeft = 30;
  let timer;
  let answers = [];
  
  function showQuestion() {
    const question = questions[currentQuestionIndex];
    
    modal.innerHTML = `
      <div style="
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      ">
        <!-- Header -->
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px 40px;
          background: rgba(0,0,0,0.1);
        ">
          <div style="font-size: 24px; font-weight: bold;">
            Question ${currentQuestionIndex + 1}/${questions.length}
          </div>
          <div id="timer" style="
            font-size: 32px;
            font-weight: bold;
            padding: 10px 20px;
            background: ${timeLeft <= 10 ? '#ff4757' : '#2ed573'};
            border-radius: 50%;
            min-width: 80px;
            text-align: center;
          ">${timeLeft}</div>
          <button onclick="exitCompetition()" style="
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
          ">Exit</button>
        </div>
        
        <!-- Progress Bar -->
        <div style="
          height: 4px;
          background: rgba(255,255,255,0.2);
          margin: 0 40px 20px 40px;
        ">
          <div style="
            height: 100%;
            background: #2ed573;
            width: ${((currentQuestionIndex) / questions.length) * 100}%;
            transition: width 0.3s ease;
          "></div>
        </div>
        
        <!-- Question -->
        <div style="
          flex: 1;
          display: flex;
          flex-direction: column;
          justify-content: center;
          padding: 0 40px;
          max-width: 800px;
          margin: 0 auto;
          width: 100%;
        ">
          <div style="
            font-size: 32px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 60px;
            line-height: 1.2;
          ">${question.question}</div>
          
          <div style="
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
          ">
            ${question.options.map((option, index) => `
              <button onclick="selectAnswer(${index})" style="
                padding: 20px;
                font-size: 18px;
                background: rgba(255,255,255,0.1);
                border: 2px solid rgba(255,255,255,0.2);
                color: white;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                text-align: left;
              " onmouseover="this.style.background='rgba(255,255,255,0.2)'"
                 onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                <div style="font-weight: bold; margin-bottom: 5px;">
                  ${String.fromCharCode(65 + index)}
                </div>
                ${option}
              </button>
            `).join('')}
          </div>
        </div>
        
        <!-- Score -->
        <div style="
          text-align: center;
          padding: 20px;
          font-size: 18px;
        ">
          Score: ${score}/${questions.length}
        </div>
      </div>
    `;
    
    // Start timer
    startTimer();
  }
  
  function startTimer() {
    timer = setInterval(() => {
      timeLeft--;
      const timerEl = document.getElementById('timer');
      if (timerEl) {
        timerEl.textContent = timeLeft;
        timerEl.style.background = timeLeft <= 10 ? '#ff4757' : '#2ed573';
      }
      
      if (timeLeft <= 0) {
        clearInterval(timer);
        selectAnswer(-1); // Time up, no answer
      }
    }, 1000);
  }
  
  window.selectAnswer = function(selectedIndex) {
    clearInterval(timer);
    const question = questions[currentQuestionIndex];
    const isCorrect = selectedIndex === question.correct;
    
    if (isCorrect) score++;
    
    answers.push({
      question: question.question,
      selected: selectedIndex >= 0 ? question.options[selectedIndex] : 'Time Up',
      correct: question.options[question.correct],
      isCorrect: isCorrect,
      timeRemaining: timeLeft
    });
    
    // Show answer feedback
    showAnswerFeedback(isCorrect, question.options[question.correct]);
    
    setTimeout(() => {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        timeLeft = 30;
        showQuestion();
      } else {
        showResults();
      }
    }, 2000);
  };
  
  function showAnswerFeedback(isCorrect, correctAnswer) {
    const feedbackOverlay = document.createElement('div');
    feedbackOverlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    `;
    
    feedbackOverlay.innerHTML = `
      <div style="
        text-align: center;
        color: white;
        font-size: 32px;
        font-weight: bold;
      ">
        <div style="
          font-size: 64px;
          margin-bottom: 20px;
        ">${isCorrect ? '‚úÖ' : '‚ùå'}</div>
        <div style="margin-bottom: 10px;">
          ${isCorrect ? 'Correct!' : 'Incorrect'}
        </div>
        <div style="font-size: 18px; opacity: 0.8;">
          Answer: ${correctAnswer}
        </div>
      </div>
    `;
    
    document.body.appendChild(feedbackOverlay);
    
    setTimeout(() => {
      feedbackOverlay.remove();
    }, 2000);
  }
  
  async function showResults() {
    // Save results to Firebase (placeholder)
    const resultData = {
      userId: firebase.auth().currentUser?.uid,
      score: score,
      totalQuestions: questions.length,
      answers: answers,
      timestamp: new Date()
    };
    
    // In real app, save to Firebase here
    console.log('Competition results:', resultData);
    
    modal.innerHTML = `
      <div style="
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        text-align: center;
        padding: 40px;
      ">
        <h1 style="
          font-size: 48px;
          margin-bottom: 20px;
          font-weight: bold;
        ">üèÜ Competition Complete!</h1>
        
        <div style="
          font-size: 72px;
          font-weight: bold;
          margin: 40px 0;
        ">${score}/${questions.length}</div>
        
        <div style="
          font-size: 24px;
          margin-bottom: 40px;
          opacity: 0.9;
        ">
          ${score === questions.length ? 'Perfect Score!' : 
            score >= questions.length * 0.8 ? 'Excellent!' :
            score >= questions.length * 0.6 ? 'Good Job!' :
            'Keep Practicing!'}
        </div>
        
        <!-- Leaderboard -->
        <div style="
          background: rgba(255,255,255,0.1);
          border-radius: 16px;
          padding: 30px;
          margin: 20px auto;
          max-width: 600px;
          width: 100%;
        ">
          <h3 style="margin-bottom: 20px; font-size: 24px;">üèÖ Leaderboard</h3>
          <div style="text-align: left;">
            <div style="
              display: flex;
              justify-content: space-between;
              padding: 15px;
              background: rgba(255,215,0,0.2);
              border-radius: 8px;
              margin-bottom: 10px;
              border-left: 4px solid gold;
            ">
              <span>ü•á You</span>
              <span>${score}/${questions.length}</span>
            </div>
            <div style="
              display: flex;
              justify-content: space-between;
              padding: 15px;
              background: rgba(255,255,255,0.1);
              border-radius: 8px;
              margin-bottom: 10px;
            ">
              <span>ü•à Team Alpha</span>
              <span>${Math.max(0, score - 1)}/${questions.length}</span>
            </div>
            <div style="
              display: flex;
              justify-content: space-between;
              padding: 15px;
              background: rgba(255,255,255,0.1);
              border-radius: 8px;
            ">
              <span>ü•â Team Beta</span>
              <span>${Math.max(0, score - 2)}/${questions.length}</span>
            </div>
          </div>
        </div>
        
        <div style="
          display: flex;
          gap: 20px;
          justify-content: center;
          margin-top: 40px;
        ">
          <button onclick="closeModal()" style="
            padding: 15px 30px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">Back to Home</button>
          <button onclick="startWrittenCompetition()" style="
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            border: none;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
          ">Play Again</button>
        </div>
      </div>
    `;
  }
  
  // Start the quiz
  showQuestion();
}

// Speaking Competition
function startSpeakingCompetition() {
  const modal = createFullPageModal();
  
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow:auto;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    ">
      <!-- Header -->
      <div style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
        background: rgba(0,0,0,0.1);
      ">
        <h1 style="font-size: 28px; margin: 0;">üé§ Speaking Competition</h1>
        <button onclick="closeModal()" style="
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        ">Exit</button>
      </div>
      
      <!-- Main Content -->
      <div style="
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 40px;
        text-align: center;
      ">
        <div id="challenge-prompt" style="
          background: rgba(255,255,255,0.1);
          border-radius: 16px;
          padding: 40px;
          margin-bottom: 40px;
          max-width: 700px;
        ">
          <h2 style="
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: bold;
          ">Your Challenge</h2>
          <p style="
            font-size: 20px;
            line-height: 1.5;
            margin-bottom: 20px;
          ">
            "Present a 3-minute elevator pitch for a new mobile app that helps students manage their finances. 
            Include the problem, solution, target market, and monetization strategy."
          </p>
          <div style="
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            font-size: 16px;
          ">
            <div>‚è±Ô∏è Time Limit: 3 minutes</div>
            <div>üéØ Points: 100</div>
            <div>üìä Judged on: Content, Delivery, Clarity</div>
          </div>
        </div>
        
        <!-- Camera Section -->
        <div id="camera-section" style="
          background: rgba(0,0,0,0.3);
          border-radius: 16px;
          padding: 30px;
          margin-bottom: 30px;
          width: 100%;
          max-width: 600px;
        ">
          <video id="video" autoplay muted style="
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 12px;
            object-fit: cover;
          "></video>
          
          <div style="
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
          ">
            <button id="start-recording" onclick="startRecording()" style="
              padding: 15px 30px;
              background: #ff4757;
              border: none;
              color: white;
              border-radius: 12px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              display: flex;
              align-items: center;
              gap: 10px;
            ">
              üî¥ Start Recording
            </button>
            
            <button id="stop-recording" onclick="stopRecording()" style="
              padding: 15px 30px;
              background: #2ed573;
              border: none;
              color: white;
              border-radius: 12px;
              cursor: pointer;
              font-size: 16px;
              font-weight: 600;
              display: none;
              align-items: center;
              gap: 10px;
            ">
              ‚èπÔ∏è Stop & Submit
            </button>
          </div>
          
          <div id="timer-display" style="
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
            display: none;
          ">Time: <span id="recording-timer">00:00</span></div>
        </div>
      </div>
    </div>
  `;
  
  // Initialize camera
  initializeCamera();
}

async function initializeCaseCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: true, 
      audio: true 
    });
    const video = document.getElementById('case-video');
    if (video) {
      video.srcObject = stream;
      // Store the stream globally so we can access it later
      window.caseStream = stream;
    }
  } catch (err) {
    console.error('Error accessing camera:', err);
    alert('Unable to access camera. Please check permissions.');
  }
}


// Case Competition
function startCaseCompetition() {
  const modal = createFullPageModal();
  
  modal.innerHTML = `
    <div style="
      display: flex;
      height: 100vh;
      flex-direction: column;
      overflow: auto;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    ">
      <!-- Header -->
      <div style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 40px;
        background: rgba(0,0,0,0.1);
      ">
        <h1 style="font-size: 28px; margin: 0;">üíº Case Study Competition</h1>
        <button onclick="closeModal()" style="
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          padding: 10px 20px;
          border-radius: 8px;
          cursor: pointer;
        ">Exit</button>
      </div>
      
      <!-- Main Content -->
      <div style="
        flex: 1;
        display: flex;
        padding: 20px;
        gap: 20px;
      ">
        <!-- Case Study Document -->
        <div style="
          flex: 2;
          background: rgba(255,255,255,0.1);
          border-radius: 16px;
          padding: 30px;
          overflow-y: auto;
        ">
          <h2 style="margin-bottom: 20px; font-size: 24px;">üìÑ Case Study: TechStart Inc.</h2>
          
          <div style="
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            line-height: 1.6;
          ">
            <h3 style="color: #ffd700; margin-bottom: 15px;">Background</h3>
            <p>TechStart Inc. is a 3-year-old software company that developed a project management tool for small businesses. Initially successful with 10,000 users and $2M ARR, they're now facing increased competition from larger tech companies.</p>
          </div>
          
          <div style="
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            line-height: 1.6;
          ">
            <h3 style="color: #ffd700; margin-bottom: 15px;">Current Challenges</h3>
            <ul style="margin: 0; padding-left: 20px;">
              <li>Customer acquisition cost has increased by 200%</li>
              <li>Monthly churn rate is 8% (industry average: 5%)</li>
              <li>Limited development resources (5 engineers)</li>
              <li>New competitor launched with 50% lower pricing</li>
            </ul>
          </div>
          
          <div style="
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 25px;
            line-height: 1.6;
          ">
            <h3 style="color: #ffd700; margin-bottom: 15px;">Financial Data</h3>
            <p><strong>Monthly Revenue:</strong> $167K<br>
            <strong>Operating Costs:</strong> $140K/month<br>
            <strong>Cash on Hand:</strong> $800K<br>
            <strong>Runway:</strong> 10 months at current burn rate</p>
          </div>
        </div>
        
        <!-- Response Section -->
        <div style="
          flex: 1;
          background: rgba(255,255,255,0.1);
          border-radius: 16px;
          padding: 30px;
          display: flex;
          flex-direction: column;
        ">
          <h3 style="margin-bottom: 20px; font-size: 20px;">Your Strategic Response</h3>
          
          <div style="
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
          ">
            <h4 style="margin-bottom: 15px; color: #ffd700;">Question 1</h4>
            <p style="margin-bottom: 15px; font-size: 14px;">
              What are the top 3 strategic priorities TechStart should focus on immediately?
            </p>
            <textarea placeholder="Enter your response..." style="
              width: 100%;
              height: 100px;
              background: rgba(255,255,255,0.1);
              border: 1px solid rgba(255,255,255,0.3);
              border-radius: 8px;
              padding: 15px;
              color: white;
              font-size: 14px;
              resize: vertical;
            "></textarea>
          </div>
          
          <div style="
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
          ">
            <h4 style="margin-bottom: 15px; color: #ffd700;">Question 2</h4>
            <p style="margin-bottom: 15px; font-size: 14px;">
              Develop a 6-month action plan to reduce churn and improve unit economics.
            </p>
            <textarea placeholder="Enter your response..." style="
              width: 100%;
              height: 120px;
              background: rgba(255,255,255,0.1);
              border: 1px solid rgba(255,255,255,0.3);
              border-radius: 8px;
              padding: 15px;
              color: white;
              font-size: 14px;
              resize: vertical;
            "></textarea>
          </div>
          
          <!-- Camera Section for Presentation -->
          <div style="
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
          ">
            <h4 style="margin-bottom: 15px; text-align: center;">üìπ Present Your Solution</h4>
            <video id="case-video" autoplay muted style="
              width: 100%;
              height: 150px;
              background: #000;
              border-radius: 8px;
              object-fit: cover;
              margin-bottom: 15px;
            "></video>
            
            <div style="
              display: flex;
              justify-content: center;
              gap: 10px;
              margin-bottom: 15px;
            ">
              <button id="start-recording" onclick="startRecording()" style="
                padding: 10px 20px;
                background: #ff4757;
                border: none;
                color: white;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
              ">
                üî¥ Start Recording
              </button>
              
              <button id="stop-recording" onclick="stopRecording()" style="
                padding: 10px 20px;
                background: #2ed573;
                border: none;
                color: white;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 600;
                display: none;
                align-items: center;
                gap: 8px;
              ">
                ‚èπÔ∏è Stop & Submit
              </button>
            </div>
            
            <div id="timer-display" style="
              text-align: center;
              font-size: 16px;
              font-weight: bold;
              display: none;
            ">Recording: <span id="recording-timer">00:00</span></div>
            
            <div style="
              text-align: center;
              margin-top: 15px;
              font-size: 12px;
              opacity: 0.7;
            ">‚è±Ô∏è Time Remaining: 45:00</div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Initialize camera for case study
  initializeCaseCamera();
}
// Helper function to create full page modal
function createFullPageModal() {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 2000;
  `;
  modal.id = 'competition-modal';
  document.body.appendChild(modal);
  return modal;
}

// Camera functions
async function initializeCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: true, 
      audio: true 
    });
    const video = document.getElementById('video');
    if (video) {
      video.srcObject = stream;
    }
  } catch (err) {
    console.error('Error accessing camera:', err);
    alert('Unable to access camera. Please check permissions.');
  }
}



let mediaRecorder;
let recordedChunks = [];
let recordingTimer;
let recordingTime = 0;
let caseStream = null;

function startRecording() {
  // Check which video element exists
  const video = document.getElementById('video') || document.getElementById('case-video');
  const startBtn = document.getElementById('start-recording');
  const stopBtn = document.getElementById('stop-recording');
  const timerDisplay = document.getElementById('timer-display');
  const recordingTimerEl = document.getElementById('recording-timer');
  
  if (!video || !video.srcObject) {
    alert('Camera not initialized. Please refresh and try again.');
    return;
  }
  
  const stream = video.srcObject;
  
  recordedChunks = [];
  mediaRecorder = new MediaRecorder(stream);
  
  mediaRecorder.ondataavailable = function(event) {
    if (event.data.size > 0) {
      recordedChunks.push(event.data);
    }
  };
  
  mediaRecorder.onstop = function() {
    const blob = new Blob(recordedChunks, { type: 'video/webm' });
    // Here you would upload to Firebase or process the recording
    console.log('Recording completed:', blob);
    
    // Show different completion screens based on competition type
    if (document.getElementById('case-video')) {
      showCaseRecordingComplete();
    } else {
      showRecordingComplete();
    }
  };
  
  mediaRecorder.start();
  
  // Update UI
  if (startBtn) startBtn.style.display = 'none';
  if (stopBtn) stopBtn.style.display = 'flex';
  if (timerDisplay) timerDisplay.style.display = 'block';
  
  // Start timer
  recordingTime = 0;
  recordingTimer = setInterval(() => {
    recordingTime++;
    const minutes = Math.floor(recordingTime / 60);
    const seconds = recordingTime % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (recordingTimerEl) {
      recordingTimerEl.textContent = timeString;
    }
    
    // Auto-stop at 3 minutes for speaking, 10 minutes for case study
    const maxTime = document.getElementById('case-video') ? 600 : 180;
    if (recordingTime >= maxTime) {
      stopRecording();
    }
  }, 1000);
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
  if (recordingTimer) {
    clearInterval(recordingTimer);
  }
  
  // Reset UI
  const startBtn = document.getElementById('start-recording');
  const stopBtn = document.getElementById('stop-recording');
  
  if (startBtn) startBtn.style.display = 'flex';
  if (stopBtn) stopBtn.style.display = 'none';
}

// New function specifically for case study recording completion
function showCaseRecordingComplete() {
  // Collect all text responses
  const responses = document.querySelectorAll('textarea');
  const answers = Array.from(responses).map(textarea => textarea.value);
  
  console.log('Case study responses:', answers);
  
  const modal = document.getElementById('competition-modal');
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center;
      padding: 40px;
      justify-content: center;
      align-items: center;
    ">
      <h1 style="font-size: 48px; margin-bottom: 20px;">üíº Case Study Complete!</h1>
      <p style="font-size: 24px; margin-bottom: 40px;">
        Your strategic analysis and presentation have been successfully submitted.
      </p>
      
      <!-- Mock Scoring for Case Study -->
      <div style="
        background: rgba(255,255,255,0.1);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        max-width: 500px;
        width: 100%;
      ">
        <h3 style="margin-bottom: 20px; font-size: 24px;">üìä Preliminary Assessment</h3>
        <div style="text-align: left; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Strategic Analysis</span>
            <span style="color: #2ed573; font-weight: bold;">88/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Financial Understanding</span>
            <span style="color: #2ed573; font-weight: bold;">82/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Presentation Quality</span>
            <span style="color: #ffa500; font-weight: bold;">91/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Implementation Plan</span>
            <span style="color: #2ed573; font-weight: bold;">85/100</span>
          </div>
          <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">
          <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
            <span>Overall Score</span>
            <span style="color: #ffd700;">346/400</span>
          </div>
        </div>
      </div>
      
      <p style="font-size: 16px; margin-bottom: 40px; opacity: 0.9;">
        Detailed feedback from industry experts will be available within 48 hours.
      </p>
      
      <div style="display: flex; gap: 20px;">
        <button onclick="closeModal()" style="
          padding: 15px 30px;
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Back to Home</button>
        <button onclick="startCaseCompetition()" style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #ff6b6b, #ee5a52);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Try Another Case</button>
      </div>
    </div>
  `;
}

function startCaseRecording() {
  // Similar to startRecording but for case study
  console.log('Starting case study recording...');
}

function submitCaseStudy() {
  // Collect all responses and submit
  const responses = document.querySelectorAll('textarea');
  const answers = Array.from(responses).map(textarea => textarea.value);
  
  console.log('Case study responses:', answers);
  
  // Show completion screen
  const modal = document.getElementById('competition-modal');
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center;
      padding: 40px;
      justify-content: center;
      align-items: center;
    ">
      <h1 style="font-size: 48px; margin-bottom: 20px;">‚úÖ Case Study Submitted!</h1>
      <p style="font-size: 24px; margin-bottom: 40px;">
        Your strategic analysis has been submitted for review.
      </p>
      <p style="font-size: 18px; margin-bottom: 40px; opacity: 0.9;">
        You'll receive feedback and scores within 24 hours.
      </p>
      <button onclick="closeModal()" style="
        padding: 15px 30px;
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
      ">Back to Home</button>
    </div>
  `;
}

function showRecordingComplete() {
  const modal = document.getElementById('competition-modal');
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center;
      padding: 40px;
      justify-content: center;
      align-items: center;
    ">
      <h1 style="font-size: 48px; margin-bottom: 20px;">üé§ Presentation Recorded!</h1>
      <p style="font-size: 24px; margin-bottom: 40px;">
        Your speaking presentation has been successfully recorded and submitted.
      </p>
      
      <!-- Mock Scoring -->
      <div style="
        background: rgba(255,255,255,0.1);
        border-radius: 16px;
        padding: 30px;
        margin: 20px 0;
        max-width: 500px;
        width: 100%;
      ">
        <h3 style="margin-bottom: 20px; font-size: 24px;">üìä Preliminary Scores</h3>
        <div style="text-align: left; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Content Quality</span>
            <span style="color: #2ed573; font-weight: bold;">85/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Delivery & Clarity</span>
            <span style="color: #2ed573; font-weight: bold;">92/100</span>
          </div>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Time Management</span>
            <span style="color: #ffa500; font-weight: bold;">78/100</span>
          </div>
          <hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">
          <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
            <span>Total Score</span>
            <span style="color: #ffd700;">255/300</span>
          </div>
        </div>
      </div>
      
      <p style="font-size: 16px; margin-bottom: 40px; opacity: 0.9;">
        Final judges' scores will be available after all participants have completed their presentations.
      </p>
      
      <div style="display: flex; gap: 20px;">
        <button onclick="closeModal()" style="
          padding: 15px 30px;
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Back to Home</button>
        <button onclick="startSpeakingCompetition()" style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #ff6b6b, #ee5a52);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Try Again</button>
      </div>
    </div>
  `;
}

// Global exit function
window.exitCompetition = function() {
  if (confirm('Are you sure you want to exit the competition? Your progress will be lost.')) {
    closeModal();
  }
};

// Global close modal function
window.closeModal = function() {
  const modal = document.getElementById('competition-modal');
  if (modal) {
    // Stop any ongoing timers
    if (timer) clearInterval(timer);
    if (recordingTimer) clearInterval(recordingTimer);
    
    // Stop camera streams
    const videos = modal.querySelectorAll('video');
    videos.forEach(video => {
      if (video.srcObject) {
        video.srcObject.getTracks().forEach(track => track.stop());
      }
    });
    
    modal.remove();
  }
};

// Additional helper functions for Firebase integration

async function saveCompetitionResult(type, data) {
  try {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    const result = {
      userId: user.uid,
      competitionType: type,
      timestamp: new Date(),
      ...data
    };
    
    await db.collection('competitionResults').add(result);
    console.log('Competition result saved:', result);
  } catch (error) {
    console.error('Error saving competition result:', error);
  }
}

async function getLeaderboard(competitionType) {
  try {
    const snapshot = await db.collection('competitionResults')
      .where('competitionType', '==', competitionType)
      .orderBy('score', 'desc')
      .limit(10)
      .get();
    
    const leaderboard = [];
    snapshot.forEach(doc => {
      leaderboard.push(doc.data());
    });
    
    return leaderboard;
  } catch (error) {
    console.error('Error getting leaderboard:', error);
    return [];
  }
}

// Enhanced written competition with real Firebase leaderboard
async function showWrittenResults() {
  // Save results to Firebase
  const resultData = {
    score: score,
    totalQuestions: questions.length,
    answers: answers,
    timestamp: new Date()
  };
  
  await saveCompetitionResult('written', resultData);
  
  // Get real leaderboard
  const leaderboard = await getLeaderboard('written');
  
  modal.innerHTML = `
    <div style="
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      text-align: center;
      padding: 40px;
    ">
      <h1 style="
        font-size: 48px;
        margin-bottom: 20px;
        font-weight: bold;
      ">üèÜ Competition Complete!</h1>
      
      <div style="
        font-size: 72px;
        font-weight: bold;
        margin: 40px 0;
      ">${score}/${questions.length}</div>
      
      <div style="
        font-size: 24px;
        margin-bottom: 40px;
        opacity: 0.9;
      ">
        ${score === questions.length ? 'Perfect Score!' : 
          score >= questions.length * 0.8 ? 'Excellent!' :
          score >= questions.length * 0.6 ? 'Good Job!' :
          'Keep Practicing!'}
      </div>
      
      <!-- Real Firebase Leaderboard -->
      <div style="
        background: rgba(255,255,255,0.1);
        border-radius: 16px;
        padding: 30px;
        margin: 20px auto;
        max-width: 600px;
        width: 100%;
      ">
        <h3 style="margin-bottom: 20px; font-size: 24px;">üèÖ Live Leaderboard</h3>
        <div style="text-align: left;">
          ${leaderboard.map((entry, index) => `
            <div style="
              display: flex;
              justify-content: space-between;
              padding: 15px;
              background: ${index === 0 ? 'rgba(255,215,0,0.2)' : 'rgba(255,255,255,0.1)'};
              border-radius: 8px;
              margin-bottom: 10px;
              ${index === 0 ? 'border-left: 4px solid gold;' : ''}
            ">
              <span>${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üèÖ'} ${entry.userId === firebase.auth().currentUser?.uid ? 'You' : `Player ${index + 1}`}</span>
              <span>${entry.score}/${entry.totalQuestions}</span>
            </div>
          `).join('')}
        </div>
      </div>
      
      <div style="
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 40px;
      ">
        <button onclick="closeModal()" style="
          padding: 15px 30px;
          background: rgba(255,255,255,0.2);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Back to Home</button>
        <button onclick="startWrittenCompetition()" style="
          padding: 15px 30px;
          background: linear-gradient(45deg, #ff6b6b, #ee5a52);
          border: none;
          color: white;
          border-radius: 12px;
          cursor: pointer;
          font-size: 16px;
          font-weight: 600;
        ">Play Again</button>
      </div>
    </div>
  `;
}

window.backToHome = function() {
  closeModal();
  // If you're in a subdirectory, adjust the path accordingly
  // For example, if you're in /public/home.html, use '../index.html' or the correct path
  window.location.href = 'home.html'; // Adjust this path as needed
};
  </script>
  
</body>
</html>

