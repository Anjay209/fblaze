<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BLAZE Forum</title>
  <link rel="stylesheet" href="forum.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
  authDomain: "certquest-94959.firebaseapp.com",
  projectId: "certquest-94959",
  storageBucket: "certquest-94959.firebasestorage.app",
  messagingSenderId: "323956529033",
  appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
  measurementId: "G-F5JHTGGN6K"
};
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
</script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  <style>
    /* Hide mentor comment modal */
    #mentorCommentModal {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
      position: absolute !important;
      left: -9999px !important;
      top: -9999px !important;
      width: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }

    /* Speaking Assignment Modal Styles - Matching React Design */
    .cq-speaking-modal {
      position: fixed;
      z-index: 3100;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: #020617; /* slate-950 */
      color: white;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Star Field Background */
    .cq-speaking-stars {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .cq-speaking-star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle linear infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.9; }
    }
    .cq-speaking-glow-1 {
      position: absolute;
      top: 5rem;
      left: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    .cq-speaking-glow-2 {
      position: absolute;
      bottom: 0;
      right: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    
    .cq-speaking-modal-content {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
    }
    
    .cq-speaking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30, 41, 59, 0.3); /* slate-800/30 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }
    .cq-speaking-title {
      font-size: 1.875rem; /* text-3xl */
      font-weight: 700;
      color: #f97316; /* orange-500 */
      margin: 0;
    }
    .cq-speaking-close {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: #f97316; /* orange-500 */
      color: white;
      border: none;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
    }
    .cq-speaking-close:hover {
      background: #ea580c; /* orange-600 */
    }
    
    .cq-speaking-main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 0;
    }
    
    .cq-speaking-questions {
      display: flex;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-speaking-question-card {
      flex: 1;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700 */
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .cq-speaking-question-label {
      font-size: 0.75rem; /* text-xs */
      font-weight: 600;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.25rem;
    }
    .cq-speaking-question-text {
      font-size: 0.875rem; /* text-sm */
      color: white;
      line-height: 1.5;
    }
    
    .cq-speaking-video-container {
      flex: 1;
      position: relative;
      border-radius: 1rem; /* rounded-2xl */
      overflow: hidden;
      border: 2px solid rgba(249, 115, 22, 0.3); /* border-orange-500/30 */
      background: #000;
      min-height: 0;
    }
    .cq-speaking-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cq-speaking-no-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1rem;
    }
    
    /* Recording Indicator */
    .cq-speaking-recording-indicator {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      backdrop-filter: blur(8px);
      font-size: 0.75rem;
    }
    .cq-speaking-recording-indicator.active {
      display: flex;
    }
    .cq-speaking-recording-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .cq-speaking-recording-text {
      font-weight: 600;
      color: #fca5a5; /* red-400 */
    }
    
    .cq-speaking-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-speaking-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }
    .cq-speaking-control-btn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: rgba(30, 41, 59, 0.4); /* slate-800/40 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #94a3b8; /* slate-400 */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1.25rem;
    }
    .cq-speaking-control-btn:hover {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #cbd5e1; /* slate-300 */
    }
    .cq-speaking-record-btn {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background: linear-gradient(to right, #f97316, #ef4444); /* orange-500 to red-500 */
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
      font-size: 2rem;
      font-weight: 600;
    }
    .cq-speaking-record-btn:hover {
      box-shadow: 0 0 30px rgba(249, 115, 22, 0.7);
    }
    .cq-speaking-record-btn.recording {
      background: #ef4444; /* red-500 */
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
    
    .cq-speaking-submit-btn {
      padding: 0.5rem 2.5rem;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700 */
      border-radius: 0.5rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1rem;
    }
    .cq-speaking-submit-btn:hover:not(:disabled) {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
    }
    .cq-speaking-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Case Study Assignment Modal Styles - Matching React Design */
    .cq-case-study-modal {
      position: fixed;
      z-index: 3100;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: #020617; /* slate-950 */
      color: white;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Star Field Background */
    .cq-case-study-stars {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .cq-case-study-star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: cq-case-study-twinkle linear infinite;
    }
    @keyframes cq-case-study-twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.9; }
    }
    .cq-case-study-glow-1 {
      position: absolute;
      top: 5rem;
      left: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    .cq-case-study-glow-2 {
      position: absolute;
      bottom: 0;
      right: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    
    .cq-case-study-modal-content {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
    }
    
    .cq-case-study-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30, 41, 59, 0.3); /* slate-800/30 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }
    .cq-case-study-title {
      font-size: 1.875rem; /* text-3xl */
      font-weight: 700;
      color: #f97316; /* orange-500 */
      margin: 0;
    }
    .cq-case-study-header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .cq-case-study-timer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      backdrop-filter: blur(8px);
    }
    .cq-case-study-timer:hover {
      border-color: rgba(249, 115, 22, 0.3); /* orange-500/30 */
    }
    .cq-case-study-timer.active {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }
    .cq-case-study-timer-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: #f97316; /* orange-500 */
      transition: all 0.2s;
    }
    .cq-case-study-timer.active .cq-case-study-timer-dot {
      background: #ef4444; /* red-500 */
      animation: cq-case-study-pulse-dot 1.5s ease-in-out infinite;
    }
    @keyframes cq-case-study-pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .cq-case-study-timer-text {
      font-size: 0.875rem;
      font-family: monospace;
      font-weight: 600;
      color: #cbd5e1; /* slate-300 */
    }
    .cq-case-study-timer.active .cq-case-study-timer-text {
      color: #fca5a5; /* red-400 */
    }
    .cq-case-study-timer-start {
      font-size: 0.75rem;
      color: #94a3b8; /* slate-400 */
      margin-left: 0.25rem;
    }
    .cq-case-study-timer.active .cq-case-study-timer-start {
      display: none;
    }
    .cq-case-study-close {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: #f97316; /* orange-500 */
      color: white;
      border: none;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
    }
    .cq-case-study-close:hover {
      background: #ea580c; /* orange-600 */
    }
    
    .cq-case-study-main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 0;
    }
    
    .cq-case-study-top-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-info-card {
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 1rem;
      backdrop-filter: blur(8px);
    }
    .cq-case-study-info-card.cq-case-study-clickable {
      cursor: pointer;
      transition: all 0.2s;
    }
    .cq-case-study-info-card.cq-case-study-clickable:hover {
      border-color: rgba(249, 115, 22, 0.3); /* orange-500/30 */
    }
    .cq-case-study-info-label {
      font-size: 0.75rem;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.25rem;
    }
    .cq-case-study-info-value {
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
    }
    .cq-case-study-info-preview {
      font-size: 0.75rem;
      color: white;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: color 0.2s;
    }
    .cq-case-study-clickable:hover .cq-case-study-info-preview {
      color: #fb923c; /* orange-400 */
    }
    .cq-case-study-read-more {
      font-size: 0.75rem;
      color: #fb923c; /* orange-400 */
      margin-top: 0.5rem;
    }
    
    .cq-case-study-expanded-content {
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 1.5rem;
      backdrop-filter: blur(8px);
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .cq-case-study-expanded-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }
    .cq-case-study-expanded-label {
      font-size: 0.875rem;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.25rem;
    }
    .cq-case-study-expanded-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: white;
    }
    .cq-case-study-expanded-close {
      color: #94a3b8; /* slate-400 */
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      transition: color 0.2s;
      padding: 0;
      width: 1.25rem;
      height: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cq-case-study-expanded-close:hover {
      color: #fb923c; /* orange-400 */
    }
    .cq-case-study-full-content {
      font-size: 0.875rem;
      color: white;
      line-height: 1.75;
      flex: 1;
    }
    
    .cq-case-study-video-container {
      flex: 1;
      position: relative;
      border-radius: 1rem; /* rounded-2xl */
      overflow: hidden;
      border: 2px solid rgba(249, 115, 22, 0.3); /* border-orange-500/30 */
      background: #000;
      min-height: 0;
    }
    .cq-case-study-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cq-case-study-no-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1rem;
    }
    
    /* Recording Indicator */
    .cq-case-study-recording-indicator {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      backdrop-filter: blur(8px);
      font-size: 0.75rem;
    }
    .cq-case-study-recording-indicator.active {
      display: flex;
    }
    .cq-case-study-recording-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: #ef4444;
      border-radius: 50%;
      animation: cq-case-study-pulse-dot 1.5s ease-in-out infinite;
    }
    .cq-case-study-recording-text {
      font-weight: 600;
      color: #fca5a5; /* red-400 */
    }
    
    .cq-case-study-bottom-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-question-card {
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 0.75rem;
      backdrop-filter: blur(8px);
    }
    .cq-case-study-question-label {
      font-size: 0.75rem;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.5rem;
    }
    .cq-case-study-question-text {
      font-size: 0.75rem;
      color: white;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .cq-case-study-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }
    .cq-case-study-control-btn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: rgba(30, 41, 59, 0.4); /* slate-800/40 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #94a3b8; /* slate-400 */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1.25rem;
    }
    .cq-case-study-control-btn:hover {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #cbd5e1; /* slate-300 */
    }
    .cq-case-study-record-btn {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background: linear-gradient(to right, #f97316, #ef4444); /* orange-500 to red-500 */
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
      font-size: 2rem;
      font-weight: 600;
    }
    .cq-case-study-record-btn:hover {
      box-shadow: 0 0 30px rgba(249, 115, 22, 0.7);
    }
    .cq-case-study-record-btn.recording {
      background: #ef4444; /* red-500 */
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
    
    .cq-case-study-submit-btn {
      padding: 0.5rem 2.5rem;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700 */
      border-radius: 0.5rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1rem;
    }
    .cq-case-study-submit-btn:hover:not(:disabled) {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
    }
    .cq-case-study-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Practice Quiz Fullscreen Modal Styles */
    .practice-quiz-fullscreen {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display: none;
      flex-direction: column;
      min-height: 100vh;
      overflow-y: auto;
      color: #fff;
    }

    .practice-quiz-fullscreen[style*="display: flex"] {
      display: flex !important;
    }

    .practice-quiz-fullscreen[style*="display: block"] {
      display: flex !important;
    }

    /* Galaxy Background */
    .practice-quiz-galaxy-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: #000;
      overflow: hidden;
    }

    .practice-quiz-galaxy-gradient {
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom right, #0f172a 0%, #000 50%, rgba(88, 28, 135, 0.1) 100%);
    }

    .practice-quiz-stars-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 1;
    }

    .practice-quiz-star {
      position: absolute;
      border-radius: 50%;
      background: #fff;
      pointer-events: none;
      z-index: 2;
    }

    @keyframes practice-quiz-twinkle {
      0%, 100% { opacity: 0.1; }
      50% { opacity: 0.8; }
    }

    .practice-quiz-nebula {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }

    .practice-quiz-nebula-1 {
      top: 0;
      left: 25%;
      width: 500px;
      height: 500px;
      background: rgba(147, 51, 234, 0.05);
    }

    .practice-quiz-nebula-2 {
      top: 33%;
      right: 0;
      width: 600px;
      height: 600px;
      background: rgba(37, 99, 235, 0.05);
    }

    .practice-quiz-nebula-3 {
      bottom: 0;
      left: 50%;
      width: 500px;
      height: 500px;
      background: rgba(6, 182, 212, 0.05);
    }

    /* Top Bar */
    .practice-quiz-topbar {
      position: sticky;
      z-index: 10001;
      border-bottom: 1px solid rgba(127, 29, 29, 0.3);
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(40px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      top: 0;
    }

    .practice-quiz-topbar-content {
      max-width: 80rem;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .practice-quiz-topbar-title {
      font-size: 1.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .practice-quiz-topbar-subtitle {
      color: #94a3b8;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .practice-quiz-topbar-right {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .practice-quiz-timer-section {
      text-align: center;
    }

    .practice-quiz-timer-label {
      color: #94a3b8;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0;
    }

    .practice-quiz-timer-value {
      color: #fb923c;
      font-size: 1.5rem;
      font-weight: 900;
      margin: 0;
    }

    .practice-quiz-close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      border-radius: 0.5rem;
    }

    .practice-quiz-close-btn:hover {
      color: #fb923c;
      background: rgba(251, 146, 60, 0.1);
    }

    /* Main Content */
    .practice-quiz-main {
      position: relative;
      z-index: 1;
      max-width: 80rem;
      margin: 0 auto;
      padding: 3rem 2rem;
      flex: 1;
    }

    .practice-quiz-competency-badge {
      display: inline-block;
      background: rgba(220, 38, 38, 0.3);
      border: 1px solid rgba(220, 38, 38, 0.5);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      margin-bottom: 3rem;
    }

    .practice-quiz-competency-text {
      color: #fca5a5;
      font-weight: 900;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .practice-quiz-question-section {
      margin-bottom: 4rem;
    }

    .practice-quiz-question {
      font-size: 3rem;
      font-weight: 900;
      color: #fff;
      margin-bottom: 1rem;
      line-height: 1.2;
    }

    .practice-quiz-question-hint {
      color: #94a3b8;
      font-size: 1rem;
    }

    .practice-quiz-options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 4rem;
    }

    .practice-quiz-option-btn {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 1.5rem;
      border-radius: 1rem;
      border: 2px solid rgba(71, 85, 105, 0.5);
      background: rgba(30, 41, 59, 0.3);
      color: #fff;
      font-weight: 700;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      transform: scale(1);
    }

    .practice-quiz-option-btn:hover {
      transform: scale(1.02);
      border-color: rgba(251, 146, 60, 0.5);
      background: rgba(251, 146, 60, 0.1);
    }

    .practice-quiz-option-btn.selected {
      background: linear-gradient(to right, rgba(220, 38, 38, 0.4), rgba(249, 115, 22, 0.3));
      border-color: rgba(239, 68, 68, 0.7);
    }

    .practice-quiz-option-radio {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      border: 3px solid rgba(71, 85, 105, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .practice-quiz-option-btn.selected .practice-quiz-option-radio {
      border-color: #dc2626;
      background: #dc2626;
    }

    .practice-quiz-option-dot {
      width: 0.75rem;
      height: 0.75rem;
      background: #fff;
      border-radius: 50%;
    }

    .practice-quiz-option-text {
      color: #fff;
      font-weight: 700;
      font-size: 1.125rem;
    }

    .practice-quiz-progress-section {
      margin-bottom: 3rem;
    }

    .practice-quiz-progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .practice-quiz-progress-label {
      color: #94a3b8;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
      margin: 0;
    }

    .practice-quiz-progress-value {
      color: #94a3b8;
      font-size: 0.875rem;
      margin: 0;
    }

    .practice-quiz-progress-bar {
      width: 100%;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 9999px;
      height: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(71, 85, 105, 0.5);
    }

    .practice-quiz-progress-fill {
      background: linear-gradient(to right, #dc2626, #f97316);
      height: 100%;
      transition: width 0.5s;
      border-radius: 9999px;
    }

    .practice-quiz-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .practice-quiz-prev-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #94a3b8;
      background: none;
      border: none;
      font-weight: 900;
      cursor: pointer;
      transition: color 0.2s;
      padding: 0.5rem;
    }

    .practice-quiz-prev-btn:hover:not(:disabled) {
      color: #fff;
    }

    .practice-quiz-prev-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .practice-quiz-next-btn,
    .practice-quiz-submit-btn {
      background: linear-gradient(to right, #dc2626, #f97316);
      border: none;
      color: #fff;
      font-weight: 900;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      transform: scale(1);
    }

    .practice-quiz-next-btn:hover,
    .practice-quiz-submit-btn:hover {
      background: linear-gradient(to right, #b91c1c, #ea580c);
      transform: scale(1.05);
    }

    /* Congrats Modal Styles */
    .congrats-content {
      text-align: center;
      max-width: 600px;
      width: 100%;
    }

    .congrats-header {
      margin-bottom: 2rem;
    }

    .congrats-title {
      font-size: 3rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
    }

    .congrats-subtitle {
      font-size: 1.25rem;
      color: #94a3b8;
    }

    .congrats-assignment-info {
      margin-bottom: 2rem;
    }

    .congrats-assignment-label {
      font-size: 0.875rem;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 0.5rem;
    }

    .congrats-assignment-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
    }

    .congrats-competencies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .congrats-competency-item {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.5rem;
      padding: 1rem;
    }

    .congrats-competency-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: #fca5a5;
      margin-bottom: 0.5rem;
    }

    .congrats-competency-stats {
      font-size: 0.75rem;
      color: #94a3b8;
    }

    .congrats-actions {
      display: flex;
      justify-content: center;
    }

    /* Assignment Modal Styles */
    .cq-modal {
      display: none !important;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      justify-content: center;
      align-items: center;
      transition: background 0.3s;
    }

    .cq-modal[style*="display: block"],
    .cq-modal[style*="display:block"] {
      display: flex !important;
    }

    .cq-modal:not([style*="display: block"]):not([style*="display:block"]) {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
      position: absolute !important;
      left: -9999px !important;
      top: -9999px !important;
      width: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }

    .cq-modal:not([style*="display: block"]):not([style*="display:block"]) * {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      pointer-events: none !important;
    }

    .cq-modal-content {
      background: linear-gradient(to bottom right, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.95));
      border: 2px solid rgba(239, 68, 68, 0.5);
      border-radius: 1.5rem;
      padding: 3rem;
      max-width: 540px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      backdrop-filter: blur(24px);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .cq-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      color: #f87171;
      font-size: 2rem;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cq-close:hover {
      color: #ef4444;
    }

    .cq-modal-title {
      font-size: 1.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1.5rem;
    }

    .cq-modal-fields {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .cq-modal-footer {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 1.5rem;
    }

    .cq-modal-btn {
      padding: 0.75rem 1.5rem;
      background: rgba(127, 29, 29, 0.5);
      border: 2px solid rgba(239, 68, 68, 0.5);
      border-radius: 0.5rem;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cq-modal-btn:hover:not(:disabled) {
      background: rgba(127, 29, 29, 0.7);
      border-color: rgba(239, 68, 68, 0.7);
    }

    .cq-modal-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Loading Modal Styles */
    .cq-written-loading {
      position: fixed;
      inset: 0;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(20px);
    }

    .gradient-balls {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .ball {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      animation: float 6s ease-in-out infinite;
    }

    .ball-1 {
      width: 300px;
      height: 300px;
      background: rgba(239, 68, 68, 0.3);
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }

    .ball-2 {
      width: 250px;
      height: 250px;
      background: rgba(249, 115, 22, 0.3);
      top: 60%;
      right: 10%;
      animation-delay: 2s;
    }

    .ball-3 {
      width: 200px;
      height: 200px;
      background: rgba(234, 179, 8, 0.3);
      bottom: 20%;
      left: 50%;
      animation-delay: 4s;
    }

    .ball-4 {
      width: 180px;
      height: 180px;
      background: rgba(239, 68, 68, 0.2);
      top: 30%;
      right: 30%;
      animation-delay: 1s;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -30px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    .cq-loading-container {
      position: relative;
      z-index: 1;
      text-align: center;
    }

    .cq-loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(239, 68, 68, 0.2);
      border-top-color: #ef4444;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .cq-loading-text {
      font-size: 1.5rem;
      font-weight: 700;
      color: #fff;
      margin-bottom: 0.5rem;
    }

    .cq-loading-subtext {
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 1.5rem;
    }

    .cq-loading-progress {
      width: 300px;
      height: 8px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 9999px;
      overflow: hidden;
      margin: 0 auto;
    }

    .cq-loading-progress-bar {
      height: 100%;
      background: linear-gradient(to right, #ef4444, #f97316);
      border-radius: 9999px;
      transition: width 0.3s;
      width: 0%;
    }

    .circular-progress-loader {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .circular-progress-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .circular-progress-bg {
      fill: none;
      stroke: rgba(255,255,255,0.1);
      stroke-width: 8;
    }

    .circular-progress-fill {
      fill: none;
      stroke: url(#progressGradient);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      transition: stroke-dashoffset 0.3s;
    }

    .circular-progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.25rem;
      font-weight: 700;
      color: #fff;
    }

    #cq-assignment-modal {
  position: fixed !important;
}

#cq-assignment-modal[style*="display: flex"] {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  pointer-events: auto !important;
}
/* ADD THIS TO YOUR STYLESHEET */

#cq-assignment-modal {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  z-index: 999999 !important;
  background-color: rgba(0, 0, 0, 0.9) !important;
  align-items: center !important;
  justify-content: center !important;
  pointer-events: auto !important;
}

#cq-assignment-modal[style*="display: none"] {
  display: none !important;
  visibility: hidden !important;
  opacity: 0 !important;
  pointer-events: none !important;
}

.cq-modal-content {
  position: relative !important;
  background: #1a1f3a !important;
  border: 2px solid #ef4444 !important;
  border-radius: 16px !important;
  padding: 2rem !important;
  max-width: 600px !important;
  width: 90% !important;
  max-height: 90vh !important;
  overflow-y: auto !important;
  z-index: 1000000 !important;
}
/* ===== ASSIGNMENT MODAL - FINAL DESIGN ===== */

#cq-assignment-modal {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  z-index: 999999 !important;
  background-color: rgba(0, 0, 0, 0.7) !important;
  align-items: center !important;
  justify-content: center !important;
  pointer-events: auto !important;
}

.cq-modal-content {
  position: relative !important;
  background: linear-gradient(135deg, #0f1419 0%, #1a1f3a 100%) !important;
  border: 3px solid #ef4444 !important;
  border-radius: 28px !important;
  padding: 3rem 2.5rem !important;
  max-width: 650px !important;
  width: 90% !important;
  max-height: 85vh !important;
  overflow-y: auto !important;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.7) !important;
  display: flex !important;
  flex-direction: column !important;
  z-index: 1000000 !important;
}

#cq-assignment-title {
  color: #ff9c42 !important;
  font-size: 2.8rem !important;
  font-weight: 800 !important;
  margin: 0 0 2.5rem 0 !important;
  text-align: center !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  letter-spacing: 0.5px !important;
}

.cq-close {
  position: absolute !important;
  right: 1.5rem !important;
  top: 1.5rem !important;
  color: #d1d5db !important;
  font-size: 2.2rem !important;
  font-weight: 300 !important;
  cursor: pointer !important;
  border: none !important;
  background: none !important;
  padding: 0 !important;
  width: 50px !important;
  height: 50px !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  transition: all 0.2s ease !important;
}

.cq-close:hover {
  color: #fff !important;
  transform: scale(1.15) !important;
}

#cq-assignment-info {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.cq-modal-fields {
  color: #e2e8f0 !important;
  line-height: 2.2 !important;
  font-size: 1.15rem !important;
  margin-bottom: 2.5rem !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.cq-modal-fields div {
  margin-bottom: 1.3rem !important;
  padding-bottom: 0 !important;
  border-bottom: none !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  color: #e2e8f0 !important;
}

.cq-modal-fields div:last-child {
  margin-bottom: 0 !important;
}

.cq-modal-fields b {
  color: #fff !important;
  font-weight: 600 !important;
  margin-right: 0.5rem !important;
}

.cq-modal-fields ul {
  margin: 0 !important;
  padding: 0 !important;
  color: #9ca3af !important;
  list-style: none !important;
}

.cq-modal-fields li {
  margin-bottom: 0.5rem !important;
  display: block !important;
  visibility: visible !important;
}

.cq-modal-footer {
  display: flex !important;
  gap: 1.5rem !important;
  margin-top: 2.5rem !important;
  justify-content: center !important;
  flex-wrap: wrap !important;
}

.cq-modal-btn {
  padding: 0.9rem 2.2rem !important;
  border: none !important;
  border-radius: 50px !important;
  cursor: pointer !important;
  font-weight: 700 !important;
  font-size: 1.08rem !important;
  transition: all 0.3s ease !important;
  white-space: nowrap !important;
  color: white !important;
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.cq-modal-btn:first-child {
  background: linear-gradient(135deg, #ef4444 0%, #f97316 100%) !important;
  min-width: 200px !important;
}

.cq-modal-btn:first-child:hover {
  background: linear-gradient(135deg, #dc2626 0%, #ea580c 100%) !important;
  transform: translateY(-4px) !important;
  box-shadow: 0 12px 24px rgba(239, 68, 68, 0.5) !important;
}

.cq-modal-btn:last-child {
  background: linear-gradient(135deg, #ef4444 0%, #f97316 100%) !important;
  min-width: 200px !important;
}

.cq-modal-btn:last-child:hover {
  background: linear-gradient(135deg, #dc2626 0%, #ea580c 100%) !important;
  transform: translateY(-4px) !important;
  box-shadow: 0 12px 24px rgba(239, 68, 68, 0.5) !important;
}

.cq-modal-btn:active {
  transform: translateY(0) !important;
}

/* Hide quiz section by default */
#cq-assignment-quiz {
  display: none !important;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .cq-modal-content {
    width: 95% !important;
    padding: 2rem 1.5rem !important;
    max-height: 90vh !important;
    border-radius: 20px !important;
  }

  #cq-assignment-title {
    font-size: 2.2rem !important;
    margin-bottom: 2rem !important;
  }

  .cq-modal-footer {
    flex-direction: column !important;
  }

  .cq-modal-btn {
    width: 100% !important;
    min-width: unset !important;
  }

  .cq-modal-fields {
    font-size: 1rem !important;
    line-height: 2 !important;
  }
}

#cq-assignment-info {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

#cq-assignment-fields {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.cq-modal-fields {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.cq-modal-footer {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
}
#cq-assignment-info {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

#cq-assignment-fields {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  height: auto !important;
}

.cq-modal-fields {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.cq-modal-footer {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
  margin-top: 1.5rem !important;
  gap: 1.5rem !important;
  justify-content: center !important;
  text-align: center !important;
}

.cq-modal-footer div {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.cq-modal-btn {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

.cq-modal[style*="display: flex"],
.cq-modal[style*="display:flex"] {
  display: flex !important;
}

.cq-modal[style*="display: flex"] *,
.cq-modal[style*="display:flex"] * {
  display: auto !important;
  visibility: visible !important;
  opacity: 1 !important;
  pointer-events: auto !important;
}

.cq-modal-footer {
  display: flex !important;
  visibility: visible !important;
  opacity: 1 !important;
}

#cq-assignment-fields {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}
  </style>
<script type="module" src="/js/firebase.js"></script></head>
<body>
  <!-- Galaxy Background -->
  <div class="galaxy-background" id="galaxyBackground"></div>

  <!-- Header -->
  <div class="blaze-header">
    <div class="blaze-header-content">
      <div class="header-left">
        <button class="hamburger-menu" id="hamburgerMenu" onclick="toggleMobileNav()" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <h1 class="blaze-logo">FBLAZE</h1>
      </div>
      <h1 class="blaze-logo desktop-logo">FBLAZE</h1>
      <nav class="blaze-nav" id="mainNav">
        <button class="mobile-nav-close" onclick="toggleMobileNav()" aria-label="Close menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <a href="../home3.html" class="nav-link">Home</a>
        <a href="javascript:void(0)" onclick="toggleNotificationPanel()" class="nav-link">
          Notifications
          <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="../practice.html" class="nav-link">Practice</a>
        <a href="forum.html" class="nav-link">Forum</a>
        <a href="../Calendar/calendar1.html" class="nav-link">Calendar</a>
        <a href="../mentor1.html" class="nav-link" id="mentorNavLink" style="display: none;">Mentor</a>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <div class="forum-container">
    <!-- Hero Section -->
    <div class="forum-hero">
      <h1 class="forum-hero-title">
        Competitions
        <br />
        <span class="forum-hero-gradient">Forum</span>
      </h1>
      <p class="forum-hero-desc">Connect, compete, and conquer. Share strategies, ask questions, and dominate the rankings.</p>
    </div>

    <!-- CTA Section -->
    <div class="forum-cta">
      <p class="cta-label">Join the Conversation</p>
      <h2 class="cta-title">Got a question? Share it with the community.</h2>
      <p class="cta-desc">Get answers from other competitors and mentors. Build your knowledge together.</p>
      <button id="askQuestionBtn" class="cta-button">Post a Question</button>
    </div>

    <!-- Tabs -->
    <div class="forum-tabs">
      <button class="forum-tab active" data-filter="not solved">Not Solved</button>
      <button class="forum-tab" data-filter="solved">Solved</button>
      <button class="forum-tab" data-filter="all">All</button>
    </div>

    <!-- Main Grid -->
    <div class="forum-grid">
      <!-- Left - Forum Posts -->
      <div class="forum-posts" id="forumPosts">
        <!-- Posts will be rendered here by JavaScript -->
      </div>

      <!-- Right - Forum Info & Stats -->
      <div class="forum-sidebar">
        <!-- Forum Info -->
        <div class="forum-info-card">
          <h3 class="forum-info-title">Competitions Forum</h3>
          <p class="forum-info-desc">Ask questions about your competition, studying, and anything BLAZE-related!</p>
          
          <div class="forum-guidelines">
            <div class="guideline-item">
              <span class="guideline-bullet">•</span>
              <p>Be specific about the event or topic you're asking about.</p>
            </div>
            <div class="guideline-item">
              <span class="guideline-bullet">•</span>
              <p>Share your study methods or project progress when possible.</p>
            </div>
            <div class="guideline-item">
              <span class="guideline-bullet">•</span>
              <p>Use reactions to show appreciation or start discussions.</p>
            </div>
          </div>
        </div>

        <!-- Stats -->
        <div class="forum-stats-card">
          <div class="stat-item">
            <p class="stat-label">Total Posts</p>
            <p class="stat-value posts-count">847</p>
          </div>
          <div class="stat-item">
            <p class="stat-label">Active Members</p>
            <p class="stat-value members-count">256</p>
          </div>
        </div>

        <!-- Performance Stats -->
        <div class="forum-performance-card">
          <h4 class="performance-title">Performance</h4>
          <div class="stat-item">
            <p class="stat-label">Avg Response Time</p>
            <p class="stat-value response-time">2.3h</p>
          </div>
          <div class="stat-item">
            <p class="stat-label">Solved Rate</p>
            <p class="stat-value solved-percent">78%</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Question Modal -->
  <div id="questionModal" class="modal hidden" tabindex="-1">
            <div class="modal-content">
              <button class="close-btn" id="closeModal" aria-label="Close modal">&times;</button>
              <h2>I have a question!</h2>
             
              <p class="help-prompt">What do you need help with today?</p>
              <div class="options">
                <button class="option-btn" data-type="quick">
                  I have a quick question about a problem (&lt;10 minutes)
                </button>
                <button class="option-btn" data-type="assignment">
                  I need help with an assignment (10–30 minutes)
                </button>
                <button class="option-btn" data-type="review">
                  I want to review a topic / learn a new topic (30–90 minutes)
                </button>
              </div>
              <div class="expanded-form hidden">
                <label>
                  <strong>Share your problem:</strong>
                  <textarea placeholder="E.g., I'm struggling with understanding parliamentary procedure in FBLA competitions..."></textarea>
                </label>
                <label>
                  <strong>What have you tried so far?</strong>
                  <textarea placeholder="E.g., I've reviewed the FBLA guidelines but need clarification on motion procedures..."></textarea>
                </label>
              </div>
              <div class="actions">
                <button class="cancel-btn">Cancel</button>
                <button class="post-btn" disabled>Post</button>
              </div>
            </div>
          </div>
          <!-- End Modal -->

  <!-- Notifications Panel -->
  <div class="comment-panel hidden" id="notificationPanel">
    <div class="comment-header">
      <span class="comment-title">Notifications</span>
      <button class="close-btn" onclick="toggleNotificationPanel()">✕</button>
    </div>
    <div class="comment-content" id="notificationList">
      <!-- Notifications will appear here -->
    </div>
  </div>

  <!-- Comment Panel (for forum post comments) -->
  <div class="comment-panel hidden" id="commentPanel">
    <div class="comment-header">
      <span class="comment-title">Entry Details</span>
      <button class="close-btn" onclick="toggleCommentPanel()">✕</button>
    </div>
    <div class="comment-content">
      <div class="comments-thread" id="commentsThread">
        <!-- Comments get injected here -->
      </div>
    </div>
    <div class="reply-container">
      <textarea placeholder="Reply..." class="reply-box" id="commentReplyBox"></textarea>
      <button class="reply-submit-btn" id="commentSubmitBtn">Submit</button>
    </div>
  </div>

<!-- Notification Modal -->
<div id="notificationModal" class="notification-modal hidden" style="display: none !important; visibility: hidden !important;">
  <div class="notification-content">
    <p>Post marked as resolved!</p>
    <button id="closeNotificationBtn">Close</button>
  </div>
</div>

<!-- XP Notification Modal -->
<div id="xpNotificationModal" class="notification-modal hidden" style="display: none !important; visibility: hidden !important;">
  <div class="xp-notification-content">
    <p id="xpNotificationText">+20 XP earned!</p>
    <button id="closeXpNotificationBtn" class="xp-notification-btn">Awesome!</button>
  </div>
</div>


<script>

  // Add this to your main JavaScript file - it will fix the modal automatically

// Run this function every time the modal opens
function fixAssignmentModal() {
  const modal = document.getElementById('cq-assignment-modal');
  if (!modal) return;
  
  // Force unhide info section
  const info = document.getElementById('cq-assignment-info');
  if (info) {
    info.style.display = 'block';
    info.style.visibility = 'visible';
    info.style.opacity = '1';
  }
  
  // Force unhide fields
  const fields = document.getElementById('cq-assignment-fields');
  if (fields) {
    fields.style.display = 'block';
    fields.style.visibility = 'visible';
    fields.style.opacity = '1';
    fields.style.height = 'auto';
  }
  
  // Force unhide footer
  const footer = document.querySelector('.cq-modal-footer');
  if (footer) {
    footer.style.display = 'flex';
    footer.style.visibility = 'visible';
    footer.style.opacity = '1';
    footer.style.marginTop = '1.5rem';
    footer.style.gap = '1.5rem';
    footer.style.justifyContent = 'center';
  }
  
  // Force unhide all buttons
  modal.querySelectorAll('.cq-modal-btn').forEach(btn => {
    btn.style.display = 'block';
    btn.style.visibility = 'visible';
    btn.style.opacity = '1';
  });
  
  // Force unhide all field divs
  modal.querySelectorAll('.cq-modal-fields div').forEach(div => {
    div.style.display = 'block';
    div.style.visibility = 'visible';
    div.style.opacity = '1';
  });
}

// Hook into openFullAssignmentModal to fix after content is added
const originalOpenModal = window.openFullAssignmentModal;
window.openFullAssignmentModal = function(assignment) {
  // Call original function
  originalOpenModal.call(this, assignment);
  
  // Then fix the modal after a tiny delay
  setTimeout(() => {
    fixAssignmentModal();
  }, 100);
};

// Also run on page load
document.addEventListener('DOMContentLoaded', () => {
  fixAssignmentModal();
});

// And run periodically in case CSS changes
setInterval(() => {
  const modal = document.getElementById('cq-assignment-modal');
  if (modal && modal.style.display === 'flex') {
    fixAssignmentModal();
  }
}, 500);

  // Force hide assignment modal on page load
  document.addEventListener("DOMContentLoaded", () => {
    const assignmentModal = document.getElementById('cq-assignment-modal');
    if (assignmentModal) {
      assignmentModal.style.display = 'none';
      assignmentModal.style.visibility = 'hidden';
      assignmentModal.style.opacity = '0';
      assignmentModal.style.pointerEvents = 'none';
    }
  });

  document.addEventListener("DOMContentLoaded", () => {
    // --------- CREATE ANIMATED STARS ---------
    function createStars() {
      const galaxyBackground = document.getElementById('galaxyBackground');
      if (!galaxyBackground) return;
      
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.9 + 0.3;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `twinkle ${duration}s ease-in-out infinite`;
        star.style.animationDelay = delay + 's';
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
        
        galaxyBackground.appendChild(star);
      }
    }
    
    createStars();
    
    // --------- SEARCH FUNCTIONALITY ---------
    const navbarSearch = document.getElementById('navbarSearch');
    const searchDropdown = document.getElementById('searchDropdown');
    const searchIcon = document.getElementById('navbarSearchIcon');
    
    if (navbarSearch && searchDropdown) {
      navbarSearch.addEventListener('input', async function(e) {
        const query = e.target.value.trim();
        if (!query) {
          searchDropdown.classList.remove('show');
          searchDropdown.innerHTML = '';
          return;
        }
        
        try {
          // Meilisearch integration (if available)
          if (typeof MeiliSearch !== 'undefined') {
            const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
            const index = client.index('content');
            const result = await index.search(query, { limit: 5 });
            
            if (!result.hits.length) {
              searchDropdown.classList.remove('show');
              searchDropdown.innerHTML = '';
              return;
            }
            
            searchDropdown.classList.add('show');
            searchDropdown.innerHTML = result.hits.map(doc => `
              <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
                <b>${doc.title}</b><br>
                <span style="font-size:12px;color:#94a3b8;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
              </div>
            `).join('');
          } else {
            // Fallback: hide dropdown if Meilisearch not available
            searchDropdown.classList.remove('show');
          }
        } catch (err) {
          searchDropdown.classList.remove('show');
          searchDropdown.innerHTML = '';
        }
      });
      
      // Handle result click
      searchDropdown.addEventListener('click', function(e) {
        const target = e.target.closest('.dropdown-result');
        if (target && target.dataset.url) {
          window.location = target.dataset.url;
        }
      });
      
      // Hide dropdown on outside click
      document.addEventListener('click', function(e) {
        if (!navbarSearch.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.classList.remove('show');
        }
      });
    }
    
    // --------- FIREBASE INIT ---------
    if (!firebase.apps.length) {
    }
    const db = firebase.firestore();

    // --------- AUTH STATE ---------
    window.currentUser = null;
    let currentFilter = "not solved";  // track current tab/filter

    firebase.auth().onAuthStateChanged(async (user) => {
      window.currentUser = user;
      if (user) {
        console.log("[CQ] Signed in:", user.email || user.displayName);
        // Check mentor status and show/hide mentor link
        db.collection('users').doc(user.uid).get().then((doc) => {
          const mentorNavLink = document.getElementById('mentorNavLink');
          if (mentorNavLink) {
            const isMentor = doc.exists && doc.data().isMentor === true;
            mentorNavLink.style.display = isMentor ? 'block' : 'none';
          }
        }).catch((error) => {
          console.error('Error checking mentor status:', error);
        });
      } else {
        console.log("[CQ] Not signed in");
      }
      await loadForumQuestions(currentFilter);
      await updatePostCount();
      await updateMemberCount();
      await updateSolvedPercentage();
      await updateMedianResponseTime();
      setupNotifications();
    });
    
    // --------- SETUP NOTIFICATIONS ---------
    function setupNotifications() {
  const user = window.currentUser;
  if (!user) {
    console.log("No user logged in");
    return;
  }

  console.log("Setting up notifications for user:", user.uid);

  // Load ALL notifications (read and unread) for the notification panel
  db.collection('notifications')
    .where('menteeId', '==', user.uid)
    .orderBy('timestamp', 'desc')
    .limit(20)
    .onSnapshot((snapshot) => {
      const notificationList = document.getElementById("notificationList");
      if (!notificationList) return;
      
      notificationList.innerHTML = ''; // Clear existing
      
      if (snapshot.empty) {
        notificationList.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 2rem;">No notifications yet.</p>';
        updateNotificationBadge(0);
        return;
      }
      
      snapshot.forEach((doc) => {
        const notif = doc.data();
        const item = document.createElement("div");
        item.className = `notification-item ${notif.read ? 'read' : ''}`;
        
        // Format timestamp
        let timeText = "Just now";
        if (notif.timestamp && notif.timestamp.toDate) {
          const date = notif.timestamp.toDate();
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          if (diffMins < 1) timeText = "Just now";
          else if (diffMins < 60) timeText = `${diffMins}m ago`;
          else if (diffHours < 24) timeText = `${diffHours}h ago`;
          else timeText = `${diffDays}d ago`;
        }
        
        // Different content based on notification type
        let bodyContent = '';
        if (notif.type === 'assignment') {
          bodyContent = `
            <div class="notification-body">
              Type: ${notif.assignmentType || 'Quiz'}<br>
              Competencies: ${notif.competencies ? notif.competencies.join(', ') : 'n/a'}<br>
              ${notif.time ? `Time: ${notif.time}<br>` : ''}
              ${notif.difficulty ? `Difficulty: ${notif.difficulty}` : ''}
            </div>
          `;
        } else {
          bodyContent = `
            <div class="notification-body">
              Assignment: ${notif.assignmentName || 'Unknown'}
              ${notif.score !== undefined ? `<br>Score: ${notif.score}/${notif.totalQuestions}` : ''}
            </div>
          `;
        }
        
        item.innerHTML = `
          <div class="notification-header">
            <strong>${notif.message || 'Notification'}</strong>
            <span class="notification-time">${timeText}</span>
          </div>
          ${bodyContent}
        `;
        
        // ✅ SINGLE CLICK HANDLER - NO DUPLICATES
        // REPLACE the notification click handler in setupNotifications()
if (notif.type === 'assignment' && notif.assignmentId) {
  item.style.cursor = 'pointer';
  item.addEventListener("click", async () => {
    console.log("🔔 Assignment notification clicked:", notif.assignmentId);
    
    // Mark as read
    if (!notif.read) {
      doc.ref.update({ read: true });
    }
    item.classList.add("read");
    item.classList.remove("unread");
    
    // ✅ Set global variables BEFORE opening modal
    window.latestAssignmentId = notif.assignmentId;
    window.currentAssignment = null;
    
    try {
      console.log("📥 Fetching assignment from Firebase...");
      
      // Fetch full assignment document
      const assignmentDoc = await db.collection('assignments').doc(notif.assignmentId).get();
      if (assignmentDoc.exists) {
        const assignmentData = assignmentDoc.data();
        
        console.log("✅ Assignment data retrieved:", assignmentData);
        
        // ✅ Set globals that acceptAssignmentNow() expects
        window.currentAssignment = assignmentData;
        window.latestAssignmentId = notif.assignmentId;
        
        // ✅ IMPORTANT: Close notification panel FIRST with delay
        const notificationPanel = document.getElementById("notificationPanel");
        if (notificationPanel) {
          console.log("📋 Closing notification panel...");
          
          // Remove active class to start fade-out
          if (notificationPanel.classList.contains("active")) {
            notificationPanel.classList.remove("active");
          }
          
          // Wait for animation to finish, THEN open modal
          setTimeout(() => {
            notificationPanel.classList.add("hidden");
            console.log("🎯 Opening assignment modal...");
            
            // NOW open the assignment modal
            openFullAssignmentModal(assignmentData);
          }, 300); // Match this to your CSS transition duration
        } else {
          // If no notification panel, open immediately
          console.log("🎯 Opening assignment modal (no panel delay)...");
          openFullAssignmentModal(assignmentData);
        }
      } else {
        console.error("❌ Assignment not found!");
        alert("Assignment not found");
      }
    } catch (error) {
      console.error("❌ Error fetching assignment:", error);
      alert("Could not load assignment details: " + error.message);
    }
  });
} else {
  // Regular notification click handler (non-assignment)
  item.style.cursor = 'pointer';
  item.addEventListener("click", () => {
    if (!notif.read) {
      doc.ref.update({ read: true });
    }
    item.classList.add("read");
    item.classList.remove("unread");
  });
}
        
        notificationList.appendChild(item);
      });
      
      // Update notification badge count
      const unreadCount = snapshot.docs.filter(doc => !doc.data().read).length;
      updateNotificationBadge(unreadCount);
    }, (error) => {
      console.error("Notifications error:", error);
    });
}

    function updateNotificationBadge(count) {
      const notificationLink = document.querySelector('a[onclick*="toggleNotificationPanel"]');
      if (notificationLink) {
        let notificationBadge = notificationLink.querySelector('.notification-badge');
        if (!notificationBadge && count > 0) {
          notificationBadge = document.createElement('span');
          notificationBadge.className = 'notification-badge';
          notificationBadge.textContent = count;
          notificationLink.style.position = 'relative';
          notificationLink.appendChild(notificationBadge);
        } else if (notificationBadge) {
          if (count > 0) {
            notificationBadge.style.display = 'inline-flex';
            notificationBadge.textContent = count;
          } else {
            notificationBadge.style.display = 'none';
          }
        }
      }
    }

    // --------- XP SYSTEM FUNCTIONS ---------
    async function awardXP(userId, amount, reason) {
      try {
        const userRef = db.collection('users').doc(userId);
        const userDoc = await userRef.get();
        
        if (userDoc.exists) {
          // User document exists, increment XP
          await userRef.update({
            XP: firebase.firestore.FieldValue.increment(amount)
          });
        } else {
          // User document doesn't exist, create it with initial XP
          await userRef.set({
            XP: amount
          });
        }
        
        console.log(`[CQ] Awarded ${amount} XP to user ${userId} for ${reason}`);
        showXPNotification(amount, reason);
        
      } catch (error) {
        console.error("[CQ] Failed to award XP:", error);
      }
    }

    function showXPNotification(amount, reason) {
      const modal = document.getElementById("xpNotificationModal");
      const textElem = document.getElementById("xpNotificationText");
      
      let message = `+${amount} XP earned!`;
      if (reason === 'posting') {
        message = `+${amount} XP for posting a question!`;
      } else if (reason === 'commenting') {
        message = `+${amount} XP for helping out!`;
      }
      
      textElem.textContent = message;
      modal.classList.remove("hidden");

      // Auto-close after 3 seconds
      setTimeout(() => {
        modal.classList.add("hidden");
      }, 3000);
    }

    // Close XP notification manually
    document.getElementById("closeXpNotificationBtn").addEventListener("click", () => {
      document.getElementById("xpNotificationModal").classList.add("hidden");
    });

    // --------- MODAL OPEN/CLOSE ---------
    const openBtn = document.getElementById("askQuestionBtn");
    const modal = document.getElementById("questionModal");
    const closeBtn = document.getElementById("closeModal");
    const cancelBtn = document.querySelector(".cancel-btn");
    if (openBtn && modal) openBtn.onclick = () => modal.classList.remove("hidden");
    if (closeBtn && modal) closeBtn.onclick = () => modal.classList.add("hidden");
    if (cancelBtn && modal) cancelBtn.onclick = () => modal.classList.add("hidden");
    if (modal) {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.classList.add("hidden");
      });
    }

    // --------- OPTION SELECTION & FORM SHOW ---------
    const optionButtons = document.querySelectorAll('.option-btn');
    const expandedForm = document.querySelector('.expanded-form');
    optionButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        optionButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        expandedForm.classList.remove('hidden');
        checkFormCompletion();
      });
    });

    // --------- POST BUTTON ENABLE/DISABLE ---------
    const textareas = expandedForm.querySelectorAll("textarea");
    const postBtn = document.querySelector(".post-btn");
    function checkFormCompletion() {
      const hasText = Array.from(textareas).some(t => t.value.trim().length > 0);
      const optionSelected = document.querySelector('.option-btn.selected');
      if (hasText && optionSelected) {
        postBtn.removeAttribute("disabled");
      } else {
        postBtn.setAttribute("disabled", true);
      }
    }
    textareas.forEach(t => t.addEventListener("input", checkFormCompletion));
    checkFormCompletion();

    // --------- GET USER PROFILE ---------
    async function getUserProfile() {
      const user = window.currentUser;
      if (!user) return null;
      let name = user.displayName || (user.email ? user.email.split("@")[0] : "Anonymous");
      let photo = user.photoURL || "";
      try {
        const snap = await db.collection("users").doc(user.uid).get();
        if (snap.exists && snap.data().name) name = snap.data().name;
        if (snap.exists && snap.data().photoURL) photo = snap.data().photoURL;
      } catch {}
      return { name, photo, uid: user.uid };
    }

    // --------- POST QUESTION ---------
    postBtn.addEventListener("click", async () => {
      const selected = document.querySelector('.option-btn.selected');
      const helpType = selected ? selected.textContent.trim() : '';
      const [questionTextarea, triedTextarea] = expandedForm.querySelectorAll('textarea');
      const question = questionTextarea.value.trim();
      const tried = triedTextarea.value.trim();
      const zoomCheckbox = expandedForm.querySelector('input[type=checkbox]');
      const requestZoom = zoomCheckbox ? zoomCheckbox.checked : false;

      if (!helpType || !question) return;

      const user = await getUserProfile();
      if (!user) {
        alert("You must be signed in to post!");
        return;
      }

      await db.collection("forum-questions").add({
        userId: user.uid,
        userName: user.name,
        userPhoto: user.photo,
        helpType,
        question,
        tried,
        requestZoom,
        solved: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Award 20 XP for posting a question
      await awardXP(user.uid, 20, 'posting');

      // Reset modal and form
      modal.classList.add("hidden");
      questionTextarea.value = '';
      triedTextarea.value = '';
      expandedForm.classList.add('hidden');
      postBtn.setAttribute("disabled", true);
      optionButtons.forEach(b => b.classList.remove("selected"));

      await loadForumQuestions(currentFilter);

      // Update stats after new post
      await updatePostCount();
      await updateSolvedPercentage();
      await updateMedianResponseTime();
    });

    // --------- LOAD FORUM QUESTIONS ---------
    async function loadForumQuestions(filter = "not solved") {
      console.log("[CQ] loadForumQuestions filter:", filter);
      currentFilter = filter;

      if (window.currentUser === null) {
        console.log("[CQ] Waiting for auth state before loading posts");
        return;
      }

      let query = db.collection("forum-questions").orderBy("timestamp", "desc");
      if (filter === "not solved") {
        query = query.where("solved", "==", false);
      } else if (filter === "solved") {
        query = query.where("solved", "==", true);
      }

      const forumPosts = document.getElementById('forumPosts');
      if (!forumPosts) return;

      // Clear container
      forumPosts.innerHTML = "";

      const snapshot = await query.get();

      if (snapshot.empty) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = "forum-empty";
        emptyMsg.textContent = "No unanswered questions. Anything on your mind?";
        forumPosts.appendChild(emptyMsg);
        return;
      }

      const currentUserId = window.currentUser ? window.currentUser.uid : null;

      // Build cards asynchronously but maintain order
      const cardPromises = snapshot.docs.map(async (doc, index) => {
        const data = doc.data();
        const card = document.createElement('div');
        card.classList.add('forum-card');
        card.dataset.id = doc.id;

        // Check if post has any comments
        let hasComments = false;
        try {
          const commentsSnap = await db.collection("forum-questions").doc(doc.id).collection("comments").limit(1).get();
          hasComments = !commentsSnap.empty;
        } catch (err) {
          console.error("Error checking comments for post:", doc.id, err);
        }

        const showResolveButton = !data.solved && hasComments && currentUserId;
        
        // Format time
        let timeText = "Just now";
        if (data.timestamp && data.timestamp.toDate) {
          const date = data.timestamp.toDate();
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          if (diffMins < 1) timeText = "Just now";
          else if (diffMins < 60) timeText = `${diffMins}m ago`;
          else if (diffHours < 24) timeText = `${diffHours}h ago`;
          else timeText = `${diffDays}d ago`;
        }

        // Get comment count
        let commentCount = 0;
        try {
          const commentsSnap = await db.collection("forum-questions").doc(doc.id).collection("comments").get();
          commentCount = commentsSnap.size;
        } catch (err) {
          console.error("Error getting comment count:", err);
        }

        card.innerHTML = `
          <div class="forum-post-header">
            <div class="forum-post-avatar">${data.userName ? data.userName[0].toUpperCase() : "U"}</div>
            <div class="forum-post-user">
              <p class="forum-post-username">User '${data.userName || "Anonymous"}'</p>
              <p class="forum-post-title">${data.question || "Ask a question..."}</p>
            </div>
          </div>
          <p class="forum-post-content">${data.helpType ? `<strong>Type:</strong> ${data.helpType}<br>` : ''}${data.question || ""}</p>
          <div class="forum-post-footer">
            <span class="forum-post-badge replies">${commentCount} ${commentCount === 1 ? 'reply' : 'replies'}</span>
            <span class="forum-post-badge time">${timeText}</span>
            ${showResolveButton ? `<button class="resolve-btn" data-id="${doc.id}">Resolve</button>` : ""}
          </div>
        `;
        
        return { card, index };
      });

      // Wait for all cards to be built, then append in order
      const cardResults = await Promise.all(cardPromises);
      // Sort by index to maintain query order (most recent first)
      cardResults.sort((a, b) => a.index - b.index);
      // Append cards in order
      cardResults.forEach(({ card }) => {
        forumPosts.appendChild(card);
      });
    }

    // --------- DELEGATED EVENT HANDLER FOR CARDS & RESOLVE BUTTONS ---------
    const forumPosts = document.getElementById('forumPosts');

    if (forumPosts) {
      forumPosts.addEventListener('click', async (e) => {
      // Resolve button click
      if (e.target.classList.contains('resolve-btn')) {
        e.stopPropagation();
        const postId = e.target.dataset.id;
        if (!postId) return;

        try {
          await db.collection("forum-questions").doc(postId).update({ solved: true });
          await loadForumQuestions(currentFilter);
          await updatePostCount();
          await updateSolvedPercentage();
          await updateMedianResponseTime();
          if (currentCardId === postId) toggleCommentPanel();
          showNotification("Post marked as resolved!");
        } catch (error) {
          alert("Failed to update post status: " + error.message);
        }
      }
      // Card click except on resolve button
      else if (e.target.closest('.forum-card') && !e.target.classList.contains('resolve-btn')) {
        const card = e.target.closest('.forum-card');
        currentCardId = card.dataset.id || "demo";
        toggleCommentPanel();
        loadComments(currentCardId);
      }
      });
    }

    function showNotification(message) {
      console.log("showNotification called with message:", message);
      const modal = document.getElementById("notificationModal");
      const textElem = modal.querySelector("p");
      textElem.textContent = message;
      modal.classList.remove("hidden");

      setTimeout(() => {
        modal.classList.add("hidden");
      }, 3000);
    }

    // --------- UPDATE POST COUNT ---------
    async function updatePostCount() {
      try {
        const snapshot = await db.collection("forum-questions").get();
        const count = snapshot.size;
        const countEl = document.querySelector(".posts-count");
        if (countEl) countEl.textContent = count.toLocaleString();
        console.log("[CQ] Post count updated:", count);
      } catch (error) {
        console.error("[CQ] Failed to update post count:", error);
      }
    }

    // --------- UPDATE MEMBER COUNT ---------
    async function updateMemberCount() {
      try {
        const statsRef = db.collection('stats').doc('membersCount');
        const doc = await statsRef.get();
        const count = doc.exists ? doc.data().count || 0 : 0;
        const countEl = document.querySelector(".members-count");
        if (countEl) countEl.textContent = count.toLocaleString();
        console.log("[CQ] Member count updated:", count);
      } catch (error) {
        console.error("[CQ] Failed to update member count:", error);
      }
    }

    // --------- UPDATE SOLVED PERCENTAGE ---------
    async function updateSolvedPercentage() {
      try {
        const totalSnap = await db.collection("forum-questions").get();
        const totalCount = totalSnap.size;
        if (totalCount === 0) {
          const elem = document.querySelector(".solved-percent");
          if (elem) elem.textContent = "0%";
          return;
        }
        const solvedSnap = await db.collection("forum-questions").where("solved", "==", true).get();
        const solvedCount = solvedSnap.size;
        const percent = Math.round((solvedCount / totalCount) * 100);
        const elem = document.querySelector(".solved-percent");
        if (elem) elem.textContent = `${percent}%`;
        console.log("[CQ] Solved percentage updated:", percent);
      } catch (error) {
        console.error("[CQ] Failed to update solved percentage:", error);
      }
    }

    // --------- UPDATE MEDIAN RESPONSE TIME ---------
    async function updateMedianResponseTime() {
      try {
        const postsSnapshot = await db.collection("forum-questions").get();
        const responseTimes = [];

        for (const postDoc of postsSnapshot.docs) {
          const postData = postDoc.data();
          const postTimestamp = postData.timestamp ? postData.timestamp.toDate().getTime() : null;
          if (!postTimestamp) continue;

          const commentsSnapshot = await db.collection("forum-questions")
            .doc(postDoc.id)
            .collection("comments")
            .orderBy("timestamp", "asc")
            .limit(1)
            .get();

          if (!commentsSnapshot.empty) {
            const firstComment = commentsSnapshot.docs[0].data();
            const commentTimestamp = firstComment.timestamp ? firstComment.timestamp.toDate().getTime() : null;
            if (commentTimestamp && commentTimestamp >= postTimestamp) {
              const diffMs = commentTimestamp - postTimestamp;
              const diffHours = diffMs / (1000 * 60 * 60);
              responseTimes.push(diffHours);
            }
          }
        }

        if (responseTimes.length === 0) {
          const responseTimeEl = document.querySelector(".response-time");
          if (responseTimeEl) responseTimeEl.textContent = "N/A";
          return;
        }

        responseTimes.sort((a, b) => a - b);
        let median;
        const mid = Math.floor(responseTimes.length / 2);
        if (responseTimes.length % 2 === 0) {
          median = (responseTimes[mid - 1] + responseTimes[mid]) / 2;
        } else {
          median = responseTimes[mid];
        }

        const responseTimeEl = document.querySelector(".response-time");
        if (responseTimeEl) {
          if (median < 1) {
            responseTimeEl.textContent = `${Math.round(median * 60)}m`;
          } else {
            responseTimeEl.textContent = `${median.toFixed(1)}h`;
          }
        }
        console.log("[CQ] Median response time updated:", median, "hours");

      } catch (error) {
        console.error("[CQ] Failed to update median response time:", error);
      }
    }

    // --------- NOTIFICATION PANEL TOGGLE ---------
    function toggleNotificationPanel() {
      const panel = document.getElementById("notificationPanel");
      if (!panel) return;
      
      // Close comment panel if open
      const commentPanel = document.getElementById("commentPanel");
      if (commentPanel && commentPanel.classList.contains("active")) {
        commentPanel.classList.remove("active");
        setTimeout(() => commentPanel.classList.add("hidden"), 300);
      }
      
      if (panel.classList.contains("active")) {
        panel.classList.remove("active");
        setTimeout(() => panel.classList.add("hidden"), 300);
      } else {
        panel.classList.remove("hidden");
        setTimeout(() => panel.classList.add("active"), 10);
      }
    }
    window.toggleNotificationPanel = toggleNotificationPanel;
    window.updateNotificationBadge = updateNotificationBadge;
    window.updateNotificationBadge = updateNotificationBadge;
    
    // --------- COMMENT PANEL TOGGLE ---------
    let currentCardId = null;
    function toggleCommentPanel() {
      const panel = document.getElementById("commentPanel");
      if (!panel) return;
      
      // Close notification panel if open
      const notificationPanel = document.getElementById("notificationPanel");
      if (notificationPanel && notificationPanel.classList.contains("active")) {
        notificationPanel.classList.remove("active");
        setTimeout(() => notificationPanel.classList.add("hidden"), 300);
      }
      
      if (panel.classList.contains("active")) {
        panel.classList.remove("active");
        setTimeout(() => panel.classList.add("hidden"), 300);
      } else {
        panel.classList.remove("hidden");
        setTimeout(() => panel.classList.add("active"), 10);
      }
    }
    window.toggleCommentPanel = toggleCommentPanel;

    // --------- LOAD COMMENTS FROM FIRESTORE ---------
    async function loadComments(postId) {
      const commentsThread = document.getElementById("commentsThread");
      commentsThread.innerHTML = "";

      try {
        const commentsSnapshot = await db.collection("forum-questions").doc(postId).collection("comments").orderBy("timestamp", "asc").get();
        if (commentsSnapshot.empty) {
          commentsThread.innerHTML = "<p>No comments yet. Be the first to comment!</p>";
          return;
        }
        commentsSnapshot.forEach(doc => {
          const data = doc.data();
          const commentDiv = document.createElement("div");
          commentDiv.classList.add("comment");
          commentDiv.innerHTML = `<strong>${data.name}</strong><p>${data.text}</p>`;
          commentsThread.appendChild(commentDiv);
        });
      } catch (error) {
        commentsThread.innerHTML = "<p>Failed to load comments.</p>";
        console.error("[CQ] Failed to load comments:", error);
      }
    }

    // --------- ADD COMMENT TO FIRESTORE ---------
    async function addComment(postId, comment) {
      try {
        await db.collection("forum-questions").doc(postId).collection("comments").add({
          name: comment.name,
          text: comment.text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Award 5 XP for commenting (if user is logged in)
        if (window.currentUser) {
          await awardXP(window.currentUser.uid, 5, 'commenting');
        }
        
      } catch (error) {
        console.error("[CQ] Failed to add comment:", error);
        throw error;
      }
    }

    // --------- COMMENT BOX SEND ON CTRL+ENTER OR SUBMIT BUTTON ---------
    const replyBox = document.getElementById("commentReplyBox");
    const submitBtn = document.getElementById("commentSubmitBtn");
    
    async function submitComment() {
      if (!currentCardId || !replyBox) return;
      const commentText = replyBox.value.trim();
      if (!commentText) return;
      
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";
        await addComment(currentCardId, { name: "You", text: commentText });
        replyBox.value = "";
        await loadComments(currentCardId);
        submitBtn.textContent = "Submit";
        submitBtn.disabled = false;
      } catch (error) {
        alert("Failed to post comment.");
        submitBtn.textContent = "Submit";
        submitBtn.disabled = false;
      }
    }
    
    if (replyBox) {
      replyBox.addEventListener("keydown", async (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          e.preventDefault();
          await submitComment();
        }
      });
    }
    
    if (submitBtn) {
      submitBtn.addEventListener("click", submitComment);
    }

    // --------- TAB SWITCHING ---------
    const forumTabs = document.querySelectorAll('.forum-tab');

    function selectTab(selectedTab) {
      forumTabs.forEach(tab => tab.classList.remove('active'));
      selectedTab.classList.add('active');
      const filter = selectedTab.dataset.filter || selectedTab.textContent.trim().toLowerCase();
      loadForumQuestions(filter);
    }
    window.selectTab = selectTab;

    forumTabs.forEach(tab => {
      tab.addEventListener('click', () => selectTab(tab));
    });

    // --------- EXPOSE FOR DEBUGGING ---------
    window.loadForumQuestions = loadForumQuestions;
    window.currentFilter = currentFilter;
    window.updatePostCount = updatePostCount;
    window.updateMemberCount = updateMemberCount;
    window.updateSolvedPercentage = updateSolvedPercentage;
    window.updateMedianResponseTime = updateMedianResponseTime;
    window.awardXP = awardXP; // Expose for debugging

    // ========== ASSIGNMENT MODAL FUNCTIONS ==========
  // Add this to your JavaScript file

  window.openFullAssignmentModal = function(assignment) {
  console.log("🎯 openFullAssignmentModal called");
  
  if (!assignment) {
    console.error("❌ No assignment data!");
    return;
  }

  const modal = document.getElementById('cq-assignment-modal');
  
  // Force show with 'block' not 'flex' - this is critical!
  modal.style.display = 'block';
  modal.style.visibility = 'visible';
  modal.style.opacity = '1';
  
  const content = modal.querySelector('.cq-modal-content');
  content.style.setProperty('display', 'flex', 'important');
  content.style.setProperty('visibility', 'visible', 'important');
  content.style.setProperty('opacity', '1', 'important');

  // Set title
  const titleElement = document.getElementById('cq-assignment-title');
  if (titleElement) {
    titleElement.innerText = assignment.title || "New Assignment";
    titleElement.style.setProperty('display', 'block', 'important');
    titleElement.style.setProperty('visibility', 'visible', 'important');
    titleElement.style.setProperty('opacity', '1', 'important');
    titleElement.style.setProperty('color', '#ff9c42', 'important');
  }

  // Show info section
  const infoSection = document.getElementById('cq-assignment-info');
  if (infoSection) {
    infoSection.style.setProperty('display', 'block', 'important');
    infoSection.style.setProperty('visibility', 'visible', 'important');
    infoSection.style.setProperty('opacity', '1', 'important');
  }

  // Hide quiz section
  const quizSection = document.getElementById('cq-assignment-quiz');
  if (quizSection) {
    quizSection.style.setProperty('display', 'none', 'important');
  }

  // Fill fields
  const fieldsElement = document.getElementById('cq-assignment-fields');
  if (fieldsElement) {
    fieldsElement.innerHTML = `
      <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
      <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
      <div><b>Questions:</b> ${assignment.questions || 'n/a'}</div>
      <div><b>Difficulty:</b> ${assignment.difficulty || 'n/a'}</div>
      <div><b>Simulate:</b> ${assignment.simulate ? 'Yes' : 'No'}</div>
    `;
    fieldsElement.style.setProperty('display', 'block', 'important');
    fieldsElement.style.setProperty('visibility', 'visible', 'important');
    fieldsElement.style.setProperty('opacity', '1', 'important');
  }

  // Show footer and buttons
  const footer = modal.querySelector('.cq-modal-footer');
  if (footer) {
    footer.style.setProperty('display', 'flex', 'important');
    footer.style.setProperty('visibility', 'visible', 'important');
    footer.style.setProperty('opacity', '1', 'important');
  }

  // Show all buttons
  modal.querySelectorAll('.cq-modal-btn').forEach(btn => {
    btn.style.setProperty('display', 'block', 'important');
    btn.style.setProperty('visibility', 'visible', 'important');
    btn.style.setProperty('opacity', '1', 'important');
  });

  console.log("✅ Modal visible");
};

window.closeAssignmentModal = function() {
  console.log("❌ Closing assignment modal");
  const modal = document.getElementById('cq-assignment-modal');
  if (modal) {
    modal.style.display = 'none';
  }
};

window.snoozeAssignment = function() {
  console.log("⏰ Snoozing assignment");
  window.closeAssignmentModal();
};

window.snoozeAssignment = function() {
  window.closeAssignmentModal();
}; // ========== STATE ==========
    let writtenQuestions = [];
    let currentQuestionIndex = 0;
    let writtenAnswers = {};
    let writtenTimer = null;
    let writtenTimeRemaining = 0;

    async function acceptAssignmentNow() {
  console.log("\n🚀 ACCEPT ASSIGNMENT NOW\n");
  
  // ✅ CLOSE MODAL IMMEDIATELY
  const modal = document.getElementById('cq-assignment-modal');
  if (modal) {
    modal.style.display = 'none';
  }
  
  showLoader();

  const assignment = window.currentAssignment;
  
  if (!assignment) {
    console.error("❌ No assignment");
    hideLoader();
    return;
  }

  console.log("📋 Assignment type:", assignment.type);

  try {
    // Mark as seen
    if (window.latestAssignmentId) {
      const updateData = {
        status: "seen",
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (assignment.type === 'written') {
        updateData.score = 0;
        updateData.maxScore = assignment.writtenQuestions?.length || 10;
      }

      try {
        await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
        console.log("✅ Assignment marked as seen");
      } catch (error) {
        console.error("❌ Error marking as seen:", error);
      }
    }

    // Handle speaking/case
    if (assignment.type === 'speaking' || assignment.type === 'case') {
      console.log("🎤 Speaking/case assignment");
      hideLoader();
      openCameraModal();
      return;
    }

    // Handle written
    if (assignment.type === 'written') {
      console.log("✍️ Written assignment");
      console.log("⏳ CIRCULAR PROGRESS LOADER VISIBLE");

      const competencies = assignment.competencies;
      const questionCount = assignment.totalQuestions || 10;
      const difficulty = assignment.difficulty || 'medium';

      if (!competencies || competencies.length === 0) {
        console.warn("⚠️ No competencies");
        hideLoader();
        return;
      }

      // FETCH COMPETITION ID FROM FIREBASE
      console.log("📊 Fetching competition ID from Firebase...");
      let competitionId = assignment.competitionId 
        || window.currentCompetition?.id 
        || window.competitionId 
        || window.currentUser?.competitions?.[0];

      if (!competitionId) {
        try {
          const userId = firebase.auth().currentUser?.uid;
          if (userId) {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists && userDoc.data().competitions?.[0]) {
              competitionId = userDoc.data().competitions[0];
              console.log("✅ Fetched competition from Firebase:", competitionId);
            }
          }
        } catch (err) {
          console.warn("⚠️ Could not fetch competition from Firebase:", err);
        }
      }

      console.log("🎯 Competition ID:", competitionId);

      // FETCH BASELINE
      console.log("📊 Fetching baseline...");
      let baselineText = "";

      if (competitionId) {
        try {
          const competitionDoc = await db.collection('competitions').doc(competitionId).get();
          if (competitionDoc.exists) {
            const baseline = competitionDoc.data().baseline || {};
            if (baseline.text) {
              baselineText = baseline.text;
              console.log("✅ Baseline fetched:", baselineText.length, "characters");
            }
          }
        } catch (err) {
          console.warn("⚠️ Baseline fetch failed");
        }
      } else {
        console.log("⚠️ No competition ID, skipping baseline");
      }

      // FETCH GPT CONTEXT
      console.log("🤖 Fetching GPT context...");
      let gptContextData = {};

      try {
        const userId = firebase.auth().currentUser?.uid;
        if (userId) {
          const userTrainingDoc = await db.collection('userTraining').doc(userId).get();
          if (userTrainingDoc.exists && userTrainingDoc.data().gptTrainingContext) {
            gptContextData = userTrainingDoc.data().gptTrainingContext;
            console.log("✅ GPT context fetched");
          }
        }
      } catch (err) {
        console.warn("⚠️ GPT context fetch failed");
      }

      // BUILD CONTEXT STRING - Let GPT filter intelligently
      console.log("🧠 Building context with full baseline + training data...");
      let contextString = "";
      
      if (baselineText) {
        contextString += "=== COMPETITION BASELINE STUDY MATERIAL ===\n";
        contextString += "Use the following baseline material to generate questions focused on: " + competencies.join(", ") + "\n";
        contextString += "Filter and extract the most relevant information for the specified competencies.\n\n";
        contextString += baselineText + "\n\n";
      }
      
      if (gptContextData.content) {
        contextString += "=== USER BACKGROUND AND TRAINING CONTEXT ===\n";
        contextString += "Consider the user's background when generating questions:\n";
        contextString += gptContextData.content;
      }
      
      window.__CERTQUEST_CONTEXT__ = contextString;
      console.log("✅ Context ready:", contextString.length, "chars");
      console.log("📚 Competencies to focus on:", competencies);

      // GENERATE QUESTIONS
      console.log("🧠 Generating questions WITH FULL BASELINE + TRAINING DATA...");
      console.log("⏳ LOADER PROGRESS BAR VISIBLE & ANIMATING");
      
      const questions = await generatePersonalizedQuestionsWithGPT({
        competencies,
        time: 15,
        difficulty,
        questionCount
      });

      console.log("✅ Generated", questions.length, "questions");

      // UPDATE ASSIGNMENT
      const updatedAssignment = {
        ...assignment,
        generatedQuestions: questions,
        baselineText,
        gptContext: gptContextData
      };

      window.currentAssignment = updatedAssignment;
      window.writtenQuestions = questions;

      console.log("📦 Opening written practice modal...");

      // OPEN WRITTEN PRACTICE MODAL
      await openWrittenPracticeModal(updatedAssignment);
    }

  } catch (error) {
    console.error("❌ Error:", error);
    hideLoader();
  }
}


/**
 * Gathers baseline data for competencies from the competitions collection
 */
async function gatherBaselineData(competitionId, competencies) {
  try {
    if (!competitionId) {
      console.warn("⚠️ No competition ID provided");
      return {};
    }

    const competitionDoc = await db
      .collection('competitions')
      .doc(competitionId)
      .get();

    if (!competitionDoc.exists) {
      console.warn("⚠️ Competition not found:", competitionId);
      return {};
    }

    const competitionData = competitionDoc.data();
    console.log("📄 Full competition data structure:", competitionData);
    console.log("📄 Baseline field:", competitionData.baseline);

    const baseline = {};

    // Extract baseline for each competency from competition.baseline
    competencies.forEach(competencyId => {
      const competencyBaseline = competitionData.baseline?.[competencyId];

      if (competencyBaseline) {
        baseline[competencyId] = competencyBaseline;
        console.log(`✅ Found baseline for ${competencyId}:`, competencyBaseline);
      } else {
        console.log(`⚠️ No baseline found for competency: ${competencyId}`);
      }
    });

    console.log("📊 Final baseline object:", baseline);
    return baseline;
  } catch (error) {
    console.error("❌ Error gathering baseline data:", error);
    return {};
  }
}


// Circular progress loader state
    let progressInterval = null;
    let currentProgress = 0;

    function updateCircularProgress(progress) {
      const fill = document.getElementById('circularProgressFill');
      const text = document.getElementById('circularProgressText');
      
      if (fill && text) {
        const circumference = 2 * Math.PI * 45;
        const offset = circumference - (progress / 100) * circumference;
        fill.style.strokeDashoffset = offset;
        text.textContent = Math.round(progress) + '%';
      }
    }

    function startCircularProgress() {
      currentProgress = 0;
      updateCircularProgress(0);
      
      progressInterval = setInterval(() => {
        currentProgress += 2;
        if (currentProgress > 95) {
          currentProgress = 95;
        }
        updateCircularProgress(currentProgress);
      }, 100);
    }

    function completeCircularProgress() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      updateCircularProgress(100);
    }

    function stopCircularProgress() {
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      currentProgress = 0;
    }

    function showLoader() {
      const loader = document.getElementById("assignmentLoader");
      if (loader) {
        loader.style.display = "flex";
        startCircularProgress();
      }
    }

    function hideLoader() {
      completeCircularProgress();
      setTimeout(() => {
        stopCircularProgress();
        const loader = document.getElementById("assignmentLoader");
        if (loader) {
          loader.style.display = "none";
        }
      }, 300);
    }

    function getQuestionCount(timeStr) {
      if (!timeStr) return 5;
      const normalized = timeStr.toString().toLowerCase();
      if (normalized.includes("15")) return 10;
      if (normalized.includes("10")) return 7;
      if (normalized.includes("5")) return 5;
      return 5;
    }

    async function generatePersonalizedQuestionsWithGPT(formData) {
      const questionCount = getQuestionCount(formData.time);
      const competenciesText = formData.competencies.join(', ');

      let prompt = `Generate ${questionCount} FBLA-style multiple choice questions.
- Difficulty: ${formData.difficulty}
- Competencies to cover: ${competenciesText}
- Each question must have exactly 4 options and 1 correct answer
- Questions must be standalone, realistic for FBLA, and never reference "the document", "the text", "as stated", etc.
- Use business, finance, marketing, management, economics, law, and related topics depending on the competencies.`

      prompt += `\n\nReturn ONLY valid JSON array in format:
[
  {
    "text": "Question text?",
    "competency": "Marketing",
    "correctAnswer": "Correct option text",
    "options": ["A", "B", "C", "D"],
    "difficulty": "${formData.difficulty}",
    "source": "gpt_generated"
  }
]`;

      try {
        const response = await firebase.functions().httpsCallable("generateQuestionsWithAI")({
          messages: [
            { role: "system", content: `You are an expert FBLA written-competition exam designer.

Your role is to generate ORIGINAL, competition-accurate FBLA-style multiple-choice questions that match the structure, rigor, tone, and professional standards of official FBLA written tests.

You must follow ALL rules below.

────────────────────────────────
CORE FBLA PHILOSOPHY
────────────────────────────────
FBLA written tests assess professional correctness, precision, and applied business literacy.

They do NOT assess creativity, opinion, or open-ended reasoning.

Each question must test exactly ONE concept.

Questions must be concise, objective, and professionally worded.

Avoid unnecessary narrative unless the question type explicitly requires a scenario.

────────────────────────────────
APPROVED FBLA QUESTION ARCHETYPES
────────────────────────────────
Every question MUST clearly belong to ONE of the following archetypes:

1. Definition / Term Identification  
   - Identifying the correct term based on a definition  
   - Selecting the correct meaning of a professional word or concept  

2. Classification / Category Recognition  
   - Determining where an item belongs within a professional category system  
   - Examples include document types, account categories, system types, business forms, or classifications  

3. Procedural / Workflow Knowledge  
   - Understanding the stages of a professional workflow specific to the competition area  
   - Identifying where information originates within that workflow  
   - Determining which document, tool, or action is appropriate at a given stage  
   - Recognizing correct sequencing of professional tasks within the domain  

4. Tool-to-Function Matching  
   - Matching software features, commands, utilities, or tools to their correct purpose  
   - Selecting the correct function used to accomplish a professional task  

5. Quantitative / Calculation Application  
   - Performing single-step or limited multi-step calculations  
   - Selecting the correct numeric result based on provided data  
   - Avoid unnecessary complexity or advanced math  

6. Language Precision & Usage  
   - Correct use of professional vocabulary  
   - Distinguishing homophones, word meanings, spelling, grammar, and standard usage  

7. Error Detection / Exception Identification  
   - Identifying what is incorrect, misspelled, or does NOT belong  
   - Using negation ("NOT") carefully and intentionally  

────────────────────────────────
QUESTION STRUCTURE RULES
────────────────────────────────
• Each question must assess ONE idea only.  
• Do not combine multiple concepts in one question.  
• Avoid ambiguous wording.  
• Use professional, neutral language.

Acceptable stem styles include:
- "Which of the following…"
- "What term best describes…"
- "The document used to…"
- "Which action should be taken…"
- "Which of the following is NOT…"

────────────────────────────────
ANSWER CHOICE DESIGN (CRITICAL)
────────────────────────────────
Each question MUST include exactly FOUR answer choices.

Answer choices must:
• Be the same grammatical form  
• Be similar in length  
• Belong to the same conceptual family  

Wrong answer choices (distractors) must be plausible and realistic.

Allowed distractor strategies include:
• Closely related terms within the same category  
• Common student misconceptions  
• Incorrect step within a workflow  
• Reversed or misapplied professional rules  
• Visually or linguistically similar words  
• Typical calculation or classification errors  

Never include joke answers or obviously incorrect options.

────────────────────────────────
DIFFICULTY CALIBRATION
────────────────────────────────
Easy:
• Direct recall or recognition  
• Minimal traps  

Medium:
• Requires discrimination between similar concepts  
• Includes common misconceptions  

Hard:
• Includes negation ("NOT")  
• Requires precise rule awareness  
• Uses subtle wording differences  
• Penalizes shallow memorization  

────────────────────────────────
CONTENT INTEGRITY RULES
────────────────────────────────
• All questions must be ORIGINAL.  
• Do NOT copy real FBLA questions.  
• Do NOT closely paraphrase known questions.  
• Use authentic structure only, not replicated wording.

Questions must feel realistic for competitive FBLA written events at the regional, state, or national level.

When study materials are provided, extract concepts, facts, names, dates, laws, and details from them. Present this information as established business knowledge. NEVER mention "the study guide", "the document", "the material", or use phrases like "according to", "as stated in", or "mentioned in".

────────────────────────────────
OUTPUT REQUIREMENTS
────────────────────────────────
• Generate ONLY the requested number of questions.  
• Each question must have exactly four answer options.  
• Only ONE option may be correct.  
• Output valid JSON only.  
• Do not include explanations, commentary, or headings.  

You are writing as a professional exam author — not as a tutor or teacher.` },
            { role: "user", content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt }
          ]
        });

        const data = response.data;
        let content = data.content || data.choices?.[0]?.message?.content || data;
        
        if (typeof content !== 'string') {
          content = JSON.stringify(content);
        }
        
        content = content.trim();
        content = content.replace(/```json|```/g, "");
        const jsonStart = content.indexOf('[');
        const jsonEnd = content.lastIndexOf(']') + 1;
        
        if (jsonStart !== -1 && jsonEnd > jsonStart) {
          content = content.slice(jsonStart, jsonEnd);
        }
        
        const generated = JSON.parse(content);
        console.log(`✅ Generated ${generated.length} GPT questions`);
        return generated;

      } catch (err) {
        console.error("❌ GPT error:", err);
        return getFallbackQuestions(questionCount, formData.competencies);
      }
    }

    function getFallbackQuestions(count, competencies) {
      const fallbackQuestions = [
        {
          text: "What is the primary purpose of parliamentary procedure?",
          competency: "Parliamentary Procedure",
          correctAnswer: "To make meetings more efficient",
          options: [
            "To make meetings more efficient",
            "To give the president more power",
            "To eliminate debate",
            "To make meetings longer"
          ]
        },
        {
          text: "Which motion is used to end a meeting?",
          competency: "Parliamentary Procedure",
          correctAnswer: "Adjourn",
          options: ["Adjourn", "Recess", "Postpone", "Table"]
        },
        {
          text: "What is the most effective way to communicate in business?",
          competency: "Business Communication",
          correctAnswer: "Clear and concise messaging",
          options: [
            "Clear and concise messaging",
            "Using complex terminology",
            "Lengthy detailed explanations",
            "Informal casual language"
          ]
        }
      ];
      
      const result = [];
      for (let i = 0; i < count; i++) {
        result.push(fallbackQuestions[i % fallbackQuestions.length]);
      }
      return result;
    }

    async function openWrittenPracticeModal(assignment) {
  console.log("Opening written practice modal with assignment:", assignment);

  try {
    currentQuestionIndex = 0;
    writtenAnswers = {};
    if (!window.writtenAnswers) {
      window.writtenAnswers = {};
    }

    const timeInMinutes = parseInt(assignment.time) || 15;
    writtenTimeRemaining = timeInMinutes * 60;

    // Use preloaded questions or generate new ones
    if (assignment.writtenQuestions && assignment.writtenQuestions.length > 0) {
      console.log("✅ Using preloaded questions");
      writtenQuestions = assignment.writtenQuestions;
      window.writtenQuestions = assignment.writtenQuestions;
    } else {
      console.log("⚡ Generating questions via GPT...");
      assignment.writtenQuestions = await generatePersonalizedQuestionsWithGPT({
        time: assignment.time || "15 mins",
        difficulty: assignment.difficulty || "Medium",
        competencies: assignment.competencies || ["General"]
      });
      writtenQuestions = assignment.writtenQuestions;
      window.writtenQuestions = assignment.writtenQuestions;
    }

    console.log("✅ Written questions ready:", writtenQuestions);

    // Show modal and start quiz
    const modal = document.getElementById('quizModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    createQuizStars();
    loadWrittenQuestion();
    startWrittenTimer();

  } catch (err) {
    console.error("❌ Error in openWrittenPracticeModal:", err);
    alert("Could not load written practice. Please try again.");
  } finally {
    hideLoader(); // ✅ ALWAYS hide loader at the end
    console.log("🛑 Loader hidden");
  }
}

    function loadWrittenQuestion() {
      // Use window.writtenQuestions if available (for "create your own"), otherwise use local writtenQuestions
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      const question = questions[currentQuestionIndex];
      if (!question) {
        console.error("No question found at index", currentQuestionIndex);
        return;
      }
      
      console.log("Loading question", currentQuestionIndex + 1, ":", question.question || question.text);
      
      const assignmentTitle = window.currentAssignment?.title || 'Written Practice';
      const difficulty = window.currentAssignment?.difficulty || 'Easy';
      document.getElementById('quizTitle').textContent = `${difficulty} ${assignmentTitle}`;
      document.getElementById('quizProgress').textContent = 
        `Question ${currentQuestionIndex + 1} of ${questions.length}`;
      
      document.getElementById('questionCompetency').textContent = question.competency || 'General';
      const questionTextEl = document.getElementById('questionText');
      questionTextEl.textContent = question.question || question.text;
      questionTextEl.style.color = '#fff';
      
      const optionsContainer = document.getElementById('optionsContainer');
      const answers = window.writtenAnswers || writtenAnswers;
      const previousAnswer = answers[currentQuestionIndex];
      
      optionsContainer.innerHTML = question.options.map((option, index) => {
        const isSelected = previousAnswer === option;
        return `
          <button class="practice-quiz-option-btn ${isSelected ? 'selected' : ''}" data-option="${option}">
            <div class="practice-quiz-option-radio ${isSelected ? 'selected' : ''}">
              ${isSelected ? '<div class="practice-quiz-option-dot"></div>' : ''}
            </div>
            <span class="practice-quiz-option-text">${option}</span>
          </button>
        `;
      }).join('');
      
      const options = optionsContainer.querySelectorAll('.practice-quiz-option-btn');
      options.forEach(optionBtn => {
        optionBtn.addEventListener('click', function(e) {
          options.forEach(opt => {
            opt.classList.remove("selected");
            const radio = opt.querySelector('.practice-quiz-option-radio');
            radio.classList.remove("selected");
            radio.innerHTML = '';
          });
          
          this.classList.add('selected');
          const radio = this.querySelector('.practice-quiz-option-radio');
          radio.classList.add('selected');
          radio.innerHTML = '<div class="practice-quiz-option-dot"></div>';
          
          // Save to both window.writtenAnswers and local writtenAnswers
          if (window.writtenAnswers) {
            window.writtenAnswers[currentQuestionIndex] = this.dataset.option;
          } else {
            writtenAnswers[currentQuestionIndex] = this.dataset.option;
          }
          console.log("Answer saved:", currentQuestionIndex, "->", this.dataset.option);
        });
      });
      
      updateWrittenProgress();
      updateWrittenNavButtons();
    }

    function updateWrittenProgress() {
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
      document.getElementById('progressFill').style.width = `${progress}%`;
      document.getElementById('progressPercent').textContent = Math.round(progress);
    }

    function updateWrittenNavButtons() {
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const submitBtn = document.getElementById('submitBtn');
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      
      prevBtn.disabled = currentQuestionIndex === 0;
      
      if (currentQuestionIndex === questions.length - 1) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'block';
      } else {
        nextBtn.style.display = 'block';
        submitBtn.style.display = 'none';
      }
    }

    function previousQuestion() {
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadWrittenQuestion();
      }
    }

    function nextQuestion() {
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        loadWrittenQuestion();
      }
    }

    function startWrittenTimer() {
      clearInterval(writtenTimer);
      
      console.log("Starting timer with", writtenTimeRemaining, "seconds");
      updateTimerDisplay();
      
      writtenTimer = setInterval(() => {
        writtenTimeRemaining--;
        updateTimerDisplay();
        
        if (writtenTimeRemaining <= 0) {
          console.log("Time's up! Auto-submitting...");
          clearInterval(writtenTimer);
          submitQuiz();
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      const minutes = Math.floor(writtenTimeRemaining / 60);
      const seconds = writtenTimeRemaining % 60;
      const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      
      const timerElement = document.getElementById('quizTimer');
      if (timerElement) {
        timerElement.textContent = timeString;
        
        if (writtenTimeRemaining <= 60) {
          timerElement.style.color = '#ef4444';
        } else if (writtenTimeRemaining <= 300) {
          timerElement.style.color = '#f97316';
        } else {
          timerElement.style.color = '#fb923c';
        }
      }
    }

    function createQuizStars() {
      const starsContainer = document.getElementById('quizStarsContainer');
      if (!starsContainer) return;
      
      starsContainer.innerHTML = '';
      
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'practice-quiz-star';
        
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.9 + 0.3;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
        star.style.animationDelay = delay + 's';
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
        
        starsContainer.appendChild(star);
      }
    }

    function closeQuizModal() {
      const modal = document.getElementById('quizModal');
      if (modal) {
        modal.style.display = 'none';
      }
      document.body.style.overflow = 'auto';
      clearInterval(writtenTimer);
      writtenQuestions = [];
      currentQuestionIndex = 0;
      writtenAnswers = {};
      writtenTimeRemaining = 0;
      writtenTimer = null;
    }

    async function submitQuiz() {
      // Check if this is a written practice assignment
      const hasWrittenQuestions = (window.writtenQuestions && window.writtenQuestions.length > 0) || 
                                  (writtenQuestions && writtenQuestions.length > 0);
      
      if (hasWrittenQuestions) {
        if (window.latestAssignmentId) {
          await submitWrittenPractice();
          return;
        } else {
          await submitWrittenPracticeForCreateYourOwn();
          return;
        }
      }
    }

    async function submitWrittenPractice() {
      try {
        console.log("=== SUBMITTING WRITTEN PRACTICE ===");
        clearInterval(writtenTimer);
        
        if (!window.latestAssignmentId) {
          console.error("❌ CRITICAL ERROR: No assignment ID found!");
          alert("Error: No assignment ID found. Cannot submit written practice.");
          closeQuizModal();
          return;
        }
        
        const questions = writtenQuestions;
        const answers = writtenAnswers;
        
        let score = 0;
        const competencyStats = {};
        const detailedAnswers = [];
        const totalQuestions = questions.length;
        
        questions.forEach((question, index) => {
          const userAnswer = answers[index];
          const correctAnswer = question.correctAnswer;
          const isCorrect = userAnswer === correctAnswer;
          
          if (isCorrect) score++;
          
          const competency = question.competency;
          if (!competencyStats[competency]) {
            competencyStats[competency] = { total: 0, correct: 0 };
          }
          competencyStats[competency].total++;
          if (isCorrect) competencyStats[competency].correct++;
          
          detailedAnswers.push({
            questionIndex: index,
            question: question.question || question.text,
            competency: competency,
            userAnswer: userAnswer || "No answer",
            correctAnswer: correctAnswer,
            isCorrect: isCorrect
          });
        });
        
        const originalTime = parseInt(window.currentAssignment?.time) * 60 || 900;
        const timeSpent = originalTime - writtenTimeRemaining;
        const percentage = Math.round((score / totalQuestions) * 100);
        
        const updateData = {
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          score: score,
          totalQuestions: totalQuestions,
          maxScore: totalQuestions,
          competencyStats: competencyStats,
          timeSpent: timeSpent,
          detailedAnswers: detailedAnswers,
          competencies: Object.keys(competencyStats),
          correctCompetencies: Object.entries(competencyStats)
            .filter(([_, stats]) => stats.correct === stats.total)
            .map(([comp, _]) => comp),
          percentage: percentage,
          submittedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
        console.log("✅ Assignment updated successfully");
        
        const resultsData = {
          message: `Excellent work! You scored ${score}/${totalQuestions}`,
          assignmentName: window.currentAssignment?.title || 'Written Practice',
          competencyStats: competencyStats,
          score: score,
          totalQuestions: totalQuestions,
          percentage: percentage,
          timeSpent: timeSpent
        };
        
        closeQuizModal();
        
        showCongratsModal(resultsData);
        
        window.latestAssignmentId = null;
        window.currentAssignment = null;
        
      } catch (error) {
        console.error("❌ Written practice submission error:", error);
        alert("Failed to submit practice: " + error.message);
      }
    }

    async function submitWrittenPracticeForCreateYourOwn() {
      try {
        console.log("=== SUBMITTING CREATE YOUR OWN WRITTEN PRACTICE ===");
        clearInterval(writtenTimer);
        
        const questions = window.writtenQuestions || writtenQuestions;
        const answers = window.writtenAnswers || writtenAnswers;
        
        if (!questions || questions.length === 0) {
          console.error("❌ CRITICAL ERROR: No questions found!");
          alert("Error: No questions found. Cannot submit written practice.");
          closeQuizModal();
          return;
        }
        
        let score = 0;
        const competencyStats = {};
        const detailedAnswers = [];
        const totalQuestions = questions.length;
        
        questions.forEach((question, index) => {
          const userAnswer = answers[index];
          const correctAnswer = question.correctAnswer;
          const isCorrect = userAnswer === correctAnswer;
          
          if (isCorrect) score++;
          
          const competency = question.competency;
          if (!competencyStats[competency]) {
            competencyStats[competency] = { total: 0, correct: 0 };
          }
          competencyStats[competency].total++;
          if (isCorrect) competencyStats[competency].correct++;
          
          detailedAnswers.push({
            questionIndex: index,
            question: question.question || question.text,
            competency: competency,
            userAnswer: userAnswer || "No answer",
            correctAnswer: correctAnswer,
            isCorrect: isCorrect
          });
        });
        
        const timeStr = document.getElementById('quizTitle')?.textContent?.match(/\d+/)?.[0] || '15';
        const originalTime = parseInt(timeStr) * 60 || 900;
        const timeSpent = originalTime - writtenTimeRemaining;
        const percentage = Math.round((score / totalQuestions) * 100);
        
        const resultsData = {
          message: `Excellent work! You scored ${score}/${totalQuestions}`,
          assignmentName: 'Written Practice',
          competencyStats: competencyStats,
          score: score,
          totalQuestions: totalQuestions,
          percentage: percentage,
          timeSpent: timeSpent
        };
        
        closeQuizModal();
        
        showCongratsModal(resultsData);
        
        window.writtenQuestions = null;
        window.writtenAnswers = null;
        
      } catch (error) {
        console.error("❌ Create your own written practice submission error:", error);
        alert("Failed to submit practice: " + error.message);
      }
    }

    function showCongratsModal(results) {
      const modal = document.getElementById('congratsModal');
      
      // Check if modal exists
      if (!modal) {
        // Fallback to alert if modal doesn't exist
        alert(results.message || `Congratulations! ${results.assignmentName || 'Assignment'} completed successfully!`);
        return;
      }
      
      // Handle case study assignments
      if (results.assignmentType === 'case') {
        const titleEl = document.getElementById('congratsTitle');
        const scoreEl = document.getElementById('congratsScore');
        const subtitleEl = document.getElementById('congratsSubtitle');
        const assignmentNameEl = document.getElementById('congratsAssignmentName');
        const competenciesContainer = document.getElementById('congratsCompetencies');
        
        if (titleEl) titleEl.textContent = 'Congratulations!';
        if (scoreEl) scoreEl.textContent = '';
        if (subtitleEl) subtitleEl.style.display = 'none'; // Hide the score line
        if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Case Study';
        
        // Display competencies from Firebase
        if (competenciesContainer) {
          if (results.competencies && results.competencies.length > 0) {
            competenciesContainer.innerHTML = results.competencies.map(comp => {
              return `
                <div class="congrats-competency-item">
                  <div class="congrats-competency-header">
                    <span class="congrats-competency-name">${comp}</span>
                  </div>
                </div>
              `;
            }).join('');
          } else {
            competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
          }
        }
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        createCongratsStars();
        return;
      }
      
      // Handle speaking assignments (simple message)
      if (results.assignmentType === 'speaking' || (results.message && !results.score && !results.totalQuestions)) {
        const titleEl = document.getElementById('congratsTitle');
        const scoreEl = document.getElementById('congratsScore');
        const subtitleEl = document.getElementById('congratsSubtitle');
        const assignmentNameEl = document.getElementById('congratsAssignmentName');
        const competenciesContainer = document.getElementById('congratsCompetencies');
        
        if (titleEl) titleEl.textContent = 'Congratulations!';
        if (scoreEl) scoreEl.textContent = '';
        if (subtitleEl) {
          subtitleEl.style.display = 'block';
          subtitleEl.innerHTML = results.message || 'Assignment submitted successfully!';
        }
        if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Assignment';
        
        // Display competencies if available
        if (competenciesContainer) {
          if (results.competencies && results.competencies.length > 0) {
            competenciesContainer.innerHTML = results.competencies.map(comp => {
              return `
                <div class="congrats-competency-item">
                  <div class="congrats-competency-header">
                    <span class="congrats-competency-name">${comp}</span>
                  </div>
                </div>
              `;
            }).join('');
          } else {
            competenciesContainer.innerHTML = '';
          }
        }
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        createCongratsStars();
        return;
      }
      
      // Handle written assignments (with scores)
      const percentage = results.percentage || (results.score && results.totalQuestions ? Math.round((results.score / results.totalQuestions) * 100) : 0);
      
      const titleEl = document.getElementById('congratsTitle');
      const scoreEl = document.getElementById('congratsScore');
      const subtitleEl = document.getElementById('congratsSubtitle');
      const assignmentNameEl = document.getElementById('congratsAssignmentName');
      const competenciesContainer = document.getElementById('congratsCompetencies');
      
      if (titleEl) titleEl.textContent = 'Congratulations!';
      if (scoreEl && results.score !== undefined && results.totalQuestions !== undefined) {
        scoreEl.textContent = `${results.score}/${results.totalQuestions}`;
      }
      if (subtitleEl) {
        subtitleEl.style.display = 'block'; // Reset display for other assignment types
        if (results.score !== undefined && results.totalQuestions !== undefined) {
          subtitleEl.innerHTML = 
            `Excellent work! You scored <span id="congratsScoreSpan" style="background: linear-gradient(to right, #ef4444, #f97316, #eab308); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; font-size: 1.75rem;">${results.score}/${results.totalQuestions}</span>`;
        } else if (results.message) {
          subtitleEl.innerHTML = results.message;
        }
      }
      
      if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Written Practice';
      
      if (competenciesContainer) {
        if (results.competencyStats && Object.keys(results.competencyStats).length > 0) {
          competenciesContainer.innerHTML = Object.entries(results.competencyStats).map(([comp, stats]) => {
            const percentage = Math.round((stats.correct / stats.total) * 100);
            const isFull = stats.correct === stats.total;
            return `
              <div class="congrats-competency-item">
                <div class="congrats-competency-header">
                  <span class="congrats-competency-name">${comp}</span>
                  <span class="congrats-competency-score">${stats.correct}/${stats.total} correct</span>
                </div>
                <div class="congrats-competency-progress-bar">
                  <div class="congrats-competency-progress-fill ${isFull ? 'full' : ''}" style="width: ${percentage}%"></div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
        }
      }
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      createCongratsStars();
    }

    function createCongratsStars() {
      const starsContainer = document.getElementById('congratsStarsContainer');
      if (!starsContainer) return;
      
      starsContainer.innerHTML = '';
      
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'practice-quiz-star';
        
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.9 + 0.3;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
        star.style.animationDelay = delay + 's';
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
        
        starsContainer.appendChild(star);
      }
    }

    function closeCongratsModal() {
      const modal = document.getElementById('congratsModal');
      if (modal) {
        modal.style.display = 'none';
      }
      document.body.style.overflow = 'auto';
    }

    function snoozeAssignment() {
      closeAssignmentModal();
    }

    // Speaking and Case Study Recording Variables
    let cqSpeakingMediaRecorder = null;
    let cqSpeakingMediaStream = null;
    let cqSpeakingRecordedChunks = [];
    let isRecording = false;
    let isIntentionallyStopping = false;
    let recordingStateMonitor = null;
    
    // Case Study variables
    let cqCaseStudyIsRecording = false;
    let cqCaseStudyIsIntentionallyStopping = false;
    let cqCaseStudyRecordingStateMonitor = null;
    let cqCaseStudyMediaRecorder = null;
    let cqCaseStudyMediaStream = null;
    let cqCaseStudyRecordedChunks = [];
    let cqCaseStudyTimerInterval = null;
    let cqCaseStudyTimeLeft = 1200; // 20 minutes in seconds
    let cqCaseStudyTimerActive = false;

    // Helper function to convert blob to base64
    function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function cqCaseStudyBlobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    // Complete Speaking Assignment Submission Function
    async function submitSpeakingResponse() {
      if (!window.latestAssignmentId || cqSpeakingRecordedChunks.length === 0) {
        alert("Recording not found or assignment ID missing.");
        return;
      }

      const submitBtn = document.getElementById('cq-speaking-submitBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      const blob = new Blob(cqSpeakingRecordedChunks, { type: 'video/webm' });
      const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

      const GITHUB_USERNAME = "Anjay209";
      const GITHUB_REPO = "video-storage";
      const GITHUB_TOKEN = "REDACTED_TOKEN"; // 🔐 Rotate in production

      let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
      let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

      try {
        const base64 = await blobToBase64(blob);

        const uploadRes = await fetch(githubApiUrl, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Upload ${filename}`,
            content: base64,
            branch: 'main'
          })
        });

        if (!uploadRes.ok) {
          const errData = await uploadRes.json().catch(() => ({}));
          const errorMessage = errData?.message || "GitHub upload failed";
          
          // Handle 409 Conflict - file already exists, try to update it
          if (uploadRes.status === 409) {
            console.log("File exists, attempting to update with SHA...");
            try {
              // Get the existing file's SHA
              const getRes = await fetch(githubApiUrl, {
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (getRes.ok) {
                const existingFile = await getRes.json();
                // Update with SHA
                const updateRes = await fetch(githubApiUrl, {
                  method: 'PUT',
                  headers: {
                    Authorization: `Bearer ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    message: `Update ${filename}`,
                    content: base64,
                    branch: 'main',
                    sha: existingFile.sha
                  })
                });
                
                if (!updateRes.ok) {
                  throw new Error("Failed to update existing file: " + (await updateRes.json().catch(() => ({}))).message);
                }
                console.log("Successfully updated existing file");
              } else {
                throw new Error("Could not get existing file info: " + errorMessage);
              }
            } catch (updateError) {
              // If update fails, use a unique filename
              console.log("Update failed, using unique filename...");
              const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
              const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
              const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
              
              const retryRes = await fetch(uniqueGithubApiUrl, {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Upload ${uniqueFilename}`,
                  content: base64,
                  branch: 'main'
                })
              });
              
              if (!retryRes.ok) {
                throw new Error("Failed to upload with unique filename: " + (await retryRes.json().catch(() => ({}))).message);
              }
              
              // Update the URL to use the unique filename
              githubPagesUrl = uniqueGithubPagesUrl;
              console.log("Successfully uploaded with unique filename");
            }
          } else {
            throw new Error(errorMessage);
          }
        }

        // Firestore update - setting status to "complete" in assignments collection
        await firebase.firestore()
          .collection('assignments')
          .doc(window.latestAssignmentId)
          .update({
            status: "complete",
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            recordingUrl: githubPagesUrl
          });

        // ✅ Also update user's assignments collection
        const user = firebase.auth().currentUser;
        const userId = user?.uid;
        const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
        
        if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
          console.log("Updating user assignments collection:", userId, assignmentId);
          try {
            await firebase.firestore()
              .collection('users')
              .doc(userId)
              .collection('assignments')
              .doc(assignmentId)
              .set({
                status: 'completed',
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                fileUrl: githubPagesUrl,
                fileType: 'video',
              }, { merge: true });
            console.log("Successfully updated user assignments collection");
          } catch (userAssignError) {
            console.warn("Could not update user assignments collection (non-critical):", userAssignError);
          }
        }

        // Fetch assignment data to get competencies
        let competencies = [];
        let assignmentName = 'Speaking Assessment';
        try {
          const assignmentDoc = await firebase.firestore()
            .collection('assignments')
            .doc(window.latestAssignmentId)
            .get();
          
          if (assignmentDoc.exists) {
            const assignmentData = assignmentDoc.data();
            competencies = assignmentData.competencies || [];
            assignmentName = assignmentData.title || 'Speaking Assessment';
          }
        } catch (error) {
          console.error("Error fetching assignment data:", error);
        }

        // Show success message and congrats modal
        showCongratsModal({ 
          score: undefined, 
          totalQuestions: undefined,
          assignmentName: assignmentName,
          competencies: competencies,
          assignmentType: 'speaking'
        });
        
        // Close modal
        closeSpeakingAssignmentModal();

      } catch (err) {
        console.error("Upload Error:", err);
        const errorMessage = err.message || "Something went wrong while uploading your recording.";
        
        if (errorMessage.includes("authentication") || errorMessage.includes("token") || errorMessage.includes("credentials")) {
          alert("❌ Authentication Error: " + errorMessage + "\n\nPlease contact the administrator to update the GitHub token.");
        } else if (errorMessage.includes("permission") || errorMessage.includes("not accessible") || errorMessage.includes("403")) {
          alert("❌ Permission Error: " + errorMessage);
        } else {
          alert("❌ Upload Error: " + errorMessage);
        }
        
        // Re-enable submit button on error
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Assessment';
        }
      }
    }

    // Complete Case Study Assignment Submission Function
    async function submitCaseStudyResponse() {
      if (!window.latestAssignmentId || cqCaseStudyRecordedChunks.length === 0) {
        alert("Recording not found or assignment ID missing.");
        return;
      }

      // Update submit button state
      const submitBtn = document.getElementById('cq-case-study-submitBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      const blob = new Blob(cqCaseStudyRecordedChunks, { type: 'video/webm' });
      const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

      const GITHUB_USERNAME = "Anjay209";
      const GITHUB_REPO = "video-storage";
      const GITHUB_TOKEN = "REDACTED_TOKEN";

      let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
      let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

      try {
        const base64 = await cqCaseStudyBlobToBase64(blob);

        const uploadRes = await fetch(githubApiUrl, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Upload ${filename}`,
            content: base64,
            branch: 'main'
          })
        });

        if (!uploadRes.ok) {
          const errData = await uploadRes.json().catch(() => ({}));
          const errorMessage = errData?.message || "GitHub upload failed";
          
          if (uploadRes.status === 409) {
            console.log("File exists, attempting to update with SHA...");
            try {
              const getRes = await fetch(githubApiUrl, {
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (getRes.ok) {
                const existingFile = await getRes.json();
                const updateRes = await fetch(githubApiUrl, {
                  method: 'PUT',
                  headers: {
                    Authorization: `Bearer ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    message: `Update ${filename}`,
                    content: base64,
                    branch: 'main',
                    sha: existingFile.sha
                  })
                });
                
                if (!updateRes.ok) {
                  throw new Error("Failed to update existing file: " + (await updateRes.json().catch(() => ({}))).message);
                }
                console.log("Successfully updated existing file");
              } else {
                throw new Error("Could not get existing file info: " + errorMessage);
              }
            } catch (updateError) {
              console.log("Update failed, using unique filename...");
              const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
              const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
              const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
              
              const retryRes = await fetch(uniqueGithubApiUrl, {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Upload ${uniqueFilename}`,
                  content: base64,
                  branch: 'main'
                })
              });
              
              if (!retryRes.ok) {
                throw new Error("Failed to upload with unique filename: " + (await retryRes.json().catch(() => ({}))).message);
              }
              
              githubPagesUrl = uniqueGithubPagesUrl;
              console.log("Successfully uploaded with unique filename");
            }
          } else {
            throw new Error(errorMessage);
          }
        }

        // Firestore update
        await firebase.firestore()
          .collection('assignments')
          .doc(window.latestAssignmentId)
          .update({
            status: "complete",
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            recordingUrl: githubPagesUrl
          });

        // Update user's assignments collection
        const user = firebase.auth().currentUser;
        const userId = user?.uid;
        const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
        
        if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
          try {
            await firebase.firestore()
              .collection('users')
              .doc(userId)
              .collection('assignments')
              .doc(assignmentId)
              .set({
                status: "complete",
                completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                recordingUrl: githubPagesUrl
              }, { merge: true });
          } catch (userUpdateError) {
            console.error("Error updating user assignments:", userUpdateError);
          }
        }

        // Fetch assignment data to get competencies
        let competencies = [];
        let assignmentName = 'Case Study';
        try {
          const assignmentDoc = await firebase.firestore()
            .collection('assignments')
            .doc(window.latestAssignmentId)
            .get();
          
          if (assignmentDoc.exists) {
            const assignmentData = assignmentDoc.data();
            competencies = assignmentData.competencies || [];
            assignmentName = assignmentData.title || 'Case Study';
          }
        } catch (error) {
          console.error("Error fetching assignment data:", error);
        }

        // Show success message and congrats modal
        showCongratsModal({ 
          score: undefined, 
          totalQuestions: undefined,
          assignmentName: assignmentName,
          competencies: competencies,
          assignmentType: 'case'
        });
        
        // Close modal
        closeCaseStudyModal();
      } catch (error) {
        console.error("Upload Error:", error);
        alert("Upload Error: " + error.message);
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Case Study';
        }
      }
    }

    // ========== SPEAKING MODAL FUNCTIONS ==========
    function openSpeakingAssignmentModal(assignment) {
      // Ensure assignment ID is set
      if (assignment) {
        if (assignment.id) {
          window.latestAssignmentId = assignment.id;
        }
        window.currentAssignment = assignment;
        console.log("Set assignment ID:", window.latestAssignmentId);
      }
      
      // Set the modal title
      document.getElementById('cq-speaking-title').textContent = "Speaking Assessment";
      
      // Set assignment questions
      if (window.currentAssignmentQuestions) {
        document.getElementById('cq-speaking-q1').textContent = window.currentAssignmentQuestions.q1;
        document.getElementById('cq-speaking-q2').textContent = window.currentAssignmentQuestions.q2;
      } else if (assignment && assignment.questions) {
        document.getElementById('cq-speaking-q1').textContent = assignment.questions[0] || "No question provided";
        document.getElementById('cq-speaking-q2').textContent = assignment.questions[1] || "No question provided";
      }
      
      // Create star field
      const starsContainer = document.getElementById('cq-speaking-stars');
      if (starsContainer) {
        starsContainer.innerHTML = '';
        for (let i = 0; i < 150; i++) {
          const star = document.createElement('div');
          star.className = 'cq-speaking-star';
          star.style.top = Math.random() * 100 + '%';
          star.style.left = Math.random() * 100 + '%';
          const size = Math.random() * 2 + 0.5;
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          star.style.opacity = Math.random() * 0.7 + 0.3;
          star.style.animationDuration = (Math.random() * 3 + 2) + 's';
          starsContainer.appendChild(star);
        }
      }
      
      // Hide recording indicator
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      // Show the modal
      const modal = document.getElementById('cq-speaking-modal');
      if (modal) {
        modal.style.display = 'flex';
      }
      
      // Initialize video preview (but don't start recording yet)
      setTimeout(() => {
        initializeVideoPreview();
      }, 100);
    }

    async function initializeVideoPreview() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: {
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            frameRate: { min: 15, ideal: 30, max: 60 }
          }, 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });
        
        const videoElement = document.getElementById('cq-speaking-videoPreview');
        const noVideoView = document.getElementById('cq-speaking-noVideoView');
        
        if (videoElement) {
          videoElement.srcObject = stream;
          videoElement.muted = true;
          videoElement.autoplay = true;
          videoElement.playsInline = true;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
          
          // Store stream for later use
          cqSpeakingMediaStream = stream;
          
          // Set up recorder but don't start it yet
          setupRecordingFromStream(stream);
          
          videoElement.addEventListener('loadedmetadata', () => {
            videoElement.play().catch(e => {
              console.error("Error playing video preview:", e);
            });
          });
        }
      } catch (error) {
        console.error('Error initializing video preview:', error);
        const noVideoView = document.getElementById('cq-speaking-noVideoView');
        if (noVideoView) {
          noVideoView.style.display = 'flex';
        }
      }
    }

    function setupRecordingFromStream(stream) {
      const videoElement = document.getElementById('cq-speaking-videoPreview');
      const noVideoView = document.getElementById('cq-speaking-noVideoView');
      if (!videoElement) {
        console.error("Video preview element not found in DOM");
        alert("Video preview element not found");
        return;
      }
      
      // Set up video preview
      videoElement.srcObject = stream;
      videoElement.muted = true;
      videoElement.autoplay = true;
      videoElement.playsInline = true;
      videoElement.style.display = 'block';
      if (noVideoView) noVideoView.style.display = 'none';
      
      videoElement.addEventListener('loadedmetadata', () => {
        videoElement.play().catch(e => {
          console.error("Error playing video preview:", e);
        });
      });
      
      const audioPlayback = document.getElementById('cq-speaking-audioPlayback');
      if (audioPlayback) {
        audioPlayback.style.display = 'none';
      }
      
      // Set up MediaRecorder with best available format
      let options = {};
      if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
        options.mimeType = 'video/webm;codecs=vp9';
      } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
        options.mimeType = 'video/webm;codecs=vp8';
      } else if (MediaRecorder.isTypeSupported('video/webm')) {
        options.mimeType = 'video/webm';
      } else if (MediaRecorder.isTypeSupported('video/mp4')) {
        options.mimeType = 'video/mp4';
      }
      
      cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
      console.log("MediaRecorder created with mimeType:", cqSpeakingMediaRecorder.mimeType);
      
      cqSpeakingMediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) {
          cqSpeakingRecordedChunks.push(event.data);
          console.log("Added chunk, total chunks:", cqSpeakingRecordedChunks.length);
        }
      };
      
      cqSpeakingMediaRecorder.onstop = () => {
        console.log("Video recording stopped, processing...");
        
        if (recordingStateMonitor) {
          clearInterval(recordingStateMonitor);
          recordingStateMonitor = null;
        }
        
        setTimeout(() => {
          if (cqSpeakingRecordedChunks.length === 0) {
            console.error("No video data recorded after stop");
            alert("No video data was recorded. Please try recording for at least 1 second.");
            return;
          }
          const mimeType = cqSpeakingMediaRecorder.mimeType || 'video/webm';
          const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });
          console.log("Created video blob:", blob.size, "bytes");

          const videoURL = URL.createObjectURL(blob);
          const videoElement = document.getElementById('cq-speaking-videoPreview');
          const noVideoView = document.getElementById('cq-speaking-noVideoView');
          if (videoElement) {
            videoElement.srcObject = null;
            videoElement.src = videoURL;
            videoElement.controls = true;
            videoElement.muted = false;
            videoElement.style.display = 'block';
            if (noVideoView) noVideoView.style.display = 'none';
          }

          const recordBtn = document.getElementById('cq-speaking-recordBtn');
          if (recordBtn) {
            recordBtn.classList.remove('recording');
          }
          
          const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
          if (recordingIndicator) {
            recordingIndicator.classList.remove('active');
          }

          isRecording = false;
          
          const submitBtn = document.getElementById('cq-speaking-submitBtn');
          if (submitBtn && cqSpeakingRecordedChunks.length > 0) {
            submitBtn.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Assessment';
          }
        }, 1000);
      };
      
      cqSpeakingMediaRecorder.onerror = (event) => {
        console.error("MediaRecorder error:", event.error);
        alert("Recording error: " + (event.error?.message || "Unknown error."));
        isRecording = false;
        
        const recordBtn = document.getElementById('cq-speaking-recordBtn');
        if (recordBtn) {
          recordBtn.classList.remove('recording');
        }
        
        const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
        if (recordingIndicator) {
          recordingIndicator.classList.remove('active');
        }
      };
      
      cqSpeakingMediaRecorder.addEventListener('start', () => {
        console.log("🎬 MediaRecorder start event fired");
        isIntentionallyStopping = false;
        
        if (recordingStateMonitor) {
          clearInterval(recordingStateMonitor);
          recordingStateMonitor = null;
        }
        
        recordingStateMonitor = setInterval(() => {
          if (isIntentionallyStopping) {
            return;
          }
          
          if (cqSpeakingMediaRecorder && isRecording) {
            const state = cqSpeakingMediaRecorder.state;
            if (state === 'recording') {
              console.log("✅ Recording still active");
            } else if (state === 'inactive' || state === 'paused') {
              if (!isIntentionallyStopping) {
                console.error("❌ Recording stopped unexpectedly!");
                clearInterval(recordingStateMonitor);
                recordingStateMonitor = null;
                isRecording = false;
                const recordBtn = document.getElementById('cq-speaking-recordBtn');
                if (recordBtn) {
                  recordBtn.classList.remove('recording');
                }
                const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
                if (recordingIndicator) {
                  recordingIndicator.classList.remove('active');
                }
                alert("⚠️ Recording stopped unexpectedly. Please try again.");
              }
            }
          }
        }, 1000);
      });
    }

    function stopRecording() {
      console.log("🛑 stopRecording() called");
      
      if (!cqSpeakingMediaRecorder || !isRecording) {
        console.log("Cannot stop: no recorder or not recording");
        return;
      }
      
      isIntentionallyStopping = true;
      
      if (recordingStateMonitor) {
        clearInterval(recordingStateMonitor);
        recordingStateMonitor = null;
      }
      
      isRecording = false;
      
      if (cqSpeakingMediaRecorder.state === 'recording') {
        try {
          cqSpeakingMediaRecorder.requestData();
          setTimeout(() => {
            try {
              cqSpeakingMediaRecorder.stop();
            } catch (e) {
              console.error("Error stopping recorder:", e);
            }
          }, 100);
          
          const recordBtn = document.getElementById('cq-speaking-recordBtn');
          if (recordBtn) {
            recordBtn.classList.remove('recording');
          }
          
          const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
          if (recordingIndicator) {
            recordingIndicator.classList.remove('active');
          }
          
          return;
        } catch (e) {
          console.error("Error requesting final data:", e);
        }
      }
      
      try {
        cqSpeakingMediaRecorder.stop();
      } catch (e) {
        console.error("Error stopping recorder:", e);
      }
      
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
    }

    function toggleSpeakingRecording() {
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (!recordBtn) return;
      
      if (isRecording) {
        console.log("Stopping recording via toggle button");
        stopRecording();
      } else {
        console.log("Starting recording via toggle button");
        
        if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
          cqSpeakingRecordedChunks = [];
          try {
            isRecording = true;
            recordBtn.classList.add('recording');
            
            const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
            if (recordingIndicator) {
              recordingIndicator.classList.add('active');
            }
            
            cqSpeakingMediaRecorder.start();
            console.log("✅ Recording started successfully");
          } catch (e) {
            console.error("Error starting recorder:", e);
            alert("Error starting recording: " + e.message);
            isRecording = false;
          }
        } else if (cqSpeakingMediaStream && !cqSpeakingMediaRecorder) {
          setupRecordingFromStream(cqSpeakingMediaStream);
          setTimeout(() => {
            if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
              cqSpeakingRecordedChunks = [];
              try {
                isRecording = true;
                recordBtn.classList.add('recording');
                
                const recordingIndicator2 = document.getElementById('cq-speaking-recordingIndicator');
                if (recordingIndicator2) {
                  recordingIndicator2.classList.add('active');
                }
                
                cqSpeakingMediaRecorder.start();
                console.log("✅ Recording started after setup");
              } catch (e) {
                console.error("Error starting recorder after setup:", e);
                alert("Error starting recording: " + e.message);
                isRecording = false;
              }
            }
          }, 200);
        } else if (!cqSpeakingMediaStream) {
          initializeVideoPreview();
        } else {
          alert("Recording is already in progress or not ready. Please wait.");
        }
      }
    }

    function cqSpeakingStopAllMedia() {
      if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state !== 'inactive') {
        try {
          cqSpeakingMediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping recorder:", e);
        }
      }
      
      if (cqSpeakingMediaStream) {
        cqSpeakingMediaStream.getTracks().forEach(track => track.stop());
        cqSpeakingMediaStream = null;
      }
      
      cqSpeakingMediaRecorder = null;
      cqSpeakingRecordedChunks = [];
      isRecording = false;
      
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
    }

    function closeSpeakingAssignmentModal() {
      document.getElementById('cq-speaking-downloadBtn').style.display = 'none';
      cqSpeakingStopAllMedia();
      document.getElementById('cq-speaking-modal').style.display = 'none';
      
      if (window.latestAssignmentId) {
        db.collection('assignments').doc(window.latestAssignmentId)
          .update({ status: "complete" })
          .then(() => {
            window.latestAssignmentId = null;
            window.currentAssignment = null;
          })
          .catch(error => {
            console.error("Error updating assignment status:", error);
          });
      }
    }

    // ========== CASE STUDY MODAL FUNCTIONS ==========
    async function cqCaseStudyBlobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function toggleCaseStudyTimer() {
      cqCaseStudyTimerActive = !cqCaseStudyTimerActive;
      const timerEl = document.getElementById('cq-case-study-timer');
      const timerDot = document.getElementById('cq-case-study-timer-dot');
      const timerText = document.getElementById('cq-case-study-timer-text');
      const timerStart = document.getElementById('cq-case-study-timer-start');
      
      if (cqCaseStudyTimerActive) {
        timerEl.classList.add('active');
        if (timerStart) timerStart.style.display = 'none';
        
        cqCaseStudyTimerInterval = setInterval(() => {
          if (cqCaseStudyTimeLeft > 0) {
            cqCaseStudyTimeLeft--;
            if (timerText) {
              const mins = Math.floor(cqCaseStudyTimeLeft / 60);
              const secs = cqCaseStudyTimeLeft % 60;
              timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
          } else {
            cqCaseStudyTimerActive = false;
            if (timerEl) timerEl.classList.remove('active');
            if (timerStart) timerStart.style.display = 'inline';
            if (cqCaseStudyTimerInterval) {
              clearInterval(cqCaseStudyTimerInterval);
              cqCaseStudyTimerInterval = null;
            }
            alert('Time is up!');
          }
        }, 1000);
      } else {
        timerEl.classList.remove('active');
        if (timerStart) timerStart.style.display = 'inline';
        if (cqCaseStudyTimerInterval) {
          clearInterval(cqCaseStudyTimerInterval);
          cqCaseStudyTimerInterval = null;
        }
      }
    }

    function expandCaseStudyContent() {
      document.getElementById('cq-case-study-top-info').style.display = 'none';
      document.getElementById('cq-case-study-video-container').style.display = 'none';
      document.getElementById('cq-case-study-bottom-info').style.display = 'none';
      document.getElementById('cq-case-study-controls-wrapper').style.display = 'none';
      document.getElementById('cq-case-study-expanded-content').style.display = 'flex';
    }

    function collapseCaseStudyContent() {
      document.getElementById('cq-case-study-top-info').style.display = 'grid';
      document.getElementById('cq-case-study-video-container').style.display = 'block';
      document.getElementById('cq-case-study-bottom-info').style.display = 'grid';
      document.getElementById('cq-case-study-controls-wrapper').style.display = 'flex';
      document.getElementById('cq-case-study-expanded-content').style.display = 'none';
    }

    function openCaseStudyModal(assignment) {
      // Ensure assignment ID is set
      if (assignment) {
        if (assignment.id) {
          window.latestAssignmentId = assignment.id;
        }
        window.currentAssignment = assignment;
        console.log("Set assignment ID:", window.latestAssignmentId);
      }
      
      // Set the modal title
      document.getElementById('cq-case-study-title').textContent = "Case Study";
      
      // Set case name
      const caseName = assignment.title || "Case Study";
      document.getElementById('cq-case-study-name').textContent = caseName;
      document.getElementById('cq-case-study-expanded-title').textContent = caseName;
      
      // Set case study content
      const caseContent = assignment.description || assignment.caseStudyContent || "No case study content provided.";
      const previewText = caseContent.substring(0, 100) + (caseContent.length > 100 ? '...' : '');
      document.getElementById('cq-case-study-content-preview-text').textContent = previewText;
      document.getElementById('cq-case-study-full-content').textContent = caseContent;
      
      // Set assignment questions
      if (assignment.questions && assignment.questions.length > 0) {
        document.getElementById('cq-case-study-q1').textContent = assignment.questions[0] || "No question provided";
        if (assignment.questions.length > 1) {
          document.getElementById('cq-case-study-q2').textContent = assignment.questions[1] || "No question provided";
        }
      }
      
      // Reset timer to 20 minutes
      cqCaseStudyTimeLeft = 1200;
      const timerText = document.getElementById('cq-case-study-timer-text');
      if (timerText) {
        const mins = Math.floor(cqCaseStudyTimeLeft / 60);
        const secs = cqCaseStudyTimeLeft % 60;
        timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      }
      cqCaseStudyTimerActive = false;
      const timerEl = document.getElementById('cq-case-study-timer');
      if (timerEl) timerEl.classList.remove('active');
      
      // Create star field
      const starsContainer = document.getElementById('cq-case-study-stars');
      if (starsContainer) {
        starsContainer.innerHTML = '';
        for (let i = 0; i < 150; i++) {
          const star = document.createElement('div');
          star.className = 'cq-case-study-star';
          star.style.top = Math.random() * 100 + '%';
          star.style.left = Math.random() * 100 + '%';
          const size = Math.random() * 2 + 0.5;
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          star.style.opacity = Math.random() * 0.7 + 0.3;
          star.style.animationDuration = (Math.random() * 3 + 2) + 's';
          starsContainer.appendChild(star);
        }
      }
      
      // Hide recording indicator
      const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      // Reset UI state
      collapseCaseStudyContent();
      document.getElementById('cq-case-study-submitBtn').style.display = 'none';
      document.getElementById('cq-case-study-downloadBtn').style.display = 'none';
      
      // Show the modal
      const modal = document.getElementById('cq-case-study-modal');
      if (modal) {
        modal.style.display = 'flex';
      }
      
      // Initialize video preview (but don't start recording yet)
      setTimeout(() => {
        cqCaseStudyInitializeVideoPreview();
      }, 100);
    }

    async function cqCaseStudyInitializeVideoPreview() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: {
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            frameRate: { min: 15, ideal: 30, max: 60 }
          }, 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });
        
        const videoElement = document.getElementById('cq-case-study-videoPreview');
        const noVideoView = document.getElementById('cq-case-study-noVideoView');
        
        if (videoElement) {
          videoElement.srcObject = stream;
          videoElement.muted = true;
          videoElement.autoplay = true;
          videoElement.playsInline = true;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
          
          cqCaseStudyMediaStream = stream;
          cqCaseStudySetupRecordingFromStream(stream);
          
          videoElement.addEventListener('loadedmetadata', () => {
            videoElement.play().catch(e => {
              console.error("Error playing video preview:", e);
            });
          });
        }
      } catch (error) {
        console.error('Error initializing video preview:', error);
        const noVideoView = document.getElementById('cq-case-study-noVideoView');
        if (noVideoView) {
          noVideoView.style.display = 'flex';
        }
      }
    }

    function cqCaseStudySetupRecordingFromStream(stream) {
      const videoElement = document.getElementById('cq-case-study-videoPreview');
      if (!videoElement) {
        console.error("Video preview element not found in DOM");
        return;
      }
      
      let options = {};
      if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
        options.mimeType = 'video/webm;codecs=vp9';
      } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
        options.mimeType = 'video/webm;codecs=vp8';
      } else if (MediaRecorder.isTypeSupported('video/webm')) {
        options.mimeType = 'video/webm';
      } else if (MediaRecorder.isTypeSupported('video/mp4')) {
        options.mimeType = 'video/mp4';
      }
      
      cqCaseStudyMediaRecorder = new MediaRecorder(stream, options);
      console.log("Case Study MediaRecorder created with mimeType:", cqCaseStudyMediaRecorder.mimeType);
      
      cqCaseStudyMediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
          cqCaseStudyRecordedChunks.push(event.data);
        }
      };
      
      cqCaseStudyMediaRecorder.onstop = () => {
        console.log("Case Study video recording stopped");
        
        if (cqCaseStudyRecordedChunks.length === 0) {
          alert("No video data was recorded. Please try again.");
          return;
        }
        
        const mimeType = cqCaseStudyMediaRecorder.mimeType || 'video/webm';
        const blob = new Blob(cqCaseStudyRecordedChunks, { type: mimeType });

        const videoURL = URL.createObjectURL(blob);
        const videoElement = document.getElementById('cq-case-study-videoPreview');
        const noVideoView = document.getElementById('cq-case-study-noVideoView');
        if (videoElement) {
          videoElement.srcObject = null;
          videoElement.src = videoURL;
          videoElement.controls = true;
          videoElement.muted = false;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
        }
        
        const downloadBtn = document.getElementById('cq-case-study-downloadBtn');
        if (downloadBtn && blob) {
          downloadBtn.style.display = 'flex';
          downloadBtn.onclick = function() {
            const url = URL.createObjectURL(blob);
            const filename = `CertQuest_CaseStudy_${Date.now()}.webm`;
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, 100);
          };
        }
        
        const submitBtn = document.getElementById('cq-case-study-submitBtn');
        if (submitBtn) {
          submitBtn.style.display = 'block';
        }
      };
      
      cqCaseStudyMediaRecorder.onerror = (event) => {
        console.error("Case Study MediaRecorder error:", event.error);
        alert("Recording error: " + event.error.message);
        cqCaseStudyIsRecording = false;
      };
    }

    function cqCaseStudyStopAllMedia() {
      if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state !== 'inactive') {
        try {
          cqCaseStudyMediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping recorder:", e);
        }
      }
      
      if (cqCaseStudyMediaStream) {
        cqCaseStudyMediaStream.getTracks().forEach(track => track.stop());
        cqCaseStudyMediaStream = null;
      }
      
      cqCaseStudyMediaRecorder = null;
      cqCaseStudyRecordedChunks = [];
      cqCaseStudyIsRecording = false;
      
      const recordBtn = document.getElementById('cq-case-study-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      const downloadBtn = document.getElementById('cq-case-study-downloadBtn');
      if (downloadBtn) {
        downloadBtn.style.display = 'none';
      }
    }

    function toggleCaseStudyRecording() {
      const recordBtn = document.getElementById('cq-case-study-recordBtn');
      if (!recordBtn) return;
      
      if (cqCaseStudyIsRecording) {
        console.log("Stopping case study recording");
        cqCaseStudyStopRecording();
      } else {
        console.log("Starting case study recording");
        if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
          cqCaseStudyRecordedChunks = [];
          try {
            cqCaseStudyIsRecording = true;
            recordBtn.classList.add('recording');
            
            const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
            if (recordingIndicator) {
              recordingIndicator.classList.add('active');
            }
            
            cqCaseStudyMediaRecorder.start();
            console.log("✅ Case Study recording started");
          } catch (e) {
            console.error("Error starting recorder:", e);
            alert("Error starting recording: " + e.message);
            cqCaseStudyIsRecording = false;
          }
        } else if (cqCaseStudyMediaStream && !cqCaseStudyMediaRecorder) {
          cqCaseStudySetupRecordingFromStream(cqCaseStudyMediaStream);
          setTimeout(() => {
            if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
              cqCaseStudyRecordedChunks = [];
              try {
                cqCaseStudyIsRecording = true;
                recordBtn.classList.add('recording');
                
                const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
                if (recordingIndicator) {
                  recordingIndicator.classList.add('active');
                }
                
                cqCaseStudyMediaRecorder.start();
                console.log("✅ Case Study recording started after setup");
              } catch (e) {
                console.error("Error starting recorder after setup:", e);
                alert("Error starting recording: " + e.message);
                cqCaseStudyIsRecording = false;
              }
            }
          }, 200);
        } else if (!cqCaseStudyMediaStream) {
          cqCaseStudyInitializeVideoPreview();
        } else {
          alert("Recording is already in progress or not ready. Please wait.");
        }
      }
    }

    function cqCaseStudyStopRecording() {
      if (!cqCaseStudyMediaRecorder || !cqCaseStudyIsRecording) {
        return;
      }
      
      cqCaseStudyIsIntentionallyStopping = true;
      cqCaseStudyIsRecording = false;
      
      if (cqCaseStudyMediaRecorder.state === 'recording') {
        try {
          cqCaseStudyMediaRecorder.requestData();
          cqCaseStudyMediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping recorder:", e);
        }
      }
      
      const recordBtn = document.getElementById('cq-case-study-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      cqCaseStudyIsIntentionallyStopping = false;
    }

    function closeCaseStudyModal() {
      if (cqCaseStudyTimerInterval) {
        clearInterval(cqCaseStudyTimerInterval);
        cqCaseStudyTimerInterval = null;
      }
      cqCaseStudyTimerActive = false;
      cqCaseStudyStopAllMedia();
      
      const modal = document.getElementById('cq-case-study-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }

    // Expose functions globally for onclick handlers
    window.acceptAssignmentNow = acceptAssignmentNow;
    window.closeAssignmentModal = closeAssignmentModal;
    window.openFullAssignmentModal = openFullAssignmentModal;
    window.snoozeAssignment = snoozeAssignment;
    window.closeQuizModal = closeQuizModal;
    window.previousQuestion = previousQuestion;
    window.nextQuestion = nextQuestion;
    window.submitQuiz = submitQuiz;
    window.closeCongratsModal = closeCongratsModal;
    window.submitSpeakingResponse = submitSpeakingResponse;
    window.submitCaseStudyResponse = submitCaseStudyResponse;
    window.openSpeakingAssignmentModal = openSpeakingAssignmentModal;
    window.openCaseStudyModal = openCaseStudyModal;
    window.toggleSpeakingRecording = toggleSpeakingRecording;
    window.toggleCaseStudyRecording = toggleCaseStudyRecording;
    window.closeSpeakingAssignmentModal = closeSpeakingAssignmentModal;
    window.closeCaseStudyModal = closeCaseStudyModal;
    window.toggleCaseStudyTimer = toggleCaseStudyTimer;
    window.expandCaseStudyContent = expandCaseStudyContent;
    window.collapseCaseStudyContent = collapseCaseStudyContent;
  });
</script>

  <!-- Assignment Modal -->
  <div id="cq-assignment-modal" class="cq-modal" style="display: none;">
    <div class="cq-modal-content">
      <span class="cq-close" onclick="closeAssignmentModal()">&times;</span>
      <div id="cq-assignment-title" class="cq-modal-title">New Assignment</div>
      
      <!-- Assignment Info (shown first) -->
      <div id="cq-assignment-info">
        <div id="cq-assignment-fields" class="cq-modal-fields"></div>
        <div class="cq-modal-footer" style="margin-top:1.5rem; text-align:right;">
          <button class="cq-modal-btn" onclick="acceptAssignmentNow()">I'll do it now</button>
          <button class="cq-modal-btn" onclick="snoozeAssignment()">I'll do it later</button>
        </div>
      </div>
      
      <!-- Quiz Section (hidden initially) -->
      <div id="cq-assignment-quiz" style="display:none;">
        <div id="quizQuestions" class="cq-modal-fields"></div>
        <div class="cq-modal-footer">
          <button class="cq-modal-btn" id="submitQuizBtn" disabled>Submit Answers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quiz Modal - Fullscreen -->
  <div id="quizModal" style="display: none;" class="practice-quiz-fullscreen">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="quizStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Top Bar -->
    <div class="practice-quiz-topbar">
      <div class="practice-quiz-topbar-content">
        <div>
          <h1 id="quizTitle" class="practice-quiz-topbar-title">Easy Written Practice</h1>
          <p class="practice-quiz-topbar-subtitle">
            <span id="quizProgress">Question 1 of 14</span>
          </p>
        </div>
        
        <div class="practice-quiz-topbar-right">
          <div class="practice-quiz-timer-section">
            <p class="practice-quiz-timer-label">Time Remaining</p>
            <p id="quizTimer" class="practice-quiz-timer-value">14:53</p>
          </div>
          
          <button class="practice-quiz-close-btn" onclick="closeQuizModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="practice-quiz-main">
      <!-- Competency Badge -->
      <div class="practice-quiz-competency-badge">
        <span id="questionCompetency" class="practice-quiz-competency-text">Business Communication</span>
      </div>

      <!-- Question -->
      <div class="practice-quiz-question-section">
        <h2 id="questionText" class="practice-quiz-question">Loading question...</h2>
        <p class="practice-quiz-question-hint">Select the best answer from the options below</p>
      </div>

      <!-- Answer Options -->
      <div id="optionsContainer" class="practice-quiz-options">
        <!-- Options will be populated dynamically -->
      </div>

      <!-- Progress Section -->
      <div class="practice-quiz-progress-section">
        <div class="practice-quiz-progress-header">
          <p class="practice-quiz-progress-label">Overall Progress</p>
          <p class="practice-quiz-progress-value"><span id="progressPercent">0</span>/100</p>
        </div>
        <div class="practice-quiz-progress-bar">
          <div class="practice-quiz-progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="practice-quiz-actions">
        <button id="prevBtn" class="practice-quiz-prev-btn" onclick="previousQuestion()" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Previous Question
        </button>
        <button id="nextBtn" class="practice-quiz-next-btn" onclick="nextQuestion()">Next Question</button>
        <button id="submitBtn" class="practice-quiz-submit-btn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
      </div>
    </div>
  </div>

  <!-- Congratulations Modal - Fullscreen -->
  <div id="congratsModal" class="practice-quiz-fullscreen" style="display:none;">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="congratsStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Main Content - Centered -->
    <div class="practice-quiz-main" style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px);">
      <div class="congrats-content">
        <!-- Congratulations Header - Centered -->
        <div class="congrats-header">
          <h1 id="congratsTitle" class="congrats-title">Congratulations!</h1>
          <p class="congrats-subtitle" id="congratsSubtitle">
            Excellent work! You scored <span id="congratsScore">0/0</span>
          </p>
        </div>

        <!-- Assignment Info - Centered -->
        <div class="congrats-assignment-info">
          <p class="congrats-assignment-label">For completing:</p>
          <h2 id="congratsAssignmentName" class="congrats-assignment-name">Written Practice</h2>
        </div>

        <!-- Competency Breakdown - Grid Layout -->
        <div class="congrats-competencies-grid" id="congratsCompetencies">
          <!-- Competencies will be populated here -->
        </div>

        <!-- Action Button -->
        <div class="congrats-actions">
          <button class="practice-quiz-next-btn" onclick="closeCongratsModal()">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assignment Loader - Fullscreen Blurred -->
  <div id="assignmentLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 10000; justify-content: center; align-items: center; flex-direction: column;">
    <div class="circular-progress-loader">
      <svg class="circular-progress-svg" viewBox="0 0 100 100">
        <defs>
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#f97316;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#eab308;stop-opacity:1" />
          </linearGradient>
        </defs>
        <circle class="circular-progress-bg" cx="50" cy="50" r="45"></circle>
        <circle class="circular-progress-fill" cx="50" cy="50" r="45" id="circularProgressFill"></circle>
      </svg>
      <div class="circular-progress-text" id="circularProgressText">0%</div>
    </div>
  </div>

  <!-- Notification Panel -->
  <div id="notificationPanel" class="notification-panel hidden">
    <div class="notification-panel-header">
      <h3 class="notification-panel-title">NOTIFICATIONS</h3>
      <button onclick="toggleNotificationPanel()" class="close-notifications">✕</button>
    </div>
    <div id="notificationList" class="notification-list"></div>
  </div>

  <div id="cq-written-loading" class="cq-written-loading" style="display:none;">
    <!-- Gradient balls background -->
    <div class="gradient-balls">
        <div class="ball ball-1"></div>
        <div class="ball ball-2"></div>
        <div class="ball ball-3"></div>
        <div class="ball ball-4"></div>
    </div>
    
    <!-- Loading content -->
    <div class="cq-loading-container">
        <div class="cq-loading-spinner"></div>
        <div class="cq-loading-text">Loading Assignment!</div>
        <div class="cq-loading-subtext">Analyzing your competencies and creating personalized content...</div>
        <div class="cq-loading-progress">
            <div class="cq-loading-progress-bar" id="cq-loading-progress-bar"></div>
        </div>
    </div>
  </div>

  <!-- Speaking Assignment Modal -->
  <div id="cq-speaking-modal" class="cq-speaking-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-speaking-stars" id="cq-speaking-stars"></div>
    <div class="cq-speaking-glow-1"></div>
    <div class="cq-speaking-glow-2"></div>
    
    <div class="cq-speaking-modal-content">
      <!-- Header -->
      <div class="cq-speaking-header">
        <h1 class="cq-speaking-title" id="cq-speaking-title">Speaking Assessment</h1>
        <button class="cq-speaking-close" onclick="closeSpeakingAssignmentModal()">×</button>
      </div>
      
      <!-- Main Container -->
      <div class="cq-speaking-main-container">
        <!-- Questions Row -->
        <div class="cq-speaking-questions">
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 1:</h2>
            <p id="cq-speaking-q1" class="cq-speaking-question-text">What is your strategy for this scenario?</p>
          </div>
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 2:</h2>
            <p id="cq-speaking-q2" class="cq-speaking-question-text">How would you handle unexpected challenges?</p>
          </div>
        </div>
        
        <!-- Video Feed -->
        <div class="cq-speaking-video-container">
          <video id="cq-speaking-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-speaking-noVideoView" class="cq-speaking-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-speaking-recordingIndicator" class="cq-speaking-recording-indicator">
            <div class="cq-speaking-recording-dot"></div>
            <span class="cq-speaking-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Controls -->
        <div class="cq-speaking-controls-wrapper">
          <div class="cq-speaking-controls">
            <button id="cq-speaking-documentBtn" class="cq-speaking-control-btn" title="Document">
              📄
            </button>
            <button id="cq-speaking-recordBtn" class="cq-speaking-record-btn" onclick="toggleSpeakingRecording()">
              🎤
            </button>
            <button id="cq-speaking-micBtn" class="cq-speaking-control-btn" title="Settings">
              ⚙️
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-speaking-submitBtn" class="cq-speaking-submit-btn" style="display:none;" onclick="submitSpeakingResponse()">Submit Assessment</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-speaking-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-speaking-audioBtn" style="display:none;"></button>
      <button id="cq-speaking-videoBtn" style="display:none;"></button>
      <button id="cq-speaking-stopBtn" style="display:none;"></button>
      <button id="cq-speaking-downloadBtn" style="display:none;"></button>
    </div>
  </div>

  <!-- Case Study Assignment Modal -->
  <div id="cq-case-study-modal" class="cq-case-study-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-case-study-stars" id="cq-case-study-stars"></div>
    <div class="cq-case-study-glow-1"></div>
    <div class="cq-case-study-glow-2"></div>
    
    <div class="cq-case-study-modal-content">
      <!-- Header -->
      <div class="cq-case-study-header">
        <h1 class="cq-case-study-title" id="cq-case-study-title">Case Study</h1>
        <div class="cq-case-study-header-right">
          <!-- Timer -->
          <div id="cq-case-study-timer" class="cq-case-study-timer" onclick="toggleCaseStudyTimer()">
            <div id="cq-case-study-timer-dot" class="cq-case-study-timer-dot"></div>
            <span id="cq-case-study-timer-text" class="cq-case-study-timer-text">20:00</span>
            <span id="cq-case-study-timer-start" class="cq-case-study-timer-start">Start</span>
          </div>
          <button class="cq-case-study-close" onclick="closeCaseStudyModal()">×</button>
        </div>
      </div>
      
      <!-- Main Container -->
      <div class="cq-case-study-main-container">
        <!-- Top Info Section (when content collapsed) -->
        <div id="cq-case-study-top-info" class="cq-case-study-top-info">
          <div class="cq-case-study-info-card">
            <p class="cq-case-study-info-label">Case Name</p>
            <p id="cq-case-study-name" class="cq-case-study-info-value">Market Expansion Strategy</p>
          </div>
          <div id="cq-case-study-content-preview" class="cq-case-study-info-card cq-case-study-clickable" onclick="expandCaseStudyContent()">
            <p class="cq-case-study-info-label">Case Study Content</p>
            <p id="cq-case-study-content-preview-text" class="cq-case-study-info-preview">Loading...</p>
            <p class="cq-case-study-read-more">Read More →</p>
          </div>
        </div>
        
        <!-- Expanded Content (when content expanded) -->
        <div id="cq-case-study-expanded-content" class="cq-case-study-expanded-content" style="display:none;">
          <div class="cq-case-study-expanded-header">
            <div>
              <p class="cq-case-study-expanded-label">Case Study Content</p>
              <h3 id="cq-case-study-expanded-title" class="cq-case-study-expanded-title">Market Expansion Strategy</h3>
            </div>
            <button class="cq-case-study-expanded-close" onclick="collapseCaseStudyContent()">×</button>
          </div>
          <p id="cq-case-study-full-content" class="cq-case-study-full-content">Loading...</p>
        </div>
        
        <!-- Video Feed (hidden when content expanded) -->
        <div id="cq-case-study-video-container" class="cq-case-study-video-container">
          <video id="cq-case-study-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-case-study-noVideoView" class="cq-case-study-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-case-study-recordingIndicator" class="cq-case-study-recording-indicator">
            <div class="cq-case-study-recording-dot"></div>
            <span class="cq-case-study-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Bottom Info Section (hidden when content expanded) -->
        <div id="cq-case-study-bottom-info" class="cq-case-study-bottom-info">
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 1</p>
            <p id="cq-case-study-q1" class="cq-case-study-question-text">What are the key market opportunities and challenges?</p>
          </div>
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 2</p>
            <p id="cq-case-study-q2" class="cq-case-study-question-text">How would you develop a comprehensive expansion strategy?</p>
          </div>
        </div>
        
        <!-- Controls (hidden when content expanded) -->
        <div id="cq-case-study-controls-wrapper" class="cq-case-study-controls-wrapper">
          <div class="cq-case-study-controls">
            <button id="cq-case-study-recordBtn" class="cq-case-study-record-btn" onclick="toggleCaseStudyRecording()">
              🎤
            </button>
            <button id="cq-case-study-downloadBtn" class="cq-case-study-control-btn" title="Download" style="display:none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="7" y="7" width="10" height="10" rx="2.5" fill="#60a5fa"/>
                <path d="M12 9.5v4.5m0 0l-2.5-2.5m2.5 2.5l2.5-2.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-case-study-submitBtn" class="cq-case-study-submit-btn" style="display:none;" onclick="submitCaseStudyResponse()">Submit Case Study</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-case-study-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-case-study-audioBtn" style="display:none;"></button>
      <button id="cq-case-study-videoBtn" style="display:none;"></button>
      <button id="cq-case-study-stopBtn" style="display:none;"></button>
    </div>
  </div>

  <!-- Quiz Modal - Fullscreen Written Practice -->
  <div id="quizModal" style="display: none;" class="practice-quiz-fullscreen">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="quizStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Top Bar -->
    <div class="practice-quiz-topbar">
      <div class="practice-quiz-topbar-content">
        <div>
          <h1 id="quizTitle" class="practice-quiz-topbar-title">Easy Written Practice</h1>
          <p class="practice-quiz-topbar-subtitle">
            <span id="quizProgress">Question 1 of 14</span>
          </p>
        </div>
        
        <div class="practice-quiz-topbar-right">
          <div class="practice-quiz-timer-section">
            <p class="practice-quiz-timer-label">Time Remaining</p>
            <p id="quizTimer" class="practice-quiz-timer-value">14:53</p>
          </div>
          
          <button class="practice-quiz-close-btn" onclick="closeQuizModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="practice-quiz-main">
      <!-- Competency Badge -->
      <div class="practice-quiz-competency-badge">
        <span id="questionCompetency" class="practice-quiz-competency-text">Business Communication</span>
      </div>

      <!-- Question -->
      <div class="practice-quiz-question-section">
        <h2 id="questionText" class="practice-quiz-question">Loading question...</h2>
        <p class="practice-quiz-question-hint">Select the best answer from the options below</p>
      </div>

      <!-- Answer Options -->
      <div id="optionsContainer" class="practice-quiz-options">
        <!-- Options will be populated dynamically -->
      </div>

      <!-- Progress Section -->
      <div class="practice-quiz-progress-section">
        <div class="practice-quiz-progress-header">
          <p class="practice-quiz-progress-label">Overall Progress</p>
          <p class="practice-quiz-progress-value"><span id="progressPercent">0</span>/100</p>
        </div>
        <div class="practice-quiz-progress-bar">
          <div class="practice-quiz-progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="practice-quiz-actions">
        <button id="prevBtn" class="practice-quiz-prev-btn" onclick="previousQuestion()" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Previous Question
        </button>
        <button id="nextBtn" class="practice-quiz-next-btn" onclick="nextQuestion()">Next Question</button>
        <button id="submitBtn" class="practice-quiz-submit-btn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
      </div>
    </div>
  </div>

  <!-- Congratulations Modal - Fullscreen -->
  <div id="congratsModal" class="practice-quiz-fullscreen" style="display:none;">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="congratsStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Main Content - Centered -->
    <div class="practice-quiz-main" style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px);">
      <div class="congrats-content">
        <!-- Congratulations Header - Centered -->
        <div class="congrats-header">
          <h1 id="congratsTitle" class="congrats-title">Congratulations!</h1>
          <p class="congrats-subtitle" id="congratsSubtitle">
            Excellent work! You scored <span id="congratsScore">0/0</span>
          </p>
        </div>

        <!-- Assignment Info - Centered -->
        <div class="congrats-assignment-info">
          <p class="congrats-assignment-label">For completing:</p>
          <h2 id="congratsAssignmentName" class="congrats-assignment-name">Written Practice</h2>
        </div>

        <!-- Competency Breakdown - Grid Layout -->
        <div class="congrats-competencies-grid" id="congratsCompetencies">
          <!-- Competencies will be populated here -->
        </div>

        <!-- Action Button -->
        <div class="congrats-actions">
          <button class="practice-quiz-next-btn" onclick="closeCongratsModal()">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assignment Loader - Fullscreen Blurred -->
  <div id="assignmentLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 10000; justify-content: center; align-items: center; flex-direction: column;">
    <div class="circular-progress-loader">
      <svg class="circular-progress-svg" viewBox="0 0 100 100">
        <defs>
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#f97316;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#eab308;stop-opacity:1" />
          </linearGradient>
        </defs>
        <circle class="circular-progress-bg" cx="50" cy="50" r="45"></circle>
        <circle class="circular-progress-fill" cx="50" cy="50" r="45" id="circularProgressFill"></circle>
      </svg>
      <div class="circular-progress-text" id="circularProgressText">0%</div>
    </div>
  </div>

  <div id="mentorCommentModal" style="display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; position: absolute !important; left: -9999px !important; top: -9999px !important;">
    <div class="modal-content">
      <span class="close" onclick="closeMentorCommentModal()">&times;</span>
      <h2 id="mentorCommentAssignment"></h2>
      <div id="mentorCommentText"></div>
      <button class="btn" onclick="closeMentorCommentModal()">Close</button>
    </div>
  </div>

  <script>
    // Force hide mentor comment modal on page load
    document.addEventListener("DOMContentLoaded", () => {
      const mentorCommentModal = document.getElementById('mentorCommentModal');
      if (mentorCommentModal) {
        mentorCommentModal.style.display = 'none';
        mentorCommentModal.style.visibility = 'hidden';
        mentorCommentModal.style.opacity = '0';
        mentorCommentModal.style.pointerEvents = 'none';
        mentorCommentModal.style.position = 'absolute';
        mentorCommentModal.style.left = '-9999px';
        mentorCommentModal.style.top = '-9999px';
      }
    });

    // Mobile Navigation Toggle
    window.toggleMobileNav = function() {
      const nav = document.getElementById('mainNav');
      const hamburger = document.getElementById('hamburgerMenu');
      
      if (nav && hamburger) {
        nav.classList.toggle('active');
        hamburger.classList.toggle('active');
        document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
      }
    };
    
    // Close mobile nav when clicking a nav link
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.blaze-nav .nav-link').forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            toggleMobileNav();
          }
        });
      });
    });
  </script>

</body>
</html>