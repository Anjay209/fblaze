<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FBLAZE Dashboard</title>
  <link rel="stylesheet" href="competition.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">üåê</div>
     <div class="nav-title"><div class="nav-pills">
    <a class="nav-pill active" href="Public/Competitions/competition.html">Your Journey</a>
    <a class="nav-pill" href="/practice.html">Practice Hub</a>
    <a class="nav-pill" href="/statistics.html">Your Statistics</a>
  </div></div>
    <div class="nav-right">
  <input type="text" id="navbarSearch" placeholder="Search CertQuest..." />
  <span class="search-icon" id="navbarSearchIcon">üîç</span>
  <div id="searchDropdown"></div>
</div>
  </div>

  <div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">FB</div>
      <ul class="nav-icons">
  <li>
    <a href="/Public/home.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3L20 9V21H15V15H9V21H4V9L12 3Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M12 3L4 9V21H9V15H15V21H20V9L12 3Z" stroke="#3b82f6" stroke-width="2" fill="none" stroke-linejoin="round"/>
      <rect x="10" y="17" width="4" height="4" fill="#3b82f6"/>
      <rect x="6" y="11" width="2" height="2" fill="#3b82f6"/>
      <rect x="16" y="11" width="2" height="2" fill="#3b82f6"/>
    </svg>
    
    <span class="nav-label">Home</span>
     </a>
  </li>
  <li>
   <a href="/Public/home.html"  onclick="openNotificationsOnHome();">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <!-- Bell body main fill -->
    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" fill="#3b82f6" fill-opacity="0.3"/>
    <!-- Bell body lighter overlay -->
    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 12 6 15 6 15H18C18 15 18 12 18 8Z" fill="#3b82f6" fill-opacity="0.2"/>
    <!-- Bell outline -->
    <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
    <!-- Bell clapper -->
    <circle cx="12" cy="8" r="1" fill="#3b82f6"/>
    <!-- Sound waves -->
    <path d="M19 4L20 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
    <path d="M20.5 6.5L22 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
    <path d="M5 4L4 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
    <path d="M3.5 6.5L2 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
    <!-- Bottom notification indicator -->
    <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
  </svg>
  <span class="nav-label">Notifications</span>
</a>
</li>
  <li>
    <a href="/practice.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="9" fill="#3b82f6" fill-opacity="0.3"/>
      <circle cx="12" cy="12" r="6" fill="#3b82f6" fill-opacity="0.2"/>
      <circle cx="12" cy="12" r="9" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <circle cx="12" cy="12" r="6" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="3" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="1.5" fill="#3b82f6"/>
      <path d="M16 8L12 12L16 8Z" fill="#3b82f6"/>
      <line x1="16" y1="8" x2="19" y2="5" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Practice</span>
    </a>
  </li>
  <li>
    <a href="/Public/Forum/forum.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" fill="#3b82f6" fill-opacity="0.2"/>
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <line x1="11" y1="8" x2="17" y2="8" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="11" y1="10" x2="15" y2="10" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Forum</span>
    </a>
  </li>
  <li>
     <a href="/Public/Calendar/calendar.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="3" y="6" width="18" height="15" rx="2" fill="#3b82f6" fill-opacity="0.3"/>
      <rect x="3" y="6" width="18" height="4" rx="2" fill="#3b82f6" fill-opacity="0.2"/>
      <rect x="3" y="6" width="18" height="15" rx="2" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <line x1="7" y1="3" x2="7" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="17" y1="3" x2="17" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="10" x2="21" y2="10" stroke="#3b82f6" stroke-width="1" opacity="0.5"/>
      <line x1="7.5" y1="10" x2="7.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="12" y1="10" x2="12" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="16.5" y1="10" x2="16.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <circle cx="9" cy="13" r="1" fill="#3b82f6"/>
      <circle cx="15" cy="16" r="1" fill="#3b82f6"/>
      <circle cx="12" cy="18" r="1" fill="#3b82f6"/>
    </svg>
    <span class="nav-label">Calendar</span>
     </a>
  </li>
</ul>
    </aside>

    

    <!-- Secondary Sidebar -->
   <!-- <aside class="sub-sidebar">
      <div class="sidebar-header">
        <span id="comp">Physics</span>
        <span class="dots">‚ãØ</span>
      </div>
      <div class="sub-nav-wrapper">
        <ul class="sub-nav"> 
          <li class="active"><a class="link" href="#">Your Journey</a></li>
          <li><a href="/practice.html" class="link">Practice Hub</a></li>
          <li><a href="/statistics.html" class="link">Your Statistics</a></li>
        </ul>
      </div>
    </aside> -->

    <!-- Main Journey Card -->
     <div class="journey-layout">
    <div class="journey-card" style="margin-left:20vw;">
  <!-- Content will be dynamically populated by renderJourneySection() -->
  <div class="loading-placeholder">
    <h2>Loading Your Journey...</h2>
    <p>Fetching your progress data...</p>
  </div>
</div>
    <div class="profile-card-container">
    <div class="profile-card">
      <img class="profile-pic" src="/Public/assets/duckpfp.jpg" alt="Anjay P" />
      <div class="profile-name">Anjay P</div>
      <div class="profile-meta">He/Him ¬∑ Member since Jul 2025</div>
    </div>
    <br>
    <div class="profile-card">
      <div class="profile-name">Quick Actions<span class="tutor-badge"></span></div><br>
      <button class="profile-btn"><a href="/flashcard.html" class="link" style="color: #1877f2; text-decoration: none;">Recently Studied FlashDecks</a></button> <br><br>
      <button class="profile-btn"><a href="/statistics.html" class="link" style="color: #1877f2; text-decoration: none;">Competency Analysis</a></button> <br>
    </div>
  </div>
    
        
  </div>
  </div>

  <div id="confirmationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Confirm Action</h3>
      <span class="close-modal">&times;</span>
    </div>
    <div class="modal-body">
      <p id="modalMessage">Are you sure you want to complete this task?</p>
    </div>
    <div class="modal-footer">
      <button id="confirmAction" class="modal-btn confirm">Yes, Complete It</button>
      <button id="cancelAction" class="modal-btn cancel">Cancel</button>
    </div>
  </div>
</div>

<div id="loading">Loading users...</div>
<div id="users-container"></div>




  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>
<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
    authDomain: "certquest-94959.firebaseapp.com",
    projectId: "certquest-94959",
    storageBucket: "certquest-94959.appspot.com",
    messagingSenderId: "323956529033",
    appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
    measurementId: "G-F5JHTGGN6K"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // Current user state
  let currentUser = null;
  let currentCompetition = 'fbla';

  // Authentication state observer
  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      initApp();
    } else {
      // Handle unauthenticated state
      console.log("User not authenticated");
    }
  });

  const modal = document.getElementById('confirmationModal');
  const modalMessage = document.getElementById('modalMessage');
  const confirmBtn = document.getElementById('confirmAction');
  const cancelBtn = document.getElementById('cancelAction');
  const closeModal = document.querySelector('.close-modal');
  
  let currentTaskId = null;
  
  // Show modal function
  function showModal(taskId, taskDescription) {
    currentTaskId = taskId;
    modalMessage.textContent = `Are you sure you want to mark "${taskDescription}" as completed?`;
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden'; // Prevent scrolling
  }
  
  // Hide modal function
  function hideModal() {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Re-enable scrolling
  }
  
  // Event listeners for modal
  closeModal.addEventListener('click', hideModal);
  cancelBtn.addEventListener('click', hideModal);
  
  confirmBtn.addEventListener('click', async () => {
    if (currentTaskId && currentUser) {
      const success = await updateTaskProgress(currentUser.uid, currentCompetition, currentTaskId, true);
      if (success) {
        await renderJourneySection(currentCompetition, currentUser.uid);
      }
    }
    hideModal();
  });
  
  // Close modal when clicking outside
  window.addEventListener('click', (event) => {
    if (event.target === modal) {
      hideModal();
    }
  });
  
  // Updated task action handler
  async function handleTaskAction(taskId) {
    if (!currentUser) {
      alert("Please sign in to complete tasks");
      return;
    }
    
    // Find the task description
    const competitionData = getDefaultCompetitionData(currentCompetition);
    let taskDescription = '';
    
    // Search through all stages to find the task
    for (const stage of Object.values(competitionData.stages)) {
      const task = stage.tasks.find(t => t.id === taskId);
      if (task) {
        taskDescription = task.description;
        break;
      }
    }
    
    showModal(taskId, taskDescription);
  }


  async function initApp() {
    await renderJourneySection(currentCompetition, currentUser.uid);
    initSearch();
  }

  // Competition data functions
  async function getCompetitionData(competitionName) {
    try {
      const doc = await db.collection('competitions').doc(competitionName.toLowerCase()).get();
      return doc.exists ? doc.data() : getDefaultCompetitionData(competitionName);
    } catch (error) {
      console.error("Error fetching competition data:", error);
      return getDefaultCompetitionData(competitionName);
    }
  }

  async function getUserJourneyProgress(userId, competitionName) {
    try {
      const doc = await db.collection('userProgress').doc(`${userId}_${competitionName.toLowerCase()}`).get();
      if (doc.exists) return doc.data();
      
      // Create default progress if doesn't exist
      const defaultProgress = {
        currentStage: 'get_started',
        completedTasks: [],
        stageProgress: {
          get_started: { completed: 0, total: 4 },
          budding_competitor: { completed: 0, total: 5 },
          novice_competitor: { completed: 0, total: 6 },
          master_competitor: { completed: 0, total: 4 }
        }
      };
      
      await db.collection('userProgress').doc(`${userId}_${competitionName.toLowerCase()}`).set(defaultProgress);
      return defaultProgress;
    } catch (error) {
      console.error("Error fetching user progress:", error);
      return {
        currentStage: 'get_started',
        completedTasks: [],
        stageProgress: {
          get_started: { completed: 0, total: 4 },
          budding_competitor: { completed: 0, total: 5 },
          novice_competitor: { completed: 0, total: 6 },
          master_competitor: { completed: 0, total: 4 }
        }
      };
    }
  }

  async function updateTaskProgress(userId, competitionName, taskId, isComplete) {
    try {
      const progressRef = db.collection('userProgress').doc(`${userId}_${competitionName.toLowerCase()}`);
      const progress = await getUserJourneyProgress(userId, competitionName);
      
      let updatedTasks = [...progress.completedTasks];
      const stageId = getTaskStage(competitionName, taskId);
      
      if (isComplete && !updatedTasks.includes(taskId)) {
        updatedTasks.push(taskId);
      } else if (!isComplete) {
        updatedTasks = updatedTasks.filter(id => id !== taskId);
      }
      
      // Update stage progress counts
      const updatedStageProgress = {...progress.stageProgress};
      if (stageId) {
        updatedStageProgress[stageId].completed = updatedTasks.filter(id => 
          getTaskStage(competitionName, id) === stageId
        ).length;
      }
      
      // Update current stage if needed
      let currentStage = progress.currentStage;
      const stageOrder = ['get_started', 'budding_competitor', 'novice_competitor', 'master_competitor'];
      const currentStageIndex = stageOrder.indexOf(currentStage);
      
      if (currentStageIndex < stageOrder.length - 1) {
        const nextStage = stageOrder[currentStageIndex + 1];
        if (updatedStageProgress[currentStage].completed === updatedStageProgress[currentStage].total) {
          currentStage = nextStage;
        }
      }
      
      await progressRef.update({
        completedTasks: updatedTasks,
        stageProgress: updatedStageProgress,
        currentStage: currentStage
      });
      
      return true;
    } catch (error) {
      console.error("Error updating task progress:", error);
      return false;
    }
  }

  function getTaskStage(competitionName, taskId) {
    const data = getDefaultCompetitionData(competitionName);
    for (const [stageId, stage] of Object.entries(data.stages)) {
      if (stage.tasks.some(task => task.id === taskId)) {
        return stageId;
      }
    }
    return null;
  }

  // Default competition data fallback
  function getDefaultCompetitionData(competitionName) {
    return {
      displayName: competitionName.charAt(0).toUpperCase() + competitionName.slice(1),
      description: `Master ${competitionName.toLowerCase()} concepts through structured competition preparation.`,
      stages: {
        get_started: {
          tasks: [
            {
              id: "first_practice_test",
              description: "Complete your first FBLA practice test",
              actionButton: "Take Test"
            },
            {
              id: "meet_advisor",
              description: "Meet with your FBLA chapter advisor",
              actionButton: "Schedule Meeting"
            },
            {
              id: "join_committee",
              description: "Join an FBLA competition committee",
              actionButton: "Join Committee"
            },
            {
              id: "basic_rules",
              description: "Learn basic competition rules and guidelines",
              actionButton: "Study Guide"
            }
          ]
        },
        budding_competitor: {
          tasks: [
            {
              id: "score_50_percent",
              description: "Score above 50% on a practice test",
              actionButton: "Take Test"
            },
            {
              id: "complete_20_questions",
              description: "Answer 20 practice questions correctly",
              actionButton: "Practice Now"
            },
            {
              id: "attend_3_workshops",
              description: "Attend 3 competition prep workshops",
              actionButton: "View Schedule"
            },
            {
              id: "event_strategies",
              description: "Learn strategies for your chosen event",
              actionButton: "Study Materials"
            },
            {
              id: "first_competition",
              description: "Compete in your first FBLA event",
              actionButton: "Register"
            }
          ]
        },
        novice_competitor: {
          tasks: [
            {
              id: "score_70_percent",
              description: "Score above 70% on a practice test",
              actionButton: "Take Test"
            },
            {
              id: "complete_50_questions",
              description: "Answer 50 practice questions correctly",
              actionButton: "Practice Now"
            },
            {
              id: "lead_3_sessions",
              description: "Lead 3 study sessions for competitors",
              actionButton: "Schedule Session"
            },
            {
              id: "advanced_strategies",
              description: "Master advanced competition strategies",
              actionButton: "Study Guide"
            },
            {
              id: "place_top_10",
              description: "Place in top 10 at a competition",
              actionButton: "View Results"
            },
            {
              id: "mentor_3_members",
              description: "Mentor 3 new FBLA competitors",
              actionButton: "Connect"
            }
          ]
        },
        master_competitor: {
          tasks: [
            {
              id: "score_90_percent",
              description: "Score 90%+ on advanced practice tests",
              actionButton: "Take Test"
            },
            {
              id: "win_competition",
              description: "Win a regional/state competition",
              actionButton: "View Events"
            },
            {
              id: "train_5_competitors",
              description: "Train 5 competitors to competition level",
              actionButton: "Start Training"
            },
            {
              id: "create_materials",
              description: "Create competition study materials",
              actionButton: "Create Content"
            }
          ]
        }
      }
    };
  }

  // UI Rendering functions
  async function renderJourneySection(competitionName, userId) {
    const competitionData = await getCompetitionData(competitionName);
    const userProgress = await getUserJourneyProgress(userId, competitionName);
    
    if (!competitionData || !userProgress) return;

    const journeyHTML = `
      <h2>Your FBLA Journey</h2>
      <p class="journey-description">
        ${competitionData.description}
      </p>

      <div class="progress-wrapper">
        ${generateStageHTML('get_started', 'Get Started', 'Complete your initial foundation', competitionData.stages.get_started, userProgress, 'üöÄ')}
        ${generateStageHTML('budding_competitor', 'Budding Competitor', 'Build your knowledge and start competing', competitionData.stages.budding_competitor, userProgress, '‚≠ê')}
        ${generateStageHTML('novice_competitor', 'Novice Competitor', 'Advance your skills and compete regularly', competitionData.stages.novice_competitor, userProgress, 'üèÖ')}
        ${generateStageHTML('master_competitor', 'Master Competitor', 'Achieve mastery and mentor others', competitionData.stages.master_competitor, userProgress, 'üëë')}
      </div>
    `;

    const container = document.querySelector('.journey-card');
    if (container) {
      container.innerHTML = journeyHTML;
      
      // Add event listeners for expandable sections
      document.querySelectorAll('.step-header').forEach(header => {
        header.addEventListener('click', () => toggleStep(header));
      });
    }
  }

function generateStageHTML(stageId, title, subtitle, stageData, userProgress, emoji) {
  const isCompleted = userProgress.stageProgress[stageId].completed === userProgress.stageProgress[stageId].total;
  const isCurrent = userProgress.currentStage === stageId;
  const isLocked = !isCompleted && !isCurrent && !isPreviousStageCompleted(stageId, userProgress);
  
  const stageClass = isCompleted ? 'completed' : isCurrent ? 'active' : isLocked ? 'locked' : '';
  const progressPercent = Math.round((userProgress.stageProgress[stageId].completed / userProgress.stageProgress[stageId].total) * 100);

  return `
    <div class="journey-step ${stageClass} ${isCurrent ? 'expanded' : ''}">
      <div class="step-header">
        <div class="emoji-marker">${isCompleted ? '‚úÖ' : isLocked ? 'üîí' : emoji}</div>
        <div class="step-info">
          <div class="step-title">${title}</div>
          <div class="step-subtitle">${subtitle}</div>
        </div>
        ${!isLocked ? `
          <div class="progress-text">${userProgress.stageProgress[stageId].completed}/${userProgress.stageProgress[stageId].total}</div>
          <span class="chevron"><i class="fas fa-chevron-${isCurrent ? 'up' : 'down'}"></i></span>
        ` : ''}
      </div>
      
      ${!isLocked ? `
        <div class="step-content">
          <div class="progress-indicator">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progressPercent}%;"></div>
            </div>
          </div>
          
          <div class="tasks-container">
            ${generateTasksHTML(stageData.tasks, userProgress.completedTasks)}
          </div>
        </div>
      ` : ''}
    </div>
  `;
}

  function generateTasksHTML(tasks, completedTasks) {
    return tasks.map(task => {
      const isCompleted = completedTasks.includes(task.id);
      
      return `
        <div class="task-row ${isCompleted ? 'completed' : ''}" data-task-id="${task.id}">

          <span class="task-description">${task.description}</span>
          ${task.actionButton ? `
            <button class="task-action" onclick="handleTaskAction('${task.id}')">
              ${task.actionButton}
            </button>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  function isPreviousStageCompleted(currentStageId, userProgress) {
    const stageOrder = ['get_started', 'budding_competitor', 'novice_competitor', 'master_competitor'];
    const currentIndex = stageOrder.indexOf(currentStageId);
    
    if (currentIndex === 0) return true;
    
    const previousStage = stageOrder[currentIndex - 1];
    return userProgress.stageProgress[previousStage].completed === userProgress.stageProgress[previousStage].total;
  }

  function toggleStep(header) {
    const step = header.closest('.journey-step');
    if (step.classList.contains('locked')) return;
    
    step.classList.toggle('expanded');
    const chevron = header.querySelector('.chevron i');
    if (chevron) {
      chevron.classList.toggle('fa-chevron-up');
      chevron.classList.toggle('fa-chevron-down');
    }
  }

 

  // Search functionality
  function initSearch() {
    const searchBox = document.getElementById('navbarSearch');
    const searchDropdown = document.getElementById('searchDropdown');
    
    if (!searchBox || !searchDropdown) return;

    searchBox.addEventListener('input', debounce(async function(e) {
      const query = e.target.value.trim();
      if (!query) {
        searchDropdown.style.display = 'none';
        return;
      }
      
      try {
        // Replace with your actual search implementation
        const results = await mockSearch(query);
        
        if (!results.length) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '<div class="dropdown-item">No results found</div>';
          return;
        }
        
        searchDropdown.innerHTML = results.map(item => `
          <div class="dropdown-item" data-id="${item.id}">
            <div class="dropdown-item-title">${item.title}</div>
            <div class="dropdown-item-description">${item.description}</div>
          </div>
        `).join('');
        
        searchDropdown.style.display = 'block';
        
        // Add click handlers
        document.querySelectorAll('.dropdown-item').forEach(item => {
          item.addEventListener('click', () => {
            searchBox.value = item.querySelector('.dropdown-item-title').textContent;
            searchDropdown.style.display = 'none';
            // Navigate to selected item
            console.log("Selected:", item.dataset.id);
          });
        });
      } catch (error) {
        console.error("Search error:", error);
        searchDropdown.style.display = 'none';
      }
    }, 300));

    // Hide dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
        searchDropdown.style.display = 'none';
      }
    });
  }

  // Mock search function - replace with your actual search implementation
  async function mockSearch(query) {
    return [
      { id: '1', title: 'FBLA Competition Guidelines', description: 'Official rules and regulations' },
      { id: '2', title: 'Business Math Practice Tests', description: 'Sample questions and solutions' },
      { id: '3', title: 'Public Speaking Tips', description: 'How to prepare for presentation events' }
    ].filter(item => 
      item.title.toLowerCase().includes(query.toLowerCase()) || 
      item.description.toLowerCase().includes(query.toLowerCase())
    );
  }

  // Utility function
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    // If user is already logged in when page loads
    if (currentUser) {
      initApp();
    }
  });

  async function loadCompetitionName() {
  try {
    const user = firebase.auth().currentUser;
    
    if (!user) {
      console.log('No user authenticated, waiting...');
      return;
    }
    
    const userId = user.uid;
    console.log('üî• Loading competition for user:', userId);
    
    // Get user document
    const userDoc = await db.collection('users').doc(userId).get();
    
    if (!userDoc.exists) {
      console.log('User document not found');
      document.getElementById('comp').textContent = 'User not found';
      return;
    }
    
    const userData = userDoc.data();
    const competitions = userData.competitions;
    
    // DEBUG: Log the entire competitions array
    console.log('üîç DEBUG - Full competitions array:', competitions);
    console.log('üîç DEBUG - Type of first competition:', typeof competitions[0]);
    console.log('üîç DEBUG - First competition value:', competitions[0]);
    
    if (!competitions || competitions.length === 0) {
      document.getElementById('comp').textContent = 'No competition assigned';
      return;
    }
    
    const competitionValue = competitions[0];
    
    // If it looks like a name string, use it directly
    if (typeof competitionValue === 'string' && competitionValue.length > 0) {
      console.log('‚úÖ Using competition name directly:', competitionValue);
      document.getElementById('comp').textContent = competitionValue;
      return;
    }
    
    // Otherwise try to look it up as a document ID
    console.log('üî• Looking for competition as document ID:', competitionValue);
    const competitionDoc = await db.collection('competitions').doc(competitionValue).get();
    
    if (!competitionDoc.exists) {
      console.log('‚ùå Competition document not found:', competitionValue);
      document.getElementById('comp').textContent = 'Competition not found';
      return;
    }
    
    const competitionData = competitionDoc.data();
    const competitionName = competitionData.name || 'Unnamed Competition';
    
    console.log('‚úÖ Found competition name:', competitionName);
    document.getElementById('comp').textContent = competitionName;
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    document.getElementById('comp').textContent = 'Error loading';
  }
}

// Add this function to your existing script
async function updateCurrentUserProfile() {
    const user = firebase.auth().currentUser;
    if (!user) return;
    
    try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (!userDoc.exists) return;
        
        const userData = userDoc.data();
        const name = userData.name || 'Unknown User';
        const createdAt = userData.createdAt;
        
        // Format creation date
        let memberSince = 'Unknown';
        if (createdAt) {
            if (createdAt.toDate) {
                memberSince = formatDate(createdAt.toDate());
            } else if (createdAt instanceof Date) {
                memberSince = formatDate(createdAt);
            } else if (typeof createdAt === 'string') {
                const date = new Date(createdAt);
                memberSince = formatDate(date);
            }
        }
        
        // Update the profile card elements
        const profileNameElement = document.querySelector('.profile-card .profile-name');
        const profileMetaElement = document.querySelector('.profile-card .profile-meta');
        
        if (profileNameElement) {
            profileNameElement.textContent = name;
        }
        
        if (profileMetaElement) {
            profileMetaElement.textContent = `He/Him ¬∑ Member since ${memberSince}`;
        }
        
    } catch (error) {
        console.error('Error updating profile:', error);
    }
}

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadCompetitionName();
    updateCurrentUserProfile(); 
  }
});

  // Make functions available globally
  window.handleTaskAction = handleTaskAction;

  function refreshLeaderboard() {
  const activeTab = document.querySelector('.tabs button.active');
  const timeframe = activeTab ? activeTab.textContent.toLowerCase().replace(' ', '') : 'week';
  showLoadingState();
  loadLeaderboard(timeframe);
}
function openNotificationsOnHome() {
    // Set a flag in sessionStorage (gets cleared when browser is closed)
    sessionStorage.setItem('openNotifications', 'true');
    // Navigate to home page - CHANGE THIS PATH to match your structure
    window.location.href = 'public/home.html';
}

function formatDate(date) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                   'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    
    return `${month} ${year}`;
}

// Function to get user's initials for avatar
function getInitials(name) {
    return name
        .split(' ')
        .map(word => word.charAt(0).toUpperCase())
        .join('')
        .substring(0, 2);
}

// Function to create user card HTML
function createUserCard(userData) {
    const name = userData.name || 'Unknown User';
    const email = userData.email || 'No email';
    const createdAt = userData.createdAt;
    const isMentor = userData.isMentor || false;
    const mentorCompetition = userData.mentorCompetition || '';
    const studyGoalSet = userData.studyGoalSet || false;
    const countedInMembers = userData.countedInMembers || false;
    
    // Format creation date
    let memberSince = 'Unknown';
    if (createdAt) {
        if (createdAt.toDate) {
            memberSince = formatDate(createdAt.toDate());
        } else if (createdAt instanceof Date) {
            memberSince = formatDate(createdAt);
        } else if (typeof createdAt === 'string') {
            const date = new Date(createdAt);
            memberSince = formatDate(date);
        }
    }
    
    const initials = getInitials(name);
    const roleText = isMentor ? 'Mentor' : 'Member';
    const roleClass = isMentor ? 'mentor' : 'member';
    
    return `
        <div class="user-card">
            <div class="profile-header">
                <div class="profile-avatar">${initials}</div>
                <div class="profile-info">
                    <div class="profile-name">${name}</div>
                    <div class="profile-meta">
                        ${email} ¬∑ ${roleText} since ${memberSince}
                        <span class="badge ${roleClass}">${roleText}</span>
                    </div>
                </div>
            </div>
            
            ${isMentor ? `
                <div class="mentor-info">
                    <strong>Mentor for:</strong> ${mentorCompetition || 'Not assigned'}
                </div>
            ` : ''}
            
            <div class="profile-stats">
                <div class="stat">
                    <span class="stat-value">${studyGoalSet ? 'Yes' : 'No'}</span>
                    <span class="stat-label">Study Goal</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${countedInMembers ? 'Active' : 'Inactive'}</span>
                    <span class="stat-label">Status</span>
                </div>
                <div class="stat">
                    <span class="stat-value">${isMentor ? 'Mentor' : 'Student'}</span>
                    <span class="stat-label">Role</span>
                </div>
            </div>
        </div>
    `;
}

// Function to display all users
async function displayAllUsers() {
    const usersContainer = document.getElementById('users-container');
    const loadingElement = document.getElementById('loading');
    
    try {
        // Show loading
        if (loadingElement) {
            loadingElement.style.display = 'block';
        }
        
        // Fetch all users from Firebase
        const usersSnapshot = await db.collection('users').get();
        
        if (usersSnapshot.empty) {
            usersContainer.innerHTML = '<p>No users found.</p>';
            return;
        }
        
        let usersHTML = '';
        let userCount = 0;
        let mentorCount = 0;
        let activeCount = 0;
        
        // Process each user document
        usersSnapshot.forEach((doc) => {
            const userData = doc.data();
            usersHTML += createUserCard(userData);
            
            userCount++;
            if (userData.isMentor) mentorCount++;
            if (userData.countedInMembers) activeCount++;
        });
        
         
        
        // Hide loading
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
        
    } catch (error) {
        console.error('Error fetching users:', error);
        usersContainer.innerHTML = `
            <div class="error">
                <h3>Error Loading Users</h3>
                <p>Could not fetch user data. Please try again later.</p>
                <p>Error: ${error.message}</p>
            </div>
        `;
        
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }
    }
}

// Function to filter users
function filterUsers(filterType) {
    const userCards = document.querySelectorAll('.user-card');
    
    userCards.forEach(card => {
        const badge = card.querySelector('.badge');
        const isVisible = 
            filterType === 'all' || 
            (filterType === 'mentors' && badge.classList.contains('mentor')) ||
            (filterType === 'members' && badge.classList.contains('member'));
        
        card.style.display = isVisible ? 'block' : 'none';
    });
}

// Function to search users by name
function searchUsers(searchTerm) {
    const userCards = document.querySelectorAll('.user-card');
    const term = searchTerm.toLowerCase();
    
    userCards.forEach(card => {
        const name = card.querySelector('.profile-name').textContent.toLowerCase();
        const email = card.querySelector('.profile-meta').textContent.toLowerCase();
        const isVisible = name.includes(term) || email.includes(term);
        
        card.style.display = isVisible ? 'block' : 'none';
    });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    displayAllUsers();
    
    // Add event listeners for filters if they exist
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const filterType = btn.dataset.filter;
            filterUsers(filterType);
            
            // Update active button
            filterButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });
    
    // Add event listener for search if it exists
    const searchInput = document.getElementById('user-search');
    if (searchInput) {
        searchInput.addEventListener('input', (e) => {
            searchUsers(e.target.value);
        });
    }
});

// Function to refresh user data
function refreshUsers() {
    displayAllUsers();
}

// Auto-refresh every 30 seconds (optional)
setInterval(refreshUsers, 30000);

</script>
</body>
</html>
