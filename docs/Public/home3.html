<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FBLAZE  Dashboard</title>
  <link rel="stylesheet" href="home3.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
  authDomain: "certquest-94959.firebaseapp.com",
  projectId: "certquest-94959",
  storageBucket: "certquest-94959.firebasestorage.app",
  messagingSenderId: "323956529033",
  appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
  measurementId: "G-F5JHTGGN6K"
};
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
</script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>
  
  <style>
    /* Speaking Assignment Modal Styles - Matching React Design */
    .cq-speaking-modal {
      position: fixed;
      z-index: 3100;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: #020617; /* slate-950 */
      color: white;
      overflow: hidden;
    }
    
    /* Star Field Background */
    .cq-speaking-stars {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .cq-speaking-star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle linear infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.9; }
    }
    .cq-speaking-glow-1 {
      position: absolute;
      top: 5rem;
      left: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    .cq-speaking-glow-2 {
      position: absolute;
      bottom: 0;
      right: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    
    .cq-speaking-modal-content {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
    }
    
    .cq-speaking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30, 41, 59, 0.3); /* slate-800/30 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }
    .cq-speaking-title {
      font-size: 1.875rem; /* text-3xl */
      font-weight: 700;
      color: #f97316; /* orange-500 */
      margin: 0;
    }
    .cq-speaking-close {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: #f97316; /* orange-500 */
      color: white;
      border: none;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
    }
    .cq-speaking-close:hover {
      background: #ea580c; /* orange-600 */
    }
    
    .cq-speaking-main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 0;
    }
    
    .cq-speaking-questions {
      display: flex;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-speaking-question-card {
      flex: 1;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700 */
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .cq-speaking-question-label {
      font-size: 0.75rem; /* text-xs */
      font-weight: 600;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.25rem;
    }
    .cq-speaking-question-text {
      font-size: 0.875rem; /* text-sm */
      color: white;
      line-height: 1.5;
    }
    
    .cq-speaking-video-container {
      flex: 1;
      position: relative;
      border-radius: 1rem; /* rounded-2xl */
      overflow: hidden;
      border: 2px solid rgba(249, 115, 22, 0.3); /* border-orange-500/30 */
      background: #000;
      min-height: 0;
    }
    .cq-speaking-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cq-speaking-no-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1rem;
    }
    
    /* Recording Indicator */
    .cq-speaking-recording-indicator {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      backdrop-filter: blur(8px);
      font-size: 0.75rem;
    }
    .cq-speaking-recording-indicator.active {
      display: flex;
    }
    .cq-speaking-recording-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .cq-speaking-recording-text {
      font-weight: 600;
      color: #fca5a5; /* red-400 */
    }
    
    .cq-speaking-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-speaking-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }
    .cq-speaking-control-btn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: rgba(30, 41, 59, 0.4); /* slate-800/40 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #94a3b8; /* slate-400 */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1.25rem;
    }
    .cq-speaking-control-btn:hover {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #cbd5e1; /* slate-300 */
    }
    .cq-speaking-record-btn {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background: linear-gradient(to right, #f97316, #ef4444); /* orange-500 to red-500 */
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
      font-size: 2rem;
      font-weight: 600;
    }
    .cq-speaking-record-btn:hover {
      box-shadow: 0 0 30px rgba(249, 115, 22, 0.7);
    }
    .cq-speaking-record-btn.recording {
      background: #ef4444; /* red-500 */
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
    
    .cq-speaking-submit-btn {
      padding: 0.5rem 2.5rem;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700 */
      border-radius: 0.5rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1rem;
    }
    .cq-speaking-submit-btn:hover:not(:disabled) {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
    }
    .cq-speaking-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Case Study Assignment Modal Styles - Matching React Design */
    .cq-case-study-modal {
      position: fixed;
      z-index: 3100;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: #020617; /* slate-950 */
      color: white;
      overflow: hidden;
    }
    
    /* Star Field Background */
    .cq-case-study-stars {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .cq-case-study-star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: cq-case-study-twinkle linear infinite;
    }
    @keyframes cq-case-study-twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.9; }
    }
    .cq-case-study-glow-1 {
      position: absolute;
      top: 5rem;
      left: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    .cq-case-study-glow-2 {
      position: absolute;
      bottom: 0;
      right: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    
    .cq-case-study-modal-content {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
    }
    
    .cq-case-study-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30, 41, 59, 0.3); /* slate-800/30 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }
    .cq-case-study-title {
      font-size: 1.875rem; /* text-3xl */
      font-weight: 700;
      color: #f97316; /* orange-500 */
      margin: 0;
    }
    .cq-case-study-header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .cq-case-study-timer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      backdrop-filter: blur(8px);
    }
    .cq-case-study-timer:hover {
      border-color: rgba(249, 115, 22, 0.3); /* orange-500/30 */
    }
    .cq-case-study-timer.active {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }
    .cq-case-study-timer-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: #f97316; /* orange-500 */
      transition: all 0.2s;
    }
    .cq-case-study-timer.active .cq-case-study-timer-dot {
      background: #ef4444; /* red-500 */
      animation: cq-case-study-pulse-dot 1.5s ease-in-out infinite;
    }
    @keyframes cq-case-study-pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .cq-case-study-timer-text {
      font-size: 0.875rem;
      font-family: monospace;
      font-weight: 600;
      color: #cbd5e1; /* slate-300 */
    }
    .cq-case-study-timer.active .cq-case-study-timer-text {
      color: #fca5a5; /* red-400 */
    }
    .cq-case-study-timer-start {
      font-size: 0.75rem;
      color: #94a3b8; /* slate-400 */
      margin-left: 0.25rem;
    }
    .cq-case-study-timer.active .cq-case-study-timer-start {
      display: none;
    }
    .cq-case-study-close {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: #f97316; /* orange-500 */
      color: white;
      border: none;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
    }
    .cq-case-study-close:hover {
      background: #ea580c; /* orange-600 */
    }
    
    .cq-case-study-main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 0;
    }
    
    .cq-case-study-top-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-info-card {
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 1rem;
      backdrop-filter: blur(8px);
    }
    .cq-case-study-info-card.cq-case-study-clickable {
      cursor: pointer;
      transition: all 0.2s;
    }
    .cq-case-study-info-card.cq-case-study-clickable:hover {
      border-color: rgba(249, 115, 22, 0.3); /* orange-500/30 */
    }
    .cq-case-study-info-label {
      font-size: 0.75rem;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.25rem;
    }
    .cq-case-study-info-value {
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
    }
    .cq-case-study-info-preview {
      font-size: 0.75rem;
      color: white;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: color 0.2s;
    }
    .cq-case-study-clickable:hover .cq-case-study-info-preview {
      color: #fb923c; /* orange-400 */
    }
    .cq-case-study-read-more {
      font-size: 0.75rem;
      color: #fb923c; /* orange-400 */
      margin-top: 0.5rem;
    }
    
    .cq-case-study-expanded-content {
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 1.5rem;
      backdrop-filter: blur(8px);
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .cq-case-study-expanded-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }
    .cq-case-study-expanded-label {
      font-size: 0.875rem;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.25rem;
    }
    .cq-case-study-expanded-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: white;
    }
    .cq-case-study-expanded-close {
      color: #94a3b8; /* slate-400 */
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      transition: color 0.2s;
      padding: 0;
      width: 1.25rem;
      height: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cq-case-study-expanded-close:hover {
      color: #fb923c; /* orange-400 */
    }
    .cq-case-study-full-content {
      font-size: 0.875rem;
      color: white;
      line-height: 1.75;
      flex: 1;
    }
    
    .cq-case-study-video-container {
      flex: 1;
      position: relative;
      border-radius: 1rem; /* rounded-2xl */
      overflow: hidden;
      border: 2px solid rgba(249, 115, 22, 0.3); /* border-orange-500/30 */
      background: #000;
      min-height: 0;
    }
    .cq-case-study-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cq-case-study-no-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1rem;
    }
    
    /* Recording Indicator */
    .cq-case-study-recording-indicator {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      backdrop-filter: blur(8px);
      font-size: 0.75rem;
    }
    .cq-case-study-recording-indicator.active {
      display: flex;
    }
    .cq-case-study-recording-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: #ef4444;
      border-radius: 50%;
      animation: cq-case-study-pulse-dot 1.5s ease-in-out infinite;
    }
    .cq-case-study-recording-text {
      font-weight: 600;
      color: #fca5a5; /* red-400 */
    }
    
    .cq-case-study-bottom-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-question-card {
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      border-radius: 0.5rem;
      padding: 0.75rem;
      backdrop-filter: blur(8px);
    }
    .cq-case-study-question-label {
      font-size: 0.75rem;
      color: #94a3b8; /* slate-400 */
      margin-bottom: 0.5rem;
    }
    .cq-case-study-question-text {
      font-size: 0.75rem;
      color: white;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .cq-case-study-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }
    .cq-case-study-control-btn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: rgba(30, 41, 59, 0.4); /* slate-800/40 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #94a3b8; /* slate-400 */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1.25rem;
    }
    .cq-case-study-control-btn:hover {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
      color: #cbd5e1; /* slate-300 */
    }
    .cq-case-study-record-btn {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background: linear-gradient(to right, #f97316, #ef4444); /* orange-500 to red-500 */
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
      font-size: 2rem;
      font-weight: 600;
    }
    .cq-case-study-record-btn:hover {
      box-shadow: 0 0 30px rgba(249, 115, 22, 0.7);
    }
    .cq-case-study-record-btn.recording {
      background: #ef4444; /* red-500 */
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
    
    .cq-case-study-submit-btn {
      padding: 0.5rem 2.5rem;
      background: rgba(30, 41, 59, 0.5); /* slate-800/50 */
      border: 1px solid rgba(51, 65, 85, 0.5); /* slate-700 */
      border-radius: 0.5rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1rem;
    }
    .cq-case-study-submit-btn:hover:not(:disabled) {
      background: rgba(51, 65, 85, 0.5); /* slate-700/50 */
    }
    .cq-case-study-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Practice Quiz Fullscreen Modal Styles */
    .practice-quiz-fullscreen {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display: none;
      flex-direction: column;
      min-height: 100vh;
      overflow-y: auto;
      color: #fff;
    }

    .practice-quiz-fullscreen[style*="display: flex"] {
      display: flex !important;
    }

    .practice-quiz-fullscreen[style*="display: block"] {
      display: flex !important;
    }

    /* Galaxy Background */
    .practice-quiz-galaxy-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: #000;
      overflow: hidden;
    }

    .practice-quiz-galaxy-gradient {
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom right, #0f172a 0%, #000 50%, rgba(88, 28, 135, 0.1) 100%);
    }

    .practice-quiz-stars-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 1;
    }

    .practice-quiz-star {
      position: absolute;
      border-radius: 50%;
      background: #fff;
      pointer-events: none;
      z-index: 2;
    }

    @keyframes practice-quiz-twinkle {
      0%, 100% { opacity: 0.1; }
      50% { opacity: 0.8; }
    }

    .practice-quiz-nebula {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }

    .practice-quiz-nebula-1 {
      top: 0;
      left: 25%;
      width: 500px;
      height: 500px;
      background: rgba(147, 51, 234, 0.05);
    }

    .practice-quiz-nebula-2 {
      top: 33%;
      right: 0;
      width: 600px;
      height: 600px;
      background: rgba(37, 99, 235, 0.05);
    }

    .practice-quiz-nebula-3 {
      bottom: 0;
      left: 50%;
      width: 500px;
      height: 500px;
      background: rgba(6, 182, 212, 0.05);
    }

    /* Top Bar */
    .practice-quiz-topbar {
      position: sticky;
      z-index: 10001;
      border-bottom: 1px solid rgba(127, 29, 29, 0.3);
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(40px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      top: 0;
    }

    .practice-quiz-topbar-content {
      max-width: 80rem;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .practice-quiz-topbar-title {
      font-size: 1.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .practice-quiz-topbar-subtitle {
      color: #94a3b8;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .practice-quiz-topbar-right {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .practice-quiz-timer-section {
      text-align: center;
    }

    .practice-quiz-timer-label {
      color: #94a3b8;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0;
    }

    .practice-quiz-timer-value {
      color: #fb923c;
      font-size: 1.5rem;
      font-weight: 900;
      margin: 0;
    }

    .practice-quiz-close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      border-radius: 0.5rem;
    }

    .practice-quiz-close-btn:hover {
      color: #fb923c;
      background: rgba(251, 146, 60, 0.1);
    }

    /* Main Content */
    .practice-quiz-main {
      position: relative;
      z-index: 1;
      max-width: 80rem;
      margin: 0 auto;
      padding: 3rem 2rem;
      flex: 1;
    }

    .practice-quiz-competency-badge {
      display: inline-block;
      background: rgba(220, 38, 38, 0.3);
      border: 1px solid rgba(220, 38, 38, 0.5);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      margin-bottom: 3rem;
    }

    .practice-quiz-competency-text {
      color: #fca5a5;
      font-weight: 900;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .practice-quiz-question-section {
      margin-bottom: 4rem;
    }

    .practice-quiz-question {
      font-size: 3rem;
      font-weight: 900;
      color: #fff;
      margin-bottom: 1rem;
      line-height: 1.2;
    }

    .practice-quiz-question-hint {
      color: #94a3b8;
      font-size: 1rem;
    }

    .practice-quiz-options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 4rem;
    }

    .practice-quiz-option-btn {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 1.5rem;
      border-radius: 1rem;
      border: 2px solid rgba(71, 85, 105, 0.5);
      background: rgba(30, 41, 59, 0.3);
      color: #fff;
      font-weight: 700;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      transform: scale(1);
    }

    .practice-quiz-option-btn:hover {
      transform: scale(1.02);
      border-color: rgba(251, 146, 60, 0.5);
      background: rgba(251, 146, 60, 0.1);
    }

    .practice-quiz-option-btn.selected {
      background: linear-gradient(to right, rgba(220, 38, 38, 0.4), rgba(249, 115, 22, 0.3));
      border-color: rgba(239, 68, 68, 0.7);
    }

    .practice-quiz-option-radio {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      border: 3px solid rgba(71, 85, 105, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .practice-quiz-option-btn.selected .practice-quiz-option-radio {
      border-color: #dc2626;
      background: #dc2626;
    }

    .practice-quiz-option-dot {
      width: 0.75rem;
      height: 0.75rem;
      background: #fff;
      border-radius: 50%;
    }

    .practice-quiz-option-text {
      color: #fff;
      font-weight: 700;
      font-size: 1.125rem;
    }

    .practice-quiz-progress-section {
      margin-bottom: 3rem;
    }

    .practice-quiz-progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .practice-quiz-progress-label {
      color: #94a3b8;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
      margin: 0;
    }

    .practice-quiz-progress-value {
      color: #94a3b8;
      font-size: 0.875rem;
      margin: 0;
    }

    .practice-quiz-progress-bar {
      width: 100%;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 9999px;
      height: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(71, 85, 105, 0.5);
    }

    .practice-quiz-progress-fill {
      background: linear-gradient(to right, #dc2626, #f97316);
      height: 100%;
      transition: width 0.5s;
      border-radius: 9999px;
    }

    .practice-quiz-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .practice-quiz-prev-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #94a3b8;
      background: none;
      border: none;
      font-weight: 900;
      cursor: pointer;
      transition: color 0.2s;
      padding: 0.5rem;
    }

    .practice-quiz-prev-btn:hover:not(:disabled) {
      color: #fff;
    }

    .practice-quiz-prev-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .practice-quiz-next-btn,
    .practice-quiz-submit-btn {
      background: linear-gradient(to right, #dc2626, #f97316);
      border: none;
      color: #fff;
      font-weight: 900;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      transform: scale(1);
    }

    .practice-quiz-next-btn:hover,
    .practice-quiz-submit-btn:hover {
      background: linear-gradient(to right, #b91c1c, #ea580c);
      transform: scale(1.05);
    }

    /* Congratulations Modal Styles */
    .congrats-content {
      max-width: 80rem;
      margin: 0 auto;
      width: 100%;
      text-align: center;
    }

    .congrats-header {
      margin-bottom: 3rem;
    }

    .congrats-title {
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0 0 1rem 0;
      line-height: 1.2;
    }

    .congrats-subtitle {
      font-size: 1.5rem;
      color: #fff;
      margin: 0;
      font-weight: 500;
    }

    .congrats-subtitle span {
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 900;
    }

    .congrats-assignment-info {
      text-align: center;
      margin-bottom: 4rem;
    }

    .congrats-assignment-label {
      color: #94a3b8;
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
    }

    .congrats-assignment-name {
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .congrats-competencies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 4rem;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .congrats-competency-item {
      background: rgba(30, 41, 59, 0.3);
      border: 2px solid rgba(71, 85, 105, 0.5);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.2s;
      text-align: left;
    }

    .congrats-competency-item:hover {
      border-color: rgba(251, 146, 60, 0.5);
      background: rgba(251, 146, 60, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(251, 146, 60, 0.2);
    }

    .congrats-competency-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .congrats-competency-name {
      font-size: 1rem;
      font-weight: 900;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .congrats-competency-score {
      font-size: 1rem;
      font-weight: 700;
      color: #94a3b8;
    }

    .congrats-competency-progress-bar {
      width: 100%;
      height: 0.75rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 9999px;
      overflow: hidden;
      border: 1px solid rgba(71, 85, 105, 0.5);
    }

    .congrats-competency-progress-fill {
      height: 100%;
      background: linear-gradient(to right, #dc2626, #f97316);
      border-radius: 9999px;
      transition: width 0.5s;
    }

    .congrats-competency-progress-fill.full {
      background: linear-gradient(to right, #16a34a, #22c55e);
    }

    .congrats-actions {
      display: flex;
      justify-content: center;
      margin-top: 3rem;
    }

    @media (max-width: 768px) {
      .practice-quiz-question {
        font-size: 2rem;
      }
      
      .practice-quiz-topbar-content {
        padding: 1rem;
      }
      
      .practice-quiz-main {
        padding: 2rem 1rem;
      }
    }
    
    /* Force select elements to appear as dropdowns, not text inputs */
    select.comp-input,
    select.mentor-comp-input {
      appearance: menulist !important;
      -webkit-appearance: menulist !important;
      -moz-appearance: menulist !important;
      cursor: pointer !important;
      /* Match chapter input styling */
      background-color: rgba(127, 29, 29, 0.3) !important;
      border: 2px solid rgba(239, 68, 68, 0.5) !important;
      border-radius: 8px !important;
      color: #fff !important;
      /* Prevent any text input behavior */
      -webkit-user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      user-select: none !important;
    }
    
    /* Style select options */
    select.comp-input option,
    select.mentor-comp-input option {
      background-color: rgba(127, 29, 29, 0.3) !important;
      color: #fff !important;
    }
    
    select.comp-input option[value=""],
    select.mentor-comp-input option[value=""] {
      color: #fca5a5 !important;
    }
    
    /* Focus states to match chapter input */
    select.comp-input:focus,
    select.mentor-comp-input:focus {
      outline: none !important;
      border-color: #f97316 !important;
      background-color: rgba(127, 29, 29, 0.5) !important;
      box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.3) !important;
    }
    
    /* Ensure dropdown arrow is visible */
    select.comp-input::-ms-expand,
    select.mentor-comp-input::-ms-expand {
      display: block !important;
    }
    
    /* Make sure height matches chapter input */
    select.comp-input,
    select.mentor-comp-input {
      height: 48px !important;
      padding: 12px 16px !important;
      font-size: 16px !important;
    }
    
    /* Prevent any input elements from being created with these classes */
    input.comp-input,
    input.mentor-comp-input {
      display: none !important;
    }
    
    /* Force any element with these IDs to be a select */
    #comps:not(select),
    #mentorComp:not(select) {
      display: none !important;
    }
    
    /* Ensure selects cannot be made contenteditable */
    select.comp-input,
    select.mentor-comp-input {
      pointer-events: auto !important;
    }
  </style>

<script type="module" src="/js/firebase.js"></script></head>
<body>
  <!-- Galaxy Background -->
  <div class="galaxy-background">
    <div class="galaxy-gradient"></div>
    <div class="stars-container" id="starsContainer"></div>
    <div class="nebula nebula-1"></div>
    <div class="nebula nebula-2"></div>
    <div class="nebula nebula-3"></div>
  </div>

  <!-- Personality Modal -->
  <div id="personalityModal" class="personality-modal" style="display: none;">
    <div class="personality-modal-content">
      <h2 class="personality-title">Customize Your Duck</h2>
      <p class="personality-subtitle">How would you like your duck to help you study?</p>
      <div class="personality-grid">
        <button class="personality-option" onclick="selectPersonality('chill')">
          <div class="personality-emoji">ðŸ¦†</div>
          <h3 class="personality-name">Chill Duck</h3>
          <p class="personality-desc">Relaxed vibes, supportive energy</p>
        </button>
        <button class="personality-option orange" onclick="selectPersonality('grind')">
          <div class="personality-emoji">ðŸ¦†</div>
          <h3 class="personality-name">Grind Duck</h3>
          <p class="personality-desc">Competitive edge, no mercy</p>
        </button>
      </div>
    </div>
  </div>

  <!-- Locked In Mode -->
  <div id="lockedInOverlay" class="locked-in-overlay" style="display: none;">
    <div class="locked-in-content">
      <div class="locked-in-emoji">ðŸ”¥</div>
      <h2 class="locked-in-title">LOCKED IN MODE</h2>
      <p class="locked-in-subtitle">FOCUS. GRIND. DOMINATE.</p>
      <button class="locked-in-button" onclick="exitLockedIn()">FEATURE COMING SOON!</button>
    </div>
  </div>

  <!-- Header -->
  <div class="blaze-header">
    <div class="blaze-header-content">
      <div class="header-left">
        <button class="hamburger-menu" id="hamburgerMenu" onclick="toggleMobileNav()" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <h1 class="blaze-logo">FBLAZE</h1>
      </div>
      <h1 class="blaze-logo desktop-logo">FBLAZE</h1>
      <nav class="blaze-nav" id="mainNav">
        <button class="mobile-nav-close" onclick="toggleMobileNav()" aria-label="Close menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <a href="home3.html" class="nav-link">Home</a>
        <a href="javascript:void(0)" onclick="toggleNotificationPanel()" class="nav-link">
          Notifications
          <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="practice.html" class="nav-link">Practice</a>
        <a href="Forum/forum.html" class="nav-link">Forum</a>
        <a href="Calendar/calendar1.html" class="nav-link">Calendar</a>
        <a href="mentor1.html" class="nav-link" id="mentorNavLink" style="display: none;">Mentor</a>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Welcome & Duck Layout -->
    <div class="welcome-grid">
      <!-- Left - Welcome Text -->
      <div class="welcome-text">
        <p class="welcome-label">Welcome back</p>
        <h1 class="welcome-title">
          Ready to Blaze,<br />
          <span class="welcome-username" id="userName">User</span><span class="welcome-question-mark">?</span>
        </h1>
        <p class="welcome-meta">Level <span id="userLevel">8</span> â€¢ <span id="userXP">12,450</span> Total XP</p>
      </div>

      <!-- Center - 3D Duck -->
      <div class="duck-container" id="duckContainer">
        <div class="duck-wrapper" id="duckWrapper">
          <img src="assets/duck1.png" alt="Duck" class="duck-image" id="duckImage" />
        </div>
      </div>

      <!-- Right - Quick Stats -->
      <div class="quick-stats">
        <div class="stat-card">
          <p class="stat-label">Streak</p>
          <p class="stat-value red" id="userStreak">14</p>
        </div>
        <div class="stat-card orange">
          <p class="stat-label">Weekly XP</p>
          <p class="stat-value orange" id="weeklyXP">342</p>
        </div>
        <div class="stat-card yellow">
          <p class="stat-label">Rank</p>
          <p class="stat-value yellow" id="userRank">#47</p>
        </div>
      </div>
    </div>

    <!-- Daily Inspirational Quote -->
    <div class="duck-wisdom">
      <div class="wisdom-container">
        <div class="wisdom-glow"></div>
        <div class="wisdom-content">
          <p class="wisdom-quote" id="dailyQuote">"The only way to do great work is to love what you do."</p>
          <p class="wisdom-author" id="dailyQuoteAuthor">â€” Steve Jobs</p>
        </div>
      </div>
    </div>

    <!-- AI Performance Insights -->
    <div class="ai-insights">
      <h3 class="ai-insights-title">Performance Insights</h3>
      <div class="ai-insights-content">
        <p class="ai-insight-item">
          <span class="ai-insight-label">Recent Average:</span>
          <span class="ai-insight-value" id="recentAverage">0%</span> (1 test)
        </p>
        <p class="ai-insight-item">
          <span class="ai-insight-label">Strongest Area:</span>
          <span class="ai-insight-value" id="strongestArea">Accounting</span>
        </p>
      </div>
    </div>

    <!-- Personalized Goals -->
    <div class="personalized-goals">
      <p class="personalized-text">
        <span class="personalized-highlight">Personalized for your goals</span>
        <span style="color: #ef4444;"> â€¢ </span>
        <span class="personalized-comp" id="userComps">Accounting</span>
      </p>
    </div>

    <!-- Feature Cards -->
    <div class="feature-grid">
      <div class="feature-card">
        <p class="feature-label">Global Rank</p>
        <h3 class="feature-title">Leaderboard</h3>
        <p class="feature-desc">Check your XP earned, rank, and compete with hunters worldwide. Climb to the top.</p>
        <a href="../Leaderboard/leaderboard1.html" class="feature-link">Go to Leaderboard â†’</a>
      </div>
      <div class="feature-card orange">
        <p class="feature-label">Stay Scheduled</p>
        <h3 class="feature-title">Upcoming Events</h3>
        <p class="feature-desc">See your mentor meetings, study groups, and tournament brackets.</p>
        <a href="Calendar/calendar.html" class="feature-link">View Schedule â†’</a>
      </div>
      <div class="feature-card">
        <p class="feature-label">Community</p>
        <h3 class="feature-title">Forum</h3>
        <p class="feature-desc">Connect with hunters, share strategies, and earn community XP.</p>
        <a href="Forum/forum.html" class="feature-link">Join Forum â†’</a>
      </div>
      <div class="feature-card orange">
        <p class="feature-label">Level Up</p>
        <h3 class="feature-title">Mentorship</h3>
        <p class="feature-desc">Complete modules, join teams, unlock certifications and abilities.</p>
        <a href="Training/training1.html" class="feature-link">Start Training â†’</a>
      </div>
    </div>

    <!-- CTA -->
    <div class="cta-section">
      <p class="cta-label">Next Challenge</p>
      <h2 class="cta-title">Ready to ignite your potential?</h2>
      <p class="cta-desc">Complete the next assignment to earn XP, unlock achievements, and climb the ranks.</p>
      <button class="cta-button" onclick="enterLockedIn()">Begin Assignment</button>
    </div>
      </div>
    </div>


  <!-- Goal Modal -->
<div id="goalModal" class="goal-modal" style="overflow-y:auto;">
  <div class="modal-content">
    <h2>Set a Study Goal</h2>
    
    <!-- Role Selection -->
    <div style="margin-bottom: 1.5rem;">
      <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">I am a:</label>
      <div class="role-choices" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
        <button class="role-btn" data-role="member">Member</button>
        <button class="role-btn" data-role="officer">Officer</button>
        <button class="role-btn" data-role="advisor">Advisor</button>
        <button class="role-btn" data-role="chapter">Chapter Account</button>
        <button class="role-btn" data-role="individual">Individual Account</button>
      </div>
    </div>

    <div class="question-section">
    <div class="question-title">What chapter are you a part of?</div><br>
    <div class="chapter-input-group">
        <input type="text" class="chapter-input" id="school" placeholder="Ex. Lincoln High School FBLA">
    </div>
</div>

    <div class="goal-choices">
      <div class="goal-card" data-goal="passive">Passive<br><span>20 min/week</span></div>
      <div class="goal-card" data-goal="active">Active<br><span>1 hr/week</span></div>
      <div class="goal-card" data-goal="committed">Committed<br><span>2 hrs/week</span></div>
      <div class="goal-card" data-goal="running">Running the Show<br><span>4+ hrs/week</span></div>
    </div>
    
    <!-- Competition Entries - Rebuilt as proper dropdowns -->
    <div style="margin-bottom: 1rem;">
      <label style="display: block; margin-bottom: 0.5rem; color: white;">What competitions are you in?</label>
      <div id="competitionInputs">
        <div class="comp-input-group" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <select id="comps" class="comp-input" required style="flex: 1; height: 48px; padding: 12px 16px; padding-right: 2.5rem; border: 2px solid rgba(239, 68, 68, 0.5); border-radius: 8px; font-size: 16px; background-color: rgba(127, 29, 29, 0.3); color: #fff; cursor: pointer; width: 100%; appearance: menulist; -webkit-appearance: menulist; -moz-appearance: menulist; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 12 12%22><path fill=%22%23fff%22 d=%22M6 9L1 4h10z%22/></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 12px;">
            <option value="" style="background-color: rgba(127, 29, 29, 0.3); color: #fca5a5;">Select a competition...</option>
            <!-- Options will be populated from Firestore -->
          </select>
          <button type="button" id="addCompBtn" class="add-comp-btn" title="Add another competition" style="width: 48px; height: 48px; border: 2px solid rgba(239, 68, 68, 0.5); background: rgba(127, 29, 29, 0.4); color: #fff; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">+</button>
        </div>
      </div>
    </div>
    
    <div style="margin: 1.2rem 0 0.5rem 0; display: flex; align-items: center; gap: 0.5rem; margin-top: -30px;">
      <input type="checkbox" id="isMentor" style="width: 18px; height: 18px; accent-color: #2563eb;">
      <label for="isMentor" style="margin: 0; font-size: 1rem; color: white;">I am a mentor for a competition</label>
    </div>

    <div id="mentorCompDiv" style="margin-bottom: 1rem; display: none;">
      <label style="display: block; margin-bottom: 0.5rem; color: white;">What competitions can you mentor in?</label>
      <div class="mentor-comp-input-group" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
        <select id="mentorComp" class="mentor-comp-input" style="flex: 1; height: 48px; padding: 12px 16px; padding-right: 2.5rem; border: 2px solid rgba(239, 68, 68, 0.5); border-radius: 8px; font-size: 16px; background: rgba(127, 29, 29, 0.3); color: #fff; cursor: pointer; width: 100%; appearance: menulist; -webkit-appearance: menulist; -moz-appearance: menulist; background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 12 12%22><path fill=%22%23fff%22 d=%22M6 9L1 4h10z%22/></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 12px;">
          <option value="" style="background-color: rgba(127, 29, 29, 0.3); color: #fca5a5;">Select a competition...</option>
          <!-- Options will be populated from Firestore -->
        </select>
        <button type="button" id="addMentorCompBtn" class="add-mentor-comp-btn" title="Add another mentoring competition" style="width: 48px; height: 48px; border: none; background: linear-gradient(to right, #f97316, #ef4444); color: white; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;">+</button>
      </div>
      <div id="mentorCompetitionInputs">
        <!-- Dynamic dropdowns with Ã— buttons will be added here -->
      </div>
    </div>

    
    <button id="goalSubmitBtn" disabled>Save</button>
  </div>
</div>

  <div class="modal-backdrop"></div>



  <!-- Assignment Modal -->
  <div id="cq-assignment-modal" class="cq-modal">
    <div class="cq-modal-content">
      <span class="cq-close" onclick="closeAssignmentModal()">&times;</span>
      <div id="cq-assignment-title" class="cq-modal-title">New Assignment</div>
      
      <!-- Assignment Info (shown first) -->
      <div id="cq-assignment-info">
        <div id="cq-assignment-fields" class="cq-modal-fields"></div>
        <div class="cq-modal-footer" style="margin-top:1.5rem; text-align:right;">
          <button class="cq-modal-btn" onclick="acceptAssignmentNow()">I'll do it now</button>
          <button class="cq-modal-btn" onclick="snoozeAssignment()">I'll do it later</button>
        </div>
      </div>
      
      <!-- Quiz Section (hidden initially) -->
      <div id="cq-assignment-quiz" style="display:none;">
        <div class="quiz-meta">
          <span id="quizDifficulty">Difficulty: Medium</span>
          <span id="quizTime">Time: 10 mins</span>
          <span id="quizScore" style="margin-left: auto; font-weight: 600;">Score: 0/5</span>
        </div>
        <div id="quizQuestions" class="cq-modal-fields"></div>
        <div class="cq-modal-footer">
          <button class="cq-modal-btn" id="submitQuizBtn" disabled>Submit Answers</button>
        </div>
      </div>
    </div>
  </div>
  



  <!-- Speaking Assignment Modal -->
  <div id="cq-speaking-modal" class="cq-speaking-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-speaking-stars" id="cq-speaking-stars"></div>
    <div class="cq-speaking-glow-1"></div>
    <div class="cq-speaking-glow-2"></div>
    
    <div class="cq-speaking-modal-content">
      <!-- Header -->
      <div class="cq-speaking-header">
        <h1 class="cq-speaking-title" id="cq-speaking-title">Speaking Assessment</h1>
        <button class="cq-speaking-close" onclick="closeSpeakingAssignmentModal()">Ã—</button>
      </div>
      
      <!-- Main Container -->
      <div class="cq-speaking-main-container">
        <!-- Questions Row -->
        <div class="cq-speaking-questions">
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 1:</h2>
            <p id="cq-speaking-q1" class="cq-speaking-question-text">What is your strategy for this scenario?</p>
          </div>
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 2:</h2>
            <p id="cq-speaking-q2" class="cq-speaking-question-text">How would you handle unexpected challenges?</p>
          </div>
        </div>
        
        <!-- Video Feed -->
        <div class="cq-speaking-video-container">
          <video id="cq-speaking-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-speaking-noVideoView" class="cq-speaking-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-speaking-recordingIndicator" class="cq-speaking-recording-indicator">
            <div class="cq-speaking-recording-dot"></div>
            <span class="cq-speaking-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Controls -->
        <div class="cq-speaking-controls-wrapper">
          <div class="cq-speaking-controls">
            <button id="cq-speaking-documentBtn" class="cq-speaking-control-btn" title="Document">
              ðŸ“„
            </button>
            <button id="cq-speaking-recordBtn" class="cq-speaking-record-btn" onclick="toggleSpeakingRecording()">
              ðŸŽ¤
            </button>
            <button id="cq-speaking-micBtn" class="cq-speaking-control-btn" title="Settings">
              âš™ï¸
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-speaking-submitBtn" class="cq-speaking-submit-btn" style="display:none;" onclick="submitSpeakingResponse()">Submit Assessment</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-speaking-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-speaking-audioBtn" style="display:none;"></button>
      <button id="cq-speaking-videoBtn" style="display:none;"></button>
      <button id="cq-speaking-stopBtn" style="display:none;"></button>
      <button id="cq-speaking-downloadBtn" style="display:none;"></button>
    </div>
  </div>

  <!-- Case Study Assignment Modal -->
  <div id="cq-case-study-modal" class="cq-case-study-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-case-study-stars" id="cq-case-study-stars"></div>
    <div class="cq-case-study-glow-1"></div>
    <div class="cq-case-study-glow-2"></div>
    
    <div class="cq-case-study-modal-content">
      <!-- Header -->
      <div class="cq-case-study-header">
        <h1 class="cq-case-study-title" id="cq-case-study-title">Case Study</h1>
        <div class="cq-case-study-header-right">
          <!-- Timer -->
          <div id="cq-case-study-timer" class="cq-case-study-timer" onclick="toggleCaseStudyTimer()">
            <div id="cq-case-study-timer-dot" class="cq-case-study-timer-dot"></div>
            <span id="cq-case-study-timer-text" class="cq-case-study-timer-text">20:00</span>
            <span id="cq-case-study-timer-start" class="cq-case-study-timer-start">Start</span>
          </div>
          <button class="cq-case-study-close" onclick="closeCaseStudyModal()">Ã—</button>
        </div>
      </div>
      
      <!-- Main Container -->
      <div class="cq-case-study-main-container">
        <!-- Top Info Section (when content collapsed) -->
        <div id="cq-case-study-top-info" class="cq-case-study-top-info">
          <div class="cq-case-study-info-card">
            <p class="cq-case-study-info-label">Case Name</p>
            <p id="cq-case-study-name" class="cq-case-study-info-value">Market Expansion Strategy</p>
          </div>
          <div id="cq-case-study-content-preview" class="cq-case-study-info-card cq-case-study-clickable" onclick="expandCaseStudyContent()">
            <p class="cq-case-study-info-label">Case Study Content</p>
            <p id="cq-case-study-content-preview-text" class="cq-case-study-info-preview">Loading...</p>
            <p class="cq-case-study-read-more">Read More â†’</p>
          </div>
        </div>
        
        <!-- Expanded Content (when content expanded) -->
        <div id="cq-case-study-expanded-content" class="cq-case-study-expanded-content" style="display:none;">
          <div class="cq-case-study-expanded-header">
            <div>
              <p class="cq-case-study-expanded-label">Case Study Content</p>
              <h3 id="cq-case-study-expanded-title" class="cq-case-study-expanded-title">Market Expansion Strategy</h3>
            </div>
            <button class="cq-case-study-expanded-close" onclick="collapseCaseStudyContent()">Ã—</button>
          </div>
          <p id="cq-case-study-full-content" class="cq-case-study-full-content">Loading...</p>
        </div>
        
        <!-- Video Feed (hidden when content expanded) -->
        <div id="cq-case-study-video-container" class="cq-case-study-video-container">
          <video id="cq-case-study-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-case-study-noVideoView" class="cq-case-study-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-case-study-recordingIndicator" class="cq-case-study-recording-indicator">
            <div class="cq-case-study-recording-dot"></div>
            <span class="cq-case-study-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Bottom Info Section (hidden when content expanded) -->
        <div id="cq-case-study-bottom-info" class="cq-case-study-bottom-info">
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 1</p>
            <p id="cq-case-study-q1" class="cq-case-study-question-text">What are the key market opportunities and challenges?</p>
          </div>
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 2</p>
            <p id="cq-case-study-q2" class="cq-case-study-question-text">How would you develop a comprehensive expansion strategy?</p>
          </div>
        </div>
        
        <!-- Controls (hidden when content expanded) -->
        <div id="cq-case-study-controls-wrapper" class="cq-case-study-controls-wrapper">
          <div class="cq-case-study-controls">
            <button id="cq-case-study-recordBtn" class="cq-case-study-record-btn" onclick="toggleCaseStudyRecording()">
              ðŸŽ¤
            </button>
            <button id="cq-case-study-downloadBtn" class="cq-case-study-control-btn" title="Download" style="display:none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="7" y="7" width="10" height="10" rx="2.5" fill="#60a5fa"/>
                <path d="M12 9.5v4.5m0 0l-2.5-2.5m2.5 2.5l2.5-2.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-case-study-submitBtn" class="cq-case-study-submit-btn" style="display:none;" onclick="submitCaseStudyResponse()">Submit Case Study</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-case-study-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-case-study-audioBtn" style="display:none;"></button>
      <button id="cq-case-study-videoBtn" style="display:none;"></button>
      <button id="cq-case-study-stopBtn" style="display:none;"></button>
    </div>
  </div>

  <!-- Congratulations Modal -->

<div id="mentorCommentModal">
  <div class="modal-content">
    <span class="close" onclick="closeMentorCommentModal()">&times;</span>
    <h2 id="mentorCommentAssignment"></h2>
    <div id="mentorCommentText"></div>
    <button class="btn" onclick="closeMentorCommentModal()">Close</button>
  </div>
</div>

<!-- Notification Panel -->
  <div id="notificationPanel" class="notification-panel hidden">
    <div class="notification-panel-header">
      <h3 class="notification-panel-title">NOTIFICATIONS</h3>
      <button onclick="toggleNotificationPanel()" class="close-notifications">âœ•</button>
    </div>
    <div id="notificationList" class="notification-list"></div>
  </div>

<div id="cq-written-loading" class="cq-written-loading" style="display:none;">
    <!-- Gradient balls background -->
    <div class="gradient-balls">
        <div class="ball ball-1"></div>
        <div class="ball ball-2"></div>
        <div class="ball ball-3"></div>
        <div class="ball ball-4"></div>
    </div>
    
    <!-- Loading content -->
    <div class="cq-loading-container">
        <div class="cq-loading-spinner"></div>
        <div class="cq-loading-text">Loading Assignment!</div>
        <div class="cq-loading-subtext">Analyzing your competencies and creating personalized content...</div>
        <div class="cq-loading-progress">
            <div class="cq-loading-progress-bar" id="cq-loading-progress-bar"></div>
        </div>
    </div>
</div>




<script>
  // Mobile Navigation Toggle
  window.toggleMobileNav = function() {
    const nav = document.getElementById('mainNav');
    const hamburger = document.getElementById('hamburgerMenu');
    
    if (nav && hamburger) {
      nav.classList.toggle('active');
      hamburger.classList.toggle('active');
      document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
    }
  };
  
  // Close mobile nav when clicking a nav link
  // Consolidated DOMContentLoaded listener - all initialization code goes here

  // Firebase configuration

  // Initialize Firebase
  const db = firebase.firestore();
  const auth = firebase.auth();

  function populateCompetitionDropdowns() {
  if (!window.allCompetitions || window.allCompetitions.length === 0) {
    console.log('âš ï¸ No competitions loaded yet');
    return;
  }
  
  console.log('Populating dynamic dropdowns with', window.allCompetitions.length, 'competitions');
  
  // Populate regular competition dropdowns (added via "Add Competition" button)
  const compInputs = document.querySelectorAll('.comp-input');
  console.log(`Found ${compInputs.length} .comp-input elements`);
  
  compInputs.forEach((select, idx) => {
    if (select.tagName === 'SELECT') {
      select.innerHTML = '<option value="">Select a competition...</option>';
      window.allCompetitions.forEach(comp => {
        const option = document.createElement('option');
        option.value = comp;
        option.textContent = comp;
        select.appendChild(option);
      });
      console.log(`âœ… Populated .comp-input[${idx}]`);
    }
  });
  
  // Populate mentor competition dropdowns
  const mentorCompInputs = document.querySelectorAll('.mentor-comp-input');
  console.log(`Found ${mentorCompInputs.length} .mentor-comp-input elements`);
  
  mentorCompInputs.forEach((select, idx) => {
    if (select.tagName === 'SELECT') {
      select.innerHTML = '<option value="">Select a competition...</option>';
      window.allCompetitions.forEach(comp => {
        const option = document.createElement('option');
        option.value = comp;
        option.textContent = comp;
        select.appendChild(option);
      });
      console.log(`âœ… Populated .mentor-comp-input[${idx}]`);
    }
  });
}


async function loadCompetitionsFromFirestore() {
  try {
    console.log('ðŸš€ Starting loadCompetitionsFromFirestore...');
    
    // Check if Firestore is initialized
    if (!db) {
      throw new Error('Firestore db not initialized');
    }
    
    const competitionsSnapshot = await db.collection('competitions').get();
    const competitions = [];
    
    console.log(`ðŸ“Š Found ${competitionsSnapshot.size} competition documents in Firestore`);
    
    competitionsSnapshot.forEach(doc => {
      competitions.push(doc.id);
      console.log(`  - ${doc.id}`);
    });
    
    competitions.sort();
    window.allCompetitions = competitions;
    
    console.log('âœ… Competitions loaded and sorted:', competitions);
    
    // ========== STEP 1: Populate the INITIAL select elements ==========
    console.log('ðŸ“‹ Step 1: Populating initial form dropdowns...');
    
    const initialCompSelect = document.getElementById('comps');
    if (initialCompSelect && initialCompSelect.tagName === 'SELECT') {
      console.log('âœ… Found initial comps SELECT element');
      initialCompSelect.innerHTML = '<option value="">Select a competition...</option>';
      competitions.forEach(comp => {
        const option = document.createElement('option');
        option.value = comp;
        option.textContent = comp;
        initialCompSelect.appendChild(option);
      });
      console.log(`âœ… Populated comps with ${competitions.length} options`);
    } else {
      console.warn(`âš ï¸ comps element NOT found or is not a SELECT. Found: ${initialCompSelect?.tagName || 'null'}`);
    }
    
    const initialMentorSelect = document.getElementById('mentorComp');
    if (initialMentorSelect && initialMentorSelect.tagName === 'SELECT') {
      console.log('âœ… Found initial mentorComp SELECT element');
      initialMentorSelect.innerHTML = '<option value="">Select a competition...</option>';
      competitions.forEach(comp => {
        const option = document.createElement('option');
        option.value = comp;
        option.textContent = comp;
        initialMentorSelect.appendChild(option);
      });
      console.log(`âœ… Populated mentorComp with ${competitions.length} options`);
    } else {
      console.warn(`âš ï¸ mentorComp element NOT found or is not a SELECT. Found: ${initialMentorSelect?.tagName || 'null'}`);
    }
    
    // ========== STEP 2: Populate any dynamically-added dropdowns ==========
    console.log('ðŸ“‹ Step 2: Populating dynamic dropdowns...');
    populateCompetitionDropdowns();
    
    console.log('ðŸŽ‰ loadCompetitionsFromFirestore completed successfully!');
    return competitions;
    
  } catch (error) {
    console.error('âŒ Error loading competitions from Firestore:', error);
    console.error('Error details:', {
      name: error.name,
      message: error.message,
      code: error.code,
      stack: error.stack
    });
    window.allCompetitions = [];
    return [];
  }
}
  // Galaxy Background - Create Stars
  function createStars() {
    const starsContainer = document.getElementById('starsContainer');
    if (!starsContainer) return;
    
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'star';
      const size = Math.random() * 3 + 0.5;
      const duration = Math.random() * 4 + 2;
      const delay = Math.random() * 2;
      const randomLeft = Math.random() * 100;
      const randomTop = Math.random() * 100;
      const randomOpacity = Math.random() * 0.9 + 0.3;
      
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = randomLeft + '%';
      star.style.top = randomTop + '%';
      star.style.opacity = randomOpacity;
      star.style.animation = `twinkle ${duration}s ease-in-out infinite`;
      star.style.animationDelay = delay + 's';
      star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
      
      starsContainer.appendChild(star);
    }
  }

  // 3D Duck Rotation
  let duckRotation = { x: 0, y: 0 };
  let duckContainer, duckWrapper;
  let bobbingOffset = 0;
  let bobbingDirection = 1;
  let animationFrameId = null;

  function updateDuckTransform(rotX = 0, rotY = 0) {
    if (!duckWrapper) return;
    duckWrapper.style.transform = `translateY(${bobbingOffset}px) rotateX(${rotX}deg) rotateY(${rotY}deg)`;
  }

  function animateBobbing() {
    bobbingOffset += bobbingDirection * 0.3;
    if (bobbingOffset > 15) bobbingDirection = -1;
    if (bobbingOffset < -15) bobbingDirection = 1;
    
    // Update transform with current rotation
    updateDuckTransform(duckRotation.x, duckRotation.y);
    animationFrameId = requestAnimationFrame(animateBobbing);
  }

  function handleDuckMouseMove(e) {
    if (!duckContainer || !duckWrapper) return;
    const rect = duckContainer.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    const x = e.clientX - centerX;
    const y = e.clientY - centerY;
    
    // Calculate rotation based on mouse position
    const rotX = (y / (rect.height / 2)) * 25; // More pronounced rotation
    const rotY = (x / (rect.width / 2)) * 25;
    
    duckRotation = { x: rotX, y: rotY };
    updateDuckTransform(rotX, rotY);
  }

  function handleDuckMouseLeave() {
    duckRotation = { x: 0, y: 0 };
    updateDuckTransform(0, 0);
  }

  // Personality Modal
  let duckPersonality = null;
  
  function selectPersonality(personality) {
    duckPersonality = personality;
    localStorage.setItem('duckPersonality', personality);
    
    // Save to Firebase for new accounts
    const user = auth.currentUser;
    if (user) {
      db.collection('users').doc(user.uid).update({
        duckPersonality: personality
      }).catch(err => console.error('Error saving duck personality:', err));
    }
    
    const personalityModal = document.getElementById('personalityModal');
    if (personalityModal) {
      personalityModal.style.display = 'none';
    }
  }

  function showPersonalityModal() {
    // Only show if duck personality is not set (new account)
    if (!duckPersonality) {
      const personalityModal = document.getElementById('personalityModal');
      const goalModal = document.getElementById('goalModal');
      // Only show if goal modal is not showing
      if (personalityModal && (!goalModal || goalModal.style.display !== 'block')) {
        personalityModal.style.display = 'flex';
      }
    }
  }

  // Check if user is new (no duckPersonality in Firebase)
  function checkIfNewAccount(userDoc) {
    if (!userDoc || !userDoc.exists) return true;
    const data = userDoc.data();
    // New account if no duckPersonality set
    return !data.duckPersonality;
  }

  // Calculate user rank from leaderboard (separates learners and mentors like the leaderboard page)
  async function calculateUserRank(userId, userXP) {
    try {
      // Get current user's isMentor status
      const currentUserDoc = await db.collection('users').doc(userId).get();
      const isMentor = currentUserDoc.exists && currentUserDoc.data().isMentor === true;
      
      // Get all users with XP and name (required for leaderboard)
      const usersSnapshot = await db.collection('users').get();

      const users = [];
      usersSnapshot.forEach(doc => {
        const data = doc.data();
        // Only include users with XP and name (matching leaderboard requirements)
        if (data.XP !== undefined && data.name) {
          users.push({
            id: doc.id,
            xp: data.XP || 0,
            isMentor: data.isMentor || false
          });
        }
      });

      // Separate learners and mentors (like the leaderboard does)
      const learners = users.filter(u => !u.isMentor);
      const mentors = users.filter(u => u.isMentor);
      
      // Sort the appropriate group by XP descending
      const relevantGroup = isMentor ? mentors : learners;
      relevantGroup.sort((a, b) => b.xp - a.xp);
      
      // Find user's rank within their group (1-indexed)
      const userIndex = relevantGroup.findIndex(u => u.id === userId);
      const rank = userIndex >= 0 ? userIndex + 1 : relevantGroup.length + 1;

      const rankElement = document.getElementById('userRank');
      if (rankElement) {
        rankElement.textContent = '#' + rank;
      }
      
      console.log(`Rank calculated: User is ${isMentor ? 'mentor' : 'learner'}, rank #${rank} out of ${relevantGroup.length} ${isMentor ? 'mentors' : 'learners'}`);
    } catch (error) {
      console.error('Error calculating user rank:', error);
      const rankElement = document.getElementById('userRank');
      if (rankElement) {
        rankElement.textContent = '#N/A';
      }
    }
  }

  // Award XP to user
  async function awardXP(userId, amount, reason) {
    try {
      const userRef = db.collection('users').doc(userId);
      const userDoc = await userRef.get();
      
      if (userDoc.exists) {
        // User document exists, increment XP and ensure name field exists
        const updateData = {
          XP: firebase.firestore.FieldValue.increment(amount)
        };
        
        // Ensure name field exists for leaderboard
        if (!userDoc.data().name) {
          const user = auth.currentUser;
          if (user) {
            updateData.name = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
          }
        }
        
        await userRef.update(updateData);
        
        // Fetch updated XP from Firebase to get accurate value
        const updatedDoc = await userRef.get();
        const newXP = updatedDoc.exists && updatedDoc.data().XP !== undefined ? updatedDoc.data().XP : 0;
        
        // Update UI with actual Firebase value
        const xpElement = document.getElementById('userXP');
        if (xpElement) {
          xpElement.textContent = newXP.toLocaleString();
        }
        
        // Recalculate level based on new XP
        const newLevel = Math.floor(newXP / 1500) + 1;
        const levelElement = document.getElementById('userLevel');
        if (levelElement) {
          levelElement.textContent = newLevel;
        }
        
        // Recalculate rank with new XP
        calculateUserRank(userId, newXP);
        
        console.log(`âœ… Awarded ${amount} XP to user ${userId} for ${reason}. New total: ${newXP}`);
      } else {
        // User document doesn't exist, create it with initial XP and name
        const user = auth.currentUser;
        const userName = user ? (user.displayName || (user.email ? user.email.split('@')[0] : 'User')) : 'User';
        await userRef.set({
          XP: amount,
          name: userName
        });
        
        // Update UI
        const xpElement = document.getElementById('userXP');
        if (xpElement) {
          xpElement.textContent = amount.toLocaleString();
        }
        
        const levelElement = document.getElementById('userLevel');
        if (levelElement) {
          levelElement.textContent = Math.floor(amount / 1500) + 1;
        }
        
        calculateUserRank(userId, amount);
        
        console.log(`âœ… Created user document with ${amount} XP for ${userId}`);
      }
      
    } catch (error) {
      console.error("Failed to award XP:", error);
    }
  }

  // Calculate Weekly XP from completed assignments
  async function calculateWeeklyXP(userId) {
    try {
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
      
      const assignmentsSnapshot = await db.collection('assignments')
        .where('to', '==', userId)
        .where('status', '==', 'complete')
        .where('completedAt', '>=', oneWeekAgo)
        .get();

      let weeklyXP = 0;
      assignmentsSnapshot.forEach(doc => {
        const data = doc.data();
        // XP is typically awarded based on score, but we can estimate from percentage
        // Or if there's an XP field in assignments, use that
        if (data.xpAwarded) {
          weeklyXP += data.xpAwarded;
        } else if (data.percentage) {
          // Estimate: 10 XP per 10% score
          weeklyXP += Math.round(data.percentage / 10) * 10;
        }
      });

      const weeklyXPElement = document.getElementById('weeklyXP');
      if (weeklyXPElement) {
        weeklyXPElement.textContent = weeklyXP.toLocaleString();
      }
    } catch (error) {
      console.error('Error calculating weekly XP:', error);
      // If query fails (no index), just show 0
      const weeklyXPElement = document.getElementById('weeklyXP');
      if (weeklyXPElement) {
        weeklyXPElement.textContent = '0';
      }
    }
  }

  // Load AI Performance Insights from Firebase
  async function loadAIPerformanceInsights() {
    try {
      const user = auth.currentUser;
      if (!user) {
        console.log('No user found for AI insights');
        return;
      }

      console.log('Loading AI Performance Insights for user:', user.uid);

      // Get all completed test results (written and quiz types only)
      // First try with type filter, then fallback to all complete assignments if needed
      let assignmentsSnapshot;
      try {
        // Try querying with type filter first
        let allSnapshot = await db.collection('assignments')
          .where('to', '==', user.uid)
          .where('type', 'in', ['written', 'quiz'])
          .where('status', '==', 'complete')
          .get();
        
        console.log('Fetched test results with type filter:', allSnapshot.docs.length);
        
        // If we got fewer results than expected, also fetch documents that might be tests but don't have type field
        // Filter in memory for documents that look like test results (have percentage, score, competencyStats)
        if (allSnapshot.docs.length < 3) {
          console.log('Fewer results than expected, fetching all complete assignments to check...');
          const allCompleteSnapshot = await db.collection('assignments')
            .where('to', '==', user.uid)
            .where('status', '==', 'complete')
            .get();
          
          console.log('All complete assignments:', allCompleteSnapshot.docs.length);
          
          // Filter for test-like documents (have percentage or score/maxScore or competencyStats)
          const testLikeDocs = allCompleteSnapshot.docs.filter(doc => {
            const data = doc.data();
            // Check if it looks like a test result
            const hasTestFields = (data.percentage !== undefined && data.percentage !== null) ||
                                 (data.score !== undefined && data.maxScore !== undefined) ||
                                 (data.competencyStats && Object.keys(data.competencyStats).length > 0);
            // Exclude if it's clearly not a test (has assignment-specific fields that tests don't have)
            const isNotTest = data.from !== undefined || data.mentorId !== undefined;
            return hasTestFields && !isNotTest;
          });
          
          console.log('Test-like documents found:', testLikeDocs.length);
          
          // Combine with existing results, avoiding duplicates
          const existingIds = new Set(allSnapshot.docs.map(d => d.id));
          const additionalDocs = testLikeDocs.filter(d => !existingIds.has(d.id));
          
          console.log('Additional test documents:', additionalDocs.length);
          
          // Combine the results
          allSnapshot = {
            docs: [...allSnapshot.docs, ...additionalDocs],
            empty: false
          };
        }
        
        console.log('Total test results after combining:', allSnapshot.docs.length);
        
        // Filter to ensure we only include actual test results
        // A test result should have: percentage OR (score AND maxScore) OR competencyStats
        const testResults = allSnapshot.docs.filter(doc => {
          const data = doc.data();
          const hasPercentage = data.percentage !== undefined && data.percentage !== null;
          const hasScore = data.score !== undefined && data.maxScore !== undefined;
          const hasCompetencyStats = data.competencyStats && Object.keys(data.competencyStats).length > 0;
          const isTestResult = hasPercentage || hasScore || hasCompetencyStats;
          
          // Exclude if it's clearly an assignment from a mentor (has 'from' field)
          const isMentorAssignment = data.from !== undefined && data.from !== user.uid;
          
          return isTestResult && !isMentorAssignment;
        });
        
        console.log('Filtered to actual test results:', testResults.length);
        
        // Sort by completedAt in memory and take first 10
        const sortedDocs = testResults.sort((a, b) => {
          const aData = a.data();
          const bData = b.data();
          const aTime = aData.completedAt?.toMillis?.() || aData.completedAt?.seconds * 1000 || aData.createdAt?.toMillis?.() || aData.createdAt?.seconds * 1000 || 0;
          const bTime = bData.completedAt?.toMillis?.() || bData.completedAt?.seconds * 1000 || bData.createdAt?.toMillis?.() || bData.createdAt?.seconds * 1000 || 0;
          return bTime - aTime; // Descending
        }).slice(0, 10);
        
        console.log('Sorted and limited to:', sortedDocs.length, 'tests');
        
        assignmentsSnapshot = {
          empty: sortedDocs.length === 0,
          docs: sortedDocs,
          forEach: function(callback) {
            sortedDocs.forEach(callback);
          }
        };
      } catch (fetchError) {
        console.error('Error fetching test results:', fetchError);
        // Set default values on error
        const recentAverageEl = document.getElementById('recentAverage');
        const strongestAreaEl = document.getElementById('strongestArea');
        if (recentAverageEl) {
          recentAverageEl.textContent = '0%';
          const parent = recentAverageEl.parentElement;
          if (parent) {
            parent.innerHTML = '<span class="ai-insight-label">Recent Average:</span> <span class="ai-insight-value">0%</span> (0 tests)';
          }
        }
        if (strongestAreaEl) strongestAreaEl.textContent = 'N/A';
        return;
      }

      // Handle both Firestore snapshot and custom object
      const docs = assignmentsSnapshot.docs || [];
      if (docs.length === 0 || assignmentsSnapshot.empty) {
        // Set default values if no assignments
        const recentAverageEl = document.getElementById('recentAverage');
        const strongestAreaEl = document.getElementById('strongestArea');
        if (recentAverageEl) {
          recentAverageEl.textContent = '0%';
          const parent = recentAverageEl.parentElement;
          if (parent) {
            parent.innerHTML = '<span class="ai-insight-label">Recent Average:</span> <span class="ai-insight-value">0%</span> (0 tests)';
          }
        }
        if (strongestAreaEl) strongestAreaEl.textContent = 'N/A';
        return;
      }

      const assignments = docs.map(doc => {
        const data = typeof doc.data === 'function' ? doc.data() : doc;
        console.log('Assignment data:', {
          type: data.type,
          status: data.status,
          percentage: data.percentage,
          score: data.score,
          maxScore: data.maxScore,
          competencyStats: data.competencyStats
        });
        return data;
      });
      
      console.log('Total assignments found:', assignments.length);
      
      // Calculate recent average
      // Include ALL tests, even if they have 0% (0 is a valid score)
      const percentages = assignments
        .map(a => {
          // Calculate percentage from available fields
          let percent = a.percentage;
          if (percent === undefined || percent === null) {
            if (a.score !== undefined && a.maxScore !== undefined && a.maxScore > 0) {
              percent = Math.round((a.score / a.maxScore) * 100);
            } else {
              percent = 0; // Default to 0 if we can't calculate
            }
          }
          console.log('Calculated percentage:', percent, 'from', {
            percentage: a.percentage,
            score: a.score,
            maxScore: a.maxScore,
            type: a.type
          });
          return percent;
        })
        .filter(p => p !== null && p !== undefined && !isNaN(p)); // Only filter out null/undefined/NaN, NOT 0
      
      console.log('All percentages (including 0%):', percentages);
      console.log('Total tests:', percentages.length);
      
      const recentAverage = percentages.length > 0 
        ? Math.round(percentages.reduce((sum, p) => sum + p, 0) / percentages.length)
        : 0;
      
      const testCount = percentages.length; // Count ALL tests, including 0% scores
      
      console.log('Recent average:', recentAverage, 'from', testCount, 'tests');

      // Calculate strongest area from competencyStats
      const combinedCompetencyStats = {};
      assignments.forEach(assignment => {
        if (assignment.competencyStats) {
          Object.entries(assignment.competencyStats).forEach(([competency, stats]) => {
            if (!combinedCompetencyStats[competency]) {
              combinedCompetencyStats[competency] = { correct: 0, total: 0 };
            }
            combinedCompetencyStats[competency].correct += stats.correct || 0;
            combinedCompetencyStats[competency].total += stats.total || 0;
          });
        }
      });

      // Find strongest area (highest accuracy)
      let strongestArea = 'N/A';
      let highestAccuracy = 0;
      
      Object.entries(combinedCompetencyStats).forEach(([competency, stats]) => {
        if (stats.total > 0) {
          const accuracy = (stats.correct / stats.total) * 100;
          if (accuracy > highestAccuracy) {
            highestAccuracy = accuracy;
            strongestArea = competency;
          }
        }
      });

      // Format competency name (remove underscores, capitalize)
      const formatCompetencyName = (name) => {
        if (!name || name === 'N/A') return 'N/A';
        return name
          .split('_')
          .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
          .join(' ');
      };

      // Update the UI
      const recentAverageEl = document.getElementById('recentAverage');
      const strongestAreaEl = document.getElementById('strongestArea');
      
      if (recentAverageEl) {
        recentAverageEl.textContent = recentAverage + '%';
        // Update parent to show test count
        const parent = recentAverageEl.parentElement;
        if (parent) {
          parent.innerHTML = `
            <span class="ai-insight-label">Recent Average:</span>
            <span class="ai-insight-value">${recentAverage}%</span> (${testCount} test${testCount !== 1 ? 's' : ''})
          `;
        }
      }
      
      if (strongestAreaEl) {
        strongestAreaEl.textContent = formatCompetencyName(strongestArea);
      }

      console.log('AI Performance Insights loaded:', {
        recentAverage,
        testCount,
        strongestArea,
        competencyStats: combinedCompetencyStats,
        assignmentsCount: assignments.length,
        assignments: assignments.map(a => ({
          type: a.type,
          status: a.status,
          percentage: a.percentage,
          hasCompetencyStats: !!a.competencyStats
        }))
      });
      
      // Force UI update
      if (recentAverageEl && recentAverageEl.textContent !== (recentAverage + '%')) {
        console.log('Updating recent average from', recentAverageEl.textContent, 'to', recentAverage + '%');
      }
      if (strongestAreaEl && strongestAreaEl.textContent !== formatCompetencyName(strongestArea)) {
        console.log('Updating strongest area from', strongestAreaEl.textContent, 'to', formatCompetencyName(strongestArea));
      }

    } catch (error) {
      console.error('Error loading AI performance insights:', error);
      // Set default values on error
      const recentAverageEl = document.getElementById('recentAverage');
      const strongestAreaEl = document.getElementById('strongestArea');
      if (recentAverageEl) {
        recentAverageEl.textContent = '0%';
        const parent = recentAverageEl.parentElement;
        if (parent) {
          parent.innerHTML = '<span class="ai-insight-label">Recent Average:</span> <span class="ai-insight-value">0%</span> (0 tests)';
        }
      }
      if (strongestAreaEl) strongestAreaEl.textContent = 'N/A';
    }
  }

  // Locked In Mode
  function enterLockedIn() {
    document.getElementById('lockedInOverlay').style.display = 'flex';
  }

  function exitLockedIn() {
    document.getElementById('lockedInOverlay').style.display = 'none';
  }

  // 100 Inspirational Quotes for Daily Cycling
  const inspirationalQuotes = [
    { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
    { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
    { text: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
    { text: "You are never too old to set another goal or to dream a new dream.", author: "C.S. Lewis" },
    { text: "Success is not final, failure is not fatal: it is the courage to continue that counts.", author: "Winston Churchill" },
    { text: "The only impossible journey is the one you never begin.", author: "Tony Robbins" },
    { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
    { text: "Everything you want is on the other side of fear.", author: "Jack Canfield" },
    { text: "Believe in yourself. You are braver than you think, more talented than you know, and capable of more than you imagine.", author: "Roy T. Bennett" },
    { text: "I learned that courage was not the absence of fear, but the triumph over it.", author: "Nelson Mandela" },
    { text: "What lies behind us and what lies before us are tiny matters compared to what lies within us.", author: "Ralph Waldo Emerson" },
    { text: "The greatest glory in living lies not in never falling, but in rising every time we fall.", author: "Nelson Mandela" },
    { text: "Your time is limited, so don't waste it living someone else's life.", author: "Steve Jobs" },
    { text: "It is during our darkest moments that we must focus to see the light.", author: "Aristotle" },
    { text: "The way to get started is to quit talking and begin doing.", author: "Walt Disney" },
    { text: "Don't let yesterday take up too much of today.", author: "Will Rogers" },
    { text: "You learn more from failure than from success.", author: "Unknown" },
    { text: "Success is walking from failure to failure with no loss of enthusiasm.", author: "Winston Churchill" },
    { text: "It's not whether you get knocked down, it's whether you get up.", author: "Vince Lombardi" },
    { text: "If you are working on something that you really care about, you don't have to be pushed. The vision pulls you.", author: "Steve Jobs" },
    { text: "People who are crazy enough to think they can change the world, are the ones who do.", author: "Rob Siltanen" },
    { text: "Failure is the condiment that gives success its flavor.", author: "Truman Capote" },
    { text: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb" },
    { text: "Only a life lived for others is a life worthwhile.", author: "Albert Einstein" },
    { text: "You miss 100% of the shots you don't take.", author: "Wayne Gretzky" },
    { text: "Whether you think you can, or you think you can'tâ€”you're right.", author: "Henry Ford" },
    { text: "The future is created by what you do today, not tomorrow.", author: "Unknown" },
    { text: "Great things never come from comfort zones.", author: "Unknown" },
    { text: "Dream it. Wish it. Do it.", author: "Unknown" },
    { text: "Success doesn't just find you. You have to go out and get it.", author: "Unknown" },
    { text: "The harder you work for something, the greater you'll feel when you achieve it.", author: "Unknown" },
    { text: "Dream bigger. Do bigger.", author: "Unknown" },
    { text: "Don't stop when you're tired. Stop when you're done.", author: "Unknown" },
    { text: "Wake up with determination. Go to bed with satisfaction.", author: "Unknown" },
    { text: "Do something today that your future self will thank you for.", author: "Sean Patrick Flanery" },
    { text: "Little things make big days.", author: "Unknown" },
    { text: "It's going to be hard, but hard does not mean impossible.", author: "Unknown" },
    { text: "Don't wait for opportunity. Create it.", author: "Unknown" },
    { text: "Sometimes we're tested not to show our weaknesses, but to discover our strengths.", author: "Unknown" },
    { text: "The key to success is to focus on goals, not obstacles.", author: "Unknown" },
    { text: "Dream it. Believe it. Build it.", author: "Unknown" },
    { text: "Grow through what you go through.", author: "Unknown" },
    { text: "You are capable of amazing things.", author: "Unknown" },
    { text: "Success is the sum of small efforts repeated day in and day out.", author: "Robert Collier" },
    { text: "Don't compare yourself to others. Compare yourself to who you were yesterday.", author: "Unknown" },
    { text: "Every expert was once a beginner.", author: "Unknown" },
    { text: "The only limit to our realization of tomorrow will be our doubts of today.", author: "Franklin D. Roosevelt" },
    { text: "Act as if what you do makes a difference. It does.", author: "William James" },
    { text: "Success is not how high you have climbed, but how you make those climbing feel.", author: "Zig Ziglar" },
    { text: "The only person you are destined to become is the person you decide to be.", author: "Ralph Waldo Emerson" },
    { text: "Go for it now. The future is promised to no one.", author: "Wayne Dyer" },
    { text: "Great things happen outside comfort zones.", author: "Unknown" },
    { text: "Do what you have to do, to do what you want to do.", author: "Unknown" },
    { text: "You don't have to be great to start, but you have to start to be great.", author: "Zig Ziglar" },
    { text: "There is no substitute for hard work.", author: "Thomas Edison" },
    { text: "Success usually comes to those who are too busy to be looking for it.", author: "Henry David Thoreau" },
    { text: "The road to success and the road to failure are almost exactly the same.", author: "Colin R. Davis" },
    { text: "I find that the harder I work, the more luck I seem to have.", author: "Thomas Jefferson" },
    { text: "Success is not final, failure is not fatal.", author: "Winston Churchill" },
    { text: "You are the architect of your own destiny.", author: "Unknown" },
    { text: "The best revenge is massive success.", author: "Frank Sinatra" },
    { text: "Tough times don't last, tough people do.", author: "Gregory Peck" },
    { text: "It always seems impossible until it's done.", author: "Nelson Mandela" },
    { text: "Your limitationâ€”it's only your imagination.", author: "Unknown" },
    { text: "Push yourself, because no one else is going to do it for you.", author: "Unknown" },
    { text: "Sometimes later becomes never. Do it now.", author: "Unknown" },
    { text: "Great minds discuss ideas; average minds discuss events; small minds discuss people.", author: "Eleanor Roosevelt" },
    { text: "Don't be afraid to give up the good to go for the great.", author: "John D. Rockefeller" },
    { text: "You were born to be a player. You were meant for accomplishment, engineered for success, and endowed with the seeds of greatness.", author: "Zig Ziglar" },
    { text: "Belief creates the actual fact.", author: "William James" },
    { text: "I am not afraid of storms, for I am learning how to sail my ship.", author: "Louisa May Alcott" },
    { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
    { text: "Success is not about how much money you make. It's about the difference you make in people's lives.", author: "Unknown" },
    { text: "Excellence is not a destination; it is a continuous journey that never ends.", author: "Brian Tracy" },
    { text: "The only person who can tell you 'you can't win' is you and you don't have to listen.", author: "Nike Slogan" },
    { text: "Do not go where the path may lead, go instead where there is no path and leave a trail.", author: "Ralph Waldo Emerson" },
    { text: "What we fear doing most is usually what we most need to do.", author: "Tim Ferriss" },
    { text: "The cave you fear to enter holds the treasure you seek.", author: "Joseph Campbell" },
    { text: "Challenges are what make life interesting; overcoming them is what makes life meaningful.", author: "Joshua J. Marine" },
    { text: "A person who never made a mistake never tried anything new.", author: "Albert Einstein" },
    { text: "All progress takes place outside the comfort zone.", author: "Michael John Bobak" },
    { text: "You are braver than you believe, stronger than you seem, and smarter than you think.", author: "A.A. Milne" },
    { text: "The master has failed more times than the beginner has even tried.", author: "Stephen McCranie" },
    { text: "Opportunities don't happen. You create them.", author: "Chris Grosser" },
    { text: "Success is the product of daily habitsâ€”not once-in-a-lifetime transformations.", author: "James Clear" },
    { text: "The only way to discover the limits of the possible is to go beyond them into the impossible.", author: "Arthur C. Clarke" },
    { text: "Your attitude, not your aptitude, will determine your altitude.", author: "Zig Ziglar" },
    { text: "Success is no accident. It is hard work, perseverance, learning, studying, sacrifice and most of all, love of what you are doing.", author: "PelÃ©" },
    { text: "The man who moves a mountain begins by carrying away small stones.", author: "Confucius" },
    { text: "You are never too small to make a difference.", author: "Greta Thunberg" },
    { text: "A goal is a dream with a deadline.", author: "Napoleon Hill" },
    { text: "Don't let the noise of other's opinions drown out your own inner voice.", author: "Steve Jobs" },
  ];

  // Function to get today's quote (cycles daily based on day of year)
  function getTodayQuote() {
    const today = new Date();
    const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
    const quoteIndex = dayOfYear % inspirationalQuotes.length;
    return inspirationalQuotes[quoteIndex];
  }

  // Function to display today's quote
  function displayDailyQuote() {
    const quote = getTodayQuote();
    const quoteEl = document.getElementById('dailyQuote');
    const authorEl = document.getElementById('dailyQuoteAuthor');
    
    if (quoteEl && authorEl) {
      quoteEl.textContent = `"${quote.text}"`;
      authorEl.textContent = `â€” ${quote.author}`;
    }
  }

  // Initialize on page load
  // Moved to consolidated DOMContentLoaded listener below



  // Global variables
  let modal, backdrop, goalSubmitBtn, compsInput, goalCards, isMentorCheckbox, mentorCompDiv, mentorCompInput, selectedGoal;
  let cqSpeakingMediaRecorder = null;
  let cqSpeakingMediaStream = null;
  let cqSpeakingRecordedChunks = [];
  let isRecording = false;
  let quizTimer = null;  // Add this line
let quizTimeRemaining = 0;  // Add this line if you want timer functionality
let cameraStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let recordingTimer = null;
let recordingSeconds = 0;
let cameraEnabled = true;
let micEnabled = true;
let selectedUploadFile = null;
let writtenModal = null;
let loadingProgressInterval = null;
let loadingProgress = 0;

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = error => reject(error);
  });
}

// Global variable to track the modal


// Function to create the written modal dynamically
function createWrittenModal() {
    // Create the modal container
    const modal = document.createElement('div');
    modal.id = 'cq-written-modal';
    modal.className = 'cq-written-modal';
    modal.style.display = 'none';
    
    // Create the modal content but keep it hidden initially
    modal.innerHTML = `
        <div class="cq-written-modal-content" style="display: none;">
            <div class="cq-written-header">
                <div class="cq-written-title-section">
                    <h2 class="cq-written-title" id="cq-written-title">Written Practice</h2>
                    <div class="cq-written-meta">
                        <span id="cq-written-question-count">Question 1 of 10</span>
                        <span id="cq-written-timer"></span>
                    </div>
                </div>
                <button class="cq-written-close" onclick="closeWrittenModal()">&times;</button>
            </div>
            
            <div class="cq-written-body">
                <div class="cq-written-competency" id="cq-written-competency"></div>
                <h3 class="cq-written-question" id="cq-written-question"></h3>
                
                <div class="cq-written-options" id="cq-written-options"></div>
            </div>
            
            <div class="cq-written-footer">
                <div class="cq-written-progress">
                    <div class="cq-written-progress-bar">
                        <div class="cq-written-progress-fill" id="cq-written-progress-fill"></div>
                    </div>
                </div>
                <div class="cq-written-nav">
                    <button class="cq-written-btn cq-written-btn-secondary" id="cq-written-prev" onclick="previousQuestion()" disabled>Previous</button>
                    <button class="cq-written-btn cq-written-btn-primary" id="cq-written-next" onclick="nextQuestion()">Next</button>
                </div>
            </div>
        </div>
    `;
    
    // Add the modal to the body
    document.body.appendChild(modal);
    
    return modal;
}
// Initialize the modal when the page loads - moved to consolidated DOMContentLoaded listener


// Add these functions to your existing code
function startLoadingAnimation() {
    const progressBar = document.getElementById('cq-loading-progress-bar');
    if (!progressBar) return;
    
    loadingProgress = 0;
    progressBar.style.width = '0%';
    
    // Clear any existing interval
    if (loadingProgressInterval) {
        clearInterval(loadingProgressInterval);
    }
    
    // Start new progress animation
    loadingProgressInterval = setInterval(() => {
        loadingProgress += Math.random() * 10;
        if (loadingProgress > 90) loadingProgress = 90; // Cap at 90% until complete
        progressBar.style.width = loadingProgress + '%';
    }, 300);
}

function completeLoadingAnimation() {
    const progressBar = document.getElementById('cq-loading-progress-bar');
    if (!progressBar) return;
    
    // Complete the progress bar
    progressBar.style.width = '100%';
    
    // Clear the interval
    if (loadingProgressInterval) {
        clearInterval(loadingProgressInterval);
        loadingProgressInterval = null;
    }
    
    // Reset after a short delay
    setTimeout(() => {
        progressBar.style.width = '0%';
        loadingProgress = 0;
    }, 500);
}

function showMentorCommentModal(assignmentName, comment, notificationId) {
  console.log("Showing mentor comment modal:", assignmentName, comment); // Debug log
  
  document.getElementById('mentorCommentAssignment').textContent = `Feedback for "${assignmentName}"`;
  document.getElementById('mentorCommentText').textContent = comment;
 document.getElementById('mentorCommentModal').style.display = 'flex';

  // When closed, mark notification as read
  window.closeMentorCommentModal = function() {
    document.getElementById('mentorCommentModal').style.display = 'none';
    if (notificationId) {
      db.collection('notifications').doc(notificationId).update({
        read: true
      }).catch(err => console.error("Error marking notification as read:", err));
    }
  };
}


let writtenQuestions = [];
let currentQuestionIndex = 0;
let writtenAnswers = {};
let writtenTimer = null;
let writtenTimeRemaining = 0;

const sampleWrittenQuestions = [
  {
    competency: "ACCOUNTING",
    question: "In accounting, what is the equation to calculate net income?",
    options: [
      "Assets = Liabilities + Equity",
      "Revenues - Expenses", 
      "Current Assets - Current Liabilities",
      "Gross Profit - Operating Expenses"
    ],
    correctAnswer: "Revenues - Expenses"
  },
  {
    competency: "FINANCE",
    question: "What is the primary purpose of a cash flow statement?",
    options: [
      "To show profitability over time",
      "To track cash receipts and payments",
      "To list all company assets",
      "To calculate tax obligations"
    ],
    correctAnswer: "To track cash receipts and payments"
  },
  {
    competency: "BUSINESS LAW",
    question: "Which type of business structure provides limited liability protection?",
    options: [
      "Sole Proprietorship",
      "Partnership",
      "Corporation",
      "None of the above"
    ],
    correctAnswer: "Corporation"
  },
  {
    competency: "MARKETING",
    question: "What are the 4 P's of marketing?",
    options: [
      "Product, Price, Place, Promotion",
      "People, Process, Physical, Promotion",
      "Product, Profit, Place, People",
      "Price, Profit, Promotion, People"
    ],
    correctAnswer: "Product, Price, Place, Promotion"
  },
  {
    competency: "ECONOMICS",
    question: "What happens to demand when the price of a good increases, all else being equal?",
    options: [
      "Demand increases",
      "Demand decreases",
      "Demand stays the same",
      "Demand becomes unpredictable"
    ],
    correctAnswer: "Demand decreases"
  },
  {
    competency: "MANAGEMENT",
    question: "Which leadership style involves making decisions without consulting team members?",
    options: [
      "Democratic",
      "Laissez-faire",
      "Autocratic",
      "Transformational"
    ],
    correctAnswer: "Autocratic"
  },
  {
    competency: "ENTREPRENEURSHIP",
    question: "What is a business plan primarily used for?",
    options: [
      "To impress investors only",
      "To outline business goals and strategies",
      "To calculate exact profits",
      "To hire employees"
    ],
    correctAnswer: "To outline business goals and strategies"
  },
  {
    competency: "BUSINESS ETHICS",
    question: "What is the main purpose of corporate social responsibility (CSR)?",
    options: [
      "To increase profits only",
      "To comply with legal requirements",
      "To contribute positively to society and environment",
      "To reduce employee wages"
    ],
    correctAnswer: "To contribute positively to society and environment"
  },
  {
    competency: "OPERATIONS",
    question: "What does 'Just-in-Time' inventory management aim to achieve?",
    options: [
      "Maximum inventory storage",
      "Minimum inventory while meeting demand",
      "Random inventory ordering",
      "Buying inventory in bulk always"
    ],
    correctAnswer: "Minimum inventory while meeting demand"
  },
  {
    competency: "HUMAN RESOURCES",
    question: "What is the primary purpose of performance appraisals?",
    options: [
      "To fire employees",
      "To evaluate and improve employee performance",
      "To reduce salaries",
      "To increase working hours"
    ],
    correctAnswer: "To evaluate and improve employee performance"
  }
];



  // Quiz answers
  let quizAnswers = {
    q1: "To make meetings more efficient",
    q2: "Adjourn", 
    q3: "Majority vote",
    q4: "Amend",
    q5: "\"I move to...\""
  };
  let userScore = 0;

  // Quiz Questions Array
// Replace your existing quizQuestions array with this
const quizQuestions = [
  {
    text: "What is the primary purpose of parliamentary procedure?",
    competency: "Meeting Management",
    correctAnswer: "To make meetings more efficient",
    options: [
      "To make meetings more efficient",
      "To give the president more power",
      "To eliminate debate",
      "To make meetings longer"
    ]
  },
  {
    text: "Which motion is used to end a meeting?",
    competency: "Meeting Management", 
    correctAnswer: "Adjourn",
    options: [
      "Adjourn",
      "Recess",
      "Postpone",
      "Table"
    ]
  },
  {
    text: "How many votes are typically needed to pass a motion?",
    competency: "Voting Procedures",
    correctAnswer: "Majority vote",
    options: [
      "Majority vote",
      "Unanimous vote",
      "Two-thirds vote",
      "Simple majority"
    ]
  },
  {
    text: "What motion is used to change a pending motion?",
    competency: "Amendment Process",
    correctAnswer: "Amend",
    options: [
      "Amend",
      "Substitute",
      "Withdraw",
      "Reconsider"
    ]
  },
  {
    text: "How should you properly introduce a motion?",
    competency: "Meeting Management",
    correctAnswer: "\"I move to...\"",
    options: [
      "\"I move to...\"",
      "\"I suggest that...\"",
      "\"I want to...\"",
      "\"I think we should...\""
    ]
  }
];

// Add this new function to analyze competency performance
function getQuizCompetencyBreakdown() {
  const competencyStats = {};

  document.querySelectorAll('.quiz-question').forEach((qDiv, idx) => {
    const competency = quizQuestions[idx].competency;
    const selectedOption = qDiv.querySelector('input[type="radio"]:checked');
    const isCorrect = selectedOption && 
                     selectedOption.value === quizQuestions[idx].correctAnswer;

    if (!competencyStats[competency]) {
      competencyStats[competency] = { total: 0, correct: 0 };
    }
    
    competencyStats[competency].total++;
    if (isCorrect) competencyStats[competency].correct++;
  });

  return competencyStats;
}

// Add this new function to show detailed results
function showCompetencyResults(score, totalQuestions, competencyStats) {
  const modal = document.getElementById('congratsModal');
  const content = modal.querySelector('.cq-modal-fields');
  
  let competencyHTML = Object.entries(competencyStats).map(([comp, stats]) => `
    <div class="competency-result">
      <span>${comp}:</span>
      <strong>${stats.correct}/${stats.total}</strong>
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${(stats.correct/stats.total)*100}%"></div>
      </div>
    </div>
  `).join('');

  content.innerHTML = `
    <h3 style="text-align:center">Quiz Results</h3>
    <div style="text-align:center; font-size:1.2rem; margin:1rem 0">
      Score: <strong>${score}/${totalQuestions}</strong>
    </div>
    <div style="margin-top:1.5rem">
      <h4>Competency Breakdown:</h4>
      ${competencyHTML}
    </div>
  `;

  modal.style.display = 'block';
}

function showNotification(title, description, onClick = null) {
    const list = document.getElementById("notificationList");
    const panel = document.getElementById("commentPanel");

    const item = document.createElement("div");
    item.className = "notification-item";
    item.innerHTML = `
        <div class="notification-header">
            <strong>${title}</strong>
            <span class="notification-time">Just now</span>
        </div>
        <div class="notification-body">${description}</div>
    `;

    if (onClick) {
        item.addEventListener("click", () => {
            onClick();
            // Don't remove the notification, just mark it as read
            item.classList.add("read");
        });
    }

    list.prepend(item);

    // Show a badge when new notifications arrive
    const notificationBadge = document.querySelector('.nav-icons li a[onclick="toggleCommentPanel()"] .notification-badge');
    if (notificationBadge) {
        notificationBadge.style.display = 'inline-block';
    }
}


function renderQuiz(questionsArr) {
  const quizContainer = document.getElementById('quizQuestions');
  quizContainer.innerHTML = questionsArr.map((q, idx) => `
    <div class="quiz-question" data-competency="${q.competency}">
      <h4>${idx + 1}. ${q.text}</h4>
      ${q.options.map(opt => `
        <label class="quiz-option">
          <input type="radio" name="q${idx+1}" value="${opt}"> ${opt}
        </label>
      `).join('')}
    </div>
  `).join('');
}
  feather.replace(); // renders all feather icons

  function toggleAccordion(button) {
    const content = button.nextElementSibling;
    const icon = button.querySelector('.chevron-icon');
    const isActive = button.classList.contains('active');
    if (isActive) {
      button.classList.remove('active');
      content.style.maxHeight = null;
      if (icon) icon.classList.remove('rotate');
    } else {
      button.classList.add('active');
      content.style.maxHeight = content.scrollHeight + "px";
      if (icon) icon.classList.add('rotate');
    }
  }

  // Check browser compatibility for recording
  function checkRecordingSupport() {
    const issues = [];
    
    if (!navigator.mediaDevices) {
      issues.push("mediaDevices not supported");
    }
    
    if (!navigator.mediaDevices.getUserMedia) {
      issues.push("getUserMedia not supported");
    }
    
    if (!window.MediaRecorder) {
      issues.push("MediaRecorder not supported");
    }
    
    if (issues.length > 0) {
      console.error("Recording not supported:", issues.join(", "));
      alert("Your browser does not support audio/video recording: " + issues.join(", "));
      return false;
    }
    
    return true;
  }

  // Fixed audio recording function
  function startAudioRecording() {
    document.getElementById('cq-speaking-downloadBtn').style.display = 'none';
    console.log("Starting audio recording...");
    
    if (!checkRecordingSupport()) return;
    
    // Stop any existing recording first
    cqSpeakingStopAllMedia();
    cqSpeakingRecordedChunks = [];
    
    navigator.mediaDevices.getUserMedia({ 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    })
    .then(stream => {
      console.log("Audio stream obtained successfully");
      cqSpeakingMediaStream = stream;
      
      // Check MediaRecorder support and set up with best available format
      let options = {};
      if (MediaRecorder.isTypeSupported('audio/webm')) {
        options.mimeType = 'audio/webm';
      } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
        options.mimeType = 'audio/mp4';
      } else if (MediaRecorder.isTypeSupported('audio/ogg')) {
        options.mimeType = 'audio/ogg';
      }
      
      cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
      console.log("MediaRecorder created with mimeType:", cqSpeakingMediaRecorder.mimeType);
      
      cqSpeakingMediaRecorder.ondataavailable = (event) => {
        console.log("Audio data available:", event.data.size, "bytes");
        if (event.data.size > 0) {
          cqSpeakingRecordedChunks.push(event.data);
        }
      };
      
      cqSpeakingMediaRecorder.onstop = () => {
  console.log("Audio recording stopped, processing...");
  if (cqSpeakingRecordedChunks.length === 0) {
    console.error("No audio data recorded");
    alert("No audio data was recorded. Please try again.");
    return;
  }
  const mimeType = cqSpeakingMediaRecorder.mimeType || 'audio/webm';
  const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });
  console.log("Created audio blob:", blob.size, "bytes, type:", blob.type);

  const audioURL = URL.createObjectURL(blob);
  const audioElement = document.getElementById('cq-speaking-audioPlayback');
  if (audioElement) {
    audioElement.src = audioURL;
    audioElement.style.display = 'block';
    audioElement.controls = true;
    console.log("Audio playback element updated");
    audioElement.addEventListener('loadedmetadata', () => {
      console.log("Audio metadata loaded, duration:", audioElement.duration);
    });
    audioElement.addEventListener('error', (e) => {
      console.error("Audio playback error:", e);
    });
  } else {
    console.error("Audio playback element not found in DOM");
  }

  // Download & Upload section - THIS IS WHAT YOU WANT
  const downloadBtn = document.getElementById('cq-speaking-downloadBtn');
  if (downloadBtn && blob) {
    downloadBtn.style.display = 'inline-block';
    downloadBtn.onclick = function() {
      // Create a temporary link and trigger download
      const url = URL.createObjectURL(blob);
      const filename = `CertQuest_Response_${Date.now()}.mp4`;
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);

      // Show the upload box immediately after download click
      document.getElementById('cq-speaking-uploadBox').style.display = 'block';
    };
  }

  isRecording = false;
};

      cqSpeakingMediaRecorder.onerror = (event) => {
        console.error("MediaRecorder error:", event.error);
        alert("Recording error: " + event.error.message);
        isRecording = false;
      };
      
      // Start recording
      cqSpeakingMediaRecorder.start(1000); // Collect data every second
      isRecording = true;
      console.log("Audio recording started");
      
      // Show stop button
      const stopBtn = document.getElementById('cq-speaking-stopBtn');
      if (stopBtn) {
        stopBtn.style.display = 'inline-block';
        stopBtn.textContent = 'â¹ Stop Audio Recording';
      }
      
      // Hide video preview if showing
      const videoPreview = document.getElementById('cq-speaking-videoPreview');
      if (videoPreview) {
        videoPreview.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Audio recording error:', error);
      let errorMessage = 'Failed to access microphone: ';
      if (error.name === 'NotAllowedError') {
        errorMessage += 'Permission denied. Please allow microphone access and try again.';
      } else if (error.name === 'NotFoundError') {
        errorMessage += 'No microphone found.';
      } else if (error.name === 'NotReadableError') {
        errorMessage += 'Microphone is already in use.';
      } else {
        errorMessage += error.message;
      }
      alert(errorMessage);
      isRecording = false;
    });
  }

  // Fixed video recording function
  function startVideoRecording() {
    document.getElementById('cq-speaking-downloadBtn').style.display = 'none';

    console.log("Starting video recording...");
    
    if (!checkRecordingSupport()) return;
    
    // Stop any existing recording first
    cqSpeakingStopAllMedia();
    cqSpeakingRecordedChunks = [];
    
    navigator.mediaDevices.getUserMedia({ 
      video: {
        width: { min: 640, ideal: 1280, max: 1920 },
        height: { min: 480, ideal: 720, max: 1080 },
        frameRate: { min: 15, ideal: 30, max: 60 }
      }, 
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100
      }
    })
    .then(stream => {
      console.log("Video stream obtained successfully");
      cqSpeakingMediaStream = stream;
      
      const videoElement = document.getElementById('cq-speaking-videoPreview');
      if (!videoElement) {
        console.error("Video preview element not found in DOM");
        alert("Video preview element not found");
        return;
      }
      
      // Set up video preview
      videoElement.srcObject = stream;
      videoElement.muted = true; // Prevent feedback
      videoElement.autoplay = true;
      videoElement.playsInline = true; // Important for mobile
      videoElement.style.display = 'block';
      
      // Wait for video to be ready before starting recording
      videoElement.addEventListener('loadedmetadata', () => {
        videoElement.play().catch(e => {
          console.error("Error playing video preview:", e);
        });
      });
      
      // Hide audio playback if showing
      const audioPlayback = document.getElementById('cq-speaking-audioPlayback');
      if (audioPlayback) {
        audioPlayback.style.display = 'none';
      }
      
      // Set up MediaRecorder with best available format
      let options = {};
      if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
        options.mimeType = 'video/webm;codecs=vp9';
      } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
        options.mimeType = 'video/webm;codecs=vp8';
      } else if (MediaRecorder.isTypeSupported('video/webm')) {
        options.mimeType = 'video/webm';
      } else if (MediaRecorder.isTypeSupported('video/mp4')) {
        options.mimeType = 'video/mp4';
      }
      
      cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
      console.log("MediaRecorder created with mimeType:", cqSpeakingMediaRecorder.mimeType);
      
      cqSpeakingMediaRecorder.ondataavailable = (event) => {
        console.log("Video data available:", event.data.size, "bytes");
        if (event.data.size > 0) {
          cqSpeakingRecordedChunks.push(event.data);
        }
      };
      
      cqSpeakingMediaRecorder.onstop = () => {
  console.log("Video recording stopped, processing...");
  if (cqSpeakingRecordedChunks.length === 0) {
    console.error("No video data recorded");
    alert("No video data was recorded. Please try again.");
    return;
  }
  const mimeType = cqSpeakingMediaRecorder.mimeType || 'video/webm';
  const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });
  console.log("Created video blob:", blob.size, "bytes, type:", blob.type);

  const videoURL = URL.createObjectURL(blob);
  const videoElement = document.getElementById('cq-speaking-videoPreview');
  // Switch from live preview to recorded video
  if (videoElement) {
    videoElement.srcObject = null;
    videoElement.src = videoURL;
    videoElement.controls = true;
    videoElement.muted = false;
    videoElement.autoplay = false;
    videoElement.style.display = 'block';
    videoElement.addEventListener('loadedmetadata', () => {
      console.log("Recorded video metadata loaded, duration:", videoElement.duration);
    });
    videoElement.addEventListener('error', (e) => {
      console.error("Video playback error:", e);
    });
    videoElement.load();
  } else {
    console.error("Video preview element not found in DOM");
  }

  // Download & Upload section - THIS IS WHAT YOU WANT
  const downloadBtn = document.getElementById('cq-speaking-downloadBtn');
  if (downloadBtn && blob) {
    downloadBtn.style.display = 'inline-block';
    downloadBtn.onclick = function() {
      // Create a temporary link and trigger download
      const url = URL.createObjectURL(blob);
      const filename = `CertQuest_Response_${Date.now()}.webm`;
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 100);

      // Show the upload box immediately after download click
      document.getElementById('cq-speaking-uploadBox').style.display = 'block';
    };
  }

  isRecording = false;
};

      cqSpeakingMediaRecorder.onerror = (event) => {
        console.error("MediaRecorder error:", event.error);
        alert("Recording error: " + event.error.message);
        isRecording = false;
      };
      
      // Start recording
      cqSpeakingMediaRecorder.start(1000); // Collect data every second
      isRecording = true;
      console.log("Video recording started");
      
      // Show stop button
      const stopBtn = document.getElementById('cq-speaking-stopBtn');
      if (stopBtn) {
        stopBtn.style.display = 'inline-block';
        stopBtn.textContent = 'â¹ Stop Video Recording';
      }
    })
    .catch(error => {
      console.error('Video recording error:', error);
      let errorMessage = 'Failed to access camera/microphone: ';
      if (error.name === 'NotAllowedError') {
        errorMessage += 'Permission denied. Please allow camera and microphone access and try again.';
      } else if (error.name === 'NotFoundError') {
        errorMessage += 'No camera or microphone found.';
      } else if (error.name === 'NotReadableError') {
        errorMessage += 'Camera or microphone is already in use.';
      } else {
        errorMessage += error.message;
      }
      alert(errorMessage);
      isRecording = false;
    });
  }



function removeCompInput(button) {
  const inputGroup = button.closest('.comp-input-group');
  const container = document.getElementById('competitionInputs');
  
  // Don't remove if it's the last input
  if (container && container.children.length > 1) {
    inputGroup.remove();
  }
}

// Get all competition values
function getCompetitionValues() {
  const inputs = document.querySelectorAll('.comp-input');
  return Array.from(inputs)
    .map(input => {
      // Handle both text inputs and select dropdowns
      if (input.tagName === 'SELECT') {
        return input.value.trim();
      } else {
        return input.value.trim();
      }
    })
    .filter(value => value !== '');
}

  
  function cqSpeakingStopAllMedia() {
    console.log("Stopping all media...");
    
    // Stop MediaRecorder
    if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state !== "inactive") {
      try {
        cqSpeakingMediaRecorder.stop();
      } catch (e) {
        console.error("Error stopping MediaRecorder:", e);
      }
    }
    
    // Stop all media tracks
    if (cqSpeakingMediaStream) {
      cqSpeakingMediaStream.getTracks().forEach(track => {
        track.stop();
        console.log("Stopped track:", track.kind, track.label);
      });
      cqSpeakingMediaStream = null;
    }
    
    // Clear recorded data
    cqSpeakingRecordedChunks = [];
    
    // Hide stop button
    const stopBtn = document.getElementById('cq-speaking-stopBtn');
    if (stopBtn) {
      stopBtn.style.display = 'none';
    }
    
    // Reset video element
    const videoElement = document.getElementById('cq-speaking-videoPreview');
    if (videoElement) {
      videoElement.srcObject = null;
      videoElement.src = '';
      videoElement.controls = false;
    }
    
    isRecording = false;
    console.log("All media stopped and cleaned up");
  }

  // Add this to your home page JavaScript
// STEP 2: Add this to your home.html file

// Define updateSaveState function before it's used
function updateSaveState() {
  const roleSelected = document.querySelector('.role-btn.selected');
  const goalSelected = document.querySelector('.goal-card.selected');
  
  // Check if any competition input has value
  let hasCompetitions = false;
  
  // Check main competition input
  const compsInput = document.getElementById('comps');
  if (compsInput && compsInput.value.trim()) {
    hasCompetitions = true;
  }
  
  // Check dynamically added competition inputs
  if (!hasCompetitions) {
    const additionalCompInputs = document.querySelectorAll('.comp-input');
    hasCompetitions = Array.from(additionalCompInputs).some(input => {
      if (input.tagName === 'SELECT') {
        return input.value.trim();
      } else {
        return input.value.trim();
      }
    });
  }
  
  // Enable button only if all required elements exist and have values
  const goalSubmitBtn = document.getElementById('goalSubmitBtn');
  if (goalSubmitBtn) {
    goalSubmitBtn.disabled = !(roleSelected && goalSelected && hasCompetitions);
  }
}

  // Moved to consolidated DOMContentLoaded listener below

  // Consolidated DOMContentLoaded listener - all initialization code
  document.addEventListener('DOMContentLoaded', async function() {
    // FORCE SELECT ELEMENTS TO BE DROPDOWNS - RUN IMMEDIATELY
    function forceSelectsToBeDropdowns() {
      const compsSelect = document.getElementById('comps');
      const mentorCompSelect = document.getElementById('mentorComp');
      
      // If comps is not a select, replace it with a select
      if (compsSelect && compsSelect.tagName !== 'SELECT') {
        console.warn('âš ï¸ comps element is not a SELECT, replacing it...');
        const newSelect = document.createElement('select');
        newSelect.id = 'comps';
        newSelect.className = 'comp-input';
        newSelect.style.cssText = 'flex: 1; height: 48px; padding: 12px 16px; padding-right: 2.5rem; border: 2px solid rgba(239, 68, 68, 0.5); border-radius: 8px; font-size: 16px; background-color: rgba(127, 29, 29, 0.3); color: #fff; cursor: pointer; width: 100%; appearance: menulist; -webkit-appearance: menulist; -moz-appearance: menulist; background-image: url(\'data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 12 12%22><path fill=%22%23fff%22 d=%22M6 9L1 4h10z%22/></svg>\'); background-repeat: no-repeat; background-position: right 12px center; background-size: 12px;';
        newSelect.innerHTML = '<option value="" style="background-color: rgba(127, 29, 29, 0.3); color: #fca5a5;">Select a competition...</option>';
        compsSelect.parentNode.replaceChild(newSelect, compsSelect);
      }
      
      // If mentorComp is not a select, replace it with a select
      if (mentorCompSelect && mentorCompSelect.tagName !== 'SELECT') {
        console.warn('âš ï¸ mentorComp element is not a SELECT, replacing it...');
        const newSelect = document.createElement('select');
        newSelect.id = 'mentorComp';
        newSelect.className = 'mentor-comp-input';
        newSelect.style.cssText = 'flex: 1; height: 48px; padding: 12px 16px; padding-right: 2.5rem; border: 2px solid rgba(239, 68, 68, 0.5); border-radius: 8px; font-size: 16px; background: rgba(127, 29, 29, 0.3); color: #fff; cursor: pointer; width: 100%; appearance: menulist; -webkit-appearance: menulist; -moz-appearance: menulist; background-image: url(\'data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 12 12%22><path fill=%22%23fff%22 d=%22M6 9L1 4h10z%22/></svg>\'); background-repeat: no-repeat; background-position: right 12px center; background-size: 12px;';
        newSelect.innerHTML = '<option value="" style="background-color: rgba(127, 29, 29, 0.3); color: #fca5a5;">Select a competition...</option>';
        mentorCompSelect.parentNode.replaceChild(newSelect, mentorCompSelect);
      }
      
      // Prevent any input events on select elements and ensure they're always dropdowns
      document.querySelectorAll('select.comp-input, select.mentor-comp-input').forEach(select => {
        // Remove contenteditable if it exists
        select.removeAttribute('contenteditable');
        select.setAttribute('contenteditable', 'false');
        
        // Force appearance to be dropdown
        select.style.appearance = 'menulist';
        select.style.webkitAppearance = 'menulist';
        select.style.mozAppearance = 'menulist';
        
        // Prevent keydown/keypress events that might allow typing
        const preventTyping = function(e) {
          // Only allow arrow keys, enter, escape, tab, home, end
          const allowedKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Enter', 'Escape', 'Tab', 'Home', 'End', 'PageUp', 'PageDown'];
          if (!allowedKeys.includes(e.key) && !e.ctrlKey && !e.metaKey && !e.altKey) {
            e.preventDefault();
            e.stopPropagation();
            return false;
          }
        };
        
        // Remove old listeners and add new ones with capture phase
        select.removeEventListener('keydown', preventTyping, true);
        select.removeEventListener('keypress', preventTyping, true);
        select.addEventListener('keydown', preventTyping, true);
        select.addEventListener('keypress', preventTyping, true);
        
        // Prevent input events
        const preventInput = function(e) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        };
        select.removeEventListener('input', preventInput, true);
        select.addEventListener('input', preventInput, true);
        
        // Prevent paste
        select.addEventListener('paste', function(e) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }, true);
        
        // Ensure it's a select
        if (select.tagName !== 'SELECT') {
          console.error('âŒ Element with class comp-input or mentor-comp-input is not a SELECT!', select);
        }
      });
    }
    
    // Run immediately
    forceSelectsToBeDropdowns();
    
    // Run again after a short delay to catch any dynamic changes
    setTimeout(forceSelectsToBeDropdowns, 100);
    setTimeout(forceSelectsToBeDropdowns, 500);
    setTimeout(forceSelectsToBeDropdowns, 1000);
    
    // Watch for any changes to these elements and force them to be selects
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList' || mutation.type === 'attributes') {
          const compsEl = document.getElementById('comps');
          const mentorCompEl = document.getElementById('mentorComp');
          
          if (compsEl && compsEl.tagName !== 'SELECT') {
            console.warn('ðŸš¨ comps element changed to non-SELECT! Forcing back to SELECT...');
            forceSelectsToBeDropdowns();
          }
          
          if (mentorCompEl && mentorCompEl.tagName !== 'SELECT') {
            console.warn('ðŸš¨ mentorComp element changed to non-SELECT! Forcing back to SELECT...');
            forceSelectsToBeDropdowns();
          }
          
          // Check all elements with these classes
          document.querySelectorAll('.comp-input, .mentor-comp-input').forEach(el => {
            if (el.tagName !== 'SELECT' && el.id !== 'school') {
              console.warn('ðŸš¨ Found non-SELECT element with comp-input class!', el);
              if (el.tagName === 'INPUT') {
                // Replace input with select
                const newSelect = document.createElement('select');
                newSelect.className = el.className;
                newSelect.id = el.id;
                newSelect.style.cssText = 'flex: 1; padding: 0.75rem; padding-right: 2.5rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; background: white; color: #1f2937; cursor: pointer; width: 100%; appearance: auto; -webkit-appearance: menulist; -moz-appearance: menulist; background-image: url(\'data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 12 12%22><path fill=%22%23333%22 d=%22M6 9L1 4h10z%22/></svg>\'); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 12px;';
                newSelect.innerHTML = '<option value="">Select a competition...</option>';
                el.parentNode.replaceChild(newSelect, el);
                if (window.allCompetitions && window.allCompetitions.length > 0) {
                  window.allCompetitions.forEach(comp => {
                    const option = document.createElement('option');
                    option.value = comp;
                    option.textContent = comp;
                    newSelect.appendChild(option);
                  });
                }
              }
            }
          });
        }
      });
    });
    
    // Start observing
    const goalModal = document.getElementById('goalModal');
    if (goalModal) {
      observer.observe(goalModal, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['tagName', 'type']
      });
    }
    
    await loadCompetitionsFromFirestore();
    // 1. Navigation link handling for mobile
    document.querySelectorAll('.blaze-nav .nav-link').forEach(link => {
      link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
          toggleMobileNav();
        }
      });
    });

    // 2. Galaxy background and duck rotation
    createStars();
    displayDailyQuote();
    
    // Initialize duck rotation
    duckContainer = document.getElementById('duckContainer');
    duckWrapper = document.getElementById('duckWrapper');
    
    if (duckContainer && duckWrapper) {
      duckContainer.addEventListener('mousemove', handleDuckMouseMove);
      duckContainer.addEventListener('mouseleave', handleDuckMouseLeave);
      // Start bobbing animation
      animateBobbing();
      console.log('Duck rotation initialized');
    } else {
      console.error('Duck container or wrapper not found');
    }

    // 3. Initialize written modal
    writtenModal = createWrittenModal();

    // 4. Load competitions from Firestore on page load
    console.log('Page loaded, loading competitions...');
    console.log('Competitions loaded:', window.allCompetitions);
    
    // 5. Check recording support on page load
    checkRecordingSupport();

    // 6. Assign global variables for goal modal
    modal = document.getElementById('goalModal');
    backdrop = document.querySelector('.modal-backdrop');
    goalSubmitBtn = document.getElementById('goalSubmitBtn');
    compsInput = document.getElementById('comps');
    goalCards = document.querySelectorAll('.goal-card');
    isMentorCheckbox = document.getElementById('isMentor');
    mentorCompDiv = document.getElementById('mentorCompDiv');
    mentorCompInput = document.getElementById('mentorComp');
    selectedGoal = null;

    // 7. Check if we should open notifications
    if (sessionStorage.getItem('openNotifications') === 'true') {
      // Clear the flag so it doesn't happen again
      sessionStorage.removeItem('openNotifications');
      
      // Open your notifications panel - replace with your actual function name
      if (typeof toggleCommentPanel === 'function') {
        toggleCommentPanel();
      }
    }

    // 8. Set up competition input event listeners
    if (compsInput) {
      // Handle both text inputs and select dropdowns
      if (compsInput.tagName === 'SELECT') {
        compsInput.addEventListener('change', updateSaveState);
      } else {
        compsInput.addEventListener('input', updateSaveState);
      }
    } else {
      console.error("compsInput element not found");
    }

    // Set up recording button event listeners
    const audioBtn = document.getElementById('cq-speaking-audioBtn');
    const videoBtn = document.getElementById('cq-speaking-videoBtn');
    const stopBtn = document.getElementById('cq-speaking-stopBtn');
    const submitBtn = document.getElementById('cq-speaking-submitBtn');
    const closeBtn = document.querySelector('.cq-speaking-close');

    if (audioBtn) {
      audioBtn.addEventListener('click', startAudioRecording);
    }
    
    if (videoBtn) {
      videoBtn.addEventListener('click', startVideoRecording);
    }
    
    if (stopBtn) {
      stopBtn.addEventListener('click', stopRecording);
    }
    
    if (submitBtn) {
      submitBtn.addEventListener('click', submitSpeakingResponse);
    }
    
    if (closeBtn) {
      closeBtn.addEventListener('click', closeSpeakingAssignmentModal);
    }

    

    // === DRAG AND DROP UPLOAD FUNCTIONALITY ===
    let selectedUploadFile = null;

    function setupDragAndDrop() {
      const dropZone = document.getElementById('cq-speaking-dropZone');
      const uploadInput = document.getElementById('cq-speaking-uploadInput');
      const submitBtn = document.getElementById('cq-speaking-uploadSubmitBtn');
      const dropZoneText = document.getElementById('cq-speaking-dropZone-text');

      if (!dropZone || !uploadInput || !submitBtn || !dropZoneText) {
        return; // Elements don't exist yet
      }

      // Click on dropZone opens file dialog
      dropZone.addEventListener('click', (e) => {
        e.preventDefault();
        uploadInput.click();
      });

      // Drag over styling
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.background = '#e0ebff';
        dropZone.style.borderColor = '#1e40af';
        dropZone.style.transform = 'scale(1.02)';
      });

      // Drag enter
      dropZone.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
      });

      // Drag leave styling
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        // Only reset if we're leaving the dropZone itself
        if (!dropZone.contains(e.relatedTarget)) {
          dropZone.style.background = '#f3f6fd';
          dropZone.style.borderColor = '#2563eb';
          dropZone.style.transform = 'scale(1)';
        }
      });

      // Drop handler
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.style.background = '#f3f6fd';
        dropZone.style.borderColor = '#2563eb';
        dropZone.style.transform = 'scale(1)';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleUploadFile(files[0]);
        }
      });

      // File input change handler
      uploadInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          handleUploadFile(file);
        }
      });

      function handleUploadFile(file) {
        console.log('File selected:', file.name, file.type, file.size);
        
        // Check file type
        if (!file.type.startsWith('audio/') && !file.type.startsWith('video/')) {
          dropZoneText.innerHTML = 'âŒ Please upload an audio or video file';
          submitBtn.disabled = true;
          
          selectedUploadFile = null;
          setTimeout(() => resetDropZone(), 3000);
          return;
        }

        // Check file size (limit to 100MB)
        const maxSize = 100 * 1024 * 1024; // 100MB
        if (file.size > maxSize) {
          dropZoneText.innerHTML = 'âŒ File too large (max 100MB)';
          submitBtn.disabled = true;
          selectedUploadFile = null;
          setTimeout(() => resetDropZone(), 3000);
          return;
        }

        // File is valid
        selectedUploadFile = file;
        dropZoneText.innerHTML = `âœ… Selected: ${file.name}`;
        submitBtn.disabled = false;
      }

      function resetDropZone() {
        selectedUploadFile = null;
        dropZoneText.textContent = 'Drop file here or click to select';
        submitBtn.disabled = true;
      }

      // Set up upload submit button
submitBtn.addEventListener('click', async () => {
  if (!selectedUploadFile) {
    alert('Please select a file first');
    return;
  }

  submitBtn.textContent = 'Uploading...';
  submitBtn.disabled = true;

  try {
    // Upload to GitHub
    const arrayBuffer = await selectedUploadFile.arrayBuffer();
    const typedArray = new Uint8Array(arrayBuffer);
    recordedChunks = [typedArray.buffer];

    await submitSpeakingResponse(); // this uploads to GitHub and updates Firestore

    // âœ… Mark assignment as completed in Firestore
    const user = firebase.auth().currentUser;
    const userId = user?.uid;
    const assignmentId = window.currentAssignment?.id;
    const filename = selectedUploadFile.name;
    const githubUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

    if (userId && assignmentId) {
      await db
        .collection('users')
        .doc(userId)
        .collection('assignments')
        .doc(assignmentId)
        .update({
          status: 'completed',
          submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
          fileUrl: githubUrl,
          fileType: 'video',
        });
    }

    alert('Uploaded and marked as complete!');
    document.getElementById('cq-speaking-modal').style.display = 'none';
    markAllNotificationsRead();

  } catch (error) {
    console.error(error);
    alert('Upload failed: ' + (error?.message || error));
  }

  submitBtn.textContent = 'Send to Mentor';
  submitBtn.disabled = false;
});




  // --- Get mentee and assignment info ---
  const user = firebase.auth().currentUser;
  const menteeName = user?.displayName || user?.email || 'Anonymous';
  const assignmentTitle = window.currentAssignment?.title || "Assignment";
  
  // --- Get mentor email ---
    }

    // Call setup function
    setupDragAndDrop();

    

    goalCards.forEach(card => {
      card.addEventListener('click', function() {
        goalCards.forEach(c => c.classList.remove('selected'));
        this.classList.add('selected');
        selectedGoal = this.dataset.goal;
        updateSaveState();
      });
    });
    // Handle both text inputs and select dropdowns
    if (compsInput) {
      if (compsInput.tagName === 'SELECT') {
        compsInput.addEventListener('change', updateSaveState);
      } else {
        compsInput.addEventListener('input', updateSaveState);
      }
    }

    // Mentor logic
    // Make mentor checkbox optional - no need to validate it
if (isMentorCheckbox && mentorCompDiv && mentorCompInput) {
  isMentorCheckbox.addEventListener('change', function() {
    mentorCompDiv.style.display = isMentorCheckbox.checked ? 'block' : 'none';
    // Populate mentor dropdowns when shown
    if (isMentorCheckbox.checked) {
      populateCompetitionDropdowns();
    }
    // No need to call updateSaveState() here since mentor fields are optional
  });
  
  // Handle mentor competition input (both text and select)
  if (mentorCompInput) {
    if (mentorCompInput.tagName === 'SELECT') {
      mentorCompInput.addEventListener('change', updateSaveState);
    } else {
      mentorCompInput.addEventListener('input', updateSaveState);
    }
  }
}
    // Replace your existing goalSubmitBtn event listener with this simpler version:
goalSubmitBtn.addEventListener('click', function() {
  const selectedRole = document.querySelector('.role-btn.selected')?.dataset?.role || 'member';
  
  if (selectedRole && selectedGoal) {
    // Collect ALL competition inputs (main + dynamically added)
    const competitionsArr = [];
    
    // Get all dynamically added competition inputs (handles both text inputs and select dropdowns)
    const additionalCompInputs = document.querySelectorAll('.comp-input');
    additionalCompInputs.forEach(input => {
      const value = input.value.trim();
      if (value) {
        // If it's a select dropdown, just add the value directly
        if (input.tagName === 'SELECT') {
          competitionsArr.push(value);
        } else {
          // If it's a text input, split by comma (for backwards compatibility)
          competitionsArr.push(...value.split(',').map(x => x.trim()).filter(Boolean));
        }
      }
    });
    
    // Collect ALL mentor competition inputs if user is a mentor
    const mentorCompetitionsArr = [];
    if (isMentorCheckbox && isMentorCheckbox.checked) {
      // Get main mentor competition input
      const mainMentorCompInput = document.getElementById('mentorComp');
      if (mainMentorCompInput && mainMentorCompInput.value.trim()) {
        const value = mainMentorCompInput.value.trim();
        // If it's a select dropdown, just add the value directly
        if (mainMentorCompInput.tagName === 'SELECT') {
          mentorCompetitionsArr.push(value);
        } else {
          // If it's a text input, split by comma (for backwards compatibility)
          mentorCompetitionsArr.push(...value.split(',').map(x => x.trim()).filter(Boolean));
        }
      }
      
      // Get all dynamically added mentor competition inputs
      const additionalMentorCompInputs = document.querySelectorAll('.mentor-comp-input');
      additionalMentorCompInputs.forEach(input => {
        const value = input.value.trim();
        if (value) {
          // If it's a select dropdown, just add the value directly
          if (input.tagName === 'SELECT') {
            mentorCompetitionsArr.push(value);
          } else {
            // If it's a text input, split by comma (for backwards compatibility)
            mentorCompetitionsArr.push(...value.split(',').map(x => x.trim()).filter(Boolean));
          }
        }
      });
    }
    
    // Require at least one competition
    if (competitionsArr.length === 0) {
      alert('Please enter at least one competition');
      return;
    }
    
    // Update UI
    document.getElementById('userComps').textContent = competitionsArr.join(', ');
    
    // Save to Firebase (SINGLE operation with all data)
    const user = auth.currentUser;
    if (user) {
      const userData = {
        role: selectedRole,
        competitions: competitionsArr,
        isMentor: isMentorCheckbox ? isMentorCheckbox.checked : false,
        studyGoalSet: true,
        needsApproval: false, // Keep field for compatibility, but set to false so all users can access
        school: document.getElementById('school')?.value || '' // Add school field
      };
      
      // Add mentor competitions if user is a mentor
      if (isMentorCheckbox && isMentorCheckbox.checked) {
        userData.mentorCompetition = mentorCompetitionsArr;
      }
      
      db.collection('users').doc(user.uid).set(userData, { merge: true }).then(() => {
        // Close goal modal
        modal.style.display = 'none';
        backdrop.style.display = 'none';
        
        // Show personality modal after goal is set (only for new accounts)
        // Check if this is a new account by checking if duckPersonality exists
        db.collection('users').doc(user.uid).get().then(doc => {
          if (checkIfNewAccount(doc)) {
            setTimeout(() => {
              showPersonalityModal();
            }, 300);
          }
        });
        
        // All users can access the platform directly
        if (selectedRole === 'advisor' || selectedRole === 'chapter account') {
          window.location.href = 'dashboard.html';
        } else if (selectedRole === 'individual') {
          window.location.href = 'home.html';
        }
      }).catch((error) => {
        console.error("Error saving user data:", error);
        alert("Failed to save your information. Please try again.");
      });
    }
  }
});

// Updated addCompBtn event listener to include input validation
const addCompBtn = document.getElementById('addCompBtn');
if (addCompBtn) {
  addCompBtn.addEventListener('click', function() {
    const container = document.getElementById('competitionInputs');
    if (container) {
      const inputGroup = document.createElement('div');
      inputGroup.className = 'comp-input-group';
      
      // Create dropdown with competitions
      const select = document.createElement('select');
      select.className = 'comp-input';
      select.style.cssText = 'flex: 1; height: 48px; padding: 12px 16px; padding-right: 2.5rem; border: 2px solid rgba(239, 68, 68, 0.5); border-radius: 8px; font-size: 16px; background-color: rgba(127, 29, 29, 0.3); color: #fff; cursor: pointer; appearance: menulist; -webkit-appearance: menulist; -moz-appearance: menulist; background-image: url(\'data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 12 12%22><path fill=%22%23fff%22 d=%22M6 9L1 4h10z%22/></svg>\'); background-repeat: no-repeat; background-position: right 12px center; background-size: 12px;';
      select.innerHTML = '<option value="" style="background-color: rgba(127, 29, 29, 0.3); color: #fca5a5;">Select a competition...</option>';
      
      // Populate with competitions from Firestore
      if (window.allCompetitions && window.allCompetitions.length > 0) {
        window.allCompetitions.forEach(comp => {
          const option = document.createElement('option');
          option.value = comp;
          option.textContent = comp;
          select.appendChild(option);
        });
      }
      
      inputGroup.innerHTML = '';
      inputGroup.appendChild(select);
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-comp-btn';
      removeBtn.textContent = 'Ã—';
      removeBtn.onclick = function() { removeCompInput(this); };
      inputGroup.appendChild(removeBtn);
      
      container.appendChild(inputGroup);
      
      // Add change validation listener to new field
      select.addEventListener('change', updateSaveState);
    }
  });
}

// Updated addMentorCompBtn event listener to include input validation
const addMentorCompBtn = document.getElementById('addMentorCompBtn');
if (addMentorCompBtn) {
  addMentorCompBtn.addEventListener('click', function() {
    const container = document.getElementById('mentorCompetitionInputs');
    if (container) {
      const inputGroup = document.createElement('div');
      inputGroup.className = 'mentor-comp-input-group';
      inputGroup.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;';
      
      // Create dropdown with competitions
      const select = document.createElement('select');
      select.className = 'mentor-comp-input';
      select.style.cssText = 'flex: 1; height: 48px; padding: 12px 16px; padding-right: 2.5rem; border: 2px solid rgba(239, 68, 68, 0.5); border-radius: 8px; font-size: 16px; background: rgba(127, 29, 29, 0.3); color: #fff; transition: border-color 0.2s; outline: none; appearance: menulist; -webkit-appearance: menulist; -moz-appearance: menulist; cursor: pointer; background-image: url(\'data:image/svg+xml;charset=UTF-8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%2212%22 viewBox=%220 0 12 12%22><path fill=%22%23fff%22 d=%22M6 9L1 4h10z%22/></svg>\'); background-repeat: no-repeat; background-position: right 12px center; background-size: 12px;';
      select.innerHTML = '<option value="" style="background-color: rgba(127, 29, 29, 0.3); color: #fca5a5;">Select a competition...</option>';
      
      // Populate with competitions from Firestore
      if (window.allCompetitions && window.allCompetitions.length > 0) {
        window.allCompetitions.forEach(comp => {
          const option = document.createElement('option');
          option.value = comp;
          option.textContent = comp;
          select.appendChild(option);
        });
      }
      
      inputGroup.appendChild(select);
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'remove-mentor-comp-btn';
      removeBtn.textContent = 'Ã—';
      removeBtn.style.cssText = 'width: 48px; height: 48px; margin-bottom: 5px; border: none; background-color: #fee2e2; color: #dc2626; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;';
      removeBtn.onclick = function() { removeMentorCompInput(this); };
      inputGroup.appendChild(removeBtn);
      
      container.appendChild(inputGroup);
      
      // Add change validation listener to new mentor field
      select.addEventListener('change', updateSaveState);
    }
  });
}

// Load competitions from Firestore
// Populate all competition dropdowns with loaded competitions

// Updated remove functions with validation
function removeCompInput(button) {
  button.parentElement.remove();
  updateSaveState(); // Recheck validation after removing input
}

function removeMentorCompInput(button) {
  button.parentElement.remove();
  updateSaveState(); // Recheck validation after removing input
}

if (backdrop) {
      backdrop.addEventListener('click', function() {
        modal.style.display = 'none';
        backdrop.style.display = 'none';
      });
    }

    // ---- Show full name from Firestore and modal logic ----
    auth.onAuthStateChanged(function(user) {
  if (!user) { window.location.href = "/Public/landing.html"; return; }
  if (user) {
    db.collection('users').doc(user.uid).get()
      .then(function(doc) {
        let fullName = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
        if (doc.exists && doc.data().name) {
          fullName = doc.data().name;
        }
        document.getElementById('userName').textContent = fullName;

        if (doc.exists && doc.data().competitions) {
          document.getElementById('userComps').textContent = doc.data().competitions;
        }
        

        // Load duck personality from Firebase (for existing accounts)
        if (doc.exists && doc.data().duckPersonality) {
          duckPersonality = doc.data().duckPersonality;
          localStorage.setItem('duckPersonality', duckPersonality);
        } else {
          // Check localStorage as fallback
          duckPersonality = localStorage.getItem('duckPersonality');
        }

        // Ensure user document has name field for leaderboard
        if (doc.exists && !doc.data().name) {
          const userName = fullName;
          db.collection('users').doc(user.uid).update({
            name: userName
          }).catch(err => console.error('Error updating user name:', err));
        }
        
        // Ensure user document has XP field (initialize to 0 if missing)
        if (!doc.exists || doc.data().XP === undefined) {
          db.collection('users').doc(user.uid).set({
            XP: 0,
            name: fullName
          }, { merge: true }).catch(err => console.error('Error initializing user XP:', err));
        }
        
        // Load XP and calculate Level from Firebase
        const userXP = doc.exists && doc.data().XP !== undefined ? doc.data().XP : 0;
        // Calculate level: Level = floor(XP / 1500) + 1 (or use stored level if available)
        const userLevel = doc.exists && doc.data().level ? doc.data().level : Math.floor(userXP / 1500) + 1;
        
        // Show/hide mentor link based on isMentor status
        const mentorNavLink = document.getElementById('mentorNavLink');
        if (mentorNavLink) {
          const isMentor = doc.exists && doc.data().isMentor === true;
          mentorNavLink.style.display = isMentor ? 'block' : 'none';
        }
        
        // Update UI with XP and Level
        const xpElement = document.getElementById('userXP');
        const levelElement = document.getElementById('userLevel');
        if (xpElement) {
          xpElement.textContent = userXP.toLocaleString();
        }
        if (levelElement) {
          levelElement.textContent = userLevel;
        }

        // Calculate weekly XP from completed assignments this week
        calculateWeeklyXP(user.uid);

        // Load user streak from Firebase
        const userStreak = doc.exists && doc.data().streak ? doc.data().streak : 0;
        const streakElement = document.getElementById('userStreak');
        if (streakElement) {
          streakElement.textContent = userStreak;
        }

        // Calculate user rank from leaderboard
        calculateUserRank(user.uid, userXP);
        
        // Set up real-time listener for XP updates
        db.collection('users').doc(user.uid).onSnapshot((snapshot) => {
          if (snapshot.exists) {
            const data = snapshot.data();
            const updatedXP = data.XP !== undefined ? data.XP : 0;
            const updatedLevel = Math.floor(updatedXP / 1500) + 1;
            
            // Update UI
            const xpElement = document.getElementById('userXP');
            if (xpElement) {
              xpElement.textContent = updatedXP.toLocaleString();
            }
            
            const levelElement = document.getElementById('userLevel');
            if (levelElement) {
              levelElement.textContent = updatedLevel;
            }
            
            // Recalculate rank
            calculateUserRank(user.uid, updatedXP);
          }
        }, (error) => {
          console.error('Error listening to XP updates:', error);
        });

        // Load user image/avatar from Firebase
        const userImage = doc.exists && doc.data().photoURL ? doc.data().photoURL : (user.photoURL || null);
        // If you have a user image element, update it here
        // Example: if (userImage) { document.getElementById('userImage').src = userImage; }

        // DEBUG: See exactly what Firestore returns!
        console.log("User doc.exists:", doc.exists);
        console.log("User doc.data:", doc.data());
        console.log("User XP:", userXP, "Level:", userLevel, "Streak:", userStreak);
        
        // Only show goal modal for completely new accounts (no document exists or studyGoalSet is false/undefined)
        // Hide by default first to prevent any flash
        modal.style.display = 'none';
        backdrop.style.display = 'none';
        
        // Only show for new accounts after a tiny delay to ensure DOM is ready
        if (!doc.exists || !doc.data().studyGoalSet) {
          // This is a new account - show the goal modal after a brief delay
          // Load competitions from Firestore first
          loadCompetitionsFromFirestore().then((competitions) => {
            console.log('Competitions loaded:', competitions);
            // Ensure dropdowns are populated after a brief delay to ensure DOM is ready
            setTimeout(() => {
              populateCompetitionDropdowns();
              modal.style.display = 'block';
              backdrop.style.display = 'block';
            }, 100);
          }).catch((error) => {
            console.error('Error loading competitions:', error);
            // Still show modal even if competitions fail to load
            setTimeout(() => {
              modal.style.display = 'block';
              backdrop.style.display = 'block';
            }, 100);
          });
        } else {
          // Existing account with goal set - ensure modal stays hidden
          modal.style.display = 'none';
          backdrop.style.display = 'none';
          
          // Only show personality modal for new accounts (after goal is set)
          if (checkIfNewAccount(doc)) {
            setTimeout(() => {
              showPersonalityModal();
            }, 500);
          }
        }
      })
      .catch(function(error) {
        console.error("Error fetching user data:", error);
        let fallbackName = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
        document.getElementById('userName').textContent = fallbackName;
      });

    setupNotifications();
    
    // Load AI Performance Insights from Firebase
    loadAIPerformanceInsights();
    
    // --- REALTIME ASSIGNMENT LISTENER (for mentors giving assignments) ---
    console.log("Setting up assignment listener for user:", user.uid);
    
    db.collection('assignments')
      .where('to', '==', user.uid)
      .where('status', '==', 'assigned')
      .onSnapshot(snapshot => {
        console.log("Assignment snapshot received:", snapshot.size, "documents");
        
        snapshot.forEach(doc => {
          const data = doc.data();
          console.log("Assignment data:", data);
          
          if (data.status === "assigned") {
            showAssignmentModal(data, doc.id);
          }
        });
      }, error => {
        console.error("Assignment listener error:", error);
      });
    
    // --- Mentor Comment Modal Check ---
    (async function checkMentorComments() {
      try {
        const snapshot = await db.collection('notifications')
          .where('menteeId', '==', user.uid)
          .where('read', '==', false)
          .where('type', '==', 'mentorComment')
          .get();

        snapshot.forEach(doc => {
          const notif = doc.data();
          console.log("Found mentor feedback notification:", notif);
          showMentorCommentModal(
            notif.assignmentName || "Assignment",
            notif.comment || notif.message || "No feedback provided.",
            doc.id
          );
        });
      } catch (err) {
        console.error("Failed to check mentor comments:", err);
      }
    })();
    (async function checkMentorComments() {
      try {
        const snapshot = await db.collection('notifications')
          .where('menteeId', '==', user.uid)
          .where('read', '==', false)
          .where('type', '==', 'mentorComment')
          .get();

        snapshot.forEach(doc => {
          const notif = doc.data();
          console.log("Found mentor feedback notification:", notif);
          showMentorCommentModal(
            notif.assignmentName || "Assignment",
            notif.comment || notif.message || "No feedback provided.",
            doc.id
          );
        });
      } catch (err) {
        console.error("Failed to check mentor comments:", err);
      }
    })();

  } else {
    auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "/Public/landing.html";
  }
});

  }
});

    // ============ MEILISEARCH INTEGRATION ============
    const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
    const index = client.index('content');
    // Search bar removed
    const searchBox = null;
    const searchDropdown = null;
    const searchIcon = null;

    if (false && searchBox && searchDropdown) {
      searchBox.addEventListener('input', async function(e) {
        const query = e.target.value.trim();
        if (!query) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
          return;
        }
        try {
          const result = await index.search(query, { limit: 5 });
          if (!result.hits.length) {
            searchDropdown.style.display = 'none';
            searchDropdown.innerHTML = '';
            return;
          }
          searchDropdown.style.display = 'block';
          searchDropdown.innerHTML = result.hits.map(doc => `
            <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
              <b>${doc.title}</b><br>
              <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
            </div>
          `).join('');
        } catch (err) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
        }
      });

      // Handle result click
      searchDropdown.addEventListener('click', function(e) {
        const target = e.target.closest('.dropdown-result');
        if (target && target.dataset.url) {
          window.location = target.dataset.url;
        }
      });

      // Optional: Allow Enter key to open first result
      searchBox.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && searchDropdown.innerHTML) {
          const first = searchDropdown.querySelector('.dropdown-result');
          if (first && first.dataset.url) {
            window.location = first.dataset.url;
          }
        }
      });

      // Hide dropdown on outside click
      document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.style.display = 'none';
        }
      });

      // Click magnifier icon triggers search
      if (searchIcon) {
        searchIcon.addEventListener('click', () => {
          searchBox.dispatchEvent(new Event('input'));
        });
      }
    }

    // === REALTIME ASSIGNMENT LISTENER ===
    auth.onAuthStateChanged(function(user) {
  if (!user) { window.location.href = "/Public/landing.html"; return; }
      if (!user) return;
      
      
      console.log("Setting up assignment listener for user:", user.uid);
      
      db.collection('assignments')
        .where('to', '==', user.uid)
        .where('status', '==', 'assigned')
        .onSnapshot(snapshot => {
          console.log("Assignment snapshot received:", snapshot.size, "documents");
          
          snapshot.forEach(doc => {
            const data = doc.data();
            console.log("Assignment data:", data);
            
            if (data.status === "assigned") {
              showAssignmentModal(data, doc.id);
            }
          });
        }, error => {
          console.error("Assignment listener error:", error);
        });
    });
        document.head.insertAdjacentHTML('beforeend', uploadModalCSS);

  });


// Add this HTML to your page (insert anywhere in body)

  function removeMentorCompInput(button) {
  button.parentElement.remove();
  updateSaveState(); // Recheck validation after removing input
}
  // === ASSIGNMENT MODAL FUNCTIONS ===
function showAssignmentModal(assignment, docId) {
    console.log("showAssignmentModal called with:", assignment, docId);
    
    // Set the global assignment ID for later use
    window.latestAssignmentId = docId;
    window.currentAssignment = assignment;
    
    // Store notification in Firebase (only if it doesn't already exist)
    const user = firebase.auth().currentUser;
    if (user) {
        // Check if notification already exists for this assignment
        db.collection('notifications')
            .where('menteeId', '==', user.uid)
            .where('assignmentId', '==', docId)
            .where('type', '==', 'assignment')
            .limit(1)
            .get()
            .then(existingSnapshot => {
                if (existingSnapshot.empty) {
                    // Only create notification if it doesn't exist
                    const notificationData = {
                        menteeId: user.uid,
                        type: 'assignment',
                        assignmentId: docId,
                        assignmentName: assignment.title || "New Assignment",
                        message: `New Assignment: ${assignment.title || "Assignment"}`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        showModal: false, // Don't auto-show modal for assignments
                        assignmentType: assignment.type || 'quiz',
                        competencies: assignment.competencies || [],
                        difficulty: assignment.difficulty || 'Medium',
                        time: assignment.time || '10 mins'
                    };
                    
                    // Add assignment-specific details
                    if (assignment.type === "speaking" || assignment.type === "case") {
                        notificationData.questions = assignment.questions || [];
                        notificationData.description = assignment.description || '';
                    } else if (assignment.type === "written") {
                        notificationData.questionCount = assignment.writtenQuestions ? assignment.writtenQuestions.length : 10;
                    } else {
                        notificationData.questions = assignment.questions || 'n/a';
                        notificationData.simulate = assignment.simulate || false;
                    }
                    
                    // Store in Firebase
                    db.collection('notifications').add(notificationData)
                        .then(() => {
                            console.log("Assignment notification stored in Firebase");
                        })
                        .catch(error => {
                            console.error("Error storing assignment notification:", error);
                        });
                } else {
                    console.log("Notification already exists for this assignment, skipping creation");
                }
            })
            .catch(error => {
                console.error("Error checking for existing notification:", error);
            });
    }
    
    // Create in-app notification content
    const notificationTitle = "New Assignment: " + (assignment.title || "Assignment");
    let notificationContent = "";
    
    if (assignment.type === "speaking" || assignment.type === "case") {
        notificationContent = `Type: ${assignment.type === "speaking" ? "Speaking" : "Case"} Assignment\n`;
        notificationContent += `Competencies: ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}\n`;
        notificationContent += `Questions:\n${assignment.questions ? assignment.questions.join('\n') : 'n/a'}`;
    } else {
        notificationContent = `
            Time: ${assignment.time || 'n/a'}
            Competencies: ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}
            Questions: ${assignment.questions || 'n/a'}
            Difficulty: ${assignment.difficulty || 'n/a'}
        `;
    }
    
    // Show notification with full details
    showNotification(notificationTitle, notificationContent, () => {
        // When clicked, open the full modal with all details
        openFullAssignmentModal(assignment);
    });
    
    // Mark assignment as seen (but not completed)
    db.collection('assignments').doc(docId).update({
        status: "seen"
    }).catch(error => {
        console.error("Error updating assignment status:", error);
    });
}


function openFullAssignmentModal(assignment) {
    // Set the modal title
    document.getElementById('cq-assignment-title').innerText = assignment.title || "New Assignment";
    
    // Show info section, hide quiz section
    document.getElementById('cq-assignment-info').style.display = 'block';
    document.getElementById('cq-assignment-quiz').style.display = 'none';
    
    // Fill in all assignment details
    const fieldsElement = document.getElementById('cq-assignment-fields');
    if (fieldsElement) {
        if (assignment.type === "speaking" || assignment.type === "case") {
            // Speaking/Case assignment format
            const q1 = assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided";
            const q2 = assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided";
            
            fieldsElement.innerHTML = `
                <div><b>Type:</b> ${assignment.type === "speaking" ? "Speaking" : "Case"} Assignment</div>
                <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
                <div><b>Description:</b> ${assignment.description || 'n/a'}</div>
                <div><b>Questions:</b></div>
                <ul>
                    <li>${q1}</li>
                    <li>${q2}</li>
                </ul>
            `;
        } else {
            // Regular assignment format
            fieldsElement.innerHTML = `
                <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
                <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
                <div><b>Questions:</b><br> <span style="font-weight:400; color:#333">${assignment.questions || 'n/a'}</span></div>
                <div><b>Difficulty:</b> ${assignment.difficulty || 'n/a'}</div>
                <div><b>Simulate:</b> ${assignment.simulate ? "Yes" : "No"}</div>
            `;
        }

        if (assignment.trainingPDFs && assignment.trainingPDFs.length > 0) {
            assignment.trainingPDFs.forEach(pdf => {
                const pdfBox = document.createElement('div');
                pdfBox.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; font-weight: 500;';
                pdfBox.textContent = pdf.name || 'Training Document';
                pdfBox.onclick = () => downloadPDF(pdf);
                fieldsElement.appendChild(pdfBox);
            });
        }
    }
    
    // Show the modal
    document.getElementById('cq-assignment-modal').style.display = 'block';
}

document.querySelectorAll('.role-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('selected'));
    this.classList.add('selected');
    checkFormCompletion();
  });
});

function checkFormCompletion() {
  const roleSelected = document.querySelector('.role-btn.selected');
  const goalSelected = document.querySelector('.goal-card.selected');
  const submitBtn = document.getElementById('goalSubmitBtn');
  
  submitBtn.disabled = !(roleSelected && goalSelected);
}


function downloadPDF(pdf) {
    const blob = new Blob([pdf.content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = pdf.name || 'training-document.txt';
    a.click();
    URL.revokeObjectURL(url);
}

  function showSpeakingAssignmentInfo(assignment, docId) {
    // Store for later use
    window.latestAssignmentId = docId;
    window.currentAssignment = assignment;
    
    // Set title
    document.getElementById('cq-assignment-title').innerText = assignment.title || "Speaking Assignment";
    
    // Hide quiz, show info
    document.getElementById('cq-assignment-info').style.display = 'block';
    document.getElementById('cq-assignment-quiz').style.display = 'none';
    
    // Fill in assignment fields for speaking
    document.getElementById('cq-assignment-fields').innerHTML = `
      <div><b>Type:</b> Speaking Assignment</div>
      <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
      <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
      <div><b>Description:</b><br> <span style="font-weight:400; color:#333">${assignment.description || assignment.questions || 'Practice your speaking skills'}</span></div>
      <div><b>Question 1:</b> ${assignment.question1 || 'No question provided'}</div>
      <div><b>Question 2:</b> ${assignment.question2 || 'No question provided'}</div>
    `;
    
    // Show the assignment modal (same as regular assignments)
    document.getElementById('cq-assignment-modal').style.display = 'block';
  }

function acceptAssignmentNow() {
    console.log("ðŸš€ acceptAssignmentNow() called");
    
    const assignment = window.currentAssignment;
    console.log("ðŸ“‹ Current assignment:", assignment);
    
    if (!assignment) {
        console.error("âŒ No current assignment found");
        return;
    }
    
    // âœ… IMMEDIATELY mark assignment as complete when user clicks "I'll do it now"
    // Mark assignment as accepted (but not completed)
if (window.latestAssignmentId) {
    console.log("ðŸ“ Marking assignment as accepted");
    
    db.collection('assignments').doc(window.latestAssignmentId).update({
        status: "in_progress",
        acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
}
    // Handle different assignment types
    if (assignment.type === 'case') {
      console.log("ðŸ“‹ Opening case study modal for case assignment");
      document.getElementById('cq-assignment-modal').style.display = 'none';
      
      // Store assignment questions globally for the case study modal
      window.currentAssignmentQuestions = {
        q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
        q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
        title: assignment.title || "Case Study",
        description: assignment.description || assignment.caseStudyContent || ""
      };
      
      openCaseStudyModal(assignment);
      return;
    }
    
    if (assignment.type === 'speaking') {
      console.log("ðŸŽ¤ Opening speaking modal for speaking assignment");
      document.getElementById('cq-assignment-modal').style.display = 'none';
      
      // Store assignment questions globally for the speaking modal
      window.currentAssignmentQuestions = {
        q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
        q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
        title: assignment.title || "Speaking Assignment",
        description: assignment.description || ""
      };
      
      openSpeakingAssignmentModal(assignment);
      return;
    }

    if (assignment.type === 'written') {
        console.log("âœï¸ Opening written assignment (already marked complete)");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        openWrittenPracticeModal(assignment);
        return;
    }

    // Handle regular quiz assignments (already marked complete)
    console.log("ðŸ“ Setting up regular quiz assignment (already marked complete)");
    
    document.getElementById('cq-assignment-info').style.display = 'none';
    document.getElementById('cq-assignment-quiz').style.display = 'block';

    document.getElementById('quizDifficulty').textContent = 'Difficulty: ' + (assignment.difficulty || 'Medium');
    document.getElementById('quizTime').textContent = 'Time: ' + (assignment.time || '10 mins');

    console.log("ðŸŽ¯ Rendering quiz with questions:", quizQuestions);
    renderQuiz(quizQuestions);

    const radioInputs = document.querySelectorAll('#cq-assignment-quiz input[type="radio"]');
    const submitBtn = document.getElementById('submitQuizBtn');
    
    if (!submitBtn) {
        console.error("âŒ Submit button not found!");
        return;
    }
    
    // Enable submit button immediately since assignment is already complete
    submitBtn.disabled = false;
    submitBtn.textContent = "Finish Practice"; // Change text since it's already "complete"
    
    console.log("ðŸ”“ Submit button enabled immediately");

    // Add event listeners for interactive feedback (optional)
    radioInputs.forEach((input, index) => {
        input.addEventListener('change', () => {
            console.log(`ðŸ“¡ Radio input ${index} changed to:`, input.value);
        });
    });

    // Set up the submit button click handler (for practice/feedback only)
    submitBtn.onclick = function() {
        console.log("ðŸ”¥ FINISH PRACTICE CLICKED (assignment already complete)");
        
        // Show completion modal immediately
        closeAssignmentModal();
        
        showCongratsModal({
            message: `Assignment completed! Thanks for practicing.`,
            assignmentName: document.getElementById('cq-assignment-title').textContent
        });
        
        // Show confetti
        confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 }
        });
        
        // Clear assignment data
        window.latestAssignmentId = null;
        window.currentAssignment = null;
    };
    
    console.log("âœ… acceptAssignmentNow() completed - assignment marked complete immediately");
}

const downloadModalHTML = `
<div id="downloadModal" class="download-modal-overlay" style="display: none;">
    <div class="download-modal-container">
        <div class="download-modal-header">
            <h2>Recording Complete!</h2>
            <button onclick="closeDownloadModal()">&times;</button>
        </div>
        <div class="download-modal-body">
            <div style="font-size: 4rem; margin: 20px 0;">ðŸŽ¬</div>
            <p>Your recording is ready!</p>
            <div id="recordingPreview" style="margin: 20px 0;"></div>
        </div>
        <div class="download-modal-footer">
            <button id="downloadRecordingBtn" onclick="downloadRecording()">ðŸ“¥ Download MP4</button>
            <button onclick="closeDownloadModal()">Continue</button>
        </div>
    </div>
</div>`;

function addCameraModalHTML() {
    const cameraModalHTML = `
    <!-- Camera Recording Modal -->
    <div id="cameraModal" class="camera-modal-overlay">
        <div class="camera-container">
            <!-- Header -->
            <div class="camera-header">
                <h2 class="camera-title" id="cameraModalTitle">Record Your Response</h2>
                <button class="camera-close" onclick="closeCameraModal()">&times;</button>
            </div>
            
            <!-- Assignment Questions Display -->
            <div class="assignment-questions">
                <div class="question-card">
                    <strong>Question 1:</strong>
                    <p id="cameraQ1">What is your strategy for this scenario?</p>
                </div>
                <div class="question-card">
                    <strong>Question 2:</strong>
                    <p id="cameraQ2">How would you handle unexpected challenges?</p>
                </div>
            </div>
            
            <!-- Main Video Area -->
            <div class="camera-main">
                <div class="video-preview">
                    <video id="cameraPreview" autoplay muted playsinline></video>
                    <div id="recordingIndicator" class="recording-indicator">â— RECORDING</div>
                    <div id="recordingTimer" class="recording-timer">00:00</div>
                    <div id="noCameraView" class="no-camera" style="display: none;">
                        <div class="no-camera-icon">ðŸŽ¤</div>
                        <div>Audio Only Mode</div>
                        <div class="audio-wave">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="camera-controls">
                <button id="cameraToggle" class="camera-toggle" onclick="toggleCamera()" title="Toggle Camera">ðŸ“¹</button>
                <button id="recordButton" class="record-btn" onclick="toggleRecording()">â—</button>
                <button id="micToggle" class="camera-toggle" onclick="toggleMic()" title="Toggle Microphone">ðŸŽ¤</button>
            </div>
            
            <!-- Actions -->
            <div class="camera-actions">
                <button id="submitRecording" class="action-btn" onclick="submitCameraRecording()" disabled>Submit Response</button>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', cameraModalHTML);
}

function openCameraModal() {
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('cameraModal')) {
        addCameraModalHTML();
        addCameraModalCSS();
    }
    
    // Set assignment questions
    if (window.currentAssignmentQuestions) {
        document.getElementById('cameraModalTitle').textContent = window.currentAssignmentQuestions.title;
        document.getElementById('cameraQ1').textContent = window.currentAssignmentQuestions.q1;
        document.getElementById('cameraQ2').textContent = window.currentAssignmentQuestions.q2;
    }
    
    // Show modal with animation
    const modal = document.getElementById('cameraModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
    
    // Initialize camera
    initializeCamera();
}

function closeCameraModal() {
    const modal = document.getElementById('cameraModal');
    modal.classList.remove('active');
    setTimeout(() => {
        modal.style.display = 'none';
        stopAllMedia();
    }, 300);
    
    // Clear assignment data
    window.latestAssignmentId = null;
    window.currentAssignment = null;
    window.currentAssignmentQuestions = null;
}

async function initializeCamera() {
    try {
        const constraints = {
            video: cameraEnabled,
            audio: micEnabled
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        const videoElement = document.getElementById('cameraPreview');
        
        if (cameraEnabled) {
            videoElement.srcObject = cameraStream;
            videoElement.style.display = 'block';
            document.getElementById('noCameraView').style.display = 'none';
        } else {
            videoElement.style.display = 'none';
            document.getElementById('noCameraView').style.display = 'flex';
        }
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Could not access camera/microphone. Please ensure permissions are granted.');
    }
}

// Dynamic AI Summary Generator for Firebase Assignment Data
class DynamicAISummary {
  constructor(firebaseDb, userId) {
    this.db = firebaseDb;
    this.userId = userId;
    this.summaryContainer = null;
  }

  // Function to calculate competency percentages
  calculateCompetencyPerformance(competencyStats) {
    const competencyPerformance = {};
    
    Object.entries(competencyStats || {}).forEach(([competency, stats]) => {
      if (stats.total > 0) {
        competencyPerformance[competency] = Math.round((stats.correct / stats.total) * 100);
      }
    });
    
    return competencyPerformance;
  }

  // Function to find strongest and weakest areas
  analyzePerformance(competencyPerformance) {
    const entries = Object.entries(competencyPerformance);
    if (entries.length === 0) return { strongest: 'N/A', weakest: 'N/A' };
    
    const strongest = entries.reduce((a, b) => a[1] > b[1] ? a : b)[0];
    const weakest = entries.reduce((a, b) => a[1] < b[1] ? a : b)[0];
    
    return { strongest, weakest };
  }

  // Function to format competency names
  formatCompetencyName(competency) {
    if (!competency || competency === 'N/A') return competency;
    return competency.split(/[\s_]+/)
      .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
      .join(' ');
  }

  // Function to generate encouraging messages
  generateEncouragementMessage(percentage, strongestArea, weakestArea) {
    const formattedStrongest = this.formatCompetencyName(strongestArea);
    const formattedWeakest = this.formatCompetencyName(weakestArea);

    if (percentage >= 80) {
      return `Excellent work! You're mastering ${formattedStrongest}. Keep up the momentum!`;
    } else if (percentage >= 60) {
      return `Good progress! Your ${formattedStrongest} skills are solid. Let's boost your ${formattedWeakest} next!`;
    } else if (percentage >= 40) {
      return `You're building momentum! ${formattedStrongest} is your strength. Focus on ${formattedWeakest} for improvement!`;
    } else {
      return `Every expert was once a beginner! Let's strengthen your ${formattedWeakest} foundation step by step.`;
    }
  }

  // Fetch recent assignments from Firebase
  async fetchRecentAssignments(limit = 5) {
    try {
      const snapshot = await this.db.collection('assignments')
        .where('to', '==', this.userId)
        .where('status', '==', 'complete')
        .orderBy('completedAt', 'desc')
        .limit(limit)
        .get();
      
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    } catch (error) {
      console.error('Error fetching assignments:', error);
      return [];
    }
  }

  // Calculate average performance across multiple assignments
  calculateOverallPerformance(assignments) {
    if (assignments.length === 0) return { averageScore: 0, totalTests: 0 };

    const totalScore = assignments.reduce((sum, assignment) => sum + (assignment.percentage || 0), 0);
    const averageScore = Math.round(totalScore / assignments.length);

    // Combine competency stats from all assignments
    const combinedCompetencyStats = {};
    assignments.forEach(assignment => {
      if (assignment.competencyStats) {
        Object.entries(assignment.competencyStats).forEach(([competency, stats]) => {
          if (!combinedCompetencyStats[competency]) {
            combinedCompetencyStats[competency] = { correct: 0, total: 0 };
          }
          combinedCompetencyStats[competency].correct += stats.correct || 0;
          combinedCompetencyStats[competency].total += stats.total || 0;
        });
      }
    });

    return {
      averageScore,
      totalTests: assignments.length,
      combinedCompetencyStats
    };
  }

  // Generate HTML for the AI summary

  
  generateSummaryHTML(summaryData) {
    const { averageScore, strongestArea, weakestArea, totalTests, competencyBreakdown } = summaryData;
    
    const encouragementMessage = this.generateEncouragementMessage(averageScore, strongestArea, weakestArea);
    
    // Generate competency breakdown HTML
    let competencyHTML = '';
    if (competencyBreakdown && Object.keys(competencyBreakdown).length > 0) {
      const topCompetencies = Object.entries(competencyBreakdown)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5);
      
      competencyHTML = `
        <div style="margin-top: 1rem;">
          <h4 style="font-size: 0.9rem; margin: 0 0 0.5rem 0; opacity: 0.9;">
            Quick Breakdown:
          </h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; font-size: 0.8rem;">
            ${topCompetencies.map(([competency, score]) => `
              <div style="background: rgba(255,255,255,0.1); padding: 0.25rem 0.5rem; border-radius: 4px; text-align: center;">
                <div style="font-weight: bold;">${this.formatCompetencyName(competency)}</div>
                <div style="color: ${score >= 50 ? '#90EE90' : '#FFB6C1'};">${score}%</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    return `
      <div class="ai-summary" style="
        background: #d2e3f9;
        color: black;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
        height: 155px;
        border-left: 7px solid #0ea5e9;
      ">
        <h3 style="margin: 0 0 1rem 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; color: #000;">
          AI Performance Insights
        </h3>
        
        <div style="margin-bottom: 1rem;">
          <p style="margin: 0 0 0.5rem 0; font-size: 1rem; color: #000;">
            <strong>Recent Average:</strong> ${averageScore}% (${totalTests} test${totalTests !== 1 ? 's' : ''})
          </p>
          
          ${strongestArea !== 'N/A' ? `
            <p style="margin: 0 0 0.5rem 0; font-size: 0.95rem;">
              <span style="color: #000;"><b> Strongest Area:</b></span> ${this.formatCompetencyName(strongestArea)}
            </p>
          ` : ''}
          
          ${weakestArea !== 'N/A' && weakestArea !== strongestArea ? `
            <p style="margin: 0 0 0rem 0; font-size: 0.95rem;">
              <span style="color: #000;"><b>Focus Area:</b></span> ${this.formatCompetencyName(weakestArea)}
            </p>
          ` : ''}
        </div>
      </div>
    `;
  }

  // Main function to render the AI summary
  async renderSummary(containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
      console.error(`Container with ID '${containerId}' not found`);
      return;
    }

    // Show loading state
    container.innerHTML = `
       <div class="ai-summary" style="
        background: #d2e3f9;
        color: black;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
        height: 155px;
        border-left: 7px solid #0ea5e9;
      ">
        <h3>ðŸ¤– Loading AI Insights...</h3>
        <p>Analyzing your performance data...</p>
      </div>
    `;

    try {
      // Fetch recent assignments
      const assignments = await this.fetchRecentAssignments();
      
      if (assignments.length === 0) {
        container.innerHTML = `
          <div class="ai-summary" style="
        background: #d2e3f9;
        color: black;
        padding: 1.5rem;
        border-radius: 12px;
        margin: 1rem 0;
        border-left: 7px solid #0ea5e9;
      ">
            <h3>AI Performance Insights</h3>
            <p>Complete some assignments to see your personalized insights!</p>
          </div>
        `;
        return;
      }

      // Calculate performance data
      const { averageScore, totalTests, combinedCompetencyStats } = this.calculateOverallPerformance(assignments);
      const competencyBreakdown = this.calculateCompetencyPerformance(combinedCompetencyStats);
      const { strongest, weakest } = this.analyzePerformance(competencyBreakdown);

      const summaryData = {
        averageScore,
        strongestArea: strongest,
        weakestArea: weakest,
        totalTests,
        competencyBreakdown
      };

      // Render the summary
      container.innerHTML = this.generateSummaryHTML(summaryData);

    } catch (error) {
      console.error('Error rendering AI summary:', error);
      container.innerHTML = `
        <div class="ai-summary" style="
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
          color: white;
          padding: 1.5rem;
          border-radius: 12px;
          margin: 1rem 0;
          text-align: center;
        ">
          <h3>ðŸ¤– AI Performance Insights</h3>
          <p>Unable to load performance data. Please try again later.</p>
        </div>
      `;
    }
  }

  // Method to render summary with single assignment data
  renderSummaryFromData(assignmentData, containerId) {
    const container = document.getElementById(containerId);
    if (!container) {
      console.error(`Container with ID '${containerId}' not found`);
      return;
    }

    const competencyBreakdown = this.calculateCompetencyPerformance(assignmentData.competencyStats);
    const { strongest, weakest } = this.analyzePerformance(competencyBreakdown);

    const summaryData = {
      averageScore: assignmentData.percentage || 0,
      strongestArea: strongest,
      weakestArea: weakest,
      totalTests: 1,
      competencyBreakdown
    };

    container.innerHTML = this.generateSummaryHTML(summaryData);
  }
}

// Usage examples and initialization:

// Wait for Firebase auth and DOM to be ready
    // 9. Initialize AI Summary when user is authenticated
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        const userId = user.uid;
        const aiSummary = new DynamicAISummary(firebase.firestore(), userId);
        
        // Render AI summary only if container exists
        const aiSummaryContainer = document.getElementById('ai-summary-container');
        if (aiSummaryContainer) {
          aiSummary.renderSummary('ai-summary-container');
          
          // Optional: Set up real-time updates for assignments
          const assignmentsRef = firebase.firestore()
            .collection('assignments')
            .where('to', '==', userId)
            .where('status', '==', 'complete')
            .orderBy('completedAt', 'desc')
            .limit(1);
          
          assignmentsRef.onSnapshot((snapshot) => {
            if (!snapshot.empty && document.getElementById('ai-summary-container')) {
              // Re-render summary when new assignments are completed
              aiSummary.renderSummary('ai-summary-container');
            }
          });
        }
      }
    });

    // All initialization complete

// Alternative: If you already have the user ID in a variable
function initializeAISummary(userId) {
  const aiSummary = new DynamicAISummary(firebase.firestore(), userId);
  aiSummary.renderSummary('ai-summary-container');
  return aiSummary;
}

// Alternative: Render from existing assignment data (no Firebase needed)
function renderAISummaryFromData(assignmentData) {
  const aiSummary = new DynamicAISummary();
  aiSummary.renderSummaryFromData(assignmentData, 'ai-summary-container');
}

function toggleCamera() {
    cameraEnabled = !cameraEnabled;
    const toggleBtn = document.getElementById('cameraToggle');
    
    if (cameraEnabled) {
        toggleBtn.textContent = 'ðŸ“¹';
        toggleBtn.classList.remove('camera-off');
    } else {
        toggleBtn.textContent = 'ðŸ“¹';
        toggleBtn.classList.add('camera-off');
    }
    
    // Restart stream with new constraints
    stopAllMedia();
    initializeCamera();
}

function toggleMic() {
    micEnabled = !micEnabled;
    const toggleBtn = document.getElementById('micToggle');
    
    if (micEnabled) {
        toggleBtn.textContent = 'ðŸŽ¤';
        toggleBtn.classList.remove('camera-off');
    } else {
        toggleBtn.textContent = 'ðŸŽ¤';
        toggleBtn.classList.add('camera-off');
    }
    
    // Restart stream with new constraints
    stopAllMedia();
    initializeCamera();
}

function toggleRecording() {
    if (isRecording) {
        stopRecording();
    } else {
        startRecording();
    }
}

function startRecording() {
    if (!cameraStream) {
        alert('Camera not initialized');
        return;
    }
    
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(cameraStream);
    
    mediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };
    
    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/mp4' });
        console.log('Recording finished, blob size:', blob.size);
        document.getElementById('submitRecording').disabled = false;
    };
    
    mediaRecorder.start();
    isRecording = true;
    
    // Update UI
    document.getElementById('recordButton').textContent = 'â¹';
    document.getElementById('recordButton').classList.add('recording');
    document.getElementById('recordingIndicator').classList.add('active');
    document.getElementById('recordingTimer').classList.add('active');
    
    // Start timer
    recordingSeconds = 0;
    recordingTimer = setInterval(() => {
        recordingSeconds++;
        const minutes = Math.floor(recordingSeconds / 60);
        const seconds = recordingSeconds % 60;
        document.getElementById('recordingTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopRecording() {
    if (!mediaRecorder || !isRecording) return;
    
    mediaRecorder.stop();
    isRecording = false;
    
    // Update UI
    document.getElementById('recordButton').textContent = 'â—';
    document.getElementById('recordButton').classList.remove('recording');
    document.getElementById('recordingIndicator').classList.remove('active');
    document.getElementById('recordingTimer').classList.remove('active');
    
    // Stop timer
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
    }
    
    // Show download modal after a brief delay
    setTimeout(() => {
        showDownloadModal();
    }, 500);
}
function showDownloadModal() {
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('downloadModal')) {
        document.body.insertAdjacentHTML('beforeend', downloadModalHTML);
        addDownloadModalCSS();
    }
    
    // Create blob and preview
    if (recordedChunks.length > 0) {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        
        // Store for download
        window.recordingBlob = blob;
        window.recordingURL = url;
        
        // Show preview
        const preview = document.getElementById('recordingPreview');
        if (cameraEnabled) {
            preview.innerHTML = `<video src="${url}" controls style="width:100%; max-height:200px; border-radius:10px;"></video>`;
        } else {
            preview.innerHTML = `<audio src="${url}" controls style="width:100%;"></audio>`;
        }
    }
    
    // Show modal
    const modal = document.getElementById('downloadModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
}

function downloadRecording() {
    if (!window.recordingBlob) {
        alert('No recording available');
        return;
    }
    
    // Create download link
    const url = URL.createObjectURL(window.recordingBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `CertQuest_Recording_${Date.now()}.${cameraEnabled ? 'webm' : 'webm'}`;
    document.body.appendChild(a);
    a.click();
    
    // Cleanup
    setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, 100);
    
    // MODIFIED: Close download modal and show upload modal
    closeDownloadModal();
    showUploadModal();
}

// 5. ADD THESE NEW FUNCTIONS
function showUploadModal() {
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('uploadModal')) {
        document.body.insertAdjacentHTML('beforeend', uploadModalHTML);
        setupUploadModal(); // Make sure this is called
    }
    
    // Show modal with animation
    const modal = document.getElementById('uploadModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
}


function closeUploadModal() {
    const modal = document.getElementById('uploadModal');
    modal.classList.remove('active');
    setTimeout(() => {
        modal.style.display = 'none';
        resetUploadModal();
    }, 300);
}

// Add this to your script to inject the CSS
function addLoadingStyles() {
    const style = document.createElement('style');
    style.textContent = `
        /* Light theme loading container with fade animation */
        #cq-written-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        
        #cq-written-loading.show {
            opacity: 1;
        }
        
        /* HUGE Gradient balls background */
        .gradient-balls {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }
        
        .ball {
            position: absolute;
            border-radius: 50%;
            opacity: 0.4;
            filter: blur(100px);
            animation: float 25s infinite ease-in-out;
        }
        
        .ball-1 {
            width: 600px;
            height: 600px;
            background: linear-gradient(45deg, #93c5fd, #3b82f6);
            top: 10%;
            left: 5%;
            animation-delay: 0s;
            animation-duration: 30s;
        }
        
        .ball-2 {
            width: 550px;
            height: 550px;
            background: linear-gradient(45deg, #6ee7b7, #10b981);
            top: 60%;
            right: 5%;
            animation-delay: -7s;
            animation-duration: 25s;
        }
        
        .ball-3 {
            width: 650px;
            height: 650px;
            background: linear-gradient(45deg, #d8b4fe, #8b5cf6);
            bottom: 10%;
            left: 15%;
            animation-delay: -12s;
            animation-duration: 35s;
        }
        
        .ball-4 {
            width: 500px;
            height: 500px;
            background: linear-gradient(45deg, #fcd34d, #f59e0b);
            top: 15%;
            right: 15%;
            animation-delay: -5s;
            animation-duration: 28s;
        }
        
        .ball-5 {
            width: 700px;
            height: 700px;
            background: linear-gradient(45deg, #fda4af, #ec4899);
            bottom: 5%;
            right: 10%;
            animation-delay: -15s;
            animation-duration: 32s;
        }
        
        @keyframes float {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
            }
            33% {
                transform: translate(80px, -60px) scale(1.1) rotate(120deg);
            }
            66% {
                transform: translate(-60px, 70px) scale(0.9) rotate(240deg);
            }
            100% {
                transform: translate(0, 0) scale(1) rotate(360deg);
            }
        }
        
        .cq-loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 2.5rem;
            text-align: center;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 2;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
        }
        
        .cq-loading-spinner {
            width: 70px;
            height: 70px;
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: cq-spin 1.2s ease-in-out infinite;
            margin-bottom: 1.5rem;
            box-sizing: border-box;
        }
        
        @keyframes cq-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .cq-loading-text {
            font-size: 1.5rem;
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        .cq-loading-subtext {
            font-size: 1.1rem;
            color: #64748b;
            margin-bottom: 1.5rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }
        
        .cq-loading-progress {
            width: 300px;
            height: 8px;
            background-color: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 1rem;
        }
        
        .cq-loading-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            border-radius: 4px;
            transition: width 0.4s ease;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .ball {
                filter: blur(70px);
            }
            
            .ball-1, .ball-2, .ball-3, .ball-4, .ball-5 {
                width: 400px;
                height: 400px;
            }
            
            .cq-loading-container {
                padding: 2rem 1.5rem;
                width: 85%;
            }
            
            .cq-loading-text {
                font-size: 1.3rem;
            }
            
            .cq-loading-subtext {
                font-size: 1rem;
            }
            
            .cq-loading-progress {
                width: 250px;
            }
        }
    `;
    document.head.appendChild(style);
}

// REMOVE the ensureLoaderPosition and applyInlineLoaderStyles functions

// ADD this function to show the loader properly
function showLoading() {
    const loadingElement = document.getElementById('cq-written-loading');
    if (!loadingElement) return;
    
    // Create gradient balls if they don't exist
    if (!loadingElement.querySelector('.gradient-balls')) {
        const gradientBalls = document.createElement('div');
        gradientBalls.className = 'gradient-balls';
        gradientBalls.innerHTML = `
            <div class="ball ball-1"></div>
            <div class="ball ball-2"></div>
            <div class="ball ball-3"></div>
            <div class="ball ball-4"></div>
        `;
        loadingElement.insertBefore(gradientBalls, loadingElement.firstChild);
    }
    
    // Show with fade animation
    loadingElement.style.display = 'flex';
    setTimeout(() => {
        loadingElement.classList.add('show');
    }, 10);
    
    // Start animation
    startLoadingAnimation();
}

function hideLoading() {
    const loadingElement = document.getElementById('cq-written-loading');
    if (!loadingElement) return;
    
    // Fade out first, then hide
    loadingElement.classList.remove('show');
    setTimeout(() => {
        loadingElement.style.display = 'none';
        completeLoadingAnimation();
    }, 500); // Match the CSS transition duration
}
// Call this function when your script loads
addLoadingStyles();

function setupUploadModal() {
    const dropZone = document.getElementById('uploadDropZone');
    const fileInput = document.getElementById('uploadFileInput');
    const submitBtn = document.getElementById('uploadSubmitBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');

    if (!dropZone || !fileInput || !submitBtn) {
        console.error("Upload modal elements not found!");
        return;
    }

    // Click to browse
    dropZone.addEventListener('click', (e) => {
        e.preventDefault();
        fileInput.click();
    });

    // Drag and drop events
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragenter', (e) => {
        e.preventDefault();
        e.stopPropagation();
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!dropZone.contains(e.relatedTarget)) {
            dropZone.classList.remove('dragover');
        }
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropZone.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection(files[0]);
        }
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleFileSelection(file);
        }
    });

    function handleFileSelection(file) {
        console.log('File selected:', file.name, file.type, file.size);
        
        // Validate file type
        const validTypes = ['video/webm', 'video/mp4', 'video/quicktime', 'video/x-msvideo', 'audio/webm', 'audio/mp4', 'audio/mpeg'];
        const validExtensions = ['.webm', '.mp4', '.mov', '.avi', '.mp3', '.wav'];
        
        const isValidType = validTypes.some(type => file.type.includes(type)) || 
                           validExtensions.some(ext => file.name.toLowerCase().endsWith(ext));
        
        if (!isValidType) {
            alert('Please select a valid video or audio file (WebM, MP4, MOV, AVI, MP3, WAV)');
            resetUploadModal();
            return;
        }

        // Check file size (max 200MB)
        const maxSize = 200 * 1024 * 1024;
        if (file.size > maxSize) {
            alert('File size too large. Maximum size is 200MB.');
            resetUploadModal();
            return;
        }

        // File is valid
        selectedUploadFile = file;
        
        // Update UI
        dropZone.classList.add('file-selected');
        dropZone.innerHTML = `
            <div class="upload-text">File Selected!</div>
            <div class="upload-subtext">Click to select a different file</div>
        `;
        
        // Show file info
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'flex';
        
        // Enable submit button
        submitBtn.disabled = false;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
}


function resetUploadModal() {
    selectedUploadFile = null;
    const dropZone = document.getElementById('uploadDropZone');
    const fileInfo = document.getElementById('fileInfo');
    const submitBtn = document.getElementById('uploadSubmitBtn');
    
    if (dropZone) {
        dropZone.classList.remove('file-selected', 'dragover');
        dropZone.innerHTML = `
            <div class="upload-icon">ðŸŽ¬</div>
            <div class="upload-text">Drop your recording here</div>
            <div class="upload-subtext">or click to browse files</div>
            <div class="upload-subtext">Supports WebM, MP4, MOV, AVI</div>
            <input type="file" id="uploadFileInput" class="upload-file-input" accept=".webm,.mp4,.mov,.avi,video/*,audio/*">
        `;
    }
    
    if (fileInfo) {
        fileInfo.style.display = 'none';
    }
    
    if (submitBtn) {
        submitBtn.disabled = true;
    }
}

// ========== GPT QUESTION GENERATOR ==========

function getQuestionCount(timeStr) {
  if (!timeStr) return 5;
  
  const time = parseInt(timeStr);
  if (time >= 15) return 10;
  if (time >= 10) return 7;
  return 5;
}

function getFallbackQuestions(count, competencies) {
  // Simple fallback questions if GPT fails
  return [
    {
      text: "What is the primary goal of business communication?",
      competency: competencies[0] || "Business Communication",
      correctAnswer: "Clear and effective information exchange",
      options: [
        "Clear and effective information exchange",
        "Using complex terminology",
        "Lengthy detailed explanations",
        "Informal casual language"
      ]
    },
    {
      text: "Which financial statement shows profitability over time?",
      competency: competencies[0] || "Accounting",
      correctAnswer: "Income Statement",
      options: [
        "Income Statement",
        "Balance Sheet",
        "Cash Flow Statement",
        "Trial Balance"
      ]
    }
  ].slice(0, count);
}

async function submitUploadedFile() {
  if (!selectedUploadFile) {
    alert('No file selected');
    return;
  }

  const submitBtn = document.getElementById('uploadSubmitBtn');
  submitBtn.textContent = 'Sending...';
  submitBtn.disabled = true;

  try {
    // --- Setup variables ---
    const user = firebase.auth().currentUser;
    const uid = user?.uid;
    const menteeName = user?.displayName || user?.email || 'Anonymous';
    const assignmentTitle = window.currentAssignment?.title || "Assignment";
    const assignmentId = window.latestAssignmentId;

    // GitHub info
    const GITHUB_USERNAME = "Anjay209";
    const GITHUB_REPO = "video-storage";
    const GITHUB_TOKEN = "REDACTED_TOKEN";

    const filename = `${uid}-${Date.now()}-${selectedUploadFile.name}`;
    const githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
    const githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

    // Convert file to base64
    const base64 = await blobToBase64(selectedUploadFile);

    // Upload to GitHub
    const uploadRes = await fetch(githubApiUrl, {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Upload ${filename}`,
        content: base64,
        branch: 'main'
      })
    });

    if (!uploadRes.ok) throw new Error("GitHub upload failed");

    // Mark assignment as completed in Firestore
    await firebase.firestore()
      .collection('assignments')
      .doc(assignmentId)
      .update({
        status: "complete",
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        recordingUrl: githubPagesUrl
      });

    // Award XP for completing file upload assignment (fixed 50 XP)
    if (user) {
        await awardXP(user.uid, 50, `completing file upload assignment: ${assignmentTitle}`);
    }

    // UI feedback
    alert('Successfully sent to mentor!');
    closeUploadModal();
    if (document.getElementById('cameraModal')) {
      closeCameraModal();
    }

    confetti({
      particleCount: 150,
      spread: 70,
      origin: { y: 0.6 }
    });

  } catch (error) {
    console.error('Upload error:', error);
    alert("Failed to send file: " + (error?.text || error?.message || error));
  }

  submitBtn.textContent = 'Send to Mentor';
  submitBtn.disabled = false;
}


function closeDownloadModal() {
    const modal = document.getElementById('downloadModal');
    modal.classList.remove('active');
    setTimeout(() => {
        modal.style.display = 'none';
        // Cleanup URLs
        if (window.recordingURL) {
            URL.revokeObjectURL(window.recordingURL);
            window.recordingURL = null;
        }
        window.recordingBlob = null;
    }, 300);
}

// 4. Add basic CSS (add to your existing CSS or in a <style> tag)
function addDownloadModalCSS() {
    const style = document.createElement('style');
    style.textContent = `
        .download-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8); z-index: 10001; display: flex;
            align-items: center; justify-content: center; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .download-modal-overlay.active { opacity: 1; }
        .download-modal-container {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 20px; max-width: 500px; width: 90%;
            color: white; transform: scale(0.9); transition: transform 0.3s ease;
        }
        .download-modal-overlay.active .download-modal-container { transform: scale(1); }
        .download-modal-header {
            padding: 25px 30px 15px; display: flex; justify-content: space-between;
            align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .download-modal-header button {
            background: rgba(255,255,255,0.1); border: none; color: white;
            width: 40px; height: 40px; border-radius: 50%; font-size: 24px;
            cursor: pointer;
        }
        .download-modal-body { padding: 30px; text-align: center; }
        .download-modal-footer {
            padding: 20px 30px 30px; display: flex; gap: 15px; justify-content: center;
        }
        .download-modal-footer button {
            padding: 12px 24px; border-radius: 25px; font-weight: 600;
            cursor: pointer; border: none;
        }
        #downloadRecordingBtn {
            background: linear-gradient(45deg, #4CAF50, #45a049); color: white;
        }
    `;
    document.head.appendChild(style);
}
// Fixed submitQuiz function
  async function submitQuiz() {
    // Check if this is a written practice assignment
    const hasWrittenQuestions = (window.writtenQuestions && window.writtenQuestions.length > 0) || 
                                (writtenQuestions && writtenQuestions.length > 0);
    
    if (hasWrittenQuestions) {
      if (window.latestAssignmentId) {
        await submitWrittenPractice();
        return;
      } else {
        await submitWrittenPracticeForCreateYourOwn();
        return;
      }
    }
    
    // Original quiz submission logic for other quiz types
    console.log("ðŸ“Š Assignment ID:", window.latestAssignmentId);
    console.log("ðŸ“‹ Current assignment:", window.currentAssignment);
    
    // Clear timer if it exists (but don't error if it doesn't)
    if (typeof quizTimer !== 'undefined' && quizTimer) {
        console.log("â±ï¸ Clearing quiz timer");
        clearInterval(quizTimer);
        quizTimer = null;
    }
    
    // Check if currentQuiz exists
    if (!currentQuiz || !currentQuiz.questions) {
        console.error("âŒ No quiz data found");
        alert("Error: No quiz data found. Please start a new quiz.");
        return;
    }
    
    // Verify all questions were answered BEFORE calculating results
    console.log("ðŸ” Checking if all questions are answered...");
    const unansweredQuestions = currentQuiz.questions.filter((_, idx) => {
        const checked = document.querySelector(`input[name="q${idx+1}"]:checked`);
        console.log(`â“ Question ${idx+1}:`, checked ? `âœ… ${checked.value}` : "âŒ Not answered");
        return !checked;
    });
    
    if (unansweredQuestions.length > 0) {
        console.error(`âŒ ${unansweredQuestions.length} questions not answered`);
        alert(`Please answer all questions. ${unansweredQuestions.length} questions remaining.`);
        return;
    }
    
    console.log("âœ… All questions answered, calculating results...");
    
    // Calculate results
    const quizResults = calculateQuizResults();
    console.log("ðŸ“Š Quiz Results calculated:", quizResults);
    
    // Verify we have a valid assignment ID
    if (!window.latestAssignmentId) {
        console.error("âŒ No assignment ID found");
        alert("Error: No assignment ID found. Cannot save results.");
        return;
    }

    console.log("ðŸ’¾ Saving results to Firebase...");
    
    // Save to Firebase and show results
    saveQuizResultsToFirebase(quizResults)
        .then(() => {
            console.log("âœ… Results saved successfully");
            
            // Close quiz modal and show results
            closeAssignmentModal();
            
            showCongratsModal({
                message: `Great job! You scored ${quizResults.correct}/${quizResults.total}`,
                assignmentName: document.getElementById('cq-assignment-title').textContent,
                score: quizResults.correct,
                totalQuestions: quizResults.total,
                competencyStats: quizResults.competencyStats,
                percentage: quizResults.percentage
            });
            
            // Show confetti celebration
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            // Clear assignment data
            window.latestAssignmentId = null;
            window.currentAssignment = null;
            
            console.log("ðŸŽ‰ Quiz submission completed successfully!");
        })
        .catch(error => {
            console.error('âŒ Error saving quiz results:', error);
            alert('Error saving results: ' + error.message);
        });
}


// 3. Test function to manually trigger quiz submission
function testQuizSubmission() {
    console.log("ðŸ§ª TESTING QUIZ SUBMISSION");
    
    // Set up fake assignment data
    window.latestAssignmentId = "test-assignment-123";
    window.currentAssignment = {
        title: "Test Quiz",
        type: "quiz",
        difficulty: "Easy",
        time: "10 mins"
    };
    
    console.log("ðŸŽ¯ Fake assignment set up:", window.currentAssignment);
    console.log("ðŸ“Š Assignment ID:", window.latestAssignmentId);
    console.log("ðŸ”˜ Submit button element:", document.getElementById('submitQuizBtn'));
    
    // Try to submit
    submitQuiz();
}

// Make test function available globally
window.testQuizSubmission = testQuizSubmission;


async function openWrittenPracticeModal(assignment) {
    console.log("Opening written practice modal with assignment:", assignment);

    try {
      currentQuestionIndex = 0;
      writtenAnswers = {};
      if (!window.writtenAnswers) {
        window.writtenAnswers = {};
      }

      const timeInMinutes = parseInt(assignment.time) || 15;
      writtenTimeRemaining = timeInMinutes * 60;

      // Check if window.writtenQuestions exists (from "create your own" flow)
      if (window.writtenQuestions && window.writtenQuestions.length > 0) {
        console.log("âœ… Using window.writtenQuestions from create your own flow");
        writtenQuestions = window.writtenQuestions;
      } else if (assignment.writtenQuestions && assignment.writtenQuestions.length > 0) {
        // Use assignment's preloaded questions
        writtenQuestions = assignment.writtenQuestions;
        window.writtenQuestions = assignment.writtenQuestions;
      } else {
        // Generate new questions via GPT
        console.log("âš¡ No preloaded questions, generating via GPT...");
        assignment.writtenQuestions = await generatePersonalizedQuestionsWithGPT({
          time: assignment.time || "15 mins",
          difficulty: assignment.difficulty || "Medium",
          competencies: assignment.competencies || ["General"],
          type: "written"
        });
        writtenQuestions = assignment.writtenQuestions;
        window.writtenQuestions = assignment.writtenQuestions;
      }

      console.log("âœ… Written questions ready:", writtenQuestions);

      // Show modal and create stars
      const modal = document.getElementById('quizModal');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      createQuizStars();
      loadWrittenQuestion();
      startWrittenTimer();

    } catch (err) {
      console.error("âŒ Error in openWrittenPracticeModal:", err);
      alert("Could not load written practice. Please try again.");
    } finally {
      hideLoader();
      console.log("ðŸ›‘ Loader hidden inside openWrittenPracticeModal");
    }
  }

  function loadWrittenQuestion() {
    // Use window.writtenQuestions if available (for "create your own"), otherwise use local writtenQuestions
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    const question = questions[currentQuestionIndex];
    if (!question) {
      console.error("No question found at index", currentQuestionIndex);
      return;
    }
    
    console.log("Loading question", currentQuestionIndex + 1, ":", question.question || question.text);
    
    const assignmentTitle = window.currentAssignment?.title || 'Written Practice';
    const difficulty = window.currentAssignment?.difficulty || 'Easy';
    document.getElementById('quizTitle').textContent = `${difficulty} ${assignmentTitle}`;
    document.getElementById('quizProgress').textContent = 
      `Question ${currentQuestionIndex + 1} of ${questions.length}`;
    
    document.getElementById('questionCompetency').textContent = question.competency || 'General';
    const questionTextEl = document.getElementById('questionText');
    questionTextEl.textContent = question.question || question.text;
    questionTextEl.style.color = '#fff';
    
    const optionsContainer = document.getElementById('optionsContainer');
    const answers = window.writtenAnswers || writtenAnswers;
    const previousAnswer = answers[currentQuestionIndex];
    
    optionsContainer.innerHTML = question.options.map((option, index) => {
      const isSelected = previousAnswer === option;
      return `
        <button class="practice-quiz-option-btn ${isSelected ? 'selected' : ''}" data-option="${option}">
          <div class="practice-quiz-option-radio ${isSelected ? 'selected' : ''}">
            ${isSelected ? '<div class="practice-quiz-option-dot"></div>' : ''}
          </div>
          <span class="practice-quiz-option-text">${option}</span>
        </button>
      `;
    }).join('');
    
    const options = optionsContainer.querySelectorAll('.practice-quiz-option-btn');
    options.forEach(optionBtn => {
      optionBtn.addEventListener('click', function(e) {
        options.forEach(opt => {
          opt.classList.remove("selected");
          const radio = opt.querySelector('.practice-quiz-option-radio');
          radio.classList.remove("selected");
          radio.innerHTML = '';
        });
        
        this.classList.add('selected');
        const radio = this.querySelector('.practice-quiz-option-radio');
        radio.classList.add('selected');
        radio.innerHTML = '<div class="practice-quiz-option-dot"></div>';
        
        // Save to both window.writtenAnswers and local writtenAnswers
        if (window.writtenAnswers) {
          window.writtenAnswers[currentQuestionIndex] = this.dataset.option;
        } else {
          writtenAnswers[currentQuestionIndex] = this.dataset.option;
        }
        console.log("Answer saved:", currentQuestionIndex, "->", this.dataset.option);
      });
    });
    
    updateWrittenProgress();
    updateWrittenNavButtons();
  }

  function updateWrittenProgress() {
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
    document.getElementById('progressFill').style.width = `${progress}%`;
    document.getElementById('progressPercent').textContent = Math.round(progress);
  }

  function updateWrittenNavButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    
    prevBtn.disabled = currentQuestionIndex === 0;
    
    if (currentQuestionIndex === questions.length - 1) {
      nextBtn.style.display = 'none';
      submitBtn.style.display = 'block';
    } else {
      nextBtn.style.display = 'block';
      submitBtn.style.display = 'none';
    }
  }

  function previousQuestion() {
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      loadWrittenQuestion();
    }
  }

  function nextQuestion() {
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    if (currentQuestionIndex < questions.length - 1) {
      currentQuestionIndex++;
      loadWrittenQuestion();
    }
  }

  function startWrittenTimer() {
    clearInterval(writtenTimer);
    
    console.log("Starting timer with", writtenTimeRemaining, "seconds");
    updateTimerDisplay();
    
    writtenTimer = setInterval(() => {
      writtenTimeRemaining--;
      updateTimerDisplay();
      
      if (writtenTimeRemaining <= 0) {
        console.log("Time's up! Auto-submitting...");
        clearInterval(writtenTimer);
        submitQuiz();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const minutes = Math.floor(writtenTimeRemaining / 60);
    const seconds = writtenTimeRemaining % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const timerElement = document.getElementById('quizTimer');
    if (timerElement) {
      timerElement.textContent = timeString;
      
      if (writtenTimeRemaining <= 60) {
        timerElement.style.color = '#ef4444';
      } else if (writtenTimeRemaining <= 300) {
        timerElement.style.color = '#f97316';
      } else {
        timerElement.style.color = '#fb923c';
      }
    }
  }

  function createQuizStars() {
    const starsContainer = document.getElementById('quizStarsContainer');
    if (!starsContainer) return;
    
    starsContainer.innerHTML = '';
    
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'practice-quiz-star';
      
      const size = Math.random() * 3 + 0.5;
      const duration = Math.random() * 4 + 2;
      const delay = Math.random() * 2;
      const randomLeft = Math.random() * 100;
      const randomTop = Math.random() * 100;
      const randomOpacity = Math.random() * 0.9 + 0.3;
      
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = randomLeft + '%';
      star.style.top = randomTop + '%';
      star.style.opacity = randomOpacity;
      star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
      star.style.animationDelay = delay + 's';
      star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
      
      starsContainer.appendChild(star);
    }
  }

// Fix the training data usage issue
// FIXED VERSION - Add this after your existing function
function fixTrainingDataUsage() {
    console.log("ðŸ”§ Fixing training data usage in question generation");
    
    // Override the existing function with complete debugging and PDF support
    window.generateQuestionsFromCompetencies = async function(competencies, questionCount, difficulty, assignment) {
        console.log("ðŸš€ =========================== QUESTION GENERATION START ===========================");
        console.log("ðŸ” Initial parameters:", { 
            competencies, 
            questionCount, 
            difficulty, 
            assignmentExists: !!assignment,
            assignmentKeys: assignment ? Object.keys(assignment) : []
        });

        // Use your existing API key
        const apiKey = window.openaiApiKey || "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";

        const compText = competencies.join(', ');
        let trainingContext = "";
        let allTrainingContent = [];
        let hasTrainingData = false;

        // ================================ PDF PROCESSING SECTION ================================
        console.log("ðŸ“„ =========================== PDF PROCESSING START ===========================");
        
        if (!assignment) {
            console.log("âŒ NO ASSIGNMENT OBJECT PROVIDED");
        } else if (!assignment.trainingPDFs) {
            console.log("âŒ NO trainingPDFs PROPERTY IN ASSIGNMENT");
            console.log("ðŸ“‹ Available assignment properties:", Object.keys(assignment));
        } else if (!Array.isArray(assignment.trainingPDFs)) {
            console.log("âŒ trainingPDFs IS NOT AN ARRAY:", typeof assignment.trainingPDFs);
            console.log("ðŸ“‹ trainingPDFs value:", assignment.trainingPDFs);
        } else if (assignment.trainingPDFs.length === 0) {
            console.log("âŒ trainingPDFs ARRAY IS EMPTY");
        } else {
            console.log("âœ… trainingPDFs FOUND - Count:", assignment.trainingPDFs.length);
            console.log("ðŸ“„ Full trainingPDFs structure:", JSON.stringify(assignment.trainingPDFs, null, 2));
            
            assignment.trainingPDFs.forEach((pdf, index) => {
                console.log(`\nðŸ“„ PROCESSING PDF ${index + 1}/${assignment.trainingPDFs.length}:`);
                console.log(`   Name: ${pdf.name || 'UNNAMED'}`);
                console.log(`   Type: ${pdf.type || 'NO TYPE'}`);
                console.log(`   Processed: ${pdf.processed}`);
                console.log(`   Has content: ${!!pdf.content}`);
                console.log(`   Content type: ${typeof pdf.content}`);
                console.log(`   Content length: ${pdf.content?.length || 0}`);
                
                if (!pdf.content) {
                    console.log("   âŒ SKIP: No content property");
                } else if (typeof pdf.content !== 'string') {
                    console.log("   âŒ SKIP: Content is not a string");
                } else if (pdf.content.trim().length === 0) {
                    console.log("   âŒ SKIP: Content is empty after trim");
                } else {
                    const contentSnippet = pdf.content.trim().substring(0, 1500); // Increased from 1000
                    allTrainingContent.push(contentSnippet);
                    hasTrainingData = true;
                    console.log("   âœ… ADDED PDF to training content");
                    console.log(`   First 200 chars: "${contentSnippet.substring(0, 200)}..."`);
                }
            });
        }

        // ================================ USER TRAINING DATA SECTION ================================
        console.log("\nðŸ‘¤ =========================== USER TRAINING DATA START ===========================");
        
        if (assignment?.usedMenteeTrainingData === true) {
            console.log("âœ… User training data REQUESTED");
            try {
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    console.log("âŒ No current user authenticated");
                } else {
                    console.log("âœ… Current user found:", currentUser.uid);
                    const userTrainingRef = firebase.firestore().collection('userTraining').doc(currentUser.uid);
                    const userTrainingDoc = await userTrainingRef.get();
                    
                    if (!userTrainingDoc.exists) {
                        console.log("âŒ No user training document exists");
                    } else {
                        console.log("âœ… User training document exists");
                        const entriesRef = userTrainingRef.collection('entries').orderBy('timestamp', 'desc').limit(3);
                        const entriesSnapshot = await entriesRef.get();
                        
                        console.log(`ðŸ“Š Found ${entriesSnapshot.size} user training entries`);
                        
                        entriesSnapshot.forEach(doc => {
                            const data = doc.data();
                            console.log(`   Entry ID: ${doc.id}`);
                            console.log(`   Has content: ${!!data.content}`);
                            console.log(`   Content length: ${data.content?.trim().length || 0}`);
                            
                            if (data.content && data.content.trim().length > 0) {
                                allTrainingContent.push(data.content.trim());
                                hasTrainingData = true;
                                console.log("   âœ… ADDED user training content");
                            }
                        });
                    }
                }
            } catch (error) {
                console.error("ðŸ’¥ Error fetching user training data:", error);
            }
        } else {
            console.log("â­ï¸ User training data NOT requested");
            console.log(`   usedMenteeTrainingData value: ${assignment?.usedMenteeTrainingData}`);
        }

        // ================================ TRAINING CONTEXT CREATION ================================
        console.log("\nðŸ”§ =========================== TRAINING CONTEXT CREATION ===========================");
        console.log(`Total training content pieces: ${allTrainingContent.length}`);
        console.log(`Has training data: ${hasTrainingData}`);

        if (hasTrainingData && allTrainingContent.length > 0) {
            const combinedContent = allTrainingContent.join(' ').substring(0, 2500); // Increased limit
            trainingContext = combinedContent;
            
            console.log("âœ… TRAINING CONTEXT CREATED");
            console.log(`   Combined content length: ${combinedContent.length}`);
            console.log(`   First 300 chars of context: "${trainingContext.substring(0, 300)}..."`);
        } else {
            console.log("âŒ NO TRAINING CONTEXT CREATED - No valid training data");
        }

        // ================================ PROMPT CREATION ================================
        console.log("\nðŸ“ =========================== PROMPT CREATION ===========================");
        
        let prompt;
        if (hasTrainingData && trainingContext) {
            prompt = `You are creating FBLA business questions that MUST be directly based on this student's uploaded content:

"${trainingContext}"

Create ${questionCount} multiple choice questions that:
1. Use concepts, topics, and themes from the student's content above
2. Connect those concepts to these business competencies: ${compText}
3. Are at ${difficulty} difficulty level
4. Have exactly 4 answer choices each
5. Make the connection between the student's content and business concepts clear

CRITICAL: The questions MUST relate to the actual content the student uploaded. If the content is about prisons, create questions about workplace management, employee conditions, organizational structure, etc. that connect to that theme.

Return JSON only in this exact format:
[
  {
    "text": "Question text that references concepts from the student content?",
    "competency": "One of the provided competency names",
    "correctAnswer": "The correct option text",
    "options": ["Option A", "Option B", "Option C", "Option D"]
  }
]`;
        } else {
            prompt = `Generate ${questionCount} FBLA multiple choice questions.
- Difficulty: ${difficulty}
- Competencies: ${compText}
- Each must have exactly 4 options, 1 correct answer
- Make questions realistic for business competitions

Return JSON only in this format:
[
  {
    "text": "Question text?",
    "competency": "Competency Name",
    "correctAnswer": "Correct option text",
    "options": ["Option A", "Option B", "Option C", "Option D"]
  }
]`;
        }

        console.log("ðŸ“ FINAL PROMPT DETAILS:");
        console.log(`   Prompt length: ${prompt.length}`);
        console.log(`   Has training context: ${!!trainingContext}`);
        console.log(`   Training context length: ${trainingContext.length}`);
        
        console.log("ðŸ“ ACTUAL PROMPT BEING SENT:");
        console.log("=" .repeat(80));
        console.log(prompt);
        console.log("=" .repeat(80));

        // ================================ API CALL ================================
        console.log("\nðŸŒ =========================== API CALL START ===========================");
        
        try {
            console.log("ðŸ“¤ Sending request to OpenAI...");
            
            const requestBody = {
                model: "gpt-4o-mini",
                messages: [
                    { 
                        role: "system", 
                        content: hasTrainingData ? 
                            "You are an expert at creating personalized FBLA questions based on student content. Always connect the student's actual uploaded content to business concepts. Be creative in making these connections." :
                            "You are an expert FBLA exam writer who creates realistic business competition questions."
                    },
                    { role: "user", content: prompt }
                ],
                temperature: 0.8,
                max_tokens: 2500
            };
            
            console.log("ðŸ“¤ Request body summary:", {
                model: requestBody.model,
                systemMessage: requestBody.messages[0].content,
                promptLength: requestBody.messages[1].content.length,
                temperature: requestBody.temperature
            });
            
            const res = await fetch("https://api.openai.com/v1/chat/completions", {
                method: "POST",
                headers: { 
                    "Authorization": `Bearer ${apiKey}`, 
                    "Content-Type": "application/json" 
                },
                body: JSON.stringify(requestBody)
            });

            console.log(`ðŸ“¥ Response status: ${res.status} ${res.statusText}`);

            if (!res.ok) {
                const errorText = await res.text();
                console.error("ðŸ’¥ GPT API Error:", res.status, errorText);
                throw new Error(`API Error ${res.status}: ${errorText}`);
            }
            
            const responseData = await res.json();
            console.log("ðŸ“¥ API response summary:", {
                hasChoices: !!responseData.choices,
                choicesLength: responseData.choices?.length || 0,
                finishReason: responseData.choices?.[0]?.finish_reason
            });
            
            let content = responseData.choices[0].message.content.trim();
            console.log("ðŸ“¥ Raw content length:", content.length);
            console.log("ðŸ“¥ Raw content preview:", content.substring(0, 500) + "...");
            
            // Clean up the response
            content = content.replace(/```json|```/g, "");
            console.log("ðŸ“¥ Content after cleanup preview:", content.substring(0, 500) + "...");
            
            const questions = JSON.parse(content);
            console.log("âœ… Successfully parsed JSON - Questions count:", questions.length);
            
            // ================================ SAVE QUESTIONS TO GLOBAL VARIABLES ================================
            console.log("\nðŸ’¾ =========================== SAVING QUESTIONS ===========================");
            
            if (questions && Array.isArray(questions) && questions.length > 0) {
                // Transform questions to match your expected format
                window.writtenQuestions = questions.map((q, index) => {
                    console.log(`   Processing question ${index + 1}:`, {
                        hasText: !!q.text,
                        hasOptions: !!q.options,
                        optionsLength: q.options?.length || 0,
                        hasCorrectAnswer: !!q.correctAnswer
                    });
                    
                    return {
                        question: q.text || q.question,
                        options: q.options || [],
                        correctAnswer: q.correctAnswer,
                        competency: q.competency
                    };
                });
                
                // Initialize answers object
                window.writtenAnswers = {};
                
                console.log("âœ… QUESTIONS SAVED TO GLOBAL VARIABLES");
                console.log(`   window.writtenQuestions length: ${window.writtenQuestions.length}`);
                console.log(`   window.writtenAnswers initialized: ${typeof window.writtenAnswers}`);
                console.log("ðŸ“Š Sample saved question:", window.writtenQuestions[0]);
                
                console.log("ðŸŽ‰ =========================== SUCCESS ===========================");
                console.log(`âœ… Generated ${questions.length} questions`);
                console.log(`âœ… Used training data: ${hasTrainingData}`);
                console.log(`âœ… Training content pieces: ${allTrainingContent.length}`);
                console.log(`âœ… PDF processing: ${assignment?.trainingPDFs?.length || 0} PDFs`);
                console.log(`âœ… User training: ${assignment?.usedMenteeTrainingData === true ? 'Requested' : 'Not requested'}`);
                
                return questions;
            } else {
                throw new Error("No valid questions in response");
            }

        } catch (err) {
            console.error("ðŸ’¥ =========================== ERROR OCCURRED ===========================");
            console.error("ðŸ’¥ Error type:", err.constructor.name);
            console.error("ðŸ’¥ Error message:", err.message);
            console.error("ðŸ’¥ Full error:", err);
            
            console.log("ðŸ”„ =========================== FALLBACK PROCESSING ===========================");
            
            let fallbackQuestions = [];
            
            // Try to get fallback questions
            if (typeof getFallbackQuestions === 'function') {
                console.log("ðŸ”„ Trying getFallbackQuestions...");
                fallbackQuestions = getFallbackQuestions(questionCount, competencies);
            } else if (typeof createBasicQuestions === 'function') {
                console.log("ðŸ”„ Trying createBasicQuestions...");
                fallbackQuestions = createBasicQuestions(questionCount, competencies);
            } else {
                console.log("ðŸ”„ Creating emergency fallback questions...");
                fallbackQuestions = Array.from({length: questionCount}, (_, i) => ({
                    question: `Sample FBLA question ${i + 1} for ${competencies[0]}?`,
                    options: ["Option A", "Option B", "Option C", "Option D"],
                    correctAnswer: "Option A",
                    competency: competencies[0]
                }));
            }
            
            if (fallbackQuestions && fallbackQuestions.length > 0) {
                window.writtenQuestions = fallbackQuestions;
                window.writtenAnswers = {};
                console.log("âœ… Fallback questions saved:", window.writtenQuestions.length);
                return fallbackQuestions;
            } else {
                console.error("ðŸ’¥ Even fallback failed!");
                return [];
            }
        }
    };
    
    console.log("âœ… Training data usage fixed with complete debugging!");
}

// Auto-execute the fix

// Helper function for basic questions if everything fails
function createBasicQuestions(count, competencies) {
    const basicQuestions = [];
    for (let i = 0; i < count; i++) {
        basicQuestions.push({
            question: `Business Communication Question ${i + 1}?`,
            options: ["Option A", "Option B", "Option C", "Option D"],
            correctAnswer: "Option A",
            competency: competencies[0] || "business-communication"
        });
    }
    return basicQuestions;
}

// Run the fix
fixTrainingDataUsage();



function updateWrittenNavButtons() {
    const prevBtn = document.getElementById('cq-written-prev');
    const nextBtn = document.getElementById('cq-written-next');
    
    // Update previous button
    prevBtn.disabled = currentQuestionIndex === 0;
    
    // Update next/submit button
    if (currentQuestionIndex === writtenQuestions.length - 1) {
        nextBtn.textContent = 'Submit';
        nextBtn.onclick = submitWrittenPractice; // âœ… Fixed: no parentheses
        nextBtn.classList.remove('cq-written-btn-primary');
        nextBtn.classList.add('cq-written-btn-primary');
        nextBtn.style.background = '#dc2626'; // Red color for submit
    } else {
        nextBtn.textContent = 'Next';
        nextBtn.onclick = nextQuestion;
        nextBtn.classList.add('cq-written-btn-primary');
        nextBtn.style.background = '#3b82f6'; // Blue color for next
    }
}

function previousQuestion() {
    console.log("Previous question clicked, current index:", currentQuestionIndex);
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadWrittenQuestion();
    }
}

function nextQuestion() {
    console.log("Next question clicked, current index:", currentQuestionIndex);
    if (currentQuestionIndex < writtenQuestions.length - 1) {
        currentQuestionIndex++;
        loadWrittenQuestion();
    }
}

function startWrittenTimer() {
    clearInterval(writtenTimer);
    
    console.log("Starting timer with", writtenTimeRemaining, "seconds");
    
    // Update initial display
    updateTimerDisplay();
    
    writtenTimer = setInterval(() => {
        writtenTimeRemaining--;
        updateTimerDisplay();
        
        if (writtenTimeRemaining <= 0) {
            console.log("Time's up! Auto-submitting...");
            clearInterval(writtenTimer);
            submitWrittenPractice();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(writtenTimeRemaining / 60);
    const seconds = writtenTimeRemaining % 60;
    const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('cq-written-timer').textContent = display;
    
    // Change color when time is running low (last 2 minutes)
    const timerElement = document.getElementById('cq-written-timer');
    if (writtenTimeRemaining <= 120) { // 2 minutes
        timerElement.style.color = '#dc2626'; // Red
        timerElement.style.fontWeight = '600';
    } else {
        timerElement.style.color = '#64748b'; // Default gray
        timerElement.style.fontWeight = '500';
    }
}

async function submitWrittenPractice() {
    try {
      console.log("=== SUBMITTING WRITTEN PRACTICE ===");
      clearInterval(writtenTimer);
      
      if (!window.latestAssignmentId) {
        console.error("âŒ CRITICAL ERROR: No assignment ID found!");
        alert("Error: No assignment ID found. Cannot submit written practice.");
        closeQuizModal();
        return;
      }
      
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      const answers = window.writtenAnswers && Object.keys(window.writtenAnswers).length > 0 ? window.writtenAnswers : writtenAnswers;
      
      let score = 0;
      const competencyStats = {};
      const detailedAnswers = [];
      const totalQuestions = questions.length;
      
      questions.forEach((question, index) => {
        const userAnswer = answers[index];
        const correctAnswer = question.correctAnswer;
        const isCorrect = userAnswer === correctAnswer;
        
        if (isCorrect) score++;
        
        const competency = question.competency || 'General';
        if (!competencyStats[competency]) {
          competencyStats[competency] = { total: 0, correct: 0 };
        }
        competencyStats[competency].total++;
        if (isCorrect) competencyStats[competency].correct++;
        
        detailedAnswers.push({
          questionIndex: index,
          question: question.question || question.text,
          competency: competency,
          userAnswer: userAnswer || "No answer",
          correctAnswer: correctAnswer,
          isCorrect: isCorrect
        });
      });
      
      const originalTime = parseInt(window.currentAssignment?.time) * 60 || 900;
      const timeSpent = originalTime - writtenTimeRemaining;
      const percentage = Math.round((score / totalQuestions) * 100);
      
      const updateData = {
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        score: score,
        totalQuestions: totalQuestions,
        maxScore: totalQuestions,
        competencyStats: competencyStats,
        timeSpent: timeSpent,
        detailedAnswers: detailedAnswers,
        competencies: Object.keys(competencyStats),
        correctCompetencies: Object.entries(competencyStats)
          .filter(([_, stats]) => stats.correct === stats.total)
          .map(([comp, _]) => comp),
        percentage: percentage,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
      console.log("âœ… Assignment updated successfully");
      
      const resultsData = {
        message: `Excellent work! You scored ${score}/${totalQuestions}`,
        assignmentName: window.currentAssignment?.title || 'Written Practice',
        competencyStats: competencyStats,
        score: score,
        totalQuestions: totalQuestions,
        percentage: percentage,
        timeSpent: timeSpent
      };
      
      closeQuizModal();
      
      showCongratsModal(resultsData);
      
      window.latestAssignmentId = null;
      window.currentAssignment = null;
      window.writtenQuestions = null;
      window.writtenAnswers = null;
      
    } catch (error) {
      console.error("âŒ Written practice submission error:", error);
      alert("Failed to submit practice: " + error.message);
    }
  }

  async function submitWrittenPracticeForCreateYourOwn() {
    try {
      console.log("=== SUBMITTING CREATE YOUR OWN WRITTEN PRACTICE ===");
      clearInterval(writtenTimer);
      
      const questions = window.writtenQuestions || writtenQuestions;
      const answers = window.writtenAnswers || writtenAnswers;
      
      if (!questions || questions.length === 0) {
        console.error("âŒ CRITICAL ERROR: No questions found!");
        alert("Error: No questions found. Cannot submit written practice.");
        closeQuizModal();
        return;
      }
      
      let score = 0;
      const competencyStats = {};
      const detailedAnswers = [];
      const totalQuestions = questions.length;
      
      questions.forEach((question, index) => {
        const userAnswer = answers[index];
        const correctAnswer = question.correctAnswer;
        const isCorrect = userAnswer === correctAnswer;
        
        if (isCorrect) score++;
        
        const competency = question.competency || 'General';
        if (!competencyStats[competency]) {
          competencyStats[competency] = { total: 0, correct: 0 };
        }
        competencyStats[competency].total++;
        if (isCorrect) competencyStats[competency].correct++;
        
        detailedAnswers.push({
          questionIndex: index,
          question: question.question || question.text,
          competency: competency,
          userAnswer: userAnswer || "No answer",
          correctAnswer: correctAnswer,
          isCorrect: isCorrect
        });
      });
      
      const timeStr = document.getElementById('quizTitle')?.textContent?.match(/\d+/)?.[0] || '15';
      const originalTime = parseInt(timeStr) * 60 || 900;
      const timeSpent = originalTime - writtenTimeRemaining;
      const percentage = Math.round((score / totalQuestions) * 100);
      
      const resultsData = {
        message: `Excellent work! You scored ${score}/${totalQuestions}`,
        assignmentName: 'Written Practice',
        competencyStats: competencyStats,
        score: score,
        totalQuestions: totalQuestions,
        percentage: percentage,
        timeSpent: timeSpent
      };
      
      closeQuizModal();
      
      showCongratsModal(resultsData);
      
      window.writtenQuestions = null;
      window.writtenAnswers = null;
      
    } catch (error) {
      console.error("âŒ Create your own written practice submission error:", error);
      alert("Failed to submit practice: " + error.message);
    }
  }

function calculateQuizResults() {
    console.log("ðŸ§® Calculating quiz results...");
    
    const results = {
        correct: 0,
        total: quizQuestions.length,
        answers: {},
        competencyStats: {},
        percentage: 0
    };
    
    console.log("ðŸ“ Processing", quizQuestions.length, "questions");
    
    // Calculate correct answers and build competency stats
    quizQuestions.forEach((question, idx) => {
        const selectedAnswer = document.querySelector(`input[name="q${idx+1}"]:checked`);
        if (selectedAnswer) {
            const answerValue = selectedAnswer.value;
            results.answers[`q${idx+1}`] = answerValue;
            
            console.log(`Q${idx+1}: Selected "${answerValue}", Correct: "${question.correctAnswer}"`);
            
            // Check if correct
            const isCorrect = answerValue === question.correctAnswer;
            if (isCorrect) {
                results.correct++;
                console.log(`âœ… Q${idx+1} CORRECT`);
            } else {
                console.log(`âŒ Q${idx+1} WRONG`);
            }
            
            // Track competency performance
            const competency = question.competency;
            if (!results.competencyStats[competency]) {
                results.competencyStats[competency] = {
                    total: 0,
                    correct: 0
                };
            }
            results.competencyStats[competency].total++;
            if (isCorrect) {
                results.competencyStats[competency].correct++;
            }
        }
    });
    
    results.percentage = Math.round((results.correct / results.total) * 100);
    
    console.log("ðŸ“Š Final results:", results);
    return results;
}


async function saveQuizResultsToFirebase(results) {
    const user = firebase.auth().currentUser;
    if (!user) {
        console.error('User not authenticated');
        return;
    }

    try {
        // FIXED: Remove undefined values and add null checks
        const quizResult = {
            userId: user.uid,
            to: user.uid,
            type: 'written',
            score: results.correct || 0,
            maxScore: results.total || 0,
            percentage: results.percentage || 0,
            timeUsed: results.timeUsed || 0,
            
            // FIXED: Add null checks for questionResults - use options from questionResults directly
            questions: (results.questionResults || []).map((q, index) => {
                // Get options from questionResults first, then try writtenQuestions, then currentQuiz, then empty array
                let options = q.options || [];
                if (!options || options.length === 0) {
                    if (typeof writtenQuestions !== 'undefined' && writtenQuestions && writtenQuestions[index] && writtenQuestions[index].options) {
                        options = writtenQuestions[index].options;
                    } else if (typeof currentQuiz !== 'undefined' && currentQuiz && currentQuiz !== null && currentQuiz.questions && currentQuiz.questions[index] && currentQuiz.questions[index].options) {
                        options = currentQuiz.questions[index].options;
                    } else {
                        options = [];
                    }
                }
                return {
                    text: q.question || '',
                    userAnswer: q.userAnswer || '',
                    correctAnswer: q.correctAnswer || '',
                    correct: q.isCorrect || false,
                    competency: q.competency || '',
                    questionId: `q${index + 1}`,
                    options: options
                };
            }),
            
            // FIXED: Add null checks
            competencyStats: results.competencyStats || {},
            settings: results.quizSettings || {},
            title: `${(results.quizSettings && results.quizSettings.difficulty) || 'Practice'} Quiz`,
            difficulty: (results.quizSettings && results.quizSettings.difficulty) || 'medium',
            timeLimit: (results.quizSettings && results.quizSettings.time) || 0,
            competencies: (results.quizSettings && results.quizSettings.competencies) || [],
            
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'complete'
        };

        // FIXED: Remove any remaining undefined values
        Object.keys(quizResult).forEach(key => {
            if (quizResult[key] === undefined) {
                quizResult[key] = null;
            }
        });

        console.log('Saving quiz result to Firebase:', quizResult);

        const docRef = await firebase.firestore().collection('assignments').add(quizResult);
        console.log('Quiz result saved with ID:', docRef.id);

        return docRef.id;
    } catch (error) {
        console.error('Error saving quiz results to Firebase:', error);
        throw error;
    }
}


// FIXED: closeWrittenModal function - add parameter to indicate if completed
function closeWrittenModal(wasCompleted = false) {
    console.log("Closing written modal, wasCompleted:", wasCompleted);
    
    // Clear timer
    clearInterval(writtenTimer);
    
    // Hide modal
    if (writtenModal) {
        writtenModal.style.display = 'none';
    }
    
    // Reset state
    writtenQuestions = [];
    currentQuestionIndex = 0;
    writtenAnswers = {};
    writtenTimeRemaining = 0;
    writtenTimer = null;
    
    // ONLY mark as "seen" if the user closed without completing
    if (!wasCompleted && window.latestAssignmentId && window.currentAssignment) {
        console.log("User closed modal without completing - marking as seen");
        db.collection('assignments').doc(window.latestAssignmentId)
            .update({ status: "complete" })
            .then(() => {
                console.log("Assignment marked as seen (user closed without completing)");
                window.latestAssignmentId = null;
                window.currentAssignment = null;
            })
            .catch(error => {
                console.error("Error updating assignment status:", error);
            });
    } else if (wasCompleted) {
        console.log("Modal closed after completion - not changing status");
        // Don't update status - submitWrittenPractice already set it to "complete"
        // Don't clear globals here either - let submitWrittenPractice handle it
    }
}


window.previousQuestion = previousQuestion;
window.nextQuestion = nextQuestion;
window.openWrittenPracticeModal = openWrittenPracticeModal;

function testWrittenModal() {
    window.currentAssignment = {
        type: 'written',
        title: 'Business Fundamentals Practice',
        time: '15', // 15 minutes
        writtenQuestions: sampleWrittenQuestions
    };
    window.latestAssignmentId = 'test-assignment-id';
    openWrittenPracticeModal(window.currentAssignment);
}

// Make test function globally available
window.testWrittenModal = testWrittenModal;


  function closeAssignmentModal() {
    document.getElementById('cq-assignment-modal').style.display = 'none';
  }

  function snoozeAssignment() {
    closeAssignmentModal(); // Status remains "assigned"
  }

  // === SPEAKING ASSIGNMENT FUNCTIONS ===
function submitCameraRecording() {
    // Show success and close
    closeCameraModal();
    
    confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
    });
    
    showCongratsModal({
        message: `Great job completing the speaking assignment!`,
        assignmentName: window.currentAssignmentQuestions?.title || "Assignment"
    });
}

function stopAllMedia() {
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
    }
    
    if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
    }
    
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
    }
    
    recordedChunks = [];
    recordingSeconds = 0;
}

// 1. ADD THIS CSS TO YOUR EXISTING STYLES
const uploadModalCSS = `
<style>
/* Upload Modal Styles */
.upload-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  z-index: 10002;
  display: none;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.upload-modal-overlay.active {
  opacity: 1;
}

.upload-modal-container {
  background: linear-gradient(135deg, #667eea, #764ba2);
  border-radius: 20px;
  max-width: 600px;
  width: 90%;
  color: white;
  transform: scale(0.9);
  transition: transform 0.3s ease;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
}

.upload-modal-overlay.active .upload-modal-container {
  transform: scale(1);
}

.upload-modal-header {
  padding: 25px 30px 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.upload-modal-header h2 {
  margin: 0;
  font-size: 1.4rem;
  font-weight: 600;
}

.upload-modal-close {
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: white;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 24px;
  cursor: pointer;
  transition: background 0.2s ease;
}

.upload-modal-close:hover {
  background: rgba(255, 255, 255, 0.2);
}

.upload-modal-body {
  padding: 30px;
}

.upload-drop-zone {
  border: 3px dashed rgba(255, 255, 255, 0.3);
  border-radius: 15px;
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
}

.upload-drop-zone:hover {
  border-color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.1);
  transform: translateY(-2px);
}

.upload-drop-zone.dragover {
  border-color: #4CAF50;
  background: rgba(76, 175, 80, 0.1);
  transform: scale(1.02);
}

.upload-icon {
  font-size: 3rem;
  margin-bottom: 15px;
  opacity: 0.7;
}

.upload-text {
  font-size: 1.1rem;
  margin-bottom: 10px;
  font-weight: 500;
}

.upload-subtext {
  font-size: 0.9rem;
  opacity: 0.7;
  margin-bottom: 20px;
}

.upload-file-input {
  display: none;
}

.upload-modal-footer {
  padding: 20px 30px 30px;
  display: flex;
  gap: 15px;
  justify-content: center;
}

.upload-btn {
  padding: 12px 24px;
  border-radius: 25px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  font-size: 1rem;
  transition: all 0.3s ease;
  min-width: 120px;
}

.upload-btn-primary {
  background: linear-gradient(45deg, #4CAF50, #45a049);
  color: white;
}

.upload-btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 25px rgba(76, 175, 80, 0.3);
}

.upload-btn-primary:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.upload-btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.upload-btn-secondary:hover {
  background: rgba(255, 255, 255, 0.2);
}

.file-selected {
  background: rgba(76, 175, 80, 0.2);
  border-color: #4CAF50;
  padding: 20px;
}

.file-info {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-top: 10px;
}

.file-name {
  font-weight: 600;
  color: #4CAF50;
}

.file-size {
  opacity: 0.7;
  font-size: 0.9rem;
}
</style>
`;


// 2. ADD THIS HTML TO YOUR BODY (before closing </body> tag)
const uploadModalHTML = `
<div id="uploadModal" class="upload-modal-overlay">
  <div class="upload-modal-container">
    <div class="upload-modal-header">
      <h2>Upload Your Recording</h2>
      <button class="upload-modal-close" onclick="closeUploadModal()">&times;</button>
    </div>
    <div class="upload-modal-body">
      <div id="uploadDropZone" class="upload-drop-zone">
        <div class="upload-icon">ðŸŽ¬</div>
        <div class="upload-text">Drop your recording here</div>
        <div class="upload-subtext">or click to browse files</div>
        <div class="upload-subtext">Supports WebM, MP4, MOV, AVI</div>
        <input type="file" id="uploadFileInput" class="upload-file-input" accept=".webm,.mp4,.mov,.avi,video/*,audio/*">
      </div>
      <div id="fileInfo" class="file-info" style="display: none;">
        <span class="file-name" id="fileName"></span>
        <span class="file-size" id="fileSize"></span>
      </div>
    </div>
    <div class="upload-modal-footer">
      <button class="upload-btn upload-btn-secondary" onclick="closeUploadModal()">Cancel</button>
      <button id="uploadSubmitBtn" class="upload-btn upload-btn-primary" disabled onclick="submitUploadedFile()">Send to Mentor</button>
    </div>
  </div>
</div>
`;


// 4. Add CSS styles
function addCameraModalCSS() {
    const styles = `
    <style>
        .camera-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d1b69 100%);
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .camera-modal-overlay.active {
            opacity: 1;
        }
        
        .camera-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .camera-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        
        .camera-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .camera-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .assignment-questions {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            gap: 20px;
        }
        
        .question-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            color: white;
        }
        
        .question-card strong {
            color: #64b5f6;
            display: block;
            margin-bottom: 8px;
        }
        
        .camera-main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }
        
        .video-preview {
            width: 80%;
            max-width: 800px;
            height: 60vh;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .recording-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff4757;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: none;
            animation: pulse 1.5s infinite;
        }
        
        .recording-indicator.active {
            display: block;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .recording-timer {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 1rem;
            font-family: monospace;
            display: none;
        }
        
        .recording-timer.active {
            display: block;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .camera-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 16px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .camera-toggle.camera-off {
            background: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
        }
        
        .record-btn {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            border: none;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(255, 71, 87, 0.3);
            color: white;
        }
        
        .record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 35px rgba(255, 71, 87, 0.4);
        }
        
        .record-btn.recording {
            background: #2ecc71;
        }
        
        .camera-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .action-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .no-camera {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .no-camera-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .audio-wave {
            display: flex;
            gap: 4px;
            margin: 20px 0;
        }
        
        .wave-bar {
            width: 4px;
            height: 20px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
        }
        
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes wave {
            0%, 40%, 100% { transform: scaleY(0.4); }
            20% { transform: scaleY(1); }
        }
    </style>`;
    
    document.head.insertAdjacentHTML('beforeend', styles);
}

// 5. Remove old speaking modal functions and replace with simple redirect
function openSpeakingAssignmentModal(assignment) {
    // Ensure assignment ID is set
    if (assignment && assignment.id) {
      window.latestAssignmentId = assignment.id;
      window.currentAssignment = assignment;
      console.log("Set assignment ID:", assignment.id);
    }
    
    // Set the modal title
    document.getElementById('cq-speaking-title').textContent = "Speaking Assessment";
    
    // Set assignment questions
    if (window.currentAssignmentQuestions) {
      document.getElementById('cq-speaking-q1').textContent = window.currentAssignmentQuestions.q1;
      document.getElementById('cq-speaking-q2').textContent = window.currentAssignmentQuestions.q2;
    } else if (assignment && assignment.questions) {
      document.getElementById('cq-speaking-q1').textContent = assignment.questions[0] || "No question provided";
      document.getElementById('cq-speaking-q2').textContent = assignment.questions[1] || "No question provided";
    }
    
    // Create star field
    const starsContainer = document.getElementById('cq-speaking-stars');
    if (starsContainer) {
      starsContainer.innerHTML = '';
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.className = 'cq-speaking-star';
        star.style.top = Math.random() * 100 + '%';
        star.style.left = Math.random() * 100 + '%';
        const size = Math.random() * 2 + 0.5;
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.opacity = Math.random() * 0.7 + 0.3;
        star.style.animationDuration = (Math.random() * 3 + 2) + 's';
        starsContainer.appendChild(star);
      }
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    // Show the modal
    const modal = document.getElementById('cq-speaking-modal');
    if (modal) {
      modal.style.display = 'flex';
    }
    
    // Initialize video preview (but don't start recording yet)
    setTimeout(() => {
      initializeVideoPreview();
    }, 100);
  }

  async function initializeVideoPreview() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: {
          width: { min: 640, ideal: 1280, max: 1920 },
          height: { min: 480, ideal: 720, max: 1080 },
          frameRate: { min: 15, ideal: 30, max: 60 }
        }, 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          sampleRate: 44100
        }
      });
      
      const videoElement = document.getElementById('cq-speaking-videoPreview');
      const noVideoView = document.getElementById('cq-speaking-noVideoView');
      
      if (videoElement) {
        videoElement.srcObject = stream;
        videoElement.muted = true;
        videoElement.autoplay = true;
        videoElement.playsInline = true;
        videoElement.style.display = 'block';
        if (noVideoView) noVideoView.style.display = 'none';
        
        // Store stream for later use
        cqSpeakingMediaStream = stream;
        
        // Set up recorder but don't start it yet
        setupRecordingFromStream(stream);
        
        videoElement.addEventListener('loadedmetadata', () => {
          videoElement.play().catch(e => {
            console.error("Error playing video preview:", e);
          });
        });
      }
    } catch (error) {
      console.error('Error initializing video preview:', error);
      const noVideoView = document.getElementById('cq-speaking-noVideoView');
      if (noVideoView) {
        noVideoView.style.display = 'flex';
      }
    }
  }

  // Initialize recording state variables
  let isIntentionallyStopping = false;
  let recordingStateMonitor = null;

  function checkRecordingSupport() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("Your browser does not support video recording. Please use a modern browser like Chrome, Firefox, or Edge.");
      return false;
    }
    if (!MediaRecorder) {
      alert("MediaRecorder API is not supported in your browser. Please use a modern browser.");
      return false;
    }
    return true;
  }

  function setupRecordingFromStream(stream) {
    const videoElement = document.getElementById('cq-speaking-videoPreview');
    const noVideoView = document.getElementById('cq-speaking-noVideoView');
    if (!videoElement) {
      console.error("Video preview element not found in DOM");
      alert("Video preview element not found");
      return;
    }
    
    // Set up video preview
    videoElement.srcObject = stream;
    videoElement.muted = true; // Prevent feedback
    videoElement.autoplay = true;
    videoElement.playsInline = true; // Important for mobile
    videoElement.style.display = 'block';
    if (noVideoView) noVideoView.style.display = 'none';
    
    // Wait for video to be ready before starting recording
    videoElement.addEventListener('loadedmetadata', () => {
      videoElement.play().catch(e => {
        console.error("Error playing video preview:", e);
      });
    });
    
    // Hide audio playback if showing
    const audioPlayback = document.getElementById('cq-speaking-audioPlayback');
    if (audioPlayback) {
      audioPlayback.style.display = 'none';
    }
    
    // Set up MediaRecorder with best available format
    let options = {};
    if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
      options.mimeType = 'video/webm;codecs=vp9';
    } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
      options.mimeType = 'video/webm;codecs=vp8';
    } else if (MediaRecorder.isTypeSupported('video/webm')) {
      options.mimeType = 'video/webm';
    } else if (MediaRecorder.isTypeSupported('video/mp4')) {
      options.mimeType = 'video/mp4';
    }
    
    cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
    console.log("MediaRecorder created with mimeType:", cqSpeakingMediaRecorder.mimeType);
    
    cqSpeakingMediaRecorder.ondataavailable = (event) => {
      if (event.data && event.data.size > 0) {
        cqSpeakingRecordedChunks.push(event.data);
        console.log("Added chunk, total chunks:", cqSpeakingRecordedChunks.length, "total size:", cqSpeakingRecordedChunks.reduce((sum, chunk) => sum + chunk.size, 0), "bytes");
      }
    };
    
    cqSpeakingMediaRecorder.onstop = () => {
      console.log("Video recording stopped, processing...");
      console.log("Total chunks collected:", cqSpeakingRecordedChunks.length);
      
      // Clear state monitor when recording stops
      if (recordingStateMonitor) {
        clearInterval(recordingStateMonitor);
        recordingStateMonitor = null;
        console.log("âœ… State monitor cleared in onstop handler");
      }
      
      // Wait for final data to arrive
      setTimeout(() => {
        console.log("Processing after stop, chunks:", cqSpeakingRecordedChunks.length);
        
        if (cqSpeakingRecordedChunks.length === 0) {
          console.error("No video data recorded after stop");
          alert("No video data was recorded. Please try recording for at least 1 second.");
          return;
        }
        const mimeType = cqSpeakingMediaRecorder.mimeType || 'video/webm';
        const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });
        console.log("Created video blob:", blob.size, "bytes, type:", blob.type);

        const videoURL = URL.createObjectURL(blob);
        const videoElement = document.getElementById('cq-speaking-videoPreview');
        const noVideoView = document.getElementById('cq-speaking-noVideoView');
        if (videoElement) {
          videoElement.srcObject = null;
          videoElement.src = videoURL;
          videoElement.controls = true;
          videoElement.muted = false;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
          console.log("Video playback element updated");
        }

        // Update record button state
        const recordBtn = document.getElementById('cq-speaking-recordBtn');
        if (recordBtn) {
          recordBtn.classList.remove('recording');
        }
        
        // Hide recording indicator
        const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
        if (recordingIndicator) {
          recordingIndicator.classList.remove('active');
        }

        // Download button (hidden but kept for functionality)
        const downloadBtn = document.getElementById('cq-speaking-downloadBtn');
        if (downloadBtn && blob) {
          downloadBtn.style.display = 'none';
          downloadBtn.onclick = function() {
            const url = URL.createObjectURL(blob);
            const filename = `CertQuest_Response_${Date.now()}.webm`;
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, 100);
          };
        }

        isRecording = false;
        
        // Show submit button after recording stops
        const submitBtn = document.getElementById('cq-speaking-submitBtn');
        if (submitBtn && cqSpeakingRecordedChunks.length > 0) {
          submitBtn.style.display = 'block';
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Assessment';
        }
      }, 1000);
    };
    
    cqSpeakingMediaRecorder.onerror = (event) => {
      console.error("MediaRecorder error:", event.error);
      alert("Recording error: " + (event.error?.message || "Unknown error. Recording may have stopped unexpectedly."));
      isRecording = false;
      
      // Update UI
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      // Hide recording indicator
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
    };
    
    // Monitor recording state to catch unexpected stops
    // Use global variable so we can clear it from stopRecording
    cqSpeakingMediaRecorder.addEventListener('start', () => {
      console.log("ðŸŽ¬ MediaRecorder start event fired");
      // Reset intentional stop flag
      isIntentionallyStopping = false;
      
      // Clear any existing check
      if (recordingStateMonitor) {
        clearInterval(recordingStateMonitor);
        recordingStateMonitor = null;
      }
      
      // Periodically check that recording is still active
      recordingStateMonitor = setInterval(() => {
        // Skip check if we're intentionally stopping
        if (isIntentionallyStopping) {
          console.log("â­ï¸ Skipping state check - intentional stop in progress");
          return;
        }
        
        if (cqSpeakingMediaRecorder && isRecording) {
          const state = cqSpeakingMediaRecorder.state;
          if (state === 'recording') {
            console.log("âœ… Recording still active, state:", state, "chunks:", cqSpeakingRecordedChunks.length);
          } else if (state === 'inactive' || state === 'paused') {
            // Only alert if this wasn't an intentional stop
            if (!isIntentionallyStopping) {
              console.error("âŒ Recording stopped unexpectedly! State:", state);
              clearInterval(recordingStateMonitor);
              recordingStateMonitor = null;
              isRecording = false;
              const recordBtn = document.getElementById('cq-speaking-recordBtn');
              if (recordBtn) {
                recordBtn.classList.remove('recording');
              }
              
              // Hide recording indicator
              const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
              if (recordingIndicator) {
                recordingIndicator.classList.remove('active');
              }
              
              alert("âš ï¸ Recording stopped unexpectedly. State: " + state + ". This may be a browser or system issue. Please try again.");
            } else {
              console.log("âœ… Recording stopped intentionally - no alert needed");
              clearInterval(recordingStateMonitor);
              recordingStateMonitor = null;
            }
          }
        } else if (!isRecording && !isIntentionallyStopping) {
          // Recording was stopped but not intentionally (shouldn't happen, but clear monitor)
          console.log("âš ï¸ Recording stopped but isRecording flag is false and not intentional");
          clearInterval(recordingStateMonitor);
          recordingStateMonitor = null;
        }
      }, 1000); // Check every second
    });
  }

  function stopRecording() {
    console.log("ðŸ›‘ stopRecording() called - user intentionally stopping");
    
    if (!cqSpeakingMediaRecorder || !isRecording) {
      console.log("Cannot stop: no recorder or not recording");
      return;
    }
    
    isIntentionallyStopping = true;
    
    if (recordingStateMonitor) {
      clearInterval(recordingStateMonitor);
      recordingStateMonitor = null;
      console.log("âœ… State monitor cleared");
    }
    
    console.log("Stopping recording, current state:", cqSpeakingMediaRecorder.state);
    console.log("Chunks before stop:", cqSpeakingRecordedChunks.length);
    
    isRecording = false;
    
    if (cqSpeakingMediaRecorder.state === 'recording') {
      try {
        cqSpeakingMediaRecorder.requestData();
        console.log("Requested final data before stop");
        setTimeout(() => {
          try {
            cqSpeakingMediaRecorder.stop();
            console.log("âœ… Recorder stopped after requesting data");
          } catch (e) {
            console.error("Error stopping recorder:", e);
          }
        }, 100);
        
        const recordBtn = document.getElementById('cq-speaking-recordBtn');
        if (recordBtn) {
          recordBtn.classList.remove('recording');
        }
        
        const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
        if (recordingIndicator) {
          recordingIndicator.classList.remove('active');
        }
        
        return;
      } catch (e) {
        console.error("Error requesting final data:", e);
      }
    }
    
    try {
      cqSpeakingMediaRecorder.stop();
      console.log("âœ… Recorder stopped, new state:", cqSpeakingMediaRecorder.state);
    } catch (e) {
      console.error("Error stopping recorder:", e);
    }
    
    const recordBtn = document.getElementById('cq-speaking-recordBtn');
    if (recordBtn) {
      recordBtn.classList.remove('recording');
    }
    
    const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    console.log("Chunks after stop:", cqSpeakingRecordedChunks.length);
  }

  function toggleSpeakingRecording() {
    const recordBtn = document.getElementById('cq-speaking-recordBtn');
    if (!recordBtn) return;
    
    if (isRecording) {
      console.log("Stopping recording via toggle button");
      stopRecording();
    } else {
      console.log("Starting recording via toggle button");
      
      if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
        cqSpeakingRecordedChunks = [];
        console.log("Starting existing recorder");
        try {
          isRecording = true;
          recordBtn.classList.add('recording');
          
          const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
          if (recordingIndicator) {
            recordingIndicator.classList.add('active');
          }
          
          cqSpeakingMediaRecorder.start();
          console.log("âœ… Recording started successfully, state:", cqSpeakingMediaRecorder.state);
          
          setTimeout(() => {
            // Skip check if we're intentionally stopping
            if (isIntentionallyStopping) {
              console.log("â­ï¸ Skipping 2-second check - intentional stop in progress");
              return;
            }
            if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'recording' && isRecording) {
              console.log("âœ… Recording still active after 2 seconds - good!");
            } else {
              console.error("âŒ Recording stopped unexpectedly! State:", cqSpeakingMediaRecorder?.state, "isRecording:", isRecording);
              alert("Recording stopped unexpectedly. Please check browser console for errors.");
            }
          }, 2000);
        } catch (e) {
          console.error("Error starting recorder:", e);
          alert("Error starting recording: " + e.message);
          isRecording = false;
        }
      } else if (cqSpeakingMediaStream && !cqSpeakingMediaRecorder) {
        console.log("Setting up recorder from existing stream");
        setupRecordingFromStream(cqSpeakingMediaStream);
        setTimeout(() => {
          if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
            cqSpeakingRecordedChunks = [];
            try {
              isRecording = true;
              recordBtn.classList.add('recording');
              
              const recordingIndicator2 = document.getElementById('cq-speaking-recordingIndicator');
              if (recordingIndicator2) {
                recordingIndicator2.classList.add('active');
              }
              
              cqSpeakingMediaRecorder.start();
              console.log("âœ… Recording started after setup, state:", cqSpeakingMediaRecorder.state);
              
              setTimeout(() => {
                // Skip check if we're intentionally stopping
                if (isIntentionallyStopping) {
                  console.log("â­ï¸ Skipping 2-second check - intentional stop in progress");
                  return;
                }
                if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'recording' && isRecording) {
                  console.log("âœ… Recording still active after 2 seconds - good!");
                } else {
                  console.error("âŒ Recording stopped unexpectedly! State:", cqSpeakingMediaRecorder?.state, "isRecording:", isRecording);
                  alert("Recording stopped unexpectedly. Please check browser console for errors.");
                }
              }, 2000);
            } catch (e) {
              console.error("Error starting recorder after setup:", e);
              alert("Error starting recording: " + e.message);
              isRecording = false;
            }
          } else {
            console.error("Recorder not ready after setup");
          }
        }, 200);
      } else if (!cqSpeakingMediaStream) {
        console.log("Getting new stream and starting recording");
        initializeVideoPreview();
      } else {
        console.error("Cannot start recording: recorder state is", cqSpeakingMediaRecorder.state);
        alert("Recording is already in progress or not ready. Please wait.");
      }
    }
  }
  
  window.toggleSpeakingRecording = toggleSpeakingRecording;

  function cqSpeakingStopAllMedia() {
    if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state !== 'inactive') {
      try {
        cqSpeakingMediaRecorder.stop();
      } catch (e) {
        console.error("Error stopping recorder:", e);
      }
    }
    
    if (cqSpeakingMediaStream) {
      cqSpeakingMediaStream.getTracks().forEach(track => track.stop());
      cqSpeakingMediaStream = null;
    }
    
    cqSpeakingMediaRecorder = null;
    cqSpeakingRecordedChunks = [];
    isRecording = false;
    
    const recordBtn = document.getElementById('cq-speaking-recordBtn');
    if (recordBtn) {
      recordBtn.classList.remove('recording');
    }
    
    const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
  }

  // ========== CASE STUDY MODAL FUNCTIONS ==========
  // Initialize recording variables for case study
  let cqCaseStudyIsRecording = false;
  let cqCaseStudyIsIntentionallyStopping = false;
  let cqCaseStudyRecordingStateMonitor = null;
  let cqCaseStudyMediaRecorder = null;
  let cqCaseStudyMediaStream = null;
  let cqCaseStudyRecordedChunks = [];
  let cqCaseStudyTimerInterval = null;
  let cqCaseStudyTimeLeft = 1200; // 20 minutes in seconds
  let cqCaseStudyTimerActive = false;

  // Helper function to convert blob to base64 for case study
  async function cqCaseStudyBlobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  // Timer functions
  function toggleCaseStudyTimer() {
    cqCaseStudyTimerActive = !cqCaseStudyTimerActive;
    const timerEl = document.getElementById('cq-case-study-timer');
    const timerDot = document.getElementById('cq-case-study-timer-dot');
    const timerText = document.getElementById('cq-case-study-timer-text');
    const timerStart = document.getElementById('cq-case-study-timer-start');
    
    if (cqCaseStudyTimerActive) {
      timerEl.classList.add('active');
      if (timerStart) timerStart.style.display = 'none';
      
      // Start countdown
      cqCaseStudyTimerInterval = setInterval(() => {
        if (cqCaseStudyTimeLeft > 0) {
          cqCaseStudyTimeLeft--;
          if (timerText) {
            const mins = Math.floor(cqCaseStudyTimeLeft / 60);
            const secs = cqCaseStudyTimeLeft % 60;
            timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
          }
        } else {
          cqCaseStudyTimerActive = false;
          if (timerEl) timerEl.classList.remove('active');
          if (timerStart) timerStart.style.display = 'inline';
          if (cqCaseStudyTimerInterval) {
            clearInterval(cqCaseStudyTimerInterval);
            cqCaseStudyTimerInterval = null;
          }
          alert('Time is up!');
        }
      }, 1000);
    } else {
      timerEl.classList.remove('active');
      if (timerStart) timerStart.style.display = 'inline';
      if (cqCaseStudyTimerInterval) {
        clearInterval(cqCaseStudyTimerInterval);
        cqCaseStudyTimerInterval = null;
      }
    }
  }
  window.toggleCaseStudyTimer = toggleCaseStudyTimer;

  // Expand/collapse content
  function expandCaseStudyContent() {
    document.getElementById('cq-case-study-top-info').style.display = 'none';
    document.getElementById('cq-case-study-video-container').style.display = 'none';
    document.getElementById('cq-case-study-bottom-info').style.display = 'none';
    document.getElementById('cq-case-study-controls-wrapper').style.display = 'none';
    document.getElementById('cq-case-study-expanded-content').style.display = 'flex';
  }
  window.expandCaseStudyContent = expandCaseStudyContent;

  function collapseCaseStudyContent() {
    document.getElementById('cq-case-study-top-info').style.display = 'grid';
    document.getElementById('cq-case-study-video-container').style.display = 'block';
    document.getElementById('cq-case-study-bottom-info').style.display = 'grid';
    document.getElementById('cq-case-study-controls-wrapper').style.display = 'flex';
    document.getElementById('cq-case-study-expanded-content').style.display = 'none';
  }
  window.collapseCaseStudyContent = collapseCaseStudyContent;

  function openCaseStudyModal(assignment) {
    // Ensure assignment ID is set
    if (assignment && assignment.id) {
      window.latestAssignmentId = assignment.id;
      window.currentAssignment = assignment;
      console.log("Set assignment ID:", assignment.id);
    }
    
    // Set the modal title
    document.getElementById('cq-case-study-title').textContent = "Case Study";
    
    // Set case name
    const caseName = assignment.title || "Case Study";
    document.getElementById('cq-case-study-name').textContent = caseName;
    document.getElementById('cq-case-study-expanded-title').textContent = caseName;
    
    // Set case study content
    const caseContent = assignment.description || assignment.caseStudyContent || "No case study content provided.";
    const previewText = caseContent.substring(0, 100) + (caseContent.length > 100 ? '...' : '');
    document.getElementById('cq-case-study-content-preview-text').textContent = previewText;
    document.getElementById('cq-case-study-full-content').textContent = caseContent;
    
    // Set assignment questions
    if (assignment.questions && assignment.questions.length > 0) {
      document.getElementById('cq-case-study-q1').textContent = assignment.questions[0] || "No question provided";
      if (assignment.questions.length > 1) {
        document.getElementById('cq-case-study-q2').textContent = assignment.questions[1] || "No question provided";
      }
    }
    
    // Reset timer to 20 minutes
    cqCaseStudyTimeLeft = 1200; // Always 20 minutes (1200 seconds)
    const timerText = document.getElementById('cq-case-study-timer-text');
    if (timerText) {
      const mins = Math.floor(cqCaseStudyTimeLeft / 60);
      const secs = cqCaseStudyTimeLeft % 60;
      timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    cqCaseStudyTimerActive = false;
    const timerEl = document.getElementById('cq-case-study-timer');
    if (timerEl) timerEl.classList.remove('active');
    
    // Create star field
    const starsContainer = document.getElementById('cq-case-study-stars');
    if (starsContainer) {
      starsContainer.innerHTML = '';
      for (let i = 0; i < 150; i++) {
        const star = document.createElement('div');
        star.className = 'cq-case-study-star';
        star.style.top = Math.random() * 100 + '%';
        star.style.left = Math.random() * 100 + '%';
        const size = Math.random() * 2 + 0.5;
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.opacity = Math.random() * 0.7 + 0.3;
        star.style.animationDuration = (Math.random() * 3 + 2) + 's';
        starsContainer.appendChild(star);
      }
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    // Reset UI state
    collapseCaseStudyContent();
    document.getElementById('cq-case-study-submitBtn').style.display = 'none';
    document.getElementById('cq-case-study-downloadBtn').style.display = 'none';
    
    // Show the modal
    const modal = document.getElementById('cq-case-study-modal');
    if (modal) {
      modal.style.display = 'flex';
    }
    
    // Initialize video preview (but don't start recording yet)
    setTimeout(() => {
      cqCaseStudyInitializeVideoPreview();
    }, 100);
  }
  window.openCaseStudyModal = openCaseStudyModal;

  // Close case study modal
  function closeCaseStudyModal() {
    // Stop timer
    if (cqCaseStudyTimerInterval) {
      clearInterval(cqCaseStudyTimerInterval);
      cqCaseStudyTimerInterval = null;
    }
    cqCaseStudyTimerActive = false;
    
    // Stop all media
    cqCaseStudyStopAllMedia();
    
    // Hide modal
    const modal = document.getElementById('cq-case-study-modal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  window.closeCaseStudyModal = closeCaseStudyModal;

  // Initialize video preview
  async function cqCaseStudyInitializeVideoPreview() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: {
          width: { min: 640, ideal: 1280, max: 1920 },
          height: { min: 480, ideal: 720, max: 1080 },
          frameRate: { min: 15, ideal: 30, max: 60 }
        }, 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          sampleRate: 44100
        }
      });
      
      const videoElement = document.getElementById('cq-case-study-videoPreview');
      const noVideoView = document.getElementById('cq-case-study-noVideoView');
      
      if (videoElement) {
        videoElement.srcObject = stream;
        videoElement.muted = true;
        videoElement.autoplay = true;
        videoElement.playsInline = true;
        videoElement.style.display = 'block';
        if (noVideoView) noVideoView.style.display = 'none';
        
        // Store stream for later use
        cqCaseStudyMediaStream = stream;
        
        // Set up recorder but don't start it yet
        cqCaseStudySetupRecordingFromStream(stream);
        
        videoElement.addEventListener('loadedmetadata', () => {
          videoElement.play().catch(e => {
            console.error("Error playing video preview:", e);
          });
        });
      }
    } catch (error) {
      console.error('Error initializing video preview:', error);
      const noVideoView = document.getElementById('cq-case-study-noVideoView');
      if (noVideoView) {
        noVideoView.style.display = 'flex';
      }
    }
  }

  // Setup recording from stream
  function cqCaseStudySetupRecordingFromStream(stream) {
    const videoElement = document.getElementById('cq-case-study-videoPreview');
    if (!videoElement) {
      console.error("Video preview element not found in DOM");
      return;
    }
    
    // Set up MediaRecorder with best available format
    let options = {};
    if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
      options.mimeType = 'video/webm;codecs=vp9';
    } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
      options.mimeType = 'video/webm;codecs=vp8';
    } else if (MediaRecorder.isTypeSupported('video/webm')) {
      options.mimeType = 'video/webm';
    } else if (MediaRecorder.isTypeSupported('video/mp4')) {
      options.mimeType = 'video/mp4';
    }
    
    cqCaseStudyMediaRecorder = new MediaRecorder(stream, options);
    console.log("Case Study MediaRecorder created with mimeType:", cqCaseStudyMediaRecorder.mimeType);
    
    cqCaseStudyMediaRecorder.ondataavailable = (event) => {
      console.log("Case Study video data available:", event.data.size, "bytes");
      if (event.data.size > 0) {
        cqCaseStudyRecordedChunks.push(event.data);
        console.log("Added chunk, total chunks:", cqCaseStudyRecordedChunks.length, "total size:", cqCaseStudyRecordedChunks.reduce((sum, chunk) => sum + chunk.size, 0), "bytes");
      }
    };
    
    cqCaseStudyMediaRecorder.onstop = () => {
      console.log("Case Study video recording stopped, processing...");
      console.log("Total chunks collected:", cqCaseStudyRecordedChunks.length);
      
      if (cqCaseStudyRecordedChunks.length === 0) {
        console.error("No video data recorded");
        alert("No video data was recorded. Please try again.");
        return;
      }
      
      const mimeType = cqCaseStudyMediaRecorder.mimeType || 'video/webm';
      const blob = new Blob(cqCaseStudyRecordedChunks, { type: mimeType });
      console.log("Created video blob:", blob.size, "bytes, type:", blob.type);

      const videoURL = URL.createObjectURL(blob);
      const videoElement = document.getElementById('cq-case-study-videoPreview');
      const noVideoView = document.getElementById('cq-case-study-noVideoView');
      if (videoElement) {
        videoElement.srcObject = null;
        videoElement.src = videoURL;
        videoElement.controls = true;
        videoElement.muted = false;
        videoElement.style.display = 'block';
        if (noVideoView) noVideoView.style.display = 'none';
        console.log("Video playback element updated");
      }
      
      // Show download button
      const downloadBtn = document.getElementById('cq-case-study-downloadBtn');
      if (downloadBtn && blob) {
        downloadBtn.style.display = 'flex';
        downloadBtn.onclick = function() {
          const url = URL.createObjectURL(blob);
          const filename = `CertQuest_CaseStudy_${Date.now()}.webm`;
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }, 100);
        };
      }
      
      // Show submit button
      const submitBtn = document.getElementById('cq-case-study-submitBtn');
      if (submitBtn) {
        submitBtn.style.display = 'block';
      }
    };
    
    cqCaseStudyMediaRecorder.onerror = (event) => {
      console.error("Case Study MediaRecorder error:", event.error);
      alert("Recording error: " + event.error.message);
      cqCaseStudyIsRecording = false;
    };
  }

  // Stop all media
  function cqCaseStudyStopAllMedia() {
    if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state !== 'inactive') {
      try {
        cqCaseStudyMediaRecorder.stop();
      } catch (e) {
        console.error("Error stopping recorder:", e);
      }
    }
    
    if (cqCaseStudyMediaStream) {
      cqCaseStudyMediaStream.getTracks().forEach(track => track.stop());
      cqCaseStudyMediaStream = null;
    }
    
    cqCaseStudyMediaRecorder = null;
    cqCaseStudyRecordedChunks = [];
    cqCaseStudyIsRecording = false;
    
    const recordBtn = document.getElementById('cq-case-study-recordBtn');
    if (recordBtn) {
      recordBtn.classList.remove('recording');
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    // Hide download button
    const downloadBtn = document.getElementById('cq-case-study-downloadBtn');
    if (downloadBtn) {
      downloadBtn.style.display = 'none';
    }
  }

  // Toggle recording
  function toggleCaseStudyRecording() {
    const recordBtn = document.getElementById('cq-case-study-recordBtn');
    if (!recordBtn) return;
    
    if (cqCaseStudyIsRecording) {
      // Stop recording
      console.log("Stopping case study recording via toggle button");
      cqCaseStudyStopRecording();
    } else {
      // Start recording
      console.log("Starting case study recording via toggle button");
      if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
        cqCaseStudyRecordedChunks = [];
        try {
          cqCaseStudyIsRecording = true;
          recordBtn.classList.add('recording');
          
          // Show recording indicator
          const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
          if (recordingIndicator) {
            recordingIndicator.classList.add('active');
          }
          
          cqCaseStudyMediaRecorder.start();
          console.log("âœ… Case Study recording started successfully, state:", cqCaseStudyMediaRecorder.state);
        } catch (e) {
          console.error("Error starting recorder:", e);
          alert("Error starting recording: " + e.message);
          cqCaseStudyIsRecording = false;
        }
      } else if (cqCaseStudyMediaStream && !cqCaseStudyMediaRecorder) {
        cqCaseStudySetupRecordingFromStream(cqCaseStudyMediaStream);
        setTimeout(() => {
          if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
            cqCaseStudyRecordedChunks = [];
            try {
              cqCaseStudyIsRecording = true;
              recordBtn.classList.add('recording');
              
              // Show recording indicator
              const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
              if (recordingIndicator) {
                recordingIndicator.classList.add('active');
              }
              
              cqCaseStudyMediaRecorder.start();
              console.log("âœ… Case Study recording started after setup, state:", cqCaseStudyMediaRecorder.state);
            } catch (e) {
              console.error("Error starting recorder after setup:", e);
              alert("Error starting recording: " + e.message);
              cqCaseStudyIsRecording = false;
            }
          }
        }, 200);
      } else if (!cqCaseStudyMediaStream) {
        cqCaseStudyInitializeVideoPreview();
      } else {
        alert("Recording is already in progress or not ready. Please wait.");
      }
    }
  }
  window.toggleCaseStudyRecording = toggleCaseStudyRecording;

  // Stop recording
  function cqCaseStudyStopRecording() {
    if (!cqCaseStudyMediaRecorder || !cqCaseStudyIsRecording) {
      console.log("Cannot stop: no recorder or not recording");
      return;
    }
    
    cqCaseStudyIsIntentionallyStopping = true;
    
    console.log("Stopping case study recording, current state:", cqCaseStudyMediaRecorder.state);
    
    cqCaseStudyIsRecording = false;
    
    if (cqCaseStudyMediaRecorder.state === 'recording') {
      try {
        cqCaseStudyMediaRecorder.requestData();
        cqCaseStudyMediaRecorder.stop();
      } catch (e) {
        console.error("Error stopping recorder:", e);
      }
    }
    
    const recordBtn = document.getElementById('cq-case-study-recordBtn');
    if (recordBtn) {
      recordBtn.classList.remove('recording');
    }
    
    // Hide recording indicator
    const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
    if (recordingIndicator) {
      recordingIndicator.classList.remove('active');
    }
    
    cqCaseStudyIsIntentionallyStopping = false;
  }

  // Submit case study response
  async function submitCaseStudyResponse() {
    if (!window.latestAssignmentId || cqCaseStudyRecordedChunks.length === 0) {
      alert("Recording not found or assignment ID missing.");
      return;
    }

    // Update submit button state
    const submitBtn = document.getElementById('cq-case-study-submitBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
    }

    const blob = new Blob(cqCaseStudyRecordedChunks, { type: 'video/webm' });
    const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

    const GITHUB_USERNAME = "Anjay209";
    const GITHUB_REPO = "video-storage";
    const GITHUB_TOKEN = "REDACTED_TOKEN";

    let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
    let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

    try {
      const base64 = await cqCaseStudyBlobToBase64(blob);

      const uploadRes = await fetch(githubApiUrl, {
        method: 'PUT',
        headers: {
          Authorization: `Bearer ${GITHUB_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Upload ${filename}`,
          content: base64,
          branch: 'main'
        })
      });

      if (!uploadRes.ok) {
        const errData = await uploadRes.json().catch(() => ({}));
        const errorMessage = errData?.message || "GitHub upload failed";
        
        if (uploadRes.status === 409) {
          console.log("File exists, attempting to update with SHA...");
          try {
            const getRes = await fetch(githubApiUrl, {
              headers: {
                Authorization: `Bearer ${GITHUB_TOKEN}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (getRes.ok) {
              const existingFile = await getRes.json();
              const updateRes = await fetch(githubApiUrl, {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Update ${filename}`,
                  content: base64,
                  branch: 'main',
                  sha: existingFile.sha
                })
              });
              
              if (!updateRes.ok) {
                throw new Error("Failed to update existing file: " + (await updateRes.json().catch(() => ({}))).message);
              }
              console.log("Successfully updated existing file");
            } else {
              throw new Error("Could not get existing file info: " + errorMessage);
            }
          } catch (updateError) {
            console.log("Update failed, using unique filename...");
            const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
            const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
            const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
            
            const retryRes = await fetch(uniqueGithubApiUrl, {
              method: 'PUT',
              headers: {
                Authorization: `Bearer ${GITHUB_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Upload ${uniqueFilename}`,
                content: base64,
                branch: 'main'
              })
            });
            
            if (!retryRes.ok) {
              throw new Error("Failed to upload with unique filename: " + (await retryRes.json().catch(() => ({}))).message);
            }
            
            githubPagesUrl = uniqueGithubPagesUrl;
            console.log("Successfully uploaded with unique filename");
          }
        } else {
          throw new Error(errorMessage);
        }
      }

      // Firestore update
      await firebase.firestore()
        .collection('assignments')
        .doc(window.latestAssignmentId)
        .update({
          status: "complete",
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          recordingUrl: githubPagesUrl
        });

      // Update user's assignments collection
      const user = firebase.auth().currentUser;
      const userId = user?.uid;
      const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
      
      if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
        try {
          await firebase.firestore()
            .collection('users')
            .doc(userId)
            .collection('assignments')
            .doc(assignmentId)
            .set({
              status: "complete",
              completedAt: firebase.firestore.FieldValue.serverTimestamp(),
              recordingUrl: githubPagesUrl
            }, { merge: true });
        } catch (userUpdateError) {
          console.error("Error updating user assignments:", userUpdateError);
        }
      }

      // Fetch assignment data to get competencies
      let competencies = [];
      let assignmentName = 'Case Study';
      try {
        const assignmentDoc = await firebase.firestore()
          .collection('assignments')
          .doc(window.latestAssignmentId)
          .get();
        
        if (assignmentDoc.exists) {
          const assignmentData = assignmentDoc.data();
          competencies = assignmentData.competencies || [];
          assignmentName = assignmentData.title || 'Case Study';
        }
      } catch (error) {
        console.error("Error fetching assignment data:", error);
      }

      // Show success message and congrats modal
      showCongratsModal({ 
        score: undefined, 
        totalQuestions: undefined,
        assignmentName: assignmentName,
        competencies: competencies,
        assignmentType: 'case'
      });
      
      // Close modal
      closeCaseStudyModal();
    } catch (error) {
      console.error("Upload Error:", error);
      alert("Upload Error: " + error.message);
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Case Study';
      }
    }
  }
  window.submitCaseStudyResponse = submitCaseStudyResponse;
  function closeSpeakingAssignmentModal() {
    document.getElementById('cq-speaking-downloadBtn').style.display = 'none';

    // Stop any active recordings
    cqSpeakingStopAllMedia();
    
    // Hide modal
    document.getElementById('cq-speaking-modal').style.display = 'none';
    
    // Mark as seen (if assignment exists)
    if (window.latestAssignmentId) {
      db.collection('assignments').doc(window.latestAssignmentId)
        .update({ status: "complete" })
        .then(() => {
          window.latestAssignmentId = null;
          window.currentAssignment = null;
        })
        .catch(error => {
          console.error("Error updating assignment status:", error);
        });
    }
  }


  // Helper function to convert blob to base64
  async function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64 = reader.result.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

async function submitSpeakingResponse() {
  if (!window.latestAssignmentId || cqSpeakingRecordedChunks.length === 0) {
    alert("Recording not found or assignment ID missing.");
    return;
  }

  // Update submit button state
  const submitBtn = document.getElementById('cq-speaking-submitBtn');
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';
  }

  const blob = new Blob(cqSpeakingRecordedChunks, { type: 'video/webm' });
  const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

  const GITHUB_USERNAME = "Anjay209";
  const GITHUB_REPO = "video-storage";
  const GITHUB_TOKEN = "REDACTED_TOKEN"; // ðŸ” Rotate in production

  let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
  let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

  try {
    const base64 = await blobToBase64(blob);

    const uploadRes = await fetch(githubApiUrl, {
      method: 'PUT',
      headers: {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Upload ${filename}`,
        content: base64,
        branch: 'main'
      })
    });

    if (!uploadRes.ok) {
      const errData = await uploadRes.json().catch(() => ({}));
      const errorMessage = errData?.message || "GitHub upload failed";
      
      // Handle 409 Conflict - file already exists, try to update it
      if (uploadRes.status === 409) {
        console.log("File exists, attempting to update with SHA...");
        try {
          // Get the existing file's SHA
          const getRes = await fetch(githubApiUrl, {
            headers: {
              Authorization: `Bearer ${GITHUB_TOKEN}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });
          
          if (getRes.ok) {
            const existingFile = await getRes.json();
            // Update with SHA
            const updateRes = await fetch(githubApiUrl, {
              method: 'PUT',
              headers: {
                Authorization: `Bearer ${GITHUB_TOKEN}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                message: `Update ${filename}`,
                content: base64,
                branch: 'main',
                sha: existingFile.sha
              })
            });
            
            if (!updateRes.ok) {
              throw new Error("Failed to update existing file: " + (await updateRes.json().catch(() => ({}))).message);
            }
            console.log("Successfully updated existing file");
          } else {
            throw new Error("Could not get existing file info: " + errorMessage);
          }
        } catch (updateError) {
          // If update fails, use a unique filename
          console.log("Update failed, using unique filename...");
          const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
          const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
          const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
          
          const retryRes = await fetch(uniqueGithubApiUrl, {
            method: 'PUT',
            headers: {
              Authorization: `Bearer ${GITHUB_TOKEN}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Upload ${uniqueFilename}`,
              content: base64,
              branch: 'main'
            })
          });
          
          if (!retryRes.ok) {
            throw new Error("Failed to upload with unique filename: " + (await retryRes.json().catch(() => ({}))).message);
          }
          
          // Update the URL to use the unique filename
          githubPagesUrl = uniqueGithubPagesUrl;
          console.log("Successfully uploaded with unique filename");
        }
      } else {
        throw new Error(errorMessage);
      }
    }

    // Firestore update - setting status to "complete" in assignments collection
    // Only update if assignmentId exists
    if (window.latestAssignmentId && window.latestAssignmentId.trim() !== '') {
      await firebase.firestore()
        .collection('assignments')
        .doc(window.latestAssignmentId)
        .update({
          status: "complete",
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          recordingUrl: githubPagesUrl
        });
      console.log("âœ… Assignment updated successfully");
    } else {
      console.warn("âš ï¸ Skipping assignment update - no assignment ID");
    }

    // âœ… Also update user's assignments collection
    const user = firebase.auth().currentUser;
    const userId = user?.uid;
    const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
    
    if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
      console.log("Updating user assignments collection:", userId, assignmentId);
      try {
        await firebase.firestore()
          .collection('users')
          .doc(userId)
          .collection('assignments')
          .doc(assignmentId)
          .set({
            status: 'completed',
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            fileUrl: githubPagesUrl,
            fileType: 'video',
          }, { merge: true });
        console.log("Successfully updated user assignments collection");
      } catch (userAssignError) {
        console.warn("Could not update user assignments collection (non-critical):", userAssignError);
      }
    }

    // Fetch assignment data to get competencies
    let competencies = [];
    let assignmentName = 'Speaking Assessment';
    try {
      const assignmentDoc = await firebase.firestore()
        .collection('assignments')
        .doc(window.latestAssignmentId)
        .get();
      
      if (assignmentDoc.exists) {
        const assignmentData = assignmentDoc.data();
        competencies = assignmentData.competencies || [];
        assignmentName = assignmentData.title || 'Speaking Assessment';
      }
    } catch (error) {
      console.error("Error fetching assignment data:", error);
    }

    // Show success message and congrats modal
    showCongratsModal({ 
      score: undefined, 
      totalQuestions: undefined,
      assignmentName: assignmentName,
      competencies: competencies,
      assignmentType: 'speaking'
    });
    
    // Close modal
    closeSpeakingAssignmentModal();

  } catch (err) {
    console.error("Upload Error:", err);
    const errorMessage = err.message || "Something went wrong while uploading your recording.";
    
    if (errorMessage.includes("authentication") || errorMessage.includes("token") || errorMessage.includes("credentials")) {
      alert("âŒ Authentication Error: " + errorMessage + "\n\nPlease contact the administrator to update the GitHub token.");
    } else if (errorMessage.includes("permission") || errorMessage.includes("not accessible") || errorMessage.includes("403")) {
      alert("âŒ Permission Error: " + errorMessage);
    } else {
      alert("âŒ Upload Error: " + errorMessage);
    }
    
    // Re-enable submit button on error
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Submit Assessment';
    }
  }
}

function blobToBase64(blob) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(blob);
  });
}




  // === NOTIFICATION FUNCTIONS ===
 function setupNotifications() {
  const user = auth.currentUser;
  if (!user) {
    console.log("No user logged in");
    return;
  }

  console.log("Setting up notifications for user:", user.uid);

  db.collection('notifications')
    .where('menteeId', '==', user.uid)
    .where('showModal', '==', true)
    .where('read', '==', false)
    .orderBy('timestamp', 'desc')
    .onSnapshot((snapshot) => {
      console.log("Received notifications snapshot with", snapshot.size, "items");
      
      snapshot.docChanges().forEach((change) => {
        if (change.type === "added") {
          console.log("New notification received:", change.doc.data());
          showCongratsModal(change.doc.data());
          
          // ONLY mark showModal as false to prevent re-showing
          // DON'T mark as read - let user dismiss manually
          setTimeout(() => {
            change.doc.ref.update({
              showModal: false  // Remove this line: read: true,
            });
          }, 1000);
        }
      });
    }, (error) => {
      console.error("Notifications error:", error);
    });

  // NEW: Load ALL notifications (read and unread) for the notification panel
  // REMOVED the showModal filter so notifications persist after reload
  // Load ALL notifications (read and unread) for the notification panel
db.collection('notifications')
    .where('menteeId', '==', user.uid)
    .orderBy('timestamp', 'desc')
    .limit(20) // Show last 20 notifications
    .onSnapshot((snapshot) => {
      const notificationList = document.getElementById("notificationList");
      if (!notificationList) return;
      
      notificationList.innerHTML = ''; // Clear existing
      
      snapshot.forEach((doc) => {
        const notif = doc.data();
        const item = document.createElement("div");
        item.className = `notification-item ${notif.read ? 'read' : ''}`;
        
        // Format timestamp
        let timeText = "Just now";
        if (notif.timestamp && notif.timestamp.toDate) {
          const date = notif.timestamp.toDate();
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / 60000);
          const diffHours = Math.floor(diffMs / 3600000);
          const diffDays = Math.floor(diffMs / 86400000);
          
          if (diffMins < 1) timeText = "Just now";
          else if (diffMins < 60) timeText = `${diffMins}m ago`;
          else if (diffHours < 24) timeText = `${diffHours}h ago`;
          else timeText = `${diffDays}d ago`;
        }
        
        // Different content based on notification type
        let bodyContent = '';
        if (notif.type === 'assignment') {
          bodyContent = `
            <div class="notification-body">
              Type: ${notif.assignmentType || 'Quiz'}<br>
              Competencies: ${notif.competencies ? notif.competencies.join(', ') : 'n/a'}<br>
              ${notif.time ? `Time: ${notif.time}<br>` : ''}
              ${notif.difficulty ? `Difficulty: ${notif.difficulty}` : ''}
            </div>
          `;
        } else {
          bodyContent = `
            <div class="notification-body">
              Assignment: ${notif.assignmentName || 'Unknown'}
              ${notif.score !== undefined ? `<br>Score: ${notif.score}/${notif.totalQuestions}` : ''}
            </div>
          `;
        }
        
        item.innerHTML = `
          <div class="notification-header">
            <strong>${notif.message || 'Notification'}</strong>
            <span class="notification-time">${timeText}</span>
          </div>
          ${bodyContent}
        `;
        
        // Add click handler based on notification type
        if (notif.type === 'assignment' && notif.assignmentId) {
          item.addEventListener("click", () => {
            // Mark as read
            if (!notif.read) {
              doc.ref.update({ read: true });
            }
            item.classList.add("read");
            
            // Fetch and show assignment details
            db.collection('assignments').doc(notif.assignmentId).get()
              .then(assignmentDoc => {
                if (assignmentDoc.exists) {
                  window.currentAssignment = assignmentDoc.data();
                  window.latestAssignmentId = notif.assignmentId;
                  openFullAssignmentModal(assignmentDoc.data());
                }
              })
              .catch(error => {
                console.error("Error fetching assignment:", error);
                alert("Could not load assignment details");
              });
          });
        } else {
          // Regular notification click handler
          item.addEventListener("click", () => {
            if (!notif.read) {
              doc.ref.update({ read: true });
            }
            item.classList.add("read");
          });
        }
        
        notificationList.appendChild(item);
      });
      
      // Update notification badge count
      const unreadCount = snapshot.docs.filter(doc => !doc.data().read).length;
      updateNotificationBadge(unreadCount);
    });
}

function updateNotificationBadge(count) {
  const notificationLink = document.querySelector('a[onclick*="toggleNotificationPanel"]');
  if (notificationLink) {
    let notificationBadge = notificationLink.querySelector('.notification-badge');
    if (!notificationBadge && count > 0) {
      notificationBadge = document.createElement('span');
      notificationBadge.className = 'notification-badge';
      notificationBadge.textContent = count;
      notificationLink.style.position = 'relative';
      notificationLink.appendChild(notificationBadge);
    } else if (notificationBadge) {
      if (count > 0) {
        notificationBadge.style.display = 'inline-flex';
        notificationBadge.textContent = count;
      } else {
        notificationBadge.style.display = 'none';
      }
    }
  }
}

// ADD this new function to mark all notifications as read:
function markAllNotificationsRead() {
  const user = auth.currentUser;
  if (!user) return;
  
  db.collection('notifications')
    .where('menteeId', '==', user.uid)
    .where('read', '==', false)
    .get()
    .then((snapshot) => {
      const batch = db.batch();
      snapshot.forEach((doc) => {
        batch.update(doc.ref, { read: true });
      });
      return batch.commit();
    })
    .then(() => {
      console.log("All notifications marked as read");
      // Hide the badge
      updateNotificationBadge(0);
    })
    .catch((error) => {
      console.error("Error marking notifications as read:", error);
    });
}

// Make the function globally available
window.markAllNotificationsRead = markAllNotificationsRead;

// Removed duplicate showCongratsModal - using the one below that uses proper modal structure


function closeCongratsModal(docId) {
  const modal = document.getElementById('congratsModal');
  if (modal) {
    modal.style.display = 'none';
  }
  document.body.style.overflow = 'auto';
  
  if (docId) {
    db.collection('assignments').doc(docId).update({
      status: "complete"
    }).catch(error => {
      console.error("Error updating assignment status:", error);
    });
  }
}

// Make it globally available
window.closeCongratsModal = closeCongratsModal;

// ... rest of your code ...

  console.log("ðŸ”¥ Firebase initialized and script loaded successfully");

  // Notification Panel Toggle
  function toggleNotificationPanel() {
    const panel = document.getElementById("notificationPanel");
    if (!panel) return;
    
    if (panel.classList.contains("active")) {
      panel.classList.remove("active");
      setTimeout(() => panel.classList.add("hidden"), 300);
    } else {
      panel.classList.remove("hidden");
      setTimeout(() => panel.classList.add("active"), 10);
      loadNotifications();
    }
  }
  window.toggleNotificationPanel = toggleNotificationPanel;
  window.updateNotificationBadge = updateNotificationBadge;

  // Load Notifications (for initial load)
  function loadNotifications() {
    setupNotifications();
  }

  // ========== ASSIGNMENT MODAL FUNCTIONS ==========
  function openFullAssignmentModal(assignment) {
    // Set the modal title
    document.getElementById('cq-assignment-title').innerText = assignment.title || "New Assignment";
    
    // Show info section, hide quiz section
    document.getElementById('cq-assignment-info').style.display = 'block';
    document.getElementById('cq-assignment-quiz').style.display = 'none';
    
    // Fill in all assignment details
    const fieldsElement = document.getElementById('cq-assignment-fields');
    if (fieldsElement) {
        if (assignment.type === "speaking" || assignment.type === "case") {
            // Speaking/Case assignment format
            const q1 = assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided";
            const q2 = assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided";
            
            fieldsElement.innerHTML = `
                <div><b>Type:</b> ${assignment.type === "speaking" ? "Speaking" : "Case"} Assignment</div>
                <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
                <div><b>Description:</b> ${assignment.description || 'n/a'}</div>
                <div><b>Questions:</b></div>
                <ul>
                    <li>${q1}</li>
                    <li>${q2}</li>
                </ul>
            `;
        } else {
            // Regular assignment format
            fieldsElement.innerHTML = `
                <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
                <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
                <div><b>Questions:</b><br> <span style="font-weight:400; color:#374151">${assignment.questions || 'n/a'}</span></div>
                <div><b>Difficulty:</b> ${assignment.difficulty || 'n/a'}</div>
                <div><b>Simulate:</b> ${assignment.simulate ? "Yes" : "No"}</div>
            `;
        }

        if (assignment.trainingPDFs && assignment.trainingPDFs.length > 0) {
            assignment.trainingPDFs.forEach(pdf => {
                const pdfBox = document.createElement('div');
                pdfBox.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; font-weight: 500;';
                pdfBox.textContent = pdf.name || 'Training Document';
                pdfBox.onclick = () => downloadPDF(pdf);
                fieldsElement.appendChild(pdfBox);
            });
        }
    }
    
    // Show the modal
    document.getElementById('cq-assignment-modal').style.display = 'block';
  }

  // Function to close assignment modal
  function closeAssignmentModal() {
    document.getElementById('cq-assignment-modal').style.display = 'none';
  }

  function snoozeAssignment() {
    closeAssignmentModal();
  }

  // ========== STATE ==========
  // Note: writtenQuestions, currentQuestionIndex, writtenAnswers, writtenTimer, writtenTimeRemaining
  // are already declared earlier in the file (around line 1138-1142)
  // Using those existing declarations

  async function acceptAssignmentNow() {
    console.log("ðŸš€ acceptAssignmentNow() called");
    showLoader();

    const assignment = window.currentAssignment;
    console.log("ðŸ“‹ Current assignment:", assignment);

    if (!assignment) {
      console.error("âŒ No current assignment found");
      hideLoader();
      return;
    }

    if (window.latestAssignmentId) {
      console.log("âœ… Marking assignment as seen");

      const updateData = {
        status: "seen",
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      if (assignment.type === 'written') {
        updateData.score = 0;
        updateData.maxScore = assignment.writtenQuestions?.length || 10;
      }

      try {
        await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
        console.log("âœ… Assignment marked as seen successfully");
      } catch (error) {
        console.error("âŒ Error marking assignment as seen:", error);
      }
    }

    // Handle assignment types
    if (assignment.type === 'case') {
      console.log("ðŸ“‹ Opening case study modal for case assignment");
      document.getElementById('cq-assignment-modal').style.display = 'none';
      hideLoader();
      
      // Store assignment questions globally for the case study modal
      window.currentAssignmentQuestions = {
        q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
        q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
        title: assignment.title || "Case Study",
        description: assignment.description || assignment.caseStudyContent || ""
      };
      
      openCaseStudyModal(assignment);
      return;
    }
    
    if (assignment.type === 'speaking') {
      console.log("ðŸŽ¤ Opening speaking modal for speaking assignment");
      document.getElementById('cq-assignment-modal').style.display = 'none';
      hideLoader();
      
      // Store assignment questions globally for the speaking modal
      window.currentAssignmentQuestions = {
        q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
        q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
        title: assignment.title || "Speaking Assignment",
        description: assignment.description || ""
      };
      
      openSpeakingAssignmentModal(assignment);
      return;
    }

    if (assignment.type === 'written') {
      console.log("âœï¸ Opening written assignment (with GPT if needed)");
      document.getElementById('cq-assignment-modal').style.display = 'none';
      await openWrittenPracticeModal(assignment); 
      return;
    }

    hideLoader();
  }

  function showLoader() {
    const loader = document.getElementById("assignmentLoader");
    if (loader) {
      loader.style.display = "flex";
    }
  }

  function hideLoader() {
    const loader = document.getElementById("assignmentLoader");
    if (loader) {
      loader.style.display = "none";
    }
  }

  async function openWrittenPracticeModal(assignment) {
    console.log("Opening written practice modal with assignment:", assignment);

    try {
      currentQuestionIndex = 0;
      writtenAnswers = {};
      if (!window.writtenAnswers) {
        window.writtenAnswers = {};
      }

      const timeInMinutes = parseInt(assignment.time) || 15;
      writtenTimeRemaining = timeInMinutes * 60;

      // Check if window.writtenQuestions exists (from "create your own" flow)
      if (window.writtenQuestions && window.writtenQuestions.length > 0) {
        console.log("âœ… Using window.writtenQuestions from create your own flow");
        writtenQuestions = window.writtenQuestions;
      } else if (assignment.writtenQuestions && assignment.writtenQuestions.length > 0) {
        // Use assignment's preloaded questions
        writtenQuestions = assignment.writtenQuestions;
        window.writtenQuestions = assignment.writtenQuestions;
      } else {
        // Generate new questions via GPT
        console.log("âš¡ No preloaded questions, generating via GPT...");
        assignment.writtenQuestions = await generatePersonalizedQuestionsWithGPT({
          time: assignment.time || "15 mins",
          difficulty: assignment.difficulty || "Medium",
          competencies: assignment.competencies || ["General"],
          type: "written"
        });
        writtenQuestions = assignment.writtenQuestions;
        window.writtenQuestions = assignment.writtenQuestions;
      }

      console.log("âœ… Written questions ready:", writtenQuestions);

      // Show modal and create stars
      const modal = document.getElementById('quizModal');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      createQuizStars();
      loadWrittenQuestion();
      startWrittenTimer();

    } catch (err) {
      console.error("âŒ Error in openWrittenPracticeModal:", err);
      alert("Could not load written practice. Please try again.");
    } finally {
      hideLoader();
      console.log("ðŸ›‘ Loader hidden inside openWrittenPracticeModal");
    }
  }

  function getQuestionCount(timeStr) {
    if (!timeStr) return 5;
    const normalized = timeStr.toString().toLowerCase();
    if (normalized.includes("15")) return 10;
    if (normalized.includes("10")) return 7;
    if (normalized.includes("5")) return 5;
    return 5;
  }

  async function generatePersonalizedQuestionsWithGPT(formData) {
    const questionCount = getQuestionCount(formData.time);
    const competenciesText = formData.competencies.join(', ');

    let prompt = `Generate ${questionCount} FBLA-style multiple choice questions.
- Difficulty: ${formData.difficulty}
- Competencies to cover: ${competenciesText}
- Each question must have exactly 4 options and 1 correct answer
- Questions must be standalone, realistic for FBLA, and never reference "the document", "the text", "as stated", etc.
- Use business, finance, marketing, management, economics, law, and related topics depending on the competencies.`

    prompt += `\n\nReturn ONLY valid JSON array in format:
[
  {
    "text": "Question text?",
    "competency": "Marketing",
    "correctAnswer": "Correct option text",
    "options": ["A", "B", "C", "D"],
    "difficulty": "${formData.difficulty}",
    "source": "gpt_generated"
  }
]`;

    try {
      // Check if functions is available
      if (!firebase.functions) {
        throw new Error("Firebase Functions SDK not loaded. Please refresh the page.");
      }
      
      const functions = firebase.functions();
      const generateQuestions = functions.httpsCallable("generateQuestionsWithAI");
      
      const response = await generateQuestions({
        messages: [
          { role: "system", content: `You are an expert FBLA written-competition exam designer.

Your role is to generate ORIGINAL, competition-accurate FBLA-style multiple-choice questions that match the structure, rigor, tone, and professional standards of official FBLA written tests.

You must follow ALL rules below.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CORE FBLA PHILOSOPHY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FBLA written tests assess professional correctness, precision, and applied business literacy.

They do NOT assess creativity, opinion, or open-ended reasoning.

Each question must test exactly ONE concept.

Questions must be concise, objective, and professionally worded.

Avoid unnecessary narrative unless the question type explicitly requires a scenario.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
APPROVED FBLA QUESTION ARCHETYPES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Every question MUST clearly belong to ONE of the following archetypes:

1. Definition / Term Identification  
   - Identifying the correct term based on a definition  
   - Selecting the correct meaning of a professional word or concept  

2. Classification / Category Recognition  
   - Determining where an item belongs within a professional category system  
   - Examples include document types, account categories, system types, business forms, or classifications  

3. Procedural / Workflow Knowledge  
   - Understanding the stages of a professional workflow specific to the competition area  
   - Identifying where information originates within that workflow  
   - Determining which document, tool, or action is appropriate at a given stage  
   - Recognizing correct sequencing of professional tasks within the domain  

4. Tool-to-Function Matching  
   - Matching software features, commands, utilities, or tools to their correct purpose  
   - Selecting the correct function used to accomplish a professional task  

5. Quantitative / Calculation Application  
   - Performing single-step or limited multi-step calculations  
   - Selecting the correct numeric result based on provided data  
   - Avoid unnecessary complexity or advanced math  

6. Language Precision & Usage  
   - Correct use of professional vocabulary  
   - Distinguishing homophones, word meanings, spelling, grammar, and standard usage  

7. Error Detection / Exception Identification  
   - Identifying what is incorrect, misspelled, or does NOT belong  
   - Using negation ("NOT") carefully and intentionally  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
QUESTION STRUCTURE RULES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Each question must assess ONE idea only.  
â€¢ Do not combine multiple concepts in one question.  
â€¢ Avoid ambiguous wording.  
â€¢ Use professional, neutral language.

Acceptable stem styles include:
- "Which of the followingâ€¦"
- "What term best describesâ€¦"
- "The document used toâ€¦"
- "Which action should be takenâ€¦"
- "Which of the following is NOTâ€¦"

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ANSWER CHOICE DESIGN (CRITICAL)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Each question MUST include exactly FOUR answer choices.

Answer choices must:
â€¢ Be the same grammatical form  
â€¢ Be similar in length  
â€¢ Belong to the same conceptual family  

Wrong answer choices (distractors) must be plausible and realistic.

Allowed distractor strategies include:
â€¢ Closely related terms within the same category  
â€¢ Common student misconceptions  
â€¢ Incorrect step within a workflow  
â€¢ Reversed or misapplied professional rules  
â€¢ Visually or linguistically similar words  
â€¢ Typical calculation or classification errors  

Never include joke answers or obviously incorrect options.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DIFFICULTY CALIBRATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Easy:
â€¢ Direct recall or recognition  
â€¢ Minimal traps  

Medium:
â€¢ Requires discrimination between similar concepts  
â€¢ Includes common misconceptions  

Hard:
â€¢ Includes negation ("NOT")  
â€¢ Requires precise rule awareness  
â€¢ Uses subtle wording differences  
â€¢ Penalizes shallow memorization  

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CONTENT INTEGRITY RULES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ All questions must be ORIGINAL.  
â€¢ Do NOT copy real FBLA questions.  
â€¢ Do NOT closely paraphrase known questions.  
â€¢ Use authentic structure only, not replicated wording.

Questions must feel realistic for competitive FBLA written events at the regional, state, or national level.

When study materials are provided, extract concepts, facts, names, dates, laws, and details from them. Present this information as established business knowledge. NEVER mention "the study guide", "the document", "the material", or use phrases like "according to", "as stated in", or "mentioned in".

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
OUTPUT REQUIREMENTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â€¢ Generate ONLY the requested number of questions.  
â€¢ Each question must have exactly four answer options.  
â€¢ Only ONE option may be correct.  
â€¢ Output valid JSON only.  
â€¢ Do not include explanations, commentary, or headings.  

You are writing as a professional exam author â€” not as a tutor or teacher.` },
          { role: "user", content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt }
        ]
      });

      const data = response.data;
      let content = data.content || data.choices?.[0]?.message?.content || data;
      
      if (typeof content !== 'string') {
        content = JSON.stringify(content);
      }
      
      content = content.trim();
      content = content.replace(/```json|```/g, "");
      const jsonStart = content.indexOf('[');
      const jsonEnd = content.lastIndexOf(']') + 1;
      
      if (jsonStart !== -1 && jsonEnd > jsonStart) {
        content = content.slice(jsonStart, jsonEnd);
      }
      
      const generated = JSON.parse(content);
      console.log(`âœ… Generated ${generated.length} GPT questions`);
      return generated;

    } catch (err) {
      console.error("âŒ GPT error:", err);
      return getFallbackQuestions(questionCount, formData.competencies);
    }
  }

  function getFallbackQuestions(count, competencies) {
    const fallbackQuestions = [
      {
        text: "What is the primary purpose of parliamentary procedure?",
        competency: "Parliamentary Procedure",
        correctAnswer: "To make meetings more efficient",
        options: [
          "To make meetings more efficient",
          "To give the president more power",
          "To eliminate debate",
          "To make meetings longer"
        ]
      },
      {
        text: "Which motion is used to end a meeting?",
        competency: "Parliamentary Procedure",
        correctAnswer: "Adjourn",
        options: ["Adjourn", "Recess", "Postpone", "Table"]
      },
      {
        text: "What is the most effective way to communicate in business?",
        competency: "Business Communication",
        correctAnswer: "Clear and concise messaging",
        options: [
          "Clear and concise messaging",
          "Using complex terminology",
          "Lengthy detailed explanations",
          "Informal casual language"
        ]
      }
    ];
    
    const result = [];
    for (let i = 0; i < count; i++) {
      result.push(fallbackQuestions[i % fallbackQuestions.length]);
    }
    return result;
  }

  function loadWrittenQuestion() {
    // Use window.writtenQuestions if available (for "create your own"), otherwise use local writtenQuestions
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    const question = questions[currentQuestionIndex];
    if (!question) {
      console.error("No question found at index", currentQuestionIndex);
      return;
    }
    
    console.log("Loading question", currentQuestionIndex + 1, ":", question.question || question.text);
    
    const assignmentTitle = window.currentAssignment?.title || 'Written Practice';
    const difficulty = window.currentAssignment?.difficulty || 'Easy';
    document.getElementById('quizTitle').textContent = `${difficulty} ${assignmentTitle}`;
    document.getElementById('quizProgress').textContent = 
      `Question ${currentQuestionIndex + 1} of ${questions.length}`;
    
    document.getElementById('questionCompetency').textContent = question.competency || 'General';
    const questionTextEl = document.getElementById('questionText');
    questionTextEl.textContent = question.question || question.text;
    questionTextEl.style.color = '#fff';
    
    const optionsContainer = document.getElementById('optionsContainer');
    const answers = window.writtenAnswers || writtenAnswers;
    const previousAnswer = answers[currentQuestionIndex];
    
    optionsContainer.innerHTML = question.options.map((option, index) => {
      const isSelected = previousAnswer === option;
      return `
        <button class="practice-quiz-option-btn ${isSelected ? 'selected' : ''}" data-option="${option}">
          <div class="practice-quiz-option-radio ${isSelected ? 'selected' : ''}">
            ${isSelected ? '<div class="practice-quiz-option-dot"></div>' : ''}
          </div>
          <span class="practice-quiz-option-text">${option}</span>
        </button>
      `;
    }).join('');
    
    const options = optionsContainer.querySelectorAll('.practice-quiz-option-btn');
    options.forEach(optionBtn => {
      optionBtn.addEventListener('click', function(e) {
        options.forEach(opt => {
          opt.classList.remove("selected");
          const radio = opt.querySelector('.practice-quiz-option-radio');
          radio.classList.remove("selected");
          radio.innerHTML = '';
        });
        
        this.classList.add('selected');
        const radio = this.querySelector('.practice-quiz-option-radio');
        radio.classList.add('selected');
        radio.innerHTML = '<div class="practice-quiz-option-dot"></div>';
        
        // Save to both window.writtenAnswers and local writtenAnswers
        if (window.writtenAnswers) {
          window.writtenAnswers[currentQuestionIndex] = this.dataset.option;
        } else {
          writtenAnswers[currentQuestionIndex] = this.dataset.option;
        }
        console.log("Answer saved:", currentQuestionIndex, "->", this.dataset.option);
      });
    });
    
    updateWrittenProgress();
    updateWrittenNavButtons();
  }

  function updateWrittenProgress() {
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
    document.getElementById('progressFill').style.width = `${progress}%`;
    document.getElementById('progressPercent').textContent = Math.round(progress);
  }

  function updateWrittenNavButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    
    prevBtn.disabled = currentQuestionIndex === 0;
    
    if (currentQuestionIndex === questions.length - 1) {
      nextBtn.style.display = 'none';
      submitBtn.style.display = 'block';
    } else {
      nextBtn.style.display = 'block';
      submitBtn.style.display = 'none';
    }
  }

  function previousQuestion() {
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    if (currentQuestionIndex > 0) {
      currentQuestionIndex--;
      loadWrittenQuestion();
    }
  }

  function nextQuestion() {
    const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
    if (currentQuestionIndex < questions.length - 1) {
      currentQuestionIndex++;
      loadWrittenQuestion();
    }
  }

  function startWrittenTimer() {
    clearInterval(writtenTimer);
    
    console.log("Starting timer with", writtenTimeRemaining, "seconds");
    updateTimerDisplay();
    
    writtenTimer = setInterval(() => {
      writtenTimeRemaining--;
      updateTimerDisplay();
      
      if (writtenTimeRemaining <= 0) {
        console.log("Time's up! Auto-submitting...");
        clearInterval(writtenTimer);
        submitWrittenPractice();
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const minutes = Math.floor(writtenTimeRemaining / 60);
    const seconds = writtenTimeRemaining % 60;
    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    const timerElement = document.getElementById('quizTimer');
    if (timerElement) {
      timerElement.textContent = timeString;
      
      if (writtenTimeRemaining <= 60) {
        timerElement.style.color = '#ef4444';
      } else if (writtenTimeRemaining <= 300) {
        timerElement.style.color = '#f97316';
      } else {
        timerElement.style.color = '#fb923c';
      }
    }
  }

  function createQuizStars() {
    const starsContainer = document.getElementById('quizStarsContainer');
    if (!starsContainer) return;
    
    starsContainer.innerHTML = '';
    
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'practice-quiz-star';
      
      const size = Math.random() * 3 + 0.5;
      const duration = Math.random() * 4 + 2;
      const delay = Math.random() * 2;
      const randomLeft = Math.random() * 100;
      const randomTop = Math.random() * 100;
      const randomOpacity = Math.random() * 0.9 + 0.3;
      
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = randomLeft + '%';
      star.style.top = randomTop + '%';
      star.style.opacity = randomOpacity;
      star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
      star.style.animationDelay = delay + 's';
      star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
      
      starsContainer.appendChild(star);
    }
  }

  function closeQuizModal() {
    const modal = document.getElementById('quizModal');
    if (modal) {
      modal.style.display = 'none';
    }
    document.body.style.overflow = 'auto';
    clearInterval(writtenTimer);
    writtenQuestions = [];
    currentQuestionIndex = 0;
    writtenAnswers = {};
    writtenTimeRemaining = 0;
    writtenTimer = null;
  }

  async function submitWrittenPractice() {
    try {
      console.log("=== SUBMITTING WRITTEN PRACTICE ===");
      clearInterval(writtenTimer);
      
      if (!window.latestAssignmentId) {
        console.error("âŒ CRITICAL ERROR: No assignment ID found!");
        alert("Error: No assignment ID found. Cannot submit written practice.");
        closeQuizModal();
        return;
      }
      
      // Use local writtenQuestions for assignment-based tests
      const questions = writtenQuestions;
      const answers = writtenAnswers;
      
      let score = 0;
      const competencyStats = {};
      const detailedAnswers = [];
      const totalQuestions = questions.length;
      
      questions.forEach((question, index) => {
        const userAnswer = answers[index];
        const correctAnswer = question.correctAnswer;
        const isCorrect = userAnswer === correctAnswer;
        
        if (isCorrect) score++;
        
        const competency = question.competency;
        if (!competencyStats[competency]) {
          competencyStats[competency] = { total: 0, correct: 0 };
        }
        competencyStats[competency].total++;
        if (isCorrect) competencyStats[competency].correct++;
        
        detailedAnswers.push({
          questionIndex: index,
          question: question.question || question.text,
          competency: competency,
          userAnswer: userAnswer || "No answer",
          correctAnswer: correctAnswer,
          isCorrect: isCorrect
        });
      });
      
      const originalTime = parseInt(window.currentAssignment?.time) * 60 || 900;
      const timeSpent = originalTime - writtenTimeRemaining;
      const percentage = Math.round((score / totalQuestions) * 100);
      
      const quizResults = {
        correct: score,
        total: totalQuestions,
        percentage: percentage,
        timeUsed: timeSpent,
        questionResults: detailedAnswers.map((ans, idx) => {
          const originalQuestion = questions[ans.questionIndex];
          return {
            question: ans.question,
            userAnswer: ans.userAnswer,
            correctAnswer: ans.correctAnswer,
            isCorrect: ans.isCorrect,
            competency: ans.competency,
            options: originalQuestion ? (originalQuestion.options || []) : []
          };
        }),
        competencyStats: competencyStats,
        quizSettings: {
          difficulty: window.currentAssignment?.difficulty || 'medium',
          time: window.currentAssignment?.time || '15',
          competencies: Object.keys(competencyStats)
        }
      };
      
      console.log("=== SAVING NEW TEST RESULT DOCUMENT ===");
      await saveQuizResultsToFirebase(quizResults);
      console.log("âœ… New test result document created");
      
      // Update original assignment document (for mentor tracking) - but DON'T set status to 'complete'
      const updateData = {
        completedAt: firebase.firestore.FieldValue.serverTimestamp(),
        score: score,
        totalQuestions: totalQuestions,
        maxScore: totalQuestions,
        competencyStats: competencyStats,
        timeSpent: timeSpent,
        detailedAnswers: detailedAnswers,
        competencies: Object.keys(competencyStats),
        correctCompetencies: Object.entries(competencyStats)
          .filter(([_, stats]) => stats.correct === stats.total)
          .map(([comp, _]) => comp),
        percentage: percentage,
        submittedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
      console.log("âœ… Assignment updated successfully");
      
      const resultsData = {
        message: `Excellent work! You scored ${score}/${totalQuestions}`,
        assignmentName: window.currentAssignment?.title || 'Written Practice',
        competencyStats: competencyStats,
        score: score,
        totalQuestions: totalQuestions,
        percentage: percentage,
        timeSpent: timeSpent
      };
      
      closeQuizModal();
      
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#3b82f6', '#1d4ed8', '#1e40af']
      });
      
      showCongratsModal(resultsData);
      
      window.latestAssignmentId = null;
      window.currentAssignment = null;
      
    } catch (error) {
      console.error("âŒ Written practice submission error:", error);
      alert("Failed to submit practice: " + error.message);
    }
  }

  function showCongratsModal(results) {
    const modal = document.getElementById('congratsModal');
    
    // Check if modal exists
    if (!modal) {
      // Fallback to alert if modal doesn't exist
      alert(results.message || `Congratulations! ${results.assignmentName || 'Assignment'} completed successfully!`);
      return;
    }
    
    // Handle case study assignments
    if (results.assignmentType === 'case') {
      const titleEl = document.getElementById('congratsTitle');
      const scoreEl = document.getElementById('congratsScore');
      const subtitleEl = document.getElementById('congratsSubtitle');
      const assignmentNameEl = document.getElementById('congratsAssignmentName');
      const competenciesContainer = document.getElementById('congratsCompetencies');
      
      if (titleEl) titleEl.textContent = 'Congratulations!';
      if (scoreEl) scoreEl.textContent = '';
      if (subtitleEl) subtitleEl.style.display = 'none'; // Hide the score line
      if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Case Study';
      
      // Display competencies from Firebase
      if (competenciesContainer) {
        if (results.competencies && results.competencies.length > 0) {
          competenciesContainer.innerHTML = results.competencies.map(comp => {
            return `
              <div class="congrats-competency-item">
                <div class="congrats-competency-header">
                  <span class="congrats-competency-name">${comp}</span>
                </div>
              </div>
            `;
          }).join('');
        } else {
          competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
        }
      }
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      createCongratsStars();
      return;
    }
    
    // Handle speaking assignments (simple message)
    if (results.assignmentType === 'speaking' || (results.message && !results.score && !results.totalQuestions)) {
      const titleEl = document.getElementById('congratsTitle');
      const scoreEl = document.getElementById('congratsScore');
      const subtitleEl = document.getElementById('congratsSubtitle');
      const assignmentNameEl = document.getElementById('congratsAssignmentName');
      const competenciesContainer = document.getElementById('congratsCompetencies');
      
      if (titleEl) titleEl.textContent = 'Congratulations!';
      if (scoreEl) scoreEl.textContent = '';
      if (subtitleEl) {
        subtitleEl.style.display = 'block';
        subtitleEl.innerHTML = results.message || 'Assignment submitted successfully!';
      }
      if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Assignment';
      
      // Display competencies if available
      if (competenciesContainer) {
        if (results.competencies && results.competencies.length > 0) {
          competenciesContainer.innerHTML = results.competencies.map(comp => {
            return `
              <div class="congrats-competency-item">
                <div class="congrats-competency-header">
                  <span class="congrats-competency-name">${comp}</span>
                </div>
              </div>
            `;
          }).join('');
        } else {
          competenciesContainer.innerHTML = '';
        }
      }
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      createCongratsStars();
      return;
    }
    
    // Handle written assignments (with scores)
    const percentage = results.percentage || (results.score && results.totalQuestions ? Math.round((results.score / results.totalQuestions) * 100) : 0);
    
    const titleEl = document.getElementById('congratsTitle');
    const scoreEl = document.getElementById('congratsScore');
    const subtitleEl = document.getElementById('congratsSubtitle');
    const assignmentNameEl = document.getElementById('congratsAssignmentName');
    const competenciesContainer = document.getElementById('congratsCompetencies');
    
    if (titleEl) titleEl.textContent = 'Congratulations!';
    if (scoreEl && results.score !== undefined && results.totalQuestions !== undefined) {
      scoreEl.textContent = `${results.score}/${results.totalQuestions}`;
    }
    if (subtitleEl) {
      subtitleEl.style.display = 'block'; // Reset display for other assignment types
      if (results.score !== undefined && results.totalQuestions !== undefined) {
        subtitleEl.innerHTML = 
          `Excellent work! You scored <span id="congratsScoreSpan" style="background: linear-gradient(to right, #ef4444, #f97316, #eab308); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; font-size: 1.75rem;">${results.score}/${results.totalQuestions}</span>`;
      } else if (results.message) {
        subtitleEl.innerHTML = results.message;
      }
    }
    
    if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Written Practice';
    
    if (competenciesContainer) {
      if (results.competencyStats && Object.keys(results.competencyStats).length > 0) {
        competenciesContainer.innerHTML = Object.entries(results.competencyStats).map(([comp, stats]) => {
          const percentage = Math.round((stats.correct / stats.total) * 100);
          const isFull = stats.correct === stats.total;
          return `
            <div class="congrats-competency-item">
              <div class="congrats-competency-header">
                <span class="congrats-competency-name">${comp}</span>
                <span class="congrats-competency-score">${stats.correct}/${stats.total} correct</span>
              </div>
              <div class="congrats-competency-progress-bar">
                <div class="congrats-competency-progress-fill ${isFull ? 'full' : ''}" style="width: ${percentage}%"></div>
              </div>
            </div>
          `;
        }).join('');
      } else {
        competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
      }
    }
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    createCongratsStars();
  }

  function createCongratsStars() {
    const starsContainer = document.getElementById('congratsStarsContainer');
    if (!starsContainer) return;
    
    starsContainer.innerHTML = '';
    
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'practice-quiz-star';
      
      const size = Math.random() * 3 + 0.5;
      const duration = Math.random() * 4 + 2;
      const delay = Math.random() * 2;
      const randomLeft = Math.random() * 100;
      const randomTop = Math.random() * 100;
      const randomOpacity = Math.random() * 0.9 + 0.3;
      
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = randomLeft + '%';
      star.style.top = randomTop + '%';
      star.style.opacity = randomOpacity;
      star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
      star.style.animationDelay = delay + 's';
      star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
      
      starsContainer.appendChild(star);
    }
  }

  function closeCongratsModal() {
    const modal = document.getElementById('congratsModal');
    if (modal) {
      modal.style.display = 'none';
    }
    document.body.style.overflow = 'auto';
  }
  window.closeCongratsModal = closeCongratsModal;

  function createCongratsStars() {
    const starsContainer = document.getElementById('congratsStarsContainer');
    if (!starsContainer) return;
    
    starsContainer.innerHTML = '';
    
    for (let i = 0; i < 200; i++) {
      const star = document.createElement('div');
      star.className = 'practice-quiz-star';
      
      const size = Math.random() * 3 + 0.5;
      const duration = Math.random() * 4 + 2;
      const delay = Math.random() * 2;
      const randomLeft = Math.random() * 100;
      const randomTop = Math.random() * 100;
      const randomOpacity = Math.random() * 0.9 + 0.3;
      
      star.style.width = size + 'px';
      star.style.height = size + 'px';
      star.style.left = randomLeft + '%';
      star.style.top = randomTop + '%';
      star.style.opacity = randomOpacity;
      star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
      star.style.animationDelay = delay + 's';
      star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
      
      starsContainer.appendChild(star);
    }
  }

  // closeCongratsModal is defined above, no need to redefine

  async function submitWrittenPracticeForCreateYourOwn() {
    try {
      console.log("=== SUBMITTING CREATE YOUR OWN WRITTEN PRACTICE ===");
      clearInterval(writtenTimer);
      
      // Use window.writtenQuestions and window.writtenAnswers for "create your own" tests
      const questions = window.writtenQuestions || writtenQuestions;
      const answers = window.writtenAnswers || writtenAnswers;
      
      if (!questions || questions.length === 0) {
        console.error("âŒ CRITICAL ERROR: No questions found!");
        alert("Error: No questions found. Cannot submit written practice.");
        closeQuizModal();
        return;
      }
      
      let score = 0;
      const competencyStats = {};
      const detailedAnswers = [];
      const totalQuestions = questions.length;
      
      questions.forEach((question, index) => {
        const userAnswer = answers[index];
        const correctAnswer = question.correctAnswer;
        const isCorrect = userAnswer === correctAnswer;
        
        if (isCorrect) score++;
        
        const competency = question.competency;
        if (!competencyStats[competency]) {
          competencyStats[competency] = { total: 0, correct: 0 };
        }
        competencyStats[competency].total++;
        if (isCorrect) competencyStats[competency].correct++;
        
        detailedAnswers.push({
          questionIndex: index,
          question: question.question || question.text,
          competency: competency,
          userAnswer: userAnswer || "No answer",
          correctAnswer: correctAnswer,
          isCorrect: isCorrect
        });
      });
      
      // Get time from form data or default
      const timeStr = document.getElementById('quizTitle')?.textContent?.match(/\d+/)?.[0] || '15';
      const originalTime = parseInt(timeStr) * 60 || 900;
      const timeSpent = originalTime - writtenTimeRemaining;
      const percentage = Math.round((score / totalQuestions) * 100);
      
      // Get difficulty from quiz title or default
      const difficulty = document.getElementById('quizTitle')?.textContent?.match(/(Easy|Medium|Hard)/i)?.[0] || 'medium';
      
      const quizResults = {
        correct: score,
        total: totalQuestions,
        percentage: percentage,
        timeUsed: timeSpent,
        questionResults: detailedAnswers.map((ans, idx) => {
          const originalQuestion = questions[ans.questionIndex];
          return {
            question: ans.question,
            userAnswer: ans.userAnswer,
            correctAnswer: ans.correctAnswer,
            isCorrect: ans.isCorrect,
            competency: ans.competency,
            options: originalQuestion ? (originalQuestion.options || []) : []
          };
        }),
        competencyStats: competencyStats,
        quizSettings: {
          difficulty: difficulty.toLowerCase(),
          time: timeStr,
          competencies: Object.keys(competencyStats)
        }
      };
      
      console.log("=== SAVING NEW TEST RESULT DOCUMENT (CREATE YOUR OWN) ===");
      await saveQuizResultsToFirebase(quizResults);
      console.log("âœ… New test result document created");
      
      const resultsData = {
        message: `Excellent work! You scored ${score}/${totalQuestions}`,
        assignmentName: 'Written Practice',
        competencyStats: competencyStats,
        score: score,
        totalQuestions: totalQuestions,
        percentage: percentage,
        timeSpent: timeSpent
      };
      
      closeQuizModal();
      
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 },
        colors: ['#3b82f6', '#1d4ed8', '#1e40af']
      });
      
      showCongratsModal(resultsData);
      
      // Clear window variables
      window.writtenQuestions = null;
      window.writtenAnswers = null;
      
    } catch (error) {
      console.error("âŒ Create your own written practice submission error:", error);
      alert("Failed to submit practice: " + error.message);
    }
  }

  // Override global nextQuestion and previousQuestion if they exist
  if (typeof window.nextQuestion === 'undefined') {
    window.nextQuestion = nextQuestion;
  }
  if (typeof window.previousQuestion === 'undefined') {
    window.previousQuestion = previousQuestion;
  }

  // All DOMContentLoaded listeners have been consolidated above
 

</script>

  <!-- Quiz Modal - Fullscreen Written Practice -->
  <div id="quizModal" style="display: none;" class="practice-quiz-fullscreen">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="quizStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Top Bar -->
    <div class="practice-quiz-topbar">
      <div class="practice-quiz-topbar-content">
        <div>
          <h1 id="quizTitle" class="practice-quiz-topbar-title">Easy Written Practice</h1>
          <p class="practice-quiz-topbar-subtitle">
            <span id="quizProgress">Question 1 of 14</span>
          </p>
        </div>
        
        <div class="practice-quiz-topbar-right">
          <div class="practice-quiz-timer-section">
            <p class="practice-quiz-timer-label">Time Remaining</p>
            <p id="quizTimer" class="practice-quiz-timer-value">14:53</p>
          </div>
          
          <button class="practice-quiz-close-btn" onclick="closeQuizModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="practice-quiz-main">
      <!-- Competency Badge -->
      <div class="practice-quiz-competency-badge">
        <span id="questionCompetency" class="practice-quiz-competency-text">Business Communication</span>
      </div>

      <!-- Question -->
      <div class="practice-quiz-question-section">
        <h2 id="questionText" class="practice-quiz-question">Loading question...</h2>
        <p class="practice-quiz-question-hint">Select the best answer from the options below</p>
      </div>

      <!-- Answer Options -->
      <div id="optionsContainer" class="practice-quiz-options">
        <!-- Options will be populated dynamically -->
      </div>

      <!-- Progress Section -->
      <div class="practice-quiz-progress-section">
        <div class="practice-quiz-progress-header">
          <p class="practice-quiz-progress-label">Overall Progress</p>
          <p class="practice-quiz-progress-value"><span id="progressPercent">0</span>/100</p>
        </div>
        <div class="practice-quiz-progress-bar">
          <div class="practice-quiz-progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="practice-quiz-actions">
        <button id="prevBtn" class="practice-quiz-prev-btn" onclick="previousQuestion()" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Previous Question
        </button>
        <button id="nextBtn" class="practice-quiz-next-btn" onclick="nextQuestion()">Next Question</button>
        <button id="submitBtn" class="practice-quiz-submit-btn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
      </div>
    </div>
  </div>

  <!-- Congratulations Modal - Fullscreen -->
  <div id="congratsModal" class="practice-quiz-fullscreen" style="display:none;">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="congratsStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Main Content - Centered -->
    <div class="practice-quiz-main" style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px);">
      <div class="congrats-content">
        <!-- Congratulations Header - Centered -->
        <div class="congrats-header">
          <h1 id="congratsTitle" class="congrats-title">Congratulations!</h1>
          <p class="congrats-subtitle" id="congratsSubtitle">
            Excellent work! You scored <span id="congratsScore">0/0</span>
          </p>
        </div>

        <!-- Assignment Info - Centered -->
        <div class="congrats-assignment-info">
          <p class="congrats-assignment-label">For completing:</p>
          <h2 id="congratsAssignmentName" class="congrats-assignment-name">Written Practice</h2>
        </div>

        <!-- Competency Breakdown - Grid Layout -->
        <div class="congrats-competencies-grid" id="congratsCompetencies">
          <!-- Competencies will be populated here -->
        </div>

        <!-- Action Button -->
        <div class="congrats-actions">
          <button class="practice-quiz-next-btn" onclick="closeCongratsModal()">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assignment Modal -->
  <div id="cq-assignment-modal" class="cq-modal" style="display: none;">
    <div class="cq-modal-content">
      <span class="cq-close" onclick="closeAssignmentModal()">&times;</span>
      <div id="cq-assignment-title" class="cq-modal-title">New Assignment</div>
      
      <!-- Assignment Info (shown first) -->
      <div id="cq-assignment-info">
        <div id="cq-assignment-fields" class="cq-modal-fields"></div>
        <div class="cq-modal-footer" style="margin-top:1.5rem; text-align:right;">
          <button class="cq-modal-btn" onclick="acceptAssignmentNow()">I'll do it now</button>
          <button class="cq-modal-btn" onclick="snoozeAssignment()">I'll do it later</button>
        </div>
      </div>
      
      <!-- Quiz Section (hidden initially) -->
      <div id="cq-assignment-quiz" style="display:none;">
        <div id="quizQuestions" class="cq-modal-fields"></div>
        <div class="cq-modal-footer">
          <button class="cq-modal-btn" id="submitQuizBtn" disabled>Submit Answers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assignment Loader - Fullscreen Blurred -->
  <div id="assignmentLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 10000; justify-content: center; align-items: center; flex-direction: column;">
    <div class="circular-progress-loader">
      <svg class="circular-progress-svg" viewBox="0 0 100 100">
        <defs>
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#f97316;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#eab308;stop-opacity:1" />
          </linearGradient>
        </defs>
        <circle class="circular-progress-bg" cx="50" cy="50" r="45"></circle>
        <circle class="circular-progress-fill" cx="50" cy="50" r="45" id="circularProgressFill"></circle>
      </svg>
      <div class="circular-progress-text" id="circularProgressText">0%</div>
    </div>
  </div>

  <style>
    .circular-progress-loader {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .circular-progress-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .circular-progress-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.2);
      stroke-width: 8;
    }

    .circular-progress-fill {
      fill: none;
      stroke: url(#progressGradient);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      transition: stroke-dashoffset 0.3s ease;
    }

    .circular-progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
    }

    .congrats-content {
      max-width: 80rem;
      margin: 0 auto;
      width: 100%;
      text-align: center;
    }

    .congrats-header {
      margin-bottom: 3rem;
    }

    .congrats-title {
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0 0 1rem 0;
      line-height: 1.2;
    }

    .congrats-subtitle {
      font-size: 1.5rem;
      color: #fff;
      margin: 0;
      font-weight: 500;
    }

    .congrats-subtitle span {
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 900;
    }

    .congrats-assignment-info {
      text-align: center;
      margin-bottom: 4rem;
    }

    .congrats-assignment-label {
      color: #94a3b8;
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
    }

    .congrats-assignment-name {
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .congrats-competencies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 4rem;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .congrats-competency-item {
      background: rgba(30, 41, 59, 0.3);
      border: 2px solid rgba(71, 85, 105, 0.5);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.2s;
      text-align: left;
    }

    .congrats-competency-item:hover {
      border-color: rgba(251, 146, 60, 0.5);
      background: rgba(251, 146, 60, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(251, 146, 60, 0.2);
    }

    .congrats-competency-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .congrats-competency-name {
      font-size: 1rem;
      font-weight: 900;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .congrats-competency-score {
      font-size: 1rem;
      font-weight: 700;
      color: #94a3b8;
    }

    .congrats-competency-progress-bar {
      width: 100%;
      height: 0.75rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 9999px;
      overflow: hidden;
      border: 1px solid rgba(71, 85, 105, 0.5);
    }

    .congrats-competency-progress-fill {
      height: 100%;
      background: linear-gradient(to right, #dc2626, #f97316);
      border-radius: 9999px;
      transition: width 0.5s;
    }

    .congrats-competency-progress-fill.full {
      background: linear-gradient(to right, #16a34a, #22c55e);
    }

    .congrats-actions {
      display: flex;
      justify-content: center;
      margin-top: 3rem;
    }
  </style>

  <script>
    // Circular progress loader
    (function() {
      let progressInterval = null;
      let currentProgress = 0;

      function updateCircularProgress(progress) {
        const fill = document.getElementById('circularProgressFill');
        const text = document.getElementById('circularProgressText');
        
        if (fill && text) {
          const circumference = 2 * Math.PI * 45;
          const offset = circumference - (progress / 100) * circumference;
          fill.style.strokeDashoffset = offset;
          text.textContent = Math.round(progress) + '%';
        }
      }

      function startCircularProgress() {
        currentProgress = 0;
        updateCircularProgress(0);
        
        progressInterval = setInterval(() => {
          currentProgress += 2;
          if (currentProgress > 95) {
            currentProgress = 95;
          }
          updateCircularProgress(currentProgress);
        }, 100);
      }

      function completeCircularProgress() {
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        updateCircularProgress(100);
      }

      function stopCircularProgress() {
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        currentProgress = 0;
      }

      const originalShowLoader = window.showLoader;
      const originalHideLoader = window.hideLoader;

      window.showLoader = function() {
        if (originalShowLoader) originalShowLoader();
        const loader = document.getElementById("assignmentLoader");
        if (loader) {
          loader.style.display = "flex";
          startCircularProgress();
        }
      };

      window.hideLoader = function() {
        completeCircularProgress();
        setTimeout(() => {
          stopCircularProgress();
          if (originalHideLoader) originalHideLoader();
        }, 300);
      };
    })();
  </script>

</body>
</html>