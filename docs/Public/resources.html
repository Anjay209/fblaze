<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resource Hub | FBLAZE</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
  authDomain: "certquest-94959.firebaseapp.com",
  projectId: "certquest-94959",
  storageBucket: "certquest-94959.firebasestorage.app",
  messagingSenderId: "323956529033",
  appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
  measurementId: "G-F5JHTGGN6K"
};
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
</script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      min-height: 100vh;
      overflow-x: hidden;
    }

    html::-webkit-scrollbar, body::-webkit-scrollbar {
      display: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      color: #fff;
      position: relative;
      background: #000;
    }

    /* Galaxy Background */
    .galaxy-background {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: #000;
      overflow: hidden;
    }

    .galaxy-gradient {
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom right, #0f172a 0%, #000 50%, rgba(88, 28, 135, 0.1) 100%);
    }

    .stars-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .star {
      position: absolute;
      border-radius: 50%;
      background: #fff;
      animation: twinkle 3s ease-in-out infinite;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.1; }
      50% { opacity: 0.8; }
    }

    /* Header - from home3.html/css */
    .blaze-header {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(15, 23, 42, 0.3);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 50;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .blaze-header-content {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
      position: relative;
    }

    .header-left {
      display: none;
    }

    .desktop-logo {
      display: block;
      position: absolute;
      left: 2rem;
    }

    .header-left .blaze-logo {
      display: none;
    }

    /* Hamburger Menu */
    .hamburger-menu {
      display: none;
      flex-direction: column;
      justify-content: space-around;
      width: 1.5rem;
      height: 1.5rem;
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 0;
      z-index: 9999;
      position: relative;
    }

    .hamburger-menu span {
      width: 1.5rem;
      height: 2px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 10px;
      transition: all 0.3s linear;
      position: relative;
      transform-origin: 1px;
    }

    .hamburger-menu.active {
      display: none;
    }

    .hamburger-menu.active span:first-child {
      transform: rotate(45deg);
    }

    .hamburger-menu.active span:nth-child(2) {
      opacity: 0;
      transform: translateX(20px);
    }

    .hamburger-menu.active span:nth-child(3) {
      transform: rotate(-45deg);
    }

    .blaze-logo {
      font-size: 1.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .blaze-nav {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex: 1;
      justify-content: center;
      margin: 0 auto;
    }

    .nav-link {
      position: relative;
      padding: 0.5rem 1rem;
      font-weight: 900;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #cbd5e1;
      transition: all 0.3s;
      overflow: visible;
      cursor: pointer;
      background: none;
      border: none;
      text-decoration: none;
    }

    .nav-link:hover {
      color: #fff;
    }

    .nav-link::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to right, rgba(239, 68, 68, 0), rgba(239, 68, 68, 0.3), rgba(239, 68, 68, 0));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .nav-link:hover::before {
      opacity: 1;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 0;
      height: 4px;
      background: linear-gradient(to right, #ef4444, #f97316);
      transition: width 0.5s;
    }

    .nav-link:hover::after {
      width: 100%;
    }

    /* Notification Badge - Red/Orange Theme */
    .notification-badge {
      background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
      color: white;
      border-radius: 50%;
      min-width: 22px;
      height: 22px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 900;
      position: absolute;
      top: -6px;
      right: -4px;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
      border: 2px solid #000;
      z-index: 10;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 900;
    }

    .mobile-nav-close {
      display: none;
    }

    /* Notification Panel - from home3.html/css */
    .notification-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: linear-gradient(to bottom, #1a0000 0%, #0a0000 100%);
      border-left: 2px solid rgba(239, 68, 68, 0.3);
      box-shadow: -4px 0 20px rgba(239, 68, 68, 0.2);
      transition: right 0.3s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .notification-panel.hidden {
      right: -400px;
    }

    .notification-panel.active {
      right: 0;
    }

    .notification-panel-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(239, 68, 68, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(to right, rgba(239, 68, 68, 0.1), rgba(249, 115, 22, 0.1));
    }

    .notification-panel-title {
      font-size: 1.25rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0;
      line-height: 1.5rem;
      display: flex;
      align-items: center;
    }

    .close-notifications {
      background: none;
      border: none;
      color: #f87171;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      width: 1.5rem;
      height: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 0.25rem;
      transition: all 0.2s;
      font-weight: 700;
      line-height: 1;
      outline: none;
    }

    .close-notifications:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .close-notifications:focus {
      outline: 2px solid rgba(239, 68, 68, 0.5);
      outline-offset: 2px;
    }

    .close-notifications:active {
      transform: scale(0.95);
    }

    .notification-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
      padding-bottom: 2rem;
      min-height: 0;
    }

    .notification-list::-webkit-scrollbar {
      width: 6px;
    }

    .notification-list::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
    }

    .notification-list::-webkit-scrollbar-thumb {
      background: rgba(239, 68, 68, 0.5);
      border-radius: 3px;
    }

    .notification-list::-webkit-scrollbar-thumb:hover {
      background: rgba(239, 68, 68, 0.7);
    }

    /* Speaking Assignment Modal Styles - from home3.html */
    .cq-speaking-modal {
      position: fixed;
      z-index: 3100;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: #020617;
      color: white;
      overflow: hidden;
      display: none;
    }
    
    .cq-speaking-modal[style*="flex"] {
      display: flex !important;
    }
    
    .cq-speaking-stars {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .cq-speaking-star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: twinkle linear infinite;
    }
    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.9; }
    }
    .cq-speaking-glow-1 {
      position: absolute;
      top: 5rem;
      left: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    .cq-speaking-glow-2 {
      position: absolute;
      bottom: 0;
      right: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    
    .cq-speaking-modal-content {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
    }
    
    .cq-speaking-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30, 41, 59, 0.3);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }
    .cq-speaking-title {
      font-size: 1.875rem;
      font-weight: 700;
      color: #f97316;
      margin: 0;
    }
    .cq-speaking-close {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: #f97316;
      color: white;
      border: none;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
    }
    .cq-speaking-close:hover {
      background: #ea580c;
    }
    
    .cq-speaking-main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 0;
    }
    
    .cq-speaking-questions {
      display: flex;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-speaking-question-card {
      flex: 1;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.5rem;
      padding: 1rem;
    }
    .cq-speaking-question-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 0.25rem;
    }
    .cq-speaking-question-text {
      font-size: 0.875rem;
      color: white;
      line-height: 1.5;
    }
    
    .cq-speaking-video-container {
      flex: 1;
      position: relative;
      border-radius: 1rem;
      overflow: hidden;
      border: 2px solid rgba(249, 115, 22, 0.3);
      background: #000;
      min-height: 0;
    }
    .cq-speaking-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cq-speaking-no-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1rem;
    }
    
    .cq-speaking-recording-indicator {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      backdrop-filter: blur(8px);
      font-size: 0.75rem;
    }
    .cq-speaking-recording-indicator.active {
      display: flex;
    }
    .cq-speaking-recording-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: #ef4444;
      border-radius: 50%;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .cq-speaking-recording-text {
      font-weight: 600;
      color: #fca5a5;
    }
    
    .cq-speaking-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-speaking-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }
    .cq-speaking-control-btn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(51, 65, 85, 0.5);
      color: #94a3b8;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1.25rem;
    }
    .cq-speaking-control-btn:hover {
      background: rgba(51, 65, 85, 0.5);
      color: #cbd5e1;
    }
    .cq-speaking-record-btn {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background: linear-gradient(to right, #f97316, #ef4444);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
      font-size: 2rem;
      font-weight: 600;
    }
    .cq-speaking-record-btn:hover {
      box-shadow: 0 0 30px rgba(249, 115, 22, 0.7);
    }
    .cq-speaking-record-btn.recording {
      background: #ef4444;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
    
    .cq-speaking-submit-btn {
      padding: 0.5rem 2.5rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.5rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1rem;
    }
    .cq-speaking-submit-btn:hover:not(:disabled) {
      background: rgba(51, 65, 85, 0.5);
    }
    .cq-speaking-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Case Study Assignment Modal Styles - from home3.html */
    .cq-case-study-modal {
      position: fixed;
      z-index: 3100;
      left: 0; top: 0; right: 0; bottom: 0;
      width: 100vw;
      height: 100vh;
      background: #020617;
      color: white;
      overflow: hidden;
      display: none;
    }
    
    .cq-case-study-modal[style*="flex"] {
      display: flex !important;
    }
    
    .cq-case-study-stars {
      position: fixed;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 0;
    }
    .cq-case-study-star {
      position: absolute;
      background: white;
      border-radius: 50%;
      animation: cq-case-study-twinkle linear infinite;
    }
    @keyframes cq-case-study-twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 0.9; }
    }
    .cq-case-study-glow-1 {
      position: absolute;
      top: 5rem;
      left: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(249, 115, 22, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    .cq-case-study-glow-2 {
      position: absolute;
      bottom: 0;
      right: 2.5rem;
      width: 18rem;
      height: 18rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }
    
    .cq-case-study-modal-content {
      position: relative;
      z-index: 10;
      width: 100%;
      height: 100%;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      overflow-y: auto;
    }
    
    .cq-case-study-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(30, 41, 59, 0.3);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      backdrop-filter: blur(8px);
      flex-shrink: 0;
    }
    .cq-case-study-title {
      font-size: 1.875rem;
      font-weight: 700;
      color: #f97316;
      margin: 0;
    }
    .cq-case-study-header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .cq-case-study-timer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(51, 65, 85, 0.5);
      backdrop-filter: blur(8px);
    }
    .cq-case-study-timer:hover {
      border-color: rgba(249, 115, 22, 0.3);
    }
    .cq-case-study-timer.active {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
    }
    .cq-case-study-timer-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: #f97316;
      transition: all 0.2s;
    }
    .cq-case-study-timer.active .cq-case-study-timer-dot {
      background: #ef4444;
      animation: cq-case-study-pulse-dot 1.5s ease-in-out infinite;
    }
    @keyframes cq-case-study-pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .cq-case-study-timer-text {
      font-size: 0.875rem;
      font-family: monospace;
      font-weight: 600;
      color: #cbd5e1;
    }
    .cq-case-study-timer.active .cq-case-study-timer-text {
      color: #fca5a5;
    }
    .cq-case-study-timer-start {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-left: 0.25rem;
    }
    .cq-case-study-timer.active .cq-case-study-timer-start {
      display: none;
    }
    .cq-case-study-close {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      background: #f97316;
      color: white;
      border: none;
      font-size: 1.5rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      line-height: 1;
      padding: 0;
    }
    .cq-case-study-close:hover {
      background: #ea580c;
    }
    
    .cq-case-study-main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      min-height: 0;
    }
    
    .cq-case-study-top-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-info-card {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.5rem;
      padding: 1rem;
      backdrop-filter: blur(8px);
    }
    .cq-case-study-info-card.cq-case-study-clickable {
      cursor: pointer;
      transition: all 0.2s;
    }
    .cq-case-study-info-card.cq-case-study-clickable:hover {
      border-color: rgba(249, 115, 22, 0.3);
    }
    .cq-case-study-info-label {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 0.25rem;
    }
    .cq-case-study-info-value {
      font-size: 0.875rem;
      font-weight: 600;
      color: white;
    }
    .cq-case-study-info-preview {
      font-size: 0.75rem;
      color: white;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      transition: color 0.2s;
    }
    .cq-case-study-clickable:hover .cq-case-study-info-preview {
      color: #fb923c;
    }
    .cq-case-study-read-more {
      font-size: 0.75rem;
      color: #fb923c;
      margin-top: 0.5rem;
    }
    
    .cq-case-study-expanded-content {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.5rem;
      padding: 1.5rem;
      backdrop-filter: blur(8px);
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .cq-case-study-expanded-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 1rem;
    }
    .cq-case-study-expanded-label {
      font-size: 0.875rem;
      color: #94a3b8;
      margin-bottom: 0.25rem;
    }
    .cq-case-study-expanded-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: white;
    }
    .cq-case-study-expanded-close {
      color: #94a3b8;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      transition: color 0.2s;
      padding: 0;
      width: 1.25rem;
      height: 1.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .cq-case-study-expanded-close:hover {
      color: #fb923c;
    }
    .cq-case-study-full-content {
      font-size: 0.875rem;
      color: white;
      line-height: 1.75;
      flex: 1;
    }
    
    .cq-case-study-video-container {
      flex: 1;
      position: relative;
      border-radius: 1rem;
      overflow: hidden;
      border: 2px solid rgba(249, 115, 22, 0.3);
      background: #000;
      min-height: 0;
    }
    .cq-case-study-video-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .cq-case-study-no-video {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 1rem;
    }
    
    .cq-case-study-recording-indicator {
      position: absolute;
      top: 1rem;
      left: 1rem;
      display: none;
      align-items: center;
      gap: 0.5rem;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid #ef4444;
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      backdrop-filter: blur(8px);
      font-size: 0.75rem;
    }
    .cq-case-study-recording-indicator.active {
      display: flex;
    }
    .cq-case-study-recording-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: #ef4444;
      border-radius: 50%;
      animation: cq-case-study-pulse-dot 1.5s ease-in-out infinite;
    }
    .cq-case-study-recording-text {
      font-weight: 600;
      color: #fca5a5;
    }
    
    .cq-case-study-bottom-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-question-card {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.5rem;
      padding: 1rem;
      backdrop-filter: blur(8px);
    }
    .cq-case-study-question-label {
      font-size: 0.75rem;
      color: #94a3b8;
      margin-bottom: 0.25rem;
    }
    .cq-case-study-question-text {
      font-size: 0.875rem;
      color: white;
      line-height: 1.5;
    }
    
    .cq-case-study-controls-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    .cq-case-study-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1.5rem;
    }
    .cq-case-study-control-btn {
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(51, 65, 85, 0.5);
      color: #94a3b8;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
    }
    .cq-case-study-control-btn:hover {
      background: rgba(51, 65, 85, 0.5);
      color: #cbd5e1;
    }
    .cq-case-study-record-btn {
      width: 4rem;
      height: 4rem;
      border-radius: 50%;
      background: linear-gradient(to right, #f97316, #ef4444);
      color: white;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
      font-size: 2rem;
      font-weight: 600;
    }
    .cq-case-study-record-btn:hover {
      box-shadow: 0 0 30px rgba(249, 115, 22, 0.7);
    }
    .cq-case-study-record-btn.recording {
      background: #ef4444;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
    }
    
    .cq-case-study-submit-btn {
      padding: 0.5rem 2.5rem;
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(51, 65, 85, 0.5);
      border-radius: 0.5rem;
      font-weight: 600;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      backdrop-filter: blur(8px);
      font-size: 1rem;
    }
    .cq-case-study-submit-btn:hover:not(:disabled) {
      background: rgba(51, 65, 85, 0.5);
    }
    .cq-case-study-submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Notification Item Styles - from home.css */
    .notification-item {
      background: linear-gradient(to right, rgba(239, 68, 68, 0.1), rgba(249, 115, 22, 0.05));
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-left: 3px solid #ef4444;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .notification-item:hover {
      background: linear-gradient(to right, rgba(239, 68, 68, 0.2), rgba(249, 115, 22, 0.1));
      border-color: rgba(239, 68, 68, 0.4);
      transform: translateX(4px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }

    .notification-item.read {
      background: rgba(0, 0, 0, 0.2);
      border-left-color: rgba(239, 68, 68, 0.3);
      opacity: 0.6;
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .notification-header strong {
      font-weight: 700;
      font-size: 0.95rem;
      color: #fca5a5;
      line-height: 1.4;
      flex: 1;
      margin-right: 12px;
    }

    .notification-time {
      font-size: 0.75rem;
      color: #f97316;
      font-weight: 600;
      background: rgba(249, 115, 22, 0.2);
      padding: 4px 8px;
      border-radius: 12px;
      white-space: nowrap;
      border: 1px solid rgba(249, 115, 22, 0.3);
    }

    .notification-body {
      font-size: 0.875rem;
      color: #cbd5e1;
      line-height: 1.5;
      margin: 0;
    }

    /* Unread indicator dot - Red/Orange */
    .notification-item:not(.read)::after {
      content: '';
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.3);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* CQ Modal Styles - Matching home3.html */
    .cq-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      justify-content: center;
      align-items: center;
      transition: background 0.3s;
    }

    .cq-modal[style*="block"] {
      display: flex !important;
    }

    .cq-modal-content {
      background: linear-gradient(to bottom right, rgba(15, 23, 42, 0.95), rgba(2, 6, 23, 0.95));
      border: 2px solid rgba(239, 68, 68, 0.5);
      border-radius: 1.5rem;
      padding: 3rem;
      max-width: 540px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      position: relative;
      backdrop-filter: blur(24px);
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    .cq-close {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      font-size: 2rem;
      color: #f87171;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0.5rem;
      line-height: 1;
      transition: color 0.2s;
      z-index: 10;
    }

    .cq-close:hover {
      color: #ef4444;
    }

    .cq-modal-title {
      font-size: 2.25rem;
      font-weight: 900;
      margin-bottom: 2rem;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      letter-spacing: 0.5px;
      position: relative;
    }

    .cq-modal-fields {
      margin-bottom: 1.25rem;
      margin-top: 0.5rem;
      color: #e2e8f0;
    }

    .cq-modal-fields b {
      color: #fff;
      font-weight: 600;
      margin-right: 4px;
    }

    .cq-modal-fields > div {
      margin-bottom: 16px;
      font-size: 16px;
      line-height: 1.5;
      color: #e2e8f0;
    }

    .cq-modal-fields > div > b {
      color: #fff;
      font-weight: 600;
      margin-right: 8px;
    }

    .cq-modal-fields ul {
      margin: 8px 0 0 20px;
      padding: 0;
    }

    .cq-modal-fields li {
      margin-bottom: 4px;
      color: #e2e8f0;
    }

    .cq-modal-footer {
      margin-top: 32px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .cq-modal-btn {
      background: linear-gradient(to right, #dc2626, #f97316);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
      margin-right: 12px;
      transition: all 0.2s;
    }

    .cq-modal-btn:hover {
      background: linear-gradient(to right, #b91c1c, #ea580c);
      transform: scale(1.05);
    }

    .cq-modal-btn:last-child {
      margin-right: 0;
    }

    /* Written Modal Styles */
    .cq-written-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cq-written-modal-content {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 680px;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      display: flex;
      flex-direction: column;
    }

    .cq-written-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cq-written-btn-primary {
      background: #4f46e5;
      color: white;
    }

    .cq-written-btn-primary:hover {
      background: #4338ca;
    }

    .cq-written-btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .cq-written-btn-secondary:hover {
      background: #d1d5db;
    }

    .cq-written-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Written Loading Modal */
    .cq-written-loading {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(8px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .gradient-balls {
      position: absolute;
      inset: 0;
      overflow: hidden;
    }

    .ball {
      position: absolute;
      border-radius: 50%;
      filter: blur(60px);
      opacity: 0.6;
      animation: float 6s ease-in-out infinite;
    }

    .ball-1 {
      width: 200px;
      height: 200px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }

    .ball-2 {
      width: 150px;
      height: 150px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      top: 60%;
      right: 10%;
      animation-delay: 2s;
    }

    .ball-3 {
      width: 180px;
      height: 180px;
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      bottom: 10%;
      left: 50%;
      animation-delay: 4s;
    }

    .ball-4 {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      top: 30%;
      right: 30%;
      animation-delay: 1s;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(30px, -30px) scale(1.1); }
      66% { transform: translate(-20px, 20px) scale(0.9); }
    }

    .cq-loading-container {
      position: relative;
      z-index: 10;
      text-align: center;
      color: white;
    }

    .cq-loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 2rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .cq-loading-text {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .cq-loading-subtext {
      font-size: 1rem;
      opacity: 0.8;
      margin-bottom: 2rem;
    }

    .cq-loading-progress {
      width: 300px;
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      margin: 0 auto;
      overflow: hidden;
    }

    .cq-loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
      animation: progress 2s ease-in-out infinite;
    }

    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    /* Quiz Styles */
    .quiz-meta {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #374151;
    }

    .quiz-question {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #f9fafb;
      border-radius: 8px;
    }

    .quiz-question h4 {
      margin-bottom: 0.75rem;
      color: #1f2937;
      font-size: 1rem;
    }

    .quiz-option {
      display: block;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .quiz-option:hover {
      background: #e5e7eb;
    }

    .quiz-option input[type="radio"] {
      margin-right: 0.5rem;
    }

    /* Main Content */
    main {
      position: relative;
      z-index: 10;
      background: transparent;
      max-width: 1280px;
      margin: 0 auto;
      padding: 3rem 2rem;
      padding-top: calc(3rem + 80px);
    }

    /* Hero Section */
    .hero {
      padding: 1.5rem 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .hero h1 {
      font-size: 4.5rem;
      font-weight: 900;
      color: white;
      margin: 0;
      line-height: 1;
    }

    .hero h2 {
      font-size: 3.75rem;
      font-weight: 900;
      color: #ff5722;
      margin: 0;
      line-height: 1;
    }

    .hero p {
      color: #999;
      font-size: 1.125rem;
      max-width: 42rem;
      text-align: center;
      margin: 1rem 0;
    }

    .drop-resource-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 1rem 2.5rem;
      border-radius: 1rem;
      font-weight: 900;
      color: white;
      background: linear-gradient(135deg, #dc2626 0%, #ea580c 50%, #f97316 100%);
      border: 2px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 14px rgba(220, 38, 38, 0.4), 0 0 0 0 rgba(220, 38, 38, 0.4);
      position: relative;
      overflow: hidden;
    }

    .drop-resource-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
      transition: left 0.5s;
    }

    .drop-resource-btn:hover::before {
      left: 100%;
    }

    .drop-resource-btn:hover {
      transform: translateY(-2px) scale(1.02);
      background: linear-gradient(135deg, #ea580c 0%, #f97316 50%, #fb923c 100%);
      box-shadow: 0 8px 24px rgba(220, 38, 38, 0.6), 0 0 0 4px rgba(220, 38, 38, 0.3);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .drop-resource-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 2px 8px rgba(255, 87, 34, 0.4);
    }

    .drop-resource-btn svg {
      width: 20px;
      height: 20px;
      stroke-width: 3;
      transition: transform 0.3s;
    }

    .drop-resource-btn:hover svg {
      transform: rotate(90deg);
    }

    /* Search & Filter Section */
    .filters-section {
      max-width: 80rem;
      margin: 0 auto;
      padding: 0.75rem 2rem;
    }

    .search-container {
      position: relative;
      margin-bottom: 0.75rem;
    }

    .search-icon {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #ff5722;
      width: 20px;
      height: 20px;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem 0.75rem 3rem;
      border-radius: 0.5rem;
      background-color: #1a1a1a;
      border: 2px solid #2a2a2a;
      color: white;
      font-size: 1rem;
    }

    .search-input:focus {
      outline: none;
      border-color: #ff5722;
    }

    .category-filters {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
      margin-bottom: 1.25rem;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.875rem;
      border: 2px solid #2a2a2a;
      background-color: #1a1a1a;
      color: #888;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .filter-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 87, 34, 0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }

    .filter-btn:hover::before {
      width: 300px;
      height: 300px;
    }

    .filter-btn:hover {
      background-color: #2a2a2a;
      border-color: #ff5722;
      color: #fff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
    }

    .filter-btn.active {
      background-color: #ff5722;
      color: #fff;
      border: none;
      box-shadow: 0 4px 12px rgba(255, 87, 34, 0.4);
    }

    .filter-btn.active:hover {
      background-color: #f97316;
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(255, 87, 34, 0.5);
    }

    .tag-section {
      margin-top: 1.5rem;
    }

    .tag-section-label {
      color: #999;
      font-size: 0.875rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .tag-filters {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .tag-btn {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
      border: 1px solid #2a2a2a;
      background-color: #1a1a1a;
      color: #888;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .tag-btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 87, 34, 0.15);
      transform: translate(-50%, -50%);
      transition: width 0.5s, height 0.5s;
    }

    .tag-btn:hover::before {
      width: 200px;
      height: 200px;
    }

    .tag-btn:hover {
      background-color: #2a2a2a;
      border-color: #ff5722;
      color: #fff;
      transform: translateY(-1px) scale(1.05);
      box-shadow: 0 2px 8px rgba(255, 87, 34, 0.25);
    }

    .tag-btn.active {
      background-color: #ff5722;
      color: #fff;
      border: none;
      box-shadow: 0 2px 8px rgba(255, 87, 34, 0.3);
    }

    .tag-btn.active:hover {
      background-color: #f97316;
      transform: translateY(-1px) scale(1.05);
      box-shadow: 0 4px 12px rgba(255, 87, 34, 0.4);
    }

    /* Resources Grid */
    .resources-section {
      max-width: 80rem;
      margin: 0 auto;
      padding: 1rem 2rem 3rem;
    }

    .resources-grid {
      display: grid;
      gap: 2rem;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    }

    .resource-card {
      border-radius: 0.75rem;
      border: 1px solid transparent;
      padding: 1.5rem;
      background-color: #0f0f0f;
      transition: all 0.2s;
      cursor: pointer;
    }

    .resource-card:hover {
      transform: scale(1.02);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
      border-color: #ff5722;
    }

    .resource-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .resource-title {
      font-size: 1.25rem;
      font-weight: 900;
      color: white;
      margin-bottom: 0.5rem;
      line-height: 1.25;
    }

    .resource-description {
      color: #999;
      font-size: 0.875rem;
    }

    .resource-tags {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .tag {
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 700;
      color: white;
      background-color: #1a1a1a;
    }

    .category-badge {
      display: inline-block;
      margin-bottom: 1rem;
    }

    .category-badge span {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 900;
      text-transform: uppercase;
      background-color: #ff5722;
      color: #fff;
    }

    .resource-meta {
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #1a1a1a;
    }

    .resource-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .action-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .like-btn {
      background-color: #1a1a1a;
      color: #888;
    }

    .like-btn.liked {
      background-color: #ff5722;
      color: #fff;
    }

    .visit-btn {
      background-color: #ff5722;
      color: #fff;
    }

    .action-btn:hover {
      opacity: 0.8;
    }

    .share-btn {
      padding: 0.5rem;
      border-radius: 0.5rem;
      background-color: #1a1a1a;
      color: #ff5722;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .share-btn:hover {
      opacity: 0.8;
    }

    .empty-state {
      text-align: center;
      padding: 5rem 0;
    }

    .empty-state p {
      color: #999;
      font-size: 1.125rem;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1rem;
    }

    .modal {
      border-radius: 0.75rem;
      border: 2px solid #1a1a1a;
      padding: 2rem;
      max-width: 28rem;
      width: 100%;
      background-color: #0f0f0f;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }

    .modal-title {
      font-size: 1.5rem;
      font-weight: 900;
      color: white;
    }

    .modal-close {
      padding: 0.5rem;
      background-color: #1a1a1a;
      color: #ff5722;
      border: none;
      cursor: pointer;
      border-radius: 0.25rem;
      transition: all 0.2s;
    }

    .modal-close:hover {
      opacity: 0.8;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      color: white;
      font-weight: 700;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      background-color: #1a1a1a;
      border: 2px solid #1a1a1a;
      color: white;
      font-size: 1rem;
    }

    .form-textarea {
      resize: none;
      min-height: 80px;
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: #ff5722;
    }

    .submit-btn {
      width: 100%;
      padding: 0.75rem;
      border-radius: 0.5rem;
      font-weight: 900;
      color: white;
      background-color: #ff5722;
      border: none;
      cursor: pointer;
      font-size: 1.125rem;
      transition: all 0.2s;
    }

    .submit-btn:hover {
      transform: scale(1.05);
    }

    .submit-btn:active {
      transform: scale(0.95);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .hero h1 {
        font-size: 3rem;
      }

      .hero h2 {
        font-size: 2.5rem;
      }

      nav {
        gap: 1rem;
        font-size: 0.75rem;
      }

      .resources-grid {
        grid-template-columns: 1fr;
      }

      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 480px) {
      .hero h1 {
        font-size: 2rem;
      }

      .hero h2 {
        font-size: 1.75rem;
      }

      .header-content,
      .filters-section,
      .resources-section {
        padding-left: 1rem;
        padding-right: 1rem;
      }
    }

    /* Practice Quiz Fullscreen Modal Styles */
    .practice-quiz-fullscreen {
      position: fixed;
      inset: 0;
      z-index: 10000;
      display: none;
      flex-direction: column;
      min-height: 100vh;
      overflow-y: auto;
      color: #fff;
    }

    .practice-quiz-fullscreen[style*="display: flex"] {
      display: flex !important;
    }

    .practice-quiz-fullscreen[style*="display: block"] {
      display: flex !important;
    }

    /* Galaxy Background */
    .practice-quiz-galaxy-bg {
      position: fixed;
      inset: 0;
      z-index: 0;
      background: #000;
      overflow: hidden;
    }

    .practice-quiz-galaxy-gradient {
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom right, #0f172a 0%, #000 50%, rgba(88, 28, 135, 0.1) 100%);
    }

    .practice-quiz-stars-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 1;
    }

    .practice-quiz-star {
      position: absolute;
      border-radius: 50%;
      background: #fff;
      pointer-events: none;
      z-index: 2;
    }

    @keyframes practice-quiz-twinkle {
      0%, 100% { opacity: 0.1; }
      50% { opacity: 0.8; }
    }

    .practice-quiz-nebula {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
    }

    .practice-quiz-nebula-1 {
      top: 0;
      left: 25%;
      width: 500px;
      height: 500px;
      background: rgba(147, 51, 234, 0.05);
    }

    .practice-quiz-nebula-2 {
      top: 33%;
      right: 0;
      width: 600px;
      height: 600px;
      background: rgba(37, 99, 235, 0.05);
    }

    .practice-quiz-nebula-3 {
      bottom: 0;
      left: 50%;
      width: 500px;
      height: 500px;
      background: rgba(6, 182, 212, 0.05);
    }

    /* Top Bar */
    .practice-quiz-topbar {
      position: sticky;
      z-index: 10001;
      border-bottom: 1px solid rgba(127, 29, 29, 0.3);
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(40px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      top: 0;
    }

    .practice-quiz-topbar-content {
      max-width: 80rem;
      margin: 0 auto;
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .practice-quiz-topbar-title {
      font-size: 1.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .practice-quiz-topbar-subtitle {
      color: #94a3b8;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    .practice-quiz-topbar-right {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .practice-quiz-timer-section {
      text-align: center;
    }

    .practice-quiz-timer-label {
      color: #94a3b8;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin: 0;
    }

    .practice-quiz-timer-value {
      color: #fb923c;
      font-size: 1.5rem;
      font-weight: 900;
      margin: 0;
    }

    .practice-quiz-close-btn {
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      border-radius: 0.5rem;
    }

    .practice-quiz-close-btn:hover {
      color: #fb923c;
      background: rgba(251, 146, 60, 0.1);
    }

    /* Main Content */
    .practice-quiz-main {
      position: relative;
      z-index: 1;
      max-width: 80rem;
      margin: 0 auto;
      padding: 3rem 2rem;
      flex: 1;
    }

    .practice-quiz-competency-badge {
      display: inline-block;
      background: rgba(220, 38, 38, 0.3);
      border: 1px solid rgba(220, 38, 38, 0.5);
      border-radius: 9999px;
      padding: 0.5rem 1rem;
      margin-bottom: 3rem;
    }

    .practice-quiz-competency-text {
      color: #fca5a5;
      font-weight: 900;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .practice-quiz-question-section {
      margin-bottom: 4rem;
    }

    .practice-quiz-question {
      font-size: 3rem;
      font-weight: 900;
      color: #fff;
      margin-bottom: 1rem;
      line-height: 1.2;
    }

    .practice-quiz-question-hint {
      color: #94a3b8;
      font-size: 1rem;
    }

    .practice-quiz-options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 4rem;
    }

    .practice-quiz-option-btn {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      padding: 1.5rem;
      border-radius: 1rem;
      border: 2px solid rgba(71, 85, 105, 0.5);
      background: rgba(30, 41, 59, 0.3);
      color: #fff;
      font-weight: 700;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      transform: scale(1);
    }

    .practice-quiz-option-btn:hover {
      transform: scale(1.02);
      border-color: rgba(251, 146, 60, 0.5);
      background: rgba(251, 146, 60, 0.1);
    }

    .practice-quiz-option-btn.selected {
      background: linear-gradient(to right, rgba(220, 38, 38, 0.4), rgba(249, 115, 22, 0.3));
      border-color: rgba(239, 68, 68, 0.7);
    }

    .practice-quiz-option-radio {
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      border: 3px solid rgba(71, 85, 105, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }

    .practice-quiz-option-btn.selected .practice-quiz-option-radio {
      border-color: #dc2626;
      background: #dc2626;
    }

    .practice-quiz-option-dot {
      width: 0.75rem;
      height: 0.75rem;
      background: #fff;
      border-radius: 50%;
    }

    .practice-quiz-option-text {
      color: #fff;
      font-weight: 700;
      font-size: 1.125rem;
    }

    .practice-quiz-progress-section {
      margin-bottom: 3rem;
    }

    .practice-quiz-progress-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .practice-quiz-progress-label {
      color: #94a3b8;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
      margin: 0;
    }

    .practice-quiz-progress-value {
      color: #94a3b8;
      font-size: 0.875rem;
      margin: 0;
    }

    .practice-quiz-progress-bar {
      width: 100%;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 9999px;
      height: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(71, 85, 105, 0.5);
    }

    .practice-quiz-progress-fill {
      background: linear-gradient(to right, #dc2626, #f97316);
      height: 100%;
      transition: width 0.5s;
      border-radius: 9999px;
    }

    .practice-quiz-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
      justify-content: space-between;
    }

    .practice-quiz-prev-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #94a3b8;
      background: none;
      border: none;
      font-weight: 900;
      cursor: pointer;
      transition: color 0.2s;
      padding: 0.5rem;
    }

    .practice-quiz-prev-btn:hover:not(:disabled) {
      color: #fff;
    }

    .practice-quiz-prev-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .practice-quiz-next-btn,
    .practice-quiz-submit-btn {
      background: linear-gradient(to right, #dc2626, #f97316);
      border: none;
      color: #fff;
      font-weight: 900;
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      transform: scale(1);
    }

    .practice-quiz-next-btn:hover,
    .practice-quiz-submit-btn:hover {
      background: linear-gradient(to right, #b91c1c, #ea580c);
      transform: scale(1.05);
    }

    /* Congratulations Modal Styles */
    .congrats-content {
      max-width: 80rem;
      margin: 0 auto;
      width: 100%;
      text-align: center;
    }

    .congrats-header {
      margin-bottom: 3rem;
    }

    .congrats-title {
      font-size: 3.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0 0 1rem 0;
      line-height: 1.2;
    }

    .congrats-subtitle {
      font-size: 1.5rem;
      color: #fff;
      margin: 0;
      font-weight: 500;
    }

    .congrats-subtitle span {
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 900;
    }

    .congrats-assignment-info {
      text-align: center;
      margin-bottom: 4rem;
    }

    .congrats-assignment-label {
      color: #94a3b8;
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 700;
    }

    .congrats-assignment-name {
      font-size: 2.5rem;
      font-weight: 900;
      background: linear-gradient(to right, #ef4444, #f97316, #eab308);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin: 0;
    }

    .congrats-competencies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      margin-bottom: 4rem;
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .congrats-competency-item {
      background: rgba(30, 41, 59, 0.3);
      border: 2px solid rgba(71, 85, 105, 0.5);
      border-radius: 1rem;
      padding: 1.5rem;
      transition: all 0.2s;
      text-align: left;
    }

    .congrats-competency-item:hover {
      border-color: rgba(251, 146, 60, 0.5);
      background: rgba(251, 146, 60, 0.1);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(251, 146, 60, 0.2);
    }

    .congrats-competency-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .congrats-competency-name {
      font-size: 1rem;
      font-weight: 900;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .congrats-competency-score {
      font-size: 1rem;
      font-weight: 700;
      color: #94a3b8;
    }

    .congrats-competency-progress-bar {
      width: 100%;
      height: 0.75rem;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 9999px;
      overflow: hidden;
      border: 1px solid rgba(71, 85, 105, 0.5);
    }

    .congrats-competency-progress-fill {
      height: 100%;
      background: linear-gradient(to right, #dc2626, #f97316);
      border-radius: 9999px;
      transition: width 0.5s;
    }

    .congrats-competency-progress-fill.full {
      background: linear-gradient(to right, #16a34a, #22c55e);
    }

    .congrats-actions {
      display: flex;
      justify-content: center;
      margin-top: 3rem;
    }

    @media (max-width: 768px) {
      .practice-quiz-question {
        font-size: 2rem;
      }
      
      .practice-quiz-topbar-content {
        padding: 1rem;
      }
      
      .practice-quiz-main {
        padding: 2rem 1rem;
      }
    }

    /* Circular Progress Loader Styles */
    .circular-progress-loader {
      position: relative;
      width: 120px;
      height: 120px;
    }

    .circular-progress-svg {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
    }

    .circular-progress-bg {
      fill: none;
      stroke: rgba(255, 255, 255, 0.2);
      stroke-width: 8;
    }

    .circular-progress-fill {
      fill: none;
      stroke: url(#progressGradient);
      stroke-width: 8;
      stroke-linecap: round;
      stroke-dasharray: 283;
      stroke-dashoffset: 283;
      transition: stroke-dashoffset 0.3s ease;
    }

    .circular-progress-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #fff;
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
    }
  </style>
<script type="module" src="/js/firebase.js"></script></head>
<body>
  <!-- Galaxy Background -->
  <div class="galaxy-background">
    <div class="galaxy-gradient"></div>
    <div class="stars-container" id="starsContainer"></div>
  </div>

  <!-- Header -->
  <div class="blaze-header">
    <div class="blaze-header-content">
      <div class="header-left">
        <button class="hamburger-menu" id="hamburgerMenu" onclick="toggleMobileNav()" aria-label="Toggle menu">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <h1 class="blaze-logo">FBLAZE</h1>
      </div>
      <h1 class="blaze-logo desktop-logo">FBLAZE</h1>
      <nav class="blaze-nav" id="mainNav">
        <button class="mobile-nav-close" onclick="toggleMobileNav()" aria-label="Close menu">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
        <a href="home3.html" class="nav-link">Home</a>
        <a href="javascript:void(0)" onclick="toggleNotificationPanel()" class="nav-link">
          Notifications
          <span id="notificationBadge" class="notification-badge" style="display: none;">0</span>
        </a>
        <a href="practice.html" class="nav-link">Practice</a>
        <a href="Forum/forum.html" class="nav-link">Forum</a>
        <a href="Calendar/calendar.html" class="nav-link">Calendar</a>
        <a href="mentor1.html" class="nav-link" id="mentorNavLink" style="display: none;">Mentor</a>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <main>
    <!-- Hero Section -->
    <section class="hero">
      <h1>Resources</h1>
      <h2>Hub</h2>
      <p>Connect, share, and dominate. Discover resources, tag them, and elevate your skills.</p>
      <button class="drop-resource-btn" id="dropResourceBtn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        DROP RESOURCE
      </button>
    </section>

    <!-- Search & Filter Section -->
    <section class="filters-section">
      <div class="search-container">
        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input type="text" class="search-input" id="searchInput" placeholder="Search resources...">
      </div>

      <!-- Category Filter -->
      <div class="category-filters" id="categoryFilters">
        <button class="filter-btn active" data-category="all">all</button>
        <button class="filter-btn" data-category="tutorial">tutorial</button>
        <button class="filter-btn" data-category="course">course</button>
        <button class="filter-btn" data-category="reference">reference</button>
        <button class="filter-btn" data-category="article">article</button>
        <button class="filter-btn" data-category="tool">tool</button>
      </div>

      <!-- Tag Filter -->
      <div class="tag-section">
        <p class="tag-section-label">FILTER BY TAG</p>
        <div class="tag-filters" id="tagFilters">
          <button class="tag-btn" data-tag="React">React</button>
          <button class="tag-btn" data-tag="JavaScript">JavaScript</button>
          <button class="tag-btn" data-tag="Frontend">Frontend</button>
          <button class="tag-btn" data-tag="Backend">Backend</button>
          <button class="tag-btn" data-tag="System Design">System Design</button>
          <button class="tag-btn" data-tag="CSS">CSS</button>
          <button class="tag-btn" data-tag="Python">Python</button>
          <button class="tag-btn" data-tag="Database">Database</button>
          <button class="tag-btn" data-tag="Architecture">Architecture</button>
          <button class="tag-btn" data-tag="Design">Design</button>
          <button class="tag-btn" data-tag="Course">Course</button>
          <button class="tag-btn" data-tag="Article">Article</button>
          <button class="tag-btn" data-tag="Tutorial">Tutorial</button>
        </div>
      </div>
    </section>

    <!-- Resources Grid -->
    <section class="resources-section">
      <div class="resources-grid" id="resourcesGrid">
        <!-- Resources will be dynamically inserted here -->
      </div>
      <div class="empty-state" id="emptyState" style="display: none;">
        <p>No resources match your filters. Try something else!</p>
      </div>
    </section>
  </main>
  </div>

  <!-- Notification Panel -->
  <div id="notificationPanel" class="notification-panel hidden">
    <div class="notification-panel-header">
      <h3 class="notification-panel-title">NOTIFICATIONS</h3>
      <button onclick="toggleNotificationPanel()" class="close-notifications"></button>
    </div>
    <div id="notificationList" class="notification-list"></div>
  </div>

  <!-- Assignment Modal -->
  <div id="cq-assignment-modal" class="cq-modal">
    <div class="cq-modal-content">
      <span class="cq-close" onclick="closeAssignmentModal()">&times;</span>
      <div id="cq-assignment-title" class="cq-modal-title">New Assignment</div>
      
      <!-- Assignment Info (shown first) -->
      <div id="cq-assignment-info">
        <div id="cq-assignment-fields" class="cq-modal-fields"></div>
        <div class="cq-modal-footer" style="margin-top:1.5rem; text-align:right;">
          <button class="cq-modal-btn" onclick="acceptAssignmentNow()">I'll do it now</button>
          <button class="cq-modal-btn" onclick="snoozeAssignment()">I'll do it later</button>
        </div>
      </div>
      
      <!-- Quiz Section (hidden initially) -->
      <div id="cq-assignment-quiz" style="display:none;">
        <div class="quiz-meta">
          <span id="quizDifficulty">Difficulty: Medium</span>
          <span id="quizTime">Time: 10 mins</span>
          <span id="quizScore" style="margin-left: auto; font-weight: 600;">Score: 0/5</span>
        </div>
        <div id="quizQuestions" class="cq-modal-fields"></div>
        <div class="cq-modal-footer">
          <button class="cq-modal-btn" id="submitQuizBtn" disabled>Submit Answers</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assignment Loader - Fullscreen Blurred -->
  <div id="assignmentLoader" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); z-index: 10000; justify-content: center; align-items: center; flex-direction: column;">
    <div class="circular-progress-loader">
      <svg class="circular-progress-svg" viewBox="0 0 100 100">
        <defs>
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
            <stop offset="50%" style="stop-color:#f97316;stop-opacity:1" />
            <stop offset="100%" style="stop-color:#eab308;stop-opacity:1" />
          </linearGradient>
        </defs>
        <circle class="circular-progress-bg" cx="50" cy="50" r="45"></circle>
        <circle class="circular-progress-fill" cx="50" cy="50" r="45" id="circularProgressFill"></circle>
      </svg>
      <div class="circular-progress-text" id="circularProgressText">0%</div>
    </div>
  </div>

  <!-- Written Practice Modal -->
  <div id="cq-written-modal" class="cq-written-modal" style="display:none;">
    <div class="cq-written-modal-content">
      <div style="padding: 1.5rem; border-bottom: 1px solid #eee;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2 style="margin: 0; font-size: 1.5rem; font-weight: 700; color: #1f2937;">Written Practice</h2>
          <button onclick="closeWrittenPracticeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #9ca3af;">&times;</button>
        </div>
        <div id="cq-written-progress" style="height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden;">
          <div id="cq-written-progress-fill" style="height: 100%; background: #4f46e5; width: 0%; transition: width 0.3s;"></div>
        </div>
        <div id="cq-written-question-count" style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">Question 1 of 10</div>
      </div>
      <div style="padding: 1.5rem; flex: 1; overflow-y: auto;">
        <div id="cq-written-competency" style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;"></div>
        <h3 class="cq-written-question" id="cq-written-question" style="font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 1.5rem;"></h3>
        <div id="cq-written-options" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
      </div>
      <div style="padding: 1.5rem; border-top: 1px solid #eee; display: flex; justify-content: space-between;">
        <button class="cq-written-btn cq-written-btn-secondary" id="cq-written-prev" onclick="previousQuestion()" disabled>Previous</button>
        <button class="cq-written-btn cq-written-btn-primary" id="cq-written-next" onclick="nextQuestion()">Next</button>
        <button class="cq-written-btn cq-written-btn-primary" id="cq-written-submit" onclick="submitWrittenPractice()" style="display: none;">Submit</button>
      </div>
    </div>
  </div>

  <!-- Congratulations Modal -->
  <!-- Congratulations Modal - Fullscreen -->
  <div id="congratsModal" class="practice-quiz-fullscreen" style="display:none;">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="congratsStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Main Content - Centered -->
    <div class="practice-quiz-main" style="display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 80px);">
      <div class="congrats-content">
        <!-- Congratulations Header - Centered -->
        <div class="congrats-header">
          <h1 id="congratsTitle" class="congrats-title">Congratulations!</h1>
          <p class="congrats-subtitle" id="congratsSubtitle">
            Excellent work! You scored <span id="congratsScore">0/0</span>
          </p>
        </div>

        <!-- Assignment Info - Centered -->
        <div class="congrats-assignment-info">
          <p class="congrats-assignment-label">For completing:</p>
          <h2 id="congratsAssignmentName" class="congrats-assignment-name">Written Practice</h2>
        </div>

        <!-- Competency Breakdown - Grid Layout -->
        <div class="congrats-competencies-grid" id="congratsCompetencies">
          <!-- Competencies will be populated here -->
        </div>

        <!-- Action Button -->
        <div class="congrats-actions">
          <button class="practice-quiz-next-btn" onclick="closeCongratsModal()">Got it!</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Speaking Assignment Modal -->
  <div id="cq-speaking-modal" class="cq-speaking-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-speaking-stars" id="cq-speaking-stars"></div>
    <div class="cq-speaking-glow-1"></div>
    <div class="cq-speaking-glow-2"></div>
    
    <div class="cq-speaking-modal-content">
      <!-- Header -->
      <div class="cq-speaking-header">
        <h1 class="cq-speaking-title" id="cq-speaking-title">Speaking Assessment</h1>
        <button class="cq-speaking-close" onclick="closeSpeakingAssignmentModal()"></button>
      </div>
      
      <!-- Main Container -->
      <div class="cq-speaking-main-container">
        <!-- Questions Row -->
        <div class="cq-speaking-questions">
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 1:</h2>
            <p id="cq-speaking-q1" class="cq-speaking-question-text">What is your strategy for this scenario?</p>
          </div>
          <div class="cq-speaking-question-card">
            <h2 class="cq-speaking-question-label">Question 2:</h2>
            <p id="cq-speaking-q2" class="cq-speaking-question-text">How would you handle unexpected challenges?</p>
          </div>
        </div>
        
        <!-- Video Feed -->
        <div class="cq-speaking-video-container">
          <video id="cq-speaking-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-speaking-noVideoView" class="cq-speaking-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-speaking-recordingIndicator" class="cq-speaking-recording-indicator">
            <div class="cq-speaking-recording-dot"></div>
            <span class="cq-speaking-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Controls -->
        <div class="cq-speaking-controls-wrapper">
          <div class="cq-speaking-controls">
            <button id="cq-speaking-documentBtn" class="cq-speaking-control-btn" title="Document">
              
            </button>
            <button id="cq-speaking-recordBtn" class="cq-speaking-record-btn" onclick="toggleSpeakingRecording()">
              
            </button>
            <button id="cq-speaking-micBtn" class="cq-speaking-control-btn" title="Settings">
              
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-speaking-submitBtn" class="cq-speaking-submit-btn" style="display:none;" onclick="submitSpeakingResponse()">Submit Assessment</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-speaking-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-speaking-audioBtn" style="display:none;"></button>
      <button id="cq-speaking-videoBtn" style="display:none;"></button>
      <button id="cq-speaking-stopBtn" style="display:none;"></button>
      <button id="cq-speaking-downloadBtn" style="display:none;"></button>
    </div>
  </div>

  <!-- Case Study Assignment Modal -->
  <div id="cq-case-study-modal" class="cq-case-study-modal" style="display:none;">
    <!-- Star Field Background -->
    <div class="cq-case-study-stars" id="cq-case-study-stars"></div>
    <div class="cq-case-study-glow-1"></div>
    <div class="cq-case-study-glow-2"></div>
    
    <div class="cq-case-study-modal-content">
      <!-- Header -->
      <div class="cq-case-study-header">
        <h1 class="cq-case-study-title" id="cq-case-study-title">Case Study</h1>
        <div class="cq-case-study-header-right">
          <!-- Timer -->
          <div id="cq-case-study-timer" class="cq-case-study-timer" onclick="toggleCaseStudyTimer()">
            <div id="cq-case-study-timer-dot" class="cq-case-study-timer-dot"></div>
            <span id="cq-case-study-timer-text" class="cq-case-study-timer-text">20:00</span>
            <span id="cq-case-study-timer-start" class="cq-case-study-timer-start">Start</span>
          </div>
          <button class="cq-case-study-close" onclick="closeCaseStudyModal()"></button>
        </div>
      </div>
      
      <!-- Main Container -->
      <div class="cq-case-study-main-container">
        <!-- Top Info Section (when content collapsed) -->
        <div id="cq-case-study-top-info" class="cq-case-study-top-info">
          <div class="cq-case-study-info-card">
            <p class="cq-case-study-info-label">Case Name</p>
            <p id="cq-case-study-name" class="cq-case-study-info-value">Market Expansion Strategy</p>
          </div>
          <div id="cq-case-study-content-preview" class="cq-case-study-info-card cq-case-study-clickable" onclick="expandCaseStudyContent()">
            <p class="cq-case-study-info-label">Case Study Content</p>
            <p id="cq-case-study-content-preview-text" class="cq-case-study-info-preview">Loading...</p>
            <p class="cq-case-study-read-more">Read More </p>
          </div>
        </div>
        
        <!-- Expanded Content (when content expanded) -->
        <div id="cq-case-study-expanded-content" class="cq-case-study-expanded-content" style="display:none;">
          <div class="cq-case-study-expanded-header">
            <div>
              <p class="cq-case-study-expanded-label">Case Study Content</p>
              <h3 id="cq-case-study-expanded-title" class="cq-case-study-expanded-title">Market Expansion Strategy</h3>
            </div>
            <button class="cq-case-study-expanded-close" onclick="collapseCaseStudyContent()"></button>
          </div>
          <p id="cq-case-study-full-content" class="cq-case-study-full-content">Loading...</p>
        </div>
        
        <!-- Video Feed (hidden when content expanded) -->
        <div id="cq-case-study-video-container" class="cq-case-study-video-container">
          <video id="cq-case-study-videoPreview" autoplay playsInline muted style="width:100%; height:100%; object-fit:cover; background:#000; display:none;"></video>
          <div id="cq-case-study-noVideoView" class="cq-case-study-no-video" style="width:100%; height:100%; background:#000; display:flex; align-items:center; justify-content:center; color:#94a3b8; position:absolute; top:0; left:0;">
            <span>No video preview</span>
          </div>
          
          <!-- Recording Indicator -->
          <div id="cq-case-study-recordingIndicator" class="cq-case-study-recording-indicator">
            <div class="cq-case-study-recording-dot"></div>
            <span class="cq-case-study-recording-text">Recording</span>
          </div>
        </div>
        
        <!-- Bottom Info Section (hidden when content expanded) -->
        <div id="cq-case-study-bottom-info" class="cq-case-study-bottom-info">
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 1</p>
            <p id="cq-case-study-q1" class="cq-case-study-question-text">What are the key market opportunities and challenges?</p>
          </div>
          <div class="cq-case-study-question-card">
            <p class="cq-case-study-question-label">Question 2</p>
            <p id="cq-case-study-q2" class="cq-case-study-question-text">How would you develop a comprehensive expansion strategy?</p>
          </div>
        </div>
        
        <!-- Controls (hidden when content expanded) -->
        <div id="cq-case-study-controls-wrapper" class="cq-case-study-controls-wrapper">
          <div class="cq-case-study-controls">
            <button id="cq-case-study-recordBtn" class="cq-case-study-record-btn" onclick="toggleCaseStudyRecording()">
              
            </button>
            <button id="cq-case-study-downloadBtn" class="cq-case-study-control-btn" title="Download" style="display:none;">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="7" y="7" width="10" height="10" rx="2.5" fill="#60a5fa"/>
                <path d="M12 9.5v4.5m0 0l-2.5-2.5m2.5 2.5l2.5-2.5" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
          </div>
          
          <!-- Submit button - shown after recording -->
          <button id="cq-case-study-submitBtn" class="cq-case-study-submit-btn" style="display:none;" onclick="submitCaseStudyResponse()">Submit Case Study</button>
        </div>
      </div>
      
      <!-- Audio playback (hidden by default) -->
      <audio id="cq-case-study-audioPlayback" style="display:none;"></audio>
      
      <!-- Hidden buttons for functionality (kept for JavaScript) -->
      <button id="cq-case-study-audioBtn" style="display:none;"></button>
      <button id="cq-case-study-videoBtn" style="display:none;"></button>
      <button id="cq-case-study-stopBtn" style="display:none;"></button>
    </div>
  </div>

  <!-- Written Practice Quiz Modal - Fullscreen -->
  <div id="quizModal" style="display: none;" class="practice-quiz-fullscreen">
    <!-- Galaxy Background -->
    <div class="practice-quiz-galaxy-bg">
      <div class="practice-quiz-galaxy-gradient"></div>
      <div class="practice-quiz-stars-container" id="quizStarsContainer"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-1"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-2"></div>
      <div class="practice-quiz-nebula practice-quiz-nebula-3"></div>
    </div>

    <!-- Top Bar -->
    <div class="practice-quiz-topbar">
      <div class="practice-quiz-topbar-content">
        <div>
          <h1 id="quizTitle" class="practice-quiz-topbar-title">Easy Written Practice</h1>
          <p class="practice-quiz-topbar-subtitle">
            <span id="quizProgress">Question 1 of 14</span>
          </p>
        </div>
        
        <div class="practice-quiz-topbar-right">
          <div class="practice-quiz-timer-section">
            <p class="practice-quiz-timer-label">Time Remaining</p>
            <p id="quizTimer" class="practice-quiz-timer-value">14:53</p>
          </div>
          
          <button class="practice-quiz-close-btn" onclick="closeQuizModal()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="practice-quiz-main">
      <!-- Competency Badge -->
      <div class="practice-quiz-competency-badge">
        <span id="questionCompetency" class="practice-quiz-competency-text">Business Communication</span>
      </div>

      <!-- Question -->
      <div class="practice-quiz-question-section">
        <h2 id="questionText" class="practice-quiz-question">Loading question...</h2>
        <p class="practice-quiz-question-hint">Select the best answer from the options below</p>
      </div>

      <!-- Answer Options -->
      <div id="optionsContainer" class="practice-quiz-options">
        <!-- Options will be populated dynamically -->
      </div>

      <!-- Progress Section -->
      <div class="practice-quiz-progress-section">
        <div class="practice-quiz-progress-header">
          <p class="practice-quiz-progress-label">Overall Progress</p>
          <p class="practice-quiz-progress-value"><span id="progressPercent">0</span>/100</p>
        </div>
        <div class="practice-quiz-progress-bar">
          <div class="practice-quiz-progress-fill" id="progressFill"></div>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="practice-quiz-actions">
        <button id="quizPrevBtn" class="practice-quiz-prev-btn" onclick="previousQuestion()" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          Previous Question
        </button>
        <button id="quizNextBtn" class="practice-quiz-next-btn" onclick="nextQuestion()">Next Question</button>
        <button id="quizSubmitBtn" class="practice-quiz-submit-btn" onclick="submitWrittenPractice()" style="display: none;">Submit Quiz</button>
      </div>
    </div>
  </div>

  <!-- Written Loading Modal -->
  <div id="cq-written-loading" class="cq-written-loading" style="display:none;">
    <div class="gradient-balls">
      <div class="ball ball-1"></div>
      <div class="ball ball-2"></div>
      <div class="ball ball-3"></div>
      <div class="ball ball-4"></div>
    </div>
    <div class="cq-loading-container">
      <div class="cq-loading-spinner"></div>
      <div class="cq-loading-text">Loading Assignment!</div>
      <div class="cq-loading-subtext">Analyzing your competencies and creating personalized content...</div>
      <div class="cq-loading-progress">
        <div class="cq-loading-progress-bar" id="cq-loading-progress-bar"></div>
      </div>
    </div>
  </div>

  <!-- Resource Modal -->
  <div class="modal-overlay" id="modalOverlay" style="display: none;">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">DROP A RESOURCE</h2>
        <button class="modal-close" id="modalClose">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <form class="modal-form" id="resourceForm">
        <div class="form-group">
          <label class="form-label">TITLE</label>
          <input type="text" class="form-input" id="formTitle" placeholder="Resource title" required>
        </div>

        <div class="form-group">
          <label class="form-label">DESCRIPTION</label>
          <textarea class="form-textarea" id="formDescription" placeholder="What's this resource about?" rows="3"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">URL</label>
          <input type="url" class="form-input" id="formUrl" placeholder="https://example.com" required>
        </div>

        <div class="form-group">
          <label class="form-label">TAGS (comma-separated)</label>
          <input type="text" class="form-input" id="formTags" placeholder="React, JavaScript, Frontend">
        </div>

        <div class="form-group">
          <label class="form-label">CATEGORY</label>
          <select class="form-select" id="formCategory">
            <option value="tutorial">Tutorial</option>
            <option value="course">Course</option>
            <option value="reference">Reference</option>
            <option value="article">Article</option>
            <option value="tool">Tool</option>
          </select>
        </div>

        <button type="submit" class="submit-btn">SUBMIT RESOURCE</button>
      </form>
    </div>
  </div>

  <script>
    // Initial resources data
    let resources = [
      {
        id: 1,
        title: 'Advanced React Patterns',
        description: 'Comprehensive guide to React hooks, compound components, and performance optimization',
        url: 'https://example.com/react-patterns',
        tags: ['React', 'JavaScript', 'Frontend'],
        category: 'tutorial',
        savedBy: 234,
        addedBy: 'User #412',
        timestamp: '2d ago',
        liked: false
      },
      {
        id: 2,
        title: 'System Design Masterclass',
        description: 'Learn how to design scalable systems at scale. Covers databases, caching, and architecture',
        url: 'https://example.com/system-design',
        tags: ['System Design', 'Backend', 'Architecture'],
        category: 'course',
        savedBy: 567,
        addedBy: 'User #891',
        timestamp: '5d ago',
        liked: false
      },
      {
        id: 3,
        title: 'CSS Grid Layout Cheat Sheet',
        description: 'Quick reference for CSS Grid properties and layouts',
        url: 'https://example.com/css-grid',
        tags: ['CSS', 'Frontend', 'Design'],
        category: 'reference',
        savedBy: 123,
        addedBy: 'User #567',
        timestamp: '1w ago',
        liked: false
      }
    ];

    // State
    let searchQuery = '';
    let selectedTags = [];
    let selectedCategory = 'all';

    // Galaxy Background - Create Stars
    function createStars() {
      const starsContainer = document.getElementById('starsContainer');
      if (!starsContainer) return;
      
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.9 + 0.3;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `twinkle ${duration}s ease-in-out infinite`;
        star.style.animationDelay = delay + 's';
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
        
        starsContainer.appendChild(star);
      }
    }

    // Render resources
    function renderResources() {
      const grid = document.getElementById('resourcesGrid');
      const emptyState = document.getElementById('emptyState');
      
      const filtered = resources.filter(resource => {
        const matchesSearch = resource.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
          resource.description.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesTags = selectedTags.length === 0 || selectedTags.some(tag => resource.tags.includes(tag));
        const matchesCategory = selectedCategory === 'all' || resource.category === selectedCategory;
        return matchesSearch && matchesTags && matchesCategory;
      });

      if (filtered.length === 0) {
        grid.style.display = 'none';
        emptyState.style.display = 'block';
        return;
      }

      grid.style.display = 'grid';
      emptyState.style.display = 'none';
      grid.innerHTML = filtered.map(resource => `
        <div class="resource-card">
          <div class="resource-header">
            <div style="flex: 1;">
              <h3 class="resource-title">${resource.title}</h3>
              <p class="resource-description">${resource.description}</p>
            </div>
          </div>

          <div class="resource-tags">
            ${resource.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
          </div>

          <div class="category-badge">
            <span>${resource.category}</span>
          </div>

          <div class="resource-meta">
            <p>Added by ${resource.addedBy}  ${resource.timestamp}</p>
          </div>

          <div class="resource-actions">
            <div class="action-buttons">
              <button class="action-btn like-btn ${resource.liked ? 'liked' : ''}" onclick="toggleLike(${resource.id})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="${resource.liked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                  <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                ${resource.savedBy}
              </button>
              <button class="action-btn visit-btn" onclick="window.open('${resource.url}', '_blank')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
                VISIT
              </button>
            </div>
            <button class="share-btn" onclick="shareResource(${resource.id})">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
              </svg>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Toggle like
    function toggleLike(id) {
      const resource = resources.find(r => r.id === id);
      if (resource) {
        resource.liked = !resource.liked;
        resource.savedBy += resource.liked ? 1 : -1;
        renderResources();
      }
    }

    // Share resource
    function shareResource(id) {
      const resource = resources.find(r => r.id === id);
      if (resource && navigator.share) {
        navigator.share({
          title: resource.title,
          text: resource.description,
          url: resource.url
        });
      }
    }

    // Modal handlers
    document.getElementById('dropResourceBtn').addEventListener('click', () => {
      document.getElementById('modalOverlay').style.display = 'flex';
    });

    document.getElementById('modalClose').addEventListener('click', () => {
      document.getElementById('modalOverlay').style.display = 'none';
    });

    document.getElementById('modalOverlay').addEventListener('click', (e) => {
      if (e.target.id === 'modalOverlay') {
        document.getElementById('modalOverlay').style.display = 'none';
      }
    });

    // Form submission
    document.getElementById('resourceForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const title = document.getElementById('formTitle').value;
      const description = document.getElementById('formDescription').value;
      const url = document.getElementById('formUrl').value;
      const tags = document.getElementById('formTags').value.split(',').map(t => t.trim()).filter(t => t);
      const category = document.getElementById('formCategory').value;

      if (title && url) {
        const newResource = {
          id: Math.max(...resources.map(r => r.id), 0) + 1,
          title,
          description,
          url,
          tags,
          category,
          savedBy: 0,
          addedBy: 'You',
          timestamp: 'just now',
          liked: false
        };
        resources.unshift(newResource);
        renderResources();
        document.getElementById('resourceForm').reset();
        document.getElementById('modalOverlay').style.display = 'none';
      }
    });

    // Search
    document.getElementById('searchInput').addEventListener('input', (e) => {
      searchQuery = e.target.value;
      renderResources();
    });

    // Category filter
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        selectedCategory = btn.dataset.category;
        renderResources();
      });
    });

    // Tag filter
    document.querySelectorAll('.tag-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tag = btn.dataset.tag;
        if (selectedTags.includes(tag)) {
          selectedTags = selectedTags.filter(t => t !== tag);
          btn.classList.remove('active');
        } else {
          selectedTags.push(tag);
          btn.classList.add('active');
        }
        renderResources();
      });
    });

    // Initialize
    createStars();
    renderResources();

    // ============ FIREBASE INITIALIZATION ============

    const db = firebase.firestore();
    const auth = firebase.auth();

    // ============ GLOBAL VARIABLES ============
    let writtenQuestions = [];
    let currentQuestionIndex = 0;
    let writtenAnswers = {};
    let writtenTimeRemaining = 0;
    let writtenTimer = null;
    window.latestAssignmentId = null;
    window.currentAssignment = null;
    window.currentAssignmentQuestions = null;

    // Speaking recording variables
    let cqSpeakingMediaRecorder = null;
    let cqSpeakingMediaStream = null;
    let cqSpeakingRecordedChunks = [];
    let isRecording = false;
    let isIntentionallyStopping = false;
    let recordingStateMonitor = null;

    // Case study recording variables
    let cqCaseStudyIsRecording = false;
    let cqCaseStudyIsIntentionallyStopping = false;
    let cqCaseStudyRecordingStateMonitor = null;
    let cqCaseStudyMediaRecorder = null;
    let cqCaseStudyMediaStream = null;
    let cqCaseStudyRecordedChunks = [];
    let cqCaseStudyTimerInterval = null;
    let cqCaseStudyTimeLeft = 1200; // 20 minutes in seconds
    let cqCaseStudyTimerActive = false;

    // ============ MEILISEARCH INTEGRATION ============
    const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
    const index = client.index('content');
    const searchBox = document.getElementById('navbarSearch');
    const searchDropdown = document.getElementById('searchDropdown');
    const searchIcon = document.getElementById('navbarSearchIcon');

    if (searchBox && searchDropdown) {
      searchBox.addEventListener('input', async function(e) {
        const query = e.target.value.trim();
        if (!query) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
          return;
        }
        try {
          const result = await index.search(query, { limit: 5 });
          if (!result.hits.length) {
            searchDropdown.style.display = 'none';
            searchDropdown.innerHTML = '';
            return;
          }
          searchDropdown.style.display = 'block';
          searchDropdown.innerHTML = result.hits.map(doc => `
            <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
              <b>${doc.title}</b><br>
              <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
            </div>
          `).join('');
        } catch (err) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
        }
      });

      searchDropdown.addEventListener('click', function(e) {
        const target = e.target.closest('.dropdown-result');
        if (target && target.dataset.url) {
          window.location = target.dataset.url;
        }
      });

      searchBox.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && searchDropdown.innerHTML) {
          const first = searchDropdown.querySelector('.dropdown-result');
          if (first && first.dataset.url) {
            window.location = first.dataset.url;
          }
        }
      });

      document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.style.display = 'none';
        }
      });

      if (searchIcon) {
        searchIcon.addEventListener('click', () => {
          searchBox.dispatchEvent(new Event('input'));
        });
      }
    }

    // ============ NOTIFICATION FUNCTIONS ============
    function toggleNotificationPanel() {
      const panel = document.getElementById("notificationPanel");
      if (!panel) return;
      
      if (panel.classList.contains("active")) {
        panel.classList.remove("active");
        setTimeout(() => panel.classList.add("hidden"), 300);
      } else {
        panel.classList.remove("hidden");
        setTimeout(() => panel.classList.add("active"), 10);
        loadNotifications();
      }
    }
    window.toggleNotificationPanel = toggleNotificationPanel;

    function loadNotifications() {
      setupNotifications();
    }

    function setupNotifications() {
      const user = auth.currentUser;
      if (!user) {
        console.log("No user logged in");
        return;
      }

      console.log("Setting up notifications for user:", user.uid);

      db.collection('notifications')
        .where('menteeId', '==', user.uid)
        .where('showModal', '==', true)
        .where('read', '==', false)
        .orderBy('timestamp', 'desc')
        .onSnapshot((snapshot) => {
          console.log("Received notifications snapshot with", snapshot.size, "items");
          
          snapshot.docChanges().forEach((change) => {
            if (change.type === "added") {
              console.log("New notification received:", change.doc.data());
              showCongratsModal(change.doc.data());
              
              setTimeout(() => {
                change.doc.ref.update({
                  showModal: false
                });
              }, 1000);
            }
          });
        }, (error) => {
          console.error("Notifications error:", error);
        });

      // Load ALL notifications for the notification panel
      db.collection('notifications')
        .where('menteeId', '==', user.uid)
        .orderBy('timestamp', 'desc')
        .limit(20)
        .onSnapshot((snapshot) => {
          const notificationList = document.getElementById("notificationList");
          if (!notificationList) return;
          
          notificationList.innerHTML = '';
          
          snapshot.forEach((doc) => {
            const notif = doc.data();
            const item = document.createElement("div");
            item.className = `notification-item ${notif.read ? 'read' : ''}`;
            
            let timeText = "Just now";
            if (notif.timestamp && notif.timestamp.toDate) {
              const date = notif.timestamp.toDate();
              const now = new Date();
              const diffMs = now - date;
              const diffMins = Math.floor(diffMs / 60000);
              const diffHours = Math.floor(diffMs / 3600000);
              const diffDays = Math.floor(diffMs / 86400000);
              
              if (diffMins < 1) timeText = "Just now";
              else if (diffMins < 60) timeText = `${diffMins}m ago`;
              else if (diffHours < 24) timeText = `${diffHours}h ago`;
              else timeText = `${diffDays}d ago`;
            }
            
            let bodyContent = '';
            if (notif.type === 'assignment') {
              bodyContent = `
                <div class="notification-body">
                  Type: ${notif.assignmentType || 'Quiz'}<br>
                  Competencies: ${notif.competencies ? notif.competencies.join(', ') : 'n/a'}<br>
                  ${notif.time ? `Time: ${notif.time}<br>` : ''}
                  ${notif.difficulty ? `Difficulty: ${notif.difficulty}` : ''}
                </div>
              `;
            } else {
              bodyContent = `
                <div class="notification-body">
                  ${notif.assignmentName ? `Assignment: ${notif.assignmentName}` : (notif.message || 'Notification')}
                  ${notif.score !== undefined ? `<br>Score: ${notif.score}/${notif.totalQuestions}` : ''}
                </div>
              `;
            }
            
            const isAssignment = notif.type === 'assignment';
            const titleColor = isAssignment ? 'color: #fb923c;' : '';
            
            item.innerHTML = `
              <div class="notification-header">
                <strong style="${titleColor}">${notif.message || 'Notification'}</strong>
                <span class="notification-time">${timeText}</span>
              </div>
              ${bodyContent}
            `;
            
            if (notif.type === 'assignment' && notif.assignmentId) {
              item.addEventListener("click", () => {
                if (!notif.read) {
                  doc.ref.update({ read: true });
                }
                item.classList.add("read");
                
                db.collection('assignments').doc(notif.assignmentId).get()
                  .then(assignmentDoc => {
                    if (assignmentDoc.exists) {
                      const assignmentData = assignmentDoc.data();
                      assignmentData.id = notif.assignmentId;
                      window.currentAssignment = assignmentData;
                      window.latestAssignmentId = notif.assignmentId;
                      openFullAssignmentModal(assignmentData);
                    }
                  })
                  .catch(error => {
                    console.error("Error fetching assignment:", error);
                    alert("Could not load assignment details");
                  });
              });
            } else {
              item.addEventListener("click", () => {
                if (!notif.read) {
                  doc.ref.update({ read: true });
                }
                item.classList.add("read");
              });
            }
            
            notificationList.appendChild(item);
          });
          
          const unreadCount = snapshot.docs.filter(doc => !doc.data().read).length;
          updateNotificationBadge(unreadCount);
        });
    }

    function updateNotificationBadge(count) {
      const notificationLink = document.querySelector('a[onclick*="toggleNotificationPanel"]');
      if (notificationLink) {
        let notificationBadge = notificationLink.querySelector('.notification-badge');
        if (!notificationBadge && count > 0) {
          notificationBadge = document.createElement('span');
          notificationBadge.className = 'notification-badge';
          notificationBadge.textContent = count;
          notificationLink.style.position = 'relative';
          notificationLink.appendChild(notificationBadge);
        } else if (notificationBadge) {
          if (count > 0) {
            notificationBadge.style.display = 'inline-flex';
            notificationBadge.textContent = count;
          } else {
            notificationBadge.style.display = 'none';
          }
        }
      }
    }
    window.updateNotificationBadge = updateNotificationBadge;

    function markAllNotificationsRead() {
      const user = auth.currentUser;
      if (!user) return;
      
      db.collection('notifications')
        .where('menteeId', '==', user.uid)
        .where('read', '==', false)
        .get()
        .then((snapshot) => {
          const batch = db.batch();
          snapshot.forEach((doc) => {
            batch.update(doc.ref, { read: true });
          });
          return batch.commit();
        })
        .then(() => {
          console.log("All notifications marked as read");
          updateNotificationBadge(0);
        })
        .catch((error) => {
          console.error("Error marking notifications as read:", error);
        });
    }
    window.markAllNotificationsRead = markAllNotificationsRead;

    // ============ ASSIGNMENT FUNCTIONS ============
    function openFullAssignmentModal(assignment) {
      if (assignment && assignment.id) {
        window.latestAssignmentId = assignment.id;
        window.currentAssignment = assignment;
      }
      
      document.getElementById('cq-assignment-title').innerText = assignment.title || "New Assignment";
      document.getElementById('cq-assignment-info').style.display = 'block';
      document.getElementById('cq-assignment-quiz').style.display = 'none';
      
      const fieldsElement = document.getElementById('cq-assignment-fields');
      if (fieldsElement) {
        if (assignment.type === "speaking" || assignment.type === "case") {
          const q1 = assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided";
          const q2 = assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided";
          
          fieldsElement.innerHTML = `
            <div><b>Type:</b> ${assignment.type === "speaking" ? "Speaking" : "Case"} Assignment</div>
            <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
            <div><b>Description:</b> ${assignment.description || 'n/a'}</div>
            <div><b>Questions:</b></div>
            <ul>
              <li>${q1}</li>
              <li>${q2}</li>
            </ul>
          `;
        } else if (assignment.type === "written") {
          fieldsElement.innerHTML = `
            <div><b>Type:</b> Written Assignment</div>
            <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
            <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
            <div><b>Difficulty:</b> ${assignment.difficulty || 'n/a'}</div>
            <div><b>Question Count:</b> ${assignment.writtenQuestions ? assignment.writtenQuestions.length : 10}</div>
          `;
        } else {
          fieldsElement.innerHTML = `
            <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
            <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
            <div><b>Questions:</b><br> <span style="font-weight:400; color:#333">${assignment.questions || 'n/a'}</span></div>
            <div><b>Difficulty:</b> ${assignment.difficulty || 'n/a'}</div>
            <div><b>Simulate:</b> ${assignment.simulate ? "Yes" : "No"}</div>
          `;
        }

        if (assignment.trainingPDFs && assignment.trainingPDFs.length > 0) {
          assignment.trainingPDFs.forEach(pdf => {
            const pdfBox = document.createElement('div');
            pdfBox.style.cssText = 'background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px; margin: 8px 0; border-radius: 8px; cursor: pointer; font-weight: 500;';
            pdfBox.textContent = pdf.name || 'Training Document';
            pdfBox.onclick = () => downloadPDF(pdf);
            fieldsElement.appendChild(pdfBox);
          });
        }
      }
      
      document.getElementById('cq-assignment-modal').style.display = 'block';
    }

    function closeAssignmentModal() {
      document.getElementById('cq-assignment-modal').style.display = 'none';
    }

    function snoozeAssignment() {
      closeAssignmentModal();
    }

    function downloadPDF(pdf) {
      const blob = new Blob([pdf.content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = pdf.name || 'training-document.txt';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function acceptAssignmentNow() {
      console.log(" acceptAssignmentNow() called");
      
      const assignment = window.currentAssignment;
      console.log(" Current assignment:", assignment);
      
      if (!assignment) {
        console.error(" No current assignment found");
        return;
      }
      
      if (window.latestAssignmentId) {
        console.log(" Marking assignment as seen");
        const updateData = {
          status: "seen",
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (assignment.type === 'written') {
          updateData.score = 0;
          updateData.maxScore = assignment.writtenQuestions?.length || 10;
        }
        try {
          await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
          console.log(" Assignment marked as seen successfully");
        } catch (error) {
          console.error(" Error marking assignment as seen:", error);
        }
      }

      // Handle assignment types
      if (assignment.type === 'case') {
        console.log(" Opening case study modal for case assignment");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        
        window.currentAssignmentQuestions = {
          q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
          q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
          title: assignment.title || "Case Study",
          description: assignment.description || assignment.caseStudyContent || ""
        };
        
        openCaseStudyModal(assignment);
        return;
      }
      
      if (assignment.type === 'speaking') {
        console.log(" Opening speaking modal for speaking assignment");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        
        window.currentAssignmentQuestions = {
          q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
          q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
          title: assignment.title || "Speaking Assignment",
          description: assignment.description || ""
        };
        
        openSpeakingAssignmentModal(assignment);
        return;
      }

      if (assignment.type === 'written') {
        console.log(" Opening written assignment");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        openWrittenPracticeModal(assignment);
        return;
      }

      // Handle regular quiz assignments
      console.log(" Setting up regular quiz assignment");
      document.getElementById('cq-assignment-info').style.display = 'none';
      document.getElementById('cq-assignment-quiz').style.display = 'block';

      document.getElementById('quizDifficulty').textContent = 'Difficulty: ' + (assignment.difficulty || 'Medium');
      document.getElementById('quizTime').textContent = 'Time: ' + (assignment.time || '10 mins');

      const quizQuestions = assignment.questions || [];
      renderQuiz(quizQuestions);

      const submitBtn = document.getElementById('submitQuizBtn');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = "Finish Practice";
        submitBtn.onclick = function() {
          closeAssignmentModal();
          showCongratsModal({
            message: `Assignment completed! Thanks for practicing.`,
            assignmentName: document.getElementById('cq-assignment-title').textContent
          });
          confetti({
            particleCount: 150,
            spread: 70,
            origin: { y: 0.6 }
          });
          window.latestAssignmentId = null;
          window.currentAssignment = null;
        };
      }
    }

    function renderQuiz(questionsArr) {
      const quizContainer = document.getElementById('quizQuestions');
      if (!quizContainer) return;
      quizContainer.innerHTML = questionsArr.map((q, idx) => `
        <div class="quiz-question" data-competency="${q.competency || ''}">
          <h4>${idx + 1}. ${q.text}</h4>
          ${q.options.map(opt => `
            <label class="quiz-option">
              <input type="radio" name="q${idx+1}" value="${opt}"> ${opt}
            </label>
          `).join('')}
        </div>
      `).join('');
    }

    // ============ WRITTEN PRACTICE FUNCTIONS ============
    function openWrittenPracticeModal(assignment) {
      window.currentAssignment = assignment;
      document.getElementById('cq-written-loading').style.display = 'flex';
      
      const competencies = assignment.competencies || [];
      const questionCount = assignment.writtenQuestions ? assignment.writtenQuestions.length : 10;
      const difficulty = assignment.difficulty || 'Medium';
      
      generateQuestionsFromCompetencies(competencies, questionCount, difficulty, assignment)
        .then(questions => {
          document.getElementById('cq-written-loading').style.display = 'none';
          writtenQuestions = questions;
          currentQuestionIndex = 0;
          writtenAnswers = {};
          loadWrittenQuestion();
          document.getElementById('cq-written-modal').style.display = 'flex';
        })
        .catch(error => {
          console.error("Error generating questions:", error);
          document.getElementById('cq-written-loading').style.display = 'none';
          alert("Error loading assignment. Please try again.");
        });
    }

    function closeWrittenPracticeModal() {
      document.getElementById('cq-written-modal').style.display = 'none';
      if (writtenTimer) {
        clearInterval(writtenTimer);
        writtenTimer = null;
      }
    }

    function loadWrittenQuestion() {
      if (!writtenQuestions || writtenQuestions.length === 0) {
        console.error("No questions available");
        return;
      }

      const question = writtenQuestions[currentQuestionIndex];
      document.getElementById('cq-written-question-count').textContent = 
        `Question ${currentQuestionIndex + 1} of ${writtenQuestions.length}`;
      document.getElementById('cq-written-competency').textContent = question.competency || '';
      document.getElementById('cq-written-question').textContent = question.text;

      const optionsContainer = document.getElementById('cq-written-options');
      optionsContainer.innerHTML = question.options.map((option, idx) => `
        <label class="quiz-option" style="display: flex; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
          <input type="radio" name="written-q${currentQuestionIndex}" value="${option}" style="margin-right: 0.75rem;">
          <span>${option}</span>
        </label>
      `).join('');

      const previousAnswer = writtenAnswers[currentQuestionIndex];
      if (previousAnswer) {
        const radio = optionsContainer.querySelector(`input[value="${previousAnswer}"]`);
        if (radio) radio.checked = true;
      }

      optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
          writtenAnswers[currentQuestionIndex] = radio.value;
        });
      });

      const progress = ((currentQuestionIndex + 1) / writtenQuestions.length) * 100;
      document.getElementById('cq-written-progress-fill').style.width = `${progress}%`;

      document.getElementById('cq-written-prev').disabled = currentQuestionIndex === 0;
      document.getElementById('cq-written-next').style.display = currentQuestionIndex < writtenQuestions.length - 1 ? 'block' : 'none';
      document.getElementById('cq-written-submit').style.display = currentQuestionIndex === writtenQuestions.length - 1 ? 'block' : 'none';
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadWrittenQuestion();
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < writtenQuestions.length - 1) {
        currentQuestionIndex++;
        loadWrittenQuestion();
      }
    }

    function submitWrittenPractice() {
      let score = 0;
      writtenQuestions.forEach((question, index) => {
        if (writtenAnswers[index] === question.correctAnswer) {
          score++;
        }
      });

      const percentage = Math.round((score / writtenQuestions.length) * 100);
      
      closeWrittenPracticeModal();
      
      showCongratsModal({
        message: `You scored ${score}/${writtenQuestions.length} (${percentage}%)!`,
        assignmentName: window.currentAssignment?.title || 'Written Practice',
        score: score,
        totalQuestions: writtenQuestions.length,
        percentage: percentage
      });

      if (window.latestAssignmentId) {
        db.collection('assignments').doc(window.latestAssignmentId).update({
          status: "complete",
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          score: score,
          totalQuestions: writtenQuestions.length,
          percentage: percentage
        });
      }

      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
      });
    }

    // ============ QUESTION GENERATION FUNCTION ============
    window.generateQuestionsFromCompetencies = async function(competencies, questionCount, difficulty, assignment) {
      console.log(" =========================== QUESTION GENERATION START ===========================");
      const compText = competencies.join(', ');
      let trainingContext = "";
      let allTrainingContent = [];
      let hasTrainingData = false;

      if (assignment && assignment.trainingPDFs && Array.isArray(assignment.trainingPDFs) && assignment.trainingPDFs.length > 0) {
        assignment.trainingPDFs.forEach((pdf) => {
          if (pdf.content && typeof pdf.content === 'string' && pdf.content.trim().length > 0) {
            const contentSnippet = pdf.content.trim().substring(0, 1500);
            allTrainingContent.push(contentSnippet);
            hasTrainingData = true;
          }
        });
      }

      if (assignment?.usedMenteeTrainingData === true) {
        try {
          const currentUser = firebase.auth().currentUser;
          if (currentUser) {
            const userTrainingRef = firebase.firestore().collection('userTraining').doc(currentUser.uid);
            const entriesRef = userTrainingRef.collection('entries').orderBy('timestamp', 'desc').limit(3);
            const entriesSnapshot = await entriesRef.get();
            
            entriesSnapshot.forEach(doc => {
              const data = doc.data();
              if (data.content && data.content.trim().length > 0) {
                allTrainingContent.push(data.content.trim());
                hasTrainingData = true;
              }
            });
          }
        } catch (error) {
          console.error("Error fetching user training data:", error);
        }
      }

      if (hasTrainingData && allTrainingContent.length > 0) {
        const combinedContent = allTrainingContent.join(' ').substring(0, 2500);
        trainingContext = combinedContent;
      }

      let prompt;
      if (hasTrainingData && trainingContext) {
        prompt = `You are creating FBLA business questions that MUST be directly based on this student's uploaded content:

"${trainingContext}"

Create ${questionCount} multiple choice questions that:
1. Use concepts, topics, and themes from the student's content above
2. Connect those concepts to these business competencies: ${compText}
3. Are at ${difficulty} difficulty level
4. Have exactly 4 answer choices each
5. Make the connection between the student's content and business concepts clear

CRITICAL: The questions MUST relate to the actual content the student uploaded. If the content is about prisons, create questions about workplace management, employee conditions, organizational structure, etc. that connect to that theme.

Return JSON only in this exact format:
[
  {
    "text": "Question text that references concepts from the student content?",
    "competency": "One of the provided competency names",
    "correctAnswer": "The correct option text",
    "options": ["Option A", "Option B", "Option C", "Option D"]
  }
]`;
      } else {
        prompt = `Generate ${questionCount} FBLA multiple choice questions.
- Difficulty: ${difficulty}
- Competencies: ${compText}
- Each must have exactly 4 options, 1 correct answer
- Make questions realistic for business competitions

Return JSON only in this format:
[
  {
    "text": "Question text?",
    "competency": "Competency Name",
    "correctAnswer": "Correct option text",
    "options": ["Option A", "Option B", "Option C", "Option D"]
  }
]`;
      }

      try {
        const requestBody = {
          model: "gpt-4o-mini",
          messages: [
            { 
              role: "system", 
              content: `You are an expert FBLA written-competition exam designer.

Your role is to generate ORIGINAL, competition-accurate FBLA-style multiple-choice questions that match the structure, rigor, tone, and professional standards of official FBLA written tests.

You must follow ALL rules below.


CORE FBLA PHILOSOPHY

FBLA written tests assess professional correctness, precision, and applied business literacy.

They do NOT assess creativity, opinion, or open-ended reasoning.

Each question must test exactly ONE concept.

Questions must be concise, objective, and professionally worded.

Avoid unnecessary narrative unless the question type explicitly requires a scenario.


APPROVED FBLA QUESTION ARCHETYPES

Every question MUST clearly belong to ONE of the following archetypes:

1. Definition / Term Identification  
   - Identifying the correct term based on a definition  
   - Selecting the correct meaning of a professional word or concept  

2. Classification / Category Recognition  
   - Determining where an item belongs within a professional category system  
   - Examples include document types, account categories, system types, business forms, or classifications  

3. Procedural / Workflow Knowledge  
   - Understanding the stages of a professional workflow specific to the competition area  
   - Identifying where information originates within that workflow  
   - Determining which document, tool, or action is appropriate at a given stage  
   - Recognizing correct sequencing of professional tasks within the domain  

4. Tool-to-Function Matching  
   - Matching software features, commands, utilities, or tools to their correct purpose  
   - Selecting the correct function used to accomplish a professional task  

5. Quantitative / Calculation Application  
   - Performing single-step or limited multi-step calculations  
   - Selecting the correct numeric result based on provided data  
   - Avoid unnecessary complexity or advanced math  

6. Language Precision & Usage  
   - Correct use of professional vocabulary  
   - Distinguishing homophones, word meanings, spelling, grammar, and standard usage  

7. Error Detection / Exception Identification  
   - Identifying what is incorrect, misspelled, or does NOT belong  
   - Using negation ("NOT") carefully and intentionally  


QUESTION STRUCTURE RULES

 Each question must assess ONE idea only.  
 Do not combine multiple concepts in one question.  
 Avoid ambiguous wording.  
 Use professional, neutral language.

Acceptable stem styles include:
- "Which of the following"
- "What term best describes"
- "The document used to"
- "Which action should be taken"
- "Which of the following is NOT"


ANSWER CHOICE DESIGN (CRITICAL)

Each question MUST include exactly FOUR answer choices.

Answer choices must:
 Be the same grammatical form  
 Be similar in length  
 Belong to the same conceptual family  

Wrong answer choices (distractors) must be plausible and realistic.

Allowed distractor strategies include:
 Closely related terms within the same category  
 Common student misconceptions  
 Incorrect step within a workflow  
 Reversed or misapplied professional rules  
 Visually or linguistically similar words  
 Typical calculation or classification errors  

Never include joke answers or obviously incorrect options.


DIFFICULTY CALIBRATION

Easy:
 Direct recall or recognition  
 Minimal traps  

Medium:
 Requires discrimination between similar concepts  
 Includes common misconceptions  

Hard:
 Includes negation ("NOT")  
 Requires precise rule awareness  
 Uses subtle wording differences  
 Penalizes shallow memorization  


CONTENT INTEGRITY RULES

 All questions must be ORIGINAL.  
 Do NOT copy real FBLA questions.  
 Do NOT closely paraphrase known questions.  
 Use authentic structure only, not replicated wording.

Questions must feel realistic for competitive FBLA written events at the regional, state, or national level.

When study materials are provided, extract concepts, facts, names, dates, laws, and details from them. Present this information as established business knowledge. NEVER mention "the study guide", "the document", "the material", or use phrases like "according to", "as stated in", or "mentioned in".


OUTPUT REQUIREMENTS

 Generate ONLY the requested number of questions.  
 Each question must have exactly four answer options.  
 Only ONE option may be correct.  
 Output valid JSON only.  
 Do not include explanations, commentary, or headings.  

You are writing as a professional exam author  not as a tutor or teacher.`
            },
            { role: "user", content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt }
          ],
          temperature: 0.8,
          max_tokens: 2500
        };

        const res = await firebase.functions().httpsCallable("generateQuestionsWithAI")({messages: requestBody.messages});

        const data = res.data;
        let content = data.content || data.choices?.[0]?.message?.content || '';
        
        if (typeof content !== 'string') {
          content = JSON.stringify(content);
        }
        
        content = content.trim();
        content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '');
        
        const jsonStart = content.indexOf('[');
        const jsonEnd = content.lastIndexOf(']') + 1;
        
        if (jsonStart !== -1 && jsonEnd > jsonStart) {
          content = content.slice(jsonStart, jsonEnd);
        }
        
        const questions = JSON.parse(content);
        console.log(" Generated questions:", questions);
        
        return questions.map((q, index) => ({
          id: index + 1,
          text: q.text,
          competency: q.competency || competencies[0] || 'General',
          correctAnswer: q.correctAnswer,
          options: q.options || []
        }));
      } catch (error) {
        console.error("Error generating questions:", error);
        throw error;
      }
    };

    // ============ CONGRATULATIONS MODAL ============
    function showCongratsModal(results) {
      const modal = document.getElementById('congratsModal');
      const content = modal.querySelector('.cq-modal-fields');
      
      let competenciesHTML = '';
      if (results.competencyStats) {
        const breakdownDiv = document.createElement('div');
        breakdownDiv.style.marginTop = '1.25rem';
        
        const title = document.createElement('b');
        title.textContent = 'Competency Breakdown:';
        breakdownDiv.appendChild(title);
        
        Object.entries(results.competencyStats).forEach(([comp, stats]) => {
          const compDiv = document.createElement('div');
          compDiv.style.marginTop = '0.5rem';
          
          const compText = document.createElement('div');
          compText.textContent = `${comp}: ${stats.correct}/${stats.total} correct`;
          compDiv.appendChild(compText);
          
          const progressContainer = document.createElement('div');
          progressContainer.style.cssText = 'height:6px; background:#e2e8f0; border-radius:3px; margin-top:2px;';
          
          const progressBar = document.createElement('div');
          const percentage = (stats.correct / stats.total) * 100;
          progressBar.style.cssText = `height:100%; width:${percentage}%; background:#4ade80; border-radius:3px;`;
          progressContainer.appendChild(progressBar);
          
          compDiv.appendChild(progressContainer);
          breakdownDiv.appendChild(compDiv);
        });
        
        competenciesHTML = breakdownDiv.outerHTML;
      } else if (results.competencies && Array.isArray(results.competencies) && results.competencies.length > 0) {
        // For speaking and case study assignments
        const breakdownDiv = document.createElement('div');
        breakdownDiv.style.marginTop = '1.25rem';
        
        const title = document.createElement('b');
        title.textContent = 'Competencies Assessed:';
        breakdownDiv.appendChild(title);
        
        results.competencies.forEach(comp => {
          const compDiv = document.createElement('div');
          compDiv.style.marginTop = '0.5rem';
          compDiv.textContent = comp;
          breakdownDiv.appendChild(compDiv);
        });
        
        competenciesHTML = breakdownDiv.outerHTML;
      }

      const percentage = results.percentage || (results.score !== undefined && results.totalQuestions !== undefined ? Math.round((results.score / results.totalQuestions) * 100) : undefined);

      content.innerHTML = `
        <div style="text-align:center; padding:1rem;">
          <div style="font-size:1.25rem; margin-bottom:1rem;">
            ${results.message || 'Assignment Completed!'}
          </div>
          <div style="font-size:0.9rem; color:#666; margin-bottom:0.5rem;">
            For completing: <strong>${results.assignmentName || 'the assignment'}</strong>
          </div>
          ${results.score !== undefined && results.totalQuestions !== undefined ? `
            <div style="font-size:1.1rem; margin:1rem 0; color:#1f2937;">
              Score: <strong>${results.score}/${results.totalQuestions}</strong>${percentage !== undefined ? ` (${percentage}%)` : ''}
            </div>
          ` : ''}
          ${competenciesHTML}
        </div>
      `;
      
      modal.style.display = 'block';
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 }
      });
    }

    function closeCongratsModal(docId) {
      const modal = document.getElementById('congratsModal');
      if (modal) {
        modal.style.display = 'none';
      }
      document.body.style.overflow = 'auto';
      
      if (docId) {
        db.collection('assignments').doc(docId).update({
          status: "complete"
        }).catch(error => {
          console.error("Error updating assignment status:", error);
        });
      } else if (window.latestAssignmentId) {
        db.collection('assignments').doc(window.latestAssignmentId).update({
          status: "complete"
        }).catch(error => {
          console.error("Error updating assignment status:", error);
        });
      }
    }

    window.openFullAssignmentModal = openFullAssignmentModal;
    window.closeAssignmentModal = closeAssignmentModal;
    window.snoozeAssignment = snoozeAssignment;
    window.acceptAssignmentNow = acceptAssignmentNow;
    window.showCongratsModal = showCongratsModal;
    window.closeCongratsModal = closeCongratsModal;
    window.openWrittenPracticeModal = openWrittenPracticeModal;
    window.closeWrittenPracticeModal = closeWrittenPracticeModal;
    window.loadWrittenQuestion = loadWrittenQuestion;
    window.previousQuestion = previousQuestion;
    window.nextQuestion = nextQuestion;
    window.submitWrittenPractice = submitWrittenPractice;
    window.renderQuiz = renderQuiz;

    // ============ ASSIGNMENT LISTENER ============
    auth.onAuthStateChanged(function(user) {
      if (!user) return;
      
      setupNotifications();
      
      db.collection('assignments')
        .where('to', '==', user.uid)
        .where('status', '==', 'assigned')
        .onSnapshot(snapshot => {
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.status === "assigned") {
              showAssignmentModal(data, doc.id);
            }
          });
        }, error => {
          console.error("Assignment listener error:", error);
        });
    });

    function showAssignmentModal(assignment, docId) {
      window.latestAssignmentId = docId;
      window.currentAssignment = assignment;
      
      const user = firebase.auth().currentUser;
      if (user) {
        const notificationData = {
          menteeId: user.uid,
          type: 'assignment',
          assignmentId: docId,
          assignmentName: assignment.title || "New Assignment",
          message: `New Assignment: ${assignment.title || "Assignment"}`,
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false,
          showModal: false,
          assignmentType: assignment.type || 'quiz',
          competencies: assignment.competencies || [],
          difficulty: assignment.difficulty || 'Medium',
          time: assignment.time || '10 mins'
        };
        
        if (assignment.type === "speaking" || assignment.type === "case") {
          notificationData.questions = assignment.questions || [];
          notificationData.description = assignment.description || '';
        } else if (assignment.type === "written") {
          notificationData.questionCount = assignment.writtenQuestions ? assignment.writtenQuestions.length : 10;
        } else {
          notificationData.questions = assignment.questions || 'n/a';
          notificationData.simulate = assignment.simulate || false;
        }
        
        db.collection('notifications').add(notificationData)
          .then(() => {
            console.log("Assignment notification stored in Firebase");
          })
          .catch(error => {
            console.error("Error storing assignment notification:", error);
          });
      }
      
      showNotification("New Assignment: " + (assignment.title || "Assignment"), 
        assignment.type === "written" ? "Written Assignment" : "Quiz Assignment",
        () => {
          openFullAssignmentModal(assignment);
        });
      
      db.collection('assignments').doc(docId).update({
        status: "seen"
      }).catch(error => {
        console.error("Error updating assignment status:", error);
      });
    }

    function showNotification(title, description, onClick = null) {
      const list = document.getElementById("notificationList");
      if (!list) return;

      const item = document.createElement("div");
      item.className = "notification-item";
      item.innerHTML = `
        <div class="notification-header">
          <strong>${title}</strong>
          <span class="notification-time">Just now</span>
        </div>
        <div class="notification-body">${description}</div>
      `;

      if (onClick) {
        item.addEventListener("click", () => {
          onClick();
          item.classList.add("read");
        });
      }

      list.prepend(item);

      const notificationBadge = document.querySelector('.nav-icons li a[onclick="toggleCommentPanel()"] .notification-badge');
      if (notificationBadge) {
        notificationBadge.style.display = 'inline-block';
      }
    }

    window.showAssignmentModal = showAssignmentModal;
    window.showNotification = showNotification;

    // ============ SPEAKING ASSIGNMENT FUNCTIONS ============
    function openSpeakingAssignmentModal(assignment) {
      if (assignment && assignment.id) {
        window.latestAssignmentId = assignment.id;
        window.currentAssignment = assignment;
        console.log("Set assignment ID:", assignment.id);
      }
      
      document.getElementById('cq-speaking-title').textContent = "Speaking Assessment";
      
      if (window.currentAssignmentQuestions) {
        document.getElementById('cq-speaking-q1').textContent = window.currentAssignmentQuestions.q1;
        document.getElementById('cq-speaking-q2').textContent = window.currentAssignmentQuestions.q2;
      } else if (assignment && assignment.questions) {
        document.getElementById('cq-speaking-q1').textContent = assignment.questions[0] || "No question provided";
        document.getElementById('cq-speaking-q2').textContent = assignment.questions[1] || "No question provided";
      }
      
      const starsContainer = document.getElementById('cq-speaking-stars');
      if (starsContainer) {
        starsContainer.innerHTML = '';
        for (let i = 0; i < 150; i++) {
          const star = document.createElement('div');
          star.className = 'cq-speaking-star';
          star.style.top = Math.random() * 100 + '%';
          star.style.left = Math.random() * 100 + '%';
          const size = Math.random() * 2 + 0.5;
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          star.style.opacity = Math.random() * 0.7 + 0.3;
          star.style.animationDuration = (Math.random() * 3 + 2) + 's';
          starsContainer.appendChild(star);
        }
      }
      
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      const modal = document.getElementById('cq-speaking-modal');
      if (modal) {
        modal.style.display = 'flex';
      }
      
      setTimeout(() => {
        initializeVideoPreview();
      }, 100);
    }
    window.openSpeakingAssignmentModal = openSpeakingAssignmentModal;

    async function initializeVideoPreview() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: {
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            frameRate: { min: 15, ideal: 30, max: 60 }
          }, 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });
        
        const videoElement = document.getElementById('cq-speaking-videoPreview');
        const noVideoView = document.getElementById('cq-speaking-noVideoView');
        
        if (videoElement) {
          videoElement.srcObject = stream;
          videoElement.muted = true;
          videoElement.autoplay = true;
          videoElement.playsInline = true;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
          
          cqSpeakingMediaStream = stream;
          setupRecordingFromStream(stream);
          
          videoElement.addEventListener('loadedmetadata', () => {
            videoElement.play().catch(e => {
              console.error("Error playing video preview:", e);
            });
          });
        }
      } catch (error) {
        console.error('Error initializing video preview:', error);
        const noVideoView = document.getElementById('cq-speaking-noVideoView');
        if (noVideoView) {
          noVideoView.style.display = 'flex';
        }
      }
    }

    function setupRecordingFromStream(stream) {
      const videoElement = document.getElementById('cq-speaking-videoPreview');
      if (!videoElement) {
        console.error("Video preview element not found in DOM");
        return;
      }
      
      videoElement.srcObject = stream;
      videoElement.muted = true;
      videoElement.autoplay = true;
      videoElement.playsInline = true;
      videoElement.style.display = 'block';
      const noVideoView = document.getElementById('cq-speaking-noVideoView');
      if (noVideoView) noVideoView.style.display = 'none';
      
      videoElement.addEventListener('loadedmetadata', () => {
        videoElement.play().catch(e => {
          console.error("Error playing video preview:", e);
        });
      });
      
      let options = {};
      if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
        options.mimeType = 'video/webm;codecs=vp9';
      } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
        options.mimeType = 'video/webm;codecs=vp8';
      } else if (MediaRecorder.isTypeSupported('video/webm')) {
        options.mimeType = 'video/webm';
      } else if (MediaRecorder.isTypeSupported('video/mp4')) {
        options.mimeType = 'video/mp4';
      }
      
      cqSpeakingMediaRecorder = new MediaRecorder(stream, options);
      console.log("MediaRecorder created with mimeType:", cqSpeakingMediaRecorder.mimeType);
      
      cqSpeakingMediaRecorder.ondataavailable = (event) => {
        if (event.data && event.data.size > 0) {
          cqSpeakingRecordedChunks.push(event.data);
          console.log("Added chunk, total chunks:", cqSpeakingRecordedChunks.length);
        }
      };
      
      cqSpeakingMediaRecorder.onstop = () => {
        console.log("Video recording stopped, processing...");
        
        if (recordingStateMonitor) {
          clearInterval(recordingStateMonitor);
          recordingStateMonitor = null;
        }
        
        setTimeout(() => {
          if (cqSpeakingRecordedChunks.length === 0) {
            console.error("No video data recorded after stop");
            alert("No video data was recorded. Please try recording for at least 1 second.");
            return;
          }
          const mimeType = cqSpeakingMediaRecorder.mimeType || 'video/webm';
          const blob = new Blob(cqSpeakingRecordedChunks, { type: mimeType });
          console.log("Created video blob:", blob.size, "bytes");

          const videoURL = URL.createObjectURL(blob);
          const videoElement = document.getElementById('cq-speaking-videoPreview');
          const noVideoView = document.getElementById('cq-speaking-noVideoView');
          if (videoElement) {
            videoElement.srcObject = null;
            videoElement.src = videoURL;
            videoElement.controls = true;
            videoElement.muted = false;
            videoElement.style.display = 'block';
            if (noVideoView) noVideoView.style.display = 'none';
          }
          
          const recordBtn = document.getElementById('cq-speaking-recordBtn');
          if (recordBtn) {
            recordBtn.classList.remove('recording');
          }
          
          const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
          if (recordingIndicator) {
            recordingIndicator.classList.remove('active');
          }
          
          isRecording = false;
          
          const submitBtn = document.getElementById('cq-speaking-submitBtn');
          if (submitBtn && cqSpeakingRecordedChunks.length > 0) {
            submitBtn.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Assessment';
          }
        }, 1000);
      };
      
      cqSpeakingMediaRecorder.addEventListener('start', () => {
        console.log(" MediaRecorder start event fired");
        isIntentionallyStopping = false;
        
        if (recordingStateMonitor) {
          clearInterval(recordingStateMonitor);
          recordingStateMonitor = null;
        }
        
        recordingStateMonitor = setInterval(() => {
          if (isIntentionallyStopping) {
            return;
          }
          
          if (cqSpeakingMediaRecorder && isRecording) {
            const state = cqSpeakingMediaRecorder.state;
            if (state === 'recording') {
              console.log(" Recording still active");
            } else if (state === 'inactive' || state === 'paused') {
              if (!isIntentionallyStopping) {
                console.error(" Recording stopped unexpectedly! State:", state);
                clearInterval(recordingStateMonitor);
                recordingStateMonitor = null;
                isRecording = false;
                const recordBtn = document.getElementById('cq-speaking-recordBtn');
                if (recordBtn) {
                  recordBtn.classList.remove('recording');
                }
                const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
                if (recordingIndicator) {
                  recordingIndicator.classList.remove('active');
                }
                alert(" Recording stopped unexpectedly. Please try again.");
              }
            }
          }
        }, 1000);
      });
    }

    function stopRecording() {
      console.log(" stopRecording() called - user intentionally stopping");
      
      if (!cqSpeakingMediaRecorder || !isRecording) {
        console.log("Cannot stop: no recorder or not recording");
        return;
      }
      
      isIntentionallyStopping = true;
      
      if (recordingStateMonitor) {
        clearInterval(recordingStateMonitor);
        recordingStateMonitor = null;
        console.log(" State monitor cleared");
      }
      
      console.log("Stopping recording, current state:", cqSpeakingMediaRecorder.state);
      isRecording = false;
      
      if (cqSpeakingMediaRecorder.state === 'recording') {
        try {
          cqSpeakingMediaRecorder.requestData();
          console.log("Requested final data before stop");
          setTimeout(() => {
            try {
              cqSpeakingMediaRecorder.stop();
              console.log(" Recorder stopped after requesting data");
            } catch (e) {
              console.error("Error stopping recorder:", e);
            }
          }, 100);
          
          const recordBtn = document.getElementById('cq-speaking-recordBtn');
          if (recordBtn) {
            recordBtn.classList.remove('recording');
          }
          
          const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
          if (recordingIndicator) {
            recordingIndicator.classList.remove('active');
          }
          
          return;
        } catch (e) {
          console.error("Error requesting final data:", e);
        }
      }
      
      try {
        cqSpeakingMediaRecorder.stop();
        console.log(" Recorder stopped");
      } catch (e) {
        console.error("Error stopping recorder:", e);
      }
      
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
    }

    function toggleSpeakingRecording() {
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (!recordBtn) return;
      
      if (isRecording) {
        console.log("Stopping recording via toggle button");
        stopRecording();
      } else {
        console.log("Starting recording via toggle button");
        
        if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
          cqSpeakingRecordedChunks = [];
          console.log("Starting existing recorder");
          try {
            isRecording = true;
            recordBtn.classList.add('recording');
            
            const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
            if (recordingIndicator) {
              recordingIndicator.classList.add('active');
            }
            
            cqSpeakingMediaRecorder.start();
            console.log(" Recording started successfully, state:", cqSpeakingMediaRecorder.state);
          } catch (e) {
            console.error("Error starting recorder:", e);
            alert("Error starting recording: " + e.message);
            isRecording = false;
          }
        } else if (cqSpeakingMediaStream && !cqSpeakingMediaRecorder) {
          console.log("Setting up recorder from existing stream");
          setupRecordingFromStream(cqSpeakingMediaStream);
          setTimeout(() => {
            if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state === 'inactive') {
              cqSpeakingRecordedChunks = [];
              try {
                isRecording = true;
                recordBtn.classList.add('recording');
                
                const recordingIndicator2 = document.getElementById('cq-speaking-recordingIndicator');
                if (recordingIndicator2) {
                  recordingIndicator2.classList.add('active');
                }
                
                cqSpeakingMediaRecorder.start();
                console.log(" Recording started after setup");
              } catch (e) {
                console.error("Error starting recorder after setup:", e);
                alert("Error starting recording: " + e.message);
                isRecording = false;
              }
            }
          }, 200);
        } else if (!cqSpeakingMediaStream) {
          console.log("Getting new stream and starting recording");
          initializeVideoPreview();
        } else {
          alert("Recording is already in progress or not ready. Please wait.");
        }
      }
    }
    window.toggleSpeakingRecording = toggleSpeakingRecording;

    function cqSpeakingStopAllMedia() {
      if (cqSpeakingMediaRecorder && cqSpeakingMediaRecorder.state !== 'inactive') {
        try {
          cqSpeakingMediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping recorder:", e);
        }
      }
      
      if (cqSpeakingMediaStream) {
        cqSpeakingMediaStream.getTracks().forEach(track => track.stop());
        cqSpeakingMediaStream = null;
      }
      
      cqSpeakingMediaRecorder = null;
      cqSpeakingRecordedChunks = [];
      isRecording = false;
      
      const recordBtn = document.getElementById('cq-speaking-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-speaking-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
    }

    function closeSpeakingAssignmentModal() {
      document.getElementById('cq-speaking-downloadBtn').style.display = 'none';
      cqSpeakingStopAllMedia();
      document.getElementById('cq-speaking-modal').style.display = 'none';
      
      if (window.latestAssignmentId) {
        db.collection('assignments').doc(window.latestAssignmentId)
          .update({ status: "complete" })
          .then(() => {
            window.latestAssignmentId = null;
            window.currentAssignment = null;
          })
          .catch(error => {
            console.error("Error updating assignment status:", error);
          });
      }
    }
    window.closeSpeakingAssignmentModal = closeSpeakingAssignmentModal;

    async function blobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    async function submitSpeakingResponse() {
      if (!window.latestAssignmentId || cqSpeakingRecordedChunks.length === 0) {
        alert("Recording not found or assignment ID missing.");
        return;
      }

      const submitBtn = document.getElementById('cq-speaking-submitBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      const blob = new Blob(cqSpeakingRecordedChunks, { type: 'video/webm' });
      const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

      const GITHUB_USERNAME = "Anjay209";
      const GITHUB_REPO = "video-storage";
      const GITHUB_TOKEN = "REDACTED_TOKEN";

      let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
      let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

      try {
        const base64 = await blobToBase64(blob);

        const uploadRes = await fetch(githubApiUrl, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Upload ${filename}`,
            content: base64,
            branch: 'main'
          })
        });

        if (!uploadRes.ok) {
          const errData = await uploadRes.json().catch(() => ({}));
          const errorMessage = errData?.message || "GitHub upload failed";
          
          if (uploadRes.status === 409) {
            console.log("File exists, attempting to update with SHA...");
            try {
              const getRes = await fetch(githubApiUrl, {
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (getRes.ok) {
                const existingFile = await getRes.json();
                const updateRes = await fetch(githubApiUrl, {
                  method: 'PUT',
                  headers: {
                    Authorization: `Bearer ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    message: `Update ${filename}`,
                    content: base64,
                    branch: 'main',
                    sha: existingFile.sha
                  })
                });
                
                if (!updateRes.ok) {
                  throw new Error("Failed to update existing file: " + (await updateRes.json().catch(() => ({}))).message);
                }
                console.log("Successfully updated existing file");
              } else {
                throw new Error("Could not get existing file info: " + errorMessage);
              }
            } catch (updateError) {
              console.log("Update failed, using unique filename...");
              const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
              const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
              const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
              
              const retryRes = await fetch(uniqueGithubApiUrl, {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Upload ${uniqueFilename}`,
                  content: base64,
                  branch: 'main'
                })
              });
              
              if (!retryRes.ok) {
                throw new Error("Failed to upload with unique filename: " + (await retryRes.json().catch(() => ({}))).message);
              }
              
              githubPagesUrl = uniqueGithubPagesUrl;
              console.log("Successfully uploaded with unique filename");
            }
          } else {
            throw new Error(errorMessage);
          }
        }

        await firebase.firestore()
          .collection('assignments')
          .doc(window.latestAssignmentId)
          .update({
            status: "complete",
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            recordingUrl: githubPagesUrl
          });

        const user = firebase.auth().currentUser;
        const userId = user?.uid;
        const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
        
        if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
          try {
            await firebase.firestore()
              .collection('users')
              .doc(userId)
              .collection('assignments')
              .doc(assignmentId)
              .set({
                status: 'completed',
                submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
                fileUrl: githubPagesUrl,
                fileType: 'video',
              }, { merge: true });
          } catch (userAssignError) {
            console.warn("Could not update user assignments collection (non-critical):", userAssignError);
          }
        }

        let competencies = [];
        let assignmentName = 'Speaking Assessment';
        try {
          const assignmentDoc = await firebase.firestore()
            .collection('assignments')
            .doc(window.latestAssignmentId)
            .get();
          
          if (assignmentDoc.exists) {
            const assignmentData = assignmentDoc.data();
            competencies = assignmentData.competencies || [];
            assignmentName = assignmentData.title || 'Speaking Assessment';
          }
        } catch (error) {
          console.error("Error fetching assignment data:", error);
        }

        showCongratsModal({ 
          score: undefined, 
          totalQuestions: undefined,
          assignmentName: assignmentName,
          competencies: competencies,
          assignmentType: 'speaking'
        });
        
        closeSpeakingAssignmentModal();

      } catch (err) {
        console.error("Upload Error:", err);
        const errorMessage = err.message || "Something went wrong while uploading your recording.";
        alert(" Upload Error: " + errorMessage);
        
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Assessment';
        }
      }
    }
    window.submitSpeakingResponse = submitSpeakingResponse;

    // ============ CASE STUDY ASSIGNMENT FUNCTIONS ============
    async function cqCaseStudyBlobToBase64(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    function toggleCaseStudyTimer() {
      cqCaseStudyTimerActive = !cqCaseStudyTimerActive;
      const timerEl = document.getElementById('cq-case-study-timer');
      const timerDot = document.getElementById('cq-case-study-timer-dot');
      const timerText = document.getElementById('cq-case-study-timer-text');
      const timerStart = document.getElementById('cq-case-study-timer-start');
      
      if (cqCaseStudyTimerActive) {
        timerEl.classList.add('active');
        if (timerStart) timerStart.style.display = 'none';
        
        cqCaseStudyTimerInterval = setInterval(() => {
          if (cqCaseStudyTimeLeft > 0) {
            cqCaseStudyTimeLeft--;
            if (timerText) {
              const mins = Math.floor(cqCaseStudyTimeLeft / 60);
              const secs = cqCaseStudyTimeLeft % 60;
              timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
          } else {
            cqCaseStudyTimerActive = false;
            if (timerEl) timerEl.classList.remove('active');
            if (timerStart) timerStart.style.display = 'inline';
            if (cqCaseStudyTimerInterval) {
              clearInterval(cqCaseStudyTimerInterval);
              cqCaseStudyTimerInterval = null;
            }
            alert('Time is up!');
          }
        }, 1000);
      } else {
        timerEl.classList.remove('active');
        if (timerStart) timerStart.style.display = 'inline';
        if (cqCaseStudyTimerInterval) {
          clearInterval(cqCaseStudyTimerInterval);
          cqCaseStudyTimerInterval = null;
        }
      }
    }
    window.toggleCaseStudyTimer = toggleCaseStudyTimer;

    function expandCaseStudyContent() {
      document.getElementById('cq-case-study-top-info').style.display = 'none';
      document.getElementById('cq-case-study-video-container').style.display = 'none';
      document.getElementById('cq-case-study-bottom-info').style.display = 'none';
      document.getElementById('cq-case-study-controls-wrapper').style.display = 'none';
      document.getElementById('cq-case-study-expanded-content').style.display = 'flex';
    }
    window.expandCaseStudyContent = expandCaseStudyContent;

    function collapseCaseStudyContent() {
      document.getElementById('cq-case-study-top-info').style.display = 'grid';
      document.getElementById('cq-case-study-video-container').style.display = 'block';
      document.getElementById('cq-case-study-bottom-info').style.display = 'grid';
      document.getElementById('cq-case-study-controls-wrapper').style.display = 'flex';
      document.getElementById('cq-case-study-expanded-content').style.display = 'none';
    }
    window.collapseCaseStudyContent = collapseCaseStudyContent;

    function openCaseStudyModal(assignment) {
      if (assignment && assignment.id) {
        window.latestAssignmentId = assignment.id;
        window.currentAssignment = assignment;
        console.log("Set assignment ID:", assignment.id);
      }
      
      document.getElementById('cq-case-study-title').textContent = "Case Study";
      
      const caseName = assignment.title || "Case Study";
      document.getElementById('cq-case-study-name').textContent = caseName;
      document.getElementById('cq-case-study-expanded-title').textContent = caseName;
      
      const caseContent = assignment.description || assignment.caseStudyContent || "No case study content provided.";
      const previewText = caseContent.substring(0, 100) + (caseContent.length > 100 ? '...' : '');
      document.getElementById('cq-case-study-content-preview-text').textContent = previewText;
      document.getElementById('cq-case-study-full-content').textContent = caseContent;
      
      if (assignment.questions && assignment.questions.length > 0) {
        document.getElementById('cq-case-study-q1').textContent = assignment.questions[0] || "No question provided";
        if (assignment.questions.length > 1) {
          document.getElementById('cq-case-study-q2').textContent = assignment.questions[1] || "No question provided";
        }
      }
      
      cqCaseStudyTimeLeft = 1200;
      const timerText = document.getElementById('cq-case-study-timer-text');
      if (timerText) {
        const mins = Math.floor(cqCaseStudyTimeLeft / 60);
        const secs = cqCaseStudyTimeLeft % 60;
        timerText.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      }
      cqCaseStudyTimerActive = false;
      const timerEl = document.getElementById('cq-case-study-timer');
      if (timerEl) timerEl.classList.remove('active');
      
      const starsContainer = document.getElementById('cq-case-study-stars');
      if (starsContainer) {
        starsContainer.innerHTML = '';
        for (let i = 0; i < 150; i++) {
          const star = document.createElement('div');
          star.className = 'cq-case-study-star';
          star.style.top = Math.random() * 100 + '%';
          star.style.left = Math.random() * 100 + '%';
          const size = Math.random() * 2 + 0.5;
          star.style.width = size + 'px';
          star.style.height = size + 'px';
          star.style.opacity = Math.random() * 0.7 + 0.3;
          star.style.animationDuration = (Math.random() * 3 + 2) + 's';
          starsContainer.appendChild(star);
        }
      }
      
      const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      collapseCaseStudyContent();
      document.getElementById('cq-case-study-submitBtn').style.display = 'none';
      document.getElementById('cq-case-study-downloadBtn').style.display = 'none';
      
      const modal = document.getElementById('cq-case-study-modal');
      if (modal) {
        modal.style.display = 'flex';
      }
      
      setTimeout(() => {
        cqCaseStudyInitializeVideoPreview();
      }, 100);
    }
    window.openCaseStudyModal = openCaseStudyModal;

    async function cqCaseStudyInitializeVideoPreview() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: {
            width: { min: 640, ideal: 1280, max: 1920 },
            height: { min: 480, ideal: 720, max: 1080 },
            frameRate: { min: 15, ideal: 30, max: 60 }
          }, 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            sampleRate: 44100
          }
        });
        
        const videoElement = document.getElementById('cq-case-study-videoPreview');
        const noVideoView = document.getElementById('cq-case-study-noVideoView');
        
        if (videoElement) {
          videoElement.srcObject = stream;
          videoElement.muted = true;
          videoElement.autoplay = true;
          videoElement.playsInline = true;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
          
          cqCaseStudyMediaStream = stream;
          cqCaseStudySetupRecordingFromStream(stream);
          
          videoElement.addEventListener('loadedmetadata', () => {
            videoElement.play().catch(e => {
              console.error("Error playing video preview:", e);
            });
          });
        }
      } catch (error) {
        console.error('Error initializing video preview:', error);
        const noVideoView = document.getElementById('cq-case-study-noVideoView');
        if (noVideoView) {
          noVideoView.style.display = 'flex';
        }
      }
    }

    function cqCaseStudySetupRecordingFromStream(stream) {
      const videoElement = document.getElementById('cq-case-study-videoPreview');
      if (!videoElement) {
        console.error("Video preview element not found in DOM");
        return;
      }
      
      let options = {};
      if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
        options.mimeType = 'video/webm;codecs=vp9';
      } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
        options.mimeType = 'video/webm;codecs=vp8';
      } else if (MediaRecorder.isTypeSupported('video/webm')) {
        options.mimeType = 'video/webm';
      } else if (MediaRecorder.isTypeSupported('video/mp4')) {
        options.mimeType = 'video/mp4';
      }
      
      cqCaseStudyMediaRecorder = new MediaRecorder(stream, options);
      console.log("Case Study MediaRecorder created with mimeType:", cqCaseStudyMediaRecorder.mimeType);
      
      cqCaseStudyMediaRecorder.ondataavailable = (event) => {
        console.log("Case Study video data available:", event.data.size, "bytes");
        if (event.data.size > 0) {
          cqCaseStudyRecordedChunks.push(event.data);
        }
      };
      
      cqCaseStudyMediaRecorder.onstop = () => {
        console.log("Case Study video recording stopped, processing...");
        
        if (cqCaseStudyRecordedChunks.length === 0) {
          console.error("No video data recorded");
          alert("No video data was recorded. Please try again.");
          return;
        }
        
        const mimeType = cqCaseStudyMediaRecorder.mimeType || 'video/webm';
        const blob = new Blob(cqCaseStudyRecordedChunks, { type: mimeType });
        console.log("Created video blob:", blob.size, "bytes");

        const videoURL = URL.createObjectURL(blob);
        const videoElement = document.getElementById('cq-case-study-videoPreview');
        const noVideoView = document.getElementById('cq-case-study-noVideoView');
        if (videoElement) {
          videoElement.srcObject = null;
          videoElement.src = videoURL;
          videoElement.controls = true;
          videoElement.muted = false;
          videoElement.style.display = 'block';
          if (noVideoView) noVideoView.style.display = 'none';
        }
        
        const downloadBtn = document.getElementById('cq-case-study-downloadBtn');
        if (downloadBtn && blob) {
          downloadBtn.style.display = 'flex';
          downloadBtn.onclick = function() {
            const url = URL.createObjectURL(blob);
            const filename = `CertQuest_CaseStudy_${Date.now()}.webm`;
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, 100);
          };
        }
        
        const submitBtn = document.getElementById('cq-case-study-submitBtn');
        if (submitBtn) {
          submitBtn.style.display = 'block';
        }
      };
      
      cqCaseStudyMediaRecorder.onerror = (event) => {
        console.error("Case Study MediaRecorder error:", event.error);
        alert("Recording error: " + event.error.message);
        cqCaseStudyIsRecording = false;
      };
    }

    function cqCaseStudyStopAllMedia() {
      if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state !== 'inactive') {
        try {
          cqCaseStudyMediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping recorder:", e);
        }
      }
      
      if (cqCaseStudyMediaStream) {
        cqCaseStudyMediaStream.getTracks().forEach(track => track.stop());
        cqCaseStudyMediaStream = null;
      }
      
      cqCaseStudyMediaRecorder = null;
      cqCaseStudyRecordedChunks = [];
      cqCaseStudyIsRecording = false;
      
      const recordBtn = document.getElementById('cq-case-study-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      const downloadBtn = document.getElementById('cq-case-study-downloadBtn');
      if (downloadBtn) {
        downloadBtn.style.display = 'none';
      }
    }

    function cqCaseStudyStopRecording() {
      if (!cqCaseStudyMediaRecorder || !cqCaseStudyIsRecording) {
        console.log("Cannot stop: no recorder or not recording");
        return;
      }
      
      cqCaseStudyIsIntentionallyStopping = true;
      
      console.log("Stopping case study recording, current state:", cqCaseStudyMediaRecorder.state);
      
      cqCaseStudyIsRecording = false;
      
      if (cqCaseStudyMediaRecorder.state === 'recording') {
        try {
          cqCaseStudyMediaRecorder.requestData();
          cqCaseStudyMediaRecorder.stop();
        } catch (e) {
          console.error("Error stopping recorder:", e);
        }
      }
      
      const recordBtn = document.getElementById('cq-case-study-recordBtn');
      if (recordBtn) {
        recordBtn.classList.remove('recording');
      }
      
      const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
      if (recordingIndicator) {
        recordingIndicator.classList.remove('active');
      }
      
      cqCaseStudyIsIntentionallyStopping = false;
    }

    function toggleCaseStudyRecording() {
      const recordBtn = document.getElementById('cq-case-study-recordBtn');
      if (!recordBtn) return;
      
      if (cqCaseStudyIsRecording) {
        console.log("Stopping case study recording via toggle button");
        cqCaseStudyStopRecording();
      } else {
        console.log("Starting case study recording via toggle button");
        if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
          cqCaseStudyRecordedChunks = [];
          try {
            cqCaseStudyIsRecording = true;
            recordBtn.classList.add('recording');
            
            const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
            if (recordingIndicator) {
              recordingIndicator.classList.add('active');
            }
            
            cqCaseStudyMediaRecorder.start();
            console.log(" Case Study recording started successfully");
          } catch (e) {
            console.error("Error starting recorder:", e);
            alert("Error starting recording: " + e.message);
            cqCaseStudyIsRecording = false;
          }
        } else if (cqCaseStudyMediaStream && !cqCaseStudyMediaRecorder) {
          cqCaseStudySetupRecordingFromStream(cqCaseStudyMediaStream);
          setTimeout(() => {
            if (cqCaseStudyMediaRecorder && cqCaseStudyMediaRecorder.state === 'inactive') {
              cqCaseStudyRecordedChunks = [];
              try {
                cqCaseStudyIsRecording = true;
                recordBtn.classList.add('recording');
                
                const recordingIndicator = document.getElementById('cq-case-study-recordingIndicator');
                if (recordingIndicator) {
                  recordingIndicator.classList.add('active');
                }
                
                cqCaseStudyMediaRecorder.start();
                console.log(" Case Study recording started after setup");
              } catch (e) {
                console.error("Error starting recorder after setup:", e);
                alert("Error starting recording: " + e.message);
                cqCaseStudyIsRecording = false;
              }
            }
          }, 200);
        } else if (!cqCaseStudyMediaStream) {
          cqCaseStudyInitializeVideoPreview();
        } else {
          alert("Recording is already in progress or not ready. Please wait.");
        }
      }
    }
    window.toggleCaseStudyRecording = toggleCaseStudyRecording;

    function closeCaseStudyModal() {
      if (cqCaseStudyTimerInterval) {
        clearInterval(cqCaseStudyTimerInterval);
        cqCaseStudyTimerInterval = null;
      }
      cqCaseStudyTimerActive = false;
      
      cqCaseStudyStopAllMedia();
      
      const modal = document.getElementById('cq-case-study-modal');
      if (modal) {
        modal.style.display = 'none';
      }
    }
    window.closeCaseStudyModal = closeCaseStudyModal;

    async function submitCaseStudyResponse() {
      if (!window.latestAssignmentId || cqCaseStudyRecordedChunks.length === 0) {
        alert("Recording not found or assignment ID missing.");
        return;
      }

      const submitBtn = document.getElementById('cq-case-study-submitBtn');
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
      }

      const blob = new Blob(cqCaseStudyRecordedChunks, { type: 'video/webm' });
      const filename = `${firebase.auth().currentUser.uid}-${Date.now()}.webm`;

      const GITHUB_USERNAME = "Anjay209";
      const GITHUB_REPO = "video-storage";
      const GITHUB_TOKEN = "REDACTED_TOKEN";

      let githubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${filename}`;
      let githubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${filename}`;

      try {
        const base64 = await cqCaseStudyBlobToBase64(blob);

        const uploadRes = await fetch(githubApiUrl, {
          method: 'PUT',
          headers: {
            Authorization: `Bearer ${GITHUB_TOKEN}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Upload ${filename}`,
            content: base64,
            branch: 'main'
          })
        });

        if (!uploadRes.ok) {
          const errData = await uploadRes.json().catch(() => ({}));
          const errorMessage = errData?.message || "GitHub upload failed";
          
          if (uploadRes.status === 409) {
            console.log("File exists, attempting to update with SHA...");
            try {
              const getRes = await fetch(githubApiUrl, {
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Accept': 'application/vnd.github.v3+json'
                }
              });
              
              if (getRes.ok) {
                const existingFile = await getRes.json();
                const updateRes = await fetch(githubApiUrl, {
                  method: 'PUT',
                  headers: {
                    Authorization: `Bearer ${GITHUB_TOKEN}`,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    message: `Update ${filename}`,
                    content: base64,
                    branch: 'main',
                    sha: existingFile.sha
                  })
                });
                
                if (!updateRes.ok) {
                  throw new Error("Failed to update existing file: " + (await updateRes.json().catch(() => ({}))).message);
                }
                console.log("Successfully updated existing file");
              } else {
                throw new Error("Could not get existing file info: " + errorMessage);
              }
            } catch (updateError) {
              console.log("Update failed, using unique filename...");
              const uniqueFilename = `${firebase.auth().currentUser.uid}-${Date.now()}-${Math.random().toString(36).substring(7)}.webm`;
              const uniqueGithubApiUrl = `https://github-proxy.certquest.workers.dev/github/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/docs/videos/${uniqueFilename}`;
              const uniqueGithubPagesUrl = `https://${GITHUB_USERNAME.toLowerCase()}.github.io/${GITHUB_REPO}/docs/videos/${uniqueFilename}`;
              
              const retryRes = await fetch(uniqueGithubApiUrl, {
                method: 'PUT',
                headers: {
                  Authorization: `Bearer ${GITHUB_TOKEN}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  message: `Upload ${uniqueFilename}`,
                  content: base64,
                  branch: 'main'
                })
              });
              
              if (!retryRes.ok) {
                throw new Error("Failed to upload with unique filename: " + (await retryRes.json().catch(() => ({}))).message);
              }
              
              githubPagesUrl = uniqueGithubPagesUrl;
              console.log("Successfully uploaded with unique filename");
            }
          } else {
            throw new Error(errorMessage);
          }
        }

        await firebase.firestore()
          .collection('assignments')
          .doc(window.latestAssignmentId)
          .update({
            status: "complete",
            completedAt: firebase.firestore.FieldValue.serverTimestamp(),
            recordingUrl: githubPagesUrl
          });

        const user = firebase.auth().currentUser;
        const userId = user?.uid;
        const assignmentId = window.latestAssignmentId || window.currentAssignment?.id;
        
        if (userId && assignmentId && typeof assignmentId === 'string' && assignmentId.trim() !== '') {
          try {
            await firebase.firestore()
              .collection('users')
              .doc(userId)
              .collection('assignments')
              .doc(assignmentId)
              .set({
                status: "complete",
                completedAt: firebase.firestore.FieldValue.serverTimestamp(),
                recordingUrl: githubPagesUrl
              }, { merge: true });
          } catch (userUpdateError) {
            console.error("Error updating user assignments:", userUpdateError);
          }
        }

        let competencies = [];
        let assignmentName = 'Case Study';
        try {
          const assignmentDoc = await firebase.firestore()
            .collection('assignments')
            .doc(window.latestAssignmentId)
            .get();
          
          if (assignmentDoc.exists) {
            const assignmentData = assignmentDoc.data();
            competencies = assignmentData.competencies || [];
            assignmentName = assignmentData.title || 'Case Study';
          }
        } catch (error) {
          console.error("Error fetching assignment data:", error);
        }

        showCongratsModal({ 
          score: undefined, 
          totalQuestions: undefined,
          assignmentName: assignmentName,
          competencies: competencies,
          assignmentType: 'case'
        });
        
        closeCaseStudyModal();
      } catch (error) {
        console.error("Upload Error:", error);
        alert("Upload Error: " + error.message);
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Case Study';
        }
      }
    }
    window.submitCaseStudyResponse = submitCaseStudyResponse;

    // ============ ASSIGNMENT MODAL FUNCTIONS ============
    function openFullAssignmentModal(assignment) {
      if (assignment && assignment.id) {
        window.latestAssignmentId = assignment.id;
        window.currentAssignment = assignment;
      }
      
      document.getElementById('cq-assignment-title').innerText = assignment.title || "New Assignment";
      
      document.getElementById('cq-assignment-info').style.display = 'block';
      document.getElementById('cq-assignment-quiz').style.display = 'none';
      
      const fieldsElement = document.getElementById('cq-assignment-fields');
      if (fieldsElement) {
        if (assignment.type === "speaking" || assignment.type === "case") {
          const q1 = assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided";
          const q2 = assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided";
          
          fieldsElement.innerHTML = `
            <div><b>Type:</b> ${assignment.type === "speaking" ? "Speaking" : "Case"} Assignment</div>
            <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
            <div><b>Description:</b> ${assignment.description || 'n/a'}</div>
            <div><b>Questions:</b></div>
            <ul>
              <li>${q1}</li>
              <li>${q2}</li>
            </ul>
          `;
        } else {
          fieldsElement.innerHTML = `
            <div><b>Time:</b> ${assignment.time || 'n/a'}</div>
            <div><b>Competencies:</b> ${assignment.competencies ? assignment.competencies.join(', ') : 'n/a'}</div>
            <div><b>Questions:</b><br> <span style="font-weight:400; color:#333">${assignment.questions || 'n/a'}</span></div>
            <div><b>Difficulty:</b> ${assignment.difficulty || 'n/a'}</div>
            <div><b>Simulate:</b> ${assignment.simulate ? "Yes" : "No"}</div>
          `;
        }
      }
      
      document.getElementById('cq-assignment-modal').style.display = 'block';
    }
    window.openFullAssignmentModal = openFullAssignmentModal;

    function closeAssignmentModal() {
      document.getElementById('cq-assignment-modal').style.display = 'none';
    }
    window.closeAssignmentModal = closeAssignmentModal;

    function snoozeAssignment() {
      closeAssignmentModal();
    }
    window.snoozeAssignment = snoozeAssignment;

    // Circular progress loader functionality
    (function() {
      let progressInterval = null;
      let currentProgress = 0;

      function updateCircularProgress(progress) {
        const fill = document.getElementById('circularProgressFill');
        const text = document.getElementById('circularProgressText');
        
        if (fill && text) {
          const circumference = 2 * Math.PI * 45;
          const offset = circumference - (progress / 100) * circumference;
          fill.style.strokeDashoffset = offset;
          text.textContent = Math.round(progress) + '%';
        }
      }

      function startCircularProgress() {
        currentProgress = 0;
        updateCircularProgress(0);
        
        progressInterval = setInterval(() => {
          currentProgress += 2;
          if (currentProgress > 95) {
            currentProgress = 95;
          }
          updateCircularProgress(currentProgress);
        }, 100);
      }

      function completeCircularProgress() {
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        updateCircularProgress(100);
      }

      function stopCircularProgress() {
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }
        currentProgress = 0;
        updateCircularProgress(0);
      }

      function showLoader() {
        const loader = document.getElementById("assignmentLoader");
        if (loader) {
          loader.style.display = "flex";
          startCircularProgress();
        }
      }
      window.showLoader = showLoader;

      function hideLoader() {
        completeCircularProgress();
        setTimeout(() => {
          stopCircularProgress();
          const loader = document.getElementById("assignmentLoader");
          if (loader) {
            loader.style.display = "none";
          }
        }, 300);
      }
      window.hideLoader = hideLoader;
    })();

    async function acceptAssignmentNow() {
      console.log(" acceptAssignmentNow() called");
      showLoader();

      const assignment = window.currentAssignment;
      console.log(" Current assignment:", assignment);

      if (!assignment) {
        console.error(" No current assignment found");
        hideLoader();
        return;
      }

      if (window.latestAssignmentId) {
        console.log(" Marking assignment as seen");

        const updateData = {
          status: "seen",
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          acceptedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (assignment.type === 'written') {
          updateData.score = 0;
          updateData.maxScore = assignment.writtenQuestions?.length || 10;
        }

        try {
          await db.collection('assignments').doc(window.latestAssignmentId).update(updateData);
          console.log(" Assignment marked as seen successfully");
        } catch (error) {
          console.error(" Error marking assignment as seen:", error);
        }
      }

      if (assignment.type === 'case') {
        console.log(" Opening case study modal for case assignment");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        hideLoader();
        
        window.currentAssignmentQuestions = {
          q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
          q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
          title: assignment.title || "Case Study",
          description: assignment.description || assignment.caseStudyContent || ""
        };
        
        openCaseStudyModal(assignment);
        return;
      }
      
      if (assignment.type === 'speaking') {
        console.log(" Opening speaking modal for speaking assignment");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        hideLoader();
        
        window.currentAssignmentQuestions = {
          q1: assignment.questions && assignment.questions[0] ? assignment.questions[0] : "No question provided",
          q2: assignment.questions && assignment.questions[1] ? assignment.questions[1] : "No question provided",
          title: assignment.title || "Speaking Assignment",
          description: assignment.description || ""
        };
        
        openSpeakingAssignmentModal(assignment);
        return;
      }

      if (assignment.type === 'written') {
        console.log(" Opening written assignment (with GPT if needed)");
        document.getElementById('cq-assignment-modal').style.display = 'none';
        await openWrittenPracticeModal(assignment); 
        return;
      }

      hideLoader();
    }
    window.acceptAssignmentNow = acceptAssignmentNow;

    // ============ WRITTEN ASSIGNMENT FUNCTIONS ============
    function getQuestionCount(timeStr) {
      if (!timeStr) return 10;
      const normalized = timeStr.toString().toLowerCase();
      if (normalized.includes("50")) return 50;
      if (normalized.includes("30")) return 25;
      if (normalized.includes("15")) return 10;
      return 10;
    }

    async function generatePersonalizedQuestionsWithGPT(formData) {
      const questionCount = getQuestionCount(formData.time);
      const competenciesText = formData.competencies.join(', ');

      let prompt = `Generate ${questionCount} FBLA-style multiple choice questions.
- Difficulty: ${formData.difficulty}
- Competencies to cover: ${competenciesText}
- Each question must have exactly 4 options and 1 correct answer
- Questions must be standalone, realistic for FBLA, and never reference "the document", "the text", "as stated", etc.
- Use business, finance, marketing, management, economics, law, and related topics depending on the competencies.`

      prompt += `\n\nReturn ONLY valid JSON array in format:
[
  {
    "text": "Question text?",
    "competency": "Marketing",
    "correctAnswer": "Correct option text",
    "options": ["A", "B", "C", "D"],
    "difficulty": "${formData.difficulty}",
    "source": "gpt_generated"
  }
]`;

      try {
        if (!firebase.functions) {
          throw new Error("Firebase Functions SDK not loaded. Please refresh the page.");
        }
        
        const functions = firebase.functions();
        const generateQuestions = functions.httpsCallable("generateQuestionsWithAI");
        
        const response = await generateQuestions({
          messages: [
            { role: "system", content: `You are an expert FBLA written-competition exam designer.

Your role is to generate ORIGINAL, competition-accurate FBLA-style multiple-choice questions that match the structure, rigor, tone, and professional standards of official FBLA written tests.

You must follow ALL rules below.


CORE FBLA PHILOSOPHY

FBLA written tests assess professional correctness, precision, and applied business literacy.

They do NOT assess creativity, opinion, or open-ended reasoning.

Each question must test exactly ONE concept.

Questions must be concise, objective, and professionally worded.

Avoid unnecessary narrative unless the question type explicitly requires a scenario.


APPROVED FBLA QUESTION ARCHETYPES

Every question MUST clearly belong to ONE of the following archetypes:

1. Definition / Term Identification  
   - Identifying the correct term based on a definition  
   - Selecting the correct meaning of a professional word or concept  

2. Classification / Category Recognition  
   - Determining where an item belongs within a professional category system  
   - Examples include document types, account categories, system types, business forms, or classifications  

3. Procedural / Workflow Knowledge  
   - Understanding the stages of a professional workflow specific to the competition area  
   - Identifying where information originates within that workflow  
   - Determining which document, tool, or action is appropriate at a given stage  
   - Recognizing correct sequencing of professional tasks within the domain  

4. Tool-to-Function Matching  
   - Matching software features, commands, utilities, or tools to their correct purpose  
   - Selecting the correct function used to accomplish a professional task  

5. Quantitative / Calculation Application  
   - Performing single-step or limited multi-step calculations  
   - Selecting the correct numeric result based on provided data  
   - Avoid unnecessary complexity or advanced math  

6. Language Precision & Usage  
   - Correct use of professional vocabulary  
   - Distinguishing homophones, word meanings, spelling, grammar, and standard usage  

7. Error Detection / Exception Identification  
   - Identifying what is incorrect, misspelled, or does NOT belong  
   - Using negation ("NOT") carefully and intentionally  


QUESTION STRUCTURE RULES

 Each question must assess ONE idea only.  
 Do not combine multiple concepts in one question.  
 Avoid ambiguous wording.  
 Use professional, neutral language.

Acceptable stem styles include:
- "Which of the following"
- "What term best describes"
- "The document used to"
- "Which action should be taken"
- "Which of the following is NOT"


ANSWER CHOICE DESIGN (CRITICAL)

Each question MUST include exactly FOUR answer choices.

Answer choices must:
 Be the same grammatical form  
 Be similar in length  
 Belong to the same conceptual family  

Wrong answer choices (distractors) must be plausible and realistic.

Allowed distractor strategies include:
 Closely related terms within the same category  
 Common student misconceptions  
 Incorrect step within a workflow  
 Reversed or misapplied professional rules  
 Visually or linguistically similar words  
 Typical calculation or classification errors  

Never include joke answers or obviously incorrect options.


DIFFICULTY CALIBRATION

Easy:
 Direct recall or recognition  
 Minimal traps  

Medium:
 Requires discrimination between similar concepts  
 Includes common misconceptions  

Hard:
 Includes negation ("NOT")  
 Requires precise rule awareness  
 Uses subtle wording differences  
 Penalizes shallow memorization  


CONTENT INTEGRITY RULES

 All questions must be ORIGINAL.  
 Do NOT copy real FBLA questions.  
 Do NOT closely paraphrase known questions.  
 Use authentic structure only, not replicated wording.

Questions must feel realistic for competitive FBLA written events at the regional, state, or national level.

When study materials are provided, extract concepts, facts, names, dates, laws, and details from them. Present this information as established business knowledge. NEVER mention "the study guide", "the document", "the material", or use phrases like "according to", "as stated in", or "mentioned in".


OUTPUT REQUIREMENTS

 Generate ONLY the requested number of questions.  
 Each question must have exactly four answer options.  
 Only ONE option may be correct.  
 Output valid JSON only.  
 Do not include explanations, commentary, or headings.  

You are writing as a professional exam author  not as a tutor or teacher.` },
            { role: "user", content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt }
          ]
        });

        const data = response.data;
        let content = data.content || data.choices?.[0]?.message?.content || data;
        
        if (typeof content !== 'string') {
          content = JSON.stringify(content);
        }
        
        content = content.trim();
        content = content.replace(/```json|```/g, "");
        const jsonStart = content.indexOf('[');
        const jsonEnd = content.lastIndexOf(']') + 1;
        
        if (jsonStart !== -1 && jsonEnd > jsonStart) {
          content = content.slice(jsonStart, jsonEnd);
        }
        
        const generated = JSON.parse(content);
        console.log(` Generated ${generated.length} GPT questions`);
        return generated;

      } catch (err) {
        console.error(" GPT error:", err);
        return getFallbackQuestions(questionCount, formData.competencies);
      }
    }

    function getFallbackQuestions(count, competencies) {
      const fallbackQuestions = [
        {
          text: "What is the primary purpose of parliamentary procedure?",
          competency: "Parliamentary Procedure",
          correctAnswer: "To make meetings more efficient",
          options: [
            "To make meetings more efficient",
            "To give the president more power",
            "To eliminate debate",
            "To make meetings longer"
          ]
        },
        {
          text: "Which motion is used to end a meeting?",
          competency: "Parliamentary Procedure",
          correctAnswer: "Adjourn",
          options: ["Adjourn", "Recess", "Postpone", "Table"]
        },
        {
          text: "What is the most effective way to communicate in business?",
          competency: "Business Communication",
          correctAnswer: "Clear and concise messaging",
          options: [
            "Clear and concise messaging",
            "Using complex terminology",
            "Lengthy detailed explanations",
            "Informal casual language"
          ]
        }
      ];
      
      const result = [];
      for (let i = 0; i < count; i++) {
        result.push(fallbackQuestions[i % fallbackQuestions.length]);
      }
      return result;
    }

    async function openWrittenPracticeModal(assignment) {
      console.log("Opening written practice modal with assignment:", assignment);

      try {
        currentQuestionIndex = 0;
        writtenAnswers = {};
        if (!window.writtenAnswers) {
          window.writtenAnswers = {};
        }

        const timeInMinutes = parseInt(assignment.time) || 15;
        writtenTimeRemaining = timeInMinutes * 60;

        if (window.writtenQuestions && window.writtenQuestions.length > 0) {
          console.log(" Using window.writtenQuestions from create your own flow");
          writtenQuestions = window.writtenQuestions;
        } else if (assignment.writtenQuestions && assignment.writtenQuestions.length > 0) {
          writtenQuestions = assignment.writtenQuestions;
          window.writtenQuestions = assignment.writtenQuestions;
        } else {
          console.log(" No preloaded questions, generating via GPT...");
          assignment.writtenQuestions = await generatePersonalizedQuestionsWithGPT({
            time: assignment.time || "15 mins",
            difficulty: assignment.difficulty || "Medium",
            competencies: assignment.competencies || ["General"],
            type: "written"
          });
          writtenQuestions = assignment.writtenQuestions;
          window.writtenQuestions = assignment.writtenQuestions;
        }

        console.log(" Written questions ready:", writtenQuestions);

        const modal = document.getElementById('quizModal');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        createQuizStars();
        loadWrittenQuestion();
        startWrittenTimer();

      } catch (err) {
        console.error(" Error in openWrittenPracticeModal:", err);
        alert("Could not load written practice. Please try again.");
      } finally {
        hideLoader();
        console.log(" Loader hidden inside openWrittenPracticeModal");
      }
    }
    window.openWrittenPracticeModal = openWrittenPracticeModal;

    function loadWrittenQuestion() {
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      const question = questions[currentQuestionIndex];
      if (!question) {
        console.error("No question found at index", currentQuestionIndex);
        return;
      }

      const assignmentTitle = window.currentAssignment?.title || 'Written Practice';
      const difficulty = window.currentAssignment?.difficulty || 'Easy';
      document.getElementById('quizTitle').textContent = `${difficulty} ${assignmentTitle}`;
      document.getElementById('quizProgress').textContent = 
        `Question ${currentQuestionIndex + 1} of ${questions.length}`;
      
      document.getElementById('questionCompetency').textContent = question.competency || 'General';
      const questionTextEl = document.getElementById('questionText');
      questionTextEl.textContent = question.question || question.text;
      questionTextEl.style.color = '#fff';
      
      const optionsContainer = document.getElementById('optionsContainer');
      const answers = window.writtenAnswers || writtenAnswers;
      const previousAnswer = answers[currentQuestionIndex];
      
      optionsContainer.innerHTML = question.options.map((option, index) => {
        const isSelected = previousAnswer === option;
        return `
          <button class="practice-quiz-option-btn ${isSelected ? 'selected' : ''}" data-option="${option}">
            <div class="practice-quiz-option-radio ${isSelected ? 'selected' : ''}">
              ${isSelected ? '<div class="practice-quiz-option-dot"></div>' : ''}
            </div>
            <span class="practice-quiz-option-text">${option}</span>
          </button>
        `;
      }).join('');
      
      const optionButtons = optionsContainer.querySelectorAll('.practice-quiz-option-btn');
      optionButtons.forEach(optionBtn => {
        optionBtn.addEventListener('click', function(e) {
          optionButtons.forEach(opt => {
            opt.classList.remove("selected");
            const radio = opt.querySelector('.practice-quiz-option-radio');
            radio.classList.remove("selected");
            radio.innerHTML = '';
          });
          
          this.classList.add('selected');
          const radio = this.querySelector('.practice-quiz-option-radio');
          radio.classList.add('selected');
          radio.innerHTML = '<div class="practice-quiz-option-dot"></div>';
          
          const selectedOption = this.getAttribute('data-option');
          writtenAnswers[currentQuestionIndex] = selectedOption;
          if (!window.writtenAnswers) window.writtenAnswers = {};
          window.writtenAnswers[currentQuestionIndex] = selectedOption;
        });
      });

      updateWrittenProgress();
      updateWrittenNavButtons();
    }
    window.loadWrittenQuestion = loadWrittenQuestion;

    function updateWrittenProgress() {
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      const progressEl = document.getElementById('quizProgress');
      if (progressEl) {
        progressEl.textContent = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
      }
    }

    function updateWrittenNavButtons() {
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      const prevBtn = document.getElementById('quizPrevBtn');
      const nextBtn = document.getElementById('quizNextBtn');
      const submitBtn = document.getElementById('quizSubmitBtn');
      
      if (prevBtn) {
        prevBtn.disabled = currentQuestionIndex === 0;
      }
      
      if (nextBtn) {
        if (currentQuestionIndex < questions.length - 1) {
          nextBtn.style.display = 'block';
          submitBtn.style.display = 'none';
        } else {
          nextBtn.style.display = 'none';
          submitBtn.style.display = 'block';
        }
      }
      
      // Update progress
      const progressPercent = Math.round(((currentQuestionIndex + 1) / questions.length) * 100);
      document.getElementById('progressPercent').textContent = progressPercent;
      document.getElementById('progressFill').style.width = progressPercent + '%';
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        loadWrittenQuestion();
      }
    }
    window.previousQuestion = previousQuestion;

    function nextQuestion() {
      const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        loadWrittenQuestion();
      } else {
        submitWrittenPractice();
      }
    }
    window.nextQuestion = nextQuestion;

    function startWrittenTimer() {
      if (writtenTimer) {
        clearInterval(writtenTimer);
      }
      
      writtenTimer = setInterval(() => {
        if (writtenTimeRemaining > 0) {
          writtenTimeRemaining--;
          updateTimerDisplay();
        } else {
          clearInterval(writtenTimer);
          alert('Time is up! Submitting your answers...');
          submitWrittenPractice();
        }
      }, 1000);
      
      updateTimerDisplay();
    }

    function updateTimerDisplay() {
      const timerEl = document.getElementById('quizTimer');
      if (timerEl) {
        const mins = Math.floor(writtenTimeRemaining / 60);
        const secs = writtenTimeRemaining % 60;
        timerEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      }
    }

    async function submitWrittenPractice() {
      try {
        console.log("=== SUBMITTING WRITTEN PRACTICE ===");
        clearInterval(writtenTimer);
        
        if (!window.latestAssignmentId) {
          console.error("No assignment ID found");
          alert("Error: Assignment ID not found. Please try again.");
          return;
        }

        const questions = window.writtenQuestions && window.writtenQuestions.length > 0 ? window.writtenQuestions : writtenQuestions;
        const answers = window.writtenAnswers || writtenAnswers;
        
        let score = 0;
        const competencyStats = {};
        
        questions.forEach((q, idx) => {
          const userAnswer = answers[idx];
          const isCorrect = userAnswer === q.correctAnswer;
          
          if (isCorrect) {
            score++;
          }
          
          const comp = q.competency || "General";
          if (!competencyStats[comp]) {
            competencyStats[comp] = { correct: 0, total: 0 };
          }
          competencyStats[comp].total++;
          if (isCorrect) {
            competencyStats[comp].correct++;
          }
        });

        await db.collection('assignments').doc(window.latestAssignmentId).update({
          status: "complete",
          completedAt: firebase.firestore.FieldValue.serverTimestamp(),
          score: score,
          maxScore: questions.length,
          answers: answers
        });

        const user = firebase.auth().currentUser;
        if (user) {
          await db.collection('users').doc(user.uid).collection('assignments').doc(window.latestAssignmentId).set({
            status: 'completed',
            submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
            score: score,
            maxScore: questions.length
          }, { merge: true });
        }

        document.getElementById('quizModal').style.display = 'none';
        document.body.style.overflow = 'auto';

        let assignmentName = 'Written Practice';
        try {
          const assignmentDoc = await db.collection('assignments').doc(window.latestAssignmentId).get();
          if (assignmentDoc.exists) {
            assignmentName = assignmentDoc.data().title || 'Written Practice';
          }
        } catch (error) {
          console.error("Error fetching assignment name:", error);
        }

        showCongratsModal({
          score: score,
          totalQuestions: questions.length,
          assignmentName: assignmentName,
          competencyStats: competencyStats,
          assignmentType: 'written'
        });

      } catch (error) {
        console.error("Error submitting written practice:", error);
        alert("Error submitting practice. Please try again.");
      }
    }
    window.submitWrittenPractice = submitWrittenPractice;

    // ============ QUIZ FUNCTIONS ============
    function renderQuiz(questionsArr) {
      const quizContainer = document.getElementById('quizQuestions');
      quizContainer.innerHTML = questionsArr.map((q, idx) => `
        <div class="quiz-question" data-competency="${q.competency}">
          <h4>${idx + 1}. ${q.text}</h4>
          ${q.options.map(opt => `
            <label class="quiz-option">
              <input type="radio" name="q${idx+1}" value="${opt}"> ${opt}
            </label>
          `).join('')}
        </div>
      `).join('');
    }
    window.renderQuiz = renderQuiz;

    function createQuizStars() {
      const starsContainer = document.getElementById('quizStarsContainer');
      if (!starsContainer) return;
      
      starsContainer.innerHTML = '';
      
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'practice-quiz-star';
        
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.9 + 0.3;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
        star.style.animationDelay = delay + 's';
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
        
        starsContainer.appendChild(star);
      }
    }
    window.createQuizStars = createQuizStars;

    function closeQuizModal() {
      const modal = document.getElementById('quizModal');
      if (modal) {
        modal.style.display = 'none';
      }
      document.body.style.overflow = 'auto';
      if (writtenTimer) {
        clearInterval(writtenTimer);
      }
    }
    window.closeQuizModal = closeQuizModal;

    function submitQuiz() {
      const quizContainer = document.getElementById('quizQuestions');
      const questions = Array.from(quizContainer.querySelectorAll('.quiz-question'));
      let score = 0;
      const answers = {};
      
      questions.forEach((qEl, idx) => {
        const selected = qEl.querySelector('input[type="radio"]:checked');
        if (selected) {
          answers[idx] = selected.value;
        }
      });
      
      document.getElementById('quizModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      
      showCongratsModal({
        score: score,
        totalQuestions: questions.length,
        assignmentName: 'Quiz',
        assignmentType: 'quiz'
      });
    }
    window.submitQuiz = submitQuiz;

    // ============ CONGRATULATIONS MODAL ============
    function showCongratsModal(results) {
      const modal = document.getElementById('congratsModal');
      
      if (!modal) {
        alert(results.message || `Congratulations! ${results.assignmentName || 'Assignment'} completed successfully!`);
        return;
      }
      
      if (results.assignmentType === 'case') {
        const titleEl = document.getElementById('congratsTitle');
        const scoreEl = document.getElementById('congratsScore');
        const subtitleEl = document.getElementById('congratsSubtitle');
        const assignmentNameEl = document.getElementById('congratsAssignmentName');
        const competenciesContainer = document.getElementById('congratsCompetencies');
        
        if (titleEl) titleEl.textContent = 'Congratulations!';
        if (scoreEl) scoreEl.textContent = '';
        if (subtitleEl) subtitleEl.style.display = 'none';
        if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Case Study';
        
        if (competenciesContainer) {
          if (results.competencies && results.competencies.length > 0) {
            competenciesContainer.innerHTML = results.competencies.map(comp => {
              return `
                <div class="congrats-competency-item">
                  <div class="congrats-competency-header">
                    <span class="congrats-competency-name">${comp}</span>
                  </div>
                </div>
              `;
            }).join('');
          } else {
            competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
          }
        }
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        createCongratsStars();
        return;
      }
      
      if (results.assignmentType === 'speaking' || (results.message && !results.score && !results.totalQuestions)) {
        const titleEl = document.getElementById('congratsTitle');
        const scoreEl = document.getElementById('congratsScore');
        const subtitleEl = document.getElementById('congratsSubtitle');
        const assignmentNameEl = document.getElementById('congratsAssignmentName');
        const competenciesContainer = document.getElementById('congratsCompetencies');
        
        if (titleEl) titleEl.textContent = 'Congratulations!';
        if (scoreEl) scoreEl.textContent = '';
        if (subtitleEl) {
          subtitleEl.style.display = 'block';
          subtitleEl.innerHTML = results.message || 'Assignment submitted successfully!';
        }
        if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Assignment';
        
        if (competenciesContainer) {
          if (results.competencies && results.competencies.length > 0) {
            competenciesContainer.innerHTML = results.competencies.map(comp => {
              return `
                <div class="congrats-competency-item">
                  <div class="congrats-competency-header">
                    <span class="congrats-competency-name">${comp}</span>
                  </div>
                </div>
              `;
            }).join('');
          } else {
            competenciesContainer.innerHTML = '';
          }
        }
        
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        createCongratsStars();
        return;
      }
      
      const percentage = results.percentage || (results.score && results.totalQuestions ? Math.round((results.score / results.totalQuestions) * 100) : 0);
      
      const titleEl = document.getElementById('congratsTitle');
      const scoreEl = document.getElementById('congratsScore');
      const subtitleEl = document.getElementById('congratsSubtitle');
      const assignmentNameEl = document.getElementById('congratsAssignmentName');
      const competenciesContainer = document.getElementById('congratsCompetencies');
      
      if (titleEl) titleEl.textContent = 'Congratulations!';
      if (scoreEl && results.score !== undefined && results.totalQuestions !== undefined) {
        scoreEl.textContent = `${results.score}/${results.totalQuestions}`;
      }
      if (subtitleEl) {
        subtitleEl.style.display = 'block';
        if (results.score !== undefined && results.totalQuestions !== undefined) {
          subtitleEl.innerHTML = 
            `Excellent work! You scored <span id="congratsScoreSpan" style="background: linear-gradient(to right, #ef4444, #f97316, #eab308); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; font-size: 1.75rem;">${results.score}/${results.totalQuestions}</span>`;
        } else if (results.message) {
          subtitleEl.innerHTML = results.message;
        }
      }
      
      if (assignmentNameEl) assignmentNameEl.textContent = results.assignmentName || 'Written Practice';
      
      if (competenciesContainer) {
        if (results.competencyStats && Object.keys(results.competencyStats).length > 0) {
          competenciesContainer.innerHTML = Object.entries(results.competencyStats).map(([comp, stats]) => {
            const percentage = Math.round((stats.correct / stats.total) * 100);
            const isFull = stats.correct === stats.total;
            return `
              <div class="congrats-competency-item">
                <div class="congrats-competency-header">
                  <span class="congrats-competency-name">${comp}</span>
                  <span class="congrats-competency-score">${stats.correct}/${stats.total} correct</span>
                </div>
                <div class="congrats-competency-progress-bar">
                  <div class="congrats-competency-progress-fill ${isFull ? 'full' : ''}" style="width: ${percentage}%"></div>
                </div>
              </div>
            `;
          }).join('');
        } else {
          competenciesContainer.innerHTML = '<p style="color: #94a3b8; text-align: center;">No competency breakdown available</p>';
        }
      }
      
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      createCongratsStars();
    }
    window.showCongratsModal = showCongratsModal;

    function createCongratsStars() {
      const starsContainer = document.getElementById('congratsStarsContainer');
      if (!starsContainer) return;
      
      starsContainer.innerHTML = '';
      
      for (let i = 0; i < 200; i++) {
        const star = document.createElement('div');
        star.className = 'practice-quiz-star';
        
        const size = Math.random() * 3 + 0.5;
        const duration = Math.random() * 4 + 2;
        const delay = Math.random() * 2;
        const randomLeft = Math.random() * 100;
        const randomTop = Math.random() * 100;
        const randomOpacity = Math.random() * 0.9 + 0.3;
        
        star.style.width = size + 'px';
        star.style.height = size + 'px';
        star.style.left = randomLeft + '%';
        star.style.top = randomTop + '%';
        star.style.opacity = randomOpacity;
        star.style.animation = `practice-quiz-twinkle ${duration}s ease-in-out infinite`;
        star.style.animationDelay = delay + 's';
        star.style.boxShadow = `0 0 ${size * 2}px rgba(255, 255, 255, 0.8)`;
        
        starsContainer.appendChild(star);
      }
    }
    window.createCongratsStars = createCongratsStars;

    function closeCongratsModal() {
      const modal = document.getElementById('congratsModal');
      if (modal) {
        modal.style.display = 'none';
      }
      document.body.style.overflow = 'auto';
    }
    window.closeCongratsModal = closeCongratsModal;

    // ============ MOBILE NAVIGATION ============
    window.toggleMobileNav = function() {
      const nav = document.getElementById('mainNav');
      const hamburger = document.getElementById('hamburgerMenu');
      
      if (nav && hamburger) {
        nav.classList.toggle('active');
        hamburger.classList.toggle('active');
        document.body.style.overflow = nav.classList.contains('active') ? 'hidden' : '';
      }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.blaze-nav .nav-link').forEach(link => {
        link.addEventListener('click', () => {
          if (window.innerWidth <= 768) {
            toggleMobileNav();
          }
        });
      });
    });

    // ============ MENTOR LINK LOGIC ============
    auth.onAuthStateChanged(function(user) {
      if (user) {
        db.collection('users').doc(user.uid).get().then(doc => {
          if (doc.exists) {
            const userData = doc.data();
            const mentorNavLink = document.getElementById('mentorNavLink');
            if (mentorNavLink) {
              if (userData.isMentor === true) {
                mentorNavLink.style.display = 'block';
              } else {
                mentorNavLink.style.display = 'none';
              }
            }
          }
        }).catch(error => {
          console.error("Error checking mentor status:", error);
        });
      }
    });

    console.log(" Firebase initialized and script loaded successfully");
  </script>
</body>
</html>