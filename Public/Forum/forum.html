<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CertQuest Dashboard</title>
  <link rel="stylesheet" href="forum.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>
  
</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">üåê</div>
    <div class="nav-title">Dashboard <span class="new-badge">(New!)</span></div>
    <div class="nav-right">
      <div class="search-container" style="position:relative;">
        <input type="text" id="navbarSearch" placeholder="Search CertQuest..." autocomplete="off" />
        <span class="search-icon" id="navbarSearchIcon">üîç</span>
        <div id="searchDropdown"></div>
      </div>
    </div>
  </div>

  <!-- Section Header -->
  <div class="section-header-background glassmorphic">
        <div class="gradient-blob-1"></div>
<div class="gradient-blob-2"></div>
    <div class="section-header-content">
      <h1 class="unit-title"><span class="name">Competitions Forum</span></h1>
      <div class="recent-questions">

        <div class="question-tabs glassmorphic">
          <div class="tab active">Not Solved</div>
          <div class="tab">Solved</div>
          <div class="tab">All</div>
        </div>
        <div class="tab-underline"></div>
      </div>
    </div>
  </div>

  <div class="main-layout">
    <aside class="sidebar">
      <div class="logo">CQ</div>
      <ul class="nav-icons">
  <li>
     <a href="/Public/home.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3L20 9V21H15V15H9V21H4V9L12 3Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M12 3L4 9V21H9V15H15V21H20V9L12 3Z" stroke="#3b82f6" stroke-width="2" fill="none" stroke-linejoin="round"/>
      <rect x="10" y="17" width="4" height="4" fill="#3b82f6"/>
      <rect x="6" y="11" width="2" height="2" fill="#3b82f6"/>
      <rect x="16" y="11" width="2" height="2" fill="#3b82f6"/>
    </svg>
    
    <span class="nav-label">Home</span>
     </a>
  </li>
  <li>
  <a href="javascript:void(0)" onclick="toggleCommentPanel()">  
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Bell body main fill -->
      <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" fill="#3b82f6" fill-opacity="0.3"/>
      
      <!-- Bell body lighter overlay -->
      <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 12 6 15 6 15H18C18 15 18 12 18 8Z" fill="#3b82f6" fill-opacity="0.2"/>
      
      <!-- Bell outline -->
      <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
      
      <!-- Bell clapper -->
      <circle cx="12" cy="8" r="1" fill="#3b82f6"/>
      
      <!-- Sound waves -->
      <path d="M19 4L20 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
      <path d="M20.5 6.5L22 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
      <path d="M5 4L4 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
      <path d="M3.5 6.5L2 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
      
      <!-- Bottom notification indicator -->
      <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Notifications</span>
  </a>
</li>
  <li>
    <a href="/practice.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="9" fill="#3b82f6" fill-opacity="0.3"/>
      <circle cx="12" cy="12" r="6" fill="#3b82f6" fill-opacity="0.2"/>
      <circle cx="12" cy="12" r="9" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <circle cx="12" cy="12" r="6" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="3" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="1.5" fill="#3b82f6"/>
      <path d="M16 8L12 12L16 8Z" fill="#3b82f6"/>
      <line x1="16" y1="8" x2="19" y2="5" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Practice</span>
    </a>
  </li>
  <li>
    <a href="/Public/Forum/forum.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" fill="#3b82f6" fill-opacity="0.2"/>
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <line x1="11" y1="8" x2="17" y2="8" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="11" y1="10" x2="15" y2="10" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Forum</span>
    </a>
  </li>
  <li>
     <a href="/Public/Calendar/calendar.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="3" y="6" width="18" height="15" rx="2" fill="#3b82f6" fill-opacity="0.3"/>
      <rect x="3" y="6" width="18" height="4" rx="2" fill="#3b82f6" fill-opacity="0.2"/>
      <rect x="3" y="6" width="18" height="15" rx="2" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <line x1="7" y1="3" x2="7" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="17" y1="3" x2="17" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="10" x2="21" y2="10" stroke="#3b82f6" stroke-width="1" opacity="0.5"/>
      <line x1="7.5" y1="10" x2="7.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="12" y1="10" x2="12" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="16.5" y1="10" x2="16.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <circle cx="9" cy="13" r="1" fill="#3b82f6"/>
      <circle cx="15" cy="16" r="1" fill="#3b82f6"/>
      <circle cx="12" cy="18" r="1" fill="#3b82f6"/>
    </svg>
    <span class="nav-label">Calendar</span>
     </a>
  </li>
</ul>
    </aside>
    <main class="content">
      <div class="forum-wrapper">
        <div class="forum-main">

          <!-- Ask Box -->
          <div class="ask-box">
            <div class="ask-avatar-wrapper">
              <img src="/Public/assets/duckpfp.jpg" alt="User avatar" class="ask-avatar" />
              <div class="online-dot"></div>
            </div>
            <button id="askQuestionBtn" class="ask-input" type="button">Ask a question...</button>
          </div>
<br><br>
          <!-- Modal Overlay -->
         

          <!-- Posts will render here by JS -->
        </div>
        <!-- Forum-main ends -->
        <!-- Side Panel -->
        <aside class="forum-info-panel">
            <div class="stats-box">
  <div class="stats-header">
    <h3>FBLA Forum</h3>
    <span class="info-icon">‚ìò</span>
  </div>
  <p class="stats-description">
    Ask questions about your competition, studying, and anything FBLA-related!
  </p>
  <ul class="guidelines">
    <li>Be specific about the event or topic you're asking about.</li>
    <li>Share your study methods or project progress when possible.</li>
    <li>Use üôå or üí¨ to show appreciation or start discussions.</li>
  </ul>
  <div class="stats-grid">
    <div class="stat">
      <div class="value posts-count">2064</div>
      <div class="label">Posts</div>
    </div>
    <div class="stat">
      <div class="value members-count">0</div>
      <div class="label">Members</div>
    </div>
  </div>
</div>

          <br>
          <div class="stats-box">
            <div class="stats-header">
              <h3>Stats</h3>
              <span class="info-icon">‚ìò</span>
            </div>
            <div class="stats-grid">
              <div class="stat">
  <div class="value solved-percent">0%</div>
  <div class="label">Solved</div>
</div>
              <div class="stat full">
                <div class="response-line">
                  <span class="value">0 min</span>
                </div>
                <div class="label">Median Response Time</div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- COMMENT PANEL -->



   <div id="questionModal" class="modal hidden" tabindex="-1">
            <div class="modal-content">
              <button class="close-btn" id="closeModal" aria-label="Close modal">&times;</button>
              <h2>I have a question!</h2>
             
              <p class="help-prompt">What do you need help with today?</p>
              <div class="options">
                <button class="option-btn" data-type="quick">
                  ‚ùì I have a quick question about a problem (&lt;10 minutes)
                </button>
                <button class="option-btn" data-type="assignment">
                  üìÑ I need help with an assignment (10‚Äì30 minutes)
                </button>
                <button class="option-btn" data-type="review">
                  üìö I want to review a topic / learn a new topic (30‚Äì90 minutes)
                </button>
              </div>
              <div class="expanded-form hidden">
                <label>
                  <strong>Share your problem:</strong>
                  <textarea placeholder="E.g., I'm trying to solve 4x+2=3 for x..."></textarea>
                </label>
                <label>
                  <strong>What have you tried so far?</strong>
                  <textarea placeholder="E.g., I tried subtracting 2 but got confused..."></textarea>
                </label>
                <label class="zoom-check">
                  <input type="checkbox" checked />
                  Yes, request Zoom help!
                </label>
                <p class="disclaimer">
                  By posting, you agree that you're here to learn. Pressuring others to do your homework may lead to suspension.
                </p>
              </div>
              <div class="actions">
                <button class="cancel-btn">Cancel</button>
                <button class="post-btn" disabled>Post</button>
              </div>
            </div>
          </div>
          <!-- End Modal -->

          <div class="comment-panel hidden" id="commentPanel">
  <div class="comment-header">
    <span class="comment-title">Entry Details</span>
    <button class="close-btn" onclick="toggleCommentPanel()">‚úï</button>
  </div>
  <div class="comment-content">
    <div class="comments-thread" id="commentsThread">
      <!-- Comments get injected here -->
    </div>
  </div>
  <div class="reply-container">
    <textarea placeholder="Reply..." class="reply-box"></textarea>
  </div>
</div>

<!-- Notification Modal -->
<div id="notificationModal" class="notification-modal hidden">
  <div class="notification-content">
    <p>Post marked as resolved!</p>
    <button id="closeNotificationBtn">Close</button>
  </div>
</div>

<!-- XP Notification Modal -->
<div id="xpNotificationModal" class="notification-modal hidden" style="background: rgba(0,0,0,0.8);">
  <div class="notification-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
    <p id="xpNotificationText">+20 XP earned!</p>
    <button id="closeXpNotificationBtn" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">Awesome!</button>
  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", () => {
    // --------- FIREBASE INIT ---------
    const firebaseConfig = {
      apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
      authDomain: "certquest-94959.firebaseapp.com",
      projectId: "certquest-94959",
      storageBucket: "certquest-94959.appspot.com",
      messagingSenderId: "323956529033",
      appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
      measurementId: "G-F5JHTGGN6K"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();

    // --------- AUTH STATE ---------
    window.currentUser = null;
    let currentFilter = "not solved";  // track current tab/filter

    firebase.auth().onAuthStateChanged(async (user) => {
      window.currentUser = user;
      if (user) {
        console.log("[CQ] Signed in:", user.email || user.displayName);
      } else {
        console.log("[CQ] Not signed in");
      }
      await loadForumQuestions(currentFilter);
      await updatePostCount();
      await updateMemberCount();
      await updateSolvedPercentage();
      await updateMedianResponseTime();
    });

    // --------- XP SYSTEM FUNCTIONS ---------
    async function awardXP(userId, amount, reason) {
      try {
        const userRef = db.collection('users').doc(userId);
        const userDoc = await userRef.get();
        
        if (userDoc.exists) {
          // User document exists, increment XP
          await userRef.update({
            XP: firebase.firestore.FieldValue.increment(amount)
          });
        } else {
          // User document doesn't exist, create it with initial XP
          await userRef.set({
            XP: amount
          });
        }
        
        console.log(`[CQ] Awarded ${amount} XP to user ${userId} for ${reason}`);
        showXPNotification(amount, reason);
        
      } catch (error) {
        console.error("[CQ] Failed to award XP:", error);
      }
    }

    function showXPNotification(amount, reason) {
      const modal = document.getElementById("xpNotificationModal");
      const textElem = document.getElementById("xpNotificationText");
      
      let message = `+${amount} XP earned!`;
      if (reason === 'posting') {
        message = `üéâ +${amount} XP for posting a question!`;
      } else if (reason === 'commenting') {
        message = `üí¨ +${amount} XP for helping out!`;
      }
      
      textElem.textContent = message;
      modal.classList.remove("hidden");

      // Auto-close after 3 seconds
      setTimeout(() => {
        modal.classList.add("hidden");
      }, 3000);
    }

    // Close XP notification manually
    document.getElementById("closeXpNotificationBtn").addEventListener("click", () => {
      document.getElementById("xpNotificationModal").classList.add("hidden");
    });

    // --------- MODAL OPEN/CLOSE ---------
    const openBtn = document.getElementById("askQuestionBtn");
    const modal = document.getElementById("questionModal");
    const closeBtn = document.getElementById("closeModal");
    const cancelBtn = document.querySelector(".cancel-btn");
    if (openBtn && modal) openBtn.onclick = () => modal.classList.remove("hidden");
    if (closeBtn && modal) closeBtn.onclick = () => modal.classList.add("hidden");
    if (cancelBtn && modal) cancelBtn.onclick = () => modal.classList.add("hidden");
    if (modal) {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) modal.classList.add("hidden");
      });
    }

    // --------- OPTION SELECTION & FORM SHOW ---------
    const optionButtons = document.querySelectorAll('.option-btn');
    const expandedForm = document.querySelector('.expanded-form');
    optionButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        optionButtons.forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        expandedForm.classList.remove('hidden');
        checkFormCompletion();
      });
    });

    // --------- POST BUTTON ENABLE/DISABLE ---------
    const textareas = expandedForm.querySelectorAll("textarea");
    const postBtn = document.querySelector(".post-btn");
    function checkFormCompletion() {
      const hasText = Array.from(textareas).some(t => t.value.trim().length > 0);
      const optionSelected = document.querySelector('.option-btn.selected');
      if (hasText && optionSelected) {
        postBtn.removeAttribute("disabled");
      } else {
        postBtn.setAttribute("disabled", true);
      }
    }
    textareas.forEach(t => t.addEventListener("input", checkFormCompletion));
    checkFormCompletion();

    // --------- GET USER PROFILE ---------
    async function getUserProfile() {
      const user = window.currentUser;
      if (!user) return null;
      let name = user.displayName || (user.email ? user.email.split("@")[0] : "Anonymous");
      let photo = user.photoURL || "";
      try {
        const snap = await db.collection("users").doc(user.uid).get();
        if (snap.exists && snap.data().name) name = snap.data().name;
        if (snap.exists && snap.data().photoURL) photo = snap.data().photoURL;
      } catch {}
      return { name, photo, uid: user.uid };
    }

    // --------- POST QUESTION ---------
    postBtn.addEventListener("click", async () => {
      const selected = document.querySelector('.option-btn.selected');
      const helpType = selected ? selected.textContent.trim() : '';
      const [questionTextarea, triedTextarea] = expandedForm.querySelectorAll('textarea');
      const question = questionTextarea.value.trim();
      const tried = triedTextarea.value.trim();
      const requestZoom = expandedForm.querySelector('input[type=checkbox]').checked;

      if (!helpType || !question) return;

      const user = await getUserProfile();
      if (!user) {
        alert("You must be signed in to post!");
        return;
      }

      await db.collection("forum-questions").add({
        userId: user.uid,
        userName: user.name,
        userPhoto: user.photo,
        helpType,
        question,
        tried,
        requestZoom,
        solved: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Award 20 XP for posting a question
      await awardXP(user.uid, 20, 'posting');

      // Reset modal and form
      modal.classList.add("hidden");
      questionTextarea.value = '';
      triedTextarea.value = '';
      expandedForm.classList.add('hidden');
      postBtn.setAttribute("disabled", true);
      optionButtons.forEach(b => b.classList.remove("selected"));

      await loadForumQuestions(currentFilter);

      // Update stats after new post
      await updatePostCount();
      await updateSolvedPercentage();
      await updateMedianResponseTime();
    });

    // --------- LOAD FORUM QUESTIONS ---------
    async function loadForumQuestions(filter = "not solved") {
      console.log("[CQ] loadForumQuestions filter:", filter);
      currentFilter = filter;

      if (window.currentUser === null) {
        console.log("[CQ] Waiting for auth state before loading posts");
        return;
      }

      let query = db.collection("forum-questions").orderBy("timestamp", "desc");
      if (filter === "not solved") {
        query = query.where("solved", "==", false);
      } else if (filter === "solved") {
        query = query.where("solved", "==", true);
      }

      const forumMain = document.querySelector('.forum-main');
      if (!forumMain) return;
      const askBox = forumMain.querySelector('.ask-box');

      // Clear container once here before rendering anything
      forumMain.innerHTML = "";
      if (askBox) forumMain.appendChild(askBox);

      const snapshot = await query.get();

      if (snapshot.empty) {
        const emptyMsg = document.createElement('div');
        emptyMsg.style.cssText = "color:#888;text-align:center;padding:2rem;";
        emptyMsg.textContent = "No unanswered questions. Anything on your mind?";
        forumMain.appendChild(emptyMsg);
        return;
      }

      const currentUserId = window.currentUser ? window.currentUser.uid : null;

      // Build cards asynchronously
      const cardPromises = snapshot.docs.map(async (doc) => {
        const data = doc.data();
        const card = document.createElement('div');
        card.classList.add('forum-card');
        card.dataset.id = doc.id;

        // Check if post has any comments
        let hasComments = false;
        try {
          const commentsSnap = await db.collection("forum-questions").doc(doc.id).collection("comments").limit(1).get();
          hasComments = !commentsSnap.empty;
        } catch (err) {
          console.error("Error checking comments for post:", doc.id, err);
        }

        const showResolveButton = !data.solved && hasComments && currentUserId;

        card.innerHTML = `
          <div class="card-header">
            <div class="user-info">
              <div class="avatar">${data.userName ? data.userName[0] : "A"}</div>
              <div class="user-details">
                <div class="user-meta"><strong>${data.userName || "Anonymous"}</strong></div>
                <div class="time-meta">${data.timestamp ? data.timestamp.toDate().toLocaleString() : ''}</div>
              </div>
              <div class="menu-icon">‚Ä¢‚Ä¢‚Ä¢</div>
            </div>
          </div>
          <div class="card-body">
            <p><strong>Type:</strong> ${data.helpType || ""}</p>
            <p><strong>Question:</strong> ${data.question || ""}</p>
            <p><strong>Tried:</strong> ${data.tried || ""}</p>
          </div>
          <div class="question-footer">
            <div class="left-icons"></div>
            <div class="not-solved"><span>${data.solved ? "Solved" : "Not Solved"}</span></div>
            ${showResolveButton ? `<button class="resolve-btn" data-id="${doc.id}">Resolve</button>` : ""}
          </div>
        `;
        forumMain.appendChild(card);
      });

      await Promise.all(cardPromises);
    }

    // --------- DELEGATED EVENT HANDLER FOR CARDS & RESOLVE BUTTONS ---------
    const forumMain = document.querySelector('.forum-main');

    forumMain.addEventListener('click', async (e) => {
      // Resolve button click
      if (e.target.classList.contains('resolve-btn')) {
        e.stopPropagation();
        const postId = e.target.dataset.id;
        if (!postId) return;

        try {
          await db.collection("forum-questions").doc(postId).update({ solved: true });
          await loadForumQuestions(currentFilter);
          await updatePostCount();
          await updateSolvedPercentage();
          await updateMedianResponseTime();
          if (currentCardId === postId) toggleCommentPanel();
          showNotification("Post marked as resolved!");
        } catch (error) {
          alert("Failed to update post status: " + error.message);
        }
      }
      // Card click except on resolve button
      else if (e.target.closest('.forum-card') && !e.target.classList.contains('resolve-btn')) {
        const card = e.target.closest('.forum-card');
        currentCardId = card.dataset.id || "demo";
        toggleCommentPanel();
        loadComments(currentCardId);
      }
    });

    function showNotification(message) {
      console.log("showNotification called with message:", message);
      const modal = document.getElementById("notificationModal");
      const textElem = modal.querySelector("p");
      textElem.textContent = message;
      modal.classList.remove("hidden");

      setTimeout(() => {
        modal.classList.add("hidden");
      }, 3000);
    }

    // --------- UPDATE POST COUNT ---------
    async function updatePostCount() {
      try {
        const snapshot = await db.collection("forum-questions").get();
        const count = snapshot.size;
        const countEl = document.querySelector(".posts-count");
        if (countEl) countEl.textContent = count.toLocaleString();
        console.log("[CQ] Post count updated:", count);
      } catch (error) {
        console.error("[CQ] Failed to update post count:", error);
      }
    }

    // --------- UPDATE MEMBER COUNT ---------
    async function updateMemberCount() {
      try {
        const statsRef = db.collection('stats').doc('membersCount');
        const doc = await statsRef.get();
        const count = doc.exists ? doc.data().count || 0 : 0;
        const countEl = document.querySelector(".members-count");
        if (countEl) countEl.textContent = count.toLocaleString();
        console.log("[CQ] Member count updated:", count);
      } catch (error) {
        console.error("[CQ] Failed to update member count:", error);
      }
    }

    // --------- UPDATE SOLVED PERCENTAGE ---------
    async function updateSolvedPercentage() {
      try {
        const totalSnap = await db.collection("forum-questions").get();
        const totalCount = totalSnap.size;
        if (totalCount === 0) {
          const elem = document.querySelector(".solved-percent");
          if (elem) elem.textContent = "0%";
          return;
        }
        const solvedSnap = await db.collection("forum-questions").where("solved", "==", true).get();
        const solvedCount = solvedSnap.size;
        const percent = Math.round((solvedCount / totalCount) * 100);
        const elem = document.querySelector(".solved-percent");
        if (elem) elem.textContent = `${percent}%`;
        console.log("[CQ] Solved percentage updated:", percent);
      } catch (error) {
        console.error("[CQ] Failed to update solved percentage:", error);
      }
    }

    // --------- UPDATE MEDIAN RESPONSE TIME ---------
    async function updateMedianResponseTime() {
      try {
        const postsSnapshot = await db.collection("forum-questions").get();
        const responseTimes = [];

        for (const postDoc of postsSnapshot.docs) {
          const postData = postDoc.data();
          const postTimestamp = postData.timestamp ? postData.timestamp.toDate().getTime() : null;
          if (!postTimestamp) continue;

          const commentsSnapshot = await db.collection("forum-questions")
            .doc(postDoc.id)
            .collection("comments")
            .orderBy("timestamp", "asc")
            .limit(1)
            .get();

          if (!commentsSnapshot.empty) {
            const firstComment = commentsSnapshot.docs[0].data();
            const commentTimestamp = firstComment.timestamp ? firstComment.timestamp.toDate().getTime() : null;
            if (commentTimestamp && commentTimestamp >= postTimestamp) {
              const diffMs = commentTimestamp - postTimestamp;
              const diffMinutes = Math.round(diffMs / (1000 * 60));
              responseTimes.push(diffMinutes);
            }
          }
        }

        if (responseTimes.length === 0) {
          document.querySelector(".response-line .value").textContent = "N/A";
          return;
        }

        responseTimes.sort((a, b) => a - b);
        let median;
        const mid = Math.floor(responseTimes.length / 2);
        if (responseTimes.length % 2 === 0) {
          median = Math.round((responseTimes[mid - 1] + responseTimes[mid]) / 2);
        } else {
          median = responseTimes[mid];
        }

        document.querySelector(".response-line .value").textContent = `${median} min`;
        console.log("[CQ] Median response time updated:", median, "min");

      } catch (error) {
        console.error("[CQ] Failed to update median response time:", error);
      }
    }

    // --------- COMMENT PANEL TOGGLE ---------
    let currentCardId = null;
    function toggleCommentPanel() {
      const panel = document.getElementById("commentPanel");
      if (panel.classList.contains("active")) {
        panel.classList.remove("active");
        setTimeout(() => panel.classList.add("hidden"), 300);
      } else {
        panel.classList.remove("hidden");
        setTimeout(() => panel.classList.add("active"), 10);
      }
    }
    window.toggleCommentPanel = toggleCommentPanel;

    // --------- LOAD COMMENTS FROM FIRESTORE ---------
    async function loadComments(postId) {
      const commentsThread = document.getElementById("commentsThread");
      commentsThread.innerHTML = "";

      try {
        const commentsSnapshot = await db.collection("forum-questions").doc(postId).collection("comments").orderBy("timestamp", "asc").get();
        if (commentsSnapshot.empty) {
          commentsThread.innerHTML = "<p>No comments yet. Be the first to comment!</p>";
          return;
        }
        commentsSnapshot.forEach(doc => {
          const data = doc.data();
          const commentDiv = document.createElement("div");
          commentDiv.classList.add("comment");
          commentDiv.innerHTML = `<strong>${data.name}</strong><p>${data.text}</p>`;
          commentsThread.appendChild(commentDiv);
        });
      } catch (error) {
        commentsThread.innerHTML = "<p>Failed to load comments.</p>";
        console.error("[CQ] Failed to load comments:", error);
      }
    }

    // --------- ADD COMMENT TO FIRESTORE ---------
    async function addComment(postId, comment) {
      try {
        await db.collection("forum-questions").doc(postId).collection("comments").add({
          name: comment.name,
          text: comment.text,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Award 5 XP for commenting (if user is logged in)
        if (window.currentUser) {
          await awardXP(window.currentUser.uid, 5, 'commenting');
        }
        
      } catch (error) {
        console.error("[CQ] Failed to add comment:", error);
        throw error;
      }
    }

    // --------- COMMENT BOX SEND ON CTRL+ENTER ---------
    const replyBox = document.querySelector(".reply-box");
    if (replyBox) {
      replyBox.addEventListener("keydown", async (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter" && currentCardId) {
          const commentText = replyBox.value.trim();
          if (!commentText) return;
          try {
            await addComment(currentCardId, { name: "You üí¨", text: commentText });
            replyBox.value = "";
            await loadComments(currentCardId);
          } catch {
            alert("Failed to post comment.");
          }
        }
      });
    }

    // --------- TAB SWITCHING & UNDERLINE ANIMATION ---------
    const tabs = document.querySelectorAll('.tab');
    const tabUnderline = document.querySelector('.tab-underline');

    function selectTab(selectedTab) {
      tabs.forEach(tab => tab.classList.remove('active'));
      selectedTab.classList.add('active');
      tabUnderline.style.transform = `translateX(${selectedTab.offsetLeft}px)`;
      tabUnderline.style.width = `${selectedTab.offsetWidth}px`;
      const filter = selectedTab.textContent.trim().toLowerCase();
      loadForumQuestions(filter);
    }
    window.selectTab = selectTab;

    tabs.forEach(tab => {
      tab.addEventListener('click', () => selectTab(tab));
    });

    const activeTab = document.querySelector('.tab.active');
    if (activeTab && tabUnderline) {
      tabUnderline.style.transform = `translateX(${activeTab.offsetLeft}px)`;
      tabUnderline.style.width = `${activeTab.offsetWidth}px`;
    }

    // --------- EXPOSE FOR DEBUGGING ---------
    window.loadForumQuestions = loadForumQuestions;
    window.currentFilter = currentFilter;
    window.updatePostCount = updatePostCount;
    window.updateMemberCount = updateMemberCount;
    window.updateSolvedPercentage = updateSolvedPercentage;
    window.updateMedianResponseTime = updateMedianResponseTime;
    window.awardXP = awardXP; // Expose for debugging
  });
</script>

</body>
</html>