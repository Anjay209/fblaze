<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CertQuest Dashboard</title>
  <link rel="stylesheet" href="create.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';</script>
<style>
      * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Inter', sans-serif;

  }

  html::-webkit-scrollbar, body::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Edge */
  }
  
  body {
    background-color: #f8f9fb;
    color: #111;
  }
  
  /* Layout */
  .main-layout {
    display: flex;
  }
  
  /* Sidebar */
  .sidebar {
    width: 70px;
    height: 100vh;
    background: white;
    border-right: 1px solid #ddd;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1rem 0;
    gap: 2rem;
    position: fixed;
    top: 60px;
    left: 0;
  }

  .notification-item {
  background: #eef2ff;
  border: 1px solid #c7d2fe;
  border-radius: 8px;
  padding: 0.75rem;
  margin-bottom: 0.75rem;
  font-size: 0.9rem;
  color: #1e3a8a;
  cursor: pointer;
  transition: background 0.2s ease;
}

.notification-item:hover {
  background: #e0e7ff;
}

.notification-close {
    position: absolute;
    top: 8px;
    right: 8px;
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    font-size: 14px;
    padding: 2px 5px;
    border-radius: 50%;
}

.notification-close:hover {
    color: #666;
    background: #f0f0f0;
}

.notification-item {
    position: relative;
    padding: 12px 16px 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.2s;
    background: #fff;

}


  
  .logo {
    font-weight: bold;
    color: #007aff;
    font-size: 1.2rem;
  }
  
  .button {
    background-color: transparent;
    border-color: 1px solid transparent;
  }
  .nav-icons {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .nav-icons li {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    background-color: #f1f5ff;
    padding: 0.75rem;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .nav-icons li:hover {
    background-color: #d8e5ff;
  }

  .nav-label {
    position: absolute;
    left: 100%;
    top: 50%;
    transform: translateY(-50%);
    background-color: #111827;
    color: white;
    font-size: 0.7rem;
    padding: 0.3rem 0.5rem;
    border-radius: 6px;
    margin-left: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease, transform 0.2s ease;
    z-index: 10;
  }

  .nav-icons li:hover .nav-label {
    opacity: 1;
    transform: translateY(-50%) translateX(0px);
  }
  
  /* Top Header */
  .top-header {
    position: sticky;
    top: 0;
    background: white;
    padding: 0.75rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #eee;
    z-index: 1000;
    height: 60px;
  }
  
  .nav-title {
    font-size: 1.2rem;
    font-weight: 600;
  }
  
  .new-badge {
    font-size: 0.9rem;
    color: #007aff;
    margin-left: 0.5rem;
  }
  
  .nav-right {
  position: relative;
  display: flex;
  align-items: center;
}

  
  .nav-right input {
    padding: 0.4rem 2.2rem 0.4rem 0.75rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 0.9rem;
    width: 220px;
  }
  
  .search-icon {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
    color: #666;
  }
  
  /* Content Area */
  .content {
    margin-left: 70px;
    padding: 2rem;
    width: 100%;
    width: calc(100% - 160px); /* Use available space */
    margin-left: 120px; /* Creates space from the sidebar */
  }
  
  /* Welcome Section */
  .welcome-section {
    margin-bottom: 1rem;
  }
  
  .course-title {
    background: linear-gradient(to right, #007cf0, #00dfd8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 2rem;
    font-weight: 700;
    text-transform: lowercase;
  }
  
  .unit-title {
    font-size: 5rem;
    font-weight: 800;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }
  
  .name {
    background: linear-gradient(to right, #007cf0, #00dfd8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .meta-info {
    font-size: 0.95rem;
    color: #555;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  /* AI Summary Box */
  .ai-summary {
    background: #e6f7ff;
    padding: 1rem 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    width: 80vw;
    border-left: 5px solid #00bfff; /* sky blue border */
  }
  
  .ai-summary h3 {
    font-weight: 700;
    margin-bottom: 0.5rem;
  }
  
  /* Cards */
  .cards {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }
  
  .schoolhouse-card {
    background: #fff;
    border: 1px solid #e0e6ed;
    border-radius: 12px;
    padding: 1.5rem;
    width: 100%;
    max-width: 275px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .card-icon {
    font-size: 2rem;
    color: #3b82f6;
  }
  
  .card-content h3 {
    font-size: 1.1rem;
    font-weight: 700;
  }

  .card-content{
    gap: 1rem;
    display: flex;
  flex-direction: column;
  }
  
  .card-content p {
    font-size: 0.95rem;
    color: #4b5563;
  }
  
  .card-content a {
    font-size: 0.95rem;
    color: #2563eb;
    font-weight: 600;
    text-decoration: none;
  }
  
  .card-content a:hover {
    text-decoration: underline;
  }
  
  /* FAQ */
  .faq-wrapper {
    margin-top: 2rem;
  }
  
  .faq-category {
    font-size: 1.25rem;
    font-weight: 600;
    color: #007cf0;
    margin-bottom: 1rem;
  }

  .desc {
    line-height: 1.6rem;
  }
  
  .accordion {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .accordion-item {
    border-bottom: 1px solid #ddd;
  }
  
  .accordion-toggle {
    background: none;
    border: none;
    font-size: 1rem;
    font-weight: 600;
    text-align: left;
    width: 100%;
    padding: 1rem 0;
    cursor: pointer;
  
    display: flex;
    justify-content: space-between; /* ðŸ‘ˆ pushes icon to far right */
    align-items: center;
    gap: 1rem;
  }
  
  .accordion-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    font-size: 0.95rem;
    color: #555;
  }
  
  .accordion-toggle.active + .accordion-content {
    max-height: 200px;
    padding-bottom: 1rem;
  }
  
  .feature-box-icon {
    width: 48px;
    height: 48px;
    margin-bottom: 12px;
    display: block;
    object-fit: contain;
  }
  
  .sidebar .nav-icons a {
    text-decoration: none !important;  /* ðŸ’¥ Force remove underline */
    color: inherit;                    /* ðŸŸ¦ Optional: match surrounding text color */
    display: flex;                     /* ðŸ”§ Keeps icon and label aligned */
    align-items: center;
    gap: 0.5rem;                       /* ðŸ‘ˆ Optional spacing between icon and label */
  }
  
  .chevron-icon {
    transition: transform 0.3s ease;
  }
  
  .chevron-icon.rotate {
    transform: rotate(180deg);
  }
  

  .goal-modal {
  position: fixed;
  z-index: 1002;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #fff;
  border-radius: 2rem;
  box-shadow: 0 10px 36px rgba(36,60,120,0.13), 0 2px 8px #357cf526;
  min-width: 350px;
  max-width: 95vw;
  padding: 2.6rem 2.1rem 2rem 2.1rem;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 1.6rem;
  animation: fadeIn 0.32s cubic-bezier(.21,.93,.49,1.05);
}
.goal-modal .modal-content {
  display: flex;
  flex-direction: column;
  gap: 1.2rem;
}

.goal-modal h2 {
  font-size: 2rem;
  font-weight: 700;
  color: #212941;
  margin-bottom: 0.5rem;
  text-align: left;
}

.goal-choices {
  display: flex;
  gap: 1rem;
  justify-content: stretch;
  margin-bottom: 0.8rem;
}
.goal-card {
  flex: 1 1 0;
  background: #f8fafd;
  border: 2px solid #e3e8f2;
  border-radius: 14px;
  padding: 1.18rem 0.7rem 0.93rem 0.7rem;
  text-align: center;
  font-weight: 700;
  color: #25355a;
  font-size: 1.17rem;
  box-shadow: 0 1.5px 8px #3061cb10;
  cursor: pointer;
  transition: border 0.17s, box-shadow 0.16s, background 0.14s;
  min-width: 110px;
  outline: none;
  user-select: none;
}
.goal-card.selected,
.goal-card:active,
.goal-card:focus {
  border: 2.2px solid #357cf5;
  background: #eef4fe;
  color: #1d4dd1;
  box-shadow: 0 5px 20px #357cf513;
}
.goal-card span {
  font-size: 1.02rem;
  font-weight: 500;
  display: block;
  margin-top: 0.19em;
  color: #7b8ea8;
  letter-spacing: 0.01em;
}
.goal-modal label {
  margin-top: 0.3rem;
  margin-bottom: 0.18rem;
  font-weight: 600;
  color: #273760;
  font-size: 1.07rem;
  letter-spacing: -0.01em;
}
.goal-modal input[type="text"] {
  width: 100%;
  font-size: 1.09rem;
  border: 2px solid #e6eaf2;
  border-radius: 11px;
  padding: 0.86rem 1rem;
  background: #f7fafb;
  margin-bottom: 0.4rem;
  transition: border-color 0.14s, box-shadow 0.14s;
  font-family: inherit;
}
.goal-modal input[type="text"]:focus {
  border-color: #357cf5;
  box-shadow: 0 0 0 2px #357cf532;
  outline: none;
}

#goalSubmitBtn {
  background: #357cf5;
  color: #fff;
  font-weight: 700;
  font-size: 1.12rem;
  border: none;
  border-radius: 12px;
  padding: 0.98rem 0;
  margin-top: 0.6rem;
  opacity: 0.78;
  cursor: not-allowed;
  box-shadow: 0 1.5px 8px #357cf511;
  transition: background 0.16s, opacity 0.15s;
}
#goalSubmitBtn.enabled {
  opacity: 1;
  cursor: pointer;
  background: #357cf5;
}
#goalSubmitBtn.enabled:hover {
  background: #2057b9;
}
.modal-backdrop {
  position: fixed;
  z-index: 1000;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: rgba(40,50,80,0.12);
  backdrop-filter: blur(2px);
}
@media (max-width: 600px) {
  .goal-modal { min-width: 0; padding: 1.6rem 0.5rem;}
  .goal-choices { flex-direction: column; gap: 0.7rem; }
}
.goal-card.selected {
  outline: 0.5px solid #4f46e5;
  background: #E0F2FE ;
  /* add your own highlight styling if you want */
}


#searchDropdown {
  display: none;           /* Hidden by default */
  position: absolute;
  top: 42px;               /* Adjust based on your navbarSearch input height */
  right: 0;
  width: 340px;            /* Match or be slightly wider than your input */
  max-height: 320px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  z-index: 99;
  overflow-y: auto;
  padding: 0;
}
.dropdown-result {
  padding: 12px 18px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  background: #fff;
  font-size: 16px;
  transition: background 0.12s;
}
.dropdown-result:last-child {
  border-bottom: none;
}
.dropdown-result:hover, .dropdown-result:focus {
  background: #f2f8fd;
  color: #0072ff;
}

.cq-modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.32);
  justify-content: center;
  align-items: center;
  transition: background 0.3s;
}
.cq-modal[style*="block"] {
  display: flex !important;
}
.cq-modal-content {
  background: white;
  border-radius: 24px;
  padding: 32px;
  max-width: 540px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.cq-close {
  position: absolute;
  top: 20px;
  right: 24px;
  font-size: 24px;
  color: #9ca3af;
  cursor: pointer;
  background: none;
  border: none;
  padding: 4px;
  line-height: 1;
}

.cq-close:hover {
  color: #6b7280;
}

.cq-modal-fields > div {
  margin-bottom: 16px;
  font-size: 16px;
  line-height: 1.5;
  color: #374151;
}

.cq-modal-fields > div > b {
  color: #1f2937;
  font-weight: 600;
  margin-right: 8px;
}

.cq-modal-fields ul {
  margin: 8px 0 0 20px;
  padding: 0;
}

.cq-modal-fields li {
  margin-bottom: 4px;
  color: #374151;
}


.cq-close:hover { color: #ff5361; }
.cq-modal-title {
  font-size: 1.7rem;
  font-weight: 700;
  margin-bottom: 0.7rem;
  color: #2176ff;
  text-align: center;
  letter-spacing: 0.5px;
}
.cq-modal-fields > div {
  margin-bottom: 0.55rem;
  font-size: 1.06rem;
}
.cq-modal-fields b {
  color: #404c64;
  font-weight: 600;
  margin-right: 4px;
}
.cq-modal-fields {
  margin-bottom: 1.25rem;
  margin-top: 0.5rem;
}
.cq-modal-btn {
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  margin-right: 12px;
  transition: background-color 0.2s;
}

.cq-modal-btn:hover {
  background: #4338ca;
}

.cq-modal-btn:last-child {
  margin-right: 0;
}


@media (max-width: 560px) {
  .cq-modal-content {
    max-width: 97vw;
    min-width: unset;
    padding: 1rem 0.7rem 1.4rem 0.7rem;
  }
  .cq-modal-title {
    font-size: 1.22rem;
  }
}
.comment-panel {
    background: white;
    border: 1px solid rgba(255, 255, 255, 0.18);
    overflow: hidden;
    backdrop-filter: blur(20px);
}

.comment-panel-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: none;
}

.comment-panel-header h3 {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
}

.mark-read-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
    margin-right: 8px;
}

.mark-read-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

.close-panel-btn {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border: none;
    padding: 8px 10px;
    border-radius: 8px;
    font-size: 1.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
    line-height: 1;
    backdrop-filter: blur(10px);
}

.close-panel-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-1px);
}

/* Modern Notification Items */
.notification-item {
    position: relative;
    padding: 20px 24px;
    border-bottom: 1px solid #f1f5f9;
    background: white;
    transition: all 0.3s ease;
    cursor: pointer;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Replace your notification-item::before CSS with this gradient version */

.notification-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 4px;
    height: 100%;
    
    /* Beautiful gradient options - choose one: */
    
    /* Option 1: Blue to Purple */
    background: linear-gradient(180deg, #3b82f6 0%, #8b5cf6 100%);
    
    /* Option 2: Ocean Blue */
    /* background: linear-gradient(180deg, #06b6d4 0%, #3b82f6 100%); */
    
    /* Option 3: Sunset */
    /* background: linear-gradient(180deg, #f59e0b 0%, #ef4444 100%); */
    
    /* Option 4: Forest */
    /* background: linear-gradient(180deg, #10b981 0%, #059669 100%); */
    
    /* Option 5: Royal */
    /* background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); */
    
    /* Option 6: Neon */
    /* background: linear-gradient(180deg, #06ffa5 0%, #00d4ff 100%); */
    
    transform: scaleY(0);
    transition: transform 0.3s ease;
    border-radius: 0 2px 2px 0; /* Rounded right edge */
}

.notification-item:hover {
    background: #f8fafc;
    transform: translateX(4px);
}

.notification-item:hover::before {
    transform: scaleY(1);
}

.notification-item.read {
    background: #f9fafb;
    opacity: 0.7;
}

.notification-item.read::before {
    background: #94a3b8;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 8px;
}

.notification-header strong {
    font-weight: 600;
    font-size: 0.95rem;
    color: #1e293b;
    line-height: 1.4;
    flex: 1;
    margin-right: 12px;
}

.notification-time {
    font-size: 0.75rem;
    color: #64748b;
    font-weight: 500;
    background: #f1f5f9;
    padding: 4px 8px;
    border-radius: 12px;
    white-space: nowrap;
}

.notification-body {
    font-size: 0.875rem;
    color: #475569;
    line-height: 1.5;
    margin: 0;
}

/* Unread indicator dot */
.notification-item:not(.read)::after {
    content: '';
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    background: #3b82f6;
    border-radius: 50%;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* Modern scrollbar */
.notification-list {
    max-height: 500px;
    overflow-y: auto;
}

.notification-list::-webkit-scrollbar {
    width: 6px;
}

.notification-list::-webkit-scrollbar-track {
    background: #f1f5f9;
}

.notification-list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.notification-list::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Modern notification badge */
.notification-badge {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
color: transparent;
    border-radius: 50%;
    min-width: 22px;
    height: 22px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    line-height: 1;
    padding: 0;
    margin: 0;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    border: 2px solid white;
    position: absolute;
    top: -6px;
    right: -6px;
    animation: badge-bounce 0.6s ease;
}

@keyframes badge-bounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
/* Congrats Modal - should match your other modals */
#congratsModal {
  display: none;
  position: fixed;
  z-index: 1004; /* Higher than other modals */
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
}

#congratsModal .cq-modal-content {
  background: white;
  margin: 10% auto;
  padding: 25px;
  width: 90%;
  max-width: 500px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  text-align: center;
  animation: modalFadeIn 0.3s ease-out;
}

#congratsModal .cq-modal-title {
  font-size: 1.8rem;
  color: #10b981;
  margin-bottom: 15px;
}

.cq-modal-title {
  font-size: 28px;
  font-weight: 600;
  color: #1f2937;
  margin: 0 0 24px 0;
  text-align: left;
}

#congratsModal .cq-modal-fields {
  font-size: 1.1rem;
  line-height: 1.6;
  margin: 20px 0;
}

.cq-modal-footer {
  margin-top: 32px;
  display: flex;
  justify-content: flex-end;
  gap: 12px;
}

#congratsModal .cq-modal-btn {
  background: #10b981;
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 1rem;
  cursor: pointer;
  transition: background 0.2s;
}

#congratsModal .cq-modal-btn:hover {
  background: #0d9f6e;
}

@keyframes modalFadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}


/* CertQuest Modal Styling */
.certq-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  z-index: 10000;
  font-family: 'Inter', sans-serif;
  animation: certqFadeIn 0.3s ease-out;
}

.certq-modal-content {
  position: relative;
  background: white;
  width: 90%;
  max-width: 420px;
  margin: 100px auto;
  border-radius: 12px;
  padding: 28px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  border: 1px solid #e5e7eb;
}

.certq-modal-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #111827;
  margin-bottom: 1.25rem;
  text-align: center;
  line-height: 1.3;
}

.certq-modal-fields {
  color: #4b5563;
  font-size: 1rem;
  line-height: 1.5;
  padding: 0 0.5rem;
}

.certq-modal-footer {
  margin-top: 1.75rem;
  display: flex;
  justify-content: center;
  gap: 12px;
}

.certq-modal-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.95rem;
}

.certq-modal-btn:hover {
  background: #1d4ed8;
  transform: translateY(-1px);
}

.certq-close {
  position: absolute;
  top: 16px;
  right: 20px;
  font-size: 1.75rem;
  color: #9ca3af;
  cursor: pointer;
  transition: color 0.2s ease;
  line-height: 1;
}

.certq-close:hover {
  color: #6b7280;
}

/* Animation */
@keyframes certqFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

/* Responsive adjustments */
@media (max-width: 480px) {
  .certq-modal-content {
    width: 95%;
    padding: 20px;
  }
  
  .certq-modal-title {
    font-size: 1.3rem;
  }
  
  .certq-modal-btn {
    padding: 8px 16px;
  }
}

.cq-assignment-modal .complete-btn {
  background: #2563eb;
  color: white;
  border: none;
  padding: 12px;
  border-radius: 6px;
  font-weight: 500;
  cursor: pointer;
  width: 100%;
  transition: background 0.2s;
}

.cq-assignment-modal .complete-btn:hover {
  background: #1d4ed8;
}

canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 1000;
}

/* Add these styles to your CSS file */
.complete-btn {
  background: #2563eb; /* Your brand blue */
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  font-weight: 600;
  font-family: 'Inter', sans-serif;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 100%; /* Full width of container */
  margin-top: 1rem;
}

.complete-btn:hover {
  background: #1d4ed8; /* Slightly darker blue */
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.complete-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.complete-btn:disabled {
  background: #e5e7eb;
  color: #9ca3af;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* Optional: Add checkmark icon */
.complete-btn::after {
  content: 'âœ“';
  font-size: 1.2rem;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.complete-btn:hover::after {
  opacity: 1;
}

.quiz-meta {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
  color: #666;
  font-size: 0.9rem;
}

.quiz-question {
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid #eee;
}
 
.quiz-question:last-child {
  border-bottom: none;
}

.quiz-question h4 {
  margin-bottom: 0.8rem;
  color: #333;
}

.quiz-option {
  display: block;
  margin: 0.5rem 0;
  padding: 0.5rem;
  border-radius: 4px;
  cursor: pointer;
}

.quiz-option:hover {
  background: #f5f5f5;
}

.quiz-option input {
  margin-right: 0.5rem;
}

#submitQuizBtn:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.cq-speaking-modal {
  position: fixed;
  z-index: 3100;
  left: 0; top: 0; right: 0; bottom: 0;
  align-items: center;
  justify-content: center;
  background: rgba(36, 45, 74, 0.17);
}
.cq-speaking-modal-content {
  background: #fff;
  border-radius: 2rem;
  box-shadow: 0 10px 40px rgba(24,36,85,.14), 0 1.5px 3px rgba(44,62,80,.05);
  max-width: 420px;
  width: 95%;
  padding: 2.2rem 2.5rem 2rem 2.5rem;
  position: relative;
  animation: modalpop .23s cubic-bezier(.51,1.35,.5,1) 1;
}
.cq-speaking-title {
  margin-bottom: 1.25rem;
  font-size: 1.6rem;
  font-weight: 700;
  color: #1750eb;
  text-align: center;
}
.cq-speaking-section {
  margin-bottom: 1.25rem;
}
.cq-speaking-label {
  font-weight: 600;
  color: #2b3751;
  margin-bottom: 0.25rem;
  display: block;
  font-size: 1rem;
}
.cq-speaking-qtext {
  margin-bottom: 0.4rem;
  font-size: 1.03rem;
  color: #2d3646;
  background: #f5f7fd;
  padding: 0.5rem 0.85rem;
  border-radius: 0.8rem;
}
.cq-speaking-btn {
  background: #2563eb;
  color: #fff;
  font-weight: 600;
  border: none;
  border-radius: 1.1rem;
  padding: 0.65rem 1.25rem;
  margin-right: 0.5rem;
  margin-top: 0.5rem;
  font-size: 1rem;
  transition: background .15s;
  cursor: pointer;
  box-shadow: 0 1.5px 4px rgba(44,62,80,.07);
}
.cq-speaking-btn:hover, .cq-speaking-btn:focus {
  background: #1a42a6;
}
.cq-speaking-submit {
  margin-top: 1.2rem;
  width: 100%;
  font-size: 1.1rem;
}
.cq-speaking-close {
  position: absolute;
  top: 1.2rem;
  right: 1.2rem;
  font-size: 2rem;
  font-weight: 600;
  color: #d0d3e2;
  cursor: pointer;
  z-index: 3;
}
.cq-speaking-close:hover { color: #4f5ca3; }
.cq-speaking-video, .cq-speaking-audio {
  border-radius: 1rem;
  background: #eef1f8;
  border: 1px solid #e4e7f5;
  margin-bottom: 1rem;
  margin-top: 0.2rem;
  width: 100%;
  outline: none;
}

.cq-speaking-section {
  margin: 1.5rem 0;
  font-family: 'Inter', sans-serif;
  color: #1e293b; /* dark slate */
}

.cq-speaking-label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.6rem;
  font-size: 1.1rem;
  color: #334155; /* softer dark */
}

.recording-controls {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.recording-controls button {
  background-color: transparent;
  border: 1.5px solid #3b82f6; /* subtle blue border */
  color: #3b82f6;
  font-size: 1rem;
  padding: 0.5rem 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.3s ease, color 0.3s ease;
  box-shadow: none;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.recording-controls button:hover:not(:disabled) {
  background-color: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.recording-controls button:disabled {
  border-color: #a5b4fc;
  color: #a5b4fc;
  cursor: not-allowed;
}

#cq-speaking-submitBtn {
  background-color: transparent;
  border: 1.5px solid #10b981; /* subtle green border */
  color: #10b981;
  font-weight: 600;
  padding: 0.65rem 2rem;
  font-size: 1.1rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.3s ease, color 0.3s ease;
  width: 100%;
  max-width: 320px;
  margin: 1rem auto 0 auto;
  display: block;
}

#cq-speaking-submitBtn:hover:not(:disabled) {
  background-color: #10b981;
  color: white;
  border-color: #10b981;
}

#cq-speaking-submitBtn:disabled {
  border-color: #a7f3d0;
  color: #a7f3d0;
  cursor: not-allowed;
}


.media-preview {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 0.5rem;
}

.media-preview audio,
.media-preview video {
  border-radius: 8px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
  max-width: 100%;
  outline: none;
}

#cq-speaking-submitBtn {
  background-color: #4a90e2; /* pastel blue */
  color: white;
  font-weight: 600;
  padding: 0.65rem 2.2rem;
  font-size: 1.15rem;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  transition: background-color 0.25s ease;
  width: 100%;
  max-width: 360px;
  display: block;
  margin: 1.5rem auto 0 auto;
  box-shadow: none;
}

#cq-speaking-submitBtn:hover:not(:disabled) {
  background-color: #357abd; /* slightly deeper blue */
}

#cq-speaking-submitBtn:disabled {
  background-color: #a3c2f2; /* lighter pastel blue */
  cursor: not-allowed;
  color: #e0e6f7;
}

.drag-drop-zone {
  border: 2px dashed #2563eb;
  border-radius: 10px;
  background: #f3f6fd;
  padding: 2rem;
  text-align: center;
  font-size: 1.1rem;
  color: #2563eb;
  cursor: pointer;
  margin: 1rem 0;
  transition: all 0.2s ease;
  min-height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.drag-drop-zone:hover {
  background: #e0ebff;
  border-color: #1e40af;
  transform: translateY(-1px);
}

#cq-speaking-uploadSubmitBtn {
  width: 100%;
  margin-top: 1rem;
  padding: 12px 24px;
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

#cq-speaking-uploadSubmitBtn:hover:not(:disabled) {
  background: #1e40af;
  transform: translateY(-1px);
}

#cq-speaking-uploadSubmitBtn:disabled {
  background: #94a3b8;
  cursor: not-allowed;
  transform: none;
}

#mentorCommentModal {
  display: none; /* hidden by default */
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  width: 100vw; height: 100vh;
  background: rgba(30, 41, 59, 0.30); /* translucent dark overlay */
  z-index: 5000;
  align-items: center;
  justify-content: center;
}

#mentorCommentModal .modal-content {
  background: #fff;
  border-radius: 1.25rem;
  box-shadow: 0 4px 40px rgba(0,0,0,0.13), 0 1.5px 8px rgba(60,60,120,0.08);
  padding: 2.2rem 2.5rem;
  max-width: 390px;
  width: 100%;
  margin: 0 auto;
  text-align: left;
  position: relative;
  animation: popIn 0.19s cubic-bezier(.42,1.54,.64,1) 1;
}

#mentorCommentModal .close {
  position: absolute;
  top: 20px;
  right: 24px;
  font-size: 2rem;
  color: #444;
  background: none;
  border: none;
  cursor: pointer;
  transition: color 0.13s;
}
#mentorCommentModal .close:hover {
  color: #2563eb;
}

#mentorCommentAssignment {
  font-size: 1.15rem;
  font-weight: 700;
  margin-bottom: 1rem;
  color: #222;
}
#mentorCommentText {
  color: #444;
  font-size: 1.04rem;
  margin-bottom: 1.3rem;
}

#mentorCommentModal .btn {
  background: linear-gradient(90deg, #aee7f5, #e0c3fc);
  color: #1e293b;
  border: none;
  border-radius: 0.95rem;
  padding: 0.7rem 1.5rem;
  font-size: 1.05rem;
  font-weight: 600;
  cursor: pointer;
  width: 100%;
  transition: background 0.14s, transform 0.09s;
}
#mentorCommentModal .btn:hover {
  background: linear-gradient(90deg, #dbeafe, #f3e8ff);
  transform: translateY(-2px) scale(1.03);
}

@keyframes popIn {
  from { transform: scale(0.92); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}

/* Add to your home.css */
.competency-result {
  margin: 1rem 0;
  padding: 0.5rem;
  background: #f8fafc;
  border-radius: 8px;
}

.progress-bar {
  height: 6px;
  background: #e2e8f0;
  border-radius: 3px;
  margin-top: 0.5rem;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: #4ade80;
  transition: width 0.3s ease;
}

.cq-modal-fields h4 {
  margin-bottom: 0.5rem;
  color: #334155;
}

.competency-result {
    margin: 1rem 0;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
}

.question-result {
    margin: 0.5rem 0;
    padding: 0.5rem;
}

.question-result.correct {
    border-left: 4px solid #4ade80;
}

.question-result.incorrect {
    border-left: 4px solid #f87171;
}

.comment-panel {
  position: fixed;
  top: 60px;
  left: 70px; /* align with edge of sidebar */
  width: 400px;
  height: calc(100% - 60px);
  background: #fff;
  border-right: 1px solid #ddd;
  
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
}

.comment-panel.active {
  transform: translateX(0);
}


.comment-header {
  display: flex;
  justify-content: space-between;
  padding: 1rem;
  font-weight: bold;
  border-bottom: 1px solid #eee;
}

.comment-content {
  padding: 1rem;
  flex: 1;
  overflow-y: auto;
}

.reply-container {
  padding: 1rem;
  border-top: 1px solid #eee;
}

.reply-box {
  width: 100%;
  height: 60px;
  padding: 0.75rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  resize: none;
}

.comment {
  background: #f7f7f7;
  padding: 0.75rem;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.2rem;
  cursor: pointer;
}

.cq-written-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease-out;
}

.cq-written-modal-content {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 680px;
  max-height: 85vh;
  overflow: hidden;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  display: flex;
  flex-direction: column;
  animation: slideUp 0.4s ease-out;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(40px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.cq-written-header {
  padding: 24px 32px 20px;
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.cq-written-title-section {
  flex: 1;
}

.cq-written-title {
  font-size: 24px;
  font-weight: 600;
  color: #1a202c;
  margin: 0 0 8px 0;
  line-height: 1.3;
}

.cq-written-meta {
  display: flex;
  gap: 20px;
  font-size: 14px;
  color: #64748b;
  font-weight: 500;
}

.cq-written-close {
  background: none;
  border: none;
  font-size: 28px;
  color: #94a3b8;
  cursor: pointer;
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.cq-written-close:hover {
  background: #f1f5f9;
  color: #475569;
}

.cq-written-body {
  padding: 32px;
  flex: 1;
  overflow-y: auto;
}

.cq-written-competency {
  display: inline-block;
  background: #dbeafe;
  color: #1e40af;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 20px;
}

.cq-written-question {
  font-size: 20px;
  font-weight: 500;
  color: #1a202c;
  line-height: 1.4;
  margin-bottom: 32px;
}

.cq-written-options {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.cq-written-option {
  display: flex;
  align-items: flex-start;
  padding: 20px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  background: white;
}

.cq-written-option:hover {
  border-color: #cbd5e1;
  background: #f8fafc;
}

.cq-written-option.selected {
  border-color: #3b82f6;
  background: #f0f9ff;
}

.cq-written-option input[type="radio"] {
  margin: 0 16px 0 0;
  width: 20px;
  height: 20px;
  accent-color: #3b82f6;
  cursor: pointer;
}

.cq-written-option-text {
  flex: 1;
  font-size: 16px;
  color: #374151;
  line-height: 1.5;
}



.cq-written-footer {
  padding: 24px 32px;
  border-top: 1px solid #e2e8f0;
  background: #fafbfc;
}

.cq-written-progress {
  margin-bottom: 16px;
}

.cq-written-progress-bar {
  width: 100%;
  height: 6px;
  background: #e2e8f0;
  border-radius: 3px;
  overflow: hidden;
}

.cq-written-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #3b82f6, #1d4ed8);
  border-radius: 3px;
  transition: width 0.3s ease;
  width: 10%; /* Will be updated by JavaScript */
}

.cq-written-nav {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.cq-written-btn {
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  min-width: 100px;
}

.cq-written-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.cq-written-btn-secondary {
  background: white;
  color: #64748b;
  border: 1px solid #e2e8f0;
}

.cq-written-btn-secondary:hover:not(:disabled) {
  background: #f8fafc;
  border-color: #cbd5e1;
}

.cq-written-btn-primary {
  background: #3b82f6;
  color: white;
}

.cq-written-btn-primary:hover:not(:disabled) {
  background: #2563eb;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Mobile responsiveness */
@media (max-width: 640px) {
  .cq-written-modal-content {
    width: 95%;
    max-height: 95vh;
  }
  
  .cq-written-header {
    padding: 20px 24px 16px;
  }
  
  .cq-written-body {
    padding: 24px;
  }
  
  .cq-written-footer {
    padding: 20px 24px;
  }
  
  .cq-written-title {
    font-size: 20px;
  }
  
  .cq-written-question {
    font-size: 18px;
  }
  
  .cq-written-option {
    padding: 16px;
  }
}

/* Replace your existing .cq-written-modal styles with: */
.cq-written-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    padding: 20px;
}

.cq-written-modal-content {
    background: white;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* Enhanced header styling */
.cq-written-header {
    padding: 24px 24px 0 24px;
    border-bottom: none;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.cq-written-title {
    font-size: 24px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 8px 0;
}

.cq-written-meta {
    display: flex;
    gap: 20px;
    font-size: 14px;
    color: #64748b;
    font-weight: 500;
}

.cq-written-close {
    background: none;
    border: none;
    font-size: 24px;
    color: #94a3b8;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
}

.cq-written-close:hover {
    background: #f1f5f9;
    color: #64748b;
}

/* Body styling */
.cq-written-body {
    padding: 24px;
    flex: 1;
    overflow-y: auto;
}

.cq-written-competency {
    background: #dbeafe;
    color: #1e40af;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: inline-block;
    margin-bottom: 20px;
}

.cq-written-question {
    font-size: 18px;
    font-weight: 500;
    color: #1e293b;
    line-height: 1.5;
    margin: 0 0 24px 0;
}

/* Enhanced options styling */
.cq-written-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.cq-written-option {
    display: flex;
    align-items: flex-start;
    padding: 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
}

.cq-written-option:hover {
    border-color: #cbd5e1;
    background: #f8fafc;
}

.cq-written-option.selected {
    border-color: #3b82f6;
    background: #eff6ff;
}

.cq-written-option input[type="radio"] {
    margin: 2px 12px 0 0;
    width: 18px;
    height: 18px;
    accent-color: #3b82f6;
    flex-shrink: 0;
}

.cq-written-option-text {
    flex: 1;
    font-size: 16px;
    color: #374151;
    line-height: 1.5;
}

/* Footer styling */
.cq-written-footer {
    padding: 24px;
    border-top: 1px solid #e2e8f0;
    background: #fafafa;
}

.cq-written-progress {
    margin-bottom: 16px;
}

.cq-written-progress-bar {
    width: 100%;
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
}

.cq-written-progress-fill {
    height: 100%;
    background: #3b82f6;
    transition: width 0.3s ease;
    border-radius: 3px;
}

.cq-written-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.cq-written-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    min-width: 80px;
}

.cq-written-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.cq-written-btn-secondary {
    background: #f1f5f9;
    color: #64748b;
}

.cq-written-btn-secondary:hover:not(:disabled) {
    background: #e2e8f0;
    color: #475569;
}

.cq-written-btn-primary {
    background: #3b82f6;
    color: white;
}

.cq-written-btn-primary:hover:not(:disabled) {
    background: #2563eb;
}


.record-my-answer-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 15px 30px;
    border-radius: 25px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    width: 100%;
    margin: 20px 0;
}
.sub-nav-wrapper{
  z-index: -10;
}

.record-my-answer-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(102, 126, 234, 0.4);
}

 .modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.3);
    max-height: 100vh;         /* limit height to viewport */
  overflow-y: auto;         /* scrolls only if needed */
  }
  
  .modal-content {
    background: white;
    margin: 6% auto;
    padding: 2rem;
    border-radius: 12px;
    width: 460px;
    font-family: 'Inter', sans-serif;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    animation: fadeIn 0.3s ease-in-out;
  }
  
  .modal-section {
    margin: 1.4rem 0;
  }
  
  .time-options, .difficulty-options {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }
  
  .time-btn, .difficulty-btn {
    padding: 0.5rem 1rem;
    border-radius: 8px;
    border: 1.5px solid #ddd;
    background-color: #f0f4ff;
    color: #0066ff;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s ease;
  }
  
  .time-btn.selected,
  .difficulty-btn.selected {
    background-color: #0066ff;
    color: white;
    border-color: #0066ff;
  }
  
  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  
  
  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  
 
  .start-btn {
    margin-top: 1.5rem;
    width: 100%;
    padding: 0.6rem 1.2rem;
    background-color: #0066ff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }
  
  .start-btn:hover {
    background-color: #004ecb;
  }
  
  .close-btn {
    float: right;
    font-size: 1.4rem;
    font-weight: bold;
    cursor: pointer;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  
  .select-all-btn {
    border: 1.5px solid #ddd;
    background-color: #f0f4ff;
    color: #0066ff;
    padding: 0.4rem 1rem;
    font-size: 0.9rem;
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    width: 26%;
  }
  
  /* Close button */

  /* Section spacing */
  .modal-section {
    margin-top: 1.5rem;
  }
  
  /* Textarea */
  textarea {
    width: 100%;
    padding: 1rem;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    resize: vertical;
    font-family: 'Inter', sans-serif;
    background: #f8faff;
  }
  
  /* Buttons */
  button {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    margin-top: 1rem;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background-color: #0056b3;
  }
  
  /* Recording options */
  .recording-options {
    display: flex;
    gap: 1rem;
    margin-top: 0.75rem;
  }
  .recording-options button {
    background-color: #17a2b8;
  }
  .recording-options button:hover {
    background-color: #117a8b;
  }
  
  /* Checkbox label */
  label input[type="checkbox"] {
    margin-right: 0.5rem;
    accent-color: #007bff;
  }
  
  /* Hide element */
  .hidden {
    display: none;
  }

  /* Question List */
#questionList {
    list-style-type: disc;
    padding-left: 1.25rem;
    margin-top: 0.5rem;
  }
  #questionList li {
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }
  
  /* Section header */
  #questionArea h3 {
    margin-top: 1.5rem;
    font-size: 1.25rem;
    color: #222;
  }
  
  /* Recording options */
  .recording-options {
    display: flex;
    gap: 1rem;
    margin-top: 0.75rem;
  }
  .recording-options button {
    background-color: #00b0c8;
    color: white;
    font-weight: 600;
    border: none;
    padding: 0.6rem 1.2rem;
    font-size: 1rem;
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: background-color 0.2s ease;
  }
  .recording-options button:hover {
    background-color: #008fa3;
  }
  
  /* Checkbox label */
  #questionArea label {
    display: flex;
    align-items: center;
    margin-top: 1.2rem;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 500;
  }

  .question-card-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1rem;
  }
  
  .question-card {
    background-color: #f4f8ff;
    border-radius: 12px;
    padding: 1rem 1.25rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    font-size: 1rem;
    color: #333;
    font-weight: 500;
    transition: transform 0.2s ease;
  }
  
  .question-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.07);
  }

  .media-preview {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  
  .stop-recording-btn {
    background-color: #ff4b5c;
    color: white;
    padding: 0.5rem 1rem;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  
  .stop-recording-btn:hover {
    background-color: #e93d4d;
  }
  
  
  .competency-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 1rem;
  }

  .training-meta .completed-badge {
    background: #fff7d1;
    color: #b98000;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
  }
  
  .competency-grid label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f1f5f9;
    padding: 0.5rem 1rem;
    border-radius: 999px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
    border: 2px solid transparent;
  }
  
  .competency-grid input[type="checkbox"] {
    appearance: none;
    width: 1.1rem;
    height: 1.1rem;
    border: 2px solid #999;
    border-radius: 0.25rem;
    background: white;
    position: relative;
    transition: all 0.2s ease;
  }
  
  .competency-grid input[type="checkbox"]:checked {
    background-color: #3b82f6;
    border-color: #3b82f6;
  }
  
  .competency-grid input[type="checkbox"]:checked::after {
    content: 'âœ”';
    color: white;
    font-size: 0.8rem;
    position: absolute;
    top: -2px;
    left: 3px;
  }
  
  .competency-grid label:hover {
    background-color: #e2e8f0;
  }
  
  #searchDropdown {
  display: none;           /* Hidden by default */
  position: absolute;
  top: 42px;               /* Adjust based on your navbarSearch input height */
  right: 0;
  width: 340px;            /* Match or be slightly wider than your input */
  max-height: 320px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  z-index: 99;
  overflow-y: auto;
  padding: 0;
}
.dropdown-result {
  padding: 12px 18px;
  cursor: pointer;
  border-bottom: 1px solid #f0f0f0;
  background: #fff;
  font-size: 16px;
  transition: background 0.12s;
}
.dropdown-result:last-child {
  border-bottom: none;
}
.dropdown-result:hover, .dropdown-result:focus {
  background: #f2f8fd;
  color: #0072ff;
}

#userCheckboxes {
  display: flex;
  flex-direction: column;
  gap: 0.15rem; /* closer but still breathable */
  padding: 0.25rem 0;
  max-height: 200px;
  overflow-y: auto;
}

/* Individual Checkbox Label */
#userCheckboxes label {
  display: flex;
  align-items: center;
  gap: 0.3rem; /* slightly tighter */
  font-size: 0.88rem;
  padding: 0.1rem 0.25rem;
  line-height: 1.1;
  border-radius: 6px;
  transition: background 0.15s ease;
  cursor: pointer;
}

#userCheckboxes label:hover {
  background: rgba(240, 240, 240, 0.6);
}

.user-checkbox {
  accent-color: #007aff;
  transform: scale(1.05);
  margin: 0;
}

/* Status Badge */
.status-badge {
    position: absolute;
    top: 0;
    right: 0;
    background: #10b981; /* Green for completed */
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 0 12px 0 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.incomplete {
    background: #f59e0b; /* Amber for pending */
}

/* Meta Info Row */
.training-meta {
    display: flex;
    align-items: center;       /* Vertical alignment */
    justify-content: space-between; /* Pushes elements to edges */
    width: 100%;              /* Full width of card */
    margin-top: 1rem;
    gap: 0.5rem;              /* Space between elements */
    border-top: 1px solid #f3f4f6; /* Add subtle divider */
}

.assignment-type {
    font-weight: 600;
    color: #3b82f6; /* Blue "SKILL BUILDER" text */
}

.mentee-name {
    margin-right: auto; /* Pushes to far right */
    font-weight: 600;
    margin-bottom: 10px;
    color: #3b82f6; /* Blue "SKILL BUILDER" text */
}

/* Dropdown Container */
.dropdown-sort {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
}

/* Dropdown Label */
.dropdown-sort label {
    font-size: 0.875rem;
    color: #4b5563; /* neutral-600 */
    font-weight: 500;
    white-space: nowrap;
}

/* Select Element Styling */
.dropdown-sort select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    padding: 0.5rem 2rem 0.5rem 0.75rem;
    font-size: 0.875rem;
    border: 1px solid #e5e7eb; /* gray-200 */
    border-radius: 6px;
    background-color: white;
    color: #111827; /* gray-900 */
    cursor: pointer;
    min-width: 150px;
    transition: all 0.2s ease;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    appearance: auto;
    -webkit-appearance: menulist;
    -moz-appearance: menulist;

}



/* Hover State */
.dropdown-sort select:hover {
    border-color: #9ca3af; /* gray-400 */
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* Focus State */
.dropdown-sort select:focus {
    outline: none;
    border-color: #3b82f6; /* blue-500 */
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

/* Active State */
.dropdown-sort select:active {
    border-color: #2563eb; /* blue-600 */
}

/* Dropdown Options */
.dropdown-sort option {
    padding: 0.5rem;
    font-size: 0.875rem;
    background: white;
    color: #111827;
}

/* Disabled State */
.dropdown-sort select:disabled {
    background-color: #f3f4f6; /* gray-50 */
    color: #9ca3af; /* gray-400 */
    cursor: not-allowed;
}

/* Base button style - more specific selectors */
.speaking-time-btn,
.speaking-focus-btn,
.case-time-btn,
.case-focus-btn,
.case-difficulty-btn,
.difficulty-btn,
.time-btn,
.focus-btn {
  background-color: #e6e9ff !important; /* pastel light blue */
  border: 1.5px solid #c0c4ff !important; /* subtle border */
  color: #4f74f9 !important; /* medium blue text */
  padding: 10px 18px !important;
  border-radius: 8px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  user-select: none !important;
  margin: 4px !important;
}

/* Hover effect - only when NOT selected */
.speaking-time-btn:not(.selected):hover,
.speaking-focus-btn:not(.selected):hover,
.case-time-btn:not(.selected):hover,
.case-focus-btn:not(.selected):hover,
.case-difficulty-btn:not(.selected):hover,
.difficulty-btn:not(.selected):hover,
.time-btn:not(.selected):hover,
.focus-btn:not(.selected):hover {
  background-color: #d3d7ff !important; /* slightly darker pastel */
  border-color: #9aa7ff !important;
}

/* Selected state - highest priority */
.speaking-time-btn.selected,
.speaking-focus-btn.selected,
.case-time-btn.selected,
.case-focus-btn.selected,
.case-difficulty-btn.selected,
.difficulty-btn.selected,
.time-btn.selected,
.focus-btn.selected {
  background-color: #a3b4ff !important; /* stronger pastel blue */
  border-color: #778cff !important;
  color: #1f3db8 !important; /* darker blue for text */
  box-shadow: 0 0 8px rgba(99, 117, 255, 0.6) !important;
}

/* Selected buttons should not change on hover */
.speaking-time-btn.selected:hover,
.speaking-focus-btn.selected:hover,
.case-time-btn.selected:hover,
.case-focus-btn.selected:hover,
.case-difficulty-btn.selected:hover,
.difficulty-btn.selected:hover,
.time-btn.selected:hover,
.focus-btn.selected:hover {
  background-color: #a3b4ff !important;
  border-color: #778cff !important;
  color: #1f3db8 !important;
}

/* Focus outline for accessibility */
.speaking-time-btn:focus,
.speaking-focus-btn:focus,
.case-time-btn:focus,
.case-focus-btn:focus,
.case-difficulty-btn:focus,
.difficulty-btn:focus,
.time-btn:focus,
.focus-btn:focus {
  outline: 2px solid #778cff !important;
  outline-offset: 2px !important;
}

.case-modal {
  z-index: 9000000;
}

.file-box-wrapper {
  display: flex;
  justify-content: center;
  margin-top: 10px;
  margin-bottom: 5px;
}

.file-box {
  background: #f5f5f5;
  padding: 8px 12px;
  border-radius: 8px;
  max-width: 85%;
  width: 85%;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9rem;
  word-break: break-word;
  overflow-wrap: anywhere;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.file-box a {
  color: #007bff;
  text-decoration: none;
}

.file-box a:hover {
  text-decoration: underline;
}

.card-header {
  margin-bottom: 1rem;
}

.card-content {
  flex-grow: 1;
  margin-bottom: 1.5rem;
}

.card-footer {
  margin-top: auto;
}

.mentee-name {
  font-weight: 600;
  font-size: 0.85rem;
  color: #6366f1;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.75rem;
}

.training-card h4 {
  font-size: 1.25rem; /* Increased from 1.2rem */
  font-weight: 700;
  margin-bottom: 1rem; /* Increased from 0.75rem */
  line-height: 1.3;
  color: #111827;
}

.training-card p {
  font-size: 0.95rem;
  line-height: 1.6;
  color: #6b7280;
  margin-bottom: 1rem;
}

.modal-content h2 {
  background: linear-gradient(135deg, #667eea, #764ba2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  font-size: 1.75rem;
  font-weight: 700;
  margin-bottom: 1.5rem;
}

.modal-content .close {
    /* Remove conflicting properties and streamline */
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(0, 0, 0, 0.1);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(12px);
    float: right;
    font-size: 20px;
    font-weight: 400;
    color: #6b7280;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    position: relative;
    margin: -10px -10px 0 0; /* Better positioning */
    z-index: 10;
    
    /* Ensure X is perfectly centered */
    line-height: 1;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}

.modal-content .close::before {
    content: "Ã—";
    display: block;
    font-size: 24px;
    font-weight: 300;
    line-height: 1;
    transform: translateY(-1px); /* Fine-tune vertical alignment */
}

.modal-content .close:hover {
    background: rgba(255, 255, 255, 1);
    border-color: rgba(0, 0, 0, 0.15);
    color: #374151;
    transform: scale(1.05);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
}

.modal-content .close:active {
    transform: scale(0.95);
    transition-duration: 0.1s;
}

/* Focus state for accessibility */
.modal-content .close:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
}


.modal-content {
    background: rgba(255, 255, 255, 0.98) !important;
    backdrop-filter: blur(16px) !important;
    border: 1px solid rgba(59, 130, 246, 0.1) !important;
    border-radius: 16px !important;
    box-shadow: 0 8px 32px rgba(59, 130, 246, 0.08) !important;
    padding: 2rem !important;
    max-width: 520px !important;
}

/* Clean Headers */
.modal-content h2 {
    font-size: 1.5rem !important;
    font-weight: 600 !important;
    color: #1e293b !important;
    margin-bottom: 1.5rem !important;
    letter-spacing: -0.01em !important;
}

.modal-content h3 {
    font-size: 1.125rem !important;
    font-weight: 500 !important;
    color: #334155 !important;
    margin: 1.5rem 0 1rem 0 !important;
}

/* Blue Time Buttons - Compact & Modern */
button[onclick*="selectTime"], .time-btn {
    background: rgba(59, 130, 246, 0.05) !important;
    color: #3b82f6 !important;
    border: 1px solid rgba(59, 130, 246, 0.2) !important;
    padding: 0.75rem 1.25rem !important;
    border-radius: 10px !important;
    font-weight: 500 !important;
    font-size: 0.9rem !important;
    margin: 0.25rem !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    box-shadow: none !important;
}

button[onclick*="selectTime"]:hover, .time-btn:hover {
    background: rgba(59, 130, 246, 0.1) !important;
    border-color: #3b82f6 !important;
    transform: none !important;
}

button[onclick*="selectTime"].selected, .time-btn.selected {
    background: #3b82f6 !important;
    color: white !important;
    border-color: #3b82f6 !important;
}

/* Modern Blue Checkboxes */
input[type="checkbox"] {
    appearance: none !important;
    -webkit-appearance: none !important;
    width: 20px !important;
    height: 20px !important;
    border: 2px solid #e2e8f0 !important;
    border-radius: 6px !important;
    background: white !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    position: relative !important;
    margin-right: 0.75rem !important;
    box-shadow: none !important;
}

input[type="checkbox"]:hover {
    border-color: #3b82f6 !important;
}

input[type="checkbox"]:checked {
    background: #3b82f6 !important;
    border-color: #3b82f6 !important;
}

input[type="checkbox"]:checked::after {
    content: 'âœ“' !important;
    position: absolute !important;
    top: 50% !important;
    left: 50% !important;
    transform: translate(-50%, -50%) !important;
    color: white !important;
    font-size: 12px !important;
    font-weight: 600 !important;
}

/* Compact Labels */
label {
    display: flex !important;
    align-items: center !important;
    font-weight: 400 !important;
    color: #475569 !important;
    font-size: 0.95rem !important;
    margin-bottom: 0.75rem !important;
    cursor: pointer !important;
    padding: 0.25rem 0 !important;
}

label:hover {
    color: #334155 !important;
}

/* Blue Textarea */
textarea {
    background: rgba(59, 130, 246, 0.02) !important;
    border: 1px solid rgba(59, 130, 246, 0.2) !important;
    border-radius: 10px !important;
    padding: 1rem !important;
    font-size: 0.9rem !important;
    transition: all 0.2s ease !important;
    box-shadow: none !important;
    width: 100% !important;
    min-height: 100px !important;
    box-sizing: border-box !important;
    color: #1e293b !important;
    line-height: 1.5 !important;
}

textarea:focus {
    background: rgba(59, 130, 246, 0.05) !important;
    border-color: #3b82f6 !important;
    outline: none !important;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
}

textarea::placeholder {
    color: #94a3b8 !important;
}

/* Blue Select All Button */
button[onclick*="selectAll"], button[onclick*="Select"] {
    background: rgba(59, 130, 246, 0.08) !important;
    color: #3b82f6 !important;
    border: 1px solid rgba(59, 130, 246, 0.2) !important;
    padding: 0.5rem 1rem !important;
    border-radius: 8px !important;
    font-weight: 500 !important;
    font-size: 0.85rem !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    box-shadow: none !important;
    margin: 0.5rem 0 !important;
}

button[onclick*="selectAll"]:hover, button[onclick*="Select"]:hover {
    background: rgba(59, 130, 246, 0.12) !important;
    border-color: #3b82f6 !important;
}

/* Difficulty Buttons */
button[onclick*="difficulty"], .difficulty-btn {
    background: rgba(59, 130, 246, 0.05) !important;
    color: #3b82f6 !important;
    border: 1px solid rgba(59, 130, 246, 0.2) !important;
    padding: 0.75rem 1.25rem !important;
    border-radius: 10px !important;
    font-weight: 500 !important;
    font-size: 0.9rem !important;
    margin: 0.25rem !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    box-shadow: none !important;
}

button[onclick*="difficulty"]:hover, .difficulty-btn:hover {
    background: rgba(59, 130, 246, 0.1) !important;
    border-color: #3b82f6 !important;
}

button[onclick*="difficulty"].selected, .difficulty-btn.selected {
    background: #3b82f6 !important;
    color: white !important;
    border-color: #3b82f6 !important;
}

/* Clean Close Button */
.modal-content .close {
    position: absolute !important;
    top: 16px !important;
    right: 16px !important;
    background: rgba(148, 163, 184, 0.1) !important;
    border: none !important;
    width: 32px !important;
    height: 32px !important;
    border-radius: 8px !important;
    cursor: pointer !important;
    transition: all 0.2s ease !important;
    color: #64748b !important;
    font-size: 18px !important;
}

.modal-content .close:hover {
    background: rgba(148, 163, 184, 0.2) !important;
    color: #475569 !important;
}

/* Compact Spacing */
.modal-content > * {
    margin-bottom: 1.25rem !important;
}

.modal-content > *:last-child {
    margin-bottom: 0 !important;
}

/* Remove all animations and glows */
* {
    animation: none !important;
}

.modal-content:hover {
    animation: none !important;
}

#caseModal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

#caseModal.show {
    display: flex !important;
    justify-content: center;
    align-items: center;
}


.recording-controls {
  display: flex;
  gap: 1rem;
  margin-bottom: 1rem;
}

.recording-controls button {
  background-color: transparent;
  border: 1.5px solid #3b82f6; /* subtle blue border */
  color: #3b82f6;
  font-size: 1rem;
  padding: 0.5rem 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.3s ease, color 0.3s ease;
  box-shadow: none;
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.recording-controls button:hover:not(:disabled) {
  background-color: #3b82f6;
  color: white;
  border-color: #3b82f6;
}

.recording-controls button:disabled {
  border-color: #a5b4fc;
  color: #a5b4fc;
  cursor: not-allowed;
}

#cq-speaking-submitBtn {
  background-color: transparent;
  border: 1.5px solid #10b981; /* subtle green border */
  color: #10b981;
  font-weight: 600;
  padding: 0.65rem 2rem;
  font-size: 1.1rem;
  border-radius: 8px;
  cursor: pointer;
  transition: background-color 0.3s ease, color 0.3s ease;
  width: 100%;
  max-width: 320px;
  margin: 1rem auto 0 auto;
  display: block;
}

#cq-speaking-submitBtn:hover:not(:disabled) {
  background-color: #10b981;
  color: white;
  border-color: #10b981;
}

#cq-speaking-submitBtn:disabled {
  border-color: #a7f3d0;
  color: #a7f3d0;
  cursor: not-allowed;
}


.media-preview {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 0.5rem;
}

.media-preview audio,
.media-preview video {
  border-radius: 8px;
  box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
  max-width: 100%;
  outline: none;
}

.file-info {
    margin-top: 15px;
    text-align: center;
}

.file-info small {
    color: #666;
    font-style: italic;
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 15px;
    display: inline-block;
}

/* Upload Prompt Modal Styles */
.upload-prompt-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1001;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.upload-prompt-modal.active {
    opacity: 1;
}

/* ... rest of upload modal CSS from the artifact */

#cq-speaking-submitBtn {
  background-color: #4a90e2; /* pastel blue */
  color: white;
  font-weight: 600;
  padding: 0.65rem 2.2rem;
  font-size: 1.15rem;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  transition: background-color 0.25s ease;
  width: 100%;
  max-width: 360px;
  display: block;
  margin: 1.5rem auto 0 auto;
  box-shadow: none;
}

#cq-speaking-submitBtn:hover:not(:disabled) {
  background-color: #357abd; /* slightly deeper blue */
}

#cq-speaking-submitBtn:disabled {
  background-color: #a3c2f2; /* lighter pastel blue */
  cursor: not-allowed;
  color: #e0e6f7;
}
</style>
</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">ðŸŒ</div>
    <div class="nav-title">Dashboard <span class="new-badge">(New!)</span></div>
    <div class="nav-right">
  <input type="text" id="navbarSearch" placeholder="Search CertQuest..." />
  <span class="search-icon" id="navbarSearchIcon">ðŸ”</span>
  <div id="searchDropdown"></div>
</div>
  </div>

  <!-- Section Header -->
  <div class="section-header-background">
    <div class="section-header-inline">
      <h1 class="unit-title"><span class="name">Practice Hub</span></h1>
      <button class="training-btn" id="openModalBtn" onclick="openTrainingModal()" style="margin-left: 70vw;" title="Train GPT Model">
   Train  Your Model
</button>

    </div>
    <div class="question-tabs">
  <div class="tab" onclick="selectTab(this)">Resources</div>
  <div class="tab active" onclick="selectTab(this)">Create</div> 
  <div class="tab" onclick="selectTab(this)">Judging</div>
</div>

      <div class="tab-underline"></div>
  </div>

    <aside class="sidebar">
      <div class="logo">CQ</div>
      <ul class="nav-icons">
  <li>
     <a href="/Public/home.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M12 3L20 9V21H15V15H9V21H4V9L12 3Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M12 3L4 9V21H9V15H15V21H20V9L12 3Z" stroke="#3b82f6" stroke-width="2" fill="none" stroke-linejoin="round"/>
      <rect x="10" y="17" width="4" height="4" fill="#3b82f6"/>
      <rect x="6" y="11" width="2" height="2" fill="#3b82f6"/>
      <rect x="16" y="11" width="2" height="2" fill="#3b82f6"/>
    </svg>
    
    <span class="nav-label">Home</span>
     </a>
  </li>
  <li>
  <a href="javascript:void(0)" onclick="toggleCommentPanel()">  
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Bell body main fill -->
      <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" fill="#3b82f6" fill-opacity="0.3"/>
      
      <!-- Bell body lighter overlay -->
      <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 12 6 15 6 15H18C18 15 18 12 18 8Z" fill="#3b82f6" fill-opacity="0.2"/>
      
      <!-- Bell outline -->
      <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
      
      <!-- Bell clapper -->
      <circle cx="12" cy="8" r="1" fill="#3b82f6"/>
      
      <!-- Sound waves -->
      <path d="M19 4L20 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
      <path d="M20.5 6.5L22 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
      <path d="M5 4L4 3" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.5"/>
      <path d="M3.5 6.5L2 6" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round" opacity="0.3"/>
      
      <!-- Bottom notification indicator -->
      <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Notifications</span>
  </a>
</li>
  <li>
    <a href="/Public/practice.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="12" cy="12" r="9" fill="#3b82f6" fill-opacity="0.3"/>
      <circle cx="12" cy="12" r="6" fill="#3b82f6" fill-opacity="0.2"/>
      <circle cx="12" cy="12" r="9" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <circle cx="12" cy="12" r="6" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="3" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <circle cx="12" cy="12" r="1.5" fill="#3b82f6"/>
      <path d="M16 8L12 12L16 8Z" fill="#3b82f6"/>
      <line x1="16" y1="8" x2="19" y2="5" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Practice</span>
    </a>
  </li>
  <li>
    <a href="/Public/Forum/forum.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" fill="#3b82f6" fill-opacity="0.3"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" fill="#3b82f6" fill-opacity="0.2"/>
      <path d="M8 6C8 4.89543 8.89543 4 10 4H18C19.1046 4 20 4.89543 20 6V12C20 13.1046 19.1046 14 18 14H12L8 18V6Z" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <path d="M4 10C4 8.89543 4.89543 8 6 8H8V16L4 20V12C4 11.4477 4.44772 11 5 11C4.44772 11 4 10.5523 4 10Z" stroke="#3b82f6" stroke-width="1.5" fill="none"/>
      <line x1="11" y1="8" x2="17" y2="8" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
      <line x1="11" y1="10" x2="15" y2="10" stroke="#3b82f6" stroke-width="1.5" stroke-linecap="round"/>
    </svg>
    <span class="nav-label">Forum</span>
    </a>
  </li>
  <li>
     <a href="/Public/Calendar/calendar.html">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect x="3" y="6" width="18" height="15" rx="2" fill="#3b82f6" fill-opacity="0.3"/>
      <rect x="3" y="6" width="18" height="4" rx="2" fill="#3b82f6" fill-opacity="0.2"/>
      <rect x="3" y="6" width="18" height="15" rx="2" stroke="#3b82f6" stroke-width="2" fill="none"/>
      <line x1="7" y1="3" x2="7" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="17" y1="3" x2="17" y2="7" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
      <line x1="3" y1="10" x2="21" y2="10" stroke="#3b82f6" stroke-width="1" opacity="0.5"/>
      <line x1="7.5" y1="10" x2="7.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="12" y1="10" x2="12" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <line x1="16.5" y1="10" x2="16.5" y2="21" stroke="#3b82f6" stroke-width="1" opacity="0.3"/>
      <circle cx="9" cy="13" r="1" fill="#3b82f6"/>
      <circle cx="15" cy="16" r="1" fill="#3b82f6"/>
      <circle cx="12" cy="18" r="1" fill="#3b82f6"/>
    </svg>
    <span class="nav-label">Calendar</span>
     </a>
  </li>
</ul>
    </aside>

    <!-- Sub Sidebar -->
    <aside class="sub-sidebar">
      <div class="sidebar-header">
        <span id="comp">Physics</span>
        <span class="dots">â‹¯</span>
      </div>
      <div class="sub-nav-wrapper">
        <ul class="sub-nav"> 
          <li><a class="link" href="Public/Competitions/competition.html">Your Journey</a></li>
          <li class="active"><a href="/practice.html" class="link">Practice Hub</a></li>
          <li><a href="/statistics.html" class="link">Your Statistics</a></li>
        </ul>
      </div>
    </aside>
  </div>

  <div class="content"> <br>
    <div class="exam-summary-container">
        <!-- Exam Creation -->
        <div class="create-exam-card" style="margin-left: 0px; width: 1000px;">
          <h2>Create your Practice</h2>
          <p>Weâ€™ll generate an exam based on what you want to practice</p>
          <div class="exam-buttons">
            <button onclick="openWrittenModal()">Written</button>
            <button class="speaking-btn" onclick="openSpeakingModal()">Speaking</button>
            <button onclick="openCaseModal()">Case</button>
          </div>
        </div>
      
        <!-- Score + Breakdown -->
        <div class="performance-section" style="margin-left: -1100px; width: 50vw;">
          <div class="performance-summary">
            <div class="score-ring">
              <svg viewBox="0 0 36 36">
                <path class="bg" d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831"/>
                <path class="progress" stroke-dasharray="90, 100" d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831"/>
                <text x="18" y="20.35" class="percentage">90%</text>
              </svg>
            </div>
            <div class="score-details">
              <p><strong>Correct</strong> <span class="blue">18</span></p>
              <p><strong>Incorrect</strong> <span class="gray">2</span></p>
              <p><strong>Skipped</strong> <span class="gray">0</span></p>
            </div>
          </div>
      
          <div class="performance-breakdown">
            
            <ul>
              <li>Booleans and Logic <span>2 / 2</span></li>
              <li>Arrays and ArrayLists <span>6 / 6</span></li>
              <li>Iteration <span>3 / 5</span></li>
              <li>Recursion <span>3 / 3</span></li>
              <li>Primitive Types <span>2 / 2</span></li>
              <li>Inheritance <span>1 / 1</span></li>
              <li>2D Arrays <span>1 / 1</span></li>
            </ul>
          </div>
        </div>
      </div>      
  </div>
  <!-- Written Practice Modal -->
<div id="writtenModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeWrittenModal()"></span>
      <h2>Written Practice Setup</h2>
  
      <div class="modal-section">
        <label><strong>Time:</strong></label>
        <div class="time-options">
          <button class="time-btn" onclick="selectTime(this)">15 min</button>
          <button class="time-btn" onclick="selectTime(this)">30 min</button>
          <button class="time-btn" onclick="selectTime(this)">50 min</button>
        </div>
      </div>
  
      <div class="modal-section">
        <label><strong>Competencies Tested</strong></label><br>
        
        <div class="checkbox-group">
          <label><input type="checkbox" class="competency-option" value="Business Communication"> Business Communication</label>
          <label><input type="checkbox" class="competency-option" value="Marketing"> Marketing</label>
          <label><input type="checkbox" class="competency-option" value="Accounting"> Accounting</label>
          <label><input type="checkbox" class="competency-option" value="Economics"> Economics</label>
          <!-- Add more as needed -->
          <button type="button" class="select-all-btn" onclick="selectAllCompetencies()">Select All</button>
        </div>
      </div>
      
  
      <div class="modal-section">
        <label><strong>Difficulty:</strong></label>
        <div class="difficulty-options">
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Easy</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Medium</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Hard</button>
        </div>
      </div>
  
      <div class="checkbox-row">
        <input type="checkbox" id="simulate" />
        <label for="simulate">Simulate BluePanda testing environment</label>
      </div>
  
      <div class="button-group" style="display: flex; gap: 12px; margin-top: 1rem;">
  <button class="start-btn" onclick="generateQuizQuestions()" style="flex: 1;">Customized Test</button>
  <button class="personalized-btn" onclick="generatePersonalizedTest()" style="flex: 1; margin-top: 1.5rem;
    width: 100%;
    padding: 0.6rem 1.2rem;
    background-color: #0066ff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;">SMART Test</button>
</div>

    </div>
  </div>

<div class="modal speaking-modal hidden" id="speakingModal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('speakingModal')"></span>
      <h2>Speaking Practice</h2>
  
      <div class="modal-section">
        <label for="speechInput"><strong>Paste Your Speech</strong></label>
        <textarea id="speechInput" placeholder="Paste your speech here..." rows="6"></textarea>
         <button onclick="generateQuestions()">Generate Questions</button>
      </div>
  
     
  
      <div class="modal-section hidden" id="questionArea">
        <h3>Generated Questions</h3>
        <div id="questionList" class="question-card-list"></div>
  
        <label><strong>Record your responses:</strong></label>
       <div class="cq-speaking-section">
    <button id="recordMyAnswer" class="record-my-answer-btn" onclick="openCameraModal()">
        ðŸŽ¥ Record My Answer
    </button>
</div>
  
      </div>
    </div>
  </div>
  
  <!-- CASE MODAL -->
  <div id="caseModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('caseModal')"></span>
      <h2>Case Practice</h2>
  
      <div id="casePromptSection">
        <p><strong>Choose up to 5 competencies:</strong></p>
        <div class="competency-grid">
          <label><input type="checkbox" class="competency-option" /> Teamwork</label><br><br>
          <label><input type="checkbox" class="competency-option" /> Leadership</label><br>
          <label><input type="checkbox" class="competency-option" /> Innovation</label><br>
          <label><input type="checkbox" class="competency-option" /> Communication</label>
          <label><input type="checkbox" class="competency-option" /> Ethics</label>
        </div>
  
        <p><strong>Select difficulty:</strong></p>
        <div class="difficulty-options">
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Easy</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Medium</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Hard</button>
        </div>
  
        <br />
        <button class="generate-btn" onclick="generateCase()">Generate Case</button>
      </div>
  
      <div id="caseResultSection" style="display: none;">
        <div style="background:#f3f6fa; padding:1rem; border-radius:8px;">
          <h3>ðŸ§  Your Case Prompt</h3>
          <p><strong>Difficulty:</strong> <span id="caseDifficulty"></span></p>
          <p><strong>Focus Competencies:</strong> <span id="caseCompetencies"></span></p>
          <p style="margin-top:1rem;" id="caseText">
            <em>You are part of a team launching a new tech startup...</em>
          </p>
        </div>
  
        <div id="caseRecording" style="margin-top: 1.5rem;">
          <label><strong>ðŸŽ™ï¸ Record your response:</strong></label>
          <div style="display: flex; gap: 1rem; margin-top: 0.75rem;">
            <button onclick="startAudio('case')">Audio</button>
            <button onclick="startVideo('case')">Video</button>
            <button id="stopBtnCase" onclick="stopRecording('case')" style="display: none;">â¹ï¸ Stop</button>
          </div>
  
          <div class="media-preview">
            <audio id="audioPlaybackCase" controls style="display: none; margin-top: 1rem;"></audio>
            <video id="videoPreviewCase" style="display: none; margin-top: 1rem; max-width: 100%; border-radius: 10px;" autoplay playsinline muted></video>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  
  <div id="quizModal" class="modal">
  <div class="modal-content quiz-modal-content">
    <div class="quiz-header">
      <div class="quiz-info">
        <h2 id="quizTitle">Practice Quiz</h2>
        <div class="quiz-meta">
          <span id="quizProgress">Question 1 of 10</span>
          <span id="quizTimer">15:00</span>
        </div>
      </div>
      <button class="close-quiz" onclick="closeQuizModal()">&times;</button>
    </div>
    
    <div class="quiz-content">
      <div class="question-section">
        <div class="competency-tag" id="questionCompetency">Marketing</div>
        <h3 id="questionText">Loading question...</h3>
      </div>
      
      <div class="options-section" id="optionsContainer">
        <!-- Options will be populated dynamically -->
      </div>
      
      <div class="quiz-navigation">
        <button id="prevBtn" onclick="previousQuestion()" disabled>Previous</button>
        <button id="nextBtn" onclick="nextQuestion()">Next</button>
        <button id="submitBtn" onclick="submitQuiz()" style="display: none;">Submit Quiz</button>
      </div>
    </div>
    
    <div class="quiz-progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>
</div>

<!-- Quiz Results Modal -->
<div id="quizResultsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeQuizResultsModal()">&times;</span>
    <h2>Quiz Complete!</h2>
    
    <div class="results-summary">
      <div class="score-circle">
        <div class="score-display" id="finalScore">85%</div>
      </div>
      
      <div class="results-stats">
        <div class="stat-item">
          <span class="stat-label">Correct:</span>
          <span class="stat-value" id="correctCount">17</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Incorrect:</span>
          <span class="stat-value" id="incorrectCount">3</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Time Used:</span>
          <span class="stat-value" id="timeUsed">12:34</span>
        </div>
      </div>
    </div>
    
    <div class="competency-breakdown" id="competencyBreakdown">
      <!-- Competency results will be populated here -->
    </div>
    <div class="results-actions">
      <button onclick="reviewQuestions()">Review Questions</button>
      <button onclick="closeQuizResultsModal()">Close</button>
    </div>
  </div>
</div>

<!-- Quiz Results Modal -->
<div id="quizResultsModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeQuizResultsModal()">&times;</span>
    <h2>Quiz Complete!</h2>
    
    <div class="results-summary">
      <div class="score-circle">
        <div class="score-display" id="finalScore">85%</div>
      </div>
      
      <div class="results-stats">
        <div class="stat-item">
          <span class="stat-label">Correct:</span>
          <span class="stat-value" id="correctCount">17</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Incorrect:</span>
          <span class="stat-value" id="incorrectCount">3</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Time Used:</span>
          <span class="stat-value" id="timeUsed">12:34</span>
        </div>
      </div>
    </div>
    
    <div class="competency-breakdown" id="competencyBreakdown">
      <!-- Competency results will be populated here -->
    </div>
    <div class="results-actions">
      <button class="primary-btn" onclick="reviewQuestions()">Review Questions</button>
      <button onclick="closeQuizResultsModal()">Close</button>
    </div>
  </div>
</div>


  <!-- Training Modal -->
<div id="pdfModal" style="display: none;">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Train Your Model</h2>
            
            <div class="training-section">
                <h3>ðŸ“„ Upload Study Material (Optional)</h3>
                <div id="dropZone">
                    <div class="drop-zone-content">
                        <div class="drop-zone-icon">ðŸ“„</div>
                        <div class="drop-zone-text">Drag & Drop PDF Here or Click to Upload</div>
                        <div class="drop-zone-subtext">Supports PDF files up to 10MB</div>
                    </div>
                </div>
                <div id="fileName"></div>
            </div>
            
            <div class="training-section">
                <h3>âœï¸ Add Your Own Questions</h3>
                <div id="manualQuestionsContainer">
                    <!-- Questions will be added here -->
                </div>
                <button onclick="addQuestionInput()">
                    <span>+</span>
                    Add Question
                </button>
            </div>
            
            <button onclick="usePDFForTraining()">
                Start Training Your Model
            </button>
        </div>
    </div>

    <button id="cq-speaking-downloadBtn" style="
  background: linear-gradient(90deg, #aee7f5, #e0c3fc);
  color: #222;
  border: none;
  border-radius: 1.25rem;
  padding: 0.7rem 1.8rem;
  font-size: 1.06rem;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(60,60,120,0.09);
  cursor: pointer;
  margin: 1rem 0 0 0;
  transition: background 0.18s, transform 0.12s, box-shadow 0.15s;
  outline: none;
">Download Your Response</button>

<button id="cq-speaking-submitBtn" class="primary-btn">Submit Response</button>

  
  
  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>

  
  <script>

  // Initialize Firebase
  const db = firebase.firestore();
  const auth = firebase.auth();

  

firebase.auth().onAuthStateChanged(async user => {
  if (!user) return;
  
  console.log('User authenticated, loading quiz data...');
  
  // Load existing quiz results
  await reloadQuizCardsFromFirebase();
});

 let selectedFile = null;
  let selectedDifficulty = 'easy'; // Default difficulty
  let cameraStream = null;
let recordingTimer = null;
let recordingSeconds = 0;
let cameraEnabled = true;
let micEnabled = true;
let selectedUploadFile = null;
let isRecording = true;

// Add these right after your Firebase init
window.addEventListener('dragover', function(e) {
  e.preventDefault();
  e.stopPropagation();
}, false);

window.addEventListener('drop', function(e) {
  e.preventDefault();
  e.stopPropagation();
}, false);

// Get modal elements
const modal = document.getElementById('pdfModal');
const openBtn = document.getElementById('openModalBtn');
const closeBtn = modal.querySelector('.close');
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const fileNameDisplay = document.getElementById('fileName');

const updatedModalHTML = `
<div id="pdfModal" class="modal">
  <div class="modal-content" style="max-width: 800px;">
    <span class="close" onclick="closeTrainingModal()">&times;</span>
    <h2>Train Your Model</h2>
    
    <!-- PDF Upload Section -->
    <div class="training-section">
      <h3>ðŸ“„ Upload Study Material (Optional)</h3>
      <div id="dropZone" style="border: 2px dashed #ccc; padding: 2rem; text-align: center; margin-bottom: 1rem; cursor: pointer; border-radius: 8px;">
        Drag & Drop PDF Here or Click to Upload
      </div>
      <input type="file" id="fileInput" accept="application/pdf" hidden />
      <p id="fileName" style="margin-top: 0.5rem; color: #666;"></p>
    </div>

    <!-- Manual Questions Section -->
    <div class="training-section" style="margin-top: 2rem;">
      <h3>âœï¸ Add Your Own Questions</h3>
      <div id="manualQuestionsContainer">
        <!-- Questions will be added here dynamically -->
      </div>
      <button type="button" onclick="addQuestionInput()" style="background: #3b82f6; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; margin-top: 1rem;">
        âž• Add Question
      </button>
    </div>

    <button onclick="usePDFForTraining()" class="start-btn" style="margin-top: 2rem; width: 100%;">
      Save Training Data
    </button>
  </div>
</div>`;

// Initialize manual questions array
let manualQuestions = [];
// Initialize question counter
let questionCounter = 0;

function addQuestionInput() {
  questionCounter++;
  const container = document.getElementById('manualQuestionsContainer');
  
  const questionDiv = document.createElement('div');
  questionDiv.className = 'question-input-group';
  questionDiv.id = `question-${questionCounter}`;
  
  questionDiv.innerHTML = `
    <div class="question-header">
      <div class="question-number" style="display: none;">${questionCounter} <button type="button" onclick="removeQuestion(${questionCounter})" class="remove-btn" style="margin-left: 200px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button></div>
      <h4>Question ${questionCounter}</h4>
      
    </div>
    
    <div class="form-group">
      <label for="questionText-${questionCounter}">Question Text:</label>
      <textarea id="questionText-${questionCounter}" placeholder="Enter your question here..."></textarea>
    </div> <br>
    
    <div class="form-group">
      <label for="competency-${questionCounter}">Competency:</label>
      <select id="competency-${questionCounter}">
        <option value="">Select competency...</option>
        <option value="Business Communication">Business Communication</option>
        <option value="Marketing">Marketing</option>
        <option value="Accounting">Accounting</option>
        <option value="Economics">Economics</option>
        <option value="Parliamentary Procedure">Parliamentary Procedure</option>
        <option value="Leadership">Leadership</option>
        <option value="Management">Management</option>
        <option value="Finance">Finance</option>
        <option value="Entrepreneurship">Entrepreneurship</option>
        <option value="Business Ethics">Business Ethics</option>
      </select>
    </div> <br>
    
    <div class="options-grid">
      <div class="form-group">
        <label for="optionA-${questionCounter}">Option A:</label>
        <input type="text" id="optionA-${questionCounter}" placeholder="Option A">
      </div>
      <div class="form-group">
        <label for="optionB-${questionCounter}">Option B:</label>
        <input type="text" id="optionB-${questionCounter}" placeholder="Option B">
      </div>
      <div class="form-group" style="margin-top: 20xpx;">
        <label for="optionC-${questionCounter}">Option C:</label>
        <input type="text" id="optionC-${questionCounter}" placeholder="Option C">
      </div>
      <div class="form-group">
        <label for="optionD-${questionCounter}">Option D:</label>
        <input type="text" id="optionD-${questionCounter}" placeholder="Option D">
      </div>
    </div>
    
    <div class="correct-answer-container">
      <label for="correctAnswer-${questionCounter}">Correct Answer:</label>
      <select id="correctAnswer-${questionCounter}">
        <option value="">Select correct answer...</option>
        <option value="A">Option A</option>
        <option value="B">Option B</option>
        <option value="C">Option C</option>
        <option value="D">Option D</option>
      </select>
    </div>
  `;
  
  container.appendChild(questionDiv);
}


function renumberQuestions() {
  const questions = document.querySelectorAll('.question-input-group');
  questions.forEach((question, index) => {
    const questionNumber = index + 1;
    question.id = `question-${questionNumber}`;
    question.querySelector('.question-number').textContent = questionNumber;
    question.querySelector('h4').textContent = `Question ${questionNumber}`;
    // Update remove button onclick
    const removeBtn = question.querySelector('.remove-btn');
    removeBtn.setAttribute('onclick', `removeQuestion(${questionNumber})`);
  });
  questionCounter = questions.length;
}

// Function to remove a question
function removeQuestion(questionId) {
  const questionToRemove = document.getElementById(`question-${questionId}`);
  if (questionToRemove) {
    questionToRemove.remove();
    // Optional: Re-number remaining questions
    renumberQuestions();
  }
}
// Updated openTrainingModal function
function openTrainingModal() {
  const modal = document.getElementById('pdfModal');
  modal.style.display = 'flex';
  
  // Reset inputs
  const fileInput = document.getElementById('fileInput');
  const fileNameDisplay = document.getElementById('fileName');
  if (fileInput) fileInput.value = '';
  if (fileNameDisplay) fileNameDisplay.textContent = '';
  
  // Clear manual questions
  const container = document.getElementById('manualQuestionsContainer');
  if (container) container.innerHTML = '';
  manualQuestions = [];
  questionCounter = 0;
  
  // Add one initial question input
  addQuestionInput();
}

// Function to collect manual questions
function collectManualQuestions() {
  const questions = [];
  const container = document.getElementById('manualQuestionsContainer');
  
  if (!container) return questions;
  
  const questionDivs = container.querySelectorAll('.question-input-group');
  
  questionDivs.forEach(div => {
    const id = div.id.split('-')[1];
    
    const questionText = document.getElementById(`questionText-${id}`)?.value.trim();
    const competency = document.getElementById(`competency-${id}`)?.value;
    const optionA = document.getElementById(`optionA-${id}`)?.value.trim();
    const optionB = document.getElementById(`optionB-${id}`)?.value.trim();
    const optionC = document.getElementById(`optionC-${id}`)?.value.trim();
    const optionD = document.getElementById(`optionD-${id}`)?.value.trim();
    const correctAnswerLetter = document.getElementById(`correctAnswer-${id}`)?.value;
    
    // Validate question completeness
    if (questionText && competency && optionA && optionB && optionC && optionD && correctAnswerLetter) {
      const options = [optionA, optionB, optionC, optionD];
      const correctAnswerIndex = ['A', 'B', 'C', 'D'].indexOf(correctAnswerLetter);
      const correctAnswer = options[correctAnswerIndex];
      
      questions.push({
        text: questionText,
        competency: competency,
        options: options,
        correctAnswer: correctAnswer,
        source: 'manual'
      });
    }
  });
  
  return questions;
}


// Modal open/close functions
function openTrainingModal() {
  modal.style.display = 'flex';
  // Reset inputs
  fileInput.value = '';
  fileNameDisplay.textContent = '';
}

function closeTrainingModal() {
  modal.style.display = 'none';
}

// Event listeners for modal
openBtn.addEventListener('click', openTrainingModal);
closeBtn.addEventListener('click', closeTrainingModal);

// Simple drag and drop setup
function setupDragAndDrop() {
  if (!dropZone) return;
  
  // Click to upload
  dropZone.addEventListener('click', () => fileInput.click());
  
  // Drag events
  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.style.backgroundColor = '#f0f9ff';
    dropZone.style.borderColor = '#3b82f6';
  });
  
  dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.style.backgroundColor = '';
    dropZone.style.borderColor = '';
  });
  
  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropZone.style.backgroundColor = '';
    dropZone.style.borderColor = '';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });
}

// Call setup function after modal elements are ready
setTimeout(setupDragAndDrop, 100);



function handleFile(file) {
  // Check if file is PDF
  const isPDF = file.type === 'application/pdf' || 
                file.name.toLowerCase().endsWith('.pdf');
  
  if (!isPDF) {
    fileNameDisplay.textContent = 'âŒ Please upload a PDF file.';
    fileNameDisplay.style.color = '#ef4444';
    return;
  }

  fileNameDisplay.textContent = `âœ… Uploaded: ${file.name}`;
  fileNameDisplay.style.color = '#10b981';

  // Process the PDF client-side
  processPDF(file);
}
async function processPDF(file) {
  const reader = new FileReader();
  
  reader.onload = async function(e) {
    try {
      const typedArray = new Uint8Array(e.target.result);
      const pdf = await pdfjsLib.getDocument(typedArray).promise;
      let fullText = '';
      
      // Extract text from each page
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        fullText += textContent.items.map(item => item.str).join(' ');
      }
      
      // Store the extracted text
      localStorage.setItem('currentTrainingText', fullText);
      fileNameDisplay.textContent = `âœ… Processed: ${file.name}`;
      
      // Use the text for training
      prepareTrainingData(fullText);
      
    } catch (error) {
      console.error('PDF processing error:', error);
      fileNameDisplay.textContent = 'âŒ Error processing PDF';
      fileNameDisplay.style.color = '#ef4444';
    }
  };
  
  reader.readAsArrayBuffer(file);
}
function prepareTrainingData(text) {
  // Process the text for your training needs
  const trainingData = {
    content: text.substring(0, 5000), // limit size
    lastUpdated: Date.now()
  };
  
  localStorage.setItem('gptTrainingContext', JSON.stringify(trainingData));
  console.log('Training data prepared');
}

function usePDFForTraining() {
  // Collect manual questions
  const userQuestions = collectManualQuestions();
  
  // Get PDF content if available
  const pdfContent = localStorage.getItem('currentTrainingText');
  
  // Prepare combined training data
  const trainingData = {
    pdfContent: pdfContent || null,
    userQuestions: userQuestions,
    lastUpdated: Date.now()
  };
  
  // Store the training data
  localStorage.setItem('gptTrainingContext', JSON.stringify(trainingData));
  
  console.log('Training data saved:', trainingData);
  
  // Show success message
  const fileName = document.getElementById('fileName');
  if (fileName) {
    fileName.textContent = `âœ… Training data saved! (${userQuestions.length} custom questions + ${pdfContent ? 'PDF content' : 'no PDF'})`;
    fileName.style.color = '#10b981';
  }
  
  // Close modal after a short delay
  setTimeout(() => {
    closeTrainingModal();
  }, 1500);
}



function uploadPDFToFirebase(file) {
  const user = firebase.auth().currentUser;
  if (!user) {
    console.error('User not authenticated');
    return;
  }

  const storageRef = firebase.storage().ref();
  const fileRef = storageRef.child(`training/${user.uid}/${file.name}`);
  
  const uploadTask = fileRef.put(file);
  
  uploadTask.on('state_changed',
    (snapshot) => {
      // Progress monitoring
      const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
      console.log('Upload is ' + progress + '% done');
    },
    (error) => {
      console.error('Upload failed:', error);
      fileNameDisplay.textContent = 'âŒ Upload failed. Please try again.';
      fileNameDisplay.style.color = '#ef4444';
    },
    () => {
      // Upload completed successfully
      uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
        console.log('File available at', downloadURL);
        fileNameDisplay.textContent += ' (Upload complete)';
        
        // Here you would typically save the PDF reference to Firestore
        savePDFReferenceToFirestore(file.name, downloadURL);
      });
    }
  );
}


// Function to generate flashcards from incorrect answers
async function generateCompetencyFlashcards(quizResults) {
  // 1. Filter incorrect answers grouped by competency
  const incorrectByCompetency = {};
  
  quizResults.questionResults.forEach(question => {
    if (!question.isCorrect) {
      const competency = question.competency || 'General';
      if (!incorrectByCompetency[competency]) {
        incorrectByCompetency[competency] = [];
      }
      incorrectByCompetency[competency].push(question);
    }
  });

  // 2. Generate flashcards for each competency
  const flashcards = [];
  
  for (const [competency, questions] of Object.entries(incorrectByCompetency)) {
    try {
      const competencyFlashcards = await generateFlashcardsWithAI(competency, questions);
      flashcards.push(...competencyFlashcards);
    } catch (error) {
      console.error(`Error generating flashcards for ${competency}:`, error);
      // Fallback to simple flashcards
      questions.forEach(question => {
        flashcards.push({
          competency,
          question: question.text,
          answer: question.correctAnswer,
          explanation: `The correct answer is ${question.correctAnswer} because...`,
          options: question.options
        });
      });
    }
  }

  // 3. Display the generated flashcards
  displayFlashcards(flashcards);
  return flashcards;
}

// AI-powered flashcard generation
async function generateFlashcardsWithAI(competency, questions) {
  const prompt = `Generate 3-5 high quality flashcards for ${competency} competency based on these incorrect answers:
  
  ${questions.map(q => `
    - Question: ${q.text}
      Your answer: ${q.userAnswer}
      Correct answer: ${q.correctAnswer}
  `).join('\n')}

  Format each flashcard as JSON with:
  {
    "competency": "${competency}",
    "question": "clear question focusing on the concept missed",
    "answer": "concise correct answer",
    "explanation": "1-2 sentence explanation of why this is correct",
    "options": ["multiple", "choice", "options", "if applicable"]
  }

  Make questions different from the originals but test the same concept.`;

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${yourOpenAIKey}`
    },
    body: JSON.stringify({
      model: "gpt-4",
      messages: [{ role: "user", content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt }],
      temperature: 0.7,
      max_tokens: 2000
    })
  });

  const data = response.data;
  const content = data.content;
  
  // Extract JSON from response
  const jsonStart = content.indexOf('[');
  const jsonEnd = content.lastIndexOf(']') + 1;
  return JSON.parse(content.slice(jsonStart, jsonEnd));
}

// Display flashcards in UI
function displayFlashcards(flashcards) {
  const container = document.getElementById('flashcardsContainer');
  container.innerHTML = '';
  
  // Group by competency
  const byCompetency = flashcards.reduce((acc, card) => {
    if (!acc[card.competency]) acc[card.competency] = [];
    acc[card.competency].push(card);
    return acc;
  }, {});

  // Create UI elements
  for (const [competency, cards] of Object.entries(byCompetency)) {
    const competencyHeader = document.createElement('h3');
    competencyHeader.textContent = competency;
    competencyHeader.className = 'competency-header';
    container.appendChild(competencyHeader);

    const cardGrid = document.createElement('div');
    cardGrid.className = 'flashcard-grid';
    
    cards.forEach((card, i) => {
      const flashcard = document.createElement('div');
      flashcard.className = 'flashcard';
      flashcard.innerHTML = `
        <div class="flashcard-front">
          <span class="competency-pill">${card.competency}</span>
          <p>${card.question}</p>
          ${card.options ? `<div class="flashcard-options">${
            card.options.map(opt => `<div>${opt}</div>`).join('')
          }</div>` : ''}
        </div>
        <div class="flashcard-back">
          <h4>Answer</h4>
          <p>${card.answer}</p>
          <div class="flashcard-explanation">
            <h5>Explanation</h5>
            <p>${card.explanation}</p>
          </div>
        </div>
      `;
      flashcard.addEventListener('click', () => {
        flashcard.classList.toggle('flipped');
      });
      cardGrid.appendChild(flashcard);
    });
    
    container.appendChild(cardGrid);
  }
}

function savePDFReferenceToFirestore(filename, url) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  db.collection('trainingDocuments').add({
    userId: user.uid,
    filename: filename,
    url: url,
    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
    processed: false
  }).then(() => {
    console.log('Document reference saved to Firestore');
  }).catch(error => {
    console.error('Error saving document reference:', error);
  });
}






function createIndividualQuizCard(quiz, cardNumber) {
  const card = document.createElement('div');
  card.className = 'quiz-performance-card';
  card.style.cssText = `
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
  `;

  // Calculate overall performance
  const totalQuestions = quiz.questions ? quiz.questions.length : 0;
  const correctAnswers = quiz.questions ? quiz.questions.filter(q => q.correct).length : 0;
  const overallPercentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

  // Create header with title and date
  const header = document.createElement('div');
  header.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  `;



  header.appendChild(title);
  header.appendChild(dateSpan);

  // Create main content container
  const mainContent = document.createElement('div');
  mainContent.style.cssText = `
    display: flex;
    gap: 2rem;
    align-items: flex-start;
  `;

  // Create circular progress and stats section
  const leftSection = document.createElement('div');
  leftSection.style.cssText = `
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  `;

  // Create circular progress
  const circularProgress = document.createElement('div');
  circularProgress.style.cssText = `
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: conic-gradient(#3b82f6 0deg ${overallPercentage * 3.6}deg, #e5e7eb ${overallPercentage * 3.6}deg 360deg);
    display: flex;
    align-items: center;
    justify-content: center;
  `;

  const innerCircle = document.createElement('div');
  innerCircle.style.cssText = `
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 600;
    color: #3b82f6;
  `;
  innerCircle.textContent = `${overallPercentage}%`;

  circularProgress.appendChild(innerCircle);

  // Create stats below circle
  const stats = document.createElement('div');
  stats.style.cssText = `
    text-align: center;
  `;

  const correctDiv = document.createElement('div');
  correctDiv.innerHTML = `<strong>Correct</strong> ${correctAnswers}`;
  correctDiv.style.cssText = `
    margin-bottom: 0.25rem;
    color: #1f2937;
  `;

  const incorrectDiv = document.createElement('div');
  incorrectDiv.innerHTML = `<strong>Incorrect</strong> ${totalQuestions - correctAnswers}`;
  incorrectDiv.style.cssText = `
    margin-bottom: 0.25rem;
    color: #1f2937;
  `;

  const skippedDiv = document.createElement('div');
  skippedDiv.innerHTML = `<strong>Skipped</strong> 0`;
  skippedDiv.style.cssText = `
    color: #1f2937;
  `;

  stats.appendChild(correctDiv);
  stats.appendChild(incorrectDiv);
  stats.appendChild(skippedDiv);

  leftSection.appendChild(circularProgress);
  leftSection.appendChild(stats);

  // Group questions by competency
  const competencyGroups = {};
  if (quiz.questions) {
    quiz.questions.forEach(question => {
      const competency = question.competency || 'Other';
      if (!competencyGroups[competency]) {
        competencyGroups[competency] = [];
      }
      competencyGroups[competency].push(question);
    });
  }

  // Create competency sections (right side)
  const competencyContainer = document.createElement('div');
  competencyContainer.style.cssText = `
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  `;

  Object.entries(competencyGroups).forEach(([competency, questions]) => {
    const competencyItem = document.createElement('div');
    competencyItem.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e5e7eb;
    `;

    const competencyCorrect = questions.filter(q => q.correct).length;
    const competencyTotal = questions.length;

    const competencyName = document.createElement('span');
    competencyName.textContent = competency;
    competencyName.style.cssText = `
      font-weight: 500;
      color: #1f2937;
    `;

    const competencyStats = document.createElement('span');
    competencyStats.textContent = `${competencyCorrect} / ${competencyTotal}`;
    competencyStats.style.cssText = `
      color: #6b7280;
      font-weight: 500;
    `;

    competencyItem.appendChild(competencyName);
    competencyItem.appendChild(competencyStats);
    competencyContainer.appendChild(competencyItem);
  });

  mainContent.appendChild(leftSection);
  mainContent.appendChild(competencyContainer);

  // Assemble the card
  card.appendChild(header);
  card.appendChild(mainContent);

  return card;
}

function createIndividualQuizCard(quiz, cardNumber) {
  const card = document.createElement('div');
  card.className = 'quiz-performance-card';
  card.style.cssText = `
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
  `;

  // Calculate overall performance
  const totalQuestions = quiz.questions ? quiz.questions.length : 0;
  const correctAnswers = quiz.questions ? quiz.questions.filter(q => q.correct).length : 0;
  const overallPercentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

  // Create header with title and date
  const header = document.createElement('div');
  header.style.cssText = `
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
  `;

  const title = document.createElement('h3');
  title.textContent = `Performance breakdown`;
  title.style.cssText = `
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
  `;

  const dateSpan = document.createElement('span');
  dateSpan.textContent = new Date().toLocaleString();
  dateSpan.style.cssText = `
    color: #6b7280;
    font-size: 0.875rem;
  `;

  header.appendChild(title);
  header.appendChild(dateSpan);

  // Create main content container
  const mainContent = document.createElement('div');
  mainContent.style.cssText = `
    display: flex;
    gap: 2rem;
    align-items: flex-start;
  `;

  // Create circular progress and stats section
  const leftSection = document.createElement('div');
  leftSection.style.cssText = `
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  `;

  // Create circular progress
  const circularProgress = document.createElement('div');
  circularProgress.style.cssText = `
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: conic-gradient(#3b82f6 0deg ${overallPercentage * 3.6}deg, #e5e7eb ${overallPercentage * 3.6}deg 360deg);
    display: flex;
    align-items: center;
    justify-content: center;
  `;

  const innerCircle = document.createElement('div');
  innerCircle.style.cssText = `
    width: 90px;
    height: 90px;
    border-radius: 50%;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    font-weight: 600;
    color: #3b82f6;
  `;
  innerCircle.textContent = `${overallPercentage}%`;

  circularProgress.appendChild(innerCircle);

  // Create stats below circle
  const stats = document.createElement('div');
  stats.style.cssText = `
    text-align: center;
  `;

  const correctDiv = document.createElement('div');
  correctDiv.innerHTML = `<strong>Correct</strong> ${correctAnswers}`;
  correctDiv.style.cssText = `
    margin-bottom: 0.25rem;
    color: #1f2937;
  `;

  const incorrectDiv = document.createElement('div');
  incorrectDiv.innerHTML = `<strong>Incorrect</strong> ${totalQuestions - correctAnswers}`;
  incorrectDiv.style.cssText = `
    margin-bottom: 0.25rem;
    color: #1f2937;
  `;

  const skippedDiv = document.createElement('div');
  skippedDiv.innerHTML = `<strong>Skipped</strong> 0`;
  skippedDiv.style.cssText = `
    color: #1f2937;
  `;

  stats.appendChild(correctDiv);
  stats.appendChild(incorrectDiv);
  stats.appendChild(skippedDiv);

  leftSection.appendChild(circularProgress);
  leftSection.appendChild(stats);

  // Group questions by competency
  const competencyGroups = {};
  if (quiz.questions) {
    quiz.questions.forEach(question => {
      const competency = question.competency || 'Other';
      if (!competencyGroups[competency]) {
        competencyGroups[competency] = [];
      }
      competencyGroups[competency].push(question);
    });
  }

  // Create competency sections (right side)
  const competencyContainer = document.createElement('div');
  competencyContainer.style.cssText = `
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  `;

  Object.entries(competencyGroups).forEach(([competency, questions]) => {
    const competencyItem = document.createElement('div');
    competencyItem.style.cssText = `
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e5e7eb;
    `;

    const competencyCorrect = questions.filter(q => q.correct).length;
    const competencyTotal = questions.length;

    const competencyName = document.createElement('span');
    competencyName.textContent = competency;
    competencyName.style.cssText = `
      font-weight: 500;
      color: #1f2937;
    `;

    const competencyStats = document.createElement('span');
    competencyStats.textContent = `${competencyCorrect} / ${competencyTotal}`;
    competencyStats.style.cssText = `
      color: #6b7280;
      font-weight: 500;
    `;

    competencyItem.appendChild(competencyName);
    competencyItem.appendChild(competencyStats);
    competencyContainer.appendChild(competencyItem);
  });

  mainContent.appendChild(leftSection);
  mainContent.appendChild(competencyContainer);

  // Assemble the card
  card.appendChild(header);
  card.appendChild(mainContent);

  return card;
}

function createIndividualQuizCard(quiz, cardNumber) {
  const card = document.createElement('div');
  card.className = 'quiz-performance-card';
  card.style.cssText = `
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border: 1px solid #e5e7eb;
    margin-bottom: 1rem;
  `;

  // Calculate overall performance
  const totalQuestions = quiz.questions ? quiz.questions.length : 0;
  const correctAnswers = quiz.questions ? quiz.questions.filter(q => q.correct).length : 0;
  const overallPercentage = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;

  // Create title
  const title = document.createElement('h3');
  title.textContent = `${quiz.title || `Quiz ${cardNumber}`}`;
  title.style.cssText = `
    margin: 0 0 1rem 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: #1f2937;
  `;

  // Create progress bar (moved under title)
  const progressContainer = document.createElement('div');
  progressContainer.style.cssText = `
    margin-bottom: 1.5rem;
  `;

  const progressLabel = document.createElement('div');
  progressLabel.textContent = `Overall Performance: ${overallPercentage}%`;
  progressLabel.style.cssText = `
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: #374151;
  `;

  const progressBar = document.createElement('div');
  progressBar.style.cssText = `
    width: 100%;
    height: 8px;
    background-color: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
  `;

  const progressFill = document.createElement('div');
  progressFill.style.cssText = `
    width: ${overallPercentage}%;
    height: 100%;
    background-color: ${overallPercentage >= 70 ? '#10b981' : overallPercentage >= 50 ? '#f59e0b' : '#ef4444'};
    transition: width 0.3s ease;
  `;

  progressBar.appendChild(progressFill);
  progressContainer.appendChild(progressLabel);
  progressContainer.appendChild(progressBar);

  // Group questions by competency
  const competencyGroups = {};
  if (quiz.questions) {
    quiz.questions.forEach(question => {
      const competency = question.competency || 'Other';
      if (!competencyGroups[competency]) {
        competencyGroups[competency] = [];
      }
      competencyGroups[competency].push(question);
    });
  }

  // Create competency sections
  const competencyContainer = document.createElement('div');
  competencyContainer.style.cssText = `
    display: flex;
    flex-direction: column;
    gap: 1rem;
  `;

  Object.entries(competencyGroups).forEach(([competency, questions]) => {
    const competencyCard = document.createElement('div');
    competencyCard.style.cssText = `
      background-color: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 1rem;
    `;

    const competencyCorrect = questions.filter(q => q.correct).length;
    const competencyTotal = questions.length;
    const competencyPercentage = Math.round((competencyCorrect / competencyTotal) * 100);

    const competencyHeader = document.createElement('h4');
    competencyHeader.textContent = competency;
    competencyHeader.style.cssText = `
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      font-weight: 600;
      color: #1f2937;
    `;

    const competencyStats = document.createElement('div');
    competencyStats.textContent = `${competencyCorrect}/${competencyTotal} correct (${competencyPercentage}%)`;
    competencyStats.style.cssText = `
      font-size: 0.875rem;
      color: ${competencyPercentage >= 70 ? '#059669' : competencyPercentage >= 50 ? '#d97706' : '#dc2626'};
      font-weight: 500;
    `;

    competencyCard.appendChild(competencyHeader);
    competencyCard.appendChild(competencyStats);
    competencyContainer.appendChild(competencyCard);
  });

  // Assemble the card
  card.appendChild(title);
  card.appendChild(progressContainer);
  card.appendChild(competencyContainer);

  return card;
}

function createIndividualQuizCard(quiz, quizNumber) {
  const score = quiz.score || 0;
  const maxScore = quiz.maxScore || quiz.questions?.length || 1;
  const percent = Math.round((score / maxScore) * 100);
  const incorrect = maxScore - score;
  
  const dateObj = quiz.completedAt?.toDate?.() || quiz.createdAt?.toDate?.() || new Date();
  const timeStr = dateObj.toLocaleString();

  const cardDiv = document.createElement('div');
  cardDiv.className = 'individual-quiz-card';
  cardDiv.style.cssText = `
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 24px;
    width: 100%;
    margin-bottom: 16px;
  `;

  // Process competency data for this quiz
  const competencyStats = {};
  
  if (quiz.questionStructure) {
    quiz.questionStructure.forEach((question, index) => {
      const competency = question.competency;
      const questionId = `q${index + 1}`;
      const isCorrect = quiz.userAnswers?.[questionId] === question.correctAnswer;
      
      if (!competencyStats[competency]) {
        competencyStats[competency] = { correct: 0, total: 0 };
      }
      
      competencyStats[competency].total++;
      if (isCorrect) {
        competencyStats[competency].correct++;
      }
    });
  } else if (quiz.competencyStats) {
    Object.assign(competencyStats, quiz.competencyStats);
  } else {
    const allCompetencies = quiz.competencies || [];
    const correctCompetencies = quiz.correctCompetencies || [];
    
    allCompetencies.forEach(c => {
      competencyStats[c] = competencyStats[c] || { correct: 0, total: 0 };
      competencyStats[c].total++;
    });
    
    correctCompetencies.forEach(c => {
      competencyStats[c] = competencyStats[c] || { correct: 0, total: 0 };
      competencyStats[c].correct++;
    });
  }

  const competencyList = Object.entries(competencyStats)
    .map(([comp, { correct, total }]) => `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f3f4f6; text-align: right;">
        <span style="color: #374151; font-size: 16px; font-weight: 400; text-align: left;">${comp}</span>
        <span style="color: #374151; font-size: 16px; font-weight: 500; text-align: right;">${correct} / ${total}</span>
      </div>
    `).join('');

  cardDiv.innerHTML = `
    <!-- Header with title and date - spans full width -->
   

    <!-- Main content: Score circle + stats on left, competencies on right -->
    <div style="display: flex; align-items: center; gap: 32px; width: 100%;">
      <!-- Left side: Score circle and stats side by side -->
      <div style="flex-shrink: 0; display: flex; align-items: center; gap: 24px;">
        <!-- Score Circle -->
        <div style="position: relative; width: 100px; height: 100px;">
          <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
            <path d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831" 
                  stroke="#e5e7eb" stroke-width="3" fill="none"/>
            <path stroke-dasharray="${percent}, 100" 
                  d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831" 
                  stroke="#3b82f6" stroke-width="3" fill="none" stroke-linecap="round"/>
          </svg>
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <span style="font-size: 24px; font-weight: 700; color: #3b82f6;">${percent}%</span>
          </div>
        </div>

        <!-- Stats to the right of circle -->
        <div style="text-align: left;">
          <div style="margin-bottom: 4px;">
            <span style="color: #374151; font-weight: 600;">Correct</span>
            <span style="color: #3b82f6; font-weight: 600; margin-left: 8px;">${score}</span>
          </div>
          <div style="margin-bottom: 4px;">
            <span style="color: #374151; font-weight: 600;">Incorrect</span>
            <span style="color: #374151; font-weight: 600; margin-left: 8px;">${incorrect}</span>
          </div>
          <div>
            <span style="color: #374151; font-weight: 600;">Skipped</span>
            <span style="color: #374151; font-weight: 600; margin-left: 8px;">0</span>
          </div>
        </div>
      </div>

      <!-- Right side: Competency breakdown -->
      <div style="flex: 1; text-align: right;">
         <div style="display: flex;  align-items: center; margin-bottom: 24px; width: 100%;">
      <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #374151;">Performance breakdown</h2><br>
      <span style="font-size: 14px; color: #6b7280; margin-left: 20px;">${timeStr}</span>
    </div>
        ${competencyList}
      </div>
    </div>
  `;

  return cardDiv;
}
// Global media recording variables
    let mediaRecorder;
    let mediaStream;
    let recordedChunks = [];
    let currentQuiz = null;
  
    // Tab underline + redirect
    function selectTab(selectedTab) {
      const tabText = selectedTab.textContent.trim();
      if (tabText === "Create") window.location.href = "create.html";
      if (tabText === "Resources") window.location.href = "practice.html";
      if (tabText === "Judging") window.location.href = "judging.html";
  
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      selectedTab.classList.add('active');
  
      const underline = document.querySelector('.tab-underline');
      underline.style.transform = `translateX(${selectedTab.offsetLeft}px)`;
      underline.style.width = `${selectedTab.offsetWidth}px`;
    }
  
    window.addEventListener('load', () => {
      const activeTab = document.querySelector('.tab.active');
      const underline = document.querySelector('.tab-underline');
      if (activeTab && underline) {
        underline.style.transform = `translateX(${activeTab.offsetLeft}px)`;
        underline.style.width = `${activeTab.offsetWidth}px`;
      }
      if (window.feather) feather.replace();
    });

  // Generate questions using OpenAI API
function getQuestionCount(timeString) {
  switch(timeString) {
    case '15 min': return 10;
    case '30 min': return 20;
    case '50 min': return 30;
    default: return 15;
  }
}

function resetForm() {
  document.querySelectorAll('.time-btn.selected').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.difficulty-btn.selected').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.competency-option:checked').forEach(checkbox => checkbox.checked = false);
  document.getElementById('simulate').checked = false;
}

// 2. Fix the main generateQuizQuestions function (this is the entry point)
async function generateQuizQuestions() {
  try {
    // Get form data (existing code...)
    const selectedTime = document.querySelector('.time-btn.selected')?.textContent;
    const selectedDifficulty = document.querySelector('.difficulty-btn.selected')?.textContent;
    const selectedCompetencies = Array.from(document.querySelectorAll('.competency-option:checked'))
      .map(checkbox => checkbox.value);
    const simulate = document.getElementById('simulate')?.checked || false;

    // Validation (existing code...)
    if (!selectedTime) {
      alert('Please select a time limit');
      return;
    }
    if (!selectedDifficulty) {
      alert('Please select a difficulty level');
      return;
    }
    if (selectedCompetencies.length === 0) {
      alert('Please select at least one competency');
      return;
    }

    const formData = {
      time: selectedTime,
      difficulty: selectedDifficulty,
      competencies: selectedCompetencies,
      simulate: simulate,
      type: 'written'
    };

    // Show loading state
    const startBtn = document.querySelector('.start-btn');
    const originalText = startBtn.textContent;
    startBtn.textContent = 'Generating Questions...';
    startBtn.disabled = true;

    try {
      // Generate questions using GPT API
      const questions = await generateQuestionsWithGPT(formData);
      
      // Close setup modal and open quiz modal
      closeWrittenModal();
      startQuiz(questions, formData);
      
      // Reset form
      resetForm();

    } catch (error) {
      console.error('Error creating quiz:', error);
      alert('Error creating quiz: ' + error.message);
    } finally {
      // Reset button
      startBtn.textContent = originalText;
      startBtn.disabled = false;
    }

  } catch (error) {
    console.error('Error in generateQuizQuestions:', error);
    alert('Error creating quiz: ' + error.message);
  }
}

async function generatePersonalizedTest() {
  try {
    // Get form data
    const selectedTime = document.querySelector('.time-btn.selected')?.textContent;
    const selectedDifficulty = document.querySelector('.difficulty-btn.selected')?.textContent;
    const selectedCompetencies = Array.from(document.querySelectorAll('.competency-option:checked'))
      .map(checkbox => checkbox.value);
    const simulate = document.getElementById('simulate')?.checked || false;

    // Validation
    if (!selectedTime) {
      alert('Please select a time limit');
      return;
    }
    if (!selectedDifficulty) {
      alert('Please select a difficulty level');
      return;
    }
    if (selectedCompetencies.length === 0) {
      alert('Please select at least one competency');
      return;
    }

    const formData = {
      time: selectedTime,
      difficulty: selectedDifficulty,
      competencies: selectedCompetencies,
      simulate: simulate,
      type: 'written',
      personalized: true
    };

    // Show loading state
    const personalizedBtn = document.querySelector('.personalized-btn');
    const originalText = personalizedBtn.textContent;
    personalizedBtn.textContent = 'Generating Personalized Test...';
    personalizedBtn.disabled = true;

    try {
      // Generate personalized questions
      const questions = await generatePersonalizedQuestionsWithGPT(formData);
      
      // Close setup modal and start quiz
      closeWrittenModal();
      startQuiz(questions, formData);
      
      // Reset form
      resetForm();

    } catch (error) {
      console.error('Error creating personalized quiz:', error);
      alert('Error creating personalized quiz: ' + error.message);
    } finally {
      // Reset button
      personalizedBtn.textContent = originalText;
      personalizedBtn.disabled = false;
    }

  } catch (error) {
    console.error('Error in generatePersonalizedTest:', error);
    alert('Error creating personalized quiz: ' + error.message);
  }
}

// 3. ADD THIS NEW FUNCTION:
async function generatePersonalizedQuestionsWithGPT(formData) {
  const apiKey = "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";
  
  const questionCount = getQuestionCount(formData.time);
  const competenciesText = formData.competencies.join(', ');
  
  // Get all available training data
  const trainingData = getTrainingContext();
  const userHistory = await getUserPerformanceHistory();
  
  let userQuestions = [];
  let pdfContent = null;
  let weakAreas = [];
  let strongAreas = [];
  
  if (trainingData) {
    userQuestions = trainingData.userQuestions || [];
    pdfContent = trainingData.pdfContent;
  }
  
  if (userHistory) {
    weakAreas = userHistory.weakCompetencies || [];
    strongAreas = userHistory.strongCompetencies || [];
  }
  
  // Use more user questions in personalized mode (up to 60%)
  const userQuestionsToUse = userQuestions.slice(0, Math.min(userQuestions.length, Math.floor(questionCount * 0.6)));
  const questionsToGenerate = questionCount - userQuestionsToUse.length;
  
  let prompt = `Generate ${questionsToGenerate} highly personalized multiple choice questions for FBLA practice test.

Student Profile:
- Target difficulty: ${formData.difficulty}
- Focus areas: ${competenciesText}
- Weak competencies (needs more practice): ${weakAreas.join(', ') || 'Not enough data'}
- Strong competencies (confident areas): ${strongAreas.join(', ') || 'Not enough data'}

Requirements:
- Each question should have 4 options
- Focus 70% of questions on weak areas if available
- Include some challenging questions from strong areas to maintain skills
- Make questions realistic for FBLA competitions
- Personalize based on the student's learning pattern`;

  // Add user's custom questions as style examples
  if (userQuestions.length > 0) {
    prompt += `\n\nStudent's Custom Questions (match this style and expand on these topics):`;
    userQuestions.forEach((q, i) => {
      if (i < 5) {
        prompt += `\n- ${q.text} (${q.competency}) - Answer: ${q.correctAnswer}`;
      }
    });
    prompt += `\n\nGenerate questions that build upon these topics and fill knowledge gaps.`;
  }

  // Add PDF content with more weight in personalized mode
  if (pdfContent) {
    prompt += `\n\nPersonalized Study Material (create questions directly from this content):
${pdfContent.substring(0, 4000)}

Create questions that test understanding of concepts from this material.`;
  }

  prompt += `\n\nReturn ONLY a JSON array in this exact format:
[
  {
    "text": "Question text here",
    "competency": "Business Communication",
    "correctAnswer": "Correct option text",
    "options": ["Option 1", "Option 2", "Option 3", "Option 4"]
  }
]`;

  try {
    let generatedQuestions = [];
    
    if (questionsToGenerate > 0) {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'gpt-4',
          messages: [
            {
              role: 'system',
              content: 'You are a personalized FBLA tutor. Create questions tailored to the student\'s learning needs, focusing on their weak areas while reinforcing strong areas. Use their study materials and custom questions to create the most relevant practice experience possible.'
            },
            {
              role: 'user',
              content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt
            }
          ],
          temperature: 0.8,
          max_tokens: 4000
        })
      });

      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const data = response.data;
      let content = data.content.trim();
      
      // Clean JSON formatting
      content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '');
      
      generatedQuestions = JSON.parse(content);
    }
    
    // Combine user questions with generated questions
    const allQuestions = [...userQuestionsToUse, ...generatedQuestions];
    
    // Shuffle the questions
    for (let i = allQuestions.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [allQuestions[i], allQuestions[j]] = [allQuestions[j], allQuestions[i]];
    }
    
    return allQuestions.slice(0, questionCount);

  } catch (error) {
    console.error('Personalized GPT Error:', error);
    
    // Fallback to user questions if available
    if (userQuestions.length > 0) {
      return userQuestions.slice(0, questionCount);
    } else {
      return getFallbackQuestions(questionCount, formData.competencies);
    }
  }
}


function startQuiz(questions, formData) {
  currentQuiz = {
    questions: questions,
    settings: formData,
    startTime: new Date()
  };
  
  currentQuestionIndex = 0;
  userAnswers = {};
  quizStartTime = Date.now();
  
  // Setup quiz modal
  document.getElementById('quizTitle').textContent = `${formData.difficulty} ${formData.type} Practice`;
  
  // Start timer if needed
  if (formData.time) {
    startQuizTimer(formData.time);
  }
  
  // Load first question
  loadQuestion(0);
  
  // Show quiz modal
  document.getElementById('quizModal').style.display = 'block';
}


// Load question into modal
function loadQuestion(index) {
  const question = currentQuiz.questions[index];
  const totalQuestions = currentQuiz.questions.length;
  
  // Update progress
  document.getElementById('quizProgress').textContent = `Question ${index + 1} of ${totalQuestions}`;
  document.getElementById('progressFill').style.width = `${((index + 1) / totalQuestions) * 100}%`;
  
  // Update question content
  document.getElementById('questionCompetency').textContent = question.competency;
  document.getElementById('questionText').textContent = question.text;
  
  // Create options
  const optionsContainer = document.getElementById('optionsContainer');
  optionsContainer.innerHTML = '';
  
  question.options.forEach((option, optionIndex) => {
    const optionDiv = document.createElement('div');
    optionDiv.className = 'option-item';
    
    // Check if this option was previously selected
    const isSelected = userAnswers[`q${index}`] === option;
    if (isSelected) {
      optionDiv.classList.add('selected');
    }
    
    optionDiv.innerHTML = `
      <div class="option-radio"></div>
      <div class="option-text">${option}</div>
    `;
    
    // Add click handler
    optionDiv.addEventListener('click', (event) => {
      selectOption(event, optionIndex, option);
    });
    
    optionsContainer.appendChild(optionDiv);
  });
  
  // Update navigation buttons
  document.getElementById('prevBtn').disabled = index === 0;
  document.getElementById('nextBtn').style.display = index === totalQuestions - 1 ? 'none' : 'block';
  document.getElementById('submitBtn').style.display = index === totalQuestions - 1 ? 'block' : 'none';
}

function selectOption(event, optionIndex, optionText) {
  // Get all options for this question
  const options = event.currentTarget.parentElement.querySelectorAll('.option-item');
  
  // Remove selection from all options
  options.forEach(option => {
    option.classList.remove('selected');
  });
  
  // Add selection to clicked option
  event.currentTarget.classList.add('selected');
  
  // Store answer
  userAnswers[`q${currentQuestionIndex}`] = optionText;
  
  // Enable next button if not already enabled
  if (document.getElementById('nextBtn').disabled) {
    document.getElementById('nextBtn').disabled = false;
  }
}


function selectOption(event, optionIndex, optionText) {
  // Prevent event bubbling
  event.stopPropagation();
  
  // Remove previous selection from all options in this question
  const options = event.currentTarget.parentElement.querySelectorAll('.option-item');
  options.forEach(option => {
    option.classList.remove('selected');
  });

  // Add selection to clicked option
  event.currentTarget.classList.add('selected');

  // Store answer
  userAnswers[`q${currentQuestionIndex}`] = optionText;
  
  // Update the radio button visual
  const radio = event.currentTarget.querySelector('.option-radio');
  if (radio) {
    radio.innerHTML = 'â—'; // Filled circle
  }
}


function nextQuestion() {
  if (currentQuestionIndex < currentQuiz.questions.length - 1) {
    currentQuestionIndex++;
    loadQuestion(currentQuestionIndex);
  }
}

function previousQuestion() {
  if (currentQuestionIndex > 0) {
    currentQuestionIndex--;
    loadQuestion(currentQuestionIndex);
  }
}

// Submit quiz
async function submitQuiz() {
  if (quizTimer) {
    clearInterval(quizTimer);
  }
  
  // Calculate results
  quizResults = calculateQuizResults();
  
  // Save to Firebase FIRST
  try {
    console.log('Saving quiz results...');
    await saveQuizResultsToFirebase(quizResults);
    console.log('Quiz results saved successfully!');
    
    // Force a reload of the quiz cards from Firebase
    await reloadQuizCardsFromFirebase();
    
  } catch (error) {
    console.error('Error saving quiz results:', error);
    alert('Warning: Quiz results may not have been saved properly.');
  }
  
  // Close quiz modal and show results
  closeQuizModal();
  showQuizResults(quizResults);
}

async function reloadQuizCardsFromFirebase() {
  const user = firebase.auth().currentUser;
  if (!user) return;
  
  try {
    console.log('Reloading quiz cards from Firebase...');
    
    const assignmentsRef = firebase.firestore().collection('assignments');
    const snapshot = await assignmentsRef
      .where('to', '==', user.uid)
      .where('type', 'in', ['written', 'quiz'])
      .where('status', '==', 'complete')
      .orderBy('createdAt', 'desc')
      .get();
    
    if (snapshot.empty) {
      console.log('No quiz results found');
      return;
    }
    
    const allQuizzes = snapshot.docs.map(doc => {
      const data = doc.data();
      console.log('Quiz data from Firebase:', data);
      return data;
    });
    
    // Clear existing quiz container
    const existingContainer = document.querySelector('.quiz-container');
    if (existingContainer) {
      existingContainer.remove();
    }
    
    // Hide the original performance section
    const originalPerformanceSection = document.querySelector('.performance-section');
    if (originalPerformanceSection) {
      originalPerformanceSection.style.display = 'none';
    }
    
    // Create a new container for all quiz cards
    const quizContainer = document.createElement('div');
    quizContainer.className = 'quiz-container';
    quizContainer.style.cssText = `
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      margin-top: 2rem;
    `;
    
    // Create individual quiz cards
    allQuizzes.forEach((quiz, index) => {
      const quizCard = createIndividualQuizCard(quiz, index + 1);
      quizContainer.appendChild(quizCard);
    });
    
    // Insert the quiz container after the create-exam-card
    const createExamCard = document.querySelector('.create-exam-card');
    if (createExamCard) {
      createExamCard.parentNode.insertBefore(quizContainer, createExamCard.nextSibling);
    }
    
    console.log('Quiz cards reloaded successfully');
    
  } catch (error) {
    console.error('Error reloading quiz cards:', error);
  }
}



function createQuizResultCard(results) {
  const quizContainer = document.querySelector('.quiz-container') || document.createElement('div');
  quizContainer.className = 'quiz-container';
  quizContainer.style.cssText = `
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-top: 2rem;
  `;
  
  // Hide original performance section if it exists
  const performanceSection = document.querySelector('.performance-section');
  if (performanceSection) {
    performanceSection.style.display = 'none';
  }
  
  // Create the card using the EXACT same structure as createIndividualQuizCard
  const card = createIndividualQuizCardFromResults(results, 1);
  
  quizContainer.prepend(card);
  
  // Insert the quiz container after the create-exam-card
  const createExamCard = document.querySelector('.create-exam-card');
  if (createExamCard) {
    createExamCard.parentNode.insertBefore(quizContainer, createExamCard.nextSibling);
  }
}

// New function that creates a card using the EXACT same structure as your existing createIndividualQuizCard
function createIndividualQuizCardFromResults(results, quizNumber) {
  const score = results.correct;
  const maxScore = results.total;
  const percent = results.percentage;
  const incorrect = results.incorrect;
  
  const timeStr = new Date().toLocaleString();

  const cardDiv = document.createElement('div');
  cardDiv.className = 'individual-quiz-card';
  cardDiv.style.cssText = `
    background: white;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 24px;
    width: 100%;
    margin-bottom: 16px;
  `;

  // Convert results.competencyStats to match the expected format
  const competencyStats = {};
  Object.entries(results.competencyStats).forEach(([comp, stats]) => {
    competencyStats[comp] = {
      correct: stats.correct,
      total: stats.total
    };
  });

  const competencyList = Object.entries(competencyStats)
    .map(([comp, { correct, total }]) => `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f3f4f6; text-align: right;">
        <span style="color: #374151; font-size: 16px; font-weight: 400; text-align: left;">${comp}</span>
        <span style="color: #374151; font-size: 16px; font-weight: 500; text-align: right;">${correct} / ${total}</span>
      </div>
    `).join('');

  cardDiv.innerHTML = `
    <!-- Main content: Score circle + stats on left, competencies on right -->
    <div style="display: flex; align-items: center; gap: 32px; width: 100%;">
      <!-- Left side: Score circle and stats side by side -->
      <div style="flex-shrink: 0; display: flex; align-items: center; gap: 24px;">
        <!-- Score Circle -->
        <div style="position: relative; width: 100px; height: 100px;">
          <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
            <path d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831" 
                  stroke="#e5e7eb" stroke-width="3" fill="none"/>
            <path stroke-dasharray="${percent}, 100" 
                  d="M18 2.0845 a 15.9155 15.9155 0 1 1 0 31.831 a 15.9155 15.9155 0 1 1 0 -31.831" 
                  stroke="#3b82f6" stroke-width="3" fill="none" stroke-linecap="round"/>
          </svg>
          <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <span style="font-size: 24px; font-weight: 700; color: #3b82f6;">${percent}%</span>
          </div>
        </div>

        <!-- Stats to the right of circle -->
        <div style="text-align: left;">
          <div style="margin-bottom: 4px;">
            <span style="color: #374151; font-weight: 600;">Correct</span>
            <span style="color: #3b82f6; font-weight: 600; margin-left: 8px;">${score}</span>
          </div>
          <div style="margin-bottom: 4px;">
            <span style="color: #374151; font-weight: 600;">Incorrect</span>
            <span style="color: #374151; font-weight: 600; margin-left: 8px;">${incorrect}</span>
          </div>
          <div>
            <span style="color: #374151; font-weight: 600;">Skipped</span>
            <span style="color: #374151; font-weight: 600; margin-left: 8px;">0</span>
          </div>
        </div>
      </div>

      <!-- Right side: Competency breakdown -->
      <div style="flex: 1; text-align: right;">
         <div style="display: flex; align-items: center; margin-bottom: 24px; width: 100%;">
          <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #374151;">Performance breakdown</h2>
          <span style="font-size: 14px; color: #6b7280; margin-left: 20px;">${timeStr}</span>
        </div>
        ${competencyList}
      </div>
    </div>
  `;

  return cardDiv;
}

function calculateQuizResults() {
  const questions = currentQuiz.questions;
  let correct = 0;
  const competencyStats = {};
  const questionResults = [];
  
  questions.forEach((question, index) => {
    const userAnswer = userAnswers[`q${index}`];
    const isCorrect = userAnswer === question.correctAnswer;
    
    if (isCorrect) correct++;
    
    // Track competency performance
    if (!competencyStats[question.competency]) {
      competencyStats[question.competency] = { correct: 0, total: 0 };
    }
    competencyStats[question.competency].total++;
    if (isCorrect) {
      competencyStats[question.competency].correct++;
    }
    
    questionResults.push({
      question: question.text,
      userAnswer: userAnswer,
      correctAnswer: question.correctAnswer,
      isCorrect: isCorrect,
      competency: question.competency,
      options: question.options // Include options for Firebase storage
    });
  });
  
  const totalQuestions = questions.length;
  const percentage = Math.round((correct / totalQuestions) * 100);
  const timeUsed = Date.now() - quizStartTime;
  
  return {
    correct,
    incorrect: totalQuestions - correct,
    total: totalQuestions,
    percentage,
    timeUsed,
    competencyStats,
    questionResults,
    quizSettings: currentQuiz.settings
  };
}

// Add a manual refresh function for testing
function forceRefreshQuizData() {
  console.log('Manually refreshing quiz data...');
  reloadQuizCardsFromFirebase();
}

// Add this to window for debugging
window.forceRefreshQuizData = forceRefreshQuizData;


function showQuizResults(results) {
  // Update score display
  document.getElementById('finalScore').textContent = `${results.percentage}%`;
  document.getElementById('correctCount').textContent = results.correct;
  document.getElementById('incorrectCount').textContent = results.incorrect;
  document.getElementById('timeUsed').textContent = formatTime(results.timeUsed);
  
  // Update score circle with consistent styling
  const scoreCircle = document.querySelector('#quizResultsModal .score-circle');
  if (scoreCircle) {
    const degrees = (results.percentage / 100) * 360;
    scoreCircle.style.background = `conic-gradient(#3b82f6 0deg ${degrees}deg, #e5e7eb ${degrees}deg 360deg)`;
  }
  
  // Show competency breakdown using the SAME styling as other cards
  const breakdownContainer = document.getElementById('competencyBreakdown');
  breakdownContainer.innerHTML = '<h3 style="margin-bottom: 1rem; font-size: 18px; font-weight: 600; color: #374151;">Performance by Competency</h3>';
  
  Object.entries(results.competencyStats).forEach(([competency, stats]) => {
    const percentage = Math.round((stats.correct / stats.total) * 100);
    const resultDiv = document.createElement('div');
    resultDiv.style.cssText = `
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 12px 0; 
      border-bottom: 1px solid #f3f4f6;
    `;
    resultDiv.innerHTML = `
      <span style="color: #374151; font-size: 16px; font-weight: 400;">${competency}</span>
      <span style="color: #374151; font-size: 16px; font-weight: 500;">${stats.correct} / ${stats.total}</span>
    `;
    breakdownContainer.appendChild(resultDiv);
  });
  
  // Show results modal
  document.getElementById('quizResultsModal').style.display = 'block';
}


// Timer functions
function startQuizTimer(timeLimit) {
  const minutes = parseInt(timeLimit.split(' ')[0]);
  let totalSeconds = minutes * 60;
  
  quizTimer = setInterval(() => {
    totalSeconds--;
    
    if (totalSeconds <= 0) {
      clearInterval(quizTimer);
      submitQuiz(); // Auto-submit when time runs out
      return;
    }
    
    const mins = Math.floor(totalSeconds / 60);
    const secs = totalSeconds % 60;
    document.getElementById('quizTimer').textContent = 
      `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }, 1000);
}

// Utility functions
function formatTime(milliseconds) {
  const minutes = Math.floor(milliseconds / 60000);
  const seconds = Math.floor((milliseconds % 60000) / 1000);
  return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// Modal functions
function closeQuizModal() {
  document.getElementById('quizModal').style.display = 'none';
  if (quizTimer) {
    clearInterval(quizTimer);
  }
}

function closeQuizResultsModal() {
  document.getElementById('quizResultsModal').style.display = 'none';
}

function reviewQuestions() {
  if (!quizResults) return;
  
  reviewQuestionIndex = 0;
  showReviewQuestion();
  document.getElementById('quizResultsModal').style.display = 'none';
  
  // Create review modal if it doesn't exist
  let reviewModal = document.getElementById('reviewModal');
  if (!reviewModal) {
    reviewModal = document.createElement('div');
    reviewModal.id = 'reviewModal';
    reviewModal.className = 'modal';
    reviewModal.innerHTML = `
      <div class="modal-content" style="max-width: 800px;">
        <span class="close" onclick="closeModal('reviewModal')">&times;</span>
        <h2>Question Review</h2>
        <div id="reviewQuestionContainer"></div>
        <div class="review-navigation">
          <button id="reviewPrevBtn" onclick="prevReviewQuestion()" disabled>Previous</button>
          <span id="reviewProgress">1 of ${quizResults.questionResults.length}</span>
          <button id="reviewNextBtn" onclick="nextReviewQuestion()">Next</button>
          <button onclick="closeModal('reviewModal')" style="margin-left: auto;">Close Review</button>
        </div>
      </div>
    `;
    document.body.appendChild(reviewModal);
  }
  
  reviewModal.style.display = 'block';
}

function showReviewQuestion() {
  const container = document.getElementById('reviewQuestionContainer');
  if (!container || !quizResults) return;
  
  const question = quizResults.questionResults[reviewQuestionIndex];
  const questionObj = currentQuiz.questions[reviewQuestionIndex];
  
  const optionsHTML = questionObj.options.map(option => {
    let optionClass = '';
    if (option === question.userAnswer && option === question.correctAnswer) {
      optionClass = 'correct selected';
    } else if (option === question.userAnswer) {
      optionClass = 'incorrect selected';
    } else if (option === question.correctAnswer) {
      optionClass = 'correct';
    }
    
    return `
      <div class="review-option ${optionClass}">
        ${option}
        ${option === question.correctAnswer && option !== question.userAnswer ? 
          '<span style="color: #10b981; margin-left: 8px;">âœ“ Correct answer</span>' : ''}
      </div>
    `;
  }).join('');
  
  container.innerHTML = `
    <div class="review-question">
      <div class="competency-tag">${questionObj.competency}</div>
      <div class="review-question-text">${questionObj.text}</div>
      <div class="review-options">
        ${optionsHTML}
      </div>
      ${questionObj.explanation ? `
        <div class="review-explanation">
          <strong>Explanation:</strong> ${questionObj.explanation}
        </div>
      ` : ''}
    </div>
  `;
  
  // Update navigation buttons
  document.getElementById('reviewPrevBtn').disabled = reviewQuestionIndex === 0;
  document.getElementById('reviewNextBtn').disabled = reviewQuestionIndex === quizResults.questionResults.length - 1;
  document.getElementById('reviewProgress').textContent = `${reviewQuestionIndex + 1} of ${quizResults.questionResults.length}`;
}

function nextReviewQuestion() {
  if (reviewQuestionIndex < quizResults.questionResults.length - 1) {
    reviewQuestionIndex++;
    showReviewQuestion();
  }
}

function prevReviewQuestion() {
  if (reviewQuestionIndex > 0) {
    reviewQuestionIndex--;
    showReviewQuestion();
  }
}

// Update the selectOption function for better selection handling
function selectOption(event, optionIndex, optionText) {
  const options = event.currentTarget.parentElement.querySelectorAll('.option-item');
  const clickedOption = event.currentTarget;
  
  // Check if this option is already selected
  const isSelected = clickedOption.classList.contains('selected');
  
  // Remove selection from all options
  options.forEach(option => {
    option.classList.remove('selected');
  });
  
  // Toggle selection
  if (!isSelected) {
    clickedOption.classList.add('selected');
    userAnswers[`q${currentQuestionIndex}`] = optionText;
  } else {
    userAnswers[`q${currentQuestionIndex}`] = null;
  }
  
  // Update the radio button visual
  const radio = clickedOption.querySelector('.option-radio');
  if (radio) {
    radio.innerHTML = clickedOption.classList.contains('selected') ? 'â—' : '';
  }
}


// Save quiz results to Firebase
async function saveQuizResultsToFirebase(results) {
  const user = firebase.auth().currentUser;
  if (!user) {
    console.error('User not authenticated');
    return;
  }

  try {
    // Create the exact structure that your existing code expects
    const quizResult = {
      userId: user.uid,
      to: user.uid, // This field is important for the query
      type: 'written',
      score: results.correct,
      maxScore: results.total,
      percentage: results.percentage,
      timeUsed: results.timeUsed,
      
      // Structure the questions array to match your existing format
      questions: results.questionResults.map((q, index) => ({
        text: q.question,
        userAnswer: q.userAnswer,
        correctAnswer: q.correctAnswer,
        correct: q.isCorrect,
        competency: q.competency,
        questionId: `q${index + 1}`,
        options: currentQuiz.questions[index]?.options || []
      })),
      
      // Save competency stats
      competencyStats: results.competencyStats,
      
      // Additional fields to match your existing structure
      settings: results.quizSettings,
      title: `${results.quizSettings?.difficulty || 'Practice'} Quiz`,
      difficulty: results.quizSettings?.difficulty,
      timeLimit: results.quizSettings?.time,
      competencies: results.quizSettings?.competencies || [],
      
      // Firebase timestamps
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      completedAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'complete'
    };

    console.log('Saving quiz result to Firebase:', quizResult);
    
    const docRef = await firebase.firestore().collection('assignments').add(quizResult);
    console.log('Quiz result saved with ID:', docRef.id);
    
    return docRef.id;
  } catch (error) {
    console.error('Error saving quiz results to Firebase:', error);
    throw error;
  }
}


async function generateQuestionsWithGPT(formData) {
  const apiKey = "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";
  
  const questionCount = getQuestionCount(formData.time);
  const competenciesText = formData.competencies.join(', ');
  
  // Get training data
  const trainingData = getTrainingContext();
  let userQuestions = [];
  let pdfContent = null;

  if (!formData.personalized) {
    const userHistory = await getUserPerformanceHistory();
    if (userHistory) {
      // Filter performance by selected competencies and difficulty
      const relevantPerformance = filterPerformanceBySelection(userHistory, formData);
      // Use this filtered data to influence question generation
      formData.performanceData = relevantPerformance;
    }
  }
  
  if (trainingData) {
    userQuestions = trainingData.userQuestions || [];
    pdfContent = trainingData.pdfContent;
  }
  
  // If we have enough user questions, use some of them directly
  const userQuestionsToUse = userQuestions.slice(0, Math.min(userQuestions.length, Math.floor(questionCount * 0.4))); // Use up to 40% user questions
  const questionsToGenerate = questionCount - userQuestionsToUse.length;
  
  let prompt = `Generate ${questionsToGenerate} multiple choice questions for FBLA practice test.

Requirements:
- Difficulty: ${formData.difficulty}
- Focus areas: ${competenciesText}
- Each question should have 4 options
- Make questions realistic for FBLA competitions`;

  // Add user questions as examples if available
  if (userQuestions.length > 0) {
    prompt += `\n\nHere are some example questions to match the style and topics:`;
    userQuestions.slice(0, 3).forEach(q => {
      prompt += `\n- ${q.text} (${q.competency})`;
    });
    prompt += `\n\nGenerate questions that complement these topics and maintain similar difficulty.`;
  }

  // Add PDF content if available
  if (pdfContent) {
    prompt += `\n\nUse this study material to create relevant questions:\n${pdfContent.substring(0, 3000)}`;
  }

  prompt += `\n\nReturn ONLY a JSON array in this exact format:
[
  {
    "text": "Question text here",
    "competency": "Business Communication",
    "correctAnswer": "Correct option text",
    "options": ["Option 1", "Option 2", "Option 3", "Option 4"]
  }
]`;

  try {
    let generatedQuestions = [];
    
    if (questionsToGenerate > 0) {
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${apiKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'gpt-4',
          messages: [
            {
              role: 'system',
              content: 'You are an FBLA question generator. Always respond with valid JSON only. Use provided study materials and example questions to create relevant, accurate questions that complement the user\'s custom questions.'
            },
            {
              role: 'user',
              content: (window.__CERTQUEST_CONTEXT__ || "") + "\n\n" + prompt
            }
          ],
          temperature: 0.7,
          max_tokens: 4000
        })
      });

      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const data = response.data;
      let content = data.content.trim();
      
      // Clean JSON formatting
      content = content.replace(/```json\n?/g, '').replace(/```\n?/g, '');
      
      generatedQuestions = JSON.parse(content);
    }
    
    // Combine user questions with generated questions
    const allQuestions = [...userQuestionsToUse, ...generatedQuestions];
    
    // Shuffle the questions
    for (let i = allQuestions.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [allQuestions[i], allQuestions[j]] = [allQuestions[j], allQuestions[i]];
    }
    
    // Validate questions
    allQuestions.forEach((q, i) => {
      if (!q.options.includes(q.correctAnswer)) {
        throw new Error(`Question ${i + 1}: correctAnswer not in options`);
      }
    });
    
    return allQuestions.slice(0, questionCount); // Ensure we return exactly the requested number

  } catch (error) {
    console.error('GPT Error:', error);
    
    // Return user questions if available, otherwise fallback
    if (userQuestions.length > 0) {
      return userQuestions.slice(0, questionCount);
    } else {
      return getFallbackQuestions(questionCount, formData.competencies);
    }
  }
}

async function getUserPerformanceHistory() {
  const user = firebase.auth().currentUser;
  if (!user) return null;
  
  try {
    const assignmentsRef = firebase.firestore().collection('assignments');
    const snapshot = await assignmentsRef
      .where('to', '==', user.uid)
      .where('status', '==', 'complete')
      .orderBy('createdAt', 'desc')
      .limit(10) // Get last 10 quizzes
      .get();
    
    if (snapshot.empty) return null;
    
    const competencyPerformance = {};
    const allCompetencies = [];
    
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      if (data.competencyStats) {
        Object.entries(data.competencyStats).forEach(([comp, stats]) => {
          if (!competencyPerformance[comp]) {
            competencyPerformance[comp] = { correct: 0, total: 0, attempts: 0 };
          }
          competencyPerformance[comp].correct += stats.correct;
          competencyPerformance[comp].total += stats.total;
          competencyPerformance[comp].attempts++;
        });
      }
    });
    
    // Determine weak and strong areas
    const weakCompetencies = [];
    const strongCompetencies = [];
    
    Object.entries(competencyPerformance).forEach(([comp, stats]) => {
      const percentage = (stats.correct / stats.total) * 100;
      if (percentage < 70) {
        weakCompetencies.push(comp);
      } else if (percentage > 85) {
        strongCompetencies.push(comp);
      }
    });
    
    return {
      competencyPerformance,
      weakCompetencies,
      strongCompetencies,
      totalQuizzes: snapshot.docs.length
    };
    
  } catch (error) {
    console.error('Error getting user performance history:', error);
    return null;
  }
}

function filterPerformanceBySelection(userHistory, formData) {
  const { competencies, difficulty } = formData;
  const filtered = {};
  
  // Filter by selected competencies
  competencies.forEach(comp => {
    if (userHistory.competencyPerformance[comp]) {
      const stats = userHistory.competencyPerformance[comp];
      const percentage = (stats.correct / stats.total) * 100;
      
      // Determine if this competency needs more practice based on difficulty setting
      let needsPractice = false;
      if (difficulty === 'Easy' && percentage < 60) needsPractice = true;
      if (difficulty === 'Medium' && percentage < 75) needsPractice = true;
      if (difficulty === 'Hard' && percentage < 85) needsPractice = true;
      
      filtered[comp] = {
        ...stats,
        percentage,
        needsPractice
      };
    }
  });
  
  return filtered;
}


function getTrainingContext() {
  try {
    const stored = localStorage.getItem('gptTrainingContext');
    if (!stored) return null;
    
    const data = JSON.parse(stored);
    
    // Check if data is still fresh (7 days for user questions, 24 hours for PDF)
    const isRecent = Date.now() - data.lastUpdated < 7 * 24 * 60 * 60 * 1000;
    
    return isRecent ? data : null;
  } catch (error) {
    console.error('Error getting training context:', error);
    return null;
  }
}

// Clear training context (optional utility function)
function clearTrainingContext() {
  localStorage.removeItem('gptTrainingContext');
  console.log('Training context cleared');
}


function getFallbackQuestions(count, competencies) {
  const fallbackQuestions = [
    {
      text: "What is the primary purpose of parliamentary procedure?",
      competency: "Parliamentary Procedure",
      correctAnswer: "To make meetings more efficient",
      options: [
        "To make meetings more efficient",
        "To give the president more power",
        "To eliminate debate",
        "To make meetings longer"
      ]
    },
    {
      text: "Which motion is used to end a meeting?",
      competency: "Parliamentary Procedure",
      correctAnswer: "Adjourn",
      options: [
        "Adjourn",
        "Recess",
        "Postpone",
        "Table"
      ]
    },
    {
      text: "What is the most effective way to communicate in business?",
      competency: "Business Communication",
      correctAnswer: "Clear and concise messaging",
      options: [
        "Clear and concise messaging",
        "Using complex terminology",
        "Lengthy detailed explanations",
        "Informal casual language"
      ]
    },
    {
      text: "What is the marketing mix also known as?",
      competency: "Marketing",
      correctAnswer: "The 4 P's",
      options: [
        "The 4 P's",
        "The 4 C's",
        "The 5 S's",
        "The 3 R's"
      ]
    },
    {
      text: "What is the basic accounting equation?",
      competency: "Accounting", 
      correctAnswer: "Assets = Liabilities + Owner's Equity",
      options: [
        "Assets = Liabilities + Owner's Equity",
        "Revenue = Expenses + Profit",
        "Assets = Revenue - Expenses",
        "Liabilities = Assets + Equity"
      ]
    }
  ];
  
  // Return the requested number of questions (cycle through if needed)
  const result = [];
  for (let i = 0; i < count; i++) {
    result.push(fallbackQuestions[i % fallbackQuestions.length]);
  }
  
  return result;
}
    function toggleAccordion(button) {
      const content = button.nextElementSibling;
      const icon = button.querySelector('.chevron-icon');
      const isActive = button.classList.contains('active');
  
      button.classList.toggle('active');
      content.style.maxHeight = isActive ? null : content.scrollHeight + "px";
      if (icon) icon.classList.toggle('rotate', !isActive);
    }
  
    // Modals
    function openModal(id) {
      document.getElementById(id).style.display = 'block';
    }
    function closeModal(id) {
      const modal = document.getElementById(id);
      if (modal) modal.style.display = 'none';
    }
  
    function openWrittenModal() { openModal('writtenModal'); }
    function closeWrittenModal() { closeModal('writtenModal'); }
    function openSpeakingModal() { openModal('speakingModal'); }
    function closeSpeakingModal() { closeModal('speakingModal'); }
    function openCaseModal() { openModal('caseModal'); }
    function closeCaseModal() { closeModal('caseModal'); }
  
    // UI Selectors
    function selectTime(button) {
      document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');
    }
  
    function selectDifficulty(button) {
      document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
      button.classList.add('selected');
    }
  
    function selectAllCompetencies() {
      document.querySelectorAll('.competency-option').forEach(box => {
        box.checked = true;
      });
    }
  
    // Question Generator (Speaking)
    function generateQuestions() {
      const speechInput = document.getElementById("speechInput");
      const speech = speechInput.value.trim();
      const questionArea = document.getElementById("questionArea");
      const questionList = document.getElementById("questionList");
  
      if (!speech) {
        alert("Paste your speech first!");
        return;
      }
  
      const questions = [
        "What was the main message of your speech?",
        "Why did you choose this topic?",
        "How would you connect this to a real-world issue?"
      ];
  
      speechInput.closest(".modal-section").style.display = "none";
      questionList.innerHTML = "";
      questions.forEach(q => {
        const card = document.createElement("div");
        card.className = "question-card";
        card.textContent = q;
        questionList.appendChild(card);
      });
  
      questionArea.classList.remove("hidden");
    }

    // Save quiz to Firebase
async function saveQuizToFirebase(quizData) {
  const user = firebase.auth().currentUser;
  if (!user) {
    throw new Error('User not authenticated');
  }

  const quizDoc = {
    title: `${quizData.difficulty} ${quizData.type} Practice`,
    type: quizData.type,
    difficulty: quizData.difficulty,
    timeLimit: quizData.time,
    competencies: quizData.competencies,
    questions: quizData.questions, // This now matches your exact format
    questionCount: quizData.questions.length,
    createdBy: user.uid,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'ready',
    simulate: quizData.simulate || false,
    // Add fields for quiz taking
    maxScore: quizData.questions.length,
    passingScore: Math.ceil(quizData.questions.length * 0.7) // 70% to pass
  };

  const docRef = await firebase.firestore().collection('quizzes').add(quizDoc);
  return docRef.id;
}
  
    // Case Prompt Generator
    function generateCase() {
      const selected = [...document.querySelectorAll('.competency-option:checked')];
      if (selected.length === 0 || selected.length > 5) {
        alert("Please choose between 1 to 5 competencies.");
        return;
      }
  
      const selectedCompetencies = selected.map(c => c.parentElement.textContent.trim());
      const difficulty = document.querySelector('.difficulty-btn.selected')?.textContent;
  
      if (!difficulty) {
        alert("Please select a difficulty.");
        return;
      }
  
      document.getElementById('casePromptSection').style.display = 'none';
      document.getElementById('caseDifficulty').textContent = difficulty;
      document.getElementById('caseCompetencies').textContent = selectedCompetencies.join(', ');
      document.getElementById('caseResultSection').style.display = 'block';
    }
  
    // --- Recording ---
    function stopAllMedia() {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
      }
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
      }
    }
  
    function startAudio(context) {
      stopAllMedia();
      recordedChunks = [];
  
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaStream = stream;
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            const audioURL = URL.createObjectURL(blob);
            const audio = document.getElementById(`audioPlayback${capitalize(context)}`);
            audio.src = audioURL;
            audio.style.display = 'block';
          };
          mediaRecorder.start();
          document.getElementById(`stopBtn${capitalize(context)}`).style.display = 'inline-block';
        })
        .catch(err => {
          alert('Microphone permission denied.');
          console.error(err);
        });
    }
  
    function startVideo(context) {
      stopAllMedia();
      recordedChunks = [];
  
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          mediaStream = stream;
          const video = document.getElementById(`videoPreview${capitalize(context)}`);
          video.srcObject = stream;
          video.muted = true;
          video.play();
          video.style.display = 'block';
  
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            const videoURL = URL.createObjectURL(blob);
            video.srcObject = null;
            video.src = videoURL;
            video.controls = true;
            video.muted = false;
            video.play();
          };
          mediaRecorder.start();
          document.getElementById(`stopBtn${capitalize(context)}`).style.display = 'inline-block';
        })
        .catch(err => {
          alert('Camera permission denied.');
          console.error(err);
        });
    }
  
    function stopRecording(context) {
      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
      }
      const stopBtn = document.getElementById(`stopBtn${capitalize(context)}`);
      if (stopBtn) stopBtn.style.display = 'none';
    }
  
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // ============ MEILISEARCH INTEGRATION ============
    // Meilisearch client setup (adjust if you use a different host)
    const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
    const index = client.index('content');
    const searchBox = document.getElementById('navbarSearch');
    const searchDropdown = document.getElementById('searchDropdown');
    const searchIcon = document.getElementById('navbarSearchIcon');

    if (searchBox && searchDropdown) {
      searchBox.addEventListener('input', async function(e) {
        const query = e.target.value.trim();
        if (!query) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
          return;
        }
        try {
          const result = await index.search(query, { limit: 5 });
          if (!result.hits.length) {
            searchDropdown.style.display = 'none';
            searchDropdown.innerHTML = '';
            return;
          }
          searchDropdown.style.display = 'block';
          searchDropdown.innerHTML = result.hits.map(doc => `
            <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
              <b>${doc.title}</b><br>
              <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
            </div>
          `).join('');
        } catch (err) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
        }
      });

      // Handle result click
      searchDropdown.addEventListener('click', function(e) {
        const target = e.target.closest('.dropdown-result');
        if (target && target.dataset.url) {
          window.location = target.dataset.url;
        }
      });

      // Optional: Allow Enter key to open first result
      searchBox.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && searchDropdown.innerHTML) {
          const first = searchDropdown.querySelector('.dropdown-result');
          if (first && first.dataset.url) {
            window.location = first.dataset.url;
          }
        }
      });

      // Hide dropdown on outside click
      document.addEventListener('click', function(e) {
        if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.style.display = 'none';
        }
      });

      // Click magnifier icon triggers search
      if (searchIcon) {
        searchIcon.addEventListener('click', () => {
          searchBox.dispatchEvent(new Event('input'));
        });
      }
    }
    // =========== END MEILISEARCH ============

    document.addEventListener('DOMContentLoaded', function() {
  // Initialize modal elements
  const modal = document.getElementById('pdfModal');
  if (!modal) {
    console.error('Modal element not found');
    return;
  }

  const openBtn = document.getElementById('openModalBtn');
  const closeBtn = modal.querySelector('.close');

  // Only add event listeners if elements exist
  if (openBtn) {
    openBtn.addEventListener('click', openTrainingModal);
  } else {
    console.error('Open modal button not found');
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', closeTrainingModal);
  } else {
    console.error('Close button not found in modal');
  }

  // Rest of your initialization code...
});

async function loadCompetitionName() {
  try {
    const user = firebase.auth().currentUser;
    
    if (!user) {
      console.log('No user authenticated, waiting...');
      return;
    }
    
    const userId = user.uid;
    console.log('ðŸ”¥ Loading competition for user:', userId);
    
    // Get user document
    const userDoc = await db.collection('users').doc(userId).get();
    
    if (!userDoc.exists) {
      console.log('User document not found');
      document.getElementById('comp').textContent = 'User not found';
      return;
    }
    
    const userData = userDoc.data();
    const competitions = userData.competitions;
    
    // DEBUG: Log the entire competitions array
    console.log('ðŸ” DEBUG - Full competitions array:', competitions);
    console.log('ðŸ” DEBUG - Type of first competition:', typeof competitions[0]);
    console.log('ðŸ” DEBUG - First competition value:', competitions[0]);
    
    if (!competitions || competitions.length === 0) {
      document.getElementById('comp').textContent = 'No competition assigned';
      return;
    }
    
    const competitionValue = competitions[0];
    
    // If it looks like a name string, use it directly
    if (typeof competitionValue === 'string' && competitionValue.length > 0) {
      console.log('âœ… Using competition name directly:', competitionValue);
      document.getElementById('comp').textContent = competitionValue;
      return;
    }
    
    // Otherwise try to look it up as a document ID
    console.log('ðŸ”¥ Looking for competition as document ID:', competitionValue);
    const competitionDoc = await db.collection('competitions').doc(competitionValue).get();
    
    if (!competitionDoc.exists) {
      console.log('âŒ Competition document not found:', competitionValue);
      document.getElementById('comp').textContent = 'Competition not found';
      return;
    }
    
    const competitionData = competitionDoc.data();
    const competitionName = competitionData.name || 'Unnamed Competition';
    
    console.log('âœ… Found competition name:', competitionName);
    document.getElementById('comp').textContent = competitionName;
    
  } catch (error) {
    console.error('âŒ Error:', error);
    document.getElementById('comp').textContent = 'Error loading';
  }
}

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadCompetitionName();
  }
});

function addCameraModalCSS() {
    const styles = `
    <style>
        .camera-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1e1e2e 0%, #2d1b69 100%);
            z-index: 10000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .camera-modal-overlay.active {
            opacity: 1;
        }
        
        .camera-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .camera-title {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        
        .camera-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .camera-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .assignment-questions {
            padding: 20px 30px;
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            gap: 20px;
        }
        
        .question-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            color: white;
        }
        
        .question-card strong {
            color: #64b5f6;
            display: block;
            margin-bottom: 8px;
        }
        
        .camera-main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 30px;
        }
        
        .video-preview {
            width: 80%;
            max-width: 800px;
            height: 40vh;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .video-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .recording-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff4757;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: none;
            animation: pulse 1.5s infinite;
        }
        
        .recording-indicator.active {
            display: block;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .recording-timer {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 1rem;
            font-family: monospace;
            display: none;
        }
        
        .recording-timer.active {
            display: block;
        }
        
        .camera-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .camera-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 16px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .camera-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .camera-toggle.camera-off {
            background: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
        }
        
        .record-btn {
            background: linear-gradient(45deg, #ff4757, #ff3742);
            border: none;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 25px rgba(255, 71, 87, 0.3);
            color: white;
        }
        
        .record-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 15px 35px rgba(255, 71, 87, 0.4);
        }
        
        .record-btn.recording {
            background: #2ecc71;
        }
        
        .camera-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .action-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        
        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .no-camera {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .no-camera-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .audio-wave {
            display: flex;
            gap: 4px;
            margin: 20px 0;
        }
        
        .wave-bar {
            width: 4px;
            height: 20px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
        }
        
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes wave {
            0%, 40%, 100% { transform: scaleY(0.4); }
            20% { transform: scaleY(1); }
        }
    </style>`;
    
    document.head.insertAdjacentHTML('beforeend', styles);
}



function openCameraModal() {
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('cameraModal')) {
        addCameraModalHTML();
        addCameraModalCSS();
        addImprovedCameraCSS(); // Add the improved CSS
    }
    
    // Reset recording state
    isRecording = false;
    window.recordedBlob = null;
    resetRecordingUI();
    
    // Set assignment questions
    if (window.currentAssignmentQuestions) {
        document.getElementById('cameraModalTitle').textContent = window.currentAssignmentQuestions.title;
        document.getElementById('cameraQ1').textContent = window.currentAssignmentQuestions.q1;
        document.getElementById('cameraQ2').textContent = window.currentAssignmentQuestions.q2;
    }
    
    // Show modal with animation
    const modal = document.getElementById('cameraModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
    
    // Initialize camera
    initializeCamera();
}

function closeCameraModal() {
    const modal = document.getElementById('cameraModal');
    modal.classList.remove('active');
    setTimeout(() => {
        modal.style.display = 'none';
        stopAllMedia();
    }, 300);
    
    // Clear assignment data
    window.latestAssignmentId = null;
    window.currentAssignment = null;
    window.currentAssignmentQuestions = null;
}

async function initializeCamera() {
    try {
        const constraints = {
            video: cameraEnabled,
            audio: micEnabled
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        updateVideoDisplay();
        
        // Set initial button states
        const cameraToggle = document.getElementById('cameraToggle');
        const micToggle = document.getElementById('micToggle');
        
        if (!cameraEnabled) {
            cameraToggle.classList.add('camera-off');
            cameraToggle.title = 'Turn Camera On';
        } else {
            cameraToggle.classList.remove('camera-off');
            cameraToggle.title = 'Turn Camera Off';
        }
        
        if (!micEnabled) {
            micToggle.classList.add('camera-off');
            micToggle.title = 'Turn Microphone On';
        } else {
            micToggle.classList.remove('camera-off');
            micToggle.title = 'Turn Microphone Off';
        }
        
    } catch (error) {
        console.error('Error accessing camera:', error);
        alert('Could not access camera/microphone. Please ensure permissions are granted.');
    }
}

function toggleCamera() {
    cameraEnabled = !cameraEnabled;
    const toggleBtn = document.getElementById('cameraToggle');
    
    // Update button appearance
    if (cameraEnabled) {
        toggleBtn.classList.remove('camera-off');
        toggleBtn.title = 'Turn Camera Off';
    } else {
        toggleBtn.classList.add('camera-off');
        toggleBtn.title = 'Turn Camera On';
    }
    
    // Restart stream with new constraints
    restartCameraStream();
}

function toggleMic() {
    micEnabled = !micEnabled;
    const toggleBtn = document.getElementById('micToggle');
    
    // Update button appearance
    if (micEnabled) {
        toggleBtn.classList.remove('camera-off');
        toggleBtn.title = 'Turn Microphone Off';
    } else {
        toggleBtn.classList.add('camera-off');
        toggleBtn.title = 'Turn Microphone On';
    }
    
    // Restart stream with new constraints
    restartCameraStream();
}

async function restartCameraStream() {
    // Stop current stream
    if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
    }
    
    // Get new stream with updated constraints
    try {
        const constraints = {
            video: cameraEnabled,
            audio: micEnabled
        };
        
        cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
        updateVideoDisplay();
        
    } catch (error) {
        console.error('Error restarting camera stream:', error);
        // Fallback to audio-only if camera fails
        if (cameraEnabled) {
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ audio: micEnabled });
                cameraEnabled = false;
                document.getElementById('cameraToggle').classList.add('camera-off');
                updateVideoDisplay();
            } catch (audioError) {
                console.error('Error accessing audio:', audioError);
                alert('Could not access camera or microphone');
            }
        }
    }
}

function updateVideoDisplay() {
    const videoElement = document.getElementById('cameraPreview');
    const noCameraView = document.getElementById('noCameraView');
    
    if (cameraEnabled && cameraStream) {
        videoElement.srcObject = cameraStream;
        videoElement.style.display = 'block';
        noCameraView.style.display = 'none';
    } else {
        videoElement.style.display = 'none';
        videoElement.srcObject = null;
        noCameraView.style.display = 'flex';
    }
}


function toggleRecording() {
    if (isRecording) {
        stopCameraRecording(); // Use camera-specific function
    } else {
        startCameraRecording();
    }
}

function startCameraRecording() {
    if (!cameraStream) {
        alert('Camera not initialized');
        return;
    }
    
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(cameraStream);
    
    mediaRecorder.ondataavailable = function(event) {
        console.log('Data available, blob size:', event.data.size);
        if (event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };
    
    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' }); // or 'audio/webm'
        console.log('Recording finished, blob size:', blob.size);
        window.recordedBlob = blob; // Store globally
        
        // Auto-download after a short delay
        setTimeout(() => {
            downloadCameraRecording();
        }, 500);
        
        document.getElementById('submitRecording').disabled = false;
    };
    
    mediaRecorder.start();
    isRecording = true;
    
    // Update UI
    document.getElementById('recordButton').textContent = 'â¹';
    document.getElementById('recordButton').classList.add('recording');
    document.getElementById('recordingIndicator').classList.add('active');
    document.getElementById('recordingTimer').classList.add('active');
    
    // Start timer
    startRecordingTimer();
}

function stopCameraRecording() {
    console.log('Stopping camera recording...');
    
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        isRecording = false;
        
        // Update UI
        document.getElementById('recordButton').textContent = 'â—';
        document.getElementById('recordButton').classList.remove('recording');
        document.getElementById('recordingIndicator').classList.remove('active');
        document.getElementById('recordingTimer').classList.remove('active');
        
        stopRecordingTimer();
        
    } else {
        console.log('No active recording to stop');
    }
}


function startRecording() {
    if (!cameraStream) {
        alert('Camera not initialized');
        return;
    }
    
    recordedChunks = [];
    mediaRecorder = new MediaRecorder(cameraStream);
    
    mediaRecorder.ondataavailable = function(event) {
        console.log('Data available, blob size:', event.data.size);
        if (event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };
    
    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        console.log('Recording finished, blob size:', blob.size);
        window.recordingBlob = blob; // Fixed: use recordingBlob
        document.getElementById('submitRecording').disabled = false;
    };
    
    mediaRecorder.start();
    isRecording = true;
    
    // Update UI
    document.getElementById('recordButton').textContent = 'â¹';
    document.getElementById('recordButton').classList.add('recording');
    document.getElementById('recordingIndicator').classList.add('active');
    document.getElementById('recordingTimer').classList.add('active');
    
    // Start timer
    recordingSeconds = 0;
    recordingTimer = setInterval(() => {
        recordingSeconds++;
        const minutes = Math.floor(recordingSeconds / 60);
        const seconds = recordingSeconds % 60;
        document.getElementById('recordingTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}


function stopRecording(type) {
    console.log(`Stopping ${type} recording...`);
    
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        isRecording = false;
        
        // Update UI immediately
        document.getElementById('recordButton').textContent = 'â—';
        document.getElementById('recordButton').classList.remove('recording');
        document.getElementById('recordingIndicator').classList.remove('active');
        document.getElementById('recordingTimer').classList.remove('active');
        
        // Stop timer
        if (recordingTimer) {
            clearInterval(recordingTimer);
            recordingTimer = null;
        }
        
        // Show download modal after brief delay
        setTimeout(() => {
            showDownloadModal();
        }, 500);
        
    } else {
        console.log('No active recording to stop');
    }
    
    // Hide stop button if it exists
    const stopBtn = document.getElementById(`stopBtn${type.charAt(0).toUpperCase() + type.slice(1)}`);
    if (stopBtn) {
        stopBtn.style.display = 'none';
    }
}

function showUploadPromptModal() {
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('uploadPromptModal')) {
        document.body.insertAdjacentHTML('beforeend', uploadPromptModalHTML);
    }
    
    // Show modal
    const modal = document.getElementById('uploadPromptModal');
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }
}

function closeUploadPromptModal() {
    const modal = document.getElementById('uploadPromptModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
}

function goToJudgingPage() {
    closeUploadPromptModal();
    
    // Customize this to your judging page location
    const judgingSection = document.getElementById('judging-section');
    if (judgingSection) {
        judgingSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    setTimeout(() => {
        closeRecordingSetup();
    }, 500);
}

function closeRecordingSetup() {
    // Close all modals
    closeDownloadModal();
    closeUploadPromptModal();
    
    // Hide recording interface
    const recordingContainer = document.getElementById('recordingContainer');
    if (recordingContainer) {
        recordingContainer.style.display = 'none';
    }
    
    // Stop streams and reset state
    if (window.currentStream) {
        window.currentStream.getTracks().forEach(track => track.stop());
    }
    
    // Reset variables
    isRecording = false;
    recordedChunks = [];
    mediaRecorder = null;
    
    // Clear timers and URLs
    if (window.recordingTimer) {
        clearInterval(window.recordingTimer);
    }
    if (window.recordingURL) {
        URL.revokeObjectURL(window.recordingURL);
    }
}

const uploadPromptModalHTML = `
<div id="uploadPromptModal" class="upload-prompt-modal">
    <div class="upload-prompt-modal-content">
        <div class="upload-prompt-header">
            <h3>ðŸŽ‰ Great Job!</h3>
        </div>
        <div class="upload-prompt-body">
            <div class="upload-message">
                <p>Your recording has been downloaded successfully!</p>
                <p><strong>Now upload it to the judging page for feedback!</strong></p>
                <div class="upload-icon">ðŸ“¤</div>
            </div>
            <div class="upload-prompt-actions">
                <button class="go-to-upload-btn" onclick="goToJudgingPage()">
                    ðŸš€ Go to Judging Page
                </button>
                <button class="close-recording-btn" onclick="closeRecordingSetup()">
                    âœ… Close Recording Setup
                </button>
            </div>
        </div>
    </div>
</div>`;


function downloadCameraRecording() {
    console.log('Downloading camera recording...');
    
    if (!window.recordedBlob) {
        alert('No recording found. Please record first.');
        return;
    }
    
    // Create download link
    const url = URL.createObjectURL(window.recordedBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `camera_recording_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.webm`;
    
    // Trigger download
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Clean up
    URL.revokeObjectURL(url);
    
    console.log('Download triggered successfully');
}

const downloadModalHTML = `
<div id="downloadModal" class="download-modal">
    <div class="download-modal-content">
        <div class="download-modal-header">
            <h3>Recording Complete!</h3>
            <button class="close-btn" onclick="closeDownloadModal()">&times;</button>
        </div>
        <div class="download-modal-body">
            <div id="recordingPreview" class="recording-preview">
                <!-- Preview will be inserted here -->
            </div>
            <div class="download-actions">
                <button id="downloadBtn" class="download-btn" onclick="downloadRecording()">
                    ðŸ“¥ Download Recording
                </button>
                <button class="upload-btn" onclick="showUploadPromptModal()">
                    ðŸ“¤ Upload & Continue
                </button>
                <div class="file-info">
                    <small>ðŸ’¡ Tip: Open the downloaded .webm file in your browser for best playback</small>
                </div>
            </div>
        </div>
    </div>
</div>`;


function addDownloadModalCSS() {
    if (document.getElementById('downloadModalStyles')) return;
    
    const style = document.createElement('style');
    style.id = 'downloadModalStyles';
    style.textContent = `
        .download-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .download-modal.active {
            opacity: 1;
        }
        
        .download-modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        
        .download-modal.active .download-modal-content {
            transform: scale(1);
        }
        
        .download-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .download-modal-header h3 {
            margin: 0;
            font-size: 1.3em;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .download-modal-body {
            padding: 20px;
        }
        
        .recording-preview {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .download-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            justify-content: center;
        }
        
        .download-btn, .upload-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        .file-info {
            margin-top: 15px;
            text-align: center;
        }
        
        .file-info small {
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 15px;
            display: inline-block;
        }
        
        /* Upload Prompt Modal Styles */
        .upload-prompt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1001;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .upload-prompt-modal.active {
            opacity: 1;
        }
        
        .upload-prompt-modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 0;
            max-width: 450px;
            width: 90%;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
            color: white;
            text-align: center;
        }
        
        .upload-prompt-modal.active .upload-prompt-modal-content {
            transform: scale(1);
        }
        
        .upload-prompt-header {
            padding: 30px 20px 10px 20px;
        }
        
        .upload-prompt-header h3 {
            margin: 0;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .upload-prompt-body {
            padding: 20px 30px 40px 30px;
        }
        
        .upload-message {
            margin-bottom: 30px;
        }
        
        .upload-message p {
            margin: 10px 0;
            font-size: 1.1em;
            line-height: 1.4;
        }
        
        .upload-icon {
            font-size: 3em;
            margin: 20px 0;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .upload-prompt-actions {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .go-to-upload-btn, .close-recording-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .go-to-upload-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .go-to-upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .close-recording-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .close-recording-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
    `;
    document.head.appendChild(style);
}

function showDownloadModal() {
    // Add CSS first
    addDownloadModalCSS();
    
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('downloadModal')) {
        document.body.insertAdjacentHTML('beforeend', downloadModalHTML);
    }
    
    // Use the stored blob from recording
    if (window.recordingBlob) {
        const url = URL.createObjectURL(window.recordingBlob);
        
        // Store for download
        window.recordingURL = url;
        
        // Show preview
        const preview = document.getElementById('recordingPreview');
        if (preview) {
            if (cameraEnabled) {
                preview.innerHTML = `<video src="${url}" controls style="width:100%; max-height:200px; border-radius:10px;"></video>`;
            } else {
                preview.innerHTML = `<audio src="${url}" controls style="width:100%;"></audio>`;
            }
        }
    }
    
    // Show modal
    const modal = document.getElementById('downloadModal');
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    }
}


function downloadRecording(type) {
    console.log(`Downloading ${type} recording...`);
    
    if (!recordedBlob) {
        alert('No recording found. Please record first.');
        return;
    }
    
    // Create download link
    const url = URL.createObjectURL(recordedBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${type}_recording_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.webm`;
    
    // Trigger download
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    
    // Clean up
    URL.revokeObjectURL(url);
    
    console.log('Download triggered successfully');
}

function downloadRecording() {
    if (!window.recordingBlob) {
        alert('No recording available');
        return;
    }
    
    try {
        // Create download link
        const url = URL.createObjectURL(window.recordingBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `CertQuest_Recording_${Date.now()}.webm`;
        a.style.display = 'none';
        
        // Add to DOM, click, and remove
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);
        
        // Show success feedback
        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) {
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = 'âœ… Downloaded!';
            downloadBtn.style.background = 'linear-gradient(135deg, #4CAF50, #45a049)';
            
            setTimeout(() => {
                downloadBtn.innerHTML = originalText;
            }, 2000);
        }
        
        // Close download modal and show upload prompt modal
        setTimeout(() => {
            closeDownloadModal();
            showUploadPromptModal(); // Fixed: correct function name
        }, 1000);
        
    } catch (error) {
        console.error('Download failed:', error);
        alert('Download failed. Please try again.');
    }
}


function closeDownloadModal() {
    const modal = document.getElementById('downloadModal');
    if (modal) {
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 300);
    }
    
    // Clean up blob URLs
    if (window.recordingURL) {
        URL.revokeObjectURL(window.recordingURL);
        window.recordingURL = null;
    }
}
document.addEventListener('click', function(event) {
    const modal = document.getElementById('downloadModal');
    if (modal && event.target === modal) {
        closeDownloadModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeDownloadModal();
    }
});
// 5. ADD THESE NEW FUNCTIONS
function showUploadModal() {
    // Add modal HTML if it doesn't exist
    if (!document.getElementById('uploadModal')) {
        document.body.insertAdjacentHTML('beforeend', uploadModalHTML);
        setupUploadModal(); // Make sure this is called
    }
    
    // Show modal with animation
    const modal = document.getElementById('uploadModal');
    modal.style.display = 'flex';
    setTimeout(() => modal.classList.add('active'), 10);
}


function closeUploadModal() {
    const modal = document.getElementById('uploadModal');
    modal.classList.remove('active');
    setTimeout(() => {
        modal.style.display = 'none';
        resetUploadModal();
    }, 300);
}


function updateRecordingUI(recording) {
    const recordButton = document.getElementById('recordButton');
    const recordingIndicator = document.getElementById('recordingIndicator');
    const recordingTimer = document.getElementById('recordingTimer');
    
    if (recording) {
        recordButton.textContent = 'â¹';
        recordButton.classList.add('recording');
        recordingIndicator.classList.add('active');
        recordingTimer.classList.add('active');
    } else {
        recordButton.textContent = 'â—';
        recordButton.classList.remove('recording');
        recordingIndicator.classList.remove('active');
        recordingTimer.classList.remove('active');
    }
}

function startRecordingTimer() {
    recordingSeconds = 0;
    recordingTimer = setInterval(() => {
        recordingSeconds++;
        const minutes = Math.floor(recordingSeconds / 60);
        const seconds = recordingSeconds % 60;
        const timerElement = document.getElementById('recordingTimer');
        if (timerElement) {
            timerElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }, 1000);
}

function stopRecordingTimer() {
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
    }
}

function resetRecordingUI() {
    isRecording = false;
    updateRecordingUI(false);
    stopRecordingTimer();
    document.getElementById('submitRecording').disabled = true;
}

function showRecordingComplete() {
    // Show a brief success message
    const recordButton = document.getElementById('recordButton');
    const originalText = recordButton.textContent;
    recordButton.textContent = 'âœ“';
    recordButton.style.background = '#2ecc71';
    
    setTimeout(() => {
        recordButton.textContent = originalText;
        recordButton.style.background = '';
    }, 2000);
}

function addCameraModalHTML() {
    const cameraModalHTML = `
    <!-- Camera Recording Modal -->
    <div id="cameraModal" class="camera-modal-overlay">
        <div class="camera-container">
            <!-- Header -->
            <div class="camera-header">
                <h2 class="camera-title" id="cameraModalTitle">Record Your Response</h2>
                <button class="camera-close" onclick="closeCameraModal()">&times;</button>
            </div>
            
            <!-- Assignment Questions Display -->
            <div class="assignment-questions">
                <div class="question-card">
                    <strong>Question 1:</strong>
                    <p id="cameraQ1">What is your strategy for this scenario?</p>
                </div>
                <div class="question-card">
                    <strong>Question 2:</strong>
                    <p id="cameraQ2">How would you handle unexpected challenges?</p>
                </div>
            </div>
            
            <!-- Main Video Area -->
            <div class="camera-main">
                <div class="video-preview">
                    <video id="cameraPreview" autoplay muted playsinline></video>
                    <div id="recordingIndicator" class="recording-indicator">â— RECORDING</div>
                    <div id="recordingTimer" class="recording-timer">00:00</div>
                    <div id="noCameraView" class="no-camera" style="display: none;">
                        <div class="no-camera-icon">ðŸŽ¤</div>
                        <div>Audio Only Mode</div>
                        <div class="audio-wave">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controls -->
            <div class="camera-controls">
                <button id="cameraToggle" class="camera-toggle" onclick="toggleCamera()" title="Toggle Camera">ðŸ“¹</button>
                <button id="recordButton" class="record-btn" onclick="toggleRecording()">â—</button>
                <button id="micToggle" class="camera-toggle" onclick="toggleMic()" title="Toggle Microphone">ðŸŽ¤</button>
            </div>
            
            <!-- Actions -->
            <div class="camera-actions">
                <button id="submitRecording" class="action-btn" onclick="submitCameraRecording()" disabled>Submit Response</button>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', cameraModalHTML);
}

function addImprovedCameraCSS() {
    const additionalStyles = `
    <style>
        .camera-toggle {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 12px 16px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .camera-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .camera-toggle.camera-off {
            background: rgba(255, 71, 87, 0.3) !important;
            border-color: #ff4757 !important;
        }
        
        .camera-toggle.camera-off::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 30px;
            background: #ff4757;
            transform: translate(-50%, -50%) rotate(45deg);
            border-radius: 1px;
        }
        
        .no-camera {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .no-camera-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .audio-wave {
            display: flex;
            gap: 4px;
            margin: 20px 0;
        }
        
        .wave-bar {
            width: 4px;
            height: 20px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 2px;
            animation: wave 1s infinite ease-in-out;
        }
        
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }
        
        @keyframes wave {
            0%, 40%, 100% { transform: scaleY(0.4); }
            20% { transform: scaleY(1); }
        }
    </style>`;
    
    document.head.insertAdjacentHTML('beforeend', additionalStyles);
}

async function submitCameraRecording() {
    if (!window.recordedBlob) {
        alert('No recording found. Please record first.');
        return;
    }
    
    const submitBtn = document.getElementById('submitRecording');
    const originalText = submitBtn.textContent;
    
    try {
        submitBtn.textContent = 'Uploading...';
        submitBtn.disabled = true;
        
        // Here you would upload to Firebase Storage
        // For now, just simulate success
        console.log('Submitting recording, size:', window.recordedBlob.size);
        
        // Simulate upload delay
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        submitBtn.textContent = 'Submitted âœ“';
        
        // Close modal after success
        setTimeout(() => {
            closeCameraModal();
        }, 1500);
        
    } catch (error) {
        console.error('Submit error:', error);
        alert('Failed to submit recording');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
}



// Update the click outside listener to handle both modals:
document.addEventListener('click', function(event) {
    const downloadModal = document.getElementById('downloadModal');
    const uploadModal = document.getElementById('uploadPromptModal');
    
    if (downloadModal && event.target === downloadModal) {
        closeDownloadModal();
    }
    if (uploadModal && event.target === uploadModal) {
        closeUploadPromptModal();
    }
});

// Close modals with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeDownloadModal();
        closeUploadPromptModal();
    }
});



  </script>
  
  
  
  
  
<script>
async function loadCertQuestContext(userId, competition) {
  const db = firebase.firestore();

  let baselineText = "";
  if (competition) {
    const compDoc = await db.collection("competitions").doc(competition).get();
    if (compDoc.exists && compDoc.data().baseline && compDoc.data().baseline.text) {
      baselineText = compDoc.data().baseline.text;
    }
  }

  let personalText = "";
  const entriesSnap = await db
    .collection("userTraining")
    .doc(userId)
    .collection("entries")
    .orderBy("timestamp", "desc")
    .limit(10)
    .get();

  entriesSnap.forEach(d => {
    if (d.data().content) personalText += d.data().content + "\n\n";
  });

  window.__CERTQUEST_CONTEXT__ =
    "=== OFFICIAL COMPETITION STUDY GUIDE ===\n" +
    baselineText +
    "\n\n=== STUDENT PERSONAL TRAINING DATA ===\n" +
    personalText;
}
</script>
</body>
</html> 