<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CertQuest Dashboard</title>
  <link rel="stylesheet" href="assigned.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
  .btn {
    background-color: #e6e9ff;
    border: 1.5px solid #c0c4ff;
    color: #4f74f9;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s, box-shadow 0.3s, color 0.3s;
  }
  .btn:hover:not(.selected) {
    background-color: #d4d9ff;
    box-shadow: 0 0 6px #b0b8ff88;
  }
  .btn.selected {
    background-color: #c0c4ff;
    border-color: #a0a8ff;
    color: #1e40af;
    box-shadow: 0 0 10px #a0a8ff88;
  }
</style>

</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">üåê</div>
    <div class="nav-title">Dashboard <span class="new-badge">(New!)</span></div>
    <div class="nav-right">
  <input type="text" id="navbarSearch" placeholder="Search CertQuest..." />
  <span class="search-icon" id="navbarSearchIcon">üîç</span>
  <div id="searchDropdown"></div>
</div>
  </div>

  <!-- Section Header -->
  <div class="section-header-background">
    <div class="section-header-inline">
      <h1 class="unit-title"><span class="name">Mentor Dashboard</span></h1>
    </div><div class="question-tabs">
        <div class="tab" onclick="selectTab(this)">Dashboard</div>
        <div class="tab active" onclick="selectTab(this)">Assignments</div> 
        <div class="tab" onclick="selectTab(this)">Meetings</div> 
      </div>
      <div class="tab-underline"></div>
  </div>
  <div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">CQ</div>
      <ul class="nav-icons">
        <li>üè† <span class="nav-label">Dashboard</span></li>
        <li>üìä <span class="nav-label">Stats</span></li>
        <li>üéØ <span class="nav-label">Goals</span></li>
        <li>üìÖ <span class="nav-label">Schedule</span></li>
        <li>‚öôÔ∏è <span class="nav-label">Settings</span></li>
      </ul>
    </aside>

  <main class="content">
    <div class="exam-summary-container">
        <!-- Exam Creation -->
        <div class="create-exam-card">
          <h2>Create an Assignment</h2>
          <p>We‚Äôll generate an exam based on what you want to practice</p>
          <div class="exam-buttons">
            <button onclick="openWrittenModal()">Written</button>
            <button class="speaking-btn" onclick="openSpeakingModal()">Speaking</button>
            <button onclick="openCaseModal()">Case</button>
          </div>
        </div>
    </div>
<div class="assignments-header">
  <h3 class="incomplete-title">Complete Assignments</h3>
  <div class="dropdown-sort">
    <label for="sortPeopleComplete">Sort by name</label>
    <select id="sortPeopleComplete"></select>
  </div>
</div>
<div class="training-grid training-grid-complete"></div>
<br><br>
<div class="assignments-header">
  <h3 class="incomplete-title">Incomplete Assignments</h3>
  <div class="dropdown-sort">
    <label for="sortPeopleIncomplete">Sort by name</label>
    <select id="sortPeopleIncomplete"></select>
  </div>
</div>
<div class="training-grid training-grid-incomplete"></div>


        
  </main>
  </div>

   <!-- Written Practice Modal -->
<!-- Written Practice Modal -->
<div id="writtenModal" class="modal" style="display:none;">
  <div class="modal-content">
    <span class="close" onclick="closeWrittenModal()">&times;</span>
    <h2>Written Practice Setup</h2>

    <!-- Setup content -->
    <div id="writtenSetup">
      <div class="modal-section">
        <label><strong>Time:</strong></label>
        <div class="time-options">
          <button class="time-btn" onclick="selectTime(this)">15 min</button>
          <button class="time-btn" onclick="selectTime(this)">30 min</button>
          <button class="time-btn" onclick="selectTime(this)">50 min</button>
        </div>
      </div>
      <div class="modal-section">
        <label><strong>Competencies Tested</strong></label><br>
        <div class="checkbox-group">
          <label><input type="checkbox" class="competency-option" value="Business Communication"> Business Communication</label>
          <label><input type="checkbox" class="competency-option" value="Marketing"> Marketing</label>
          <label><input type="checkbox" class="competency-option" value="Accounting"> Accounting</label>
          <label><input type="checkbox" class="competency-option" value="Economics"> Economics</label>
          <button type="button" class="select-all-btn" onclick="selectAllCompetencies()">Select All</button>
        </div>
      </div>
      <div class="modal-section">
        <label for="speechInput"><strong>Custom Questions</strong></label><br>
        <textarea id="speechInput" placeholder="Paste your questions here..." rows="6"></textarea>
      </div>
      <div class="modal-section">
        <label><strong>Difficulty:</strong></label>
        <div class="difficulty-options">
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Easy</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Medium</button>
          <button class="difficulty-btn" onclick="selectDifficulty(this)">Hard</button>
        </div>
      </div>
      <div class="modal-section">
        <label><strong>Assign to Mentee</strong></label><br>
        <div class="checkbox-group" id="userCheckboxes">
          <!-- Mentees list goes here -->
          <div id="menteesList">
            <!-- Populated dynamically by JS -->
          </div>
        </div>
        <button type="button" class="select-all-btn" onclick="selectAllUsers()">Select All</button>
      </div>
      <div class="checkbox-row">
        <input type="checkbox" id="simulate" />
        <label for="simulate">Simulate BluePanda testing environment</label>
      </div>
      <button class="start-btn" onclick="generateWrittenAssignment()">Assign Practice</button>
    </div>
    <!-- Congrats Message, hidden by default -->
    <div id="writtenCongrats" style="display:none;">
      <div style="text-align:center; padding: 2rem;">
        <span style="font-size: 2.6rem; color: #16a34a;">üéâ</span>
        <h2 style="margin-top: 1rem; color: #007cf0; font-weight: 700;">Congratulations!</h2>
        <div style="margin-top: 0.5rem; font-size: 1.25rem; color: #333;">Assignment has been made.</div>
      </div>
    </div>
  </div>
</div>



  <!-- SPEAKING MODAL -->
<!-- SPEAKING MODAL -->
<!-- SPEAKING MODAL -->
<div class="modal speaking-modal hidden" id="speakingModal">
  <div class="modal-content">
   <span class="close" onclick="closeSpeakingModal()">&times;</span>
    <h2>Speaking Practice Setup</h2>

    <!-- Setup content goes here -->
    <div id="speakingSetup">
      <div class="modal-section">
        <label for="speakingAssignmentName"><strong>Assignment Name:</strong></label>
        <textarea id="speakingAssignmentName" placeholder="Enter assignment name..." rows="2"></textarea>
      </div>
      
      <div class="modal-section">
        <label for="speakingAssignmentDesc"><strong>Assignment Description:</strong></label>
        <textarea id="speakingAssignmentDesc" placeholder="Describe the speaking assignment..." rows="3"></textarea>
      </div>

      <!-- Add this section to your speaking modal after the questions -->
<div class="modal-section">
  <label><strong>Competencies Tested</strong></label><br>
  <div class="checkbox-group">
    <label><input type="checkbox" class="speaking-competency-option" value="Public Speaking"> Public Speaking</label>
    <label><input type="checkbox" class="speaking-competency-option" value="Communication"> Communication</label>
    <label><input type="checkbox" class="speaking-competency-option" value="Presentation"> Presentation</label>
    <label><input type="checkbox" class="speaking-competency-option" value="Leadership"> Leadership</label>
    <button type="button" class="select-all-btn" onclick="selectAllSpeakingCompetencies()">Select All</button>
  </div>
</div>

      <div class="modal-section">
        <label for="speakingQuestion1"><strong>Question 1:</strong></label>
        <textarea id="speakingQuestion1" placeholder="Enter the first speaking question..." rows="3"></textarea>
      </div>

      <div class="modal-section">
        <label for="speakingQuestion2"><strong>Question 2:</strong></label>
        <textarea id="speakingQuestion2" placeholder="Enter the second speaking question..." rows="3"></textarea>
      </div>

      <div class="modal-section">
        <label for="speakingQuestion3"><strong>Question 3 (Optional):</strong></label>
        <textarea id="speakingQuestion3" placeholder="Enter a third speaking question (optional)..." rows="3"></textarea>
      </div>

      <div class="modal-section">
        <label><strong>Time Limit:</strong></label>
        <div class="time-options">
          <!-- Example for a time button -->


        </div>
      </div>

      <div class="modal-section">
        <label><strong>Assign to Mentee</strong></label><br>
        <div class="checkbox-group" id="speakingMenteesList"></div>
        <button type="button" class="select-all-btn" onclick="selectAllSpeakingMentees()">Select All</button>
      </div>
      
      <button class="start-btn" onclick="generateSpeakingAssignment()">Assign Speaking Practice</button>
    </div>

    <!-- Success message, hidden by default -->
    <div id="speakingCongrats" style="display:none;">
      <div style="text-align:center; padding: 2rem;">
        <span style="font-size: 2.6rem; color: #16a34a;">üéâ</span>
        <h2 style="margin-top: 1rem; color: #007cf0; font-weight: 700;">Congratulations!</h2>
        <div style="margin-top: 0.5rem; font-size: 1.25rem; color: #333;">Speaking assignment has been created!</div>
      </div>
    </div>
  </div>
</div>


    <!-- Success message, hidden by default -->
    <div id="congratsArea" style="display:none;">
      <div style="text-align:center; padding: 2rem;">
        <span style="font-size: 2.6rem; color: #16a34a;">üéâ</span>
        <h2 style="margin-top: 1rem; color: #007cf0; font-weight: 700;">Congratulations!</h2>
        <div style="margin-top: 0.5rem; font-size: 1.25rem; color: #333;">Assignment has been made.</div>
      </div>
    </div>

    <!-- The rest of your question/recording area can go here if you want -->
  </div>
</div>

  
  <!-- CASE MODAL -->
<!-- Replace your entire case modal with this -->
<!-- Updated Case Modal -->
<div id="caseModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeCaseModal()">&times;</span>
    <h2>Case Assignment</h2>
    
    <div id="caseSetup">
      <div class="modal-section">
        <label for="caseAssignmentName"><strong>Case Name:</strong></label>
        <textarea id="caseAssignmentName" placeholder="Enter case name..." rows="2"></textarea>
      </div>
      
      <div class="modal-section">
        <label for="caseAssignmentDesc"><strong>Case Description:</strong></label>
        <textarea id="caseAssignmentDesc" placeholder="Describe your case..." rows="4"></textarea>
      </div>
      
      <div class="modal-section">
        <label for="caseStudyContent"><strong>Case Study Content:</strong></label>
        <textarea id="caseStudyContent" placeholder="Paste your case study content here..." rows="6"></textarea>
      </div>

      <!-- Add these question sections -->
      <div class="modal-section">
        <label for="caseQuestion1"><strong>Question 1:</strong></label>
        <textarea id="caseQuestion1" placeholder="Enter the first case question..." rows="3"></textarea>
      </div>

      <div class="modal-section">
        <label for="caseQuestion2"><strong>Question 2:</strong></label>
        <textarea id="caseQuestion2" placeholder="Enter the second case question..." rows="3"></textarea>
      </div>

      <div class="modal-section">
        <label for="caseQuestion3"><strong>Question 3 (Optional):</strong></label>
        <textarea id="caseQuestion3" placeholder="Enter a third case question (optional)..." rows="3"></textarea>
      </div>

      <div class="modal-section">
        <label><strong>Competencies Tested</strong></label><br>
        <div class="checkbox-group">
          <label><input type="checkbox" class="case-competency-option" value="Business Communication"> Business Communication</label>
          <label><input type="checkbox" class="case-competency-option" value="Marketing"> Marketing</label>
          <label><input type="checkbox" class="case-competency-option" value="Accounting"> Accounting</label>
          <label><input type="checkbox" class="case-competency-option" value="Economics"> Economics</label>
          <label><input type="checkbox" class="case-competency-option" value="Strategy"> Strategy</label>
          <button type="button" class="select-all-btn" onclick="selectAllCaseCompetencies()">Select All</button>
        </div>
      </div>

      <div class="modal-section">
        <label><strong>Assign to Mentee</strong></label><br>
        <div class="checkbox-group" id="caseMenteesList"></div>
        <button type="button" class="select-all-btn" onclick="selectAllCaseMentees()">Select All</button>
      </div>
      
      <button class="start-btn" onclick="generateCaseAssignment()">Assign Case Study</button>
    </div>
    
    <div id="caseCongrats" style="display:none;">
      <div style="text-align:center; padding: 2rem;">
        <span style="font-size: 2.6rem; color: #16a34a;">üéâ</span>
        <h2 style="margin-top: 1rem; color: #007cf0; font-weight: 700;">Congratulations!</h2>
        <div style="margin-top: 0.5rem; font-size: 1.25rem; color: #333;">Case assignment has been created!</div>
      </div>
    </div>
  </div>
</div>

<!-- Mentor Comment Modal -->
<div id="commentModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:380px; padding:2rem 2.3rem;">
    <span class="close" onclick="closeCommentModal()" style="top:18px;right:20px;">&times;</span>
    <h2 style="margin-bottom:1rem; font-size:1.4rem;">Leave Feedback</h2>
    <textarea id="commentInput" placeholder="Enter your comments here..." rows="6" style="width:100%;font-size:1.1rem;margin-bottom:1rem;padding:0.5rem;border-radius:7px;border:1px solid #ddd;resize:vertical;"></textarea>
    <button class="btn" onclick="submitComment()" style="width:100%;">Submit</button>
    <div id="commentSuccess" style="display:none;color:#059669;margin-top:1rem;font-weight:600;text-align:center;">Comment submitted!</div>
  </div>
</div>



  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
    authDomain: "certquest-94959.firebaseapp.com",
    projectId: "certquest-94959",
    storageBucket: "certquest-94959.appspot.com",
    messagingSenderId: "323956529033",
    appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
    measurementId: "G-F5JHTGGN6K"
  };

  // Global variables
  let menteesCache = [];
  let currentAssignments = [];
  let menteeNameMap = {};
  let selectedMenteeId = "";



  // Initialize app when page loads
  window.addEventListener('load', () => {
    feather.replace();
    firebase.initializeApp(firebaseConfig);
    initializeApp();
  });

  // Main initialization
  async function initializeApp() {
    const user = await new Promise(resolve => {
      firebase.auth().onAuthStateChanged(resolve);
    });
    
    if (!user) return;
    
    await loadMentees(user);
    await loadAssignments(user);
    populateSortDropdowns();
    
    // Initialize modal if open
    const writtenModal = document.getElementById('writtenModal');
    if (writtenModal && writtenModal.style.display === 'block') {
      showMenteesInWrittenModal();
    }
  }

  // Load mentees
  async function loadMentees(user) {
    const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
    const userData = userDoc.data();

    let mentorComps = [];
    if (Array.isArray(userData.mentorCompetition)) mentorComps = userData.mentorCompetition;
    else if (typeof userData.mentorCompetition === 'string' && userData.mentorCompetition.trim() !== '')
      mentorComps = [userData.mentorCompetition.trim()];
    if (mentorComps.length === 0) return;
    
    const usersSnapshot = await firebase.firestore().collection('users').get();
    menteesCache = [];
    usersSnapshot.forEach(doc => {
      const other = doc.data();
      if (doc.id === user.uid) return;
      let otherComps = [];
      if (Array.isArray(other.competitions)) otherComps = other.competitions;
      else if (typeof other.competitions === 'string' && other.competitions.trim() !== '')
        otherComps = [other.competitions.trim()];
      const overlap = otherComps.some(comp => mentorComps.includes(comp));
      if (overlap) {
        menteesCache.push({ id: doc.id, ...other });
        menteeNameMap[doc.id] = other.name || other.fullName || other.email || "(unnamed)";
      }
    });
  }

  const selectionState = {
  written: {
    time: null,
    difficulty: null
  },
  speaking: {
    time: null,
    focus: null
  },
  case: {
    time: null,
    focus: null,
    difficulty: null
  }
};


 // Written Modal
function selectTime(button) {
  document.querySelectorAll('.time-btn').forEach(btn => {
    btn.classList.remove('selected');
    btn.style.backgroundColor = '#e6e9ff';
  });
  button.classList.add('selected');
  button.style.backgroundColor = '#c0c4ff';
}

function selectDifficulty(button) {
  document.querySelectorAll('.difficulty-btn').forEach(btn => {
    btn.classList.remove('selected');
    btn.style.backgroundColor = '#e6e9ff';
  });
  button.classList.add('selected');
  button.style.backgroundColor = '#c0c4ff';
}

// Speaking Modal
function selectSpeakingTime(button) {
  document.querySelectorAll('.speaking-time-btn').forEach(btn => {
    btn.classList.remove('selected');
    btn.style.backgroundColor = '#e6e9ff';
  });
  button.classList.add('selected');
  button.style.backgroundColor = '#c0c4ff';
}

function selectSpeakingFocus(button) {
  document.querySelectorAll('.speaking-focus-btn').forEach(btn => {
    btn.classList.remove('selected');
    btn.style.backgroundColor = '#e6e9ff';
  });
  button.classList.add('selected');
  button.style.backgroundColor = '#c0c4ff';
}

// Case Modal
function selectCaseTime(button) {
  document.querySelectorAll('.case-time-btn').forEach(btn => {
    btn.classList.remove('selected');
    btn.style.backgroundColor = '#e6e9ff';
  });
  button.classList.add('selected');
  button.style.backgroundColor = '#c0c4ff';
}

function selectCaseFocus(button) {
  document.querySelectorAll('.case-focus-btn').forEach(btn => {
    btn.classList.remove('selected');
    btn.style.backgroundColor = '#e6e9ff';
  });
  button.classList.add('selected');
  button.style.backgroundColor = '#c0c4ff';
}

function selectCaseDifficulty(button) {
  document.querySelectorAll('.case-difficulty-btn').forEach(btn => {
    btn.classList.remove('selected');
    btn.style.backgroundColor = '#e6e9ff';
  });
  button.classList.add('selected');
  button.style.backgroundColor = '#c0c4ff';
}
  // Load assignments
 async function loadAssignments(user) {
    if (menteesCache.length === 0) return;
    
    const menteeIds = menteesCache.map(m => m.id);
    firebase.firestore().collection("assignments")
      .where("to", "in", menteeIds)
      .onSnapshot(snapshot => {
          currentAssignments = [];
          snapshot.forEach(doc => {
              const data = doc.data();
              currentAssignments.push({ 
                  id: doc.id, 
                  ...data,
                  congratulated: data.congratulated || false,
                  reported: data.reported || false  // Add this line
              });
          });
          renderAssignments();
      });
}
  // Populate dropdowns
  function populateSortDropdowns() {
    const completeDropdown = document.getElementById('sortPeopleComplete');
    const incompleteDropdown = document.getElementById('sortPeopleIncomplete');
    
    [completeDropdown, incompleteDropdown].forEach(dropdown => {
      if (!dropdown) return;
      
      dropdown.innerHTML = '<option value="">All Mentees</option>';
      
      if (menteesCache.length === 0) {
        dropdown.innerHTML += '<option disabled>No mentees found</option>';
        return;
      }

      // Sort mentees alphabetically
      const sortedMentees = [...menteesCache].sort((a, b) => {
        const nameA = menteeNameMap[a.id] || '';
        const nameB = menteeNameMap[b.id] || '';
        return nameA.localeCompare(nameB);
      });

      sortedMentees.forEach(mentee => {
        const option = document.createElement('option');
        option.value = mentee.id;
        option.text = menteeNameMap[mentee.id] || mentee.email || "(unnamed)";
        dropdown.add(option);
      });

      dropdown.addEventListener('change', function() {
        selectedMenteeId = this.value;
        renderAssignments(selectedMenteeId);
      });
    });
  }

  // Render assignments
  function renderAssignments(menteeId = "") {
    const filtered = menteeId
      ? currentAssignments.filter(a => a.to === menteeId)
      : currentAssignments;

    const complete = filtered
      .filter(a => a.status === "complete")
      .sort((a, b) => (b.completedAt?.seconds || 0) - (a.completedAt?.seconds || 0));
    
    const incomplete = filtered
      .filter(a => a.status !== "complete")
      .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

    renderAssignmentCards("training-grid-complete", complete);
    renderAssignmentCards("training-grid-incomplete", incomplete);
  }

  function renderAssignmentCards(gridClass, assignments) {
  const grid = document.querySelector(`.${gridClass}`);
  if (!grid) return;

  grid.innerHTML = assignments.length === 0
    ? `<div class="no-assignments">No assignments found</div>`
    : assignments.map(a => {
      let submissionContent = '';

      if (a.status === "complete") {
        if (a.type === "written") {
          // Show score for written assignments
          submissionContent = `
            <div class="submission-score">
              <strong>Score:</strong> ${a.score !== undefined ? a.score : 'N/A'} / ${a.maxScore || 'N/A'}
            </div>`;
        } else if (a.type === "speaking" || a.type === "case") {
          // Show audio/video playback for speaking/case assignments
          // Assuming audio/video URLs are saved under a property e.g. a.submissionMediaUrl
          // or you have separate fields for audio and video, adapt accordingly.
          // For example purposes, I'll show an audio player for speaking and a video player for case.

          if (a.type === "speaking" && a.submissionAudioUrl) {
            submissionContent = `
              <audio controls src="${a.submissionAudioUrl}" style="width: 100%; margin-top: 0.5rem;"></audio>`;
          } else if (a.type === "case" && a.submissionVideoUrl) {
            submissionContent = `
              <video controls src="${a.submissionVideoUrl}" style="width: 100%; margin-top: 0.5rem;"></video>`;
          } else {
            submissionContent = `<em>Check your email for subsmissions!</em>`;
          }
        }
      }

      return `
        <div class="training-card" data-id="${a.id}">
          <div class="badge ${a.optional ? 'optional' : ''}">${a.optional ? "OPTIONAL" : ""}</div>
          <div class="mentee-name">${menteeNameMap[a.to] || "Unknown mentee"}</div>
          <h4>${a.title || "Untitled Assignment"}</h4>
          <p>${a.description || "No description provided."}</p>
          <div class="training-meta">
            <div class="time-sp-container">
              <span class="time">${a.time || "0 min"}</span>
              <span class="sp">+${a.sp || "0"} SP</span>
            </div>
            ${submissionContent}
           ${a.status !== "complete"
  ? `<button class="action-btn report" onclick="handleReport(this, '${a.id}')">
      ${a.reported ? '‚úì Reported' : 'Report'}
    </button>`
  : `
    <button class="action-btn congratulate" onclick="handleCongratulate(this, '${a.id}')">
      ${a.congratulated ? '‚úì Congratulated' : 'Congratulate'}
    </button>
    ${(a.type === "speaking" || a.type === "case") ? `
      <button class="action-btn comment-btn" onclick="openCommentModal('${a.id}')">Comment</button>
    ` : ""}
    `
}

          </div>
        </div>`;
    }).join('');
}




async function handleCongratulate(buttonElement, assignmentId) {
    try {
        const db = firebase.firestore();
        const user = firebase.auth().currentUser;
        
        // Get the assignment data
        const assignmentDoc = await db.collection("assignments").doc(assignmentId).get();
        const assignment = assignmentDoc.data();
        
        // Update UI immediately for better UX
        buttonElement.textContent = '‚úì Congratulated';
        buttonElement.classList.add('congratulated');
        buttonElement.disabled = true;
        
        // Create congratulation notification in mentee's notifications collection
        await db.collection('notifications').add({
            menteeId: assignment.to,
            message: `${user.displayName || "Your mentor"} congratulated you!`,
            assignmentName: assignment.title || "your assignment",
            showModal: true,  // This triggers the modal
            read: false,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update assignment status in Firestore
        await db.collection("assignments").doc(assignmentId).update({
            congratulated: true,
            congratulatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
    } catch (error) {
        console.error("Error congratulating:", error);
        buttonElement.textContent = 'Error - Try Again';
        buttonElement.classList.remove('congratulated');
        buttonElement.disabled = false;
    }
}

async function handleReport(buttonElement, assignmentId) {
    try {
        const db = firebase.firestore();
        const user = firebase.auth().currentUser;
        
        // Get the current assignment data
        const assignmentRef = db.collection("assignments").doc(assignmentId);
        const assignmentDoc = await assignmentRef.get();
        const assignment = assignmentDoc.data();
        
        if (!assignment) {
            throw new Error("Assignment not found");
        }

        // Update UI immediately
        buttonElement.textContent = '‚úì Reported';
        buttonElement.classList.add('reported');
        buttonElement.disabled = true;

        // Create notification in root collection (not user subcollection)
        await db.collection('notifications').add({
            menteeId: assignment.to, // The mentee who will receive this
            message: `${user.displayName || "Your mentor"} has reported an issue with your assignment: ${assignment.title}`,
            assignmentId: assignmentId,
            assignmentName: assignment.title || "Assignment",
            showModal: true, // This will trigger the modal popup
            read: false,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            type: "report"
        });

        // Update assignment status
        await assignmentRef.update({
            reported: true,
            reportedAt: firebase.firestore.FieldValue.serverTimestamp(),
            status: "reported" // Add this to change the status
        });

        // Update local state
        const assignmentIndex = currentAssignments.findIndex(a => a.id === assignmentId);
        if (assignmentIndex !== -1) {
            currentAssignments[assignmentIndex].reported = true;
            renderAssignments(selectedMenteeId);
        }

    } catch (error) {
        console.error("Error reporting assignment:", error);
        buttonElement.textContent = 'Error - Try Again';
        buttonElement.classList.remove('reported');
        buttonElement.disabled = false;
        
        // Optional: Show error to user
        alert("Failed to report assignment. Please try again.");
    }
}

  // Mark complete
  function markAsComplete(id) {
    const assignment = currentAssignments.find(a => a.id === id);
    if (!assignment) return;
    
    firebase.firestore().collection("assignments").doc(id).update({ 
      status: "complete",
      completedAt: firebase.firestore.FieldValue.serverTimestamp()
    })
    .then(() => {
      assignment.status = "complete";
      renderAssignments(selectedMenteeId);
    })
    .catch(error => {
      console.error("Error marking complete:", error);
      alert("Failed to mark assignment as complete");
    });
  }
function initializeButtonEffects() {
  // Remove any existing event listeners to prevent duplicates
  const allButtons = document.querySelectorAll('.speaking-time-btn, .speaking-focus-btn, .case-time-btn, .case-focus-btn, .case-difficulty-btn, .time-btn, .difficulty-btn, .focus-btn');
  
  allButtons.forEach(button => {
    // Remove inline styles that might interfere
    button.style.backgroundColor = '';
    button.style.borderColor = '';
    button.style.color = '';
    button.style.boxShadow = '';
    
    // Clone the button to remove all existing event listeners
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
  });
}

// Call this function after modals are opened or buttons are created
function setupModalButtons() {
  initializeButtonEffects();
}
  function openWrittenModal() {
  document.getElementById('writtenModal').style.display = 'block';
  showMenteesInWrittenModal();
  setTimeout(setupModalButtons, 100);
}

  function closeWrittenModal() {
    document.getElementById('writtenModal').style.display = 'none';
    document.getElementById('writtenSetup').style.display = 'block';
    document.getElementById('writtenCongrats').style.display = 'none';
  }

  // --- SPEAKING MODAL ---
// Update your modal opening functions:
function openSpeakingModal() {
  document.getElementById('speakingModal').style.display = 'block';
  showMenteesInSpeakingModal();
  setTimeout(setupModalButtons, 100); // Small delay to ensure DOM is ready
}

function closeSpeakingModal() {
  document.getElementById('speakingModal').style.display = 'none';
  // Reset to setup state
  document.getElementById('speakingSetup').style.display = 'block';
  document.getElementById('speakingCongrats').style.display = 'none';
  
  // Clear form fields
  clearSpeakingForm();
}

function clearSpeakingForm() {
  document.getElementById('speakingAssignmentName').value = '';
  document.getElementById('speakingAssignmentDesc').value = '';
  document.getElementById('speakingQuestion1').value = '';
  document.getElementById('speakingQuestion2').value = '';
  document.getElementById('speakingQuestion3').value = '';
  
  // Clear selected buttons
  document.querySelectorAll('.speaking-focus-btn.selected').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.speaking-time-btn.selected').forEach(btn => btn.classList.remove('selected'));
  
  // Clear mentee selections
  document.querySelectorAll('.speaking-user-checkbox').forEach(cb => cb.checked = false);
  
  // Clear competency selections
  document.querySelectorAll('.speaking-competency-option').forEach(cb => cb.checked = false);
}

function openCaseModal() {
  document.getElementById('caseModal').style.display = 'block';
  showMenteesInCaseModal();
  setTimeout(setupModalButtons, 100);
}


function closeCaseModal() {
  document.getElementById('caseModal').style.display = 'none';
  document.getElementById('caseSetup').style.display = 'block';
  document.getElementById('caseCongrats').style.display = 'none';
  clearCaseForm();
}

function clearCaseForm() {
  document.getElementById('caseAssignmentName').value = '';
  document.getElementById('caseAssignmentDesc').value = '';
  document.getElementById('caseStudyContent').value = '';
  document.getElementById('caseQuestion1').value = '';
  document.getElementById('caseQuestion2').value = '';
  document.getElementById('caseQuestion3').value = '';
  
  document.querySelectorAll('.case-focus-btn.selected').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.case-time-btn.selected').forEach(btn => btn.classList.remove('selected'));
  document.querySelectorAll('.case-difficulty-btn.selected').forEach(btn => btn.classList.remove('selected'));
  
  document.querySelectorAll('.case-user-checkbox').forEach(cb => cb.checked = false);
  document.querySelectorAll('.case-competency-option').forEach(cb => cb.checked = false);
}

  function showMenteesInWrittenModal() {
    const menteesList = document.getElementById('menteesList');
    if (!menteesList) return;
    
    menteesList.innerHTML = menteesCache.length === 0
      ? '<div class="no-mentees">No mentees found</div>'
      : menteesCache.map(mentee => `
        <label class="mentee-checkbox">
          <input type="checkbox" class="user-checkbox" value="${mentee.id}">
          <span class="mentee-info">
            <b>${menteeNameMap[mentee.id] || mentee.email || "Unnamed"}</b>
            <span class="mentee-details">
              ${Array.isArray(mentee.competitions) ? mentee.competitions.join(', ') : ''}
              ${mentee.email ? " | " + mentee.email : ""}
            </span>
          </span>
        </label>
      `).join('');
  }
function addButtonEffects(buttonsSelector) {
  const buttons = document.querySelectorAll(buttonsSelector);

  buttons.forEach(button => {
    button.style.transition = 'background-color 0.3s, box-shadow 0.3s, color 0.3s';

    button.addEventListener('mouseenter', () => {
      if (!button.classList.contains('selected')) {
        button.style.backgroundColor = '#d4d9ff'; // lighter pastel hover
        button.style.boxShadow = '0 0 6px #b0b8ff88';
      }
    });
    button.addEventListener('mouseleave', () => {
      if (!button.classList.contains('selected')) {
        button.style.backgroundColor = '#e6e9ff';
        button.style.boxShadow = 'none';
      }
    });
  });
}

// Call this after buttons render
addButtonEffects('.speaking-time-btn');
addButtonEffects('.speaking-focus-btn');

  function showMenteesInSpeakingModal() {
    const menteesList = document.getElementById('speakingMenteesList');
    if (!menteesList) return;

    menteesList.innerHTML = menteesCache.length === 0
      ? '<div class="no-mentees">No mentees found</div>'
      : menteesCache.map(mentee => `
        <label class="mentee-checkbox">
          <input type="checkbox" class="speaking-user-checkbox" value="${mentee.id}">
          <span class="mentee-info">
            <b>${menteeNameMap[mentee.id] || mentee.email || "Unnamed"}</b>
            <span class="mentee-details">
              ${Array.isArray(mentee.competitions) ? mentee.competitions.join(', ') : ''}
              ${mentee.email ? " | " + mentee.email : ""}
            </span>
          </span>
        </label>
      `).join('');
  }

  function showMenteesInCaseModal() {
    const menteesList = document.getElementById('caseMenteesList');
    if (!menteesList) return;

    menteesList.innerHTML = menteesCache.length === 0
      ? '<div class="no-mentees">No mentees found</div>'
      : menteesCache.map(mentee => `
        <label class="mentee-checkbox">
          <input type="checkbox" class="case-user-checkbox" value="${mentee.id}">
          <span class="mentee-info">
            <b>${menteeNameMap[mentee.id] || mentee.email || "Unnamed"}</b>
            <span class="mentee-details">
              ${Array.isArray(mentee.competitions) ? mentee.competitions.join(', ') : ''}
              ${mentee.email ? " | " + mentee.email : ""}
            </span>
          </span>
        </label>
      `).join('');
  }

  function selectAllSpeakingMentees() {
    document.querySelectorAll('.speaking-user-checkbox').forEach(cb => cb.checked = true);
  }

  function selectAllCaseMentees() {
    document.querySelectorAll('.case-user-checkbox').forEach(cb => cb.checked = true);
  }

  function selectAllSpeakingCompetencies() {
    document.querySelectorAll('.speaking-competency-option').forEach(box => box.checked = true);
  }

  function selectAllCaseCompetencies() {
    document.querySelectorAll('.case-competency-option').forEach(box => box.checked = true);
  }

  // Assignment generation
  function generateWrittenAssignment() {
    const selectedMentees = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
    if (!selectedMentees.length) {
        alert("Please select at least one mentee.");
        return;
    }

    const timeBtn = document.querySelector('.time-btn.selected');
    const time = timeBtn ? timeBtn.textContent.trim() : null;
    const competencies = Array.from(document.querySelectorAll('.competency-option:checked')).map(cb => cb.value);
    const questions = document.getElementById('speechInput').value.trim();
    const diffBtn = document.querySelector('.difficulty-btn.selected');
    const difficulty = diffBtn ? diffBtn.textContent.trim() : null;
    const simulate = document.getElementById('simulate').checked;

    const batch = firebase.firestore().batch();
    const assignmentsRef = firebase.firestore().collection('assignments');
    
    selectedMentees.forEach(uid => {
        const newRef = assignmentsRef.doc();
        batch.set(newRef, {
            title: "Written Practice",
            type: "written",
            time: time,
            sp: calculateSP(time),
            competencies: competencies,
            questions: questions,
            difficulty: difficulty,
            simulate: simulate,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            to: uid,
            status: "assigned",
            // Add these two fields for quiz scoring:
            correctAnswers: {
                q1: "To make meetings more efficient",
                q2: "Adjourn", 
                q3: "Majority vote",
                q4: "Amend",
                q5: "\"I move to...\""
            },
            maxScore: 5
        });
    });

    batch.commit()
        .then(() => {
            document.getElementById('writtenSetup').style.display = 'none';
            document.getElementById('writtenCongrats').style.display = 'block';
        })
        .catch(error => {
            console.error("Error creating assignments:", error);
            alert("Failed to create assignments");
        });
}

function selectSpeakingFocus(button) {
  document.querySelectorAll('.speaking-focus-btn').forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');
}

function selectSpeakingTime(button) {
  document.querySelectorAll('.speaking-time-btn').forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');
}

function selectCaseFocus(button) {
  document.querySelectorAll('.case-focus-btn').forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');
}

function selectCaseTime(button) {
  document.querySelectorAll('.case-time-btn').forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');
}

function selectCaseDifficulty(button) {
  document.querySelectorAll('.case-difficulty-btn').forEach(btn => btn.classList.remove('selected'));
  button.classList.add('selected');
}

function generateSpeakingAssignment() {
  const selectedMentees = Array.from(document.querySelectorAll('.speaking-user-checkbox:checked')).map(cb => cb.value);
  if (!selectedMentees.length) {
      alert("Please select at least one mentee.");
      return;
  }

  const name = document.getElementById('speakingAssignmentName').value.trim();
  const desc = document.getElementById('speakingAssignmentDesc').value.trim();
  const question1 = document.getElementById('speakingQuestion1').value.trim();
  const question2 = document.getElementById('speakingQuestion2').value.trim();
  const question3 = document.getElementById('speakingQuestion3').value.trim();
  
  const timeBtn = document.querySelector('.speaking-time-btn.selected');
  const time = timeBtn ? timeBtn.textContent.trim() : "5 min";
  
  const focusBtn = document.querySelector('.speaking-focus-btn.selected');
  const focusArea = focusBtn ? focusBtn.textContent.trim() : "General";
  
  const competencies = Array.from(document.querySelectorAll('.speaking-competency-option:checked')).map(cb => cb.value);

  const batch = firebase.firestore().batch();
  const assignmentsRef = firebase.firestore().collection('assignments');
  const notificationsRef = firebase.firestore().collection('notifications');

  selectedMentees.forEach(uid => {
    // 1. Create the assignment
    const assignmentRef = assignmentsRef.doc();
    
    batch.set(assignmentRef, {
      title: name || "Prepared Speaking",
      description: desc,
      type: "speaking",
      time: time,
      sp: calculateSP(time),
      focusArea: focusArea,
      competencies: competencies,
      questions: [
        question1 || "No question provided", 
        question2 || "No question provided",
        question3 || "No question provided"
      ].filter(q => q !== "No question provided"),
      to: uid,
      status: "assigned",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 2. Add notification for mentee homepage
    const notifRef = notificationsRef.doc();
    batch.set(notifRef, {
      menteeId: uid,
      message: `You've been assigned a new Speaking Practice${name ? ': ' + name : ''}!`,
      assignmentName: name || "Prepared Speaking",
      assignmentId: assignmentRef.id,
      type: "speaking",
      showModal: false,
      read: false,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  });

  batch.commit()
    .then(() => {
      document.getElementById('speakingSetup').style.display = 'none';
      document.getElementById('speakingCongrats').style.display = 'block';
    })
    .catch(error => {
      console.error("Error creating speaking assignments:", error);
      alert("Failed to create assignments");
    });
}

function generateCaseAssignment() {
  const selectedMentees = Array.from(document.querySelectorAll('.case-user-checkbox:checked')).map(cb => cb.value);
  if (!selectedMentees.length) {
      alert("Please select at least one mentee.");
      return;
  }

  const name = document.getElementById('caseAssignmentName').value.trim();
  const desc = document.getElementById('caseAssignmentDesc').value.trim();
  const caseContent = document.getElementById('caseStudyContent').value.trim();
  const question1 = document.getElementById('caseQuestion1').value.trim();
  const question2 = document.getElementById('caseQuestion2').value.trim();
  const question3 = document.getElementById('caseQuestion3').value.trim();
  
  const timeBtn = document.querySelector('.case-time-btn.selected');
  const time = timeBtn ? timeBtn.textContent.trim() : "10 min";
  
  const focusBtn = document.querySelector('.case-focus-btn.selected');
  const focusArea = focusBtn ? focusBtn.textContent.trim() : "General";
  
  const diffBtn = document.querySelector('.case-difficulty-btn.selected');
  const difficulty = diffBtn ? diffBtn.textContent.trim() : "Medium";
  
  const competencies = Array.from(document.querySelectorAll('.case-competency-option:checked')).map(cb => cb.value);

  const batch = firebase.firestore().batch();
  const assignmentsRef = firebase.firestore().collection('assignments');
  const notificationsRef = firebase.firestore().collection('notifications');

  selectedMentees.forEach(uid => {
    const assignmentRef = assignmentsRef.doc();
    
    batch.set(assignmentRef, {
      title: name || "Case Study",
      description: desc,
      type: "case",
      time: time,
      sp: calculateSP(time),
      focusArea: focusArea,
      difficulty: difficulty,
      competencies: competencies,
      caseContent: caseContent,
      questions: [
        question1 || "No question provided", 
        question2 || "No question provided",
        question3 || "No question provided"
      ].filter(q => q !== "No question provided"),
      to: uid,
      status: "assigned",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    const notifRef = notificationsRef.doc();
    batch.set(notifRef, {
      menteeId: uid,
      message: `You've been assigned a new Case Study${name ? ': ' + name : ''}!`,
      assignmentName: name || "Case Study",
      assignmentId: assignmentRef.id,
      type: "case",
      showModal: false,
      read: false,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  });

  batch.commit()
    .then(() => {
      document.getElementById('caseSetup').style.display = 'none';
      document.getElementById('caseCongrats').style.display = 'block';
    })
    .catch(error => {
      console.error("Error creating case assignments:", error);
      alert("Failed to create assignments");
    });
}

// Helper function to calculate SP based on time
function calculateSP(timeStr) {
  if (!timeStr) return 0;
  const minutes = parseInt(timeStr.replace(/\D/g, '')) || 0;
  return Math.max(5, Math.floor(minutes / 2) * 5); // Minimum 5 SP, then 5 SP per 2 minutes
}

  // Helper functions for written modal
  function selectTime(button) {
    document.querySelectorAll('.time-btn').forEach(btn => btn.classList.remove('selected'));
    button.classList.add('selected');
  }

  function selectDifficulty(button) {
    document.querySelectorAll('.difficulty-btn').forEach(btn => btn.classList.remove('selected'));
    button.classList.add('selected');
  }

  function selectAllCompetencies() {
    document.querySelectorAll('.competency-option').forEach(box => box.checked = true);
  }

  function selectAllUsers() {
    document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = true);
  }

  // Deprecated function - keeping for backward compatibility
  function generateAssignment() {
    document.getElementById('speakingSetup').style.display = 'none';
    document.getElementById('congratsArea').style.display = 'block';
  }

  // Media recording functions (keep your existing implementations)
  let mediaRecorder, mediaStream, recordedChunks = [];

  function stopAllMedia() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
    if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
  }

  function startAudio(context) {
    stopAllMedia();
    recordedChunks = [];
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        mediaStream = stream;
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'audio/webm' });
          const audioURL = URL.createObjectURL(blob);
          const audio = document.getElementById(`audioPlayback${capitalize(context)}`);
          audio.src = audioURL;
          audio.style.display = 'block';
        };
        mediaRecorder.start();
        document.getElementById(`stopBtn${capitalize(context)}`).style.display = 'inline-block';
      })
      .catch(err => {
        alert('Microphone permission denied.');
        console.error(err);
      });
  }

  function startVideo(context) {
    stopAllMedia();
    recordedChunks = [];
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        mediaStream = stream;
        const video = document.getElementById(`videoPreview${capitalize(context)}`);
        video.srcObject = stream;
        video.muted = true;
        video.play();
        video.style.display = 'block';
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(recordedChunks, { type: 'video/webm' });
          const videoURL = URL.createObjectURL(blob);
          video.srcObject = null;
          video.src = videoURL;
          video.controls = true;
          video.muted = false;
          video.play();
        };
        mediaRecorder.start();
        document.getElementById(`stopBtn${capitalize(context)}`).style.display = 'inline-block';
      })
      .catch(err => {
        alert('Camera permission denied.');
        console.error(err);
      });
  }

  function stopRecording(context) {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
    const stopBtn = document.getElementById(`stopBtn${capitalize(context)}`);
    if (stopBtn) stopBtn.style.display = 'none';
  }

  function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // Search functionality (keep your existing implementation)
  const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
  const index = client.index('content');
  const searchBox = document.getElementById('navbarSearch');
  const searchDropdown = document.getElementById('searchDropdown');
  const searchIcon = document.getElementById('navbarSearchIcon');

  if (searchBox && searchDropdown) {
    searchBox.addEventListener('input', async function (e) {
      const query = e.target.value.trim();
      if (!query) {
        searchDropdown.style.display = 'none';
        searchDropdown.innerHTML = '';
        return;
      }
      try {
        const result = await index.search(query, { limit: 5 });
        if (!result.hits.length) {
          searchDropdown.style.display = 'none';
          searchDropdown.innerHTML = '';
          return;
        }
        searchDropdown.style.display = 'block';
        searchDropdown.innerHTML = result.hits.map(doc => `
          <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
            <b>${doc.title}</b><br>
            <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
          </div>
        `).join('');
      } catch (err) {
        searchDropdown.style.display = 'none';
        searchDropdown.innerHTML = '';
      }
    });
    
    searchDropdown.addEventListener('click', function (e) {
      const target = e.target.closest('.dropdown-result');
      if (target?.dataset.url) window.location = target.dataset.url;
    });
    
    searchBox.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && searchDropdown.innerHTML) {
        const first = searchDropdown.querySelector('.dropdown-result');
        if (first?.dataset.url) window.location = first.dataset.url;
      }
    });
    
    document.addEventListener('click', function (e) {
      if (!searchBox.contains(e.target) && !searchDropdown.contains(e.target)) {
        searchDropdown.style.display = 'none';
      }
    });
    
    if (searchIcon) {
      searchIcon.addEventListener('click', () => {
        searchBox.dispatchEvent(new Event('input'));
      });
    }
  }

  // Tab selection + underline animation
function selectTab(selectedTab) {
  const tabText = selectedTab.textContent.trim();
  if (tabText === "Dashboard") {
    window.location.href = "mentor.html";
    return;
  }
  if (tabText === "Assignments") {
    window.location.href = "assigned.html";
    return;
  }
  if (tabText === "Meetings") {
    window.location.href = "meeting.html";
    return;
  }
  
  // Handle in-page tab selection (if you ever add that)
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => tab.classList.remove('active'));
  selectedTab.classList.add('active');
  const underline = document.querySelector('.tab-underline');
  if (underline) {
    underline.style.transform = `translateX(${selectedTab.offsetLeft}px)`;
    underline.style.width = `${selectedTab.offsetWidth}px`;
  }
}

// Also add this initialization code to ensure underline is positioned correctly
document.addEventListener('DOMContentLoaded', () => {
  const activeTab = document.querySelector('.tab.active');
  const underline = document.querySelector('.tab-underline');
  if (activeTab && underline) {
    underline.style.transform = `translateX(${activeTab.offsetLeft}px)`;
    underline.style.width = `${activeTab.offsetWidth}px`;
  }
});

// State to track assignment being commented on
let commentAssignmentId = null;

function openCommentModal(assignmentId) {
  commentAssignmentId = assignmentId;
  document.getElementById('commentModal').style.display = 'block';
  document.getElementById('commentInput').value = '';
  document.getElementById('commentSuccess').style.display = 'none';
}

function closeCommentModal() {
  document.getElementById('commentModal').style.display = 'none';
}


async function submitComment() {
  const comment = document.getElementById('commentInput').value.trim();
  if (!commentAssignmentId || !comment) {
    alert("Please write a comment.");
    return;
  }
  
  const db = firebase.firestore();
  try {
    // Get the assignment data first
    const assignmentDoc = await db.collection("assignments").doc(commentAssignmentId).get();
    const assignment = assignmentDoc.data();
    
    if (!assignment) {
      alert("Assignment not found.");
      return;
    }

    // Create the mentor comment notification
    await db.collection('notifications').add({
      menteeId: assignment.to,
      assignmentId: commentAssignmentId,
      assignmentName: assignment.title || "Assignment",
      type: "mentorComment",
      read: false,
      comment: comment,  // This is the mentor's feedback
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById('commentInput').value = '';
    document.getElementById('commentSuccess').style.display = 'block';

    setTimeout(closeCommentModal, 1200);
  } catch (err) {
    alert("Failed to submit comment.");
    console.error(err);
  }}


</script>

</body>
</html>
