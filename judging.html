<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CertQuest Dashboard</title>
  <link rel="stylesheet" href="judging.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/feather-icons"></script>
 <!-- Replace your current Firebase scripts with these -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>

  <!-- Top Nav -->
  <div class="top-header">
    <div class="nav-left">üåê</div>
    <div class="nav-title">Dashboard <span class="new-badge">(New!)</span></div>
    <div class="nav-right">
  <input type="text" id="navbarSearch" placeholder="Search CertQuest..." />
  <span class="search-icon" id="navbarSearchIcon">üîç</span>
  <div id="searchDropdown"></div>
</div>
  </div>

  <!-- Section Header -->
  <div class="section-header-background">
    <div class="section-header-inline">
      <h1 class="unit-title"><span class="name">Practice Hub</span></h1>
    </div><div class="question-tabs">
        <div class="tab" onclick="selectTab(this)">Resources</div>
        <div class="tab" onclick="selectTab(this)">Create</div> 
        <div class="tab active" onclick="selectTab(this)">Judging</div> 
      </div>
      <div class="tab-underline"></div>
  </div>

  <div class="main-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">CQ</div>
      <ul class="nav-icons">
        <li>üè† <span class="nav-label">Dashboard</span></li>
        <li>üìä <span class="nav-label">Stats</span></li>
        <li>üéØ <span class="nav-label">Goals</span></li>
        <li>üìÖ <span class="nav-label">Schedule</span></li>
        <li>‚öôÔ∏è <span class="nav-label">Settings</span></li>
      </ul>
    </aside>

    <!-- Sub Sidebar -->
    <aside class="sub-sidebar">
      <div class="sidebar-header">
        <span>Physics</span>
        <span class="dots">‚ãØ</span>
      </div>
      <div class="sub-nav-wrapper">
        <ul class="sub-nav">
          <li class="active">üì∂ My Journey</li>
          <li>üéì Certify</li>
          <li>üèÜ Leaderboard</li>
          <li>‚ÑπÔ∏è About</li>
        </ul>
      </div>
    </aside>
  </div>

  <div class="content">
    <div class="exam-summary-container">
   <div class="involvement-card">
  <div class="involvement-header">
    <h2>Your Involvement</h2>
    <p>Track your progress in Responding and Judging assignments!</p>
  </div>
  <div class="involvement-progress">
    <div class="labels">
      <span>Responding</span>
      <span>Judging</span>
    </div>
    <div class="progress-track">
      <div class="progress-bar" style="width: 62%"></div>
    </div>
    <div class="percents">
      <span>62% Responded</span>
      <span>38% Judged</span>
    </div>
  </div>
</div>


        </div>
    <div class="training-grid">
      <div class="plus-card">+</div>

<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal-box">
  <button class="close-x" id="closeX">&times;</button>
  <h2 style="margin-top: 0;">Want to get Feedback?</h2>
  
  <input type="text" id="titleInput" placeholder="Title" class="modal-input" />
  <textarea id="descInput" placeholder="Description" class="modal-input" rows="3"></textarea>

  <!-- Replace dropzone with recording interface -->
  <div class="recording-interface">
  <video id="videoPreview" muted playsinline></video>
  <div class="recording-indicator hidden" id="recordingIndicator">
    <div class="recording-dot"></div>
    <span>REC</span>
  </div>
  <div class="recording-controls">
    <button id="recordButton">‚óè Record</button>
    <button id="stopButton" disabled>‚ñ† Stop</button>
    <div class="timer">00:00</div>
  </div>
</div>

  <button id="submitBtn" class="submit-btn">Submit</button>
</div>
</div>



        <div class="training-card" onclick="toggleCommentPanel()">
          <div class="badge optional">OPTIONAL</div>
          <h4>Data Protection</h4>
          <p>In this training, you'll learn how to protect data that you may interact with as a volunteer at Schoolhouse.</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">10 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
        <div class="training-card" onclick="toggleCommentPanel()">
          <div class="badge optional">OPTIONAL</div>
          <h4>Data Protection</h4>
          <p>In this training, you'll learn how to protect data that you may interact with as a volunteer at Schoolhouse.</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">10 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
        <div class="training-card" onclick="toggleCommentPanel()">
          <div class="badge optional">OPTIONAL</div>
          <h4>Data Protection</h4>
          <p>In this training, you'll learn how to protect data that you may interact with as a volunteer at Schoolhouse.</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">10 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
        <div class="training-card" onclick="toggleCommentPanel()">
          <div class="badge optional">OPTIONAL</div>
          <h4>Data Protection</h4>
          <p>In this training, you'll learn how to protect data that you may interact with as a volunteer at Schoolhouse.</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">10 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
        <div class="training-card" onclick="toggleCommentPanel()">
          <div class="badge optional">OPTIONAL</div>
          <h4>Data Protection</h4>
          <p>In this training, you'll learn how to protect data that you may interact with as a volunteer at Schoolhouse.</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">10 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
        <div class="training-card" onclick="toggleCommentPanel()">
          <div class="badge optional">OPTIONAL</div>
          <h4>Data Protection</h4>
          <p>In this training, you'll learn how to protect data that you may interact with as a volunteer at Schoolhouse.</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">10 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
        <div class="training-card" onclick="toggleCommentPanel()"> 
          <div class="badge optional">OPTIONAL</div>
          <h4>Data Protection</h4>
          <p>In this training, you'll learn how to protect data that you may interact with as a volunteer at Schoolhouse.</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">10 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
        <div class="training-card" onclick="toggleCommentPanel()">
          <div class="badge optional">OPTIONAL</div>
          <h4>Data Protection</h4>
          <p>In this training, you'll learn how to protect data that you may interact with as a volunteer at Schoolhouse.</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">10 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
    
        <div class="training-card" onclick="toggleCommentPanel()">
          <div class="badge optional">OPTIONAL</div>
          <h4>Managing Up, Down, and Sideways</h4>
          <p>In this training, you'll learn how to manage people in a professional setting regardless of your position & role.</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">15 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
    
        <div class="training-card" onclick="toggleCommentPanel()">
          <div class="badge optional">OPTIONAL</div>
          <h4>Volunteer Leadership</h4>
          <p>This training will review what it takes to earn a leadership role as a volunteer at Schoolhouse while also exposing you to transferable‚Ä¶</p>
          <div class="training-meta">
            <span class="skill">SKILL BUILDER</span>
            <span class="time">15 mins</span>
            <span class="sp">+10 SP</span>
          </div>
        </div>
      </div>
    </section>
  </div>

  <button onclick="toggleCommentPanel()">Toggle Panel</button>


<div class="comment-panel hidden" id="commentPanel">
    <div class="comment-header">
      <span class="comment-title">Entry Details</span>
      <button class="close-btn" onclick="toggleCommentPanel()">‚úï</button>
    </div>
    <div class="comment-content">
      
        <div class="comments-thread" id="commentsThread">
          <div class="comment">
            <strong>Sai P üå±</strong>
            <p>the questions are competency based</p>
          </div>
          <div class="comment">
            <strong>Aarush T üéì</strong>
            <p>I'm happy to help, when are you free?</p>
          </div>
        </div>
      </div>
      
      <div class="reply-container">
        <textarea placeholder="Reply..." class="reply-box"></textarea>
      </div>
      
  </div>


  <script src="https://cdn.jsdelivr.net/npm/meilisearch@latest/dist/bundles/meilisearch.umd.min.js"></script>

  
<script>
  // Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDGYp9sBwOWBdu9W46Q6XFp9zfLCrEsaO4",
  authDomain: "certquest-94959.firebaseapp.com",
  projectId: "certquest-94959",
  storageBucket: "certquest-94959.appspot.com",
  messagingSenderId: "323956529033",
  appId: "1:323956529033:web:e9c9c6a3c7668b8a72f358",
  measurementId: "G-F5JHTGGN6K"
};

// Initialize Firebase
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Constants
const R2_WORKER_URL = "https://certquest-videos.certquest.workers.dev";
const R2_AUTH_KEY = "97589ee62801d77e2dc4bd57ec67ace549ea0ed5eb934845c0f90dbdacdcc347";
const MAX_FILE_SIZE = 50 * 1024 * 1024; // 50MB

// Recording variables
let mediaRecorder;
let recordedChunks = [];
let timerInterval;
let seconds = 0;

document.addEventListener('DOMContentLoaded', () => {
  // DOM Elements
  const plusCard = document.querySelector('.plus-card');
  const modal = document.getElementById('modalBackdrop');
  const closeX = document.getElementById('closeX');
  const submitBtn = document.getElementById('submitBtn');
  const videoPreview = document.getElementById('videoPreview');
  const recordButton = document.getElementById('recordButton');
  const stopButton = document.getElementById('stopButton');
  const timerDisplay = document.querySelector('.timer');
  const titleInput = document.getElementById('titleInput');
  const descInput = document.getElementById('descInput');
  const recordingIndicator = document.getElementById('recordingIndicator');

  // Initialize UI
  if (plusCard) plusCard.addEventListener('click', () => modal.style.display = 'flex');
  if (closeX) closeX.addEventListener('click', closeModal);
  window.addEventListener('click', e => e.target === modal && closeModal());

  // Tab Selection
  window.selectTab = function(selectedTab) {
    const tabText = selectedTab.textContent.trim();
    const pages = {
      "Create": "create.html",
      "Resources": "practice.html",
      "Judging": "judging.html"
    };
    if (pages[tabText]) window.location.href = pages[tabText];
  };

  // Recording Functions
  recordButton.addEventListener('click', startRecording);
  stopButton.addEventListener('click', stopRecording);
  submitBtn.addEventListener('click', handleSubmission);

  // Initialize MeiliSearch
  const client = new MeiliSearch({ host: 'http://127.0.0.1:7700' });
  const index = client.index('content');
  setupSearch(index);

  // Load submissions after a short delay
  setTimeout(loadSubmissions, 1000);
});

// ========== CORE FUNCTIONS ========== //


// Replace the startRecording function with this improved version:
async function startRecording() {
  const videoPreview = document.getElementById('videoPreview');
  const recordButton = document.getElementById('recordButton');
  const stopButton = document.getElementById('stopButton');
  const timerDisplay = document.querySelector('.timer');
  const recordingIndicator = document.getElementById('recordingIndicator');

  try {
    // Stop any existing recording
    if (mediaRecorder?.state === 'recording') {
      mediaRecorder.stop();
    }
    
    // Clear previous chunks
    recordedChunks = [];
    
    // Get media stream
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        width: { ideal: 1280 },
        height: { ideal: 720 },
        facingMode: "user"
      },
      audio: true
    });
    
    // Display preview
    videoPreview.srcObject = stream;
    await videoPreview.play();
    
    // Check for supported MIME types
    let mimeType = 'video/webm;codecs=vp9';
    if (!MediaRecorder.isTypeSupported(mimeType)) {
      mimeType = 'video/webm;codecs=vp8';
      if (!MediaRecorder.isTypeSupported(mimeType)) {
        mimeType = 'video/webm';
        if (!MediaRecorder.isTypeSupported(mimeType)) {
          mimeType = 'video/mp4';
        }
      }
    }
    
    console.log('Using MIME type:', mimeType);
    
    // Setup recorder with better options
    const options = {
      mimeType: mimeType,
      bitsPerSecond: 1000000 // Reduced from 2.5M to 1M for better compatibility
    };
    
    mediaRecorder = new MediaRecorder(stream, options);
    
    mediaRecorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) {
        console.log('Data chunk received:', e.data.size, 'bytes');
        recordedChunks.push(e.data);
      }
    };
    
    mediaRecorder.onstop = () => {
      console.log('Recording stopped, total chunks:', recordedChunks.length);
      stream.getTracks().forEach(track => track.stop());
    };
    
    mediaRecorder.onerror = (e) => {
      console.error('MediaRecorder error:', e.error);
      alert('Recording error: ' + e.error.message);
      resetRecordingState();
    };
    
    mediaRecorder.start(1000); // Collect data every second
    
    // Update UI
    recordButton.disabled = true;
    stopButton.disabled = false;
    recordingIndicator.classList.remove('hidden');
    
    // Start timer
    seconds = 0;
    clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      seconds++;
      const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
      const secs = (seconds % 60).toString().padStart(2, '0');
      timerDisplay.textContent = `${mins}:${secs}`;
    }, 1000);
    
  } catch (err) {
    console.error("Recording failed:", err);
    alert(`Couldn't access camera/microphone: ${err.message}`);
    resetRecordingState();
  }
}


function stopRecording() {
  if (mediaRecorder?.state === 'recording') {
    mediaRecorder.stop();
  }
  resetRecordingState();
}

function resetRecordingState() {
  const recordButton = document.getElementById('recordButton');
  const stopButton = document.getElementById('stopButton');
  const recordingIndicator = document.getElementById('recordingIndicator');
  
  clearInterval(timerInterval);
  recordButton.disabled = false;
  stopButton.disabled = true;
  recordingIndicator.classList.add('hidden');
}


async function uploadToR2(videoBlob) {
  try {
    console.log('Starting upload, blob size:', videoBlob.size, 'bytes');
    console.log('Blob type:', videoBlob.type);
    
    // Validate file size (50MB max)
    if (videoBlob.size > 50 * 1024 * 1024) {
      throw new Error('File exceeds 50MB limit');
    }
    
    if (videoBlob.size === 0) {
      throw new Error('Video file is empty');
    }

    // Generate a clean filename with proper extension
    const timestamp = Date.now();
    const extension = videoBlob.type.includes('mp4') ? 'mp4' : 'webm';
    const filename = `recording_${timestamp}.${extension}`;
    
    console.log('Using filename:', filename);
    
    // Create a File object instead of just appending the blob
    // This ensures the filename is properly set
    const file = new File([videoBlob], filename, { 
      type: videoBlob.type || 'video/webm'
    });
    
    const formData = new FormData();
    formData.append('file', file);

    console.log('Uploading to:', R2_WORKER_URL);
    console.log('File object:', { name: file.name, size: file.size, type: file.type });
    
    const response = await fetch(R2_WORKER_URL, {
      method: 'POST',
      headers: {
        'X-Auth-Key': R2_AUTH_KEY
      },
      body: formData
    });

    console.log('Upload response status:', response.status);
    console.log('Upload response headers:', Object.fromEntries(response.headers.entries()));

    // Get response text first to debug
    const responseText = await response.text();
    console.log('Raw response:', responseText);

    if (!response.ok) {
      // Try to parse as JSON for structured error
      try {
        const errorData = JSON.parse(responseText);
        throw new Error(errorData.error || errorData.message || `Upload failed with status ${response.status}: ${responseText}`);
      } catch (parseError) {
        // If not JSON, use raw text
        throw new Error(`Upload failed with status ${response.status}: ${responseText || response.statusText}`);
      }
    }

    // Parse successful response
    let result;
    try {
      result = JSON.parse(responseText);
    } catch (parseError) {
      throw new Error('Server returned invalid JSON response');
    }
    
    if (!result.success) {
      throw new Error(result.message || 'Upload failed - server returned success=false');
    }

    if (!result.url) {
      throw new Error('Upload succeeded but no URL returned');
    }

    console.log('Upload successful:', result);
    return result;

  } catch (error) {
    console.error('Upload error details:', error);
    
    // Provide more specific error messages
    if (error.message.includes('Failed to fetch')) {
      throw new Error('Network error - check your internet connection');
    } else if (error.message.includes('500')) {
      throw new Error('Server error - the upload service is having issues. Please try again later.');
    } else if (error.message.includes('413')) {
      throw new Error('File too large - please record a shorter video');
    } else if (error.message.includes('401') || error.message.includes('403')) {
      throw new Error('Authentication error - upload service unavailable');
    }
    
    throw error;
  }
}


async function handleSubmission() {
  const title = document.getElementById('titleInput')?.value.trim();
  const desc = document.getElementById('descInput')?.value.trim();
  const submitBtn = document.getElementById('submitBtn');

  try {
    // Validate inputs
    if (!title || !desc) {
      alert('Please fill out both title and description');
      return;
    }

    if (recordedChunks.length === 0) {
      alert('Please record a video first');
      return;
    }

    console.log('Starting submission with', recordedChunks.length, 'chunks');
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> Processing...';

    // Create video blob with proper type
    const mimeType = recordedChunks[0].type || 'video/webm';
    const blob = new Blob(recordedChunks, { type: mimeType });
    
    console.log('Created blob:', blob.size, 'bytes, type:', blob.type);

    if (blob.size === 0) {
      throw new Error('No video data recorded. Please try recording again.');
    }

    submitBtn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> Uploading...';

    // Upload to R2
    const uploadResult = await uploadToR2(blob);
    
    console.log('Upload result:', uploadResult);
    
    submitBtn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> Saving...';
    
    // Save to Firestore
    await db.collection('submissions').add({
      title,
      description: desc,
      videoUrl: uploadResult.url,
      isVideo: true,
      fileSize: blob.size,
      mimeType: blob.type,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      userId: auth.currentUser?.uid || 'anonymous'
    });

    // Success
    alert('Video submitted successfully!');
    closeModal();
    
    // Reload submissions to show the new one
    setTimeout(loadSubmissions, 1000);

  } catch (error) {
    console.error('Submission failed:', error);
    
    // Display user-friendly error message
    let errorMessage = 'Submission failed';
    
    if (error.message.includes('Server error')) {
      errorMessage = 'Server is having issues. Please try again in a few minutes.';
    } else if (error.message.includes('Network error')) {
      errorMessage = 'Network error - please check your internet connection and try again.';
    } else if (error.message.includes('File too large')) {
      errorMessage = 'Video file is too large. Please record a shorter video.';
    } else if (error.message.includes('No video data')) {
      errorMessage = 'No video was recorded. Please try recording again.';
    } else {
      errorMessage = error.message || 'An unexpected error occurred. Please try again.';
    }
    
    alert(errorMessage);
    
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = 'Submit';
  }
}

// Add this CSS for the loading animation:
const loadingStyles = document.createElement('style');
loadingStyles.textContent = `
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
document.head.appendChild(loadingStyles);

function closeModal() {
  const modal = document.getElementById('modalBackdrop');
  const videoPreview = document.getElementById('videoPreview');
  
  // Stop recording if active
  if (mediaRecorder?.state === 'recording') {
    mediaRecorder.stop();
  }
  
  // Stop all media tracks
  if (videoPreview.srcObject) {
    videoPreview.srcObject.getTracks().forEach(track => track.stop());
    videoPreview.srcObject = null;
  }
  
  // Clean up
  clearInterval(timerInterval);
  recordedChunks = [];
  seconds = 0;
  document.querySelector('.timer').textContent = '00:00';
  document.getElementById('recordingIndicator').classList.add('hidden');
  modal.style.display = 'none';
  
  // Reset form
  document.getElementById('titleInput').value = '';
  document.getElementById('descInput').value = '';
}

// ========== HELPER FUNCTIONS ========== //

function setupSearch(index) {
  const searchBox = document.getElementById('navbarSearch');
  const searchDropdown = document.getElementById('searchDropdown');
  const searchIcon = document.getElementById('navbarSearchIcon');

  if (!searchBox || !searchDropdown) return;

  searchBox.addEventListener('input', async function(e) {
    const query = e.target.value.trim();
    if (!query) {
      searchDropdown.style.display = 'none';
      searchDropdown.innerHTML = '';
      return;
    }
    
    try {
      const result = await index.search(query, { limit: 5 });
      if (!result.hits.length) {
        searchDropdown.style.display = 'none';
        searchDropdown.innerHTML = '';
        return;
      }
      
      searchDropdown.style.display = 'block';
      searchDropdown.innerHTML = result.hits.map(doc => `
        <div class="dropdown-result" tabindex="0" data-url="${doc.url}">
          <b>${doc.title}</b><br>
          <span style="font-size:12px;color:#888;">${doc.category || ''}${doc.tags ? ' | ' + doc.tags.join(', ') : ''}</span>
        </div>
      `).join('');
    } catch (err) {
      searchDropdown.style.display = 'none';
      searchDropdown.innerHTML = '';
    }
  });

  // Search event listeners...
}

async function loadSubmissions() {
  try {
    const snapshot = await db.collection('submissions')
      .orderBy('createdAt', 'desc')
      .get();

    // Clear existing user-generated cards
    document.querySelectorAll('.training-card[data-user-generated="true"]').forEach(card => card.remove());

    const plusCard = document.querySelector('.plus-card');
    if (!plusCard) return;

    snapshot.forEach(doc => {
      createCardElement(doc.data(), plusCard);
    });

  } catch (error) {
    console.error('Error loading submissions:', error);
  }
}

function createCardElement(data, plusCard) {
  const newCard = document.createElement('div');
  newCard.className = 'training-card';
  newCard.setAttribute('data-user-generated', 'true');
  newCard.onclick = () => toggleCommentPanel();

  newCard.innerHTML = `
    <div class="badge user-content">USER CONTENT</div>
    ${data.isVideo ? `
      <div class="video-preview" onclick="event.stopPropagation(); playVideo('${data.videoUrl}')">
        <video src="${data.videoUrl}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; cursor: pointer;"></video>
        <div class="play-overlay">‚ñ∂Ô∏è</div>
      </div>
    ` : `
      <div class="file-preview" onclick="event.stopPropagation(); viewFile('${data.fileUrl}', '${data.fileName}', '${data.fileType}')">
        <div class="file-icon">${getFileIcon(data.fileType)}</div>
        <div class="file-name">${data.fileName}</div>
        <div class="view-hint">Click to view</div>
      </div>
    `}
    <h4>${data.title}</h4>
    <p>${data.description}</p>
    <div class="training-meta">
      <span class="skill">USER SUBMISSION</span>
      <span class="rating">‚≠ê ${data.rating || '0'}</span>
      <span class="time">${data.length || '0'} mins</span>
      <span class="sp">+${data.sp || '0'} SP</span>
    </div>
    <div class="card-actions">
      <button class="view-comments-btn" onclick="event.stopPropagation(); toggleCommentPanel()">
        üí¨ View Comments
      </button>
    </div>
  `;

  // Add styles if not already added
  if (!document.getElementById('dynamic-styles')) {
    const style = document.createElement('style');
    style.id = 'dynamic-styles';
    style.textContent = `
      .badge.user-content { background: #e8f5e8; color: #2e7d32; }
      .video-preview { position: relative; margin-bottom: 10px; }
      .play-overlay { 
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
        font-size: 24px; background: rgba(0,0,0,0.7); color: white; 
        border-radius: 50%; width: 50px; height: 50px; 
        display: flex; align-items: center; justify-content: center; 
        opacity: 0.8; transition: opacity 0.3s; 
      }
      .play-overlay:hover { opacity: 1; }
      .file-preview { 
        background: #f0f4f8; padding: 20px; border-radius: 8px; 
        text-align: center; margin-bottom: 10px; color: #64748b; 
        cursor: pointer; transition: background-color 0.3s; 
        border: 2px dashed #cbd5e1; 
      }
      .file-preview:hover { background: #e2e8f0; border-color: #94a3b8; }
      .file-icon { font-size: 32px; margin-bottom: 8px; }
      .file-name { font-weight: 500; margin-bottom: 4px; word-break: break-word; }
      .view-hint { font-size: 12px; color: #94a3b8; }
      .card-actions { 
        margin-top: 15px; padding-top: 15px; 
        border-top: 1px solid #e2e8f0; 
      }
      .view-comments-btn { 
        background: #3b82f6; color: white; border: none; 
        padding: 8px 16px; border-radius: 6px; cursor: pointer; 
        font-size: 14px; font-weight: 500; 
        transition: background-color 0.3s; width: 100%; 
      }
      .view-comments-btn:hover { background: #2563eb; }
      .training-meta .rating { color: #f59e0b; }
    `;
    document.head.appendChild(style);
  }

  plusCard.insertAdjacentElement('afterend', newCard);
}

// ========== UTILITY FUNCTIONS ========== //

window.toggleCommentPanel = function() {
  const panel = document.getElementById("commentPanel");
  panel.classList.toggle("hidden");
  panel.classList.toggle("active");
};

window.getFileIcon = function(fileType) {
  if (!fileType) return 'üìé';
  if (fileType.includes('pdf')) return 'üìÑ';
  if (fileType.includes('image')) return 'üñºÔ∏è';
  if (fileType.includes('video')) return 'üé•';
  if (fileType.includes('audio')) return 'üéµ';
  if (fileType.includes('text')) return 'üìù';
  if (fileType.includes('zip') || fileType.includes('rar')) return 'üóúÔ∏è';
  return 'üìé';
};

window.viewFile = function(fileUrl, fileName, fileType) {
  const fileModal = document.createElement('div');
  fileModal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.9); display: flex; align-items: center;
    justify-content: center; z-index: 10000;
  `;
  
  let content = '';
  if (fileType?.includes('pdf')) {
    content = `<iframe src="${fileUrl}" style="width: 90%; height: 90%; border: none; background: white;" title="${fileName}"></iframe>`;
  } else if (fileType?.includes('image')) {
    content = `<img src="${fileUrl}" style="max-width: 90%; max-height: 90%; object-fit: contain;" alt="${fileName}">`;
  } else {
    content = `
      <div style="background: white; padding: 40px; border-radius: 8px; text-align: center;">
        <div style="font-size: 48px; margin-bottom: 20px;">${getFileIcon(fileType)}</div>
        <h3>${fileName}</h3>
        <p style="color: #64748b; margin-bottom: 20px;">File type: ${fileType || 'unknown'}</p>
        <a href="${fileUrl}" download="${fileName}" style="background: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Download File</a>
      </div>
    `;
  }
  
  fileModal.innerHTML = `
    <div style="position: relative; max-width: 95%; max-height: 95%; display: flex; flex-direction: column;">
      ${content}
      <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: -40px; right: 0; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 20px; font-weight: bold;">√ó</button>
    </div>
  `;
  
  fileModal.addEventListener('click', (e) => {
    if (e.target === fileModal) fileModal.remove();
  });
  
  document.body.appendChild(fileModal);
};

window.playVideo = function(videoUrl) {
  const videoModal = document.createElement('div');
  videoModal.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.9); display: flex; align-items: center;
    justify-content: center; z-index: 10000;
  `;
  
  videoModal.innerHTML = `
    <div style="position: relative; max-width: 90%; max-height: 90%;">
      <video controls autoplay style="width: 100%; height: auto; max-height: 80vh;">
        <source src="${videoUrl}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
      <button onclick="this.closest('div').parentElement.remove()" style="position: absolute; top: -40px; right: 0; background: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px;">√ó</button>
    </div>
  `;
  
  videoModal.addEventListener('click', (e) => {
    if (e.target === videoModal) videoModal.remove();
  });
  
  document.body.appendChild(videoModal);
};
</script>

</body>
</html>